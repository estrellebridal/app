<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estrelle Bridal</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Nunito+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream: #FAF8F5; --white: #FFFFFF; --champagne: #E8DDD4; --rose: #B8A398;
            --taupe: #6B5B4F; --charcoal: #2C2825; --blush: #F5EBE6; --sage: #9CAF94;
            --dusty: #C9A9A6; --gold: #C4A87C; --red: #C9746A; --blue: #7A9BC0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito Sans', sans-serif; background: var(--cream); color: var(--charcoal); min-height: 100vh; }
        .app { display: flex; min-height: 100vh; }

        .sidebar { width: 200px; background: var(--white); border-right: 1px solid var(--champagne); padding: 16px 0; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
        .logo { padding: 0 16px 16px; border-bottom: 1px solid var(--champagne); display: block; }
        .nav { padding: 12px 8px; flex: 1; }
        .nav-label { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--rose); padding: 0 8px; margin: 10px 0 4px; }
        .nav-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; color: var(--taupe); }
        .nav-item:hover { background: var(--blush); }
        .nav-item.active { background: var(--charcoal); color: var(--white); }
        .nav-item svg { width: 14px; height: 14px; }
        .sync-status { padding: 12px 16px; border-top: 1px solid var(--champagne); font-size: 10px; color: var(--rose); }
        .sync-status.syncing { color: var(--gold); }
        .sync-status.error { color: var(--red); }

        .main { flex: 1; margin-left: 200px; padding: 16px 24px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .title { font-family: 'Cormorant Garamond', serif; font-size: 24px; }
        .subtitle { font-size: 11px; color: var(--rose); margin-top: 2px; }

        .btn { display: inline-flex; align-items: center; gap: 5px; padding: 8px 14px; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; border: none; font-family: inherit; }
        .btn-primary { background: var(--charcoal); color: var(--white); }
        .btn-primary:hover { background: var(--taupe); }
        .btn-secondary { background: var(--white); color: var(--charcoal); border: 1px solid var(--champagne); }
        .btn-secondary:hover { background: var(--blush); }
        .btn-success { background: var(--sage); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 10px; }
        .btn-icon { padding: 6px; min-width: 28px; justify-content: center; }

        .card { background: var(--white); border-radius: 6px; border: 1px solid var(--champagne); }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-bottom: 1px solid var(--champagne); }
        .card-title { font-family: 'Cormorant Garamond', serif; font-size: 15px; }
        .card-body { padding: 12px 14px; }

        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat { background: var(--white); border-radius: 6px; padding: 14px; border: 1px solid var(--champagne); }
        .stat-label { font-size: 9px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--rose); margin-bottom: 3px; }
        .stat-value { font-family: 'Cormorant Garamond', serif; font-size: 24px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
        .grid-main { display: grid; grid-template-columns: 1fr 280px; gap: 14px; }

        .list-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--blush); cursor: pointer; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: var(--blush); margin: 0 -14px; padding: 10px 14px; }
        .avatar { width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(135deg, var(--champagne), var(--dusty)); display: flex; align-items: center; justify-content: center; font-family: 'Cormorant Garamond', serif; font-size: 13px; flex-shrink: 0; }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 500; font-size: 12px; }
        .item-meta { font-size: 10px; color: var(--rose); }

        .status { padding: 2px 6px; border-radius: 8px; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em; }
        .status-new { background: var(--blush); color: var(--dusty); }
        .status-consultation { background: #FFF8E8; color: var(--gold); }
        .status-ordered { background: #E8F0E8; color: var(--sage); }
        .status-fitting { background: #E8EEF5; color: var(--blue); }
        .status-complete { background: var(--charcoal); color: var(--white); }
        
        /* Appointment type colors */
        .appt-type-consultation { border-left: 4px solid #9b59b6; background: #f5eef8; }
        .appt-type-fitting { border-left: 4px solid #3498db; background: #eaf4fc; }
        .appt-type-pickup { border-left: 4px solid #27ae60; background: #e8f8f0; }

        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 9px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--rose); margin-bottom: 4px; }
        .form-input { width: 100%; padding: 8px 10px; border: 1px solid var(--champagne); border-radius: 4px; font-size: 12px; font-family: inherit; background: var(--cream); }
        .form-input:focus { outline: none; border-color: var(--rose); background: var(--white); }
        textarea.form-input { min-height: 60px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(44,40,37,0.75); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--white); border-radius: 8px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal.wide { max-width: 800px; }
        .modal.full { max-width: 95vw; max-height: 92vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-bottom: 1px solid var(--champagne); position: sticky; top: 0; background: var(--white); z-index: 10; }
        .modal-title { font-family: 'Cormorant Garamond', serif; font-size: 18px; }
        .modal-close { width: 24px; height: 24px; border-radius: 50%; border: none; background: var(--blush); cursor: pointer; font-size: 14px; }
        .modal-body { padding: 16px 18px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 18px; border-top: 1px solid var(--champagne); background: var(--cream); position: sticky; bottom: 0; }

        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 6px 8px; font-size: 9px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--rose); border-bottom: 1px solid var(--champagne); }
        .table td { padding: 8px; border-bottom: 1px solid var(--blush); font-size: 11px; }
        .table tr:hover { background: var(--blush); cursor: pointer; }

        .rush-badge { padding: 3px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; }
        .rush-badge.ok { background: #E8F0E8; color: var(--sage); }
        .rush-badge.warn { background: #FFF8E8; color: var(--gold); }
        .rush-badge.high { background: #FFE8E6; color: var(--red); }
        .rush-badge.confirm { background: var(--blush); color: var(--rose); }

        .timeline-box { background: var(--blush); border-radius: 6px; padding: 12px; margin-bottom: 14px; }
        .timeline-header { margin-bottom: 8px; }
        .timeline-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--taupe); }
        .timeline-months { font-family: 'Cormorant Garamond', serif; font-size: 26px; color: var(--charcoal); }
        .timeline-detail { font-size: 10px; color: var(--rose); }

        .rush-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .rush-table th { text-align: left; padding: 6px 8px; background: var(--cream); font-size: 9px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--rose); }
        .rush-table td { padding: 8px; border-bottom: 1px solid var(--cream); vertical-align: top; }

        .appt-item { background: var(--cream); border-radius: 5px; padding: 10px; margin-bottom: 6px; }
        .appt-date { font-weight: 500; font-size: 12px; }
        .appt-meta { font-size: 10px; color: var(--rose); margin-top: 1px; }
        .appt-notes { font-size: 11px; margin-top: 4px; color: var(--taupe); }
        .appt-actions { display: flex; gap: 4px; margin-top: 6px; }

        .option-card { background: var(--cream); border-radius: 5px; padding: 10px; margin-bottom: 8px; border-left: 3px solid var(--sage); }
        .option-card.favorite { border-left-color: var(--dusty); background: #fdf8f8; }
        .option-designer { font-weight: 600; font-size: 12px; }
        .option-style { font-size: 11px; color: var(--rose); }
        .option-notes { font-size: 10px; margin-top: 4px; color: var(--taupe); }
        .option-actions { display: flex; gap: 4px; margin-top: 6px; }

        .order-item { display: flex; gap: 8px; padding: 8px; background: var(--cream); border-radius: 5px; margin-bottom: 6px; align-items: center; }
        .order-item-info { flex: 1; }
        .order-item-name { font-weight: 500; font-size: 12px; }
        .order-item-meta { font-size: 10px; color: var(--rose); }
        .order-item-price { font-weight: 600; font-size: 12px; }
        .order-remove { background: none; border: none; color: var(--rose); cursor: pointer; font-size: 14px; padding: 4px; }

        .order-total { display: flex; justify-content: space-between; padding: 12px; background: var(--charcoal); color: white; border-radius: 5px; margin-top: 10px; }
        .order-total-value { font-family: 'Cormorant Garamond', serif; font-size: 20px; }

        .steps { display: flex; margin-bottom: 18px; }
        .step { flex: 1; text-align: center; padding: 8px; position: relative; }
        .step::after, .step::before { content: ''; position: absolute; top: 50%; height: 2px; background: var(--champagne); width: 50%; }
        .step::after { right: 0; }
        .step::before { left: 0; }
        .step:first-child::before, .step:last-child::after { display: none; }
        .step-num { width: 22px; height: 22px; border-radius: 50%; background: var(--champagne); display: inline-flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; position: relative; z-index: 1; }
        .step.active .step-num { background: var(--charcoal); color: white; }
        .step.done .step-num { background: var(--sage); color: white; }
        .step-label { font-size: 9px; color: var(--rose); margin-top: 3px; }
        .step.active .step-label { color: var(--charcoal); font-weight: 500; }

        .meas-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .meas-item { text-align: center; padding: 10px; background: var(--cream); border-radius: 5px; }
        .meas-label { font-size: 8px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--rose); margin-bottom: 4px; }
        .meas-input { width: 60px; padding: 5px; border: 1px solid var(--champagne); border-radius: 3px; font-size: 13px; text-align: center; }
        .meas-unit { font-size: 9px; color: var(--rose); margin-top: 2px; }

        .sig-pad { border: 2px dashed var(--champagne); border-radius: 5px; background: white; cursor: crosshair; touch-action: none; width: 100%; }
        .sig-pad.active { border-color: var(--rose); }

        .contract { background: white; border: 1px solid var(--champagne); border-radius: 5px; padding: 16px; max-height: 300px; overflow-y: auto; font-size: 10px; line-height: 1.5; }
        .contract h2 { font-family: 'Cormorant Garamond', serif; font-size: 16px; text-align: center; margin-bottom: 12px; }
        .contract h3 { font-size: 10px; font-weight: 600; margin: 12px 0 4px; text-decoration: underline; }
        .contract table { width: 100%; border-collapse: collapse; margin: 8px 0; }
        .contract th, .contract td { border: 1px solid var(--champagne); padding: 4px 5px; text-align: left; font-size: 9px; }

        .toast { position: fixed; bottom: 16px; right: 16px; padding: 10px 16px; background: var(--charcoal); color: white; border-radius: 5px; font-size: 12px; transform: translateY(80px); opacity: 0; transition: all 0.3s; z-index: 2000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--sage); }
        .toast.error { background: var(--red); }

        .search { position: relative; margin-bottom: 12px; }
        .search input { width: 100%; padding: 8px 10px 8px 32px; border: 1px solid var(--champagne); border-radius: 4px; font-size: 12px; background: var(--cream); }
        .search svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; color: var(--rose); }

        .section { display: none; }
        .section.active { display: block; }

        .consult-header { background: linear-gradient(135deg, var(--blush), var(--cream)); padding: 14px 16px; border-radius: 8px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .consult-client { display: flex; align-items: center; gap: 12px; }
        .consult-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--dusty), var(--rose)); display: flex; align-items: center; justify-content: center; font-family: 'Cormorant Garamond', serif; font-size: 18px; color: white; }
        .consult-name { font-family: 'Cormorant Garamond', serif; font-size: 20px; }
        .consult-meta { font-size: 11px; color: var(--rose); }

        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--rose); }
        .loading::after { content: ''; width: 20px; height: 20px; border: 2px solid var(--champagne); border-top-color: var(--rose); border-radius: 50%; margin-left: 10px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty { text-align: center; padding: 30px; color: var(--rose); font-size: 12px; }

        .action-btn { padding: 3px 6px; border: 1px solid var(--champagne); background: white; border-radius: 3px; font-size: 9px; cursor: pointer; }
        .action-btn:hover { background: var(--blush); }

        @media (max-width: 900px) {
            .sidebar { width: 60px; }
            .sidebar .logo { padding: 10px 0; margin-bottom: 5px; }
            .sidebar .logo div { font-size: 10px !important; letter-spacing: 0.1em !important; }
            .sidebar .nav-item span { display: none; }
            .sidebar .nav-label { display: none; }
            .sidebar .sync-status { font-size: 8px; padding: 8px; }
            .main { margin-left: 60px; padding: 12px; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            .grid-main, .grid-2 { grid-template-columns: 1fr; }
            .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo" onclick="showPage('dashboard')" style="cursor:pointer;text-align:center;padding:20px 0;margin-bottom:10px"><div style="font-family:Georgia,serif;font-size:20px;font-weight:500;letter-spacing:0.2em;color:#4a4a4a">ESTRELLE</div></div>
            <nav class="nav">
                <div class="nav-label">Overview</div>
                <div class="nav-item active" data-page="dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg><span>Dashboard</span></div>
                <div class="nav-label">Clients</div>
                <div class="nav-item" data-page="clients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>Clients</span></div>
                <div class="nav-item" data-page="week"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>This Week</span></div>
                <div class="nav-item" data-page="appointments"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/></svg><span>All Appointments</span></div>
                <div class="nav-label">Operations</div>
                <div class="nav-item" data-page="orders"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M16 10a4 4 0 0 1-8 0"/></svg><span>Orders</span></div>
                <div class="nav-item" data-page="alterations"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg><span>Alterations</span></div>
                <div class="nav-item" data-page="analytics"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg><span>Analytics</span></div>
                <div class="nav-label">Settings</div>
                <div class="nav-item" data-page="designers"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10M1 12h6m6 0h10"/></svg><span>Designers</span></div>
                <div class="nav-item" data-page="consultants"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Consultants</span></div>
            </nav>
            <div class="sync-status" id="syncStatus">‚óè Connecting...</div>
        </aside>

        <main class="main">
            <!-- Dashboard -->
            <section class="section active" id="page-dashboard">
                <div class="header">
                    <div><h1 class="title">Dashboard</h1><p class="subtitle" id="todayDate"></p></div>
                    <div>
                        <button class="btn btn-secondary" onclick="refreshData()" style="margin-right:6px">‚Üª Refresh</button>
                        <button class="btn btn-secondary" onclick="populateApptModal();openModal('newAppt')" style="margin-right:6px">+ Appointment</button>
                        <button class="btn btn-primary" onclick="openModal('newClient')">+ New Client</button>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat"><div class="stat-label">Today</div><div class="stat-value" id="statToday">-</div></div>
                    <div class="stat"><div class="stat-label">Orders</div><div class="stat-value" id="statOrders">-</div></div>
                    <div class="stat"><div class="stat-label">Alterations</div><div class="stat-value" id="statAlts">-</div></div>
                    <div class="stat"><div class="stat-label">Clients</div><div class="stat-value" id="statClients">-</div></div>
                </div>
                <div class="grid-main">
                    <div>
                        <div class="card" style="margin-bottom:14px"><div class="card-header"><h2 class="card-title">Today's Appointments</h2></div><div class="card-body" id="dashToday"><div class="loading">Loading</div></div></div>
                        <div class="card"><div class="card-header"><h2 class="card-title">This Week</h2></div><div class="card-body" id="dashWeek"><div class="loading">Loading</div></div></div>
                    </div>
                    <div class="card"><div class="card-header"><h2 class="card-title">Recent</h2></div><div class="card-body" id="dashRecent"><div class="loading">Loading</div></div></div>
                </div>
            </section>

            <!-- Clients -->
            <section class="section" id="page-clients">
                <div class="header">
                    <div><h1 class="title">Clients</h1><p class="subtitle" id="clientCount">-</p></div>
                    <button class="btn btn-primary" onclick="openModal('newClient')">+ New Client</button>
                </div>
                <div class="card"><div class="card-body">
                    <div class="search"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search..." id="clientSearch" oninput="filterClients()"></div>
                    <table class="table"><thead><tr><th>Client</th><th>Wedding</th><th>Status</th><th>Last Visit</th><th></th></tr></thead><tbody id="clientsTable"></tbody></table>
                </div></div>
            </section>

            <!-- This Week -->
            <section class="section" id="page-week">
                <div class="header">
                    <div><h1 class="title" id="weekTitle">This Week</h1><p class="subtitle" id="weekSub"></p></div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" onclick="changeWeek(-1)">‚Üê Prev</button>
                        <button class="btn btn-secondary" onclick="changeWeek(0)">Today</button>
                        <button class="btn btn-secondary" onclick="changeWeek(1)">Next ‚Üí</button>
                        <button class="btn btn-secondary" onclick="populateApptModal();openModal('newAppt')">+ Appointment</button>
                    </div>
                </div>
                <div id="weekList"></div>
            </section>

            <!-- All Appointments -->
            <section class="section" id="page-appointments">
                <div class="header">
                    <div><h1 class="title">All Appointments</h1><p class="subtitle" id="apptCount"></p></div>
                    <button class="btn btn-secondary" onclick="populateApptModal();openModal('newAppt')">+ Appointment</button>
                </div>
                <div class="card" style="margin-bottom:14px">
                    <div class="card-body" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Filter</label>
                            <select class="form-input" id="apptFilter" onchange="renderAllAppointments()" style="width:auto">
                                <option value="all">All</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="past">Past</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Type</label>
                            <select class="form-input" id="apptTypeFilter" onchange="renderAllAppointments()" style="width:auto">
                                <option value="">All Types</option>
                                <option value="consultation">Consultation</option>
                                <option value="first fitting">First Fitting</option>
                                <option value="second fitting">Second Fitting</option>
                                <option value="final fitting">Final Fitting</option>
                                <option value="pickup">Pickup</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-input" id="apptSearch" placeholder="Client name..." oninput="renderAllAppointments()" style="width:150px">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="padding:0">
                        <table class="table">
                            <thead><tr><th>Date</th><th>Time</th><th>Client</th><th>Type</th><th>Consultant</th><th></th></tr></thead>
                            <tbody id="allApptTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Orders -->
            <section class="section" id="page-orders">
                <div class="header"><div><h1 class="title">Orders</h1><p class="subtitle">Track orders by designer & QA status</p></div></div>
                
                <!-- Active Orders Summary -->
                <div class="grid-4" style="gap:12px;margin-bottom:16px">
                    <div class="card" style="border-left:3px solid #f39c12">
                        <div class="card-body">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:4px">Pending QA</div>
                            <div style="font-size:24px;font-weight:600" id="ordersNeedQa">0</div>
                        </div>
                    </div>
                    <div class="card" style="border-left:3px solid #1abc9c">
                        <div class="card-body">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:4px">In Alterations</div>
                            <div style="font-size:24px;font-weight:600" id="ordersInAlterations">0</div>
                        </div>
                    </div>
                    <div class="card" style="border-left:3px solid #27ae60">
                        <div class="card-body">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:4px">Ready for Pickup</div>
                            <div style="font-size:24px;font-weight:600" id="ordersReady">0</div>
                        </div>
                    </div>
                    <div class="card" style="border-left:3px solid #3498db">
                        <div class="card-body">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:4px">In Production</div>
                            <div style="font-size:24px;font-weight:600" id="ordersInProduction">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Orders -->
                <div class="card" style="margin-bottom:16px">
                    <div class="card-header"><h2 class="card-title">Active Orders</h2></div>
                    <div class="card-body" id="activeOrdersList"></div>
                </div>
                
                <!-- Past Orders (Picked Up) -->
                <div class="card">
                    <div class="card-header" onclick="togglePastOrders()" style="cursor:pointer">
                        <h2 class="card-title">üì¶ Past Orders (Picked Up)</h2>
                        <span id="pastOrdersToggle" style="font-size:12px;color:var(--taupe)">‚ñº Show</span>
                    </div>
                    <div class="card-body" id="pastOrdersList" style="display:none"></div>
                </div>
            </section>

            <!-- Alterations -->
            <section class="section" id="page-alterations">
                <div class="header">
                    <div><h1 class="title">Alterations</h1><p class="subtitle">Track fittings & alteration progress</p></div>
                    <button class="btn btn-primary" onclick="openAddAlterationItem()">+ Add Fitting</button>
                </div>
                
                <!-- Stats -->
                <div class="grid-3" style="gap:12px;margin-bottom:16px">
                    <div class="card" style="border-left:3px solid #1abc9c">
                        <div class="card-body">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:4px">Active Alterations</div>
                            <div style="font-size:24px;font-weight:600" id="altsActive">0</div>
                        </div>
                    </div>
                    <div class="card" style="border-left:3px solid #f39c12">
                        <div class="card-body">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:4px">Fitting This Week</div>
                            <div style="font-size:24px;font-weight:600" id="altsFittingsWeek">0</div>
                        </div>
                    </div>
                    <div class="card" style="border-left:3px solid #e74c3c">
                        <div class="card-body">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:4px">Urgent (Wedding &lt;30 days)</div>
                            <div style="font-size:24px;font-weight:600" id="altsUrgent">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Alterations List -->
                <div id="alterationsList"></div>
            </section>

            <!-- Designers -->
            <section class="section" id="page-designers">
                <div class="header">
                    <div><h1 class="title">Designer Timelines</h1><p class="subtitle">Production times & rush fees</p></div>
                    <button class="btn btn-primary" onclick="openAddDesignerModal()">+ Add Designer</button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p style="font-size:10px;color:var(--rose);margin-bottom:12px">* All rush orders require designer approval</p>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Designer</th>
                                    <th>Standard Production</th>
                                    <th>Rush Tiers</th>
                                    <th>Below Minimum</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="designersTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Analytics -->
            <section class="section" id="page-analytics">
                <div class="header">
                    <div><h1 class="title">Analytics</h1><p class="subtitle">Sales trends, customer insights & seasonality</p></div>
                    <div style="display:flex;gap:8px">
                        <select class="form-input" id="analyticsYear" onchange="renderAnalytics()" style="width:auto">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportAnalytics()">üìä Export Excel</button>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid-4" style="gap:12px;margin-bottom:16px">
                    <div class="card">
                        <div class="card-body" style="text-align:center">
                            <div style="font-size:10px;text-transform:uppercase;color:var(--rose)">Total Sales (Pre-Tax)</div>
                            <div style="font-size:28px;font-weight:600" id="analyticsTotalPreTax">$0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" style="text-align:center">
                            <div style="font-size:10px;text-transform:uppercase;color:var(--rose)">Total Sales (With Tax)</div>
                            <div style="font-size:28px;font-weight:600" id="analyticsTotalWithTax">$0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" style="text-align:center">
                            <div style="font-size:10px;text-transform:uppercase;color:var(--rose)">Total Orders</div>
                            <div style="font-size:28px;font-weight:600" id="analyticsTotalOrders">0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" style="text-align:center">
                            <div style="font-size:10px;text-transform:uppercase;color:var(--rose)">Avg Order Value</div>
                            <div style="font-size:28px;font-weight:600" id="analyticsAvgOrder">$0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Sales Chart -->
                <div class="card" style="margin-bottom:16px">
                    <div class="card-header"><h2 class="card-title">üìà Monthly Sales</h2></div>
                    <div class="card-body">
                        <div id="salesChart" style="height:250px;display:flex;align-items:flex-end;gap:8px;padding:20px 0"></div>
                        <div id="salesChartLabels" style="display:flex;gap:8px;font-size:10px;color:var(--taupe);margin-top:8px"></div>
                    </div>
                </div>
                
                <div class="grid-2" style="gap:16px;margin-bottom:16px">
                    <!-- Monthly Breakdown Table -->
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">üí∞ Monthly Breakdown</h2></div>
                        <div class="card-body" style="max-height:400px;overflow-y:auto">
                            <table class="table" id="monthlyBreakdownTable">
                                <thead><tr><th>Month</th><th>Orders</th><th>Pre-Tax</th><th>Tax</th><th>Total</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Customer Stats -->
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">üë∞ Customer Activity</h2></div>
                        <div class="card-body" style="max-height:400px;overflow-y:auto">
                            <table class="table" id="customerStatsTable">
                                <thead><tr><th>Month</th><th>New Clients</th><th>Consultations</th><th>Conversions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Seasonality & Insights -->
                <div class="grid-2" style="gap:16px;margin-bottom:16px">
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">üå∏ Wedding Season Analysis</h2></div>
                        <div class="card-body">
                            <div id="seasonalityChart" style="display:flex;flex-direction:column;gap:8px"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">üèÜ Top Designers</h2></div>
                        <div class="card-body">
                            <div id="topDesignersChart"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Data Export -->
                <div class="card">
                    <div class="card-header"><h2 class="card-title">üì• Export Data</h2></div>
                    <div class="card-body">
                        <p style="font-size:11px;color:var(--taupe);margin-bottom:12px">Select what data to export to Excel</p>
                        <div style="display:flex;flex-wrap:wrap;gap:8px">
                            <button class="btn btn-secondary" onclick="exportData('monthly-sales')">Monthly Sales</button>
                            <button class="btn btn-secondary" onclick="exportData('orders')">All Orders</button>
                            <button class="btn btn-secondary" onclick="exportData('customers')">Customer List</button>
                            <button class="btn btn-secondary" onclick="exportData('appointments')">Appointments</button>
                            <button class="btn btn-secondary" onclick="exportData('seasonality')">Seasonality Report</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Consultants -->
            <section class="section" id="page-consultants">
                <div class="header">
                    <div><h1 class="title">Consultants</h1><p class="subtitle">Manage team signatures</p></div>
                    <button class="btn btn-primary" onclick="openModal('newConsultant')">+ Add</button>
                </div>
                <div class="card" style="margin-bottom:16px"><div class="card-body">
                    <div id="consultantsList"></div>
                </div></div>
                
                <!-- Saved Alteration Items -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚úÇÔ∏è Saved Alteration Items</h2>
                    </div>
                    <div class="card-body">
                        <p style="font-size:11px;color:var(--taupe);margin-bottom:12px">Custom alteration items that appear in the dropdown when adding alterations</p>
                        <div id="savedAltItemsList" style="margin-bottom:12px"></div>
                        <div style="display:flex;gap:8px">
                            <input type="text" class="form-input" id="newSavedAltItem" placeholder="Add new item (e.g., Shorten sleeves)" style="flex:1">
                            <button class="btn btn-secondary" onclick="addSavedAltItem()">+ Add</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Consultation -->
            <section class="section" id="page-consult">
                <div class="consult-header">
                    <div class="consult-client">
                        <div class="consult-avatar" id="cAvatar">-</div>
                        <div>
                            <div class="consult-name" id="cName">-</div>
                            <div class="consult-meta" id="cMeta">-</div>
                        </div>
                        <div style="margin-left:12px;display:flex;gap:4px">
                            <button class="btn btn-sm btn-secondary" onclick="editCurrentClient()">‚úèÔ∏è Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="archiveCurrentClient()">üìÅ Archive</button>
                            <button class="btn btn-sm" onclick="deleteCurrentClient()" style="background:#fee;color:#c00">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="showPage('clients')">‚Üê Back</button>
                        <button class="btn btn-success" onclick="sheSaidYes()" id="btnSheSaidYes">üíç She Said Yes!</button>
                        <span id="draftIndicator" style="display:none;margin-left:8px;padding:4px 10px;background:#fff3cd;color:#856404;border-radius:4px;font-size:11px;cursor:pointer" onclick="sheSaidYes()">üìù Draft saved - click to continue</span>
                    </div>
                </div>
                <div class="timeline-box" id="timelineBox">
                    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
                        <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
                            <div style="text-align:center;min-width:120px">
                                <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.05em;color:var(--taupe);margin-bottom:4px">Wedding In</div>
                                <div style="font-size:36px;font-weight:600;color:var(--charcoal);line-height:1" id="tlMonths">‚Äî</div>
                                <div style="font-size:9px;color:var(--taupe);margin-top:4px">months</div>
                            </div>
                            
                            <div style="text-align:center;min-width:120px">
                                <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.05em;color:var(--taupe);margin-bottom:4px">Alteration Time</div>
                                <div style="font-size:36px;font-weight:600;color:var(--charcoal);line-height:1;display:flex;align-items:center;justify-content:center">
                                    <select class="form-input" id="tlAltMonths" onchange="updateTimeline()" style="width:60px;text-align:center;font-size:36px;font-weight:600;padding:0;border:none;background:transparent;color:var(--charcoal);-webkit-appearance:none;appearance:none;cursor:pointer">
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4" selected>4</option>
                                        <option value="5">5</option>
                                    </select>
                                    <span style="font-size:12px;color:var(--taupe);margin-left:-8px">‚ñº</span>
                                </div>
                                <div style="font-size:9px;color:var(--taupe);margin-top:4px">months</div>
                            </div>
                            
                            <div style="width:1px;height:50px;background:var(--champagne)"></div>
                            
                            <div id="tlSummary" style="font-size:11px;max-width:200px"></div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="toggleDesignerTable()" id="tlToggle">Designer Rush Fees ‚ñº</button>
                    </div>
                    <div id="altWarning" style="display:none;background:#fff3cd;color:#856404;padding:8px 12px;border-radius:4px;margin-top:10px;font-size:11px">
                        ‚ö†Ô∏è <b>2 months alterations not recommended.</b> Most brides need 3-4 months for multiple fittings and adjustments.
                    </div>
                    <div id="designerTableWrap" style="display:none;margin-top:12px;border-top:1px solid var(--champagne);padding-top:12px">
                        <div style="font-size:10px;color:var(--rose);margin-bottom:8px">* All rush orders require designer approval</div>
                        <table class="rush-table">
                            <thead><tr><th>Designer</th><th>Standard</th><th>Rush Fees</th><th>Your Timeline</th></tr></thead>
                            <tbody id="rushBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="grid-2">
                    <div>
                        <div class="card" style="margin-bottom:12px">
                            <div class="card-header"><h2 class="card-title">Appointments</h2><button class="btn btn-sm btn-secondary" onclick="addApptForClient()">+ Add</button></div>
                            <div class="card-body" id="cAppts"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Top Options</h2><button class="btn btn-sm btn-secondary" onclick="openModal('addOption')">+ Add</button></div>
                            <div class="card-body" id="cOptions"></div>
                        </div>
                    </div>
                    <div>
                        <div class="card" style="margin-bottom:12px">
                            <div class="card-header"><h2 class="card-title">Quick Notes</h2></div>
                            <div class="card-body">
                                <div class="form-group"><label class="form-label">Style Preferences</label><textarea class="form-input" id="cStyle" style="min-height:50px"></textarea></div>
                                <div class="form-group"><label class="form-label">Budget</label><input type="text" class="form-input" id="cBudget" placeholder="e.g. 4,000-5,500" oninput="formatBudget(this)" onblur="formatBudget(this)"></div>
                                <div class="form-group"><label class="form-label">General Notes</label><textarea class="form-input" id="cNotes" style="min-height:50px"></textarea></div>
                                <button class="btn btn-primary" onclick="saveClientNotes()" style="width:100%">Save Notes</button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Visit History</h2><span style="font-size:9px;color:var(--taupe)">from appointment notes</span></div>
                            <div class="card-body" id="cVisitHistory" style="max-height:400px;overflow-y:auto"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- New/Edit Client -->
    <div class="modal-overlay" id="modal-newClient">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="clientModalTitle">New Client</h2><button class="modal-close" onclick="closeModal('newClient')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="editClientId">
                <div class="form-row"><div class="form-group"><label class="form-label">First Name *</label><input type="text" class="form-input" id="nFirstName"></div><div class="form-group"><label class="form-label">Last Name *</label><input type="text" class="form-input" id="nLastName"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="nEmail"></div><div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="nPhone"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Wedding Date</label><input type="date" class="form-input" id="nWedding"></div><div class="form-group"><label class="form-label">Venue</label><input type="text" class="form-input" id="nVenue"></div></div>
                
                <div class="form-group" style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="nDestination" onchange="toggleLeavingDate()">
                    <label for="nDestination" style="font-size:12px;cursor:pointer">Destination Wedding</label>
                </div>
                <div class="form-group" id="leavingDateGroup" style="display:none">
                    <label class="form-label">Leaving Date (when bride departs)</label>
                    <input type="date" class="form-input" id="nLeavingDate">
                    <p style="font-size:10px;color:var(--rose);margin-top:4px">Dress must be ready before this date</p>
                </div>
                
                <div class="form-group"><label class="form-label">Booking Notes</label><textarea class="form-input" id="nBookingNotes"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('newClient')">Cancel</button><button class="btn btn-primary" onclick="saveClient()">Save</button></div>
        </div>
    </div>

    <!-- New/Edit Appointment -->
    <div class="modal-overlay" id="modal-newAppt">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h2 class="modal-title" id="apptModalTitle">New Appointment</h2><button class="modal-close" onclick="closeModal('newAppt')">√ó</button></div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto">
                <input type="hidden" id="editApptId">
                <input type="hidden" id="apptForClientId">
                
                <!-- Client Selection (hidden when creating for specific client) -->
                <div class="form-group" id="clientSelectGroup">
                    <label class="form-label">Client</label>
                    <select class="form-input" id="aClient" onchange="toggleNewClientFields()">
                        <option value="">Select existing...</option>
                        <option value="new">+ Create New Client</option>
                    </select>
                </div>
                
                <!-- Show selected client name when adding for specific client -->
                <div class="form-group" id="clientFixedGroup" style="display:none">
                    <label class="form-label">Client</label>
                    <input type="text" class="form-input" id="aClientName" readonly style="background:var(--blush)">
                </div>
                
                <!-- New Client Fields (shown when "Create New" selected) -->
                <div id="newClientFields" style="display:none;background:var(--blush);padding:12px;border-radius:5px;margin-bottom:12px">
                    <div style="font-size:10px;font-weight:600;margin-bottom:8px;color:var(--taupe)">New Client Details</div>
                    <div class="form-row"><div class="form-group"><label class="form-label">First Name *</label><input type="text" class="form-input" id="aNewFirstName"></div><div class="form-group"><label class="form-label">Last Name *</label><input type="text" class="form-input" id="aNewLastName"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="aNewEmail"></div><div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="aNewPhone"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Wedding Date</label><input type="date" class="form-input" id="aNewWedding"></div><div class="form-group"><label class="form-label">Venue</label><input type="text" class="form-input" id="aNewVenue"></div></div>
                </div>
                
                <!-- Appointment Details -->
                <div style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:12px">
                    <div class="form-row"><div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="aDate"></div><div class="form-group"><label class="form-label">Time</label><select class="form-input" id="aTime"><option value="">Select...</option><option value="09:00">9:00 AM</option><option value="09:15">9:15 AM</option><option value="09:30">9:30 AM</option><option value="09:45">9:45 AM</option><option value="10:00">10:00 AM</option><option value="10:15">10:15 AM</option><option value="10:30">10:30 AM</option><option value="10:45">10:45 AM</option><option value="11:00">11:00 AM</option><option value="11:15">11:15 AM</option><option value="11:30">11:30 AM</option><option value="11:45">11:45 AM</option><option value="12:00">12:00 PM</option><option value="12:15">12:15 PM</option><option value="12:30">12:30 PM</option><option value="12:45">12:45 PM</option><option value="13:00">1:00 PM</option><option value="13:15">1:15 PM</option><option value="13:30">1:30 PM</option><option value="13:45">1:45 PM</option><option value="14:00">2:00 PM</option><option value="14:15">2:15 PM</option><option value="14:30">2:30 PM</option><option value="14:45">2:45 PM</option><option value="15:00">3:00 PM</option><option value="15:15">3:15 PM</option><option value="15:30">3:30 PM</option><option value="15:45">3:45 PM</option><option value="16:00">4:00 PM</option><option value="16:15">4:15 PM</option><option value="16:30">4:30 PM</option><option value="16:45">4:45 PM</option><option value="17:00">5:00 PM</option><option value="17:15">5:15 PM</option><option value="17:30">5:30 PM</option><option value="17:45">5:45 PM</option><option value="18:00">6:00 PM</option><option value="18:15">6:15 PM</option><option value="18:30">6:30 PM</option><option value="18:45">6:45 PM</option><option value="19:00">7:00 PM</option><option value="19:15">7:15 PM</option><option value="19:30">7:30 PM</option><option value="19:45">7:45 PM</option><option value="20:00">8:00 PM</option></select></div></div>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Type</label><select class="form-input" id="aType" onchange="toggleConsultationReason()"><option value="consultation">Consultation</option><option value="first fitting">First Fitting</option><option value="fitting">Fitting</option><option value="final fitting">Final Fitting</option><option value="pickup">Pickup</option></select></div>
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Consultant</label><select class="form-input" id="aConsultant"><option value="">Select...</option></select></div>
                    </div>
                    
                    <!-- Reason for Visit (only for consultations) -->
                    <div id="consultationReasonGroup" style="margin-top:12px">
                        <label class="form-label">Reason for Visit</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px">
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="first" style="margin:0"> First Visit
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="revisit" style="margin:0"> Revisit Favourites
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="sayyes" style="margin:0"> Say Yes üíç
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="trymore" style="margin:0"> Try More Options
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="other" style="margin:0" onchange="toggleOtherReason()"> Other
                            </label>
                        </div>
                        <input type="text" class="form-input" id="aReasonOther" style="display:none;margin-top:8px" placeholder="Please specify reason...">
                    </div>
                    
                    <!-- Fitting-specific fields (only for fittings) -->
                    <div id="fittingFieldsGroup" style="display:none;margin-top:12px;background:var(--blush);padding:10px;border-radius:5px">
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom:0">
                                <label class="form-label">Dress Needed By</label>
                                <input type="date" class="form-input" id="aDressNeededBy">
                            </div>
                            <div class="form-group" style="margin-bottom:0">
                                <label class="form-label">Wedding Date</label>
                                <input type="text" class="form-input" id="aWeddingDateDisplay" readonly style="background:white">
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--taupe);margin-top:6px" id="aDaysUntilWedding"></div>
                    </div>
                </div>
                
                <!-- Visit Log Section (shown prominently for editing) -->
                <div id="visitLogSection">
                    <div style="font-size:11px;font-weight:600;color:var(--charcoal);margin-bottom:10px;display:flex;align-items:center;gap:6px">
                        <span>üìù</span> Visit Log
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Dresses Tried On</label>
                        <textarea class="form-input" id="aLogDresses" style="min-height:50px" placeholder="e.g. Netta BenShabu Aria (size 8), Enaura Bridal ES920, Rosa Clara Soft"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">What She Loved / Didn't Love</label>
                        <textarea class="form-input" id="aLogFeedback" style="min-height:60px" placeholder="e.g. Loved the fitted silhouette of Aria, didn't like the high neckline on ES920. Wants more sparkle."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Style Preference Update</label>
                            <input type="text" class="form-input" id="aLogStyle" placeholder="e.g. Prefers mermaid, no ball gowns">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Budget Update</label>
                            <input type="text" class="form-input" id="aLogBudget" placeholder="e.g. Increased to $6,000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Next Steps / Follow-up</label>
                        <input type="text" class="form-input" id="aLogNextSteps" placeholder="e.g. Coming back Saturday with mom, order Aria sample size 6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-input" id="aLogOther" style="min-height:40px" placeholder="Any other important details..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('newAppt')">Cancel</button><button class="btn btn-primary" onclick="saveAppt()">Save</button></div>
        </div>
    </div>
    
    <!-- Alteration Detail Modal -->
    <div class="modal-overlay" id="modal-alteration">
        <div class="modal" style="max-width:700px">
            <div class="modal-header"><h2 class="modal-title">‚úÇÔ∏è Alteration Details</h2><button class="modal-close" onclick="closeModal('alteration')">√ó</button></div>
            <div class="modal-body">
                <div id="altClientInfo" style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:16px"></div>
                
                <!-- Dress Needed By -->
                <div style="background:var(--blush);padding:10px 12px;border-radius:5px;margin-bottom:16px;display:flex;align-items:center;gap:12px">
                    <div style="flex:1">
                        <label class="form-label" style="margin-bottom:4px">üéØ Dress Needed By</label>
                        <input type="date" class="form-input" id="altDressNeededBy" style="max-width:180px" onchange="saveAltNeededBy()">
                    </div>
                    <div id="altNeededByCountdown" style="font-size:12px;font-weight:600"></div>
                </div>
                
                <!-- Fitting History -->
                <div style="margin-bottom:16px">
                    <h3 style="font-size:12px;font-weight:600;margin-bottom:8px">üìÖ Fitting Appointments</h3>
                    <div id="altFittingsList"></div>
                </div>
                
                <!-- Alteration Items -->
                <div style="margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <h3 style="font-size:12px;font-weight:600">‚úÇÔ∏è Alteration Items</h3>
                        <div style="display:flex;gap:6px">
                            <button class="btn btn-sm btn-secondary" onclick="manageSavedAltItems()" title="Manage saved items">‚öôÔ∏è</button>
                            <button class="btn btn-sm btn-secondary" onclick="addAlterationItem()">+ Add Item</button>
                        </div>
                    </div>
                    <div id="altItemsList"></div>
                </div>
                
                <!-- Add Item Form (hidden by default) -->
                <div id="addAltItemForm" style="display:none;background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Item</label>
                            <select class="form-input" id="newAltItemType" onchange="toggleCustomAltItem()">
                                <option value="hem">Hem (shorten/lengthen)</option>
                                <option value="bustle">Bustle</option>
                                <option value="take-in">Take In</option>
                                <option value="let-out">Let Out</option>
                                <option value="straps">Straps Adjustment</option>
                                <option value="cups">Add Bra Cups</option>
                                <option value="buttons">Buttons/Hooks</option>
                                <option value="steaming">Steaming</option>
                                <option value="cleaning">Cleaning</option>
                                <option value="---" disabled>‚îÄ‚îÄ Saved Items ‚îÄ‚îÄ</option>
                                <!-- Saved items will be populated here -->
                                <option value="custom">+ Custom...</option>
                            </select>
                        </div>
                        <div class="form-group" id="customAltItemGroup" style="display:none">
                            <label class="form-label">Custom Item Name</label>
                            <input type="text" class="form-input" id="customAltItem" placeholder="e.g., Shorten sleeves">
                            <label style="display:flex;align-items:center;gap:6px;font-size:10px;margin-top:6px;cursor:pointer">
                                <input type="checkbox" id="saveCustomAltItem"> Save for future use
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Details/Measurements</label>
                        <input type="text" class="form-input" id="newAltItemDetails" placeholder="e.g., Take up 2 inches, 3-point bustle...">
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:8px">
                        <button class="btn btn-sm btn-secondary" onclick="cancelAddAltItem()">Cancel</button>
                        <button class="btn btn-sm btn-primary" onclick="saveNewAltItem()">Add Item</button>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">Seamstress Notes</label>
                    <textarea class="form-input" id="altNotes" style="min-height:60px" placeholder="Notes for seamstress..."></textarea>
                </div>
            </div>
            <div class="modal-footer" style="flex-wrap:wrap;gap:8px">
                <button class="btn btn-secondary" onclick="closeModal('alteration')">Close</button>
                <button class="btn btn-secondary" onclick="copySeamstressText()">üìã Copy for Seamstress</button>
                <button class="btn btn-secondary" onclick="sendFittingSummary()">üìß Email Bride</button>
                <button class="btn btn-primary" onclick="saveAlterations()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Add Option -->
    <div class="modal-overlay" id="modal-addOption">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">Add Top Option</h2><button class="modal-close" onclick="closeModal('addOption')">√ó</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Designer</label><select class="form-input" id="oDesigner" onchange="toggleCustomDesigner()"></select></div>
                    <div class="form-group"><label class="form-label">Style</label><input type="text" class="form-input" id="oStyle"></div>
                </div>
                <div class="form-group" id="customDesignerGroup" style="display:none">
                    <label class="form-label">Custom Designer Name</label>
                    <input type="text" class="form-input" id="oCustomDesigner" placeholder="Enter designer name">
                </div>
                <div class="form-row"><div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="oPrice"></div><div class="form-group"><label class="form-label">Size</label><input type="text" class="form-input" id="oSize"></div></div>
                <div class="form-group"><label class="form-label">Customizations</label><textarea class="form-input" id="oCustom"></textarea></div>
                <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="oOptionNotes"></textarea></div>
                <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer"><input type="checkbox" id="oFavorite"> Mark as top choice</label>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addOption')">Cancel</button><button class="btn btn-primary" onclick="saveOption()">Add</button></div>
        </div>
    </div>

    <!-- Confirmation Email -->
    <div class="modal-overlay" id="modal-confirmEmail">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title">Send Confirmation Email</h2>
                <button class="modal-close" onclick="closeModal('confirmEmail')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="confirmApptId">
                <div class="form-row" style="margin-bottom:12px">
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <input type="email" class="form-input" id="confirmTo" readonly style="background:#f5f5f5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="confirmSubject">
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:10px;background:var(--blush);border-radius:5px">
                    <span style="font-size:11px;color:var(--taupe)">üìù Template Settings</span>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary btn-sm" onclick="resetConfirmTemplate()">Reset to Default</button>
                        <button class="btn btn-secondary btn-sm" onclick="saveConfirmTemplate()">Save as Template</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Body</label>
                    <textarea class="form-input" id="confirmBody" style="min-height:350px;font-size:12px;line-height:1.5"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmEmail')">Cancel</button>
                <button class="btn btn-primary" onclick="sendConfirmationEmail()">Send Email</button>
            </div>
        </div>
    </div>

    <!-- New Designer -->
    <div class="modal-overlay" id="modal-editDesigner">
        <div class="modal" style="max-width:550px">
            <div class="modal-header"><h2 class="modal-title" id="designerModalTitle">Edit Designer</h2><button class="modal-close" onclick="closeModal('editDesigner')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="edDesignerIdx">
                <div class="form-group"><label class="form-label">Designer Name *</label><input type="text" class="form-input" id="edDesignerName"></div>
                <div class="form-group"><label class="form-label">Standard Production (months, no rush fee)</label><input type="number" class="form-input" id="edDesignerStandard" min="1" max="24"></div>
                
                <div class="form-group">
                    <label class="form-label">Rush Tiers</label>
                    <p style="font-size:10px;color:var(--rose);margin-bottom:8px">Add rush fee tiers from longest to shortest timeline</p>
                    <div id="edDesignerTiers"></div>
                    <button class="btn btn-sm btn-secondary" onclick="addDesignerTier()" style="margin-top:6px">+ Add Rush Tier</button>
                </div>
                
                <div class="form-group" style="background:var(--blush);padding:12px;border-radius:5px">
                    <label class="form-label">Below Minimum Timeline</label>
                    <p style="font-size:10px;color:var(--rose);margin-bottom:8px">What happens if timeline is shorter than all tiers?</p>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Min Months</label><input type="number" class="form-input" id="edDesignerMinMonths" min="1" max="12"></div>
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Fee (if any)</label><input type="text" class="form-input" id="edDesignerBelowFee" placeholder="e.g. $4,600 extra"></div>
                    </div>
                    <div class="form-group" style="margin-top:8px;margin-bottom:0"><label class="form-label">Note</label><input type="text" class="form-input" id="edDesignerBelowNote" placeholder="e.g. Inquiry required, not guaranteed"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="deleteDesigner()" style="background:#fee;color:#c00;margin-right:auto">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('editDesigner')">Cancel</button>
                <button class="btn btn-primary" onclick="saveDesigner()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Consultant -->
    <div class="modal-overlay" id="modal-newConsultant">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="consultantModalTitle">Add Consultant</h2><button class="modal-close" onclick="closeModal('newConsultant')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="editConsultantId">
                <div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="cConsultantName"></div>
                <div class="form-group">
                    <label class="form-label">Signature</label>
                    <p style="font-size:10px;color:var(--rose);margin-bottom:6px">Draw signature below. This will auto-fill on contracts.</p>
                    <canvas id="consultantSigPad" class="sig-pad" width="400" height="120"></canvas>
                    <button class="btn btn-sm btn-secondary" onclick="clearConsultantSig()" style="margin-top:6px">Clear</button>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('newConsultant')">Cancel</button><button class="btn btn-primary" onclick="saveConsultant()">Save</button></div>
        </div>
    </div>

    <!-- Order Email Modal -->
    <div class="modal-overlay" id="modal-orderEmail">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="orderEmailTitle">Send Update Email</h2><button class="modal-close" onclick="closeModal('orderEmail')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="orderEmailOrderId">
                <div class="form-group">
                    <label class="form-label">Email Template</label>
                    <select class="form-input" id="orderEmailTemplate" onchange="loadOrderEmailTemplate()">
                        <option value="halfway">Halfway Update - Production on Track</option>
                        <option value="completed">Dress Completed - Ready for Shipping</option>
                        <option value="arrived">Dress Arrived - Schedule Your Fitting</option>
                        <option value="ready">Ready for Pickup</option>
                        <option value="custom">Custom Message</option>
                    </select>
                    <div id="savedTemplatesGroup" style="margin-top:8px">
                        <select class="form-input" id="savedTemplates" onchange="loadSavedTemplate()" style="font-size:11px">
                            <option value="">-- Saved Templates --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">To</label><input type="email" class="form-input" id="orderEmailTo" readonly style="background:var(--blush)"></div>
                <div class="form-group"><label class="form-label">Subject</label><input type="text" class="form-input" id="orderEmailSubject"></div>
                <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="orderEmailBody" style="min-height:200px;font-size:12px;line-height:1.6"></textarea></div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                    <input type="text" class="form-input" id="newTemplateName" placeholder="Template name..." style="flex:1;font-size:11px">
                    <button class="btn btn-sm btn-secondary" onclick="saveEmailTemplate()">üíæ Save Template</button>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('orderEmail')">Cancel</button><button class="btn btn-primary" onclick="sendOrderEmail()">üìß Send Email</button></div>
        </div>
    </div>
    
    <!-- QA Checklist Modal -->
    <div class="modal-overlay" id="modal-qa">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h2 class="modal-title">üìã QA Checklist</h2><button class="modal-close" onclick="closeModal('qa')">√ó</button></div>
            <div class="modal-body">
                <div id="qaClientInfo" style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:16px"></div>
                <div id="qaChecklist"></div>
                <div class="form-group" style="margin-top:16px">
                    <label class="form-label">QA Notes</label>
                    <textarea class="form-input" id="qaNotes" placeholder="Any issues found, notes for alterations, etc." style="min-height:80px"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Checked By</label>
                    <select class="form-input" id="qaConsultant">
                        <option value="">Select consultant...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('qa')">Cancel</button>
                <button class="btn btn-primary" onclick="submitQaChecklist()">‚úì Complete QA</button>
            </div>
        </div>
    </div>

    <!-- She Said Yes -->
    <div class="modal-overlay" id="modal-yes">
        <div class="modal full">
            <div class="modal-header"><h2 class="modal-title">üíç She Said Yes!</h2><button class="modal-close" onclick="closeModal('yes')">√ó</button></div>
            <div class="modal-body">
                <div class="steps">
                    <div class="step active" id="ys1"><span class="step-num">1</span><div class="step-label">Measurements</div></div>
                    <div class="step" id="ys2"><span class="step-num">2</span><div class="step-label">Order</div></div>
                    <div class="step" id="ys3"><span class="step-num">3</span><div class="step-label">Contract</div></div>
                    <div class="step" id="ys4"><span class="step-num">4</span><div class="step-label">Signature</div></div>
                    <div class="step" id="ys5"><span class="step-num">5</span><div class="step-label">Email</div></div>
                </div>
                <div id="yStep1">
                    <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
                        <div style="display:flex;align-items:center;gap:6px;font-size:11px">
                            <span>Unit:</span>
                            <button class="btn btn-sm btn-secondary" id="unitCm" onclick="setMeasUnit('cm')">CM</button>
                            <button class="btn btn-sm" id="unitIn" onclick="setMeasUnit('in')" style="background:var(--charcoal);color:white">Inches</button>
                        </div>
                    </div>
                    <div class="meas-grid">
                        <div class="meas-item"><div class="meas-label">Bust</div><input type="text" class="meas-input" id="mBust"><div class="meas-unit" data-unit>in</div></div>
                        <div class="meas-item"><div class="meas-label">Waist</div><input type="text" class="meas-input" id="mWaist"><div class="meas-unit" data-unit>in</div></div>
                        <div class="meas-item"><div class="meas-label">Hip</div><input type="text" class="meas-input" id="mHip"><div class="meas-unit" data-unit>in</div></div>
                        <div class="meas-item"><div class="meas-label">Height</div><input type="text" class="meas-input" id="mHeight"><div class="meas-unit" data-unit>in</div></div>
                        <div class="meas-item"><div class="meas-label">Heels</div><input type="text" class="meas-input" id="mHeels"><div class="meas-unit">in</div></div>
                        <div class="meas-item"><div class="meas-label">Hollow to Hem</div><input type="text" class="meas-input" id="mHollow"><div class="meas-unit" data-unit>in</div></div>
                    </div>
                    <div style="margin-top:12px">
                        <div style="font-size:9px;letter-spacing:0.06em;text-transform:uppercase;color:var(--rose);margin-bottom:6px">Custom Measurements</div>
                        <div id="customMeasList"></div>
                        <div class="form-row" style="margin-top:6px">
                            <input type="text" class="form-input" id="customMeasName" placeholder="Name (e.g. Shoulder)">
                            <div style="display:flex;gap:4px">
                                <input type="text" class="form-input" id="customMeasValue" placeholder="Value" style="width:80px">
                                <button class="btn btn-sm btn-secondary" onclick="addCustomMeas()">+ Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:12px"><label class="form-label">Measurement Notes</label><textarea class="form-input" id="mNotes"></textarea></div>
                </div>
                <div id="yStep2" style="display:none">
                    <div class="grid-2">
                        <div>
                            <div class="form-group">
                                <label class="form-label">Item Type</label>
                                <select class="form-input" id="oiType" onchange="toggleOrderItemFields()">
                                    <option value="dress">üëó Dress (from designer)</option>
                                    <option value="accessory">‚ú® Accessory (from designer)</option>
                                    <option value="inhouse">üè† In-House Item (veil, overskirt, etc.)</option>
                                    <option value="customization">üîß Customization (add to existing item)</option>
                                    <option value="fee">üí∞ Fee (shipping, rush, etc.)</option>
                                </select>
                            </div>
                            
                            <!-- Designer Items (dress/accessory) -->
                            <div id="oiDesignerFields">
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Designer</label><input type="text" class="form-input" id="oiDesigner"></div>
                                    <div class="form-group"><label class="form-label">Style/Name</label><input type="text" class="form-input" id="oiStyle"></div>
                                </div>
                                <div class="form-row-3">
                                    <div class="form-group"><label class="form-label">Size</label><input type="text" class="form-input" id="oiSize"></div>
                                    <div class="form-group"><label class="form-label">Color</label><input type="text" class="form-input" id="oiColor"></div>
                                    <div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="oiPrice"></div>
                                </div>
                            </div>
                            
                            <!-- In-House Items -->
                            <div id="oiInhouseFields" style="display:none">
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Item Name</label><input type="text" class="form-input" id="oiInhouseName" placeholder="e.g. Cathedral Veil, Overskirt"></div>
                                    <div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="oiInhousePrice"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Production Notes</label>
                                    <textarea class="form-input" id="oiInhouseNotes" style="min-height:60px" placeholder="e.g. Seamstress to confirm length at first fitting, bride wants cathedral with blusher"></textarea>
                                </div>
                            </div>
                            
                            <!-- Customization -->
                            <div id="oiCustomFields" style="display:none">
                                <div class="form-group">
                                    <label class="form-label">Attach to Item</label>
                                    <select class="form-input" id="oiCustomParent">
                                        <option value="">Select item...</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Customization</label><input type="text" class="form-input" id="oiCustomName" placeholder="e.g. Add beading to bodice"></div>
                                    <div class="form-group"><label class="form-label">Price</label><input type="number" class="form-input" id="oiCustomPrice"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Delivery</label>
                                    <div style="display:flex;gap:12px;margin-top:4px">
                                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer">
                                            <input type="radio" name="oiCustomDelivery" value="ondress" checked> On the dress
                                        </label>
                                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer">
                                            <input type="radio" name="oiCustomDelivery" value="separate"> Sent separately
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fee -->
                            <div id="oiFeeFields" style="display:none">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Fee Type</label>
                                        <select class="form-input" id="oiFeeType">
                                            <option value="shipping">Shipping</option>
                                            <option value="rush">Rush Fee</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group"><label class="form-label">Amount</label><input type="number" class="form-input" id="oiFeePrice"></div>
                                </div>
                                <div class="form-group"><label class="form-label">Note</label><input type="text" class="form-input" id="oiFeeNote" placeholder="e.g. Express shipping from Italy"></div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addOrderItem()" style="width:100%;margin-top:12px">+ Add Item</button>
                        </div>
                        <div>
                            <div style="font-size:9px;letter-spacing:0.06em;text-transform:uppercase;color:var(--rose);margin-bottom:6px">Order Summary</div>
                            <div id="orderItems" style="max-height:300px;overflow-y:auto"></div>
                            <div style="margin:10px 0">
                                <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer">
                                    <input type="checkbox" id="addHst" onchange="renderOrderItems()"> Add 13% HST
                                </label>
                            </div>
                            <div id="orderSubtotal" style="display:none;font-size:11px;padding:6px 0;border-top:1px solid var(--champagne)"></div>
                            <div id="orderHstRow" style="display:none;font-size:11px;padding:6px 0"></div>
                            <div class="order-total"><span>Total</span><span class="order-total-value" id="orderTotal">$0</span></div>
                            <div class="form-group" style="margin-top:12px"><label class="form-label">Order Notes</label><textarea class="form-input" id="oiDetails" style="min-height:40px" placeholder="General notes about this order..."></textarea></div>
                        </div>
                    </div>
                </div>
                <div id="yStep3" style="display:none">
                    <div class="contract" id="contractPreview" style="max-height:65vh;overflow-y:auto;font-size:12px;padding:20px"></div>
                </div>
                <div id="yStep4" style="display:none">
                    <div class="grid-2">
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:8px">Measurement Initials</p>
                            <p style="font-size:10px;color:var(--rose);margin-bottom:10px">Client initials beside each measurement to confirm accuracy</p>
                            <div id="measInitials" style="background:var(--cream);padding:10px;border-radius:5px;margin-bottom:12px"></div>
                        </div>
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:8px">Consultant</p>
                            <div class="form-group"><label class="form-label">Select Consultant</label><select class="form-input" id="yConsultantSelect" onchange="loadConsultantSignature()"><option value="">Select...</option></select></div>
                            <div class="form-group"><label class="form-label">Date</label><input type="text" class="form-input" id="yDate" readonly></div>
                        </div>
                    </div>
                    
                    <div class="grid-2" style="margin-top:16px">
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:8px">Customer Signature</p>
                            <p style="font-size:10px;color:var(--rose);margin-bottom:6px">By signing, customer agrees to all terms</p>
                            <canvas id="sigPad" class="sig-pad" width="280" height="120"></canvas>
                            <div style="display:flex;justify-content:space-between;margin-top:4px">
                                <button class="btn btn-sm btn-secondary" onclick="clearSig('customer')">Clear</button>
                                <span style="font-size:9px;color:var(--rose)" id="sigTime"></span>
                            </div>
                        </div>
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:8px">Consultant Signature</p>
                            <p style="font-size:10px;color:var(--rose);margin-bottom:6px" id="consultantSigNote">Select consultant above to load signature</p>
                            <canvas id="sigPadConsultant" class="sig-pad" width="280" height="120"></canvas>
                            <div style="display:flex;justify-content:space-between;margin-top:4px">
                                <button class="btn btn-sm btn-secondary" onclick="clearSig('consultant')">Clear</button>
                                <span style="font-size:9px;color:var(--rose)" id="sigTimeConsultant"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="yStep5" style="display:none">
                    <p style="font-size:11px;color:var(--rose);margin-bottom:12px">Review the email before sending. You can edit the subject and message.</p>
                    <div class="form-group"><label class="form-label">To</label><input type="email" class="form-input" id="emailTo" readonly style="background:var(--blush)"></div>
                    <div class="form-group"><label class="form-label">Subject</label><input type="text" class="form-input" id="emailSubject"></div>
                    <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="emailBody" style="min-height:180px;font-size:12px;line-height:1.6"></textarea></div>
                    <div style="background:var(--blush);padding:10px;border-radius:5px;font-size:10px;color:var(--taupe)">
                        üìé Signed contract PDF will be attached automatically
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="yPrev" onclick="yPrev()" style="display:none">‚Üê Back</button>
                <button class="btn btn-secondary" id="ySaveDraft" onclick="saveDraft()" title="Save progress and continue later">üíæ Save Draft</button>
                <div style="flex:1"></div>
                <button class="btn btn-primary" id="yNext" onclick="yNext()">Next ‚Üí</button>
                <button class="btn btn-success" id="yDone" onclick="sendContractEmail()" style="display:none">üìß Send Contract</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ========== CONFIG ==========
        const API_URL = 'https://script.google.com/macros/s/AKfycbxXUdFREGtFzs9WHo6hYlPjE6yrtOg0sTjiY20DmWE7ETAhDG5NZOuRALwbthIQYzCzyw/exec';

        // ========== DATA ==========
        const CACHE_KEY = 'estrelle_data_cache';
        let data = { clients: [], appointments: [], topoptions: [], orders: [], alterations: [], designers: [], consultants: [], visitnotes: [] };
        let currentClient = null;
        let currentOrder = { items: [], measurements: {} };
        let editingDesigner = null;
        let originalClientNotes = { style: '', notes: '', budget: '' };

        // ========== HELPERS ==========
        const $ = id => document.getElementById(id);
        const fmtTime = t => {
            if (!t) return '';
            // Handle Google Sheets time serial numbers (fraction of day)
            if (typeof t === 'number') {
                const totalMinutes = Math.round(t * 24 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
            }
            // Handle ISO datetime strings
            if (String(t).includes('T')) {
                const timePart = String(t).split('T')[1];
                if (timePart) return timePart.substring(0,5);
            }
            return String(t).substring(0,5);
        };
        const today = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        };
        const isToday = (d) => {
            if (!d) return false;
            const todayStr = today();
            if (typeof d === 'number') {
                const date = new Date((d - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0] === todayStr;
            }
            return String(d).split('T')[0] === todayStr;
        };
        const isThisWeek = (d) => {
            if (!d) return false;
            let dateObj;
            if (typeof d === 'number') {
                dateObj = new Date((d - 25569) * 86400 * 1000);
            } else {
                dateObj = new Date(String(d).split('T')[0] + 'T00:00:00');
            }
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setHours(0, 0, 0, 0);
            const endOfWeek = new Date(now);
            endOfWeek.setDate(endOfWeek.getDate() + 7);
            endOfWeek.setHours(23, 59, 59, 999);
            return dateObj >= startOfWeek && dateObj <= endOfWeek;
        };
        const getDateStr = (d) => {
            if (!d) return '';
            if (typeof d === 'number') {
                return new Date((d - 25569) * 86400 * 1000).toISOString().split('T')[0];
            }
            return String(d).split('T')[0];
        };
        const fmtDate = d => {
            if (!d) return '‚Äî';
            // Handle Google Sheets date serial numbers
            if (typeof d === 'number') {
                const date = new Date((d - 25569) * 86400 * 1000);
                return date.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
            }
            // Handle ISO strings or date strings
            const str = String(d).split('T')[0];
            if (!str || str.includes('1899')) return '‚Äî';
            return new Date(str+'T00:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
        };
        const fmtDateLong = d => new Date(d+'T00:00:00').toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric'});
        const initials = (f,l) => (f?.[0]||'') + (l?.[0]||'');
        const money = n => '$' + Number(n||0).toLocaleString();
        const getClient = id => data.clients.find(c => c.ID == id);
        const toast = (msg, type='') => { const t = $('toast'); t.textContent = msg; t.className = 'toast show ' + type; setTimeout(() => t.className = 'toast', 3000); };
        const monthsUntil = d => { 
            if (!d) return null; 
            let weddingDate;
            if (typeof d === 'number') {
                // Google Sheets serial date
                weddingDate = new Date((d - 25569) * 86400 * 1000);
            } else {
                weddingDate = new Date(d);
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            weddingDate.setHours(0, 0, 0, 0);
            const diffMs = weddingDate - today;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            // 1 month = 4 weeks = 28 days
            const months = Math.floor(diffDays / 28);
            return Math.max(0, months);
        };

        // ========== API ==========
        async function api(method, body = null) {
            $('syncStatus').textContent = '‚óè Syncing...';
            $('syncStatus').className = 'sync-status syncing';
            try {
                const opts = { method };
                if (body) {
                    opts.method = 'POST';
                    opts.body = JSON.stringify(body);
                    opts.headers = { 'Content-Type': 'text/plain' };
                }
                const res = await fetch(API_URL + (method === 'GET' ? '?action=getAll&t=' + Date.now() : ''), opts);
                const json = await res.json();
                if (!json.success) throw new Error(json.error);
                $('syncStatus').textContent = '‚óè Synced ' + new Date().toLocaleTimeString();
                $('syncStatus').className = 'sync-status';
                return json.data;
            } catch (e) {
                $('syncStatus').textContent = '‚óè Error: ' + e.message;
                $('syncStatus').className = 'sync-status error';
                throw e;
            }
        }

        function loadCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const parsed = JSON.parse(cached);
                    data = {
                        clients: parsed.clients || [],
                        appointments: parsed.appointments || [],
                        topoptions: parsed.topoptions || [],
                        orders: parsed.orders || [],
                        alterations: parsed.alterations || [],
                        designers: parsed.designers || [],
                        consultants: parsed.consultants || [],
                        visitnotes: parsed.visitnotes || []
                    };
                    renderDash();
                    return true;
                }
            } catch (e) {
                console.log('Cache read error:', e);
            }
            return false;
        }

        function saveCachedData() {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            } catch (e) {
                console.log('Cache write error:', e);
            }
        }

        async function loadData(showToast = false) {
            try {
                const d = await api('GET');
                data = { 
                    clients: d.clients || [], 
                    appointments: d.appointments || [], 
                    topoptions: d.topoptions || [], 
                    orders: d.orders || [], 
                    alterations: d.alterations || [], 
                    designers: d.designers || [],
                    consultants: d.consultants || [],
                    visitnotes: d.visitnotes || []
                };
                saveCachedData();
                renderDash();
                if (showToast) toast('Data refreshed', 'success');
            } catch (e) { toast('Failed to load: ' + e.message, 'error'); }
        }

        async function saveRecord(sheet, record) {
            // Optimistic update - add to local data immediately with temp ID
            const tempId = Date.now();
            const newRecord = { ...record, ID: tempId };
            const sheetKey = sheet.toLowerCase();
            if (data[sheetKey]) {
                data[sheetKey].push(newRecord);
                saveCachedData();
            }
            
            // Send to server in background
            api('POST', { action: 'add', sheet, record })
                .then(res => {
                    // Update temp ID with real ID
                    if (res && res.id && data[sheetKey]) {
                        const idx = data[sheetKey].findIndex(r => r.ID === tempId);
                        if (idx >= 0) data[sheetKey][idx].ID = res.id;
                        saveCachedData();
                    }
                })
                .catch(e => {
                    // Remove optimistic record on error
                    if (data[sheetKey]) {
                        const idx = data[sheetKey].findIndex(r => r.ID === tempId);
                        if (idx >= 0) data[sheetKey].splice(idx, 1);
                        saveCachedData();
                    }
                    toast('Save failed - please refresh', 'error');
                });
            
            return { id: tempId };
        }

        async function updateRecord(sheet, id, record) {
            // Optimistic update - update local data immediately
            const sheetKey = sheet.toLowerCase();
            if (data[sheetKey]) {
                const idx = data[sheetKey].findIndex(r => r.ID == id);
                if (idx >= 0) {
                    data[sheetKey][idx] = { ...data[sheetKey][idx], ...record };
                    saveCachedData();
                }
            }
            
            // Send to server in background
            api('POST', { action: 'update', sheet, id, record })
                .catch(e => {
                    toast('Update failed - please refresh', 'error');
                });
        }

        async function deleteRecord(sheet, id) {
            // Optimistic update - remove from local data immediately
            const sheetKey = sheet.toLowerCase();
            if (data[sheetKey]) {
                const removedIdx = data[sheetKey].findIndex(r => r.ID == id);
                if (removedIdx >= 0) {
                    data[sheetKey].splice(removedIdx, 1);
                    saveCachedData();
                }
            }
            
            // Send to server in background (fire and forget)
            api('POST', { action: 'delete', sheet, id }).catch(() => {});
        }

        function refreshData() { loadData(true); }

        // ========== NAV ==========
        function showPage(name, skipUnsavedCheck = false) {
            // Check for unsaved changes when leaving consult page
            const currentPage = document.querySelector('.section.active')?.id;
            if (!skipUnsavedCheck && currentPage === 'page-consult' && name !== 'consult') {
                if (hasUnsavedClientNotes()) {
                    if (!confirm('You have unsaved notes. Leave without saving?')) {
                        return; // Stay on current page
                    }
                }
                // Clear currentClient when leaving consult
                currentClient = null;
            }
            
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            $('page-' + name)?.classList.add('active');
            document.querySelector(`.nav-item[data-page="${name}"]`)?.classList.add('active');
            if (name === 'clients') renderClients();
            if (name === 'week') renderWeek();
            if (name === 'appointments') renderAllAppointments();
            if (name === 'orders') renderOrders();
            if (name === 'alterations') renderAlts();
            if (name === 'designers') renderDesigners();
            if (name === 'consultants') renderConsultants();
            if (name === 'analytics') renderAnalytics();
        }

        function openModal(n) { 
            $('modal-' + n)?.classList.add('active'); 
            // Only populate if NOT editing AND not pre-filled (apptForClientId indicates pre-fill)
            if (n === 'newAppt' && !$('editApptId').value && !$('apptForClientId').value) populateApptModal(); 
            if (n === 'addOption') populateOptionModal(); 
            if (n === 'newConsultant') initConsultantSigPad();
        }
        function closeModal(n) { 
            $('modal-' + n)?.classList.remove('active'); 
            // Re-enable client dropdown if it was disabled
            if (n === 'newAppt' && $('aClient')) {
                $('aClient').disabled = false;
                $('apptForClientId').value = ''; // Reset pre-fill flag
            }
        }

        // ========== DASHBOARD ==========
        function renderDash() {
            $('todayDate').textContent = fmtDateLong(today());
            const t = today();
            const todayAppts = data.appointments.filter(a => isToday(a.Date));
            $('statToday').textContent = todayAppts.length;
            $('statOrders').textContent = data.orders.filter(o => o.Status !== 'complete').length;
            $('statAlts').textContent = data.alterations.length;
            $('statClients').textContent = data.clients.length;

            const appts = todayAppts.sort((a,b) => (a.Time||'').localeCompare(b.Time||''));
            $('dashToday').innerHTML = appts.length ? appts.map(a => {
                const c = getClient(a.ClientID);
                return `<div class="list-item" onclick="${c ? `openClient(${a.ClientID})` : ''}">
                    <div class="avatar">${c ? initials(c.FirstName, c.LastName) : '?'}</div>
                    <div class="item-info"><div class="item-name">${c ? c.FirstName + ' ' + c.LastName : '?'}</div><div class="item-meta">${fmtTime(a.Time)} ¬∑ ${a.Type||''} ¬∑ ${a.Consultant||''}</div></div>
                    <div style="display:flex;gap:4px">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteAppt(${a.ID})">‚úï</button>
                        ${c ? `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation();openClient(${a.ClientID})">Start</button>` : ''}
                    </div>
                </div>`;
            }).join('') : '<div class="empty">No appointments today</div>';

            // Weekly appointments (excluding today)
            const weekAppts = data.appointments
                .filter(a => isThisWeek(a.Date) && !isToday(a.Date))
                .sort((a,b) => {
                    const dateCompare = getDateStr(a.Date).localeCompare(getDateStr(b.Date));
                    if (dateCompare !== 0) return dateCompare;
                    return (a.Time||'').localeCompare(b.Time||'');
                });
            
            $('dashWeek').innerHTML = weekAppts.length ? weekAppts.map(a => {
                const c = getClient(a.ClientID);
                const dateStr = fmtDate(a.Date);
                return `<div class="list-item" onclick="${c ? `openClient(${a.ClientID})` : ''}">
                    <div class="avatar">${c ? initials(c.FirstName, c.LastName) : '?'}</div>
                    <div class="item-info"><div class="item-name">${c ? c.FirstName + ' ' + c.LastName : '?'}</div><div class="item-meta">${dateStr} ${fmtTime(a.Time)} ¬∑ ${a.Type||''} ¬∑ ${a.Consultant||''}${a.ConfirmationSent ? ' ¬∑ ‚úì' : ''}</div></div>
                    <div style="display:flex;gap:4px">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteAppt(${a.ID})">‚úï</button>
                        <button class="btn btn-sm ${a.ConfirmationSent ? 'btn-success' : 'btn-secondary'}" onclick="event.stopPropagation();openConfirmEmailModal(${a.ID})">${a.ConfirmationSent ? '‚úìüìß' : 'üìß'}</button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();editAppt(${a.ID})">Edit</button>
                    </div>
                </div>`;
            }).join('') : '<div class="empty">No more appointments this week</div>';

            const recent = [...data.clients].sort((a,b) => (b.LastVisit||'').localeCompare(a.LastVisit||'')).slice(0, 5);
            $('dashRecent').innerHTML = recent.length ? recent.map(c => `
                <div class="list-item" onclick="openClient(${c.ID})">
                    <div class="avatar">${initials(c.FirstName, c.LastName)}</div>
                    <div class="item-info"><div class="item-name">${c.FirstName} ${c.LastName}</div><div class="item-meta">${fmtDate(c.LastVisit)}</div></div>
                    <span class="status status-${c.Status||'new'}">${c.Status||'new'}</span>
                </div>
            `).join('') : '<div class="empty">No clients yet</div>';
        }

        // ========== CLIENTS ==========
        function renderClients() {
            const activeClients = data.clients.filter(c => c.Status !== 'archived');
            $('clientCount').textContent = activeClients.length + ' clients';
            $('clientsTable').innerHTML = activeClients.length ? activeClients.map(c => `
                <tr onclick="openClient(${c.ID})">
                    <td><div style="display:flex;align-items:center;gap:6px"><div class="avatar" style="width:28px;height:28px;font-size:11px">${initials(c.FirstName,c.LastName)}</div><div><div style="font-weight:500">${c.FirstName} ${c.LastName}</div><div style="font-size:9px;color:var(--rose)">${c.Email||''}</div></div></div></td>
                    <td>${fmtDate(c.WeddingDate)}</td>
                    <td><span class="status status-${c.Status||'new'}">${c.Status||'new'}</span></td>
                    <td>${fmtDate(c.LastVisit)}</td>
                    <td><button class="action-btn" onclick="event.stopPropagation();editClient(${c.ID})">Edit</button></td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="empty">No clients</td></tr>';
        }

        function filterClients() {
            const s = $('clientSearch').value.toLowerCase();
            document.querySelectorAll('#clientsTable tr').forEach(r => r.style.display = r.textContent.toLowerCase().includes(s) ? '' : 'none');
        }

        function editClient(id) {
            const c = getClient(id);
            if (!c) return;
            $('clientModalTitle').textContent = 'Edit Client';
            $('editClientId').value = c.ID;
            $('nFirstName').value = c.FirstName || '';
            $('nLastName').value = c.LastName || '';
            $('nEmail').value = c.Email || '';
            $('nPhone').value = c.Phone || '';
            $('nWedding').value = c.WeddingDate || '';
            $('nVenue').value = c.Venue || '';
            $('nBookingNotes').value = c.BookingNotes || '';
            openModal('newClient');
        }

        async function saveClient() {
            const id = $('editClientId').value;
            const existingClient = id ? getClient(id) : null;
            const record = {
                FirstName: $('nFirstName').value,
                LastName: $('nLastName').value,
                Email: $('nEmail').value,
                Phone: $('nPhone').value,
                WeddingDate: $('nWedding').value,
                Venue: $('nVenue').value,
                DestinationWedding: $('nDestination').checked,
                LeavingDate: $('nDestination').checked ? $('nLeavingDate').value : '',
                BookingNotes: $('nBookingNotes').value,
                Status: existingClient ? existingClient.Status : 'new',
                LastVisit: existingClient ? existingClient.LastVisit : today()
            };
            if (!record.FirstName || !record.LastName) { toast('Enter name'); return; }
            
            // Close modal immediately
            closeModal('newClient');
            toast('Saving...', '');
            
            if (id) { 
                updateRecord('Clients', id, record);
                // Refresh current client view if editing current client
                if (currentClient && currentClient.ID == id) {
                    currentClient = { ...currentClient, ...record };
                    $('cName').textContent = record.FirstName + ' ' + record.LastName;
                    let metaText = `Wedding: ${fmtDate(record.WeddingDate)} ¬∑ ${record.Venue || 'Venue TBD'}`;
                    if (record.DestinationWedding && record.LeavingDate) {
                        metaText += ` ¬∑ ‚úàÔ∏è Leaving: ${fmtDate(record.LeavingDate)}`;
                    }
                    $('cMeta').textContent = metaText;
                    updateTimeline();
                }
            } else { 
                saveRecord('Clients', record); 
            }
            
            $('editClientId').value = '';
            $('clientModalTitle').textContent = 'New Client';
            ['nFirstName','nLastName','nEmail','nPhone','nWedding','nVenue','nBookingNotes','nLeavingDate'].forEach(i => $(i).value = '');
            $('nDestination').checked = false;
            $('leavingDateGroup').style.display = 'none';
            toast('Saved!', 'success');
        }
        
        function toggleLeavingDate() {
            $('leavingDateGroup').style.display = $('nDestination').checked ? 'block' : 'none';
        }
        
        function formatBudget(input) {
            let val = input.value.replace(/[^0-9,\-\s]/g, '').trim();
            if (val && !val.startsWith('$')) {
                // Add $ to start if there's content
                val = '$' + val;
            }
            // Handle ranges like "4000-5000" -> "$4,000-$5,000"
            val = val.replace(/(\d+)/g, (match) => {
                return parseInt(match).toLocaleString();
            });
            // Add $ after hyphen for ranges
            val = val.replace(/-\s*(\d)/g, '-$$$1');
            input.value = val;
        }

        function editCurrentClient() {
            if (!currentClient) return;
            const c = currentClient;
            $('editClientId').value = c.ID;
            $('clientModalTitle').textContent = 'Edit Client';
            $('nFirstName').value = c.FirstName || '';
            $('nLastName').value = c.LastName || '';
            $('nEmail').value = c.Email || '';
            $('nPhone').value = c.Phone || '';
            // Handle date - could be ISO string or Google serial
            if (c.WeddingDate) {
                if (typeof c.WeddingDate === 'number') {
                    const d = new Date((c.WeddingDate - 25569) * 86400 * 1000);
                    $('nWedding').value = d.toISOString().split('T')[0];
                } else {
                    $('nWedding').value = String(c.WeddingDate).split('T')[0];
                }
            } else {
                $('nWedding').value = '';
            }
            $('nVenue').value = c.Venue || '';
            $('nBookingNotes').value = c.BookingNotes || '';
            
            // Destination wedding
            $('nDestination').checked = c.DestinationWedding === true || c.DestinationWedding === 'TRUE';
            $('leavingDateGroup').style.display = $('nDestination').checked ? 'block' : 'none';
            if (c.LeavingDate) {
                if (typeof c.LeavingDate === 'number') {
                    const d = new Date((c.LeavingDate - 25569) * 86400 * 1000);
                    $('nLeavingDate').value = d.toISOString().split('T')[0];
                } else {
                    $('nLeavingDate').value = String(c.LeavingDate).split('T')[0];
                }
            } else {
                $('nLeavingDate').value = '';
            }
            
            openModal('newClient');
        }
        
        async function archiveCurrentClient() {
            if (!currentClient) return;
            const name = `${currentClient.FirstName} ${currentClient.LastName}`;
            if (!confirm(`Archive "${name}"?\n\nThis will hide them from the active clients list.`)) return;
            
            updateRecord('Clients', currentClient.ID, { Status: 'archived', ArchivedAt: new Date().toISOString() });
            toast(`${name} archived`, 'success');
            showPage('clients');
        }
        
        async function deleteCurrentClient() {
            if (!currentClient) return;
            const name = `${currentClient.FirstName} ${currentClient.LastName}`;
            
            if (!confirm(`‚ö†Ô∏è DELETE "${name}"?\n\nThis is permanent and cannot be undone.`)) {
                return;
            }
            
            deleteRecord('Clients', currentClient.ID);
            toast(`${name} deleted`, 'success');
            showPage('clients');
        }

        // ========== THIS WEEK ==========
        let weekOffset = 0; // 0 = current week, -1 = last week, 1 = next week, etc.
        
        function changeWeek(delta) {
            if (delta === 0) {
                weekOffset = 0; // Reset to current week
            } else {
                weekOffset += delta;
            }
            renderWeek();
        }
        
        function renderWeek() {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(startOfWeek.getDate() + (weekOffset * 7));
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Update title based on offset
            if (weekOffset === 0) {
                $('weekTitle').textContent = 'This Week';
            } else if (weekOffset === -1) {
                $('weekTitle').textContent = 'Last Week';
            } else if (weekOffset === 1) {
                $('weekTitle').textContent = 'Next Week';
            } else if (weekOffset < 0) {
                $('weekTitle').textContent = `${Math.abs(weekOffset)} Weeks Ago`;
            } else {
                $('weekTitle').textContent = `${weekOffset} Weeks Ahead`;
            }
            
            const formatSubDate = d => d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            $('weekSub').textContent = `${formatSubDate(startOfWeek)} ‚Äì ${formatSubDate(endOfWeek)}, ${startOfWeek.getFullYear()}`;
            
            // Get all appointments for the selected week
            const weekAppts = data.appointments
                .filter(a => {
                    let dateObj;
                    if (typeof a.Date === 'number') {
                        dateObj = new Date((a.Date - 25569) * 86400 * 1000);
                    } else {
                        dateObj = new Date(String(a.Date).split('T')[0] + 'T00:00:00');
                    }
                    return dateObj >= startOfWeek && dateObj <= endOfWeek;
                })
                .sort((a,b) => {
                    const dateCompare = getDateStr(a.Date).localeCompare(getDateStr(b.Date));
                    if (dateCompare !== 0) return dateCompare;
                    return (a.Time||'').localeCompare(b.Time||'');
                });
            
            if (!weekAppts.length) {
                $('weekList').innerHTML = '<div class="card"><div class="card-body empty">No appointments this week</div></div>';
                return;
            }
            
            // Group by date
            const grouped = {};
            weekAppts.forEach(a => {
                const dateKey = getDateStr(a.Date);
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(a);
            });
            
            // Render grouped
            let html = '';
            Object.keys(grouped).sort().forEach(dateKey => {
                const appts = grouped[dateKey];
                const dateObj = new Date(dateKey + 'T00:00:00');
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                const isTodays = dateKey === today();
                
                html += `<div class="card" style="margin-bottom:14px">
                    <div class="card-header" style="background:${isTodays ? 'var(--blush)' : 'var(--cream)'}">
                        <h2 class="card-title">${dayName}${isTodays ? ' (Today)' : ''}</h2>
                        <span style="font-size:11px;color:var(--rose)">${appts.length} appointment${appts.length > 1 ? 's' : ''}</span>
                    </div>
                    <div class="card-body" style="padding:0">
                        ${appts.map(a => {
                            const c = getClient(a.ClientID);
                            const typeClass = `appt-type-${a.Type || 'consultation'}`;
                            return `<div class="${typeClass}" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding:12px 14px;border-bottom:1px solid var(--blush)">
                                <div style="display:flex;align-items:center;gap:12px">
                                    <div style="font-family:'Cormorant Garamond',serif;font-size:18px;width:50px">${fmtTime(a.Time)}</div>
                                    <div class="avatar">${c ? initials(c.FirstName, c.LastName) : '?'}</div>
                                    <div><div style="font-weight:500">${c ? c.FirstName + ' ' + c.LastName : '?'}</div><div style="font-size:10px;color:var(--rose)">${a.Type||''} ¬∑ ${a.Consultant||''}${a.ConfirmationSent ? ' ¬∑ ‚úì Confirmed' : ''}</div></div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteAppt(${a.ID})" style="margin-right:4px">‚úï</button>
                                    <button class="btn btn-sm ${a.ConfirmationSent ? 'btn-success' : 'btn-secondary'}" onclick="event.stopPropagation();openConfirmEmailModal(${a.ID})" style="margin-right:4px" title="${a.ConfirmationSent ? 'Confirmation sent - click to resend' : 'Send confirmation email'}">${a.ConfirmationSent ? '‚úìüìß' : 'üìß'}</button>
                                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();editAppt(${a.ID})" style="margin-right:4px">Edit</button>
                                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();openClient(${a.ClientID})"${c ? '' : ' disabled'}>Start</button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            });
            
            $('weekList').innerHTML = html;
        }

        // ========== ALL APPOINTMENTS ==========
        function renderAllAppointments() {
            const filter = $('apptFilter').value;
            const typeFilter = $('apptTypeFilter').value;
            const search = $('apptSearch').value.toLowerCase();
            const todayStr = today();
            
            let appts = [...data.appointments];
            
            // Filter by time
            if (filter === 'upcoming') {
                appts = appts.filter(a => getDateStr(a.Date) >= todayStr);
            } else if (filter === 'past') {
                appts = appts.filter(a => getDateStr(a.Date) < todayStr);
            }
            
            // Filter by type
            if (typeFilter) {
                appts = appts.filter(a => (a.Type || '').toLowerCase().includes(typeFilter.toLowerCase()));
            }
            
            // Filter by search
            if (search) {
                appts = appts.filter(a => {
                    const c = getClient(a.ClientID);
                    const clientName = c ? `${c.FirstName} ${c.LastName}`.toLowerCase() : '';
                    return clientName.includes(search);
                });
            }
            
            // Sort by date descending for past, ascending for upcoming/all
            appts.sort((a, b) => {
                const dateCompare = getDateStr(a.Date).localeCompare(getDateStr(b.Date));
                if (filter === 'past') return -dateCompare; // Most recent first for past
                return dateCompare; // Soonest first for upcoming/all
            });
            
            $('apptCount').textContent = `${appts.length} appointment${appts.length !== 1 ? 's' : ''}`;
            
            $('allApptTable').innerHTML = appts.length ? appts.map(a => {
                const c = getClient(a.ClientID);
                const isPast = getDateStr(a.Date) < todayStr;
                return `<tr style="${isPast ? 'opacity:0.6' : ''}" onclick="${c ? `openClient(${a.ClientID})` : ''}">
                    <td>${fmtDate(a.Date)}</td>
                    <td>${fmtTime(a.Time)}</td>
                    <td>${c ? c.FirstName + ' ' + c.LastName : '?'}</td>
                    <td><span class="status status-${(a.Type||'consultation').replace(' ','-')}">${a.Type || 'consultation'}</span></td>
                    <td>${a.Consultant || ''}${a.ConfirmationSent ? ' <span style="color:green">‚úì</span>' : ''}</td>
                    <td style="text-align:right">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteAppt(${a.ID})">‚úï</button>
                        <button class="btn btn-sm ${a.ConfirmationSent ? 'btn-success' : 'btn-secondary'}" onclick="event.stopPropagation();openConfirmEmailModal(${a.ID})">${a.ConfirmationSent ? '‚úìüìß' : 'üìß'}</button>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();editAppt(${a.ID})">Edit</button>
                    </td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="empty">No appointments found</td></tr>';
        }

        async function deleteAppt(id) {
            if (!confirm('Delete this appointment?')) return;
            
            // Remove from local data immediately (optimistic)
            const removedIdx = data.appointments.findIndex(a => a.ID == id);
            if (removedIdx >= 0) {
                data.appointments.splice(removedIdx, 1);
                saveCachedData();
            }
            
            // Update UI immediately
            toast('Appointment deleted', 'success');
            renderDash();
            renderWeek();
            renderAllAppointments();
            if (currentClient) renderClientAppts();
            
            // Send to server in background (fire and forget)
            api('POST', { action: 'delete', sheet: 'Appointments', id }).catch(() => {});
        }

        // ========== CONFIRMATION EMAIL ==========
        const DEFAULT_CONFIRM_TEMPLATE = `Hi {{firstName}}, 

Thank you for booking a bridal consultation with us at Estrelle Bridal, we can't wait to meet you and help you find the one!

Appointment: {{appointmentDate}} @{{appointmentTime}}

WHAT TO EXPECT DURING YOUR BRIDAL CONSULTATION

1. You're allowed up to 4 guests MAXIMUM
2. Shoes are not permitted in the private fitting rooms. We provide slippers and shoe covers for every guest
3. We provide heels, spanx, and hair ties; we recommend wearing nude or white underwear
4. We require a 48 hour notice for cancellations to ensure you get your full refund. Includes one rescheduling
5. Please give us a call if you are running late. If you are more than 15 minutes late to your consultation, you will automatically have a shorter appointment time. If you don't respond within 30 min of contacting you, your appointment is automatically cancelled!

I am not sure if you are familiar with our assortment or if you have a particular dress direction you are hoping to explore? If you can share some of your inspirations with us that would be great!

Below I have included a list of our collections with some additional details that I thought could prove to be helpful to you in your initial research. 

Our designers and price ranges:
Vivienne Westwood $8,000- $20,000
Netta Benshabu $12,800- $17,000 
Lihi Hod $10,000-$15,000
Nicole + Felicia $3,900- $11,000
Stephane Rolland $10,000- $17,000
Corston Couture $6,000- $9,000
Tina Valerdi $3,900-$6,000
Enaura Bridal $6,000- $10,000

*Please note that most of our dresses are customizable* 

Parking:
There is paid underground parking in the Yorkville Village building, look for the Wholefoods.
We are located on the upper level of the mall, near the escalators and across from TNT Fashion.  

Please let me know if you have any questions at all or if I can provide any additional information to you prior to your consultation with us. 

I recommend browsing our website and coming to the appointment prepared with dresses that you want to try on. 

Please respond to this message to confirm the details above. 

We look forward to hearing from you soon! :)

Best regards, 
The Estrelle Bridal Team`;

        const CONFIRM_TEMPLATE_KEY = 'estrelle_confirm_template';

        function getConfirmTemplate() {
            return localStorage.getItem(CONFIRM_TEMPLATE_KEY) || DEFAULT_CONFIRM_TEMPLATE;
        }

        function saveConfirmTemplate() {
            localStorage.setItem(CONFIRM_TEMPLATE_KEY, $('confirmBody').value);
            toast('Template saved!', 'success');
        }

        function resetConfirmTemplate() {
            if (!confirm('Reset to default template? Your saved template will be lost.')) return;
            localStorage.removeItem(CONFIRM_TEMPLATE_KEY);
            const apptId = $('confirmApptId').value;
            if (apptId) openConfirmEmailModal(+apptId);
            toast('Template reset to default', 'success');
        }

        function openConfirmEmailModal(apptId) {
            const appt = data.appointments.find(a => a.ID == apptId);
            if (!appt) { toast('Appointment not found', 'error'); return; }
            
            const client = getClient(appt.ClientID);
            if (!client) { toast('Client not found', 'error'); return; }
            
            if (!client.Email) { 
                toast('No email address for this client. Please add one first.', 'error'); 
                return; 
            }
            
            // Format appointment date (handle Google Sheets serial dates)
            let apptDate = '';
            if (appt.Date) {
                let dateObj;
                if (typeof appt.Date === 'number') {
                    dateObj = new Date((appt.Date - 25569) * 86400 * 1000);
                } else {
                    dateObj = new Date(String(appt.Date).split('T')[0] + 'T00:00:00');
                }
                apptDate = dateObj.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});
            }
            const apptTime = fmtTime(appt.Time);
            
            // Fill in template
            let body = getConfirmTemplate();
            body = body.replace(/\{\{firstName\}\}/g, client.FirstName || '');
            body = body.replace(/\{\{lastName\}\}/g, client.LastName || '');
            body = body.replace(/\{\{appointmentDate\}\}/g, apptDate);
            body = body.replace(/\{\{appointmentTime\}\}/g, apptTime);
            body = body.replace(/\{\{appointmentType\}\}/g, appt.Type || 'consultation');
            
            $('confirmApptId').value = apptId;
            $('confirmTo').value = client.Email;
            $('confirmSubject').value = `Estrelle Bridal - Appointment Confirmation for ${client.FirstName}`;
            $('confirmBody').value = body;
            
            openModal('confirmEmail');
        }

        async function sendConfirmationEmail() {
            const apptId = $('confirmApptId').value;
            const to = $('confirmTo').value;
            const subject = $('confirmSubject').value;
            const body = $('confirmBody').value;
            
            if (!to) { toast('No email address', 'error'); return; }
            
            closeModal('confirmEmail');
            toast('Sending email...', 'success');
            
            try {
                await api('POST', { 
                    action: 'sendConfirmation', 
                    email: to, 
                    subject: subject, 
                    body: body 
                });
                
                // Mark appointment as confirmation sent
                updateRecord('Appointments', apptId, { ConfirmationSent: new Date().toISOString() });
                
                // Update local data
                const appt = data.appointments.find(a => a.ID == apptId);
                if (appt) appt.ConfirmationSent = new Date().toISOString();
                
                toast('‚úì Confirmation email sent!', 'success');
                
                // Re-render views
                renderDash();
                renderWeek();
                renderAllAppointments();
            } catch (e) {
                toast('Failed to send email', 'error');
            }
        }

        function populateApptModal(forClientId = null) {
            // Reset fields
            $('editApptId').value = '';
            $('apptForClientId').value = forClientId || '';
            $('aDate').value = today();
            $('aTime').value = '';
            $('aType').value = 'consultation';
            $('aConsultant').value = '';
            $('apptModalTitle').textContent = 'New Appointment';
            
            // Re-enable client dropdown (may have been disabled)
            $('aClient').disabled = false;
            
            // Reset new client fields
            ['aNewFirstName','aNewLastName','aNewEmail','aNewPhone','aNewWedding','aNewVenue'].forEach(id => $(id).value = '');
            $('newClientFields').style.display = 'none';
            
            // Reset structured visit log fields
            ['aLogDresses','aLogFeedback','aLogStyle','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => $(id).value = '');
            
            // Reset consultation reason
            $('consultationReasonGroup').style.display = 'block'; // Show by default (consultation)
            document.querySelectorAll('input[name="aReason"]').forEach(r => r.checked = false);
            $('aReasonOther').style.display = 'none';
            $('aReasonOther').value = '';
            
            // Reset fitting fields (hidden by default)
            $('fittingFieldsGroup').style.display = 'none';
            $('aDressNeededBy').value = '';
            $('aWeddingDateDisplay').value = '';
            $('aDaysUntilWedding').textContent = '';
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            
            if (forClientId) {
                // Adding appointment for specific client - show fixed client name, NO new client option
                const c = getClient(forClientId);
                $('clientSelectGroup').style.display = 'none';
                $('clientFixedGroup').style.display = 'block';
                $('aClientName').value = c ? `${c.FirstName} ${c.LastName}` : '';
                $('aClient').value = forClientId;
            } else {
                // General appointment - show client dropdown with "new" option
                $('clientSelectGroup').style.display = 'block';
                $('clientFixedGroup').style.display = 'none';
                const activeClients = data.clients.filter(c => c.Status !== 'archived');
                $('aClient').innerHTML = '<option value="">Select existing...</option><option value="new">+ Create New Client</option>' + 
                    activeClients.map(c => `<option value="${c.ID}">${c.FirstName} ${c.LastName}</option>`).join('');
            }
        }
        
        function toggleNewClientFields() {
            const isNew = $('aClient').value === 'new';
            $('newClientFields').style.display = isNew ? 'block' : 'none';
        }
        
        function toggleConsultationReason() {
            const type = $('aType').value;
            const isConsultation = type === 'consultation';
            const isFitting = type.includes('fitting');
            
            // Show/hide consultation reason
            $('consultationReasonGroup').style.display = isConsultation ? 'block' : 'none';
            if (!isConsultation) {
                // Clear reason selection when not consultation
                document.querySelectorAll('input[name="aReason"]').forEach(r => r.checked = false);
                $('aReasonOther').style.display = 'none';
                $('aReasonOther').value = '';
            }
            
            // Show/hide fitting fields
            $('fittingFieldsGroup').style.display = isFitting ? 'block' : 'none';
            
            // If fitting and client is selected, populate wedding date
            if (isFitting) {
                const clientId = $('aClient').value || $('apptForClientId').value;
                if (clientId) {
                    const c = getClient(clientId);
                    if (c && c.WeddingDate) {
                        $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                        const weddingDate = parseDate(c.WeddingDate);
                        if (weddingDate) {
                            const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                            $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                            // Default dress needed by to 2 weeks before wedding
                            const neededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                            $('aDressNeededBy').value = neededBy.toISOString().split('T')[0];
                        }
                    }
                }
            }
        }
        
        function toggleOtherReason() {
            const otherChecked = document.querySelector('input[name="aReason"][value="other"]').checked;
            $('aReasonOther').style.display = otherChecked ? 'block' : 'none';
            if (otherChecked) $('aReasonOther').focus();
        }
        
        function getSelectedReason() {
            const selected = document.querySelector('input[name="aReason"]:checked');
            if (!selected) return '';
            if (selected.value === 'other') {
                return $('aReasonOther').value.trim() || 'Other';
            }
            const labels = { first: 'First Visit', revisit: 'Revisit Favourites', sayyes: 'Say Yes üíç', trymore: 'Try More Options' };
            return labels[selected.value] || selected.value;
        }
        
        function setSelectedReason(reason) {
            if (!reason) return;
            const labels = { 'First Visit': 'first', 'Revisit Favourites': 'revisit', 'Say Yes üíç': 'sayyes', 'Try More Options': 'trymore' };
            const value = labels[reason];
            if (value) {
                const radio = document.querySelector(`input[name="aReason"][value="${value}"]`);
                if (radio) radio.checked = true;
            } else {
                // It's an "other" reason
                const otherRadio = document.querySelector('input[name="aReason"][value="other"]');
                if (otherRadio) {
                    otherRadio.checked = true;
                    $('aReasonOther').style.display = 'block';
                    $('aReasonOther').value = reason;
                }
            }
        }

        function editAppt(id) {
            const a = data.appointments.find(x => x.ID == id);
            if (!a) return;
            
            // Set edit mode
            $('apptModalTitle').textContent = 'Edit Appointment';
            $('editApptId').value = a.ID;
            $('apptForClientId').value = '';
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            ['aNewFirstName','aNewLastName','aNewEmail','aNewPhone','aNewWedding','aNewVenue'].forEach(id => $(id).value = '');
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(c => `<option value="${c.Name}" ${c.Name === a.Consultant ? 'selected' : ''}>${c.Name}</option>`).join('');
            
            // Check if we're on a client profile - hide client selection entirely
            if (currentClient && a.ClientID == currentClient.ID) {
                $('clientSelectGroup').style.display = 'none';
                $('clientFixedGroup').style.display = 'block';
                $('aClientName').value = `${currentClient.FirstName} ${currentClient.LastName}`;
                $('apptForClientId').value = a.ClientID; // Set this so saveAppt knows the client
            } else {
                // Editing from Today page or elsewhere - show client dropdown
                $('clientSelectGroup').style.display = 'block';
                $('clientFixedGroup').style.display = 'none';
                const activeClients = data.clients.filter(c => c.Status !== 'archived');
                $('aClient').innerHTML = '<option value="">Select...</option>' + 
                    activeClients.map(c => `<option value="${c.ID}" ${c.ID == a.ClientID ? 'selected' : ''}>${c.FirstName} ${c.LastName}</option>`).join('');
            }
            
            // Handle date format
            if (a.Date) {
                if (typeof a.Date === 'number') {
                    const d = new Date((a.Date - 25569) * 86400 * 1000);
                    $('aDate').value = d.toISOString().split('T')[0];
                } else {
                    $('aDate').value = String(a.Date).split('T')[0];
                }
            } else {
                $('aDate').value = '';
            }
            $('aTime').value = a.Time || '';
            $('aType').value = a.Type || 'consultation';
            
            // Show/hide consultation reason based on type
            toggleConsultationReason();
            
            // Clear and set reason
            document.querySelectorAll('input[name="aReason"]').forEach(r => r.checked = false);
            $('aReasonOther').style.display = 'none';
            $('aReasonOther').value = '';
            
            // Parse notes into structured fields
            const notes = a.Notes || '';
            const parseField = (emoji, prefix) => {
                const regex = new RegExp(`${emoji}\\s*${prefix}:\\s*(.+?)(?=\\n\\n|$)`, 's');
                const match = notes.match(regex);
                return match ? match[1].trim() : '';
            };
            
            // Parse reason from notes
            const reason = parseField('üéØ', 'Reason');
            if (reason) setSelectedReason(reason);
            
            $('aLogDresses').value = parseField('üëó', 'Tried');
            $('aLogFeedback').value = parseField('üí≠', 'Feedback');
            $('aLogStyle').value = parseField('‚ú®', 'Style');
            $('aLogBudget').value = parseField('üí∞', 'Budget');
            $('aLogNextSteps').value = parseField('üìã', 'Next');
            $('aLogOther').value = parseField('üìù', 'Notes');
            
            // If notes don't match structured format, put everything in "other"
            if (!$('aLogDresses').value && !$('aLogFeedback').value && !$('aLogStyle').value && 
                !$('aLogBudget').value && !$('aLogNextSteps').value && !$('aLogOther').value && !reason && notes) {
                $('aLogOther').value = notes;
            }
            
            openModal('newAppt');
        }

        async function saveAppt() {
            const id = $('editApptId').value;
            const forClientId = $('apptForClientId').value;
            let clientId = forClientId || $('aClient').value;
            
            // If creating new client
            if (clientId === 'new') {
                const firstName = $('aNewFirstName').value.trim();
                const lastName = $('aNewLastName').value.trim();
                if (!firstName || !lastName) { 
                    toast('Enter client name'); 
                    return; 
                }
                
                // Create new client first
                const newClient = {
                    FirstName: firstName,
                    LastName: lastName,
                    Email: $('aNewEmail').value,
                    Phone: $('aNewPhone').value,
                    WeddingDate: $('aNewWedding').value,
                    Venue: $('aNewVenue').value,
                    Status: 'new',
                    LastVisit: today()
                };
                const result = await saveRecord('Clients', newClient);
                clientId = result.id;
                
                // Add to local data so client is immediately available
                newClient.ID = clientId;
                data.clients.push(newClient);
            }
            
            if (!clientId || !$('aDate').value) { 
                toast('Select client and date'); 
                return; 
            }
            
            // Combine structured fields into notes
            const noteParts = [];
            
            // Add reason for consultation appointments
            if ($('aType').value === 'consultation') {
                const reason = getSelectedReason();
                if (reason) noteParts.push(`üéØ Reason: ${reason}`);
            }
            
            const dresses = $('aLogDresses').value.trim();
            const feedback = $('aLogFeedback').value.trim();
            const style = $('aLogStyle').value.trim();
            const budget = $('aLogBudget').value.trim();
            const nextSteps = $('aLogNextSteps').value.trim();
            const other = $('aLogOther').value.trim();
            
            if (dresses) noteParts.push(`üëó Tried: ${dresses}`);
            if (feedback) noteParts.push(`üí≠ Feedback: ${feedback}`);
            if (style) noteParts.push(`‚ú® Style: ${style}`);
            if (budget) noteParts.push(`üí∞ Budget: ${budget}`);
            if (nextSteps) noteParts.push(`üìã Next: ${nextSteps}`);
            if (other) noteParts.push(`üìù Notes: ${other}`);
            
            const record = { 
                ClientID: +clientId, 
                Date: $('aDate').value, 
                Time: $('aTime').value, 
                Type: $('aType').value, 
                Consultant: $('aConsultant').value, 
                Notes: noteParts.join('\n\n')
            };
            
            // Close immediately
            closeModal('newAppt');
            toast('Saved!', 'success');
            
            if (id) { 
                updateRecord('Appointments', id, record); 
            } else { 
                saveRecord('Appointments', record); 
            }
            
            if (currentClient) {
                renderClientAppts();
                renderVisitHistory();
            }
            renderWeek();
            renderAllAppointments();
            renderDash();
        }

        // ========== ORDERS ==========
        const ORDER_STATUSES = [
            'ordered',
            'in production',
            'shipped',
            'arrived - pending QA',
            'QA complete',
            'in alterations',
            'ready for pickup',
            'picked up'
        ];
        
        function getMonthKey(dateVal) {
            if (!dateVal) return null;
            let d;
            if (typeof dateVal === 'number') {
                d = new Date((dateVal - 25569) * 86400 * 1000);
            } else {
                d = new Date(String(dateVal).split('T')[0] + 'T00:00:00');
            }
            return d.getFullYear() * 12 + d.getMonth();
        }
        
        function renderOrders() {
            const activeOrders = data.orders.filter(o => o.Status !== 'picked up');
            const pastOrders = data.orders.filter(o => o.Status === 'picked up');
            
            // Count stats
            const needsQa = activeOrders.filter(o => o.Status === 'arrived - pending QA').length;
            const inAlterations = activeOrders.filter(o => o.Status === 'in alterations').length;
            const ready = activeOrders.filter(o => o.Status === 'ready for pickup').length;
            const inProduction = activeOrders.filter(o => o.Status === 'ordered' || o.Status === 'in production' || o.Status === 'shipped').length;
            
            $('ordersNeedQa').textContent = needsQa;
            $('ordersInAlterations').textContent = inAlterations;
            $('ordersReady').textContent = ready;
            $('ordersInProduction').textContent = inProduction;
            
            // Sort active orders by status priority
            const statusOrder = ['arrived - pending QA', 'QA complete', 'in alterations', 'ready for pickup', 'shipped', 'in production', 'ordered'];
            activeOrders.sort((a, b) => {
                const aIdx = statusOrder.indexOf(a.Status || 'ordered');
                const bIdx = statusOrder.indexOf(b.Status || 'ordered');
                return aIdx - bIdx;
            });
            
            // Render active orders
            if (activeOrders.length === 0) {
                $('activeOrdersList').innerHTML = '<div class="empty">No active orders</div>';
            } else {
                $('activeOrdersList').innerHTML = activeOrders.map(o => renderOrderCard(o)).join('');
            }
            
            // Render past orders
            if (pastOrders.length === 0) {
                $('pastOrdersList').innerHTML = '<div class="empty">No completed orders</div>';
            } else {
                $('pastOrdersList').innerHTML = pastOrders.map(o => renderOrderCard(o, true)).join('');
            }
        }
        
        function togglePastOrders() {
            const list = $('pastOrdersList');
            const toggle = $('pastOrdersToggle');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.textContent = '‚ñ≤ Hide';
            } else {
                list.style.display = 'none';
                toggle.textContent = '‚ñº Show';
            }
        }
        
        function renderOrderCard(o, isPast = false) {
            const c = getClient(o.ClientID);
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const status = o.Status || 'ordered';
            
            // Group items by designer/source
            const designers = {};
            const inhouse = [];
            
            items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    const key = item.designer || 'Unknown';
                    if (!designers[key]) designers[key] = [];
                    designers[key].push(item);
                } else if (item.type === 'inhouse') {
                    inhouse.push(item);
                }
            });
            
            let itemsHtml = '';
            
            // Designer items - simplified display (no checkboxes here)
            Object.keys(designers).forEach(designer => {
                itemsHtml += `<div style="margin-bottom:8px">
                    <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:4px">${designer}</div>`;
                designers[designer].forEach(item => {
                    const qaIcon = item.qaChecked ? '‚úì' : '';
                    itemsHtml += `<div style="padding:4px 0;border-bottom:1px dashed var(--champagne)">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <span style="font-size:11px;font-weight:500">${item.type === 'dress' ? 'üëó' : '‚ú®'} ${item.name}</span>
                                ${qaIcon ? '<span style="color:#27ae60;margin-left:6px">‚úì QA</span>' : ''}
                            </div>
                            <div style="font-size:10px;color:var(--taupe)">${item.size ? 'Size ' + item.size : ''}${item.color ? ' ¬∑ ' + item.color : ''}</div>
                        </div>
                        ${item.customizations && item.customizations.length > 0 ? 
                            `<div style="margin-left:20px;margin-top:4px;font-size:10px;color:var(--taupe)">
                                ${item.customizations.map(cust => `<div>üîß ${cust.name} ${cust.qaChecked ? '<span style="color:#27ae60">‚úì</span>' : ''}</div>`).join('')}
                            </div>` : ''}
                    </div>`;
                });
                itemsHtml += `</div>`;
            });
            
            // In-house items
            if (inhouse.length > 0) {
                itemsHtml += `<div style="margin-bottom:8px">
                    <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:4px">üè† In-House</div>`;
                inhouse.forEach(item => {
                    const statusLabel = item.status === 'complete' ? '<span style="color:#27ae60">‚úì Complete</span>' : 
                                       item.status === 'in progress' ? '<span style="color:#f39c12">In Progress</span>' : 
                                       '<span style="color:var(--taupe)">Pending</span>';
                    itemsHtml += `<div style="padding:4px 0;border-bottom:1px dashed var(--champagne)">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="font-size:11px;font-weight:500">${item.name}</div>
                            ${statusLabel}
                        </div>
                        ${item.notes ? `<div style="font-size:10px;color:var(--taupe);font-style:italic;margin-top:2px">${item.notes}</div>` : ''}
                    </div>`;
                });
                itemsHtml += `</div>`;
            }
            
            // Action buttons based on status
            let actionButtons = `<button class="btn btn-sm btn-secondary" onclick="openOrderEmailModal(${o.ID})">üìß Email</button>`;
            
            if (status === 'arrived - pending QA') {
                actionButtons += `<button class="btn btn-sm btn-primary" onclick="openQaChecklist(${o.ID})">üìã Do QA Check</button>`;
            } else if (status === 'QA complete') {
                actionButtons += `<button class="btn btn-sm btn-primary" onclick="scheduleFirstFitting(${o.ID})">üìÖ Schedule Fitting</button>`;
            } else if (status === 'in alterations') {
                actionButtons += `<button class="btn btn-sm btn-secondary" onclick="viewAlterations(${o.ClientID})">‚úÇÔ∏è View Alterations</button>`;
            }
            
            if (!isPast) {
                actionButtons += `<button class="btn btn-sm btn-secondary" onclick="openQaChecklist(${o.ID})" title="View QA Details">üìã</button>`;
            }
            
            // Add delete button
            actionButtons += `<button class="btn btn-sm btn-secondary" onclick="deleteOrder(${o.ID})" title="Delete Order" style="color:#e74c3c">üóëÔ∏è</button>`;
            
            return `<div style="padding:12px;background:var(--cream);border-radius:5px;margin-bottom:12px;border-left:3px solid ${getStatusColor(status)}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
                    <div>
                        <div style="font-weight:600;font-size:14px">${c ? c.FirstName + ' ' + c.LastName : '?'}</div>
                        <div style="font-size:10px;color:var(--taupe)">Order: ${fmtDate(o.OrderDate)} ¬∑ Wedding: ${c ? fmtDate(c.WeddingDate) : '?'}</div>
                    </div>
                    <div style="text-align:right">
                        ${isPast ? 
                            `<div style="font-size:11px;font-weight:500;padding:3px 8px;background:${getStatusColor(status)}20;color:${getStatusColor(status)};border-radius:3px;margin-bottom:4px">${status}</div>` :
                            `<select class="form-input" style="width:auto;font-size:10px;padding:4px 8px;margin-bottom:4px" onchange="updateOrderStatus(${o.ID}, this.value)">
                                ${ORDER_STATUSES.map(s => `<option value="${s}" ${s === status ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>`
                        }
                        <div style="font-size:12px;font-weight:600">${money(o.Total)}</div>
                    </div>
                </div>
                ${itemsHtml}
                <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:8px;flex-wrap:wrap">
                    ${actionButtons}
                </div>
            </div>`;
        }
        
        function getStatusColor(status) {
            const colors = {
                'ordered': '#3498db',
                'in production': '#9b59b6',
                'shipped': '#f39c12',
                'arrived - pending QA': '#e74c3c',
                'QA complete': '#27ae60',
                'in alterations': '#1abc9c',
                'ready for pickup': '#27ae60',
                'picked up': '#95a5a6'
            };
            return colors[status] || '#95a5a6';
        }
        
        async function toggleItemArrived(orderId, itemId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.arrived = !item.arrived;
                await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                renderOrders();
            }
        }
        
        async function toggleItemQa(orderId, itemId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.qaChecked = !item.qaChecked;
                await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                renderOrders();
            }
        }
        
        async function toggleCustomQa(orderId, itemId, custId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item && item.customizations) {
                const cust = item.customizations.find(c => c.id === custId);
                if (cust) {
                    cust.qaChecked = !cust.qaChecked;
                    await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                    renderOrders();
                }
            }
        }
        
        async function updateInhouseStatus(orderId, itemId, status) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.status = status;
                await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                toast('Status updated', 'success');
            }
        }
        
        let currentQaOrderId = null;
        
        function openQaChecklist(orderId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            currentQaOrderId = orderId;
            
            const c = getClient(o.ClientID);
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            
            // Client info
            $('qaClientInfo').innerHTML = `
                <div style="font-weight:600;font-size:14px">${c ? c.FirstName + ' ' + c.LastName : '?'}</div>
                <div style="font-size:11px;color:var(--taupe)">Order Date: ${fmtDate(o.OrderDate)} ¬∑ Wedding: ${c ? fmtDate(c.WeddingDate) : '?'}</div>
            `;
            
            // Build checklist
            let html = '';
            items.forEach((item, idx) => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    const icon = item.type === 'dress' ? 'üëó' : '‚ú®';
                    html += `<div style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:8px">
                        <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer">
                            <input type="checkbox" class="qa-item" data-idx="${idx}" ${item.qaChecked ? 'checked' : ''} style="margin-top:3px;transform:scale(1.3)">
                            <div style="flex:1">
                                <div style="font-weight:600">${icon} ${item.designer} - ${item.name}</div>
                                <div style="font-size:11px;color:var(--taupe)">Size: ${item.size || '‚Äî'} ¬∑ Color: ${item.color || '‚Äî'}</div>
                            </div>
                        </label>`;
                    
                    if (item.customizations && item.customizations.length > 0) {
                        html += `<div style="margin-left:28px;margin-top:8px;padding-top:8px;border-top:1px dashed var(--champagne)">`;
                        item.customizations.forEach((cust, cidx) => {
                            const deliveryLabel = cust.delivery === 'ondress' ? 
                                '<span style="color:var(--dusty)">‚úì Check ON dress</span>' : 
                                '<span style="color:#e67e22">üì¶ Separate package</span>';
                            html += `<label style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer">
                                <input type="checkbox" class="qa-custom" data-idx="${idx}" data-cidx="${cidx}" ${cust.qaChecked ? 'checked' : ''}>
                                <span>üîß ${cust.name}</span>
                                <span style="font-size:10px;margin-left:auto">${deliveryLabel}</span>
                            </label>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                } else if (item.type === 'inhouse') {
                    html += `<div style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:8px">
                        <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer">
                            <input type="checkbox" class="qa-inhouse" data-idx="${idx}" ${item.status === 'complete' ? 'checked' : ''} style="margin-top:3px;transform:scale(1.3)">
                            <div style="flex:1">
                                <div style="font-weight:600">üè† ${item.name}</div>
                                ${item.notes ? `<div style="font-size:11px;color:var(--taupe);font-style:italic">${item.notes}</div>` : ''}
                            </div>
                        </label>
                    </div>`;
                }
            });
            
            $('qaChecklist').innerHTML = html || '<div class="empty">No items to check</div>';
            $('qaNotes').value = o.QaNotes || '';
            
            // Populate consultant dropdown
            $('qaConsultant').innerHTML = '<option value="">Select consultant...</option>' +
                data.consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            
            openModal('qa');
        }
        
        async function submitQaChecklist() {
            if (!currentQaOrderId) return;
            
            const o = data.orders.find(x => x.ID == currentQaOrderId);
            if (!o) return;
            
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const consultant = $('qaConsultant').value;
            const notes = $('qaNotes').value;
            
            // Check if consultant is selected
            if (!consultant) {
                toast('Please select who is doing the QA check', 'error');
                return;
            }
            
            // Update items from checkboxes
            document.querySelectorAll('.qa-item').forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                if (items[idx]) items[idx].qaChecked = cb.checked;
            });
            
            document.querySelectorAll('.qa-custom').forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const cidx = parseInt(cb.dataset.cidx);
                if (items[idx] && items[idx].customizations && items[idx].customizations[cidx]) {
                    items[idx].customizations[cidx].qaChecked = cb.checked;
                }
            });
            
            document.querySelectorAll('.qa-inhouse').forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                if (items[idx]) items[idx].status = cb.checked ? 'complete' : 'pending';
            });
            
            // Check if all items are checked
            let allChecked = true;
            let uncheckedItems = [];
            items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    if (!item.qaChecked) {
                        allChecked = false;
                        uncheckedItems.push(item.name);
                    }
                    if (item.customizations) {
                        item.customizations.forEach(c => { 
                            if (!c.qaChecked) {
                                allChecked = false;
                                uncheckedItems.push(c.name);
                            }
                        });
                    }
                } else if (item.type === 'inhouse') {
                    if (item.status !== 'complete') {
                        allChecked = false;
                        uncheckedItems.push(item.name);
                    }
                }
            });
            
            if (!allChecked) {
                toast(`Cannot complete QA. Unchecked: ${uncheckedItems.join(', ')}`, 'error');
                return;
            }
            
            try {
                await updateRecord('Orders', currentQaOrderId, { 
                    Items: JSON.stringify(items),
                    Status: 'QA complete',
                    QaNotes: notes,
                    QaBy: consultant,
                    QaDate: today()
                });
                closeModal('qa');
                toast('‚úì QA Complete! All items verified by ' + consultant, 'success');
                renderOrders();
            } catch (e) {
                toast('Error saving QA', 'error');
            }
        }
        
        // Keep old function as alias
        function viewOrderQaChecklist(orderId) {
            openQaChecklist(orderId);
        }
        
        function scheduleFirstFitting(orderId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const c = getClient(o.ClientID);
            if (!c) return;
            
            // Set the pre-fill flag FIRST so openModal doesn't call populateApptModal
            $('apptForClientId').value = c.ID;
            $('editApptId').value = '';
            
            // Open modal first
            $('modal-newAppt').classList.add('active');
            
            // Now set all the fields AFTER modal is open
            $('aDate').value = today();
            $('aTime').value = '11:00';
            $('aType').value = 'first fitting';
            $('apptModalTitle').textContent = 'Schedule First Fitting';
            
            // Show fixed client name, hide client dropdown
            $('clientSelectGroup').style.display = 'none';
            $('clientFixedGroup').style.display = 'block';
            $('aClientName').value = c.FirstName + ' ' + c.LastName;
            $('aClient').value = c.ID;
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            
            // Hide consultation reason, show fitting fields
            $('consultationReasonGroup').style.display = 'none';
            $('fittingFieldsGroup').style.display = 'block';
            
            // Clear visit log fields
            ['aLogDresses','aLogFeedback','aLogStyle','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => {
                if ($(id)) $(id).value = '';
            });
            
            // Populate wedding date and dress needed by
            if (c.WeddingDate) {
                $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                const weddingDate = parseDate(c.WeddingDate);
                if (weddingDate) {
                    const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                    $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                    // Default dress needed by to 2 weeks before wedding
                    const neededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                    $('aDressNeededBy').value = neededBy.toISOString().split('T')[0];
                }
            } else {
                $('aWeddingDateDisplay').value = 'Not set';
                $('aDaysUntilWedding').textContent = '';
                $('aDressNeededBy').value = '';
            }
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(con => `<option value="${con.Name}">${con.Name}</option>`).join('');
            $('aConsultant').value = '';
        }
        
        function viewAlterations(clientId) {
            showPage('alterations');
            setTimeout(() => openAlterationDetail(clientId), 100);
        }
        
        async function updateOrderStatus(id, status) {
            try {
                await updateRecord('Orders', id, { Status: status });
                // Immediately update local data and re-render
                const order = data.orders.find(o => o.ID == id);
                if (order) order.Status = status;
                renderOrders();
                toast('Status updated', 'success');
            } catch (e) {}
        }
        
        async function deleteOrder(id) {
            const o = data.orders.find(x => x.ID == id);
            if (!o) return;
            
            const c = getClient(o.ClientID);
            const clientName = c ? `${c.FirstName} ${c.LastName}` : 'Unknown';
            
            if (!confirm(`Delete order for ${clientName}?\n\nTotal: ${money(o.Total)}\nStatus: ${o.Status}\n\nThis will also remove alteration data for this client.`)) {
                return;
            }
            
            try {
                await deleteRecord('Orders', id);
                
                // Remove from local data
                data.orders = data.orders.filter(x => x.ID != id);
                
                // Remove alteration data from localStorage
                if (o.ClientID) {
                    localStorage.removeItem(`alts_${o.ClientID}`);
                    localStorage.removeItem(`alts_notes_${o.ClientID}`);
                    localStorage.removeItem(`alts_neededby_${o.ClientID}`);
                }
                
                renderOrders();
                renderAlts();
                toast('Order deleted', 'success');
            } catch (e) {
                toast('Error deleting order', 'error');
            }
        }
        
        function viewOrder(id) {
            const o = data.orders.find(x => x.ID == id);
            if (!o) return;
            const c = getClient(o.ClientID);
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            alert(`Order #${o.ID}\nClient: ${c ? c.FirstName + ' ' + c.LastName : '?'}\nItems: ${items.length}\nTotal: ${money(o.Total)}\nStatus: ${o.Status || 'order received'}`);
        }
        
        let currentEmailOrder = null;
        
        function openOrderEmailModal(orderId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            currentEmailOrder = o;
            
            const c = getClient(o.ClientID);
            $('orderEmailOrderId').value = orderId;
            $('orderEmailTo').value = c?.Email || '';
            $('orderEmailTemplate').value = 'halfway';
            loadOrderEmailTemplate();
            openModal('orderEmail');
        }
        
        function loadOrderEmailTemplate() {
            const template = $('orderEmailTemplate').value;
            const o = currentEmailOrder;
            if (!o) return;
            
            const c = getClient(o.ClientID);
            const firstName = c?.FirstName || 'there';
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const dressInfo = items.map(i => `${i.designer || ''} ${i.name || i.type}`).join(', ') || 'your dress';
            const arrivalDate = fmtDate(o.ArrivalDate);
            
            const templates = {
                halfway: {
                    subject: `Update on Your Estrelle Bridal Order`,
                    body: `Hi ${firstName},

We wanted to give you a quick update on your order!

Your dress (${dressInfo}) is currently in production and everything is on track. The estimated arrival is still ${arrivalDate}.

We'll keep you posted as we get closer to completion. In the meantime, if you have any questions, please don't hesitate to reach out.

Warmly,
Estrelle Bridal
55 Avenue Road, Suite 201.5, Toronto
(647) 333-6582`
                },
                completed: {
                    subject: `Great News! Your Dress is Complete ‚Äî Estrelle Bridal`,
                    body: `Hi ${firstName},

We have wonderful news ‚Äî your dress (${dressInfo}) has been completed and is being prepared for shipping!

We expect it to arrive at our boutique around ${arrivalDate}. We'll contact you as soon as it arrives to schedule your first fitting appointment.

We can't wait for you to see it!

With love,
Estrelle Bridal
55 Avenue Road, Suite 201.5, Toronto
(647) 333-6582`
                },
                arrived: {
                    subject: `Your Dress Has Arrived! ‚Äî Estrelle Bridal`,
                    body: `Hi ${firstName},

Your dress has arrived at our boutique! üéâ

Please call us or reply to this email to schedule your first fitting appointment. We recommend booking soon so we have plenty of time for any alterations before your big day.

We're so excited for you to try it on!

With love,
Estrelle Bridal
55 Avenue Road, Suite 201.5, Toronto
(647) 333-6582`
                },
                ready: {
                    subject: `Your Dress is Ready for Pickup! ‚Äî Estrelle Bridal`,
                    body: `Hi ${firstName},

Your dress is ready and waiting for you! üë∞‚ú®

All alterations are complete and your dress looks absolutely beautiful. Please call us or reply to this email to arrange your pickup time.

Don't forget to bring:
‚Ä¢ Someone to help carry the dress
‚Ä¢ A garment bag (if you have one)

We're so excited for your big day!

With love,
Estrelle Bridal
55 Avenue Road, Suite 201.5, Toronto
(647) 333-6582`
                },
                custom: {
                    subject: `Update from Estrelle Bridal`,
                    body: `Hi ${firstName},

[Your message here]

Warmly,
Estrelle Bridal`
                }
            };
            
            const t = templates[template];
            $('orderEmailSubject').value = t.subject;
            $('orderEmailBody').value = t.body;
            
            // Load saved templates list
            loadSavedTemplatesList();
        }
        
        function loadSavedTemplatesList() {
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            const names = Object.keys(saved);
            $('savedTemplates').innerHTML = '<option value="">-- Saved Templates (' + names.length + ') --</option>' +
                names.map(n => `<option value="${n}">${n}</option>`).join('');
        }
        
        function loadSavedTemplate() {
            const name = $('savedTemplates').value;
            if (!name) return;
            
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            const template = saved[name];
            if (template) {
                // Replace placeholders with current client info
                const o = currentEmailOrder;
                const c = o ? getClient(o.ClientID) : null;
                const firstName = c?.FirstName || 'there';
                
                let subject = template.subject.replace(/\{firstName\}/g, firstName);
                let body = template.body.replace(/\{firstName\}/g, firstName);
                
                $('orderEmailSubject').value = subject;
                $('orderEmailBody').value = body;
            }
        }
        
        function saveEmailTemplate() {
            const name = $('newTemplateName').value.trim();
            if (!name) {
                toast('Enter a template name', 'error');
                return;
            }
            
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            
            // Get current values and replace client name with placeholder
            const o = currentEmailOrder;
            const c = o ? getClient(o.ClientID) : null;
            const firstName = c?.FirstName || '';
            
            let subject = $('orderEmailSubject').value;
            let body = $('orderEmailBody').value;
            
            // Replace actual first name with placeholder
            if (firstName) {
                subject = subject.replace(new RegExp(firstName, 'g'), '{firstName}');
                body = body.replace(new RegExp(firstName, 'g'), '{firstName}');
            }
            
            saved[name] = { subject, body };
            localStorage.setItem('estrelle_email_templates', JSON.stringify(saved));
            
            $('newTemplateName').value = '';
            loadSavedTemplatesList();
            toast('Template saved!', 'success');
        }
        
        // ========== ANALYTICS ==========
        function renderAnalytics() {
            const year = parseInt($('analyticsYear').value);
            const yearOrders = data.orders.filter(o => {
                const d = parseDate(o.OrderDate);
                return d && d.getFullYear() === year;
            });
            
            // Calculate totals
            let totalPreTax = 0;
            let totalTax = 0;
            yearOrders.forEach(o => {
                totalPreTax += parseFloat(o.Subtotal) || parseFloat(o.Total) || 0;
                totalTax += parseFloat(o.HST) || 0;
            });
            const totalWithTax = totalPreTax + totalTax;
            const avgOrder = yearOrders.length > 0 ? totalPreTax / yearOrders.length : 0;
            
            $('analyticsTotalPreTax').textContent = money(totalPreTax);
            $('analyticsTotalWithTax').textContent = money(totalWithTax);
            $('analyticsTotalOrders').textContent = yearOrders.length;
            $('analyticsAvgOrder').textContent = money(avgOrder);
            
            // Monthly data
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = months.map((m, i) => {
                const monthOrders = yearOrders.filter(o => {
                    const d = parseDate(o.OrderDate);
                    return d && d.getMonth() === i;
                });
                const preTax = monthOrders.reduce((s, o) => s + (parseFloat(o.Subtotal) || parseFloat(o.Total) || 0), 0);
                const tax = monthOrders.reduce((s, o) => s + (parseFloat(o.HST) || 0), 0);
                return { month: m, orders: monthOrders.length, preTax, tax, total: preTax + tax };
            });
            
            // Sales chart
            const maxSales = Math.max(...monthlyData.map(d => d.preTax), 1);
            $('salesChart').innerHTML = monthlyData.map((d, i) => {
                const height = Math.max((d.preTax / maxSales) * 200, 4);
                const isCurrentMonth = new Date().getFullYear() === year && new Date().getMonth() === i;
                return `<div style="flex:1;display:flex;flex-direction:column;align-items:center">
                    <div style="font-size:10px;margin-bottom:4px">${d.preTax > 0 ? money(d.preTax) : ''}</div>
                    <div style="width:100%;height:${height}px;background:${isCurrentMonth ? 'var(--dusty)' : 'var(--champagne)'};border-radius:3px 3px 0 0"></div>
                </div>`;
            }).join('');
            $('salesChartLabels').innerHTML = months.map(m => `<div style="flex:1;text-align:center">${m}</div>`).join('');
            
            // Monthly breakdown table
            $('monthlyBreakdownTable').querySelector('tbody').innerHTML = monthlyData.map(d => 
                `<tr><td>${d.month}</td><td>${d.orders}</td><td>${money(d.preTax)}</td><td>${money(d.tax)}</td><td><b>${money(d.total)}</b></td></tr>`
            ).join('') + `<tr style="background:var(--cream);font-weight:600">
                <td>TOTAL</td><td>${yearOrders.length}</td><td>${money(totalPreTax)}</td><td>${money(totalTax)}</td><td>${money(totalWithTax)}</td>
            </tr>`;
            
            // Customer stats
            const yearClients = data.clients.filter(c => {
                const d = parseDate(c.LastVisit);
                return d && d.getFullYear() === year;
            });
            
            const customerMonthly = months.map((m, i) => {
                const newClients = data.clients.filter(c => {
                    // Use first appointment or estimate from LastVisit
                    const clientAppts = data.appointments.filter(a => a.ClientID == c.ID);
                    if (clientAppts.length > 0) {
                        const firstAppt = clientAppts.sort((a, b) => parseDate(a.Date) - parseDate(b.Date))[0];
                        const d = parseDate(firstAppt.Date);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    }
                    return false;
                });
                
                const monthAppts = data.appointments.filter(a => {
                    const d = parseDate(a.Date);
                    return d && d.getFullYear() === year && d.getMonth() === i && 
                           (a.Type === 'consultation' || !a.Type);
                });
                
                const monthOrders = yearOrders.filter(o => {
                    const d = parseDate(o.OrderDate);
                    return d && d.getMonth() === i;
                });
                
                const conversionRate = monthAppts.length > 0 ? Math.round((monthOrders.length / monthAppts.length) * 100) : 0;
                
                return { month: m, newClients: newClients.length, consultations: monthAppts.length, conversions: conversionRate };
            });
            
            $('customerStatsTable').querySelector('tbody').innerHTML = customerMonthly.map(d => 
                `<tr><td>${d.month}</td><td>${d.newClients}</td><td>${d.consultations}</td><td>${d.conversions}%</td></tr>`
            ).join('');
            
            // Wedding seasonality (by wedding month)
            const weddingMonths = months.map((m, i) => {
                const count = data.clients.filter(c => {
                    const d = parseDate(c.WeddingDate);
                    return d && d.getFullYear() === year && d.getMonth() === i;
                }).length;
                return { month: m, count };
            });
            
            const maxWeddings = Math.max(...weddingMonths.map(w => w.count), 1);
            $('seasonalityChart').innerHTML = weddingMonths.map(w => {
                const width = (w.count / maxWeddings) * 100;
                const isSeason = w.count > maxWeddings * 0.5;
                return `<div style="display:flex;align-items:center;gap:8px">
                    <div style="width:40px;font-size:11px">${w.month}</div>
                    <div style="flex:1;background:var(--blush);border-radius:3px;height:20px">
                        <div style="width:${width}%;height:100%;background:${isSeason ? 'var(--dusty)' : 'var(--champagne)'};border-radius:3px;display:flex;align-items:center;justify-content:flex-end;padding-right:6px">
                            <span style="font-size:10px;color:${isSeason ? 'white' : 'var(--charcoal)'}"><b>${w.count}</b></span>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            // Top designers
            const designerSales = {};
            yearOrders.forEach(o => {
                const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
                items.forEach(item => {
                    if (item.designer) {
                        designerSales[item.designer] = (designerSales[item.designer] || 0) + (item.price || 0);
                    }
                });
            });
            
            const topDesigners = Object.entries(designerSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const maxDesignerSales = topDesigners.length > 0 ? topDesigners[0][1] : 1;
            $('topDesignersChart').innerHTML = topDesigners.length > 0 ? 
                topDesigners.map(([name, sales], i) => {
                    const width = (sales / maxDesignerSales) * 100;
                    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <div style="width:120px;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${name}">${i + 1}. ${name}</div>
                        <div style="flex:1;background:var(--blush);border-radius:3px;height:18px">
                            <div style="width:${width}%;height:100%;background:var(--dusty);border-radius:3px"></div>
                        </div>
                        <div style="width:70px;font-size:10px;text-align:right">${money(sales)}</div>
                    </div>`;
                }).join('') : '<div class="empty">No designer data</div>';
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (typeof dateStr === 'number') {
                return new Date((dateStr - 25569) * 86400 * 1000);
            }
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }
        
        function exportData(type) {
            const year = parseInt($('analyticsYear').value);
            let csvContent = '';
            let filename = '';
            
            if (type === 'monthly-sales') {
                filename = `estrelle_monthly_sales_${year}.csv`;
                csvContent = 'Month,Orders,Pre-Tax Sales,Tax (HST),Total Sales\n';
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach((m, i) => {
                    const monthOrders = data.orders.filter(o => {
                        const d = parseDate(o.OrderDate);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    });
                    const preTax = monthOrders.reduce((s, o) => s + (parseFloat(o.Subtotal) || parseFloat(o.Total) || 0), 0);
                    const tax = monthOrders.reduce((s, o) => s + (parseFloat(o.HST) || 0), 0);
                    csvContent += `${m},${monthOrders.length},${preTax.toFixed(2)},${tax.toFixed(2)},${(preTax + tax).toFixed(2)}\n`;
                });
            } else if (type === 'orders') {
                filename = `estrelle_orders_${year}.csv`;
                csvContent = 'Order ID,Client,Order Date,Status,Subtotal,Tax,Total,Items\n';
                data.orders.filter(o => {
                    const d = parseDate(o.OrderDate);
                    return d && d.getFullYear() === year;
                }).forEach(o => {
                    const c = getClient(o.ClientID);
                    const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
                    const itemsList = items.map(i => i.name || i.type).join('; ');
                    csvContent += `${o.ID},"${c ? c.FirstName + ' ' + c.LastName : ''}",${fmtDate(o.OrderDate)},${o.Status || ''},${o.Subtotal || o.Total || 0},${o.HST || 0},${o.Total || 0},"${itemsList}"\n`;
                });
            } else if (type === 'customers') {
                filename = `estrelle_customers_${year}.csv`;
                csvContent = 'Client ID,First Name,Last Name,Email,Phone,Wedding Date,Venue,Status,Budget\n';
                data.clients.forEach(c => {
                    csvContent += `${c.ID},"${c.FirstName}","${c.LastName}","${c.Email || ''}","${c.Phone || ''}",${fmtDate(c.WeddingDate)},"${c.Venue || ''}",${c.Status || ''},"${c.Budget || ''}"\n`;
                });
            } else if (type === 'appointments') {
                filename = `estrelle_appointments_${year}.csv`;
                csvContent = 'Date,Time,Client,Type,Consultant,Notes\n';
                data.appointments.filter(a => {
                    const d = parseDate(a.Date);
                    return d && d.getFullYear() === year;
                }).forEach(a => {
                    const c = getClient(a.ClientID);
                    csvContent += `${fmtDate(a.Date)},${a.Time || ''},"${c ? c.FirstName + ' ' + c.LastName : ''}",${a.Type || 'consultation'},${a.Consultant || ''},"${(a.Notes || '').replace(/"/g, '""')}"\n`;
                });
            } else if (type === 'seasonality') {
                filename = `estrelle_seasonality_${year}.csv`;
                csvContent = 'Month,Weddings,New Clients,Consultations,Orders,Conversion Rate\n';
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach((m, i) => {
                    const weddings = data.clients.filter(c => {
                        const d = parseDate(c.WeddingDate);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    }).length;
                    const consultations = data.appointments.filter(a => {
                        const d = parseDate(a.Date);
                        return d && d.getFullYear() === year && d.getMonth() === i && (a.Type === 'consultation' || !a.Type);
                    }).length;
                    const orders = data.orders.filter(o => {
                        const d = parseDate(o.OrderDate);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    }).length;
                    const conversion = consultations > 0 ? Math.round((orders / consultations) * 100) : 0;
                    csvContent += `${m},${weddings},0,${consultations},${orders},${conversion}%\n`;
                });
            }
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            toast(`Downloaded ${filename}`, 'success');
        }
        
        function exportAnalytics() {
            exportData('monthly-sales');
        }
        
        async function sendOrderEmail() {
            const email = $('orderEmailTo').value;
            if (!email) {
                toast('No email address', 'error');
                return;
            }
            
            closeModal('orderEmail');
            toast('Sending email...', '');
            
            try {
                await api('POST', {
                    action: 'sendOrderEmail',
                    email: email,
                    subject: $('orderEmailSubject').value,
                    body: $('orderEmailBody').value
                });
                toast('Email sent to ' + email, 'success');
            } catch (e) {
                toast('Failed to send email', 'error');
            }
        }

        // ========== ALTERATIONS ==========
        let currentAltClientId = null;
        let currentAltItems = [];
        
        function renderAlts() {
            // Get clients in alterations (orders with status 'in alterations' or 'QA complete')
            const altsClients = [];
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            data.orders.forEach(o => {
                if (o.Status === 'in alterations' || o.Status === 'QA complete') {
                    const c = getClient(o.ClientID);
                    if (c) {
                        const weddingDate = parseDate(c.WeddingDate);
                        const daysToWedding = weddingDate ? Math.ceil((weddingDate - now) / (1000 * 60 * 60 * 24)) : 999;
                        
                        // Get fitting appointments
                        const fittings = data.appointments.filter(a => 
                            a.ClientID == c.ID && 
                            (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
                        ).sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
                        
                        // Get alteration items from localStorage
                        const altItems = JSON.parse(localStorage.getItem(`alts_${c.ID}`) || '[]');
                        const doneCount = altItems.filter(i => i.status === 'done').length;
                        const totalCount = altItems.length;
                        
                        altsClients.push({
                            client: c,
                            order: o,
                            fittings,
                            altItems,
                            doneCount,
                            totalCount,
                            daysToWedding,
                            nextFitting: fittings.find(f => parseDate(f.Date) >= now)
                        });
                    }
                }
            });
            
            // Sort by urgency (days to wedding)
            altsClients.sort((a, b) => a.daysToWedding - b.daysToWedding);
            
            // Calculate stats
            const active = altsClients.length;
            const fittingsThisWeek = altsClients.filter(ac => ac.nextFitting && parseDate(ac.nextFitting.Date) <= weekFromNow).length;
            const urgent = altsClients.filter(ac => ac.daysToWedding <= 30).length;
            
            $('altsActive').textContent = active;
            $('altsFittingsWeek').textContent = fittingsThisWeek;
            $('altsUrgent').textContent = urgent;
            
            // Render list
            if (altsClients.length === 0) {
                $('alterationsList').innerHTML = '<div class="card"><div class="card-body empty">No active alterations. Clients appear here when orders are marked "QA complete" or "in alterations".</div></div>';
                return;
            }
            
            $('alterationsList').innerHTML = altsClients.map(ac => {
                const c = ac.client;
                const urgencyColor = ac.daysToWedding <= 14 ? '#e74c3c' : ac.daysToWedding <= 30 ? '#f39c12' : '#27ae60';
                const progressPct = ac.totalCount > 0 ? Math.round((ac.doneCount / ac.totalCount) * 100) : 0;
                
                // Next fitting info
                let nextFittingHtml = '';
                if (ac.nextFitting) {
                    nextFittingHtml = `<div style="font-size:10px;color:var(--dusty)">Next: ${fmtDate(ac.nextFitting.Date)} @ ${ac.nextFitting.Time} (${ac.nextFitting.Type})</div>`;
                } else {
                    nextFittingHtml = `<div style="font-size:10px;color:#e74c3c">‚ö†Ô∏è No fitting scheduled</div>`;
                }
                
                // Items summary
                let itemsHtml = '';
                if (ac.altItems.length > 0) {
                    itemsHtml = ac.altItems.slice(0, 4).map(item => {
                        const icon = item.status === 'done' ? '‚úì' : item.status === 'in-progress' ? '‚è≥' : '‚óã';
                        const color = item.status === 'done' ? '#27ae60' : item.status === 'in-progress' ? '#f39c12' : 'var(--taupe)';
                        return `<span style="font-size:10px;color:${color};margin-right:8px">${icon} ${item.name}</span>`;
                    }).join('');
                    if (ac.altItems.length > 4) itemsHtml += `<span style="font-size:10px;color:var(--taupe)">+${ac.altItems.length - 4} more</span>`;
                }
                
                return `<div class="card" style="margin-bottom:12px;border-left:3px solid ${urgencyColor}">
                    <div class="card-body">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
                            <div>
                                <div style="font-weight:600;font-size:14px">${c.FirstName} ${c.LastName}</div>
                                <div style="font-size:10px;color:var(--taupe)">Wedding: ${fmtDate(c.WeddingDate)} ¬∑ <span style="color:${urgencyColor};font-weight:600">${ac.daysToWedding} days away</span></div>
                                ${nextFittingHtml}
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:10px;color:var(--taupe)">Progress</div>
                                <div style="font-size:14px;font-weight:600">${ac.doneCount}/${ac.totalCount}</div>
                                <div style="width:60px;height:4px;background:var(--blush);border-radius:2px;overflow:hidden">
                                    <div style="width:${progressPct}%;height:100%;background:${progressPct === 100 ? '#27ae60' : 'var(--dusty)'}"></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom:8px">${itemsHtml || '<span style="font-size:10px;color:var(--taupe)">No alteration items yet</span>'}</div>
                        <div style="display:flex;justify-content:flex-end;gap:6px">
                            <button class="btn btn-sm btn-secondary" onclick="deleteAlteration(${c.ID})" title="Remove from alterations" style="color:#e74c3c">üóëÔ∏è</button>
                            <button class="btn btn-sm btn-secondary" onclick="scheduleClientFitting(${c.ID})">üìÖ Schedule Fitting</button>
                            <button class="btn btn-sm btn-primary" onclick="openAlterationDetail(${c.ID})">‚úÇÔ∏è Manage</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        async function deleteAlteration(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            const clientName = `${c.FirstName} ${c.LastName}`;
            
            if (!confirm(`Remove ${clientName} from alterations?\n\nThis will clear all alteration items and notes for this client, but keep the order.`)) {
                return;
            }
            
            // Remove alteration data from localStorage
            localStorage.removeItem(`alts_${clientId}`);
            localStorage.removeItem(`alts_notes_${clientId}`);
            localStorage.removeItem(`alts_neededby_${clientId}`);
            
            // Set order status back to QA complete (so they can re-enter alterations if needed)
            const order = data.orders.find(o => o.ClientID == clientId && o.Status === 'in alterations');
            if (order) {
                await updateRecord('Orders', order.ID, { Status: 'QA complete' });
                order.Status = 'QA complete';
            }
            
            renderAlts();
            renderOrders();
            toast(`${clientName} removed from alterations`, 'success');
        }
        
        function scheduleClientFitting(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            // Set the pre-fill flag FIRST so openModal doesn't call populateApptModal
            $('apptForClientId').value = clientId;
            $('editApptId').value = '';
            
            // Open modal first
            $('modal-newAppt').classList.add('active');
            
            // Now set all the fields AFTER modal is open
            $('aDate').value = today();
            $('aTime').value = '11:00';
            $('aType').value = 'fitting';
            $('apptModalTitle').textContent = 'Schedule Fitting';
            
            // Show fixed client name, hide client dropdown
            $('clientSelectGroup').style.display = 'none';
            $('clientFixedGroup').style.display = 'block';
            $('aClientName').value = c.FirstName + ' ' + c.LastName;
            $('aClient').value = clientId;
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            
            // Hide consultation reason, show fitting fields
            $('consultationReasonGroup').style.display = 'none';
            $('fittingFieldsGroup').style.display = 'block';
            
            // Clear visit log fields
            ['aLogDresses','aLogFeedback','aLogStyle','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => {
                if ($(id)) $(id).value = '';
            });
            
            // Populate wedding date and dress needed by
            if (c.WeddingDate) {
                $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                const weddingDate = parseDate(c.WeddingDate);
                if (weddingDate) {
                    const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                    $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                    // Default dress needed by to 2 weeks before wedding
                    const neededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                    $('aDressNeededBy').value = neededBy.toISOString().split('T')[0];
                }
            } else {
                $('aWeddingDateDisplay').value = 'Not set';
                $('aDaysUntilWedding').textContent = '';
                $('aDressNeededBy').value = '';
            }
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(con => `<option value="${con.Name}">${con.Name}</option>`).join('');
            $('aConsultant').value = '';
        }
        
        function openAddAlterationItem() {
            // Open modal to select client and schedule fitting
            const clientsInAlts = data.orders
                .filter(o => o.Status === 'QA complete' || o.Status === 'in alterations')
                .map(o => getClient(o.ClientID))
                .filter(c => c);
            
            if (clientsInAlts.length === 0) {
                toast('No clients ready for alterations. Complete QA first.', 'error');
                return;
            }
            
            // Just open the appointment modal with fitting type
            $('editApptId').value = '';
            $('apptType').value = 'first fitting';
            populateApptModal();
            openModal('newAppt');
        }
        
        function openAlterationDetail(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            currentAltClientId = clientId;
            
            // Load alteration items from localStorage
            currentAltItems = JSON.parse(localStorage.getItem(`alts_${clientId}`) || '[]');
            
            // Get order info
            const order = data.orders.find(o => o.ClientID == clientId && (o.Status === 'in alterations' || o.Status === 'QA complete'));
            
            // Client info
            const weddingDate = parseDate(c.WeddingDate);
            const daysToWedding = weddingDate ? Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24)) : '?';
            
            $('altClientInfo').innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div style="font-weight:600;font-size:16px">${c.FirstName} ${c.LastName}</div>
                        <div style="font-size:11px;color:var(--taupe)">Wedding: ${fmtDate(c.WeddingDate)} ¬∑ ${daysToWedding} days away</div>
                    </div>
                    <div style="font-size:11px;color:var(--taupe)">${c.Phone || ''}<br>${c.Email || ''}</div>
                </div>
            `;
            
            // Fittings list
            const fittings = data.appointments.filter(a => 
                a.ClientID == clientId && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            ).sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
            
            if (fittings.length === 0) {
                $('altFittingsList').innerHTML = '<div class="empty" style="font-size:11px">No fittings scheduled yet</div>';
            } else {
                $('altFittingsList').innerHTML = fittings.map((f, idx) => {
                    const d = parseDate(f.Date);
                    const isPast = d < new Date();
                    // Format time properly
                    let timeStr = f.Time || '';
                    if (timeStr.includes('T')) {
                        // It's an ISO string, extract just the time part
                        const timePart = timeStr.split('T')[1];
                        if (timePart) {
                            const [h, m] = timePart.split(':');
                            const hour = parseInt(h);
                            const ampm = hour >= 12 ? 'PM' : 'AM';
                            const hour12 = hour % 12 || 12;
                            timeStr = `${hour12}:${m} ${ampm}`;
                        }
                    } else if (timeStr.includes(':')) {
                        // Already HH:MM format, convert to 12hr
                        const [h, m] = timeStr.split(':');
                        const hour = parseInt(h);
                        const ampm = hour >= 12 ? 'PM' : 'AM';
                        const hour12 = hour % 12 || 12;
                        timeStr = `${hour12}:${m} ${ampm}`;
                    }
                    return `<div style="display:flex;align-items:center;gap:8px;padding:8px;${isPast ? 'opacity:0.7' : ''};background:${isPast ? 'var(--cream)' : 'var(--blush)'};border-radius:4px;margin-bottom:4px;cursor:pointer;transition:all 0.2s" onclick="editFittingFromAlt(${f.ID})" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='none'">
                        <div style="width:24px;height:24px;background:${isPast ? 'var(--champagne)' : 'var(--dusty)'};color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600">${idx + 1}</div>
                        <div style="flex:1">
                            <div style="font-size:11px;font-weight:500">${f.Type} - ${fmtDate(f.Date)} @ ${timeStr}</div>
                            ${f.Notes ? `<div style="font-size:10px;color:var(--taupe)">${f.Notes}</div>` : ''}
                            ${f.Consultant ? `<div style="font-size:9px;color:var(--taupe)">with ${f.Consultant}</div>` : ''}
                        </div>
                        ${isPast ? '<span style="font-size:10px;color:#27ae60">‚úì Done</span>' : '<span style="font-size:10px;color:var(--dusty)">‚úèÔ∏è Edit</span>'}
                    </div>`;
                }).join('');
            }
            
            // Render alteration items
            renderAltItems();
            
            // Load notes
            $('altNotes').value = localStorage.getItem(`alts_notes_${clientId}`) || '';
            
            // Load dress needed by date
            let neededBy = localStorage.getItem(`alts_neededby_${clientId}`);
            if (!neededBy && weddingDate) {
                // Default to 2 weeks before wedding
                const defaultNeededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                neededBy = defaultNeededBy.toISOString().split('T')[0];
            }
            $('altDressNeededBy').value = neededBy || '';
            updateNeededByCountdown();
            
            openModal('alteration');
        }
        
        function saveAltNeededBy() {
            if (!currentAltClientId) return;
            const neededBy = $('altDressNeededBy').value;
            localStorage.setItem(`alts_neededby_${currentAltClientId}`, neededBy);
            updateNeededByCountdown();
        }
        
        function updateNeededByCountdown() {
            const neededBy = $('altDressNeededBy').value;
            if (!neededBy) {
                $('altNeededByCountdown').innerHTML = '';
                return;
            }
            const neededByDate = new Date(neededBy + 'T00:00:00');
            const daysUntil = Math.ceil((neededByDate - new Date()) / (1000 * 60 * 60 * 24));
            
            let color = '#27ae60';
            let text = `${daysUntil} days`;
            if (daysUntil <= 7) {
                color = '#e74c3c';
                text = `‚ö†Ô∏è ${daysUntil} days - URGENT!`;
            } else if (daysUntil <= 14) {
                color = '#f39c12';
                text = `${daysUntil} days - soon`;
            }
            
            $('altNeededByCountdown').innerHTML = `<span style="color:${color}">${text}</span>`;
        }
        
        function editFittingFromAlt(apptId) {
            const appt = data.appointments.find(a => a.ID == apptId);
            if (!appt) return;
            
            const c = getClient(appt.ClientID);
            
            // Close alteration modal
            closeModal('alteration');
            
            // Open appointment edit modal
            $('editApptId').value = apptId;
            $('apptForClientId').value = appt.ClientID;
            $('apptModalTitle').textContent = 'Edit Fitting';
            
            // Show modal
            $('modal-newAppt').classList.add('active');
            
            // Fill in appointment details
            const apptDate = appt.Date ? (typeof appt.Date === 'number' ? 
                new Date((appt.Date - 25569) * 86400 * 1000).toISOString().split('T')[0] : 
                String(appt.Date).split('T')[0]) : '';
            $('aDate').value = apptDate;
            
            // Parse time
            let timeVal = appt.Time || '';
            if (timeVal.includes('T')) {
                timeVal = timeVal.split('T')[1]?.substring(0, 5) || '';
            }
            $('aTime').value = timeVal;
            
            $('aType').value = appt.Type || 'fitting';
            
            // Show fixed client name
            $('clientSelectGroup').style.display = 'none';
            $('clientFixedGroup').style.display = 'block';
            $('aClientName').value = c ? `${c.FirstName} ${c.LastName}` : '';
            $('aClient').value = appt.ClientID;
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            
            // Hide consultation reason, show fitting fields for fitting types
            const isFitting = (appt.Type || '').includes('fitting');
            $('consultationReasonGroup').style.display = isFitting ? 'none' : 'block';
            $('fittingFieldsGroup').style.display = isFitting ? 'block' : 'none';
            
            if (isFitting && c && c.WeddingDate) {
                $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                const weddingDate = parseDate(c.WeddingDate);
                if (weddingDate) {
                    const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                    $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                }
                // Load saved dress needed by
                const neededBy = localStorage.getItem(`alts_neededby_${appt.ClientID}`);
                $('aDressNeededBy').value = neededBy || '';
            }
            
            // Clear visit log fields
            ['aLogDresses','aLogFeedback','aLogStyle','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => {
                if ($(id)) $(id).value = '';
            });
            
            // Load notes into appropriate field
            if (appt.Notes) {
                $('aLogOther').value = appt.Notes;
            }
            
            // Populate consultant dropdown and select current
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(con => `<option value="${con.Name}">${con.Name}</option>`).join('');
            $('aConsultant').value = appt.Consultant || '';
        }
        
        function renderAltItems() {
            if (currentAltItems.length === 0) {
                $('altItemsList').innerHTML = '<div class="empty" style="font-size:11px">No alteration items yet. Add items as they\'re identified during fittings.</div>';
                return;
            }
            
            $('altItemsList').innerHTML = currentAltItems.map((item, idx) => {
                const statusColor = item.status === 'done' ? '#27ae60' : item.status === 'in-progress' ? '#f39c12' : 'var(--taupe)';
                const statusBg = item.status === 'done' ? '#27ae6020' : item.status === 'in-progress' ? '#f39c1220' : 'var(--blush)';
                
                return `<div style="display:flex;align-items:flex-start;gap:8px;padding:8px;background:${statusBg};border-radius:4px;margin-bottom:6px;border-left:3px solid ${statusColor}">
                    <select class="form-input" style="width:auto;font-size:10px;padding:3px 6px" onchange="updateAltItemStatus(${idx}, this.value)">
                        <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="in-progress" ${item.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="done" ${item.status === 'done' ? 'selected' : ''}>Done</option>
                        <option value="needs-adjustment" ${item.status === 'needs-adjustment' ? 'selected' : ''}>Needs Adjustment</option>
                    </select>
                    <div style="flex:1">
                        <div style="font-size:12px;font-weight:500">${item.name}</div>
                        ${item.details ? `<div style="font-size:10px;color:var(--taupe)">${item.details}</div>` : ''}
                        <div style="font-size:9px;color:var(--taupe)">Added: Fitting ${item.addedAtFitting || 1}</div>
                    </div>
                    <button class="action-btn" style="color:#e74c3c" onclick="removeAltItem(${idx})">√ó</button>
                </div>`;
            }).join('');
        }
        
        function addAlterationItem() {
            $('addAltItemForm').style.display = 'block';
            $('newAltItemDetails').value = '';
            $('customAltItem').value = '';
            if ($('saveCustomAltItem')) $('saveCustomAltItem').checked = false;
            
            // Populate dropdown with saved items
            populateAltItemDropdown();
            $('newAltItemType').value = 'hem';
            toggleCustomAltItem();
        }
        
        function populateAltItemDropdown() {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            const dropdown = $('newAltItemType');
            
            // Rebuild dropdown
            let html = `
                <option value="hem">Hem (shorten/lengthen)</option>
                <option value="bustle">Bustle</option>
                <option value="take-in">Take In</option>
                <option value="let-out">Let Out</option>
                <option value="straps">Straps Adjustment</option>
                <option value="cups">Add Bra Cups</option>
                <option value="buttons">Buttons/Hooks</option>
                <option value="steaming">Steaming</option>
                <option value="cleaning">Cleaning</option>
            `;
            
            if (savedItems.length > 0) {
                html += `<option value="---" disabled>‚îÄ‚îÄ Saved Items ‚îÄ‚îÄ</option>`;
                savedItems.forEach(item => {
                    html += `<option value="saved:${item}">${item}</option>`;
                });
            }
            
            html += `<option value="custom">+ Custom...</option>`;
            dropdown.innerHTML = html;
        }
        
        function manageSavedAltItems() {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            
            if (savedItems.length === 0) {
                toast('No saved items yet. Add a custom item and check "Save for future use"', 'info');
                return;
            }
            
            let html = '<div style="font-size:12px;margin-bottom:12px">Click √ó to remove saved items:</div>';
            savedItems.forEach((item, idx) => {
                html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--cream);border-radius:4px;margin-bottom:4px">
                    <span>${item}</span>
                    <button class="action-btn" style="color:#e74c3c" onclick="deleteSavedAltItem(${idx})">√ó</button>
                </div>`;
            });
            
            // Show in a simple alert-style popup
            const popup = document.createElement('div');
            popup.id = 'savedItemsPopup';
            popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:10001;max-width:300px;width:90%';
            popup.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h3 style="font-size:14px;font-weight:600">Saved Alteration Items</h3>
                    <button onclick="document.getElementById('savedItemsPopup').remove()" style="background:none;border:none;font-size:18px;cursor:pointer">√ó</button>
                </div>
                ${html}
            `;
            document.body.appendChild(popup);
        }
        
        function deleteSavedAltItem(idx) {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            const removed = savedItems.splice(idx, 1);
            localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
            toast(`Removed "${removed}"`, 'success');
            
            // Refresh the popup
            document.getElementById('savedItemsPopup')?.remove();
            if (savedItems.length > 0) {
                manageSavedAltItems();
            }
            
            // Refresh dropdown if form is open
            if ($('addAltItemForm').style.display !== 'none') {
                populateAltItemDropdown();
            }
        }
        
        function cancelAddAltItem() {
            $('addAltItemForm').style.display = 'none';
        }
        
        function toggleCustomAltItem() {
            const val = $('newAltItemType').value;
            $('customAltItemGroup').style.display = val === 'custom' ? 'block' : 'none';
        }
        
        function saveNewAltItem() {
            const type = $('newAltItemType').value;
            let name;
            
            if (type === 'custom') {
                name = $('customAltItem').value.trim();
                if (!name) {
                    toast('Enter item name', 'error');
                    return;
                }
                // Save for future if checkbox checked
                if ($('saveCustomAltItem')?.checked) {
                    const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
                    if (!savedItems.includes(name)) {
                        savedItems.push(name);
                        localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
                        toast('Item saved for future use!', 'success');
                    }
                }
            } else if (type.startsWith('saved:')) {
                name = type.replace('saved:', '');
            } else {
                name = type.charAt(0).toUpperCase() + type.slice(1).replace('-', ' ');
            }
            
            const details = $('newAltItemDetails').value;
            
            // Calculate which fitting we're at
            const fittings = data.appointments.filter(a => 
                a.ClientID == currentAltClientId && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            );
            const pastFittings = fittings.filter(f => parseDate(f.Date) < new Date());
            
            currentAltItems.push({
                id: 'alt_' + Date.now(),
                name,
                details,
                status: 'pending',
                addedAtFitting: pastFittings.length || 1
            });
            
            renderAltItems();
            cancelAddAltItem();
        }
        
        function updateAltItemStatus(idx, status) {
            if (currentAltItems[idx]) {
                currentAltItems[idx].status = status;
                renderAltItems();
            }
        }
        
        function removeAltItem(idx) {
            if (confirm('Remove this alteration item?')) {
                currentAltItems.splice(idx, 1);
                renderAltItems();
            }
        }
        
        function saveAlterations() {
            if (!currentAltClientId) return;
            
            localStorage.setItem(`alts_${currentAltClientId}`, JSON.stringify(currentAltItems));
            localStorage.setItem(`alts_notes_${currentAltClientId}`, $('altNotes').value);
            
            // Update order status to 'in alterations' if needed
            const order = data.orders.find(o => o.ClientID == currentAltClientId && o.Status === 'QA complete');
            if (order) {
                updateRecord('Orders', order.ID, { Status: 'in alterations' });
            }
            
            toast('Alterations saved!', 'success');
            closeModal('alteration');
            renderAlts();
        }
        
        function sendFittingSummary() {
            const c = getClient(currentAltClientId);
            if (!c || !c.Email) {
                toast('No email address for this client', 'error');
                return;
            }
            
            // Count fittings to determine which fitting this is
            const fittings = data.appointments.filter(a => 
                a.ClientID == currentAltClientId && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            );
            const pastFittings = fittings.filter(f => parseDate(f.Date) <= new Date());
            const fittingNum = pastFittings.length || 1;
            const nextFitting = fittings.find(f => parseDate(f.Date) > new Date());
            
            // Build summary
            const doneItems = currentAltItems.filter(i => i.status === 'done').map(i => `  ‚úì ${i.name}${i.details ? ' ‚Äì ' + i.details : ''}`).join('\n');
            const inProgressItems = currentAltItems.filter(i => i.status === 'in-progress').map(i => `  ‚Üí ${i.name}${i.details ? ' ‚Äì ' + i.details : ''} (in progress)`).join('\n');
            const pendingItems = currentAltItems.filter(i => i.status === 'pending' || i.status === 'needs-adjustment').map(i => `  ‚óã ${i.name}${i.details ? ' ‚Äì ' + i.details : ''}${i.status === 'needs-adjustment' ? ' (needs adjustment)' : ''}`).join('\n');
            const notes = $('altNotes').value;
            
            // Get wedding date info
            const weddingDate = c.WeddingDate ? fmtDate(c.WeddingDate) : null;
            
            const subject = `Your Fitting Summary ‚Äì Estrelle Bridal`;
            let body = `Dear ${c.FirstName},

Thank you for visiting us today for your ${fittingNum === 1 ? 'first ' : ''}fitting appointment. It was wonderful to see you and we're excited to be part of your wedding journey!

FITTING ${fittingNum} SUMMARY
${'‚îÄ'.repeat(30)}
`;
            if (doneItems) body += `\nCompleted:\n${doneItems}\n`;
            if (inProgressItems) body += `\nIn Progress:\n${inProgressItems}\n`;
            if (pendingItems) body += `\nRemaining:\n${pendingItems}\n`;
            if (notes) body += `\nSeamstress Notes:\n${notes}\n`;
            
            body += `\n${'‚îÄ'.repeat(30)}`;
            
            if (nextFitting) {
                body += `\n\nYour next fitting is scheduled for ${fmtDate(nextFitting.Date)}. We look forward to seeing you then!`;
            } else {
                body += `\n\nPlease contact us to schedule your next fitting appointment.`;
            }
            
            if (weddingDate) {
                body += `\n\nWedding Date: ${weddingDate}`;
            }
            
            body += `

If you have any questions or need to reschedule, please don't hesitate to contact us.

Warm regards,

Estrelle Bridal
55 Avenue Road, Suite 201.5
Toronto, Ontario
(647) 333-6582
www.estrellebridal.com`;
            
            // Use Gmail compose URL (works better than mailto)
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(c.Email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
        }
        
        function copySeamstressText() {
            const c = getClient(currentAltClientId);
            if (!c) return;
            
            // Get wedding date and calculate urgency
            const weddingDate = c.WeddingDate ? parseDate(c.WeddingDate) : null;
            const daysUntil = weddingDate ? Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            // Get next fitting
            const fittings = data.appointments.filter(a => 
                a.ClientID == currentAltClientId && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            );
            const nextFitting = fittings.find(f => parseDate(f.Date) > new Date());
            
            // Get dress needed by - calculate 2 weeks before wedding if not set
            let dressNeededBy = localStorage.getItem(`alts_neededby_${currentAltClientId}`);
            if (!dressNeededBy && weddingDate) {
                const neededByDate = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                dressNeededBy = fmtDate(neededByDate);
            }
            
            // Build text-friendly summary
            let text = `üìç ${c.FirstName} ${c.LastName}\n`;
            
            // Dress needed by - show prominently at top
            if (dressNeededBy) {
                const neededByDate = parseDate(dressNeededBy);
                const daysUntilNeeded = neededByDate ? Math.ceil((neededByDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
                text += `üéØ NEED BY: ${dressNeededBy}`;
                if (daysUntilNeeded !== null) {
                    if (daysUntilNeeded <= 7) text += ` ‚ö†Ô∏è ${daysUntilNeeded} days!`;
                    else text += ` (${daysUntilNeeded} days)`;
                }
                text += `\n`;
            }
            
            if (weddingDate) {
                text += `üíí Wedding: ${fmtDate(c.WeddingDate)}`;
                if (daysUntil <= 30) text += ` ‚ö†Ô∏è`;
                text += ` (${daysUntil} days)\n`;
            }
            if (nextFitting) {
                text += `üìÖ Next fitting: ${fmtDate(nextFitting.Date)}\n`;
            }
            text += `\n`;
            
            // Items to do
            const pending = currentAltItems.filter(i => i.status === 'pending');
            const inProgress = currentAltItems.filter(i => i.status === 'in-progress');
            const needsAdj = currentAltItems.filter(i => i.status === 'needs-adjustment');
            const done = currentAltItems.filter(i => i.status === 'done');
            
            if (needsAdj.length > 0) {
                text += `üî¥ NEEDS ADJUSTMENT:\n`;
                needsAdj.forEach(i => text += `‚Ä¢ ${i.name}${i.details ? ' - ' + i.details : ''}\n`);
                text += `\n`;
            }
            
            if (inProgress.length > 0) {
                text += `üü° IN PROGRESS:\n`;
                inProgress.forEach(i => text += `‚Ä¢ ${i.name}${i.details ? ' - ' + i.details : ''}\n`);
                text += `\n`;
            }
            
            if (pending.length > 0) {
                text += `‚ö™ TO DO:\n`;
                pending.forEach(i => text += `‚Ä¢ ${i.name}${i.details ? ' - ' + i.details : ''}\n`);
                text += `\n`;
            }
            
            if (done.length > 0) {
                text += `‚úÖ DONE:\n`;
                done.forEach(i => text += `‚Ä¢ ${i.name}\n`);
                text += `\n`;
            }
            
            // Notes
            const notes = $('altNotes').value;
            if (notes) {
                text += `üìù Notes: ${notes}\n`;
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                toast('Copied! Paste into text message üì±', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                toast('Copied! Paste into text message üì±', 'success');
            });
        }

        // ========== DESIGNERS ==========
        function renderDesigners() {
            $('designersTable').innerHTML = designerData.map((d, idx) => {
                // Format rush tiers
                let tiersHtml = '';
                if (d.rushTiers && d.rushTiers.length > 0) {
                    tiersHtml = d.rushTiers.map(t => {
                        const note = t.note ? `<br><span style="font-size:9px;color:var(--rose)">${t.note}</span>` : '';
                        return `<div style="margin-bottom:4px"><b>${t.months} months:</b> ${t.fee}${note}</div>`;
                    }).join('');
                } else {
                    tiersHtml = '<span style="color:var(--taupe)">No rush tiers</span>';
                }
                
                // Format below minimum
                let belowHtml = '‚Äî';
                if (d.belowMin && (d.belowMin.fee || d.belowMin.note)) {
                    belowHtml = `<span style="color:var(--rose)">`;
                    if (d.belowMin.fee) belowHtml += `${d.belowMin.fee}<br>`;
                    if (d.belowMin.note) belowHtml += `<span style="font-size:9px">${d.belowMin.note}</span>`;
                    belowHtml += '</span>';
                }
                
                return `<tr>
                    <td style="font-weight:500">${d.name}</td>
                    <td><span style="font-size:18px;font-weight:600">${d.standard}</span> months<br><span style="font-size:9px;color:var(--sage)">No rush fee</span></td>
                    <td style="font-size:11px">${tiersHtml}</td>
                    <td style="font-size:11px">${belowHtml}</td>
                    <td><button class="action-btn" onclick="editDesignerByIdx(${idx})">Edit</button></td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" class="empty">No designers</td></tr>';
        }
        
        let editingDesignerTiers = [];
        
        function openAddDesignerModal() {
            $('designerModalTitle').textContent = 'Add Designer';
            $('edDesignerIdx').value = '-1';
            $('edDesignerName').value = '';
            $('edDesignerStandard').value = '4';
            $('edDesignerMinMonths').value = '';
            $('edDesignerBelowFee').value = '';
            $('edDesignerBelowNote').value = 'Inquiry required';
            editingDesignerTiers = [];
            renderDesignerTiers();
            openModal('editDesigner');
        }
        
        function editDesignerByIdx(idx) {
            const d = designerData[idx];
            if (!d) return;
            
            $('designerModalTitle').textContent = 'Edit Designer';
            $('edDesignerIdx').value = idx;
            $('edDesignerName').value = d.name || '';
            $('edDesignerStandard').value = d.standard || 4;
            $('edDesignerMinMonths').value = d.minMonths || '';
            $('edDesignerBelowFee').value = d.belowMin?.fee || '';
            $('edDesignerBelowNote').value = d.belowMin?.note || '';
            editingDesignerTiers = d.rushTiers ? [...d.rushTiers] : [];
            renderDesignerTiers();
            openModal('editDesigner');
        }
        
        function renderDesignerTiers() {
            $('edDesignerTiers').innerHTML = editingDesignerTiers.length ? editingDesignerTiers.map((t, i) => `
                <div class="form-row" style="margin-bottom:6px;align-items:center">
                    <div class="form-group" style="margin-bottom:0;flex:1">
                        <input type="number" class="form-input" value="${t.months||''}" onchange="editingDesignerTiers[${i}].months=+this.value" placeholder="Months" min="1" max="12">
                    </div>
                    <div class="form-group" style="margin-bottom:0;flex:2">
                        <input type="text" class="form-input" value="${t.fee||''}" onchange="editingDesignerTiers[${i}].fee=this.value" placeholder="Fee (e.g. 10% rush)">
                    </div>
                    <button class="action-btn" onclick="editingDesignerTiers.splice(${i},1);renderDesignerTiers()" style="padding:8px">√ó</button>
                </div>
            `).join('') : '<div class="empty" style="padding:8px;font-size:11px">No rush tiers - click + Add to create</div>';
        }
        
        function addDesignerTier() {
            editingDesignerTiers.push({ months: '', fee: '' });
            renderDesignerTiers();
        }
        
        function saveDesigner() {
            const idx = parseInt($('edDesignerIdx').value);
            const name = $('edDesignerName').value.trim();
            if (!name) { toast('Enter designer name'); return; }
            
            const designer = {
                name: name,
                standard: parseInt($('edDesignerStandard').value) || 4,
                rushTiers: editingDesignerTiers.filter(t => t.months && t.fee).sort((a,b) => b.months - a.months),
                minMonths: parseInt($('edDesignerMinMonths').value) || null,
                belowMin: {
                    fee: $('edDesignerBelowFee').value.trim() || null,
                    note: $('edDesignerBelowNote').value.trim() || null
                }
            };
            
            // Set minMonths to lowest tier or standard if not set
            if (!designer.minMonths) {
                if (designer.rushTiers.length > 0) {
                    designer.minMonths = designer.rushTiers[designer.rushTiers.length - 1].months;
                } else {
                    designer.minMonths = designer.standard;
                }
            }
            
            if (idx === -1) {
                designerData.push(designer);
            } else {
                designerData[idx] = designer;
            }
            
            saveDesignerData();
            closeModal('editDesigner');
            renderDesigners();
            toast('Designer saved!', 'success');
        }
        
        function deleteDesigner() {
            const idx = parseInt($('edDesignerIdx').value);
            if (idx === -1) {
                closeModal('editDesigner');
                return;
            }
            
            const name = designerData[idx]?.name || 'this designer';
            if (!confirm(`Delete "${name}"?`)) return;
            
            designerData.splice(idx, 1);
            saveDesignerData();
            closeModal('editDesigner');
            renderDesigners();
            toast('Designer deleted', 'success');
        }

        // ========== CONSULTANTS ==========
        let consultantSigPad = null;
        
        function renderConsultants() {
            $('consultantsList').innerHTML = data.consultants.length ? data.consultants.map(c => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--cream);border-radius:5px;margin-bottom:8px">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div class="avatar">${(c.Name || '?')[0]}</div>
                        <div>
                            <div style="font-weight:500">${c.Name || 'Unknown'}</div>
                            <div style="font-size:10px;color:var(--rose)">${c.Signature ? '‚úì Signature saved' : 'No signature'}</div>
                        </div>
                    </div>
                    <div>
                        <button class="action-btn" onclick="editConsultant(${c.ID})">Edit</button>
                        <button class="action-btn" onclick="deleteConsultant(${c.ID})">Delete</button>
                    </div>
                </div>
            `).join('') : '<div class="empty">No consultants yet. Add your team members to save their signatures.</div>';
            
            // Also render saved alteration items
            renderSavedAltItems();
        }
        
        function renderSavedAltItems() {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            if (savedItems.length === 0) {
                $('savedAltItemsList').innerHTML = '<div class="empty" style="font-size:11px">No custom items saved yet. Add items here or check "Save for future use" when adding alterations.</div>';
                return;
            }
            
            $('savedAltItemsList').innerHTML = savedItems.map((item, idx) => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--cream);border-radius:4px;margin-bottom:6px">
                    <span style="font-size:12px">‚úÇÔ∏è ${item}</span>
                    <button class="action-btn" style="color:#e74c3c" onclick="removeSavedAltItem(${idx})">√ó</button>
                </div>
            `).join('');
        }
        
        function addSavedAltItem() {
            const name = $('newSavedAltItem').value.trim();
            if (!name) {
                toast('Enter item name', 'error');
                return;
            }
            
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            if (savedItems.includes(name)) {
                toast('Item already exists', 'error');
                return;
            }
            
            savedItems.push(name);
            localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
            $('newSavedAltItem').value = '';
            renderSavedAltItems();
            toast('Item saved!', 'success');
        }
        
        function removeSavedAltItem(idx) {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            savedItems.splice(idx, 1);
            localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
            renderSavedAltItems();
            toast('Item removed', 'success');
        }
        
        function initConsultantSigPad() {
            $('editConsultantId').value = '';
            $('cConsultantName').value = '';
            $('consultantModalTitle').textContent = 'Add Consultant';
            
            setTimeout(() => {
                const canvas = $('consultantSigPad');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#2C2825';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                
                let drawing = false;
                const getPos = e => { 
                    const r = canvas.getBoundingClientRect(); 
                    return { 
                        x: ((e.clientX||e.touches?.[0]?.clientX) - r.left) * (canvas.width/r.width), 
                        y: ((e.clientY||e.touches?.[0]?.clientY) - r.top) * (canvas.height/r.height) 
                    }; 
                };
                canvas.onmousedown = canvas.ontouchstart = e => { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
                canvas.onmousemove = canvas.ontouchmove = e => { if (!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
                canvas.onmouseup = canvas.ontouchend = canvas.onmouseleave = () => { drawing = false; };
                
                consultantSigPad = { canvas, ctx };
            }, 100);
        }
        
        function clearConsultantSig() {
            if (!consultantSigPad) return;
            consultantSigPad.ctx.fillStyle = 'white';
            consultantSigPad.ctx.fillRect(0, 0, consultantSigPad.canvas.width, consultantSigPad.canvas.height);
        }
        
        function editConsultant(id) {
            const c = data.consultants.find(x => x.ID == id);
            if (!c) return;
            
            $('editConsultantId').value = c.ID;
            $('cConsultantName').value = c.Name || '';
            $('consultantModalTitle').textContent = 'Edit Consultant';
            
            openModal('newConsultant');
            
            // Load existing signature after canvas is ready
            setTimeout(() => {
                if (c.Signature && consultantSigPad) {
                    const img = new Image();
                    img.onload = () => {
                        consultantSigPad.ctx.fillStyle = 'white';
                        consultantSigPad.ctx.fillRect(0, 0, consultantSigPad.canvas.width, consultantSigPad.canvas.height);
                        consultantSigPad.ctx.drawImage(img, 0, 0);
                    };
                    img.src = c.Signature;
                }
            }, 150);
        }
        
        async function saveConsultant() {
            const id = $('editConsultantId').value;
            const name = $('cConsultantName').value.trim();
            if (!name) { toast('Enter name'); return; }
            
            const signature = consultantSigPad?.canvas?.toDataURL() || null;
            const record = { Name: name, Signature: signature };
            
            closeModal('newConsultant');
            toast('Saving...', '');
            
            if (id) {
                updateRecord('Consultants', id, record);
            } else {
                saveRecord('Consultants', record);
            }
            
            toast('Saved!', 'success');
            renderConsultants();
        }
        
        async function deleteConsultant(id) {
            if (!confirm('Delete this consultant?')) return;
            deleteRecord('Consultants', id);
            renderConsultants();
            toast('Deleted', 'success');
        }
        
        function loadConsultantSignature() {
            const selectedId = $('yConsultantSelect').value;
            const consultant = data.consultants.find(c => c.ID == selectedId);
            
            if (consultant && consultant.Signature && sigPadConsultant) {
                const img = new Image();
                img.onload = () => {
                    sigPadConsultant.ctx.fillStyle = 'white';
                    sigPadConsultant.ctx.fillRect(0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                    sigPadConsultant.ctx.drawImage(img, 0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                    $('consultantSigNote').textContent = consultant.Name + "'s signature loaded";
                    $('sigTimeConsultant').textContent = new Date().toLocaleString();
                };
                img.src = consultant.Signature;
                currentOrder.consultant = consultant.Name;
            } else if (sigPadConsultant) {
                sigPadConsultant.ctx.fillStyle = 'white';
                sigPadConsultant.ctx.fillRect(0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                $('consultantSigNote').textContent = 'Select consultant above to load signature';
                $('sigTimeConsultant').textContent = '';
            }
        }

        // ========== CONSULTATION ==========
        function openClient(id) {
            const c = getClient(id);
            if (!c) return;
            currentClient = c;
            $('cAvatar').textContent = initials(c.FirstName, c.LastName);
            $('cName').textContent = c.FirstName + ' ' + c.LastName;
            
            let metaText = `Wedding: ${fmtDate(c.WeddingDate)} ¬∑ ${c.Venue || 'Venue TBD'}`;
            if (c.DestinationWedding === true || c.DestinationWedding === 'TRUE') {
                metaText += ' ¬∑ ‚úàÔ∏è Destination';
                if (c.LeavingDate) {
                    metaText += ` (Leaving: ${fmtDate(c.LeavingDate)})`;
                }
            }
            $('cMeta').textContent = metaText;
            
            $('cStyle').value = c.StylePreferences || '';
            $('cNotes').value = c.Notes || '';
            $('cBudget').value = c.Budget || '';
            
            // Save original values to detect unsaved changes
            originalClientNotes = {
                style: c.StylePreferences || '',
                notes: c.Notes || '',
                budget: c.Budget || ''
            };
            
            // Check for saved draft
            $('draftIndicator').style.display = hasDraft(c.ID) ? 'inline' : 'none';
            
            renderTimeline();
            renderClientAppts();
            renderClientOptions();
            renderVisitHistory();
            showPage('consult', true); // true = skip unsaved check since we're opening
        }
        
        function hasUnsavedClientNotes() {
            if (!currentClient) return false;
            return $('cStyle').value !== originalClientNotes.style ||
                   $('cNotes').value !== originalClientNotes.notes ||
                   $('cBudget').value !== originalClientNotes.budget;
        }

        function toggleDesignerTable() {
            const wrap = $('designerTableWrap');
            const btn = $('tlToggle');
            if (wrap.style.display === 'none') {
                wrap.style.display = 'block';
                btn.textContent = 'Designer Rush Fees ‚ñ≤';
            } else {
                wrap.style.display = 'none';
                btn.textContent = 'Designer Rush Fees ‚ñº';
            }
        }
        
        // Designer rush fee data - hardcoded for reliability
        const DESIGNER_RUSH_DATA = [
            {
                name: 'Vivienne Westwood',
                standard: 5,
                rushTiers: [
                    { months: 3, fee: '$3,800 extra', note: 'Inquiry required, not guaranteed' }
                ],
                belowMin: { fee: '$4,600 extra', note: 'Inquiry required, not guaranteed' },
                minMonths: 3
            },
            {
                name: 'Netta BenShabu',
                standard: 7,
                rushTiers: [
                    { months: 6, fee: '10% rush' },
                    { months: 5, fee: '20% rush' }
                ],
                belowMin: { note: 'Inquiry required, may be possible with higher rush' },
                minMonths: 5
            },
            {
                name: 'Stephane Rolland',
                standard: 2,
                rushTiers: [],
                belowMin: { note: 'Inquiry required, may not be possible' },
                minMonths: 2
            },
            {
                name: 'Enaura Bridal',
                standard: 4,
                rushTiers: [
                    { months: 3, fee: '10% rush' },
                    { months: 2, fee: '20% rush' }
                ],
                belowMin: { note: 'Inquiry required, most likely possible' },
                minMonths: 2
            },
            {
                name: 'Nicole + Felicia',
                standard: 4,
                rushTiers: [
                    { months: 3, fee: '10% rush' },
                    { months: 2, fee: '20% rush' }
                ],
                belowMin: { note: 'Inquiry required, most likely possible' },
                minMonths: 2
            },
            {
                name: 'Rosa Clara',
                standard: 4,
                rushTiers: [],
                belowMin: { note: 'Inquiry required, most likely possible' },
                minMonths: 4
            },
            {
                name: 'Tania Olsen',
                standard: 4,
                rushTiers: [],
                belowMin: { note: 'Inquiry required, most likely NOT possible' },
                minMonths: 4
            }
        ];
        
        // Load designers from localStorage or use defaults
        let designerData = [];
        function loadDesignerData() {
            const saved = localStorage.getItem('estrelle_designers');
            if (saved) {
                try {
                    designerData = JSON.parse(saved);
                } catch (e) {
                    designerData = [...DEFAULT_DESIGNER_DATA];
                }
            } else {
                designerData = [...DEFAULT_DESIGNER_DATA];
            }
        }
        function saveDesignerData() {
            localStorage.setItem('estrelle_designers', JSON.stringify(designerData));
        }
        
        // Rename constant to DEFAULT
        const DEFAULT_DESIGNER_DATA = DESIGNER_RUSH_DATA;
        
        // Initialize on load
        loadDesignerData();

        function renderTimeline() {
            updateTimeline();
        }
        
        function updateTimeline() {
            const c = currentClient;
            const totalMonths = monthsUntil(c.WeddingDate);
            const altMonths = parseInt($('tlAltMonths').value) || 4;
            
            // Show alteration warning
            $('altWarning').style.display = altMonths < 3 ? 'block' : 'none';
            
            // Calculate production months (total - alterations)
            const prodMonths = totalMonths !== null ? Math.max(0, totalMonths - altMonths) : null;
            
            $('tlMonths').textContent = totalMonths !== null ? totalMonths : '‚Äî';
            
            // Count statuses
            let okCount = 0, rushCount = 0, inquireCount = 0;
            
            const rows = designerData.map(d => {
                let statusBadge, statusText, rushInfo;
                
                // Build rush fee description
                let rushDesc = '';
                if (d.rushTiers.length > 0) {
                    rushDesc = d.rushTiers.map(t => `${t.months}mo: ${t.fee}`).join('<br>');
                }
                if (d.belowMin) {
                    const belowText = d.belowMin.fee ? `<${d.minMonths}mo: ${d.belowMin.fee}` : `<${d.minMonths}mo: Inquire`;
                    rushDesc += (rushDesc ? '<br>' : '') + `<span style="color:var(--rose)">${belowText}</span>`;
                }
                if (!rushDesc) rushDesc = '‚Äî';
                
                // Determine status for this client's timeline
                if (prodMonths === null) {
                    statusBadge = 'confirm';
                    statusText = 'Set date';
                } else if (prodMonths >= d.standard) {
                    statusBadge = 'ok';
                    statusText = '‚úì No rush';
                    okCount++;
                } else {
                    // Check rush tiers
                    let foundTier = null;
                    for (const t of d.rushTiers) {
                        if (prodMonths >= t.months) {
                            foundTier = t;
                            break;
                        }
                    }
                    
                    if (foundTier) {
                        statusBadge = foundTier.fee.includes('20') ? 'high' : 'warn';
                        statusText = foundTier.fee;
                        rushCount++;
                    } else if (prodMonths < d.minMonths || d.rushTiers.length === 0 && prodMonths < d.standard) {
                        statusBadge = 'confirm';
                        statusText = '‚ö†Ô∏è Rush (Inquire)';
                        inquireCount++;
                    } else {
                        statusBadge = 'confirm';
                        statusText = '‚ö†Ô∏è Rush (Inquire)';
                        inquireCount++;
                    }
                }
                
                return `<tr>
                    <td style="font-weight:500">${d.name}</td>
                    <td>${d.standard} months</td>
                    <td style="font-size:10px;line-height:1.4">${rushDesc}</td>
                    <td><span class="rush-badge ${statusBadge}">${statusText}</span></td>
                </tr>`;
            });
            
            // Summary text
            let summary = '';
            if (totalMonths === null) {
                summary = '<span style="color:var(--rose)">‚ö†Ô∏è Set wedding date</span>';
            } else if (prodMonths <= 0) {
                summary = '<span style="color:#c00">‚ùå Not enough time</span>';
            } else if (rushCount > 0 || inquireCount > 0) {
                const parts = [];
                if (okCount > 0) parts.push(`<span style="color:var(--sage)">‚úì ${okCount} OK</span>`);
                if (rushCount > 0) parts.push(`<span style="color:#e67e22">‚ö† ${rushCount} rush</span>`);
                if (inquireCount > 0) parts.push(`<span style="color:var(--rose)">‚ö† ${inquireCount} rush (inquire)</span>`);
                summary = parts.join('<br>');
            } else {
                summary = `<span style="color:var(--sage)">‚úì All ${okCount} designers OK</span>`;
            }
            $('tlSummary').innerHTML = summary;
            
            $('rushBody').innerHTML = rows.join('');
        }

        function renderClientAppts() {
            const appts = data.appointments.filter(a => a.ClientID == currentClient.ID).sort((a,b) => (b.Date||'').localeCompare(a.Date||''));
            $('cAppts').innerHTML = appts.length ? appts.map(a => `
                <div class="appt-item appt-type-${a.Type || 'consultation'}" onclick="editAppt(${a.ID})" style="cursor:pointer">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div>
                            <div class="appt-date">${fmtDate(a.Date)} at ${fmtTime(a.Time)}</div>
                            <div class="appt-meta">${a.Type||''} ¬∑ ${a.Consultant||''}</div>
                        </div>
                        <div class="appt-actions" onclick="event.stopPropagation()">
                            <button class="action-btn" onclick="deleteApptConfirm(${a.ID})">√ó</button>
                        </div>
                    </div>
                    ${a.Notes ? `<div class="appt-notes" style="margin-top:6px;padding-top:6px;border-top:1px dashed var(--champagne)">${a.Notes}</div>` : '<div style="font-size:10px;color:var(--champagne);margin-top:4px;font-style:italic">Click to add notes</div>'}
                </div>
            `).join('') : '<div class="empty">No appointments</div>';
        }

        function addApptForClient() {
            populateApptModal(currentClient.ID);
            openModal('newAppt');
        }

        async function deleteApptConfirm(id) {
            if (!confirm('Delete this appointment?')) return;
            deleteRecord('Appointments', id);
            renderClientAppts();
            toast('Deleted', 'success');
        }

        function populateOptionModal() {
            $('oDesigner').innerHTML = '<option value="">Select...</option>' + 
                designerData.map(d => `<option value="${d.name}">${d.name}</option>`).join('') +
                '<option value="custom">+ Custom Designer</option>';
            $('customDesignerGroup').style.display = 'none';
            $('oCustomDesigner').value = '';
        }

        function toggleCustomDesigner() {
            const isCustom = $('oDesigner').value === 'custom';
            $('customDesignerGroup').style.display = isCustom ? 'block' : 'none';
            if (isCustom) $('oCustomDesigner').focus();
        }

        function renderClientOptions() {
            const opts = data.topoptions.filter(o => o.ClientID == currentClient.ID);
            $('cOptions').innerHTML = opts.length ? opts.map(o => {
                const isTop = o.IsFavorite === true || o.IsFavorite === 'TRUE';
                return `
                <div class="option-card ${isTop ? 'favorite' : ''}">
                    <div class="option-designer">${o.Designer} ‚Äî ${o.Style}</div>
                    <div class="option-style">${o.Size ? 'Size ' + o.Size : ''} ${o.Price ? '¬∑ ' + money(o.Price) : ''}</div>
                    ${o.Customizations ? `<div class="option-notes"><b>Custom:</b> ${o.Customizations}</div>` : ''}
                    ${o.Notes ? `<div class="option-notes">${o.Notes}</div>` : ''}
                    <div class="option-actions">
                        <button class="action-btn" onclick="toggleFavorite(${o.ID})">${isTop ? '‚òÖ Top' : '‚≠ê'}</button>
                        <button class="action-btn" onclick="deleteOptionConfirm(${o.ID})">Delete</button>
                    </div>
                </div>`;
            }).join('') : '<div class="empty">No options</div>';
        }

        async function saveOption() {
            let designer = $('oDesigner').value;
            if (designer === 'custom') {
                designer = $('oCustomDesigner').value.trim();
                if (!designer) { toast('Enter custom designer name'); return; }
            }
            
            const record = { ClientID: currentClient.ID, Designer: designer, Style: $('oStyle').value, Price: +$('oPrice').value || 0, Size: $('oSize').value, Customizations: $('oCustom').value, Notes: $('oOptionNotes').value, IsFavorite: $('oFavorite').checked };
            if (!record.Designer) { toast('Select designer'); return; }
            
            closeModal('addOption');
            saveRecord('TopOptions', record);
            ['oDesigner','oStyle','oPrice','oSize','oCustom','oOptionNotes','oCustomDesigner'].forEach(i => $(i).value = '');
            $('oFavorite').checked = false;
            $('customDesignerGroup').style.display = 'none';
            renderClientOptions();
            toast('Added!', 'success');
        }

        async function toggleFavorite(id) {
            const opt = data.topoptions.find(o => o.ID == id);
            if (!opt) return;
            const newValue = !(opt.IsFavorite === true || opt.IsFavorite === 'TRUE');
            updateRecord('TopOptions', id, { IsFavorite: newValue });
            renderClientOptions();
        }

        async function deleteOptionConfirm(id) {
            if (!confirm('Delete this option?')) return;
            deleteRecord('TopOptions', id);
            renderClientOptions();
            toast('Deleted', 'success');
        }

        async function saveClientNotes() {
            updateRecord('Clients', currentClient.ID, {
                StylePreferences: $('cStyle').value,
                Notes: $('cNotes').value,
                Budget: $('cBudget').value,
                LastVisit: today(),
                Status: currentClient.Status === 'new' ? 'consultation' : currentClient.Status
            });
            // Also update local currentClient
            currentClient.StylePreferences = $('cStyle').value;
            currentClient.Notes = $('cNotes').value;
            currentClient.Budget = $('cBudget').value;
            
            // Update original values so unsaved check passes
            originalClientNotes = {
                style: $('cStyle').value,
                notes: $('cNotes').value,
                budget: $('cBudget').value
            };
            
            toast('Saved!', 'success');
        }

        // ========== VISIT NOTES ==========
        function renderVisitHistory() {
            // Pull from appointments that have notes
            const apptsWithNotes = data.appointments
                .filter(a => a.ClientID == currentClient.ID && a.Notes)
                .sort((a, b) => (b.Date || '').localeCompare(a.Date || ''));
            
            if (!apptsWithNotes.length) {
                $('cVisitHistory').innerHTML = '<div class="empty">No visit notes yet. Click on any appointment above to add notes about what was discussed.</div>';
                return;
            }
            
            $('cVisitHistory').innerHTML = apptsWithNotes.map(a => {
                const typeColors = {
                    consultation: '#9b59b6',
                    fitting: '#3498db',
                    pickup: '#27ae60',
                    alteration: '#e67e22',
                    other: '#7f8c8d'
                };
                const color = typeColors[a.Type] || '#7f8c8d';
                
                return `<div style="border-left:3px solid ${color};padding:10px 12px;margin-bottom:10px;background:var(--cream);border-radius:0 5px 5px 0;cursor:pointer" onclick="editAppt(${a.ID})">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
                        <div>
                            <span style="font-weight:600;font-size:12px">${fmtDate(a.Date)}</span>
                            <span style="background:${color};color:white;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">${a.Type || 'appointment'}</span>
                            ${a.Consultant ? `<span style="font-size:10px;color:var(--taupe);margin-left:6px">with ${a.Consultant}</span>` : ''}
                        </div>
                        <span style="font-size:9px;color:var(--taupe)">click to edit</span>
                    </div>
                    <div style="font-size:11px;line-height:1.5;white-space:pre-wrap">${a.Notes}</div>
                </div>`;
            }).join('');
        }

        // ========== SHE SAID YES ==========
        let yStep = 1;
        let measUnit = 'in';
        let customMeasurements = [];

        function setMeasUnit(unit) {
            measUnit = unit;
            $('unitCm').className = unit === 'cm' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('unitCm').style.background = unit === 'cm' ? 'var(--charcoal)' : '';
            $('unitCm').style.color = unit === 'cm' ? 'white' : '';
            $('unitIn').className = unit === 'in' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('unitIn').style.background = unit === 'in' ? 'var(--charcoal)' : '';
            $('unitIn').style.color = unit === 'in' ? 'white' : '';
            document.querySelectorAll('[data-unit]').forEach(el => el.textContent = unit);
        }

        function addCustomMeas() {
            const name = $('customMeasName').value.trim();
            const value = $('customMeasValue').value.trim();
            if (!name || !value) { toast('Enter name and value'); return; }
            customMeasurements.push({ name, value, unit: measUnit });
            $('customMeasName').value = '';
            $('customMeasValue').value = '';
            renderCustomMeas();
        }

        function renderCustomMeas() {
            $('customMeasList').innerHTML = customMeasurements.map((m, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:var(--cream);border-radius:4px;margin-bottom:4px;font-size:11px">
                    <span>${m.name}: ${m.value} ${m.unit}</span>
                    <button class="action-btn" onclick="customMeasurements.splice(${i},1);renderCustomMeas()">√ó</button>
                </div>
            `).join('');
        }

        function sheSaidYes() {
            yStep = 1;
            currentOrder = { items: [], measurements: {}, hst: false };
            customMeasurements = [];
            measUnit = 'in';
            setMeasUnit('in');
            const meas = typeof currentClient.Measurements === 'string' ? JSON.parse(currentClient.Measurements || '{}') : (currentClient.Measurements || {});
            ['mBust','mWaist','mHip','mHeight','mHeels','mHollow'].forEach(id => $(id).value = meas[id.slice(1).toLowerCase()] || '');
            $('mNotes').value = '';
            $('customMeasList').innerHTML = '';
            $('orderItems').innerHTML = '';
            $('orderTotal').textContent = '$0';
            $('addHst').checked = false;
            $('orderSubtotal').style.display = 'none';
            $('orderHstRow').style.display = 'none';
            $('yDate').value = fmtDate(today());
            updateYSteps();
            openModal('yes');
            
            // Check if there's a draft for this client
            checkForDraft();
        }
        
        function saveDraft() {
            // Collect current measurements from form
            const measurements = { 
                bust: $('mBust').value, 
                waist: $('mWaist').value, 
                hip: $('mHip').value, 
                height: $('mHeight').value, 
                hollow: $('mHollow').value,
                heels: $('mHeels').value, 
                notes: $('mNotes').value,
                unit: measUnit,
                custom: [...customMeasurements]
            };
            
            const draft = {
                clientId: currentClient.ID,
                clientName: `${currentClient.FirstName} ${currentClient.LastName}`,
                step: yStep,
                measurements: measurements,
                items: currentOrder.items,
                hst: $('addHst').checked,
                date: $('yDate').value,
                savedAt: new Date().toISOString()
            };
            
            // Save to localStorage with client ID as key
            const drafts = JSON.parse(localStorage.getItem('estrelle_drafts') || '{}');
            drafts[currentClient.ID] = draft;
            localStorage.setItem('estrelle_drafts', JSON.stringify(drafts));
            
            closeModal('yes');
            toast('Draft saved! You can continue later.', 'success');
            
            // Update client card to show draft indicator
            renderClientProfile();
        }
        
        function checkForDraft() {
            const drafts = JSON.parse(localStorage.getItem('estrelle_drafts') || '{}');
            const draft = drafts[currentClient.ID];
            
            if (draft) {
                const savedDate = new Date(draft.savedAt).toLocaleDateString();
                const itemCount = draft.items?.length || 0;
                if (confirm(`Found saved draft from ${savedDate} with ${itemCount} item(s).\n\nLoad draft and continue where you left off?`)) {
                    loadDraft(draft);
                } else {
                    // User chose to start fresh - delete the draft
                    delete drafts[currentClient.ID];
                    localStorage.setItem('estrelle_drafts', JSON.stringify(drafts));
                }
            }
        }
        
        function loadDraft(draft) {
            // Restore measurements
            if (draft.measurements) {
                $('mBust').value = draft.measurements.bust || '';
                $('mWaist').value = draft.measurements.waist || '';
                $('mHip').value = draft.measurements.hip || '';
                $('mHeight').value = draft.measurements.height || '';
                $('mHollow').value = draft.measurements.hollow || '';
                $('mHeels').value = draft.measurements.heels || '';
                $('mNotes').value = draft.measurements.notes || '';
                
                if (draft.measurements.unit) {
                    setMeasUnit(draft.measurements.unit);
                }
                
                if (draft.measurements.custom) {
                    customMeasurements = draft.measurements.custom;
                    renderCustomMeas();
                }
            }
            
            // Restore order items
            if (draft.items) {
                currentOrder.items = draft.items;
                renderOrderItems();
            }
            
            // Restore HST and date
            if (draft.hst) $('addHst').checked = true;
            if (draft.date) $('yDate').value = draft.date;
            
            // Go to the step they were on (but not past step 2 to review items)
            yStep = Math.min(draft.step || 1, 2);
            updateYSteps();
            
            toast('Draft loaded!', 'success');
        }
        
        function deleteDraft(clientId) {
            const drafts = JSON.parse(localStorage.getItem('estrelle_drafts') || '{}');
            delete drafts[clientId || currentClient.ID];
            localStorage.setItem('estrelle_drafts', JSON.stringify(drafts));
        }
        
        function hasDraft(clientId) {
            const drafts = JSON.parse(localStorage.getItem('estrelle_drafts') || '{}');
            return !!drafts[clientId];
        }

        function updateYSteps() {
            [1,2,3,4,5].forEach(i => {
                $('ys'+i).classList.remove('active','done');
                $('yStep'+i).style.display = 'none';
                if (i < yStep) $('ys'+i).classList.add('done');
                if (i === yStep) { $('ys'+i).classList.add('active'); $('yStep'+i).style.display = 'block'; }
            });
            $('yPrev').style.display = yStep > 1 ? 'inline-flex' : 'none';
            $('yNext').style.display = yStep < 5 ? 'inline-flex' : 'none';
            $('yDone').style.display = yStep === 5 ? 'inline-flex' : 'none';
            if (yStep === 3) genContract();
            if (yStep === 4) initSig();
            if (yStep === 5) prepareEmail();
        }

        function yNext() {
            if (yStep === 1) {
                currentOrder.measurements = { 
                    bust: $('mBust').value, 
                    waist: $('mWaist').value, 
                    hip: $('mHip').value, 
                    height: $('mHeight').value, 
                    hollow: $('mHollow').value,
                    heels: $('mHeels').value, 
                    notes: $('mNotes').value,
                    unit: measUnit,
                    custom: [...customMeasurements]
                };
            }
            if (yStep === 4) {
                // Validate required fields
                const bustInit = $('init_bust')?.value?.trim();
                const waistInit = $('init_waist')?.value?.trim();
                const hipInit = $('init_hip')?.value?.trim();
                
                if (!bustInit || !waistInit || !hipInit) {
                    toast('Client must initial Bust, Waist, and Hip measurements', 'error');
                    return;
                }
                
                const selectedId = $('yConsultantSelect').value;
                if (!selectedId) {
                    toast('Please select a consultant', 'error');
                    return;
                }
                
                // Check if customer has signed
                const customerSig = sigPadCustomer?.canvas?.toDataURL();
                const isCustomerSigBlank = isCanvasBlank(sigPadCustomer?.canvas);
                if (isCustomerSigBlank) {
                    toast('Customer signature is required', 'error');
                    return;
                }
                
                // Check if consultant signature is loaded
                const consultantSig = sigPadConsultant?.canvas?.toDataURL();
                const isConsultantSigBlank = isCanvasBlank(sigPadConsultant?.canvas);
                if (isConsultantSigBlank) {
                    toast('Please select consultant to load their signature', 'error');
                    return;
                }
                
                // Save signature data before moving to email step
                currentOrder.signatureData = customerSig;
                currentOrder.consultantSignatureData = consultantSig;
                const consultant = data.consultants.find(c => c.ID == selectedId);
                currentOrder.consultant = consultant ? consultant.Name : '';
                currentOrder.initials = collectInitials();
            }
            if (yStep < 5) { yStep++; updateYSteps(); }
        }
        
        function isCanvasBlank(canvas) {
            if (!canvas) return true;
            const ctx = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(
                ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            // Check if all pixels are white (0xFFFFFFFF)
            return pixelBuffer.every(color => color === 0xFFFFFFFF || color === 0);
        }
        
        function yPrev() { if (yStep > 1) { yStep--; updateYSteps(); } }

        function toggleOrderItemFields() {
            const type = $('oiType').value;
            $('oiDesignerFields').style.display = (type === 'dress' || type === 'accessory') ? 'block' : 'none';
            $('oiInhouseFields').style.display = type === 'inhouse' ? 'block' : 'none';
            $('oiCustomFields').style.display = type === 'customization' ? 'block' : 'none';
            $('oiFeeFields').style.display = type === 'fee' ? 'block' : 'none';
            
            // Populate parent dropdown for customizations
            if (type === 'customization') {
                const parentItems = currentOrder.items.filter(i => i.type === 'dress' || i.type === 'accessory' || i.type === 'inhouse');
                $('oiCustomParent').innerHTML = '<option value="">Select item...</option>' + 
                    parentItems.map((item, idx) => {
                        const label = item.type === 'inhouse' ? item.name : `${item.designer} - ${item.name}`;
                        return `<option value="${item.id}">${label}</option>`;
                    }).join('');
            }
        }
        
        function addOrderItem() {
            const type = $('oiType').value;
            const id = 'item_' + Date.now();
            let item = { id, type };
            
            if (type === 'dress' || type === 'accessory') {
                item.designer = $('oiDesigner').value.trim();
                item.name = $('oiStyle').value.trim();
                item.size = $('oiSize').value.trim();
                item.color = $('oiColor').value.trim();
                item.price = +$('oiPrice').value || 0;
                item.customizations = [];
                item.qaChecked = false;
                item.arrived = false;
                if (!item.designer || !item.name) { toast('Enter designer and style'); return; }
                // Clear fields
                ['oiDesigner','oiStyle','oiSize','oiColor','oiPrice'].forEach(i => $(i).value = '');
            } else if (type === 'inhouse') {
                item.name = $('oiInhouseName').value.trim();
                item.price = +$('oiInhousePrice').value || 0;
                item.notes = $('oiInhouseNotes').value.trim();
                item.status = 'pending';
                if (!item.name) { toast('Enter item name'); return; }
                ['oiInhouseName','oiInhousePrice','oiInhouseNotes'].forEach(i => $(i).value = '');
            } else if (type === 'customization') {
                const parentId = $('oiCustomParent').value;
                item.parentId = parentId;
                item.name = $('oiCustomName').value.trim();
                item.price = +$('oiCustomPrice').value || 0;
                item.delivery = document.querySelector('input[name="oiCustomDelivery"]:checked')?.value || 'ondress';
                item.qaChecked = false;
                if (!item.name) { toast('Enter customization name'); return; }
                if (!parentId) { toast('Select item to attach customization to'); return; }
                
                // Add to parent item's customizations array
                const parent = currentOrder.items.find(i => i.id === parentId);
                if (parent) {
                    parent.customizations = parent.customizations || [];
                    parent.customizations.push({ id: item.id, name: item.name, price: item.price, delivery: item.delivery, qaChecked: false });
                }
                ['oiCustomName','oiCustomPrice'].forEach(i => $(i).value = '');
                $('oiCustomParent').value = '';
            } else if (type === 'fee') {
                item.feeType = $('oiFeeType').value;
                item.name = item.feeType === 'shipping' ? 'Shipping' : item.feeType === 'rush' ? 'Rush Fee' : $('oiFeeNote').value || 'Other Fee';
                item.price = +$('oiFeePrice').value || 0;
                item.note = $('oiFeeNote').value.trim();
                if (!item.price) { toast('Enter fee amount'); return; }
                ['oiFeePrice','oiFeeNote'].forEach(i => $(i).value = '');
            }
            
            // Don't add customization as separate item (it's attached to parent)
            if (type !== 'customization') {
                currentOrder.items.push(item);
            }
            
            renderOrderItems();
            toast('Item added', 'success');
        }

        function removeOrderItem(index) {
            const item = currentOrder.items[index];
            const itemName = item.designer ? `${item.designer} ‚Äî ${item.name}` : item.name;
            if (confirm(`Remove "${itemName}" from order?`)) {
                currentOrder.items.splice(index, 1);
                renderOrderItems();
            }
        }
        
        function removeCustomization(parentId, customIdx) {
            const parent = currentOrder.items.find(i => i.id === parentId);
            if (parent && parent.customizations) {
                parent.customizations.splice(customIdx, 1);
                renderOrderItems();
            }
        }

        function renderOrderItems() {
            // Group items by type
            const designers = {}; // Group dress/accessory by designer
            const inhouse = currentOrder.items.filter(i => i.type === 'inhouse');
            const fees = currentOrder.items.filter(i => i.type === 'fee');
            
            currentOrder.items.filter(i => i.type === 'dress' || i.type === 'accessory').forEach(item => {
                if (!designers[item.designer]) designers[item.designer] = [];
                designers[item.designer].push(item);
            });
            
            let html = '';
            
            // Designer items
            Object.keys(designers).forEach(designer => {
                html += `<div style="margin-bottom:12px">
                    <div style="font-size:9px;font-weight:600;color:var(--taupe);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">${designer}</div>`;
                designers[designer].forEach((item, idx) => {
                    const itemIdx = currentOrder.items.indexOf(item);
                    html += `<div class="order-item" style="flex-direction:column;align-items:stretch">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div class="order-item-info">
                                <div class="order-item-name">${item.type === 'dress' ? 'üëó' : '‚ú®'} ${item.name}</div>
                                <div class="order-item-meta">${item.size ? 'Size ' + item.size : ''}${item.color ? ' ¬∑ ' + item.color : ''}</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <div class="order-item-price">${money(item.price)}</div>
                                <button class="order-remove" onclick="removeOrderItem(${itemIdx})">√ó</button>
                            </div>
                        </div>`;
                    // Show customizations
                    if (item.customizations && item.customizations.length > 0) {
                        html += `<div style="margin-left:16px;margin-top:6px;padding-left:8px;border-left:2px solid var(--champagne)">`;
                        item.customizations.forEach((c, cidx) => {
                            html += `<div style="display:flex;justify-content:space-between;align-items:center;font-size:10px;padding:2px 0">
                                <span>üîß ${c.name} <span style="color:var(--taupe)">(${c.delivery === 'ondress' ? 'on dress' : 'separate'})</span></span>
                                <span style="display:flex;align-items:center;gap:6px">
                                    ${money(c.price)}
                                    <button onclick="removeCustomization('${item.id}', ${cidx})" style="background:none;border:none;color:#c00;cursor:pointer;font-size:12px">√ó</button>
                                </span>
                            </div>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
            });
            
            // In-house items
            if (inhouse.length > 0) {
                html += `<div style="margin-bottom:12px">
                    <div style="font-size:9px;font-weight:600;color:var(--taupe);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">üè† In-House</div>`;
                inhouse.forEach(item => {
                    const itemIdx = currentOrder.items.indexOf(item);
                    html += `<div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">${item.name}</div>
                            ${item.notes ? `<div class="order-item-meta" style="font-style:italic">${item.notes.substring(0, 50)}${item.notes.length > 50 ? '...' : ''}</div>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="order-item-price">${money(item.price)}</div>
                            <button class="order-remove" onclick="removeOrderItem(${itemIdx})">√ó</button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            
            // Fees
            if (fees.length > 0) {
                html += `<div style="margin-bottom:12px">
                    <div style="font-size:9px;font-weight:600;color:var(--taupe);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">üí∞ Fees</div>`;
                fees.forEach(item => {
                    const itemIdx = currentOrder.items.indexOf(item);
                    html += `<div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">${item.name}</div>
                            ${item.note ? `<div class="order-item-meta">${item.note}</div>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="order-item-price">${money(item.price)}</div>
                            <button class="order-remove" onclick="removeOrderItem(${itemIdx})">√ó</button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            
            $('orderItems').innerHTML = html || '<div class="empty">No items</div>';
            
            // Calculate totals including customizations
            let subtotal = 0;
            currentOrder.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(c => subtotal += c.price || 0);
                }
            });
            
            const addHst = $('addHst').checked;
            const hst = addHst ? Math.round(subtotal * 0.13 * 100) / 100 : 0;
            const total = subtotal + hst;
            
            currentOrder.hst = addHst;
            currentOrder.hstAmount = hst;
            currentOrder.subtotal = subtotal;
            currentOrder.total = total;
            
            if (addHst) {
                $('orderSubtotal').style.display = 'flex';
                $('orderSubtotal').innerHTML = `<span>Subtotal</span><span>${money(subtotal)}</span>`;
                $('orderSubtotal').style.justifyContent = 'space-between';
                $('orderHstRow').style.display = 'flex';
                $('orderHstRow').innerHTML = `<span>HST (13%)</span><span>${money(hst)}</span>`;
                $('orderHstRow').style.justifyContent = 'space-between';
            } else {
                $('orderSubtotal').style.display = 'none';
                $('orderHstRow').style.display = 'none';
            }
            
            $('orderTotal').textContent = money(total);
        }

        function genContract() {
            const c = currentClient;
            const o = currentOrder;
            
            // Calculate totals including customizations
            let subtotal = 0;
            o.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(c => subtotal += c.price || 0);
                }
            });
            
            const hst = o.hst ? Math.round(subtotal * 0.13 * 100) / 100 : 0;
            const total = subtotal + hst;
            const unit = measUnit;
            
            let hstRows = '';
            if (o.hst) {
                hstRows = `
                    <tr><td colspan="4" style="text-align:right">Subtotal</td><td>${money(subtotal)}</td></tr>
                    <tr><td colspan="4" style="text-align:right">HST (13%)</td><td>${money(hst)}</td></tr>
                `;
            }
            
            let customMeasRows = '';
            if (customMeasurements.length > 0) {
                customMeasRows = customMeasurements.map(m => 
                    `<tr><td>${m.name}</td><td>${m.value} ${m.unit}</td><td style="width:80px;border:1px solid #ccc"></td></tr>`
                ).join('');
            }
            
            // Build items table with new structure
            let itemsHtml = '';
            o.items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    const typeLabel = item.type === 'dress' ? 'üëó Dress' : '‚ú® Accessory';
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>${item.designer || '‚Äî'}</td>
                        <td>${item.size || '‚Äî'}${item.color ? ', ' + item.color : ''}</td>
                        <td>‚Äî</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                    // Add customizations as sub-items
                    if (item.customizations && item.customizations.length > 0) {
                        item.customizations.forEach(cust => {
                            itemsHtml += `<tr style="font-size:11px;color:var(--taupe)">
                                <td style="padding-left:20px">‚Ü≥ ${cust.name}</td>
                                <td>${item.designer}</td>
                                <td>${cust.delivery === 'ondress' ? 'On dress' : 'Separate'}</td>
                                <td>Customization</td>
                                <td>${money(cust.price)}</td>
                            </tr>`;
                        });
                    }
                } else if (item.type === 'inhouse') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>In-House</td>
                        <td>‚Äî</td>
                        <td>${item.notes ? item.notes.substring(0, 30) + '...' : '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                } else if (item.type === 'fee') {
                    itemsHtml += `<tr style="font-size:11px">
                        <td>${item.name}</td>
                        <td>‚Äî</td>
                        <td>‚Äî</td>
                        <td>${item.note || '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                }
            });
            
            $('contractPreview').innerHTML = `
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:24px;letter-spacing:0.15em;font-weight:600">ESTRELLE</div>
                    <div style="font-size:10px;letter-spacing:0.2em;color:var(--rose)">BRIDAL</div>
                </div>
                <h2 style="text-align:center;font-size:18px;margin-bottom:20px">SALES CONTRACT</h2>
                
                <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                    <h3 style="margin-top:0;font-size:12px">CUSTOMER INFORMATION</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
                        <div><b>Name:</b> ${c.FirstName} ${c.LastName}</div>
                        <div><b>Email:</b> ${c.Email || '‚Äî'}</div>
                        <div><b>Phone:</b> ${c.Phone || '‚Äî'}</div>
                        <div><b>Wedding Date:</b> ${fmtDate(c.WeddingDate)}</div>
                        <div><b>Venue:</b> ${c.Venue || '‚Äî'}</div>
                        <div><b>Contract Date:</b> ${fmtDate(today())}</div>
                    </div>
                </div>
                
                <h3>PARTIES</h3>
                <p>This Sales Contract (hereinafter referred to as the "Contract") is entered into on <b>${fmtDate(today())}</b> (the "Effective Date"), by and between Estrelle Bridal (ESTR INC.) with an address of 55 Avenue Road, #201.5, Toronto, Canada, M5R 3L2 (hereinafter referred to as the "Seller"), and <b>${c.FirstName} ${c.LastName}</b> (hereinafter referred to as the "Customer") (collectively referred to as the "Parties").</p>
                
                <h3>GOODS AND PRICE</h3>
                <p>The goods that the Seller is selling to the Customer are enlisted below with their quantities (hereinafter referred to as the "Goods").</p>
                <table><tr><th>Product</th><th>Designer/Source</th><th>Details</th><th>Notes</th><th>Price</th></tr>
                ${itemsHtml}
                ${hstRows}
                <tr><td colspan="4" style="text-align:right;font-weight:bold">TOTAL</td><td style="font-weight:bold">${money(total)}</td></tr></table>
                ${$('oiDetails').value ? `<p><b>Important ordering details:</b> ${$('oiDetails').value}</p>` : ''}
                
                <h3>MEASUREMENTS</h3>
                <table>
                    <tr><th>Item</th><th>Measurement</th><th style="width:80px">Client's Initial</th></tr>
                    <tr><td>Bust</td><td>${o.measurements.bust||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Waist</td><td>${o.measurements.waist||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Hip</td><td>${o.measurements.hip||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Height</td><td>${o.measurements.height||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Hollow to Hem</td><td>${o.measurements.hollow||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Heels</td><td>${o.measurements.heels||'‚Äî'}"</td><td style="border:1px solid #ccc"></td></tr>
                    ${customMeasRows}
                </table>
                ${o.measurements.notes ? `<p><b>Important measurement notes:</b> ${o.measurements.notes}</p>` : ''}
                
                <h3>PAYMENT TERMS</h3>
                <p>The Customer agrees to make an initial deposit of at least 50% of the total purchase price upon placing the order, which is non-refundable.</p>
                <p>The Seller will send a balance finalization request to the Buyer by the end of the production, and the Customer agrees to pay the remaining balance in full before shipment.</p>
                
                <h3>DELIVERY AND SHIPPING</h3>
                <p>The delivery of the goods (hereinafter referred to as the "Delivery") will be at Estrelle Bridal.</p>
                <p>The shipping method will be decided by the suppliers and Seller will be responsible for the costs of the shipment.</p>
                
                <h3>NO REFUNDS OR RETURNS</h3>
                <p>The Customer acknowledges that the wedding dress is made-to-order or customized to their specifications. Therefore, NO returns or refunds will be accepted after the order has been confirmed and production has started.</p>
                
                <h3>CANCELLATION OF ORDERS</h3>
                <p>The Customer who cancels their sales contract are NOT entitled to a refund of ANY monies paid up to and including the cancellation date. The Customer is required to make full payment as per the original order agreement, even in the event of order cancellation, costs will still be incurred to the suppliers and to the Seller regardless of any circumstance.</p>
                
                <h3>INSPECTION</h3>
                <p>Hereby, the Customer acknowledges that it has relied solely on the investigations, examinations, and inspections that the Customer has chosen to make and that the Seller has afforded the Customer the opportunity for full and complete investigations, examinations, and inspections.</p>
                
                <h3>RISK OF LOSS AND TITLE</h3>
                <p>The risk of loss or damage for the goods will be on the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                <p>The Title of the goods will also remain with the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                
                <h3>DELAY OR FAILURE TO PERFORM AND FORCE MAJEURE</h3>
                <p>Under no circumstances will the Seller be held liable to the Customer for any delay that may occur, non-delivery or an arising fault of this Agreement that may be due to any labour dispute, shortage in transportation, delay or shortage of materials to produce the Goods, fires, accidents, Acts of God, or any other causes outside Seller's control. The Seller will notify the Customer immediately upon realization that it will not be able to deliver the Goods as promised. Upon such notice, either Party may terminate this Agreement.</p>
                
                <h3>LIMITATION OF LIABILITY</h3>
                <p>Under no circumstances will the Seller be liable for any indirect, special, consequential, or punitive damages (including lost profits) arising out of or relating to this Agreement or the transactions it contemplates (whether for breach of contract, tort, negligence, or other form of action).</p>
                
                <h3>FIT & BODY SIZE CHANGES</h3>
                <p>The Customer acknowledges that the wedding dress is ordered based on measurements taken at the time of purchase. The Seller is not responsible for any changes in the Customer's body size or shape after the order is placed. Any significant fluctuations in weight or body measurements may affect the fit, potentially requiring substantial alterations at the Customer's expense, or, in some cases, resulting in the dress not fitting as intended. The Seller bears no liability for such outcomes.</p>
                
                <h3>ENTIRE AGREEMENT</h3>
                <p>This Agreement contains the entire agreement and understanding among the Parties hereto with respect to the subject matter hereof, and supersedes all prior agreements, understandings, inducements and conditions, express or implied, oral or written, of any nature whatsoever with respect to the subject matter hereof. The express terms hereof control and supersede any course of performance and/or usage of the trade inconsistent with any of the terms hereof.</p>
                
                <h3>FORCE MAJEURE</h3>
                <p>The Seller will not be liable for delays in performance or for non-performance due to unforeseen circumstances or causes beyond the Seller's reasonable control.</p>
            `;
        }

        let sigPadCustomer, sigPadConsultant, drawingCustomer = false, drawingConsultant = false;
        let measInitialsData = {};
        
        function initSig() {
            // Populate consultant dropdown
            $('yConsultantSelect').innerHTML = '<option value="">Select consultant... *</option>' + 
                data.consultants.map(c => `<option value="${c.ID}">${c.Name}</option>`).join('');
            $('consultantSigNote').textContent = 'Select consultant above to load signature';
            
            // Render measurement initials - core 3 get individual initials, rest grouped
            const o = currentOrder;
            const unit = o.measurements.unit || 'cm';
            
            // Core measurements - individual initials required
            const coreMeasurements = [
                { key: 'bust', label: 'Bust', value: o.measurements.bust, unit: unit },
                { key: 'waist', label: 'Waist', value: o.measurements.waist, unit: unit },
                { key: 'hip', label: 'Hip', value: o.measurements.hip, unit: unit }
            ];
            
            // Other measurements - grouped under one initial
            const otherMeasurements = [
                { key: 'height', label: 'Height', value: o.measurements.height, unit: unit },
                { key: 'hollow', label: 'Hollow to Hem', value: o.measurements.hollow, unit: unit },
                { key: 'heels', label: 'Heels', value: o.measurements.heels, unit: '"' }
            ];
            
            // Add custom measurements to others
            if (o.measurements.custom) {
                o.measurements.custom.forEach((m, i) => {
                    otherMeasurements.push({ key: 'custom_' + i, label: m.name, value: m.value, unit: m.unit });
                });
            }
            
            const otherWithValues = otherMeasurements.filter(m => m.value);
            
            let html = '<div style="font-size:10px;color:var(--rose);margin-bottom:8px">* Required initials</div>';
            
            // Core measurements with individual initials
            coreMeasurements.filter(m => m.value).forEach(m => {
                html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--champagne)">
                    <span style="font-size:12px;font-weight:500">${m.label}: ${m.value} ${m.unit}</span>
                    <input type="text" class="form-input" style="width:60px;padding:4px;text-align:center;font-size:12px;border:2px solid var(--dusty)" placeholder="Initial *" id="init_${m.key}" maxlength="4" required>
                </div>`;
            });
            
            // Other measurements grouped
            if (otherWithValues.length > 0) {
                html += `<div style="padding:8px 0;border-bottom:1px solid var(--champagne)">
                    <div style="font-size:10px;color:var(--taupe);margin-bottom:6px">Other Measurements:</div>
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <span style="font-size:11px">${otherWithValues.map(m => `${m.label}: ${m.value}${m.unit}`).join(', ')}</span>
                        <input type="text" class="form-input" style="width:60px;padding:4px;text-align:center;font-size:12px" placeholder="Initial" id="init_other" maxlength="4">
                    </div>
                </div>`;
            }
            
            $('measInitials').innerHTML = html;
            
            // Customer signature
            const canvas1 = $('sigPad');
            const ctx1 = canvas1.getContext('2d');
            ctx1.fillStyle = 'white';
            ctx1.fillRect(0, 0, canvas1.width, canvas1.height);
            ctx1.strokeStyle = '#2C2825';
            ctx1.lineWidth = 2;
            ctx1.lineCap = 'round';
            const getPos1 = e => { const r = canvas1.getBoundingClientRect(); return { x: ((e.clientX||e.touches?.[0]?.clientX) - r.left) * (canvas1.width/r.width), y: ((e.clientY||e.touches?.[0]?.clientY) - r.top) * (canvas1.height/r.height) }; };
            canvas1.onmousedown = canvas1.ontouchstart = e => { e.preventDefault(); drawingCustomer = true; canvas1.classList.add('active'); const p = getPos1(e); ctx1.beginPath(); ctx1.moveTo(p.x, p.y); };
            canvas1.onmousemove = canvas1.ontouchmove = e => { if (!drawingCustomer) return; e.preventDefault(); const p = getPos1(e); ctx1.lineTo(p.x, p.y); ctx1.stroke(); };
            canvas1.onmouseup = canvas1.ontouchend = canvas1.onmouseleave = () => { drawingCustomer = false; canvas1.classList.remove('active'); $('sigTime').textContent = new Date().toLocaleString(); };
            sigPadCustomer = { canvas: canvas1, ctx: ctx1 };
            
            // Consultant signature
            const canvas2 = $('sigPadConsultant');
            const ctx2 = canvas2.getContext('2d');
            ctx2.fillStyle = 'white';
            ctx2.fillRect(0, 0, canvas2.width, canvas2.height);
            ctx2.strokeStyle = '#2C2825';
            ctx2.lineWidth = 2;
            ctx2.lineCap = 'round';
            const getPos2 = e => { const r = canvas2.getBoundingClientRect(); return { x: ((e.clientX||e.touches?.[0]?.clientX) - r.left) * (canvas2.width/r.width), y: ((e.clientY||e.touches?.[0]?.clientY) - r.top) * (canvas2.height/r.height) }; };
            canvas2.onmousedown = canvas2.ontouchstart = e => { e.preventDefault(); drawingConsultant = true; canvas2.classList.add('active'); const p = getPos2(e); ctx2.beginPath(); ctx2.moveTo(p.x, p.y); };
            canvas2.onmousemove = canvas2.ontouchmove = e => { if (!drawingConsultant) return; e.preventDefault(); const p = getPos2(e); ctx2.lineTo(p.x, p.y); ctx2.stroke(); };
            canvas2.onmouseup = canvas2.ontouchend = canvas2.onmouseleave = () => { drawingConsultant = false; canvas2.classList.remove('active'); $('sigTimeConsultant').textContent = new Date().toLocaleString(); };
            sigPadConsultant = { canvas: canvas2, ctx: ctx2 };
        }
        
        function clearSig(type) {
            if (type === 'customer' && sigPadCustomer) {
                sigPadCustomer.ctx.fillStyle = 'white';
                sigPadCustomer.ctx.fillRect(0, 0, sigPadCustomer.canvas.width, sigPadCustomer.canvas.height);
                $('sigTime').textContent = '';
            } else if (type === 'consultant' && sigPadConsultant) {
                sigPadConsultant.ctx.fillStyle = 'white';
                sigPadConsultant.ctx.fillRect(0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                $('sigTimeConsultant').textContent = '';
            }
        }
        
        function collectInitials() {
            const initials = {};
            document.querySelectorAll('[id^="init_"]').forEach(el => {
                initials[el.id.replace('init_', '')] = el.value;
            });
            return initials;
        }

        async function completeOrder() {
            const c = currentClient;
            const o = currentOrder;
            
            // Calculate totals with new structure
            let subtotal = 0;
            o.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(cust => subtotal += cust.price || 0);
                }
            });
            
            const hst = o.hst ? Math.round(subtotal * 0.13 * 100) / 100 : 0;
            const total = subtotal + hst;
            const record = {
                ClientID: c.ID,
                OrderDate: today(),
                Status: 'ordered',
                Total: total,
                Subtotal: subtotal,
                HST: hst,
                Consultant: $('yConsultantSelect').value,
                Items: JSON.stringify(o.items),
                Measurements: JSON.stringify(o.measurements),
                SignatureTimestamp: new Date().toISOString()
            };
            try {
                await saveRecord('Orders', record);
                await updateRecord('Clients', c.ID, { Status: 'ordered', Measurements: JSON.stringify(o.measurements), LastVisit: today() });
                return true;
            } catch (e) { 
                console.error('Error saving order:', e);
                return false; 
            }
        }

        function prepareEmail() {
            const c = currentClient;
            const consultant = currentOrder.consultant || $('yConsultant').value || '';
            
            $('emailTo').value = c.Email || '';
            $('emailSubject').value = `Your Estrelle Bridal Contract ‚Äî ${c.FirstName} ${c.LastName}`;
            $('emailBody').value = `Hi ${c.FirstName},

Congratulations on finding your dream dress with us! We are so excited to be part of this special time.

Please find your signed sales contract attached. Feel free to reach out with any questions.

We would greatly appreciate it if you could take a moment to share your experience with us on [Google](https://g.page/r/CeGl9T2vSOuIEAE/review).

Your review means the world to us and helps future brides find their dream dress too.

With love,
${consultant}
Estrelle Bridal`;
        }

        function getContractHtml() {
            const c = currentClient;
            const o = currentOrder;
            
            // Calculate totals with new structure
            let subtotal = 0;
            o.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(cust => subtotal += cust.price || 0);
                }
            });
            
            const hst = o.hst ? Math.round(subtotal * 0.13 * 100) / 100 : 0;
            const total = subtotal + hst;
            const unit = o.measurements.unit || 'in';
            const initials = o.initials || {};
            
            let hstRows = '';
            if (o.hst) {
                hstRows = `
                    <tr><td colspan="4" style="text-align:right">Subtotal</td><td>${money(subtotal)}</td></tr>
                    <tr><td colspan="4" style="text-align:right">HST (13%)</td><td>${money(hst)}</td></tr>
                `;
            }
            
            // Build items HTML with new structure
            let itemsHtml = '';
            o.items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>${item.designer || '‚Äî'}</td>
                        <td>${item.size || '‚Äî'}${item.color ? ', ' + item.color : ''}</td>
                        <td>‚Äî</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                    if (item.customizations && item.customizations.length > 0) {
                        item.customizations.forEach(cust => {
                            itemsHtml += `<tr style="font-size:10px;color:#666">
                                <td style="padding-left:15px">‚Ü≥ ${cust.name}</td>
                                <td>${item.designer}</td>
                                <td>${cust.delivery === 'ondress' ? 'On dress' : 'Separate'}</td>
                                <td>Customization</td>
                                <td>${money(cust.price)}</td>
                            </tr>`;
                        });
                    }
                } else if (item.type === 'inhouse') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>In-House</td>
                        <td>‚Äî</td>
                        <td>${item.notes ? item.notes.substring(0, 30) : '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                } else if (item.type === 'fee') {
                    itemsHtml += `<tr style="font-size:10px">
                        <td>${item.name}</td>
                        <td>‚Äî</td>
                        <td>‚Äî</td>
                        <td>${item.note || '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                }
            });
            
            // Build measurements with initials - core 3 have individual, others grouped
            const coreMeas = [
                { key: 'bust', label: 'Bust', value: o.measurements.bust, u: unit },
                { key: 'waist', label: 'Waist', value: o.measurements.waist, u: unit },
                { key: 'hip', label: 'Hip', value: o.measurements.hip, u: unit }
            ];
            
            const otherMeas = [
                { key: 'height', label: 'Height', value: o.measurements.height, u: unit },
                { key: 'hollow', label: 'Hollow to Hem', value: o.measurements.hollow, u: unit },
                { key: 'heels', label: 'Heels', value: o.measurements.heels, u: '"' }
            ];
            
            if (o.measurements.custom) {
                o.measurements.custom.forEach((m, i) => {
                    otherMeas.push({ key: 'custom_' + i, label: m.name, value: m.value, u: m.unit });
                });
            }
            
            const coreRows = coreMeas.filter(m => m.value).map(m => 
                `<tr><td>${m.label}</td><td>${m.value} ${m.u}</td><td style="text-align:center;font-weight:bold">${initials[m.key] || ''}</td></tr>`
            ).join('');
            
            const otherWithValues = otherMeas.filter(m => m.value);
            let otherRow = '';
            if (otherWithValues.length > 0) {
                otherRow = `<tr><td>Other</td><td>${otherWithValues.map(m => `${m.label}: ${m.value}${m.u}`).join(', ')}</td><td style="text-align:center;font-weight:bold">${initials['other'] || ''}</td></tr>`;
            }
            
            return `
                <h1 style="text-align:center;font-size:16px;">SALES CONTRACT</h1>
                
                <div style="background:#f9f7f5;padding:10px;border-radius:4px;margin-bottom:15px">
                    <h2 style="margin:0 0 8px 0;font-size:11px">CUSTOMER INFORMATION</h2>
                    <table style="border:none;font-size:10px">
                        <tr><td style="border:none;padding:2px"><b>Name:</b> ${c.FirstName} ${c.LastName}</td><td style="border:none;padding:2px"><b>Email:</b> ${c.Email || '‚Äî'}</td></tr>
                        <tr><td style="border:none;padding:2px"><b>Phone:</b> ${c.Phone || '‚Äî'}</td><td style="border:none;padding:2px"><b>Wedding Date:</b> ${fmtDate(c.WeddingDate)}</td></tr>
                        <tr><td style="border:none;padding:2px"><b>Venue:</b> ${c.Venue || '‚Äî'}</td><td style="border:none;padding:2px"><b>Contract Date:</b> ${fmtDate(today())}</td></tr>
                    </table>
                </div>
                
                <h2>PARTIES</h2>
                <p>This Sales Contract (hereinafter referred to as the "Contract") is entered into on <b>${fmtDate(today())}</b> (the "Effective Date"), by and between Estrelle Bridal (ESTR INC.) with an address of 55 Avenue Road, #201.5, Toronto, Canada, M5R 3L2 (hereinafter referred to as the "Seller"), and <b>${c.FirstName} ${c.LastName}</b> (hereinafter referred to as the "Customer") (collectively referred to as the "Parties").</p>
                
                <h2>GOODS AND PRICE</h2>
                <p>The goods that the Seller is selling to the Customer are enlisted below (hereinafter referred to as the "Goods").</p>
                <table>
                    <tr><th>Product</th><th>Designer/Source</th><th>Details</th><th>Notes</th><th>Price</th></tr>
                    ${itemsHtml}
                    ${hstRows}
                    <tr><td colspan="4" style="text-align:right;font-weight:bold">TOTAL</td><td style="font-weight:bold">${money(total)}</td></tr>
                </table>
                ${$('oiDetails').value ? `<p><b>Important ordering details:</b> ${$('oiDetails').value}</p>` : ''}
                
                <h2>MEASUREMENTS</h2>
                <table>
                    <tr><th>Item</th><th>Measurement</th><th>Client's Initial</th></tr>
                    ${coreRows}
                    ${otherRow}
                </table>
                ${o.measurements.notes ? `<p><b>Important measurement notes:</b> ${o.measurements.notes}</p>` : ''}
                
                <h2>PAYMENT TERMS</h2>
                <p>The Customer agrees to make an initial deposit of at least 50% of the total purchase price upon placing the order, which is non-refundable.</p>
                <p>The Seller will send a balance finalization request to the Buyer by the end of the production, and the Customer agrees to pay the remaining balance in full before shipment.</p>
                
                <h2>DELIVERY AND SHIPPING</h2>
                <p>The delivery of the goods (hereinafter referred to as the "Delivery") will be at Estrelle Bridal.</p>
                <p>The shipping method will be decided by the suppliers and Seller will be responsible for the costs of the shipment.</p>
                
                <h2>NO REFUNDS OR RETURNS</h2>
                <p>The Customer acknowledges that the wedding dress is made-to-order or customized to their specifications. Therefore, NO returns or refunds will be accepted after the order has been confirmed and production has started.</p>
                
                <h2>CANCELLATION OF ORDERS</h2>
                <p>The Customer who cancels their sales contract are NOT entitled to a refund of ANY monies paid up to and including the cancellation date. The Customer is required to make full payment as per the original order agreement, even in the event of order cancellation, costs will still be incurred to the suppliers and to the Seller regardless of any circumstance.</p>
                
                <h2>INSPECTION</h2>
                <p>Hereby, the Customer acknowledges that it has relied solely on the investigations, examinations, and inspections that the Customer has chosen to make and that the Seller has afforded the Customer the opportunity for full and complete investigations, examinations, and inspections.</p>
                
                <h2>RISK OF LOSS AND TITLE</h2>
                <p>The risk of loss or damage for the goods will be on the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                <p>The Title of the goods will also remain with the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                
                <h2>DELAY OR FAILURE TO PERFORM AND FORCE MAJEURE</h2>
                <p>Under no circumstances will the Seller be held liable to the Customer for any delay that may occur, non-delivery or an arising fault of this Agreement that may be due to any labour dispute, shortage in transportation, delay or shortage of materials to produce the Goods, fires, accidents, Acts of God, or any other causes outside Seller's control. The Seller will notify the Customer immediately upon realization that it will not be able to deliver the Goods as promised. Upon such notice, either Party may terminate this Agreement.</p>
                
                <h2>LIMITATION OF LIABILITY</h2>
                <p>Under no circumstances will the Seller be liable for any indirect, special, consequential, or punitive damages (including lost profits) arising out of or relating to this Agreement or the transactions it contemplates (whether for breach of contract, tort, negligence, or other form of action).</p>
                
                <h2>FIT & BODY SIZE CHANGES</h2>
                <p>The Customer acknowledges that the wedding dress is ordered based on measurements taken at the time of purchase. The Seller is not responsible for any changes in the Customer's body size or shape after the order is placed. Any significant fluctuations in weight or body measurements may affect the fit, potentially requiring substantial alterations at the Customer's expense, or, in some cases, resulting in the dress not fitting as intended. The Seller bears no liability for such outcomes.</p>
                
                <h2>ENTIRE AGREEMENT</h2>
                <p>This Agreement contains the entire agreement and understanding among the Parties hereto with respect to the subject matter hereof, and supersedes all prior agreements, understandings, inducements and conditions, express or implied, oral or written, of any nature whatsoever with respect to the subject matter hereof. The express terms hereof control and supersede any course of performance and/or usage of the trade inconsistent with any of the terms hereof.</p>
                
                <h2>FORCE MAJEURE</h2>
                <p>The Seller will not be liable for delays in performance or for non-performance due to unforeseen circumstances or causes beyond the Seller's reasonable control.</p>
            `;
        }

        async function sendContractEmail() {
            const c = currentClient;
            const brideEmail = $('emailTo').value;
            
            if (!brideEmail) {
                toast('No email address for this client', 'error');
                return;
            }
            
            // Save order first
            await completeOrder();
            
            // Delete draft since order is complete
            deleteDraft(c.ID);
            $('draftIndicator').style.display = 'none';
            
            // Close modal immediately for better UX
            closeModal('yes');
            toast('Order saved! Sending email...', 'success');
            
            // Prepare signature data
            let sigData = currentOrder.signatureData;
            let consultantSigData = currentOrder.consultantSignatureData;
            
            // Skip if signatures too large
            if (sigData && sigData.length > 500000) sigData = null;
            if (consultantSigData && consultantSigData.length > 500000) consultantSigData = null;
            
            // Send email in background
            const contractData = {
                brideName: `${c.FirstName} ${c.LastName}`,
                brideEmail: brideEmail,
                consultantName: currentOrder.consultant || '',
                subject: $('emailSubject').value,
                body: $('emailBody').value,
                contractHtml: getContractHtml(),
                signatureData: sigData,
                consultantSignatureData: consultantSigData,
                weddingDate: c.WeddingDate ? fmtDate(c.WeddingDate) : '',
                phone: c.Phone || ''
            };
            
            // Fire and forget - send in background
            api('POST', { action: 'sendContract', contractData })
                .then(() => toast('Email sent to ' + brideEmail, 'success'))
                .catch(e => toast('Email failed: ' + (e.message || 'Unknown error'), 'error'));
        }

        // ========== INIT ==========
        document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', () => { if (n.dataset.page) showPage(n.dataset.page); }));
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));
        // Init: load cached data immediately, then fetch fresh data in background
        loadCachedData();
        loadData();
        setInterval(loadData, 30000); // Auto-refresh every 30 seconds
    </script>
</body>
</html>
