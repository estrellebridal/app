<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estrelle Bridal</title>
    
    <!-- PWA / Add to Home Screen -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Estrelle">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#9B8B7D">
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #faf8f6;
            --card: #ffffff;
            --text: #2c2825;
            --text-secondary: #8a837a;
            --border: #eae6e1;
            --accent: #a68b6a;
            --accent-light: rgba(166, 139, 106, 0.08);
            --accent-medium: rgba(166, 139, 106, 0.15);
            --rose: #d4b5b0;
            --sage: #9fb396;
            --honey: #d4a855;
            --red: #c07070;
            --blue: #7a9bc0;
            /* Legacy mappings */
            --cream: #faf8f6; --white: #ffffff; --champagne: #eae6e1;
            --taupe: #8a837a; --charcoal: #2c2825; --blush: rgba(166, 139, 106, 0.08);
            --dusty: #d4b5b0; --gold: #d4a855;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.5; }
        .app { display: flex; min-height: 100vh; }

        /* Sidebar - Option 6 Style */
        .sidebar { width: 240px; background: var(--card); border-right: 1px solid var(--border); padding: 28px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; overflow-y: auto; }
        .logo { display: flex; align-items: center; gap: 12px; padding: 0 12px 32px; cursor: pointer; flex-shrink: 0; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent) 0%, #8a7356 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 16px; }
        .logo-text { font-size: 18px; font-weight: 700; color: var(--text); letter-spacing: -0.3px; }
        .nav { flex: 1; padding: 0; }
        .nav-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-secondary); padding: 0 14px; margin: 20px 0 8px; font-weight: 600; }
        .nav-item { display: flex; align-items: center; gap: 14px; padding: 13px 14px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; transition: all 0.2s ease; }
        .nav-item:hover { color: var(--text); background: var(--accent-light); }
        .nav-item.active { color: var(--accent); background: var(--accent-medium); }
        .nav-item svg { width: 20px; height: 20px; stroke-width: 1.75; }
        .sync-status { padding: 16px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-secondary); }
        .sync-status.syncing { color: var(--honey); }
        .sync-status.error { color: var(--red); }

        /* Main Content */
        .main { flex: 1; margin-left: 240px; padding: 36px 44px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; }
        .greeting { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .title { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; }
        .subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

        /* Buttons - Option 6 Style */
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 22px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #8a7356 100%); color: white; box-shadow: 0 4px 14px rgba(166, 139, 106, 0.25); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(166, 139, 106, 0.35); }
        .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
        .btn-success { background: linear-gradient(135deg, var(--sage) 0%, #8a9f82 100%); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 12px; border-radius: 8px; }
        .btn-icon { padding: 8px; min-width: 34px; justify-content: center; border-radius: 8px; }

        /* Cards - Option 6 Style */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 22px; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 8px; }

        /* Stats - Option 6 Style */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
        .stat { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 22px; transition: all 0.2s ease; }
        .stat:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.06); }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 14px; }
        .stat-icon.today { background: var(--accent-medium); }
        .stat-icon.week { background: rgba(212, 181, 176, 0.2); }
        .stat-icon.pending { background: rgba(212, 168, 85, 0.15); }
        .stat-icon.clients { background: rgba(159, 179, 150, 0.2); }
        .stat-label { font-size: 11px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px; font-weight: 500; }
        .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; }

        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .grid-main { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }

        /* List Items - Option 6 Style */
        .list-item { display: flex; align-items: center; gap: 14px; padding: 14px; border-radius: 10px; cursor: pointer; transition: all 0.15s ease; }
        .list-item:hover { background: var(--accent-light); }
        .avatar { width: 42px; height: 42px; border-radius: 12px; background: linear-gradient(135deg, var(--rose) 0%, #c9a5a0 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; flex-shrink: 0; }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 14px; }
        .item-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        /* Badges - Option 6 Style */
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-accent { background: var(--accent-medium); color: var(--accent); }
        .badge-warning { background: rgba(212, 168, 85, 0.15); color: #b8860b; }
        .badge-success { background: rgba(159, 179, 150, 0.2); color: #5a7a52; }
        .badge-danger { background: rgba(180, 100, 100, 0.12); color: #a05050; }
        .status { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
        .status-new { background: var(--accent-light); color: var(--accent); }
        .status-consultation { background: rgba(212, 168, 85, 0.12); color: var(--honey); }
        .status-ordered { background: rgba(159, 179, 150, 0.15); color: var(--sage); }
        .status-fitting { background: rgba(122, 155, 192, 0.12); color: var(--blue); }
        .status-complete { background: var(--text); color: white; }
        .status-active { background: rgba(159, 179, 150, 0.2); color: #5a7a52; }
        .status-pending { background: rgba(212, 168, 85, 0.15); color: #b8860b; }

        /* Status Dots */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: -6px; flex-shrink: 0; }
        .status-danger { background: var(--red); }
        .status-warning { background: var(--honey); }

        /* Row backgrounds */
        .overdue { background: rgba(192, 112, 112, 0.06); }
        .due-today { background: rgba(212, 168, 85, 0.06); }

        /* Time display */
        .time { font-size: 13px; color: var(--accent); font-weight: 600; min-width: 50px; }

        /* Action buttons */
        .actions { display: flex; gap: 6px; }
        .btn-icon { width: 34px; height: 34px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.15s ease; }
        .btn-icon:hover { background: var(--accent); border-color: var(--accent); color: white; }

        /* Forms - Updated */
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 11px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; }
        .form-input { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; font-family: inherit; background: var(--bg); transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--accent); background: var(--card); }
        textarea.form-input { min-height: 80px; resize: vertical; }
        .rich-text-editor { border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; background: var(--bg); }
        .rich-text-editor:focus { outline: none; border-color: var(--accent); background: var(--card); }
        .rich-text-editor b, .rich-text-editor strong { font-weight: 700; }
        .rich-text-editor i, .rich-text-editor em { font-style: italic; }
        .rich-text-editor u { text-decoration: underline; }
        .email-toolbar button { min-width: 32px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

        /* Modals - Updated */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(44,40,37,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--card); border-radius: 16px; width: 100%; max-width: 520px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .modal.wide { max-width: 800px; }
        .modal.full { max-width: 95vw; max-height: 92vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--card); z-index: 10; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: var(--bg); cursor: pointer; font-size: 16px; transition: all 0.15s; }
        .modal-close:hover { background: var(--accent-light); }
        .modal-body { padding: 20px 24px; max-height: calc(100vh - 180px); overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 24px; border-top: 1px solid var(--border); background: var(--bg); position: sticky; bottom: 0; }

        /* Tables - Updated */
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px 14px; font-size: 11px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-secondary); border-bottom: 1px solid var(--border); font-weight: 600; }
        .table td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .table tr:hover { background: var(--accent-light); cursor: pointer; }

        /* Rush badges */
        .rush-badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .rush-badge.ok { background: rgba(159, 179, 150, 0.15); color: var(--sage); }
        .rush-badge.warn { background: rgba(212, 168, 85, 0.15); color: var(--honey); }
        .rush-badge.high { background: rgba(192, 112, 112, 0.12); color: var(--red); }
        .rush-badge.confirm { background: var(--accent-light); color: var(--accent); }

        /* Timeline box */
        .timeline-box { background: var(--accent-light); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .timeline-header { margin-bottom: 10px; }
        .timeline-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .timeline-months { font-size: 32px; font-weight: 700; color: var(--text); letter-spacing: -1px; }
        .timeline-detail { font-size: 12px; color: var(--text-secondary); }

        .rush-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rush-table th { text-align: left; padding: 10px 12px; background: var(--bg); font-size: 10px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; }
        .rush-table td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: top; }

        /* Appointment items */
        .appt-item { background: var(--bg); border-radius: 10px; padding: 14px; margin-bottom: 8px; }
        .appt-date { font-weight: 600; font-size: 14px; }
        .appt-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .appt-notes { font-size: 13px; margin-top: 6px; color: var(--text-secondary); }
        .appt-actions { display: flex; gap: 6px; margin-top: 10px; }
        .appt-type-consultation, .appt-type-bridal-consultation { border-left: 4px solid var(--accent); }
        .appt-type-fitting { border-left: 4px solid var(--blue); }
        .appt-type-final-fitting { border-left: 4px solid #9b59b6; }
        .appt-type-pickup { border-left: 4px solid var(--sage); }
        .appt-type-measurement { border-left: 4px solid var(--honey); }

        /* Option cards */
        .option-card { background: var(--bg); border-radius: 10px; padding: 14px; margin-bottom: 10px; border-left: 4px solid var(--sage); }
        .option-card.favorite { border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.05); }
        .placeholder-chip { display: inline-flex; align-items: center; gap: 2px; padding: 4px 10px; background: var(--blush); border: 1px solid var(--champagne); border-radius: 20px; font-size: 10px; font-weight: 500; color: var(--accent); cursor: pointer; transition: all 0.15s; user-select: none; }
        .placeholder-chip:hover { background: var(--accent-light); border-color: var(--accent); transform: scale(1.03); }
        .placeholder-chip:active { transform: scale(0.97); }
        .option-designer { font-weight: 600; font-size: 14px; }
        .option-style { font-size: 13px; color: var(--text-secondary); }
        .option-notes { font-size: 12px; margin-top: 6px; color: var(--text-secondary); }
        .option-actions { display: flex; gap: 6px; margin-top: 10px; }
        .action-btn.liked { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }

        /* Order items */
        .order-item { display: flex; gap: 12px; padding: 12px; background: var(--bg); border-radius: 10px; margin-bottom: 8px; align-items: center; }
        .order-item-info { flex: 1; }
        .order-item-name { font-weight: 600; font-size: 14px; }
        .order-item-meta { font-size: 12px; color: var(--text-secondary); }
        .order-item-price { font-weight: 700; font-size: 14px; }
        .order-remove { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 16px; padding: 6px; }

        .order-total { display: flex; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, var(--accent) 0%, #8a7356 100%); color: white; border-radius: 10px; margin-top: 12px; }
        .order-total-value { font-size: 24px; font-weight: 700; }

        /* Steps */
        .steps { display: flex; margin-bottom: 20px; }
        .step { flex: 1; text-align: center; padding: 10px; position: relative; }
        .step::after, .step::before { content: ''; position: absolute; top: 50%; height: 2px; background: var(--border); width: 50%; }
        .step::after { right: 0; }
        .step::before { left: 0; }
        .step:first-child::before, .step:last-child::after { display: none; }
        .step-num { width: 28px; height: 28px; border-radius: 50%; background: var(--border); display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; position: relative; z-index: 1; }
        .step.active .step-num { background: var(--accent); color: white; }
        .step.done .step-num { background: var(--sage); color: white; }
        .step-label { font-size: 10px; color: var(--text-secondary); margin-top: 6px; }
        .step.active .step-label { color: var(--text); font-weight: 600; }

        /* Measurements */
        .meas-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .meas-item { text-align: center; padding: 14px; background: var(--bg); border-radius: 10px; }
        .meas-label { font-size: 9px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; }
        .meas-input { width: 70px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; text-align: center; }
        .meas-unit { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }

        /* Signature pad */
        .sig-pad { border: 2px dashed var(--border); border-radius: 10px; background: white; cursor: crosshair; touch-action: none; width: 100%; }
        .sig-pad.active { border-color: var(--accent); }

        /* Contract */
        .contract { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 20px; max-height: 300px; overflow-y: auto; font-size: 12px; line-height: 1.6; }
        .contract h2 { font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 16px; }
        .contract h3 { font-size: 12px; font-weight: 600; margin: 16px 0 6px; text-decoration: underline; }
        .contract table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .contract th, .contract td { border: 1px solid var(--border); padding: 6px 8px; text-align: left; font-size: 11px; }

        /* Toast - Updated */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 20px; background: var(--text); color: white; border-radius: 10px; font-size: 13px; font-weight: 500; transform: translateY(80px); opacity: 0; transition: all 0.3s; z-index: 2000; box-shadow: 0 8px 24px rgba(0,0,0,0.15); max-width: calc(100vw - 48px); }
        @media (max-width: 900px) { .toast { bottom: 82px; right: 12px; left: 12px; text-align: center; } }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: linear-gradient(135deg, var(--sage) 0%, #8a9f82 100%); }
        .toast.error { background: linear-gradient(135deg, var(--red) 0%, #a05858 100%); }

        /* Search */
        .search { position: relative; margin-bottom: 16px; }
        .search input { width: 100%; padding: 12px 14px 12px 40px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--bg); }
        .search svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-secondary); }

        .section { display: none; }
        .section.active { display: block; }

        /* Consultation header */
        .consult-header { background: linear-gradient(135deg, var(--accent-light), var(--bg)); padding: 20px 24px; border-radius: 14px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .consult-client { display: flex; align-items: center; gap: 14px; }
        .consult-avatar { width: 52px; height: 52px; border-radius: 14px; background: linear-gradient(135deg, var(--rose), var(--dusty)); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600; color: white; }
        .consult-name { font-size: 22px; font-weight: 700; }
        .consult-meta { font-size: 13px; color: var(--text-secondary); }

        /* Loading & Empty */
        .loading { display: flex; align-items: center; justify-content: center; padding: 50px; color: var(--text-secondary); }
        .loading::after { content: ''; width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; margin-left: 12px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 40px; color: var(--text-secondary); font-size: 13px; }

        .action-btn { padding: 6px 10px; border: 1px solid var(--border); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 500; }
        
        /* Mobile/Desktop action toggle */
        .appt-mobile-actions { display: none; }
        .appt-desktop-actions { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
        .mobile-more-btn { display: none; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        .action-btn:hover { background: var(--accent-light); border-color: var(--accent); }

        /* Pull to refresh - hidden on desktop, visible on mobile */
        .pull-indicator { 
            position: fixed; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%) translateY(-60px); 
            background: var(--accent); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 0 0 20px 20px; 
            font-size: 13px; 
            font-weight: 500;
            z-index: 9999; 
            transition: transform 0.2s ease;
            display: none;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        .pull-indicator.visible { transform: translateX(-50%) translateY(0); }
        .pull-indicator.refreshing { background: var(--sage); }
        .pull-spinner { 
            width: 16px; height: 16px; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-top-color: white; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .sidebar { 
                width: 100%; 
                height: 70px;
                position: fixed;
                bottom: 0;
                top: auto;
                left: 0;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--border);
                z-index: 1000;
                padding: 0;
                background: var(--card);
            }
            .sidebar .logo { display: none; }
            .sidebar .nav { 
                display: flex; 
                flex-direction: row; 
                padding: 0; 
                width: 100%;
                justify-content: space-around;
                align-items: center;
                height: 100%;
                gap: 0;
            }
            .sidebar .nav-item { 
                flex-direction: column; 
                padding: 8px 4px; 
                font-size: 9px;
                flex: 1;
                text-align: center;
                gap: 2px;
                border-radius: 0;
                min-width: 0;
            }
            .sidebar .nav-item span { display: block; font-size: 9px; }
            .sidebar .nav-item svg { width: 20px; height: 20px; }
            .sidebar .nav-label { display: none; }
            .sidebar .sync-status { display: none; }
            .main { 
                margin-left: 0; 
                margin-bottom: 80px;
                padding: 16px; 
            }
            .stats { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat { padding: 16px; }
            .stat-value { font-size: 24px; }
            .grid-main, .grid-2 { grid-template-columns: 1fr; }
            .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
            
            .header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .header > div:last-child { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; }
            .title { font-size: 22px; }
            
            .btn { padding: 12px 16px; font-size: 13px; }
            .btn-sm { padding: 10px 14px; font-size: 12px; }
            .action-btn { padding: 8px 12px; font-size: 12px; }
            
            .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .table { min-width: 600px; }
            .table th, .table td { padding: 10px 8px; font-size: 12px; }
            
            .card-body { padding: 12px; }
            .card-header { padding: 14px; }
            
            /* Pull to refresh - show on mobile */
            .pull-indicator { display: flex; }

            .modal { 
                width: 95%; 
                max-width: none; 
                max-height: 90vh; 
                margin: 5vh auto;
            }
            .modal.full { width: 100%; height: 100%; max-height: 100%; margin: 0; border-radius: 0; }
            .modal-body { padding: 16px; max-height: calc(100vh - 150px); overflow-y: auto; }
            
            .form-input { padding: 12px; font-size: 16px; }
            .form-row { display: flex; flex-direction: column; gap: 12px; }
            .form-row > .form-group { width: 100%; }
            
            /* Fix modal content spacing */
            #newClientFields, #newClientFields + div {
                margin-bottom: 16px !important;
            }
            #newClientFields .form-row {
                margin-bottom: 12px;
            }
            
            /* Simplify appointment actions on mobile */
            .appt-actions {
                gap: 2px !important;
            }
            .appt-actions .action-btn {
                padding: 6px 8px !important;
                font-size: 11px !important;
            }
            .appt-actions .confirm-btns {
                display: none !important;
            }
            .appt-actions .mobile-more-btn {
                display: inline-flex !important;
            }
            .appt-mobile-actions {
                display: flex !important;
            }
            .appt-desktop-actions {
                display: none !important;
            }
            
            .consult-header { padding: 16px; flex-direction: column; align-items: flex-start; }
            .consult-header.sticky { position: relative; margin: 0 0 16px 0; }
            .consult-client { width: 100%; margin-bottom: 12px; }
            .consult-name { font-size: 20px; }
            
            .floating-back { left: 16px; bottom: 90px; }
            
            .list-item { padding: 14px 10px; flex-wrap: wrap; }
            .list-item .avatar { width: 40px; height: 40px; font-size: 13px; }
            
            .appt-item { padding: 12px; }
            .appt-actions { margin-top: 10px; }
            
            .steps { overflow-x: auto; }
            .step { min-width: 70px; }
            .step-label { font-size: 9px; }
            
            .meas-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .sidebar .nav-item { padding: 6px 2px; }
            .sidebar .nav-item span { font-size: 8px; }
            .sidebar .nav-item svg { width: 18px; height: 18px; }
            .stats { grid-template-columns: 1fr 1fr; }
            .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .meas-grid { grid-template-columns: 1fr 1fr; }
        }
        
        /* Mobile: Schedule week view - compact buttons */
        @media (max-width: 900px) {
            .schedule-appt-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }
            .schedule-appt-row > div:last-child {
                width: 100%;
                justify-content: flex-start !important;
                flex-wrap: wrap;
            }
            .schedule-appt-row .btn {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
            .schedule-appt-row .confirm-btns {
                display: none !important;
            }
        }
        
        /* Mobile: Compact stat cards for Orders and Reporting */
        @media (max-width: 900px) {
            .orders-stats, .reporting-stats {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                margin-bottom: 16px !important;
            }
            .orders-stats .stat, .reporting-stats .stat {
                padding: 12px !important;
                min-height: auto !important;
            }
            .orders-stats .stat-value, .reporting-stats .stat-value {
                font-size: 20px !important;
            }
            .orders-stats .stat-label, .reporting-stats .stat-label {
                font-size: 10px !important;
            }
            .orders-stats .stat-icon, .reporting-stats .stat-icon {
                display: none !important;
            }
        }
        
        @media (max-width: 480px) {
            .orders-stats .stat, .reporting-stats .stat {
                padding: 10px !important;
            }
            .orders-stats .stat-value, .reporting-stats .stat-value {
                font-size: 18px !important;
            }
        }
        
        /* Floating back button */
        .floating-back {
            position: fixed;
            bottom: 24px;
            left: 260px;
            width: 52px;
            height: 52px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent) 0%, #8a7356 100%);
            color: white;
            border: none;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(166, 139, 106, 0.35);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .floating-back:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 28px rgba(166, 139, 106, 0.45);
        }
        .floating-back.visible {
            display: flex;
        }
        @media (max-width: 900px) {
            .floating-back { left: 16px; bottom: 90px; }
        }
        
        /* Settings expandable sections */
        .settings-card .card-header {
            transition: background 0.2s;
        }
        .settings-card .card-header:hover {
            background: var(--accent-light);
        }
        .settings-toggle {
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }
        .settings-content {
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Announcements */
        .announcement {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
            border: 1px solid #f0e6c8;
            border-radius: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        .announcement.pinned {
            background: linear-gradient(135deg, #e8f4f8 0%, #d8eef5 100%);
            border-color: #c0dde8;
        }
        .announcement.urgent {
            background: linear-gradient(135deg, #fef2f2 0%, #fee8e8 100%);
            border-color: #f5c8c8;
        }
        .announcement-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        .announcement-content {
            flex: 1;
            min-width: 0;
        }
        .announcement-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        .announcement-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .announcement-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        .announcement-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .announcement-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .announcement-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .add-announcement-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .add-announcement-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-light);
        }
        
        /* Confirmation button group - consistent styling */
        .confirm-btns {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }
        .confirm-btns .btn-done {
            background: var(--sage);
            color: white;
            border: none;
        }
        .confirm-btns .btn-done:hover {
            background: #8aa382;
        }
        .confirm-btns .btn-email {
            background: var(--accent);
            color: white;
            border: none;
        }
        .confirm-btns .btn-email:hover {
            background: #96795a;
        }
        .confirm-btns .btn-confirmed {
            background: #d4edda;
            color: #155724;
            border: none;
            cursor: default;
        }
        .confirmed-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #d4edda;
            color: #155724;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }
        .clickable {
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .clickable:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        /* Action Sheet (mobile) */
        .action-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .action-sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .action-sheet {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 16px 16px 0 0;
            padding: 8px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        .action-sheet-overlay.active .action-sheet {
            transform: translateY(0);
        }
        .action-sheet-items {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .action-sheet-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            cursor: pointer;
            text-align: left;
            transition: background 0.15s;
        }
        .action-sheet-item:hover {
            background: var(--cream);
        }
        .action-sheet-item.danger {
            color: #dc3545;
        }
        .action-sheet-cancel {
            width: 100%;
            padding: 16px;
            margin-top: 8px;
            background: var(--bg);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Custom Select Dropdown */
        .custom-select {
            position: relative;
            width: 100%;
        }
        .custom-select-trigger {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            transition: all 0.2s;
            color: var(--text);
            user-select: none;
        }
        .custom-select-trigger:hover {
            border-color: var(--accent);
        }
        .custom-select-trigger.open {
            border-color: var(--accent);
            background: var(--card);
            border-radius: 10px 10px 0 0;
        }
        .custom-select-trigger .trigger-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .custom-select-trigger .trigger-arrow {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .custom-select-trigger.open .trigger-arrow {
            transform: rotate(180deg);
        }
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--accent);
            border-top: none;
            border-radius: 0 0 10px 10px;
            z-index: 200;
            max-height: 240px;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            display: none;
        }
        .custom-select-options.open {
            display: block;
            animation: customSelectFade 0.15s ease-out;
        }
        @keyframes customSelectFade {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-select-option {
            padding: 11px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: background 0.1s;
            border-bottom: 1px solid var(--border);
        }
        .custom-select-option:last-child {
            border-bottom: none;
        }
        .custom-select-option:hover {
            background: var(--accent-light);
        }
        .custom-select-option.selected {
            background: var(--accent-medium);
            color: var(--accent);
            font-weight: 600;
        }
        .custom-select-option .option-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .custom-select-option .option-check {
            width: 16px;
            height: 16px;
            margin-left: auto;
            opacity: 0;
            color: var(--accent);
            flex-shrink: 0;
        }
        .custom-select-option.selected .option-check {
            opacity: 1;
        }
        /* Hide the native select when custom is active */
        select.form-input.custom-hidden {
            display: none !important;
        }
        @media (max-width: 900px) {
            .custom-select-trigger {
                padding: 12px;
                font-size: 16px;
            }
            .custom-select-option {
                padding: 14px;
                font-size: 15px;
            }
        }

        /* Dropdown menu (appears near button) */
        .dropdown-menu {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 2000;
            overflow: hidden;
            animation: dropdownFade 0.15s ease-out;
        }
        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .dropdown-item:hover {
            background: var(--accent-light);
        }
        .dropdown-item.danger {
            color: var(--red);
        }
        .dropdown-overlay {
            position: fixed;
            inset: 0;
            z-index: 1999;
        }
        
        /* Sticky header for client page */
        .consult-header.sticky {
            position: sticky;
            top: 0;
            z-index: 50;
            margin: -36px -44px 20px -44px;
            padding: 20px 44px;
            border-radius: 0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        @media (max-width: 900px) {
            .consult-header.sticky {
                margin: -16px -16px 16px -16px;
                padding: 16px;
            }
        }
        
        /* Photo grid styles */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
        }
        .photo-thumb {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
        }
        .photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-thumb .photo-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-thumb .photo-remove:hover {
            background: var(--red);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Pull to refresh indicator -->
    <div id="pullIndicator" class="pull-indicator">
        <span id="pullText">‚Üì Pull to refresh</span>
    </div>
    
    <div class="app">
        <aside class="sidebar">
            <div class="logo" onclick="showPage('dashboard')">
                <div class="logo-icon">E</div>
                <span class="logo-text">Estrelle</span>
            </div>
            <nav class="nav">
                <div class="nav-item active" data-page="dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg><span>Dashboard</span></div>
                <div class="nav-item" data-page="clients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>Clients</span></div>
                <div class="nav-item" data-page="schedule"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Schedule</span></div>
                <div class="nav-item" data-page="orders"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M16 10a4 4 0 0 1-8 0"/></svg><span>Orders</span></div>
                <div class="nav-item" data-page="reporting"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg><span>Reporting</span></div>
                <div class="nav-item" data-page="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Settings</span></div>
            </nav>
            <div class="sync-status" id="syncStatus">‚óè Connecting...</div>
        </aside>

        <main class="main">
            <!-- Dashboard -->
            <section class="section active" id="page-dashboard">
                <div class="header">
                    <div><p class="greeting" id="dashGreeting">Good morning ‚òÄÔ∏è</p><h1 class="title">Dashboard</h1></div>
                    <div>
                        <button class="btn btn-secondary" onclick="refreshData()" style="margin-right:8px">‚Üª Refresh</button>
                        <button class="btn btn-secondary" onclick="populateApptModal();openModal('newAppt')" style="margin-right:8px">+ Appointment</button>
                        <button class="btn btn-primary" onclick="openModal('newClient')">+ New Client</button>
                    </div>
                </div>
                
                <!-- Announcements -->
                <div id="announcementsSection" style="margin-bottom:20px"></div>
                
                <div class="stats">
                    <div class="stat"><div class="stat-icon today">üìÖ</div><div class="stat-value" id="statToday">-</div><div class="stat-label">Today's Appointments</div></div>
                    <div class="stat"><div class="stat-icon week">üì¶</div><div class="stat-value" id="statOrders">-</div><div class="stat-label">Active Orders</div></div>
                    <div class="stat"><div class="stat-icon pending">‚úÇÔ∏è</div><div class="stat-value" id="statAlts">-</div><div class="stat-label">In Alterations</div></div>
                    <div class="stat"><div class="stat-icon clients">üë∞</div><div class="stat-value" id="statClients">-</div><div class="stat-label">Total Clients</div></div>
                </div>
                <div class="grid-main">
                    <div>
                        <div class="card" style="margin-bottom:20px"><div class="card-header"><h2 class="card-title">üìç Today's Appointments</h2></div><div class="card-body" id="dashToday"><div class="loading">Loading</div></div></div>
                        <div class="card" style="margin-bottom:20px" id="draftsCard"><div class="card-header"><h2 class="card-title">üìù Pending Drafts</h2></div><div class="card-body" id="dashDrafts"><div class="loading">Loading</div></div></div>
                        <div class="card" style="margin-bottom:20px" id="followUpCard"><div class="card-header"><h2 class="card-title">üìû Follow-ups</h2></div><div class="card-body" id="dashFollowUps"><div class="loading">Loading</div></div></div>
                        <div class="card" style="margin-bottom:20px" id="confirmDueCard"><div class="card-header"><h2 class="card-title">üìß Confirmations Due</h2></div><div class="card-body" id="dashConfirmDue"><div class="loading">Loading</div></div></div>
                    </div>
                    <div class="card"><div class="card-header"><h2 class="card-title">üë∞ Recent Clients</h2></div><div class="card-body" id="dashRecent"><div class="loading">Loading</div></div></div>
                </div>
            </section>

            <!-- Clients -->
            <section class="section" id="page-clients">
                <div class="header">
                    <div><h1 class="title">Clients</h1><p class="subtitle" id="clientCount">-</p></div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <div style="display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden">
                            <button class="btn btn-sm" id="viewAllClients" onclick="setClientsView('all')" style="border:none;border-radius:0;background:var(--accent);color:white">All Clients</button>
                            <button class="btn btn-sm" id="viewAnniversaries" onclick="setClientsView('anniversaries')" style="border:none;border-radius:0;background:white;color:var(--text)">üíï Anniversaries</button>
                        </div>
                        <button class="btn btn-secondary" id="btnDeleteClients" style="display:none;background:var(--rose);color:white" onclick="bulkDeleteClients()">üóë Delete</button>
                        <button class="btn btn-primary" onclick="openModal('newClient')">+ New Client</button>
                    </div>
                </div>
                
                <!-- All Clients View -->
                <div id="allClientsView">
                    <div class="card"><div class="card-body">
                        <div class="search"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search..." id="clientSearch" oninput="filterClients()"></div>
                        <div class="table-wrap"><table class="table"><thead><tr><th style="width:30px"><input type="checkbox" id="selectAllClients" onchange="toggleAllClients(this.checked)"></th><th style="cursor:pointer" onclick="sortClientsBy('name')">Client <span id="clientSortArrow_name" style="opacity:0.3">‚Üï</span></th><th style="cursor:pointer" onclick="sortClientsBy('wedding')">Wedding <span id="clientSortArrow_wedding" style="opacity:0.3">‚Üï</span></th><th style="cursor:pointer" onclick="sortClientsBy('status')">Status <span id="clientSortArrow_status" style="opacity:0.3">‚Üï</span></th><th style="cursor:pointer" onclick="sortClientsBy('lastVisit')">Last Visit <span id="clientSortArrow_lastVisit" style="opacity:1">‚Üì</span></th><th></th></tr></thead><tbody id="clientsTable"></tbody></table></div>
                    </div></div>
                </div>
                
                <!-- Anniversaries View -->
                <div id="anniversariesView" style="display:none">
                    <div class="card" style="margin-bottom:16px">
                        <div class="card-body" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Show</label>
                                <select class="form-input" id="annFilterRange" onchange="renderAnniversariesView()" style="width:auto">
                                    <option value="30">Next 30 days</option>
                                    <option value="90">Next 90 days</option>
                                    <option value="365" selected>All this year</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Status</label>
                                <select class="form-input" id="annFilterStatus" onchange="renderAnniversariesView()" style="width:auto">
                                    <option value="">All</option>
                                    <option value="pending">Needs email</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="sent">Sent</option>
                                </select>
                            </div>
                            <div style="margin-left:auto;display:flex;gap:8px">
                                <button class="btn btn-secondary" onclick="openAnniversaryTemplateModal()">‚úèÔ∏è Edit Template</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" style="padding:0">
                            <div class="table-wrap"><table class="table">
                                <thead><tr>
                                    <th>Client</th>
                                    <th>Anniversary</th>
                                    <th>Years</th>
                                    <th>Email Status</th>
                                    <th style="text-align:right">Actions</th>
                                </tr></thead>
                                <tbody id="anniversariesTable"></tbody>
                            </table></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Schedule -->
            <section class="section" id="page-schedule">
                <div class="header">
                    <div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <h1 class="title" id="weekTitle">Schedule</h1>
                            <button onclick="openModal('importTimely')" title="Import from Timely" style="background:none;border:none;cursor:pointer;font-size:16px;opacity:0.6;padding:4px" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6">üì•</button>
                        </div>
                        <p class="subtitle" id="weekSub"></p>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <div style="display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden">
                            <button class="btn btn-sm" id="viewWeek" onclick="setScheduleView('week')" style="border:none;border-radius:0;background:var(--accent);color:white">Week</button>
                            <button class="btn btn-sm" id="viewMonth" onclick="setScheduleView('month')" style="border:none;border-radius:0;background:white;color:var(--text)">Month</button>
                            <button class="btn btn-sm" id="viewList" onclick="setScheduleView('list')" style="border:none;border-radius:0;background:white;color:var(--text)">List</button>
                        </div>
                        <button class="btn btn-secondary" onclick="changePeriod(-1)">‚Üê Prev</button>
                        <button class="btn btn-secondary" onclick="changePeriod(0)">Today</button>
                        <button class="btn btn-secondary" onclick="changePeriod(1)">Next ‚Üí</button>
                        <button class="btn btn-primary" onclick="populateApptModal();openModal('newAppt')">+ Appointment</button>
                    </div>
                </div>
                <div id="weekList"></div>
                <div id="monthList" style="display:none"></div>
                <div id="scheduleListView" style="display:none">
                    <div class="card" style="margin-bottom:14px">
                        <div class="card-body" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Filter</label>
                                <select class="form-input" id="apptFilter" onchange="renderAllAppointments()" style="width:auto">
                                    <option value="all">All</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="past">Past</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Type</label>
                                <select class="form-input" id="apptTypeFilter" onchange="renderAllAppointments()" style="width:auto">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-input" id="apptSearch" placeholder="Client name..." oninput="renderAllAppointments()" style="width:150px">
                            </div>
                            <button class="btn btn-secondary" id="btnDeleteAppts" style="display:none;background:var(--red);color:white" onclick="bulkDeleteAppointments()">üóë Delete</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" style="padding:0">
                            <div class="table-wrap"><table class="table">
                                <thead><tr><th style="width:30px"><input type="checkbox" id="selectAllAppts" onchange="toggleAllAppts(this.checked)"></th><th>Date</th><th>Time</th><th>Client</th><th>Type</th><th>Consultant</th><th></th></tr></thead>
                                <tbody id="allApptTable"></tbody>
                            </table></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders & Alterations -->
            <section class="section" id="page-orders">
                <div class="header">
                    <div><h1 class="title">Orders & Alterations</h1><p class="subtitle" id="ordersSubtitle">Track orders and fittings</p></div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button class="btn btn-secondary btn-sm" onclick="syncData()" title="Sync with server" style="padding:8px">üîÑ</button>
                        <div style="display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden">
                            <button class="btn btn-sm" id="viewOrders" onclick="setOrdersView('orders')" style="border:none;border-radius:0;background:var(--accent);color:white">Orders</button>
                            <button class="btn btn-sm" id="viewAlterations" onclick="setOrdersView('alterations')" style="border:none;border-radius:0;background:white;color:var(--text)">Alterations</button>
                        </div>
                        <button class="btn btn-primary" id="ordersAddBtn" onclick="openAddOrder()">+ Add Order</button>
                    </div>
                </div>
                
                <!-- Orders View -->
                <div id="ordersViewContent">
                    <!-- Bulk Action Bar (hidden by default) -->
                    <div id="ordersBulkBar" style="display:none;background:var(--charcoal);color:white;padding:12px 16px;border-radius:8px;margin-bottom:16px;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:12px">
                            <span id="ordersSelectedCount">0 selected</span>
                            <button class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:white" onclick="selectAllOrders()">Select All</button>
                            <button class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:white" onclick="deselectAllOrders()">Deselect All</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <select class="form-input" id="bulkStatusSelect" style="width:auto;padding:6px 10px;font-size:12px">
                                <option value="">Change Status...</option>
                                <option value="pending submission">Pending Submission</option>
                                <option value="in production">In Production</option>
                                <option value="ready to ship">Ready to Ship</option>
                                <option value="shipped">Shipped</option>
                                <option value="arrived - pending QA">Arrived - Needs QA</option>
                                <option value="QA complete">QA Complete</option>
                                <option value="in alterations">In Alterations</option>
                                <option value="picked up">Picked Up</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="applyBulkStatus()">Apply</button>
                            <button class="btn btn-sm" style="background:#e74c3c;color:white" onclick="bulkDeleteOrders()">‚úï Delete</button>
                        </div>
                    </div>
                    
                    <!-- Orders Stats -->
                    <div class="orders-stats" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px">
                        <div class="card order-stat-card" style="border-left:3px solid #e74c3c;cursor:pointer" id="cardNeedsAttention" onclick="toggleNeedsAttention()">
                            <div class="card-body" style="padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:#e74c3c;margin-bottom:4px">Needs Attention ‚ö†</div>
                                <div style="font-size:24px;font-weight:600;color:#e74c3c" id="ordersNeedsAttention">0</div>
                            </div>
                        </div>
                        <div class="card order-stat-card" style="border-left:3px solid #3498db;cursor:pointer" id="cardInProduction" onclick="filterOrders('in production')">
                            <div class="card-body" style="padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);margin-bottom:4px">In Production</div>
                                <div style="font-size:24px;font-weight:600" id="ordersInProduction">0</div>
                            </div>
                        </div>
                        <div class="card order-stat-card" style="border-left:3px solid #e67e22;cursor:pointer" id="cardArrived" onclick="filterOrders('arrived')">
                            <div class="card-body" style="padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);margin-bottom:4px">Arrived</div>
                                <div style="font-size:24px;font-weight:600"><span id="ordersArrived">0</span> <span id="ordersNeedsQA" style="font-size:12px;color:#e67e22"></span></div>
                            </div>
                        </div>
                        <div class="card order-stat-card" style="border-left:3px solid #1abc9c;cursor:pointer" id="cardInAlterations" onclick="filterOrders('in alterations')">
                            <div class="card-body" style="padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);margin-bottom:4px">In Alterations</div>
                                <div style="font-size:24px;font-weight:600" id="ordersInAlterations">0</div>
                            </div>
                        </div>
                        <div class="card order-stat-card" style="border-left:3px solid #95a5a6;cursor:pointer;opacity:0.7" id="cardPickedUp" onclick="filterOrders('picked up')" title="Click to view archived orders">
                            <div class="card-body" style="padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);margin-bottom:4px">Picked Up üìÅ</div>
                                <div style="font-size:24px;font-weight:600" id="ordersPickedUp">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search & Filter -->
                    <div class="card" style="margin-bottom:16px">
                        <div class="card-body" style="padding:12px">
                            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                                <input type="text" class="form-input" id="orderSearch" placeholder="Search orders..." style="flex:1;min-width:200px" oninput="renderOrders()">
                                <select class="form-input" id="orderStatusFilter" style="display:none">
                                    <option value="">All Statuses</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="clearOrderFilters()">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Orders Table -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Orders <span id="ordersCount" style="font-weight:normal;color:var(--text-secondary)"></span></h2>
                        </div>
                        <div class="card-body" style="padding:0;overflow-x:auto">
                            <table class="table" id="ordersTable">
                                <thead>
                                    <tr>
                                        <th style="width:40px"><input type="checkbox" id="selectAllOrdersCheckbox" onchange="toggleAllOrderCheckboxes(this.checked)"></th>
                                        <th style="cursor:pointer" onclick="sortOrdersBy('clientName')">Client <span id="sortArrow_clientName" style="opacity:0.3">‚Üï</span></th>
                                        <th>PO</th>
                                        <th>Dress</th>
                                        <th>Designer</th>
                                        <th style="cursor:pointer" onclick="sortOrdersBy('orderDate')">Order Date <span id="sortArrow_orderDate" style="opacity:1">‚Üì</span></th>
                                        <th style="cursor:pointer" onclick="sortOrdersBy('weddingDate')">Wedding <span id="sortArrow_weddingDate" style="opacity:0.3">‚Üï</span></th>
                                        <th style="cursor:pointer" onclick="sortOrdersBy('arrivalDate')">ETA <span id="sortArrow_arrivalDate" style="opacity:0.3">‚Üï</span></th>
                                        <th style="cursor:pointer" onclick="sortOrdersBy('status')">Status <span id="sortArrow_status" style="opacity:0.3">‚Üï</span></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Alterations View -->
                <div id="alterationsViewContent" style="display:none">
                    <!-- Stats -->
                    <div class="grid-3" style="gap:12px;margin-bottom:16px">
                        <div class="card" style="border-left:3px solid #1abc9c">
                            <div class="card-body">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);margin-bottom:4px">Active Alterations</div>
                                <div style="font-size:24px;font-weight:600" id="altsActive">0</div>
                            </div>
                        </div>
                        <div class="card" style="border-left:3px solid #f39c12">
                            <div class="card-body">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);margin-bottom:4px">Fitting This Week</div>
                                <div style="font-size:24px;font-weight:600" id="altsFittingsWeek">0</div>
                            </div>
                        </div>
                        <div class="card" style="border-left:3px solid #e74c3c">
                            <div class="card-body">
                                <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);margin-bottom:4px">Urgent (Wedding &lt;30 days)</div>
                                <div style="font-size:24px;font-weight:600" id="altsUrgent">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alterations List with sync button in header -->
                    <div class="card">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                            <h2 class="card-title">Alterations</h2>
                            <button class="btn btn-sm btn-secondary" onclick="syncFittingsToAlterations()" title="Sync scheduled fittings to alterations">üîÑ</button>
                        </div>
                        <div class="card-body" id="alterationsList"></div>
                    </div>
                </div>
            </section>

            <!-- Designers (now hidden, moved to Settings) -->
            <!-- Reporting (Analytics + Report Builder) -->
            <section class="section" id="page-reporting">
                <div class="header">
                    <div><h1 class="title">Reporting</h1><p class="subtitle" id="reportingSubtitle">Analytics and custom reports</p></div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <div style="display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden">
                            <button class="btn btn-sm" id="viewAnalytics" onclick="setReportingView('analytics')" style="border:none;border-radius:0;background:var(--accent);color:white">Analytics</button>
                            <button class="btn btn-sm" id="viewReportBuilder" onclick="setReportingView('builder')" style="border:none;border-radius:0;background:white;color:var(--text)">Report Builder</button>
                        </div>
                        <select class="form-input" id="analyticsYear" onchange="renderAnalytics()" style="width:auto">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportAnalytics()">üìä Export</button>
                    </div>
                </div>
                
                <!-- Analytics View -->
                <div id="analyticsViewContent">
                    <!-- Summary Cards -->
                    <div class="reporting-stats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">
                        <div class="card">
                            <div class="card-body" style="text-align:center;padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;color:var(--text-secondary)">Pre-Tax</div>
                                <div style="font-size:24px;font-weight:600" id="analyticsTotalPreTax">$0</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body" style="text-align:center;padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;color:var(--text-secondary)">With Tax</div>
                                <div style="font-size:24px;font-weight:600" id="analyticsTotalWithTax">$0</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body" style="text-align:center;padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;color:var(--text-secondary)">Orders</div>
                                <div style="font-size:24px;font-weight:600" id="analyticsTotalOrders">0</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body" style="text-align:center;padding:14px">
                                <div style="font-size:10px;text-transform:uppercase;color:var(--text-secondary)">Avg Order</div>
                                <div style="font-size:24px;font-weight:600" id="analyticsAvgOrder">$0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Sales Chart -->
                    <div class="card" style="margin-bottom:16px">
                        <div class="card-header"><h2 class="card-title">üìà Monthly Sales</h2></div>
                        <div class="card-body">
                            <div id="salesChart" style="height:250px;display:flex;align-items:flex-end;gap:8px;padding:20px 0"></div>
                            <div id="salesChartLabels" style="display:flex;gap:8px;font-size:10px;color:var(--text-secondary);margin-top:8px"></div>
                        </div>
                    </div>
                    
                    <div class="grid-2" style="gap:16px;margin-bottom:16px">
                        <!-- Monthly Breakdown Table -->
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">üí∞ Monthly Breakdown</h2></div>
                            <div class="card-body" style="max-height:400px;overflow-y:auto">
                                <table class="table" id="monthlyBreakdownTable">
                                    <thead><tr><th>Month</th><th>Orders</th><th>Pre-Tax</th><th>Tax</th><th>Total</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Customer Stats -->
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">üë∞ Customer Activity</h2></div>
                            <div class="card-body" style="max-height:400px;overflow-y:auto">
                                <table class="table" id="customerStatsTable">
                                    <thead><tr><th>Month</th><th>New Clients</th><th>Consultations</th><th>Conversions</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seasonality & Insights -->
                    <div class="grid-2" style="gap:16px;margin-bottom:16px">
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">üå∏ Wedding Season Analysis</h2></div>
                            <div class="card-body">
                                <div id="seasonalityChart" style="display:flex;flex-direction:column;gap:8px"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">üèÜ Top Designers</h2></div>
                            <div class="card-body">
                                <div id="topDesignersChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Builder View -->
                <div id="reportBuilderContent" style="display:none">
                    <div class="card" style="margin-bottom:16px">
                        <div class="card-header"><h2 class="card-title">üîß Build Custom Report</h2></div>
                        <div class="card-body">
                            <div class="grid-2" style="gap:16px;margin-bottom:16px">
                                <div class="form-group">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-input" id="reportType" onchange="updateReportOptions()">
                                        <option value="appointments">Appointments</option>
                                        <option value="clients">Clients</option>
                                        <option value="orders">Orders</option>
                                        <option value="consultants">Consultant Performance</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Group By</label>
                                    <select class="form-input" id="reportGroupBy">
                                        <option value="none">No Grouping</option>
                                        <option value="consultant">Consultant</option>
                                        <option value="type">Type</option>
                                        <option value="month">Month</option>
                                        <option value="status">Status</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid-2" style="gap:16px;margin-bottom:16px">
                                <div class="form-group">
                                    <label class="form-label">Date Range</label>
                                    <div style="display:flex;gap:8px;align-items:center">
                                        <input type="date" class="form-input" id="reportDateFrom">
                                        <span>to</span>
                                        <input type="date" class="form-input" id="reportDateTo">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Quick Range</label>
                                    <select class="form-input" id="reportQuickRange" onchange="setReportDateRange(this.value)">
                                        <option value="">Custom</option>
                                        <option value="thisMonth">This Month</option>
                                        <option value="lastMonth">Last Month</option>
                                        <option value="thisQuarter">This Quarter</option>
                                        <option value="lastQuarter">Last Quarter</option>
                                        <option value="thisYear">This Year</option>
                                        <option value="lastYear">Last Year</option>
                                    </select>
                                </div>
                            </div>
                            <div id="reportFilters" style="margin-bottom:16px">
                                <label class="form-label">Filters</label>
                                <div style="display:flex;flex-wrap:wrap;gap:12px">
                                    <label style="display:flex;align-items:center;gap:6px;font-size:13px">
                                        <input type="checkbox" id="reportFilterNoShow"> Exclude No-Shows
                                    </label>
                                    <label style="display:flex;align-items:center;gap:6px;font-size:13px">
                                        <input type="checkbox" id="reportFilterCompleted"> Completed Only
                                    </label>
                                </div>
                            </div>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                                <button class="btn btn-secondary" onclick="exportReport()">üì• Export CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Results -->
                    <div class="card" id="reportResultsCard" style="display:none">
                        <div class="card-header">
                            <h2 class="card-title" id="reportResultsTitle">Report Results</h2>
                            <span id="reportResultsCount" style="font-size:12px;color:var(--text-secondary)"></span>
                        </div>
                        <div class="card-body" style="padding:0;overflow-x:auto">
                            <table class="table" id="reportResultsTable">
                                <thead id="reportResultsHead"></thead>
                                <tbody id="reportResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Consultants (hidden, moved to Settings) -->
            <section class="section" id="page-consultants" style="display:none">
                <div class="header">
                    <div><h1 class="title">Consultants</h1><p class="subtitle">Manage team signatures</p></div>
                    <button class="btn btn-primary" onclick="openModal('newConsultant')">+ Add</button>
                </div>
                <div class="card" style="margin-bottom:16px"><div class="card-body">
                    <div id="consultantsList"></div>
                </div></div>
            </section>

            <!-- Settings (Redesigned with expandable sections) -->
            <section class="section" id="page-settings">
                <div class="header">
                    <div><h1 class="title">Settings</h1><p class="subtitle">Manage your store configuration</p></div>
                </div>
                
                <!-- Expandable Settings Cards -->
                <div style="display:flex;flex-direction:column;gap:12px">
                    
                    <!-- Store Info -->
                    <div class="card settings-card">
                        <div class="card-header" onclick="toggleSettingsSection('storeInfo')" style="cursor:pointer">
                            <h2 class="card-title">üè™ Store Information</h2>
                            <span class="settings-toggle" id="toggleStoreInfo">‚ñº</span>
                        </div>
                        <div class="card-body settings-content" id="sectionStoreInfo" style="display:none">
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">This information appears in outbound emails to clients</p>
                            <div class="form-row">
                                <div class="form-group"><label class="form-label">Store Name</label><input type="text" class="form-input" id="setStoreName" placeholder="Estrelle Bridal"></div>
                                <div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="setStorePhone" placeholder="(416) 555-1234"></div>
                            </div>
                            <div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="setStoreAddress" placeholder="123 Bridal Lane, Toronto, ON"></div>
                            <div class="form-row">
                                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="setStoreEmail" placeholder="hello@estrellebridal.com"></div>
                                <div class="form-group"><label class="form-label">Website</label><input type="url" class="form-input" id="setStoreWebsite" placeholder="https://estrellebridal.com"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label class="form-label">Instagram</label><input type="text" class="form-input" id="setStoreInstagram" placeholder="@estrellebridal"></div>
                                <div class="form-group"><label class="form-label">TikTok</label><input type="text" class="form-input" id="setStoreTiktok" placeholder="@estrellebridal"></div>
                            </div>
                            <button class="btn btn-primary" onclick="saveStoreInfo()">Save Store Info</button>
                        </div>
                    </div>
                    
                    <!-- Consultants -->
                    <div class="card settings-card">
                        <div class="card-header" onclick="toggleSettingsSection('consultants')" style="cursor:pointer">
                            <h2 class="card-title">üë• Consultants <span id="consultantCount" style="font-weight:normal;color:var(--text-secondary)"></span></h2>
                            <span class="settings-toggle" id="toggleConsultants">‚ñº</span>
                        </div>
                        <div class="card-body settings-content" id="sectionConsultants" style="display:none">
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Manage team members and their signatures</p>
                            <div id="settingsConsultantsList" style="margin-bottom:16px"></div>
                            <button class="btn btn-secondary" onclick="openModal('newConsultant')">+ Add Consultant</button>
                        </div>
                    </div>
                    
                    <!-- Designers -->
                    <div class="card settings-card">
                        <div class="card-header" onclick="toggleSettingsSection('designers')" style="cursor:pointer">
                            <h2 class="card-title">üëó Designers <span id="designerCount" style="font-weight:normal;color:var(--text-secondary)"></span></h2>
                            <span class="settings-toggle" id="toggleDesigners">‚ñº</span>
                        </div>
                        <div class="card-body settings-content" id="sectionDesigners" style="display:none">
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Production timelines and rush fees</p>
                            <div class="table-wrap">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Designer</th>
                                            <th>Standard Production</th>
                                            <th>Rush Tiers</th>
                                            <th>Below Minimum</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="settingsDesignersTable"></tbody>
                                </table>
                            </div>
                            <button class="btn btn-secondary" onclick="openAddDesignerModal()" style="margin-top:12px">+ Add Designer</button>
                        </div>
                    </div>
                    
                    <!-- Email Templates -->
                    <div class="card settings-card">
                        <div class="card-header" onclick="toggleSettingsSection('templates')" style="cursor:pointer">
                            <h2 class="card-title">üìß Email Templates <span id="templateCount" style="font-weight:normal;color:var(--text-secondary)"></span></h2>
                            <span class="settings-toggle" id="toggleTemplates">‚ñº</span>
                        </div>
                        <div class="card-body settings-content" id="sectionTemplates" style="display:none">
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Manage email templates for client communications</p>
                            
                            <!-- Preset System Templates -->
                            <div style="margin-bottom:20px">
                                <div style="font-size:11px;font-weight:600;color:var(--taupe);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.05em">System Templates</div>
                                <div style="display:flex;flex-direction:column;gap:8px">
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg);border-radius:10px">
                                        <div>
                                            <div style="font-weight:600">üìÖ Appointment Confirmation</div>
                                            <div style="font-size:12px;color:var(--text-secondary)">Sent when confirming appointments</div>
                                        </div>
                                        <button class="btn btn-secondary btn-sm" onclick="openTemplateEditor('confirmation')">Edit</button>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg);border-radius:10px">
                                        <div>
                                            <div style="font-weight:600">üíç Anniversary Email</div>
                                            <div style="font-size:12px;color:var(--text-secondary)">Sent on wedding anniversaries</div>
                                        </div>
                                        <button class="btn btn-secondary btn-sm" onclick="openTemplateEditor('anniversary')">Edit</button>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg);border-radius:10px">
                                        <div>
                                            <div style="font-weight:600">üìû Follow-up Email</div>
                                            <div style="font-size:12px;color:var(--text-secondary)">Sent after appointments</div>
                                        </div>
                                        <button class="btn btn-secondary btn-sm" onclick="openTemplateEditor('followup')">Edit</button>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg);border-radius:10px">
                                        <div>
                                            <div style="font-weight:600">üì¶ Order Status Emails</div>
                                            <div style="font-size:12px;color:var(--text-secondary)">Templates for order updates</div>
                                        </div>
                                        <button class="btn btn-secondary btn-sm" onclick="openTemplateEditor('order')">Manage</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Custom Templates -->
                            <div>
                                <div style="font-size:11px;font-weight:600;color:var(--taupe);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.05em">Custom Templates</div>
                                
                                <!-- Available Placeholders Guide -->
                                <div style="background:var(--blush);padding:12px 16px;border-radius:8px;margin-bottom:16px">
                                    <div style="font-size:11px;font-weight:600;color:var(--taupe);margin-bottom:8px">üìù AVAILABLE PLACEHOLDERS</div>
                                    <div style="display:flex;flex-wrap:wrap;gap:6px">
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{FirstName}')">{FirstName}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{LastName}')">{LastName}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{WeddingDate}')">{WeddingDate}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{Venue}')">{Venue}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{AppointmentDate}')">{AppointmentDate}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{AppointmentTime}')">{AppointmentTime}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{Consultant}')">{Consultant}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{StoreName}')">{StoreName}</code>
                                        <code style="background:white;padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer" onclick="copyPlaceholder('{StorePhone}')">{StorePhone}</code>
                                    </div>
                                    <div style="font-size:10px;color:var(--taupe);margin-top:6px">üí° Click to copy a placeholder</div>
                                </div>
                                
                                <!-- Templates List -->
                                <div id="emailTemplatesList" style="margin-bottom:16px"></div>
                                
                                <button class="btn btn-secondary" onclick="openAddTemplateModal()">+ Add Custom Template</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Types -->
                    <div class="card settings-card">
                        <div class="card-header" onclick="toggleSettingsSection('services')" style="cursor:pointer">
                            <h2 class="card-title">üìÖ Service Types</h2>
                            <span class="settings-toggle" id="toggleServices">‚ñº</span>
                        </div>
                        <div class="card-body settings-content" id="sectionServices" style="display:none">
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Appointment types for booking</p>
                            <div id="serviceTypesList" style="margin-bottom:12px"></div>
                            <div style="display:flex;gap:8px">
                                <input type="text" class="form-input" id="newServiceType" placeholder="Add new type (e.g., Pickup)" style="flex:1">
                                <button class="btn btn-secondary" onclick="addServiceType()">+ Add</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alteration Items -->
                    <div class="card settings-card">
                        <div class="card-header" onclick="toggleSettingsSection('altItems')" style="cursor:pointer">
                            <h2 class="card-title">‚úÇÔ∏è Alteration Items</h2>
                            <span class="settings-toggle" id="toggleAltItems">‚ñº</span>
                        </div>
                        <div class="card-body settings-content" id="sectionAltItems" style="display:none">
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Custom alteration items for the dropdown</p>
                            <div id="savedAltItemsList" style="margin-bottom:12px"></div>
                            <div style="display:flex;gap:8px">
                                <input type="text" class="form-input" id="newSavedAltItem" placeholder="Add new item (e.g., Shorten sleeves)" style="flex:1">
                                <button class="btn btn-secondary" onclick="addSavedAltItem()">+ Add</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </section>

            <!-- Consultation -->
            <section class="section" id="page-consult">
                <div class="consult-header sticky">
                    <div class="consult-client">
                        <div class="consult-avatar" id="cAvatar">-</div>
                        <div>
                            <div class="consult-name" id="cName">-</div>
                            <div class="consult-meta" id="cMeta">-</div>
                        </div>
                        <div style="margin-left:12px;display:flex;gap:4px">
                            <button class="btn btn-sm btn-secondary" onclick="openClientEmailModal()" title="Send Email">üìß</button>
                            <button class="btn btn-sm btn-secondary" onclick="editCurrentClient()">‚úèÔ∏è Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="archiveCurrentClient()">üìÅ Archive</button>
                            <button class="btn btn-sm" onclick="deleteCurrentClient()" style="background:#fee;color:#c00">‚úï Delete</button>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
                        <button class="btn btn-success" onclick="sheSaidYes()" id="btnSheSaidYes">üíç She Said Yes!</button>
                        <span id="draftIndicator" style="display:none;margin-left:8px;padding:4px 10px;background:#fff3cd;color:#856404;border-radius:4px;font-size:11px;cursor:pointer" onclick="sheSaidYes()">üìù Draft saved - click to continue</span>
                    </div>
                </div>
                <div class="timeline-box" id="timelineBox">
                    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
                        <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
                            <div style="text-align:center;min-width:100px">
                                <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.05em;color:var(--taupe);margin-bottom:4px" id="tlLabel">Wedding In</div>
                                <div style="font-size:32px;font-weight:600;color:var(--charcoal);line-height:1" id="tlMonths">‚Äî</div>
                            </div>
                            
                            <div style="text-align:center;min-width:120px">
                                <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.05em;color:var(--taupe);margin-bottom:4px">Alteration Time</div>
                                <div style="font-size:36px;font-weight:600;color:var(--charcoal);line-height:1;display:flex;align-items:center;justify-content:center">
                                    <select class="form-input" id="tlAltMonths" onchange="updateTimeline()" style="width:60px;text-align:center;font-size:36px;font-weight:600;padding:0;border:none;background:transparent;color:var(--charcoal);-webkit-appearance:none;appearance:none;cursor:pointer">
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4" selected>4</option>
                                        <option value="5">5</option>
                                    </select>
                                    <span style="font-size:12px;color:var(--taupe);margin-left:-8px">‚ñº</span>
                                </div>
                                <div style="font-size:9px;color:var(--taupe);margin-top:4px">months</div>
                            </div>
                            
                            <div style="width:1px;height:50px;background:var(--champagne)"></div>
                            
                            <div id="tlSummary" style="font-size:11px;max-width:200px"></div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="toggleDesignerTable()" id="tlToggle">Designer Rush Fees ‚ñº</button>
                    </div>
                    <div id="altWarning" style="display:none;background:#fff3cd;color:#856404;padding:8px 12px;border-radius:4px;margin-top:10px;font-size:11px">
                        ‚ö†Ô∏è <b>2 months alterations not recommended.</b> Most brides need 3-4 months for multiple fittings and adjustments.
                    </div>
                    <div id="designerTableWrap" style="display:none;margin-top:12px;border-top:1px solid var(--champagne);padding-top:12px">
                        <div style="font-size:10px;color:var(--rose);margin-bottom:8px">* All rush orders require designer approval</div>
                        <table class="rush-table">
                            <thead><tr><th>Designer</th><th>Standard</th><th>Rush Fees</th><th>Your Timeline</th></tr></thead>
                            <tbody id="rushBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="grid-2">
                    <div>
                        <div class="card" style="margin-bottom:12px">
                            <div class="card-header"><h2 class="card-title">Quick Notes</h2><span id="autoSaveStatus" style="font-size:10px;color:var(--sage);display:none">‚úì Saved</span></div>
                            <div class="card-body">
                                <div class="form-group"><label class="form-label">Style Preferences</label><textarea class="form-input" id="cStyle" style="min-height:50px" oninput="scheduleAutoSave()"></textarea></div>
                                <div class="form-group"><label class="form-label">Budget</label><input type="text" class="form-input" id="cBudget" placeholder="e.g. $5,000 or $5,000 - $8,000" onblur="formatBudget(this); scheduleAutoSave()" onchange="scheduleAutoSave()"></div>
                                <div class="form-group"><label class="form-label">General Notes</label><textarea class="form-input" id="cNotes" style="min-height:50px" oninput="scheduleAutoSave()"></textarea></div>
                            </div>
                        </div>
                        <div class="card" style="margin-bottom:12px">
                            <div class="card-header"><h2 class="card-title">Appointments</h2><button class="btn btn-sm btn-secondary" onclick="addApptForClient()">+ Add</button></div>
                            <div class="card-body" id="cAppts"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Top Options</h2><button class="btn btn-sm btn-secondary" onclick="$('editOptionId').value='';openModal('addOption')">+ Add</button></div>
                            <div class="card-body" id="cOptions"></div>
                        </div>
                    </div>
                    <div>
                        <div class="card" style="margin-bottom:12px">
                            <div class="card-header"><h2 class="card-title">üìè Measurements</h2><button class="btn btn-sm btn-secondary" onclick="openAddMeasurementModal()">+ Add</button></div>
                            <div class="card-body" id="cMeasurements"></div>
                        </div>
                        <div class="card" style="margin-bottom:12px">
                            <div class="card-header"><h2 class="card-title">üì∏ Photos</h2><button class="btn btn-sm btn-secondary" onclick="openPhotoUpload()">+ Add</button></div>
                            <div class="card-body" id="cPhotos" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2 class="card-title">Visit History</h2><span style="font-size:9px;color:var(--taupe)">from appointment notes</span></div>
                            <div class="card-body" id="cVisitHistory" style="max-height:400px;overflow-y:auto"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- New/Edit Client -->
    <div class="modal-overlay" id="modal-newClient">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="clientModalTitle">New Client</h2><button class="modal-close" onclick="closeModal('newClient')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="editClientId">
                <div class="form-row"><div class="form-group"><label class="form-label">First Name *</label><input type="text" class="form-input" id="nFirstName"></div><div class="form-group"><label class="form-label">Last Name *</label><input type="text" class="form-input" id="nLastName"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="nEmail"></div><div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="nPhone"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Wedding Date</label><input type="date" class="form-input" id="nWedding"></div><div class="form-group"><label class="form-label">Venue</label><input type="text" class="form-input" id="nVenue"></div></div>
                
                <div class="form-group" style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="nDestination" onchange="toggleLeavingDate()">
                    <label for="nDestination" style="font-size:12px;cursor:pointer">Destination Wedding</label>
                </div>
                <div class="form-group" id="leavingDateGroup" style="display:none">
                    <label class="form-label">Leaving Date (when bride departs)</label>
                    <input type="date" class="form-input" id="nLeavingDate">
                    <p style="font-size:10px;color:var(--rose);margin-top:4px">Dress must be ready before this date</p>
                </div>
                
                <div class="form-group"><label class="form-label">Booking Notes</label><textarea class="form-input" id="nBookingNotes"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('newClient')">Cancel</button><button class="btn btn-primary" onclick="saveClient()">Save</button></div>
        </div>
    </div>

    <!-- New/Edit Appointment -->
    <div class="modal-overlay" id="modal-newAppt">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h2 class="modal-title" id="apptModalTitle">New Appointment</h2><button class="modal-close" onclick="closeModal('newAppt')">√ó</button></div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto">
                <input type="hidden" id="editApptId">
                <input type="hidden" id="apptForClientId">
                
                <!-- Client Selection (hidden when creating for specific client) -->
                <div class="form-group" id="clientSelectGroup">
                    <label class="form-label">Client</label>
                    <select class="form-input" id="aClient" onchange="toggleNewClientFields()">
                        <option value="">Select existing...</option>
                        <option value="new">+ Create New Client</option>
                    </select>
                </div>
                
                <!-- Show selected client name when adding for specific client -->
                <div class="form-group" id="clientFixedGroup" style="display:none">
                    <label class="form-label">Client</label>
                    <input type="text" class="form-input" id="aClientName" readonly style="background:var(--blush)">
                </div>
                
                <!-- New Client Fields (shown when "Create New" selected) -->
                <div id="newClientFields" style="display:none;background:var(--blush);padding:16px;border-radius:8px;margin-bottom:16px">
                    <div style="font-size:11px;font-weight:600;margin-bottom:12px;color:var(--taupe);text-transform:uppercase;letter-spacing:0.5px">New Client Details</div>
                    <div class="form-row" style="margin-bottom:12px"><div class="form-group" style="margin-bottom:0"><label class="form-label">First Name *</label><input type="text" class="form-input" id="aNewFirstName"></div><div class="form-group" style="margin-bottom:0"><label class="form-label">Last Name *</label><input type="text" class="form-input" id="aNewLastName"></div></div>
                    <div class="form-row" style="margin-bottom:12px"><div class="form-group" style="margin-bottom:0"><label class="form-label">Email</label><input type="email" class="form-input" id="aNewEmail"></div><div class="form-group" style="margin-bottom:0"><label class="form-label">Phone</label><input type="tel" class="form-input" id="aNewPhone"></div></div>
                    <div class="form-row"><div class="form-group" style="margin-bottom:0"><label class="form-label">Wedding Date</label><input type="date" class="form-input" id="aNewWedding"></div><div class="form-group" style="margin-bottom:0"><label class="form-label">Venue</label><input type="text" class="form-input" id="aNewVenue"></div></div>
                </div>
                
                <!-- Appointment Details -->
                <div style="background:var(--cream);padding:16px;border-radius:8px;margin-bottom:12px">
                    <div style="font-size:11px;font-weight:600;margin-bottom:12px;color:var(--taupe);text-transform:uppercase;letter-spacing:0.5px">Appointment Details</div>
                    <div class="form-row" style="margin-bottom:12px"><div class="form-group" style="margin-bottom:0"><label class="form-label">Date</label><input type="date" class="form-input" id="aDate" onchange="updateFollowUpDate()"></div><div class="form-group" style="margin-bottom:0"><label class="form-label">Time</label><select class="form-input" id="aTime"><option value="">Select...</option><option value="09:00">9:00 AM</option><option value="09:15">9:15 AM</option><option value="09:30">9:30 AM</option><option value="09:45">9:45 AM</option><option value="10:00">10:00 AM</option><option value="10:15">10:15 AM</option><option value="10:30">10:30 AM</option><option value="10:45">10:45 AM</option><option value="11:00">11:00 AM</option><option value="11:15">11:15 AM</option><option value="11:30">11:30 AM</option><option value="11:45">11:45 AM</option><option value="12:00">12:00 PM</option><option value="12:15">12:15 PM</option><option value="12:30">12:30 PM</option><option value="12:45">12:45 PM</option><option value="13:00">1:00 PM</option><option value="13:15">1:15 PM</option><option value="13:30">1:30 PM</option><option value="13:45">1:45 PM</option><option value="14:00">2:00 PM</option><option value="14:15">2:15 PM</option><option value="14:30">2:30 PM</option><option value="14:45">2:45 PM</option><option value="15:00">3:00 PM</option><option value="15:15">3:15 PM</option><option value="15:30">3:30 PM</option><option value="15:45">3:45 PM</option><option value="16:00">4:00 PM</option><option value="16:15">4:15 PM</option><option value="16:30">4:30 PM</option><option value="16:45">4:45 PM</option><option value="17:00">5:00 PM</option><option value="17:15">5:15 PM</option><option value="17:30">5:30 PM</option><option value="17:45">5:45 PM</option><option value="18:00">6:00 PM</option><option value="18:15">6:15 PM</option><option value="18:30">6:30 PM</option><option value="18:45">6:45 PM</option><option value="19:00">7:00 PM</option><option value="19:15">7:15 PM</option><option value="19:30">7:30 PM</option><option value="19:45">7:45 PM</option><option value="20:00">8:00 PM</option></select></div></div>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Type</label><select class="form-input custom-hidden" id="aType" onchange="toggleConsultationReason()"></select><div class="custom-select" id="aTypeCustom"><div class="custom-select-trigger" onclick="toggleCustomSelect('aTypeCustom')"><span class="trigger-label" id="aTypeCustomLabel">Bridal Consultation</span><svg class="trigger-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></div><div class="custom-select-options" id="aTypeCustomOptions"></div></div></div>
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Consultant</label><select class="form-input" id="aConsultant"><option value="">Select...</option></select></div>
                    </div>
                    
                    <!-- Reason for Visit (only for consultations) -->
                    <div id="consultationReasonGroup" style="margin-top:12px">
                        <label class="form-label">Reason for Visit</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px">
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="first" style="margin:0"> First Visit
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="revisit" style="margin:0"> Revisit Favourites
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="sayyes" style="margin:0"> Say Yes üíç
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="trymore" style="margin:0"> Try More Options
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:6px 10px;background:white;border:1px solid var(--champagne);border-radius:4px">
                                <input type="radio" name="aReason" value="other" style="margin:0" onchange="toggleOtherReason()"> Other
                            </label>
                        </div>
                        <input type="text" class="form-input" id="aReasonOther" style="display:none;margin-top:8px" placeholder="Please specify reason...">
                    </div>
                    
                    <!-- Fitting-specific fields (only for fittings) -->
                    <div id="fittingFieldsGroup" style="display:none;margin-top:12px;background:var(--blush);padding:10px;border-radius:5px">
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom:0">
                                <label class="form-label">Dress Needed By</label>
                                <input type="date" class="form-input" id="aDressNeededBy">
                            </div>
                            <div class="form-group" style="margin-bottom:0">
                                <label class="form-label">Wedding Date</label>
                                <input type="text" class="form-input" id="aWeddingDateDisplay" readonly style="background:white">
                            </div>
                        </div>
                        <div style="font-size:10px;color:var(--taupe);margin-top:6px" id="aDaysUntilWedding"></div>
                    </div>
                </div>
                
                <!-- Visit Log Section (shown prominently for editing) -->
                <div id="visitLogSection">
                    <div style="font-size:11px;font-weight:600;color:var(--charcoal);margin-bottom:10px;display:flex;align-items:center;gap:6px">
                        <span>üìù</span> Visit Log
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Style Feedback</label>
                        <textarea class="form-input" id="aLogFeedback" style="min-height:60px" placeholder="e.g. Loved lace and fitted silhouette, didn't like high necklines. Wants more sparkle."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Budget Update</label>
                            <input type="text" class="form-input" id="aLogBudget" placeholder="e.g. $6,000 or $5,000 - $8,000" onblur="formatBudget(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Next Steps</label>
                            <input type="text" class="form-input" id="aLogNextSteps" placeholder="e.g. Bring mom Saturday">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">üìÖ Follow-up Reminder</label>
                            <select class="form-input" id="aFollowUp" onchange="updateFollowUpDate()">
                                <option value="">No follow-up</option>
                                <option value="0">Immediate (today)</option>
                                <option value="1">Tomorrow</option>
                                <option value="2">In 2 days</option>
                                <option value="3">In 3 days</option>
                                <option value="5">In 5 days</option>
                                <option value="7">In 1 week</option>
                                <option value="14">In 2 weeks</option>
                                <option value="custom">Custom date...</option>
                            </select>
                        </div>
                        <div class="form-group" id="followUpDateDisplay" style="display:none">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-input" id="aFollowUpDatePicker" onchange="updateFollowUpDateFromPicker()" style="display:none">
                            <input type="text" class="form-input" id="aFollowUpDate" readonly style="background:var(--blush)">
                        </div>
                    </div>
                    <div class="form-group" id="followUpNotesGroup" style="display:none">
                        <label class="form-label">üìù Follow-up Notes (for staff)</label>
                        <textarea class="form-input" id="aFollowUpNotes" style="min-height:50px" placeholder="e.g. Call to check if she decided on the Aria dress, mention we can hold it for 48 hours..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-input" id="aLogOther" style="min-height:40px" placeholder="Any other important details..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('newAppt')">Cancel</button><button class="btn btn-primary" onclick="saveAppt()">Save</button></div>
        </div>
    </div>
    
    <!-- View Appointment Modal -->
    <div class="modal-overlay" id="modal-viewAppt">
        <div class="modal" style="max-width:600px">
            <div class="modal-header">
                <h2 class="modal-title">üìÖ Appointment Details</h2>
                <button class="modal-close" onclick="closeModal('viewAppt')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="viewApptDetails" style="margin-bottom:16px"></div>
                
                <!-- Appointment Photos Section -->
                <div style="border-top:1px solid var(--champagne);padding-top:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h3 style="font-size:13px;font-weight:600">üì∏ Appointment Photos</h3>
                        <button class="btn btn-sm btn-secondary" onclick="$('apptPhotoInput').click()">+ Add Photos</button>
                        <input type="file" id="apptPhotoInput" accept="image/*" multiple style="display:none" onchange="handleApptPhotoSelect(event)">
                    </div>
                    <div id="apptPhotoGrid" class="photo-grid"></div>
                    <div id="apptPhotoUploadStatus" style="display:none;padding:10px;background:var(--blush);border-radius:5px;font-size:11px;margin-top:12px">
                        <span id="apptPhotoUploadText">Uploading photos...</span>
                    </div>
                    <p style="font-size:10px;color:var(--taupe);margin-top:8px">üí° Upload photos of consultation cards, dress selections, or notes</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewAppt')">Close</button>
                <button class="btn btn-primary" onclick="editApptFromView()">‚úèÔ∏è Edit</button>
            </div>
        </div>
    </div>
    
    <!-- Alteration Detail Modal -->
    <div class="modal-overlay" id="modal-alteration">
        <div class="modal" style="max-width:700px">
            <div class="modal-header"><h2 class="modal-title">‚úÇÔ∏è Alteration Details</h2><button class="modal-close" onclick="closeModal('alteration')">√ó</button></div>
            <div class="modal-body">
                <div id="altClientInfo" style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:16px"></div>
                
                <!-- Dress Needed By -->
                <div style="background:var(--blush);padding:10px 12px;border-radius:5px;margin-bottom:16px;display:flex;align-items:center;gap:12px">
                    <div style="flex:1">
                        <label class="form-label" style="margin-bottom:4px">üéØ Dress Needed By</label>
                        <input type="date" class="form-input" id="altDressNeededBy" style="max-width:180px" onchange="saveAltNeededBy()">
                    </div>
                    <div id="altNeededByCountdown" style="font-size:12px;font-weight:600"></div>
                </div>
                
                <!-- Fitting History -->
                <div style="margin-bottom:16px">
                    <h3 style="font-size:12px;font-weight:600;margin-bottom:8px">üìÖ Fitting Appointments</h3>
                    <div id="altFittingsList"></div>
                </div>
                
                <!-- Alteration Items -->
                <div style="margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <h3 style="font-size:12px;font-weight:600">‚úÇÔ∏è Alteration Items</h3>
                        <div style="display:flex;gap:6px">
                            <button class="btn btn-sm btn-secondary" onclick="manageSavedAltItems()" title="Manage saved items">‚öôÔ∏è</button>
                            <button class="btn btn-sm btn-secondary" onclick="addAlterationItem()">+ Add Item</button>
                        </div>
                    </div>
                    <div id="altItemsList"></div>
                </div>
                
                <!-- Add Item Form (hidden by default) -->
                <div id="addAltItemForm" style="display:none;background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Item</label>
                            <select class="form-input" id="newAltItemType" onchange="toggleCustomAltItem()">
                                <option value="hem">Hem (shorten/lengthen)</option>
                                <option value="bustle">Bustle</option>
                                <option value="take-in">Take In</option>
                                <option value="let-out">Let Out</option>
                                <option value="straps">Straps Adjustment</option>
                                <option value="cups">Add Bra Cups</option>
                                <option value="buttons">Buttons/Hooks</option>
                                <option value="steaming">Steaming</option>
                                <option value="cleaning">Cleaning</option>
                                <option value="---" disabled>‚îÄ‚îÄ Saved Items ‚îÄ‚îÄ</option>
                                <!-- Saved items will be populated here -->
                                <option value="custom">+ Custom...</option>
                            </select>
                        </div>
                        <div class="form-group" id="customAltItemGroup" style="display:none">
                            <label class="form-label">Custom Item Name</label>
                            <input type="text" class="form-input" id="customAltItem" placeholder="e.g., Shorten sleeves">
                            <label style="display:flex;align-items:center;gap:6px;font-size:10px;margin-top:6px;cursor:pointer">
                                <input type="checkbox" id="saveCustomAltItem"> Save for future use
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Details/Measurements</label>
                        <input type="text" class="form-input" id="newAltItemDetails" placeholder="e.g., Take up 2 inches, 3-point bustle...">
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:8px">
                        <button class="btn btn-sm btn-secondary" onclick="cancelAddAltItem()">Cancel</button>
                        <button class="btn btn-sm btn-primary" onclick="saveNewAltItem()">Add Item</button>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">Seamstress Notes</label>
                    <textarea class="form-input" id="altNotes" style="min-height:60px" placeholder="Notes for seamstress..."></textarea>
                </div>
                
                <!-- Schedule Next Fitting -->
                <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <h3 style="font-size:12px;font-weight:600">üìÖ Next Fitting</h3>
                        <span id="altNextFittingStatus" style="font-size:11px;color:var(--taupe)"></span>
                    </div>
                    <div id="altNextFittingDisplay"></div>
                    <div id="altNextFittingForm" style="display:none">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label" style="font-size:10px">Date</label>
                                <input type="date" class="form-input" id="altNextFitDate" style="font-size:12px">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label" style="font-size:10px">Time</label>
                                <input type="time" class="form-input" id="altNextFitTime" value="11:00" style="font-size:12px">
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label" style="font-size:10px">Type</label>
                                <select class="form-input" id="altNextFitType" style="font-size:12px">
                                    <option value="fitting">Fitting</option>
                                    <option value="final fitting">Final Fitting</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label" style="font-size:10px">Consultant</label>
                                <select class="form-input" id="altNextFitConsultant" style="font-size:12px"></select>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end">
                            <button class="btn btn-sm btn-secondary" onclick="cancelAltNextFitting()">Cancel</button>
                            <button class="btn btn-sm btn-primary" onclick="confirmAltNextFitting()">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-wrap:wrap;gap:8px">
                <button class="btn btn-secondary" onclick="closeModal('alteration')">Close</button>
                <button class="btn btn-secondary" onclick="copySeamstressText()">üìã Copy for Seamstress</button>
                <button class="btn btn-secondary" onclick="sendFittingSummary()">üìß Email Bride</button>
                <div style="flex:1"></div>
                <button class="btn btn-primary" onclick="saveAlterations()">üíæ Save</button>
                <button class="btn btn-primary" onclick="saveAndMarkReady()" style="background:#27ae60">‚úì Save & Mark Picked Up</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Option -->
    <div class="modal-overlay" id="modal-addOption">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="optionModalTitle">Add Top Option</h2><button class="modal-close" onclick="closeModal('addOption')">√ó</button></div>
            <input type="hidden" id="editOptionId" value="">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Designer</label><select class="form-input" id="oDesigner" onchange="toggleCustomDesigner()">
                        <option value="">Select designer...</option>
                        <option value="custom">+ Custom Designer</option>
                    </select></div>
                    <div class="form-group"><label class="form-label">Style</label><input type="text" class="form-input" id="oStyle"></div>
                </div>
                <div class="form-group" id="customDesignerGroup" style="display:none">
                    <label class="form-label">Custom Designer Name</label>
                    <input type="text" class="form-input" id="oCustomDesigner" placeholder="Enter designer name">
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Size</label><input type="text" class="form-input" id="oSize" placeholder="e.g. 6, 8, 10"></div>
                    <div class="form-group"><label class="form-label">Price</label><input type="text" class="form-input" id="oPrice" placeholder="Leave blank = as listed" onblur="formatOptionPrice(this)"></div>
                </div>
                <div class="form-group"><label class="form-label">Customizations</label><textarea class="form-input" id="oCustom" placeholder="e.g. Add sleeves, lower back"></textarea></div>
                <div class="form-group"><label class="form-label">Decision By</label><input type="date" class="form-input" id="oDecisionBy"></div>
                <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="oOptionNotes"></textarea></div>
                <label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer"><input type="checkbox" id="oFavorite"> ‚ù§Ô∏è Bride liked this one</label>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addOption')">Cancel</button><button class="btn btn-primary" id="optionSaveBtn" onclick="saveOption()">Add</button></div>
        </div>
    </div>

    <!-- Confirmation Email -->
    <!-- Email Preview Modal -->
    <div class="modal-overlay" id="modal-emailPreview">
        <div class="modal wide" style="max-width:700px;max-height:90vh">
            <div class="modal-header">
                <h2 class="modal-title">üìß Email Preview</h2>
                <button class="modal-close" onclick="closeModal('emailPreview')">√ó</button>
            </div>
            <div class="modal-body" style="padding:0;max-height:calc(90vh - 140px);overflow-y:auto">
                <div style="background:#f5f5f5;padding:16px;border-bottom:1px solid #e0e0e0">
                    <div style="font-size:11px;color:#666;margin-bottom:4px">TO</div>
                    <div style="font-size:14px;font-weight:500" id="previewTo"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fa889f99938a939f948eba9f979b9396d4999597">[email&#160;protected]</a></div>
                </div>
                <div style="background:#f5f5f5;padding:16px;border-bottom:1px solid #e0e0e0">
                    <div style="font-size:11px;color:#666;margin-bottom:4px">SUBJECT</div>
                    <div style="font-size:16px;font-weight:600" id="previewSubject">Email Subject</div>
                </div>
                <div style="padding:24px;background:white;min-height:200px">
                    <div id="previewBody" style="font-size:14px;line-height:1.7;white-space:pre-wrap;font-family:Arial,sans-serif"></div>
                </div>
                <div style="background:var(--cream);padding:12px;border-top:1px solid #e0e0e0">
                    <div style="font-size:11px;color:var(--taupe)">üëÜ This is how the email will appear to the recipient.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailPreview()">‚Üê Edit</button>
                <button class="btn btn-secondary" onclick="openPreviewInGmail()">üìß Open in Gmail</button>
                <button class="btn btn-primary" onclick="confirmSendFromPreview()">‚úì Send Email</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-confirmEmail">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title">Send Confirmation Email</h2>
                <button class="modal-close" onclick="closeModal('confirmEmail')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="confirmApptId">
                <div id="followUpNotesReminder" style="display:none"></div>
                <div class="form-row" style="margin-bottom:12px">
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <input type="email" class="form-input" id="confirmTo" readonly style="background:#f5f5f5">
                        <input type="hidden" id="confirmFirstName">
                        <input type="hidden" id="confirmLastName">
                        <input type="hidden" id="confirmApptDate">
                        <input type="hidden" id="confirmApptTime">
                        <input type="hidden" id="confirmApptType">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="confirmSubject">
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:10px;background:var(--blush);border-radius:5px">
                    <span style="font-size:11px;color:var(--taupe)">üìù Template Settings</span>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary btn-sm" onclick="resetConfirmTemplate()">Reset to Default</button>
                        <button class="btn btn-secondary btn-sm" onclick="saveConfirmTemplate()">Save as Template</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Body</label>
                    <div class="email-toolbar" style="display:flex;gap:4px;margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:5px;flex-wrap:wrap">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmail('bold')" title="Bold"><b>B</b></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmail('italic')" title="Italic"><i>I</i></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmail('underline')" title="Underline"><u>U</u></button>
                        <span style="border-left:1px solid #ccc;margin:0 4px"></span>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmail('heading')" title="Heading">H</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmail('bullet')" title="Bullet List">‚Ä¢</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmail('link')" title="Add Link">üîó</button>
                    </div>
                    <div id="confirmBodyEditor" contenteditable="true" class="form-input rich-text-editor" style="min-height:350px;font-size:12px;line-height:1.6;overflow-y:auto;white-space:pre-wrap"></div>
                    <textarea class="form-input" id="confirmBody" style="display:none"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmEmail')">Cancel</button>
                <button class="btn btn-secondary" onclick="previewConfirmationEmail()" title="Preview before sending">üëÅ Preview</button>
                <button class="btn btn-primary" onclick="sendConfirmationEmail()">Send Email</button>
            </div>
        </div>
    </div>

    <!-- Send Anniversary Email Modal -->
    <div class="modal-overlay" id="modal-sendAnnEmail">
        <div class="modal wide">
            <div class="modal-header">
                <h2 class="modal-title">üíï Send Anniversary Email</h2>
                <button class="modal-close" onclick="closeModal('sendAnnEmail')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="annEmailClientId">
                <div class="form-row" style="margin-bottom:12px">
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <input type="email" class="form-input" id="annEmailTo" readonly style="background:#f5f5f5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="annEmailSubject">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Body</label>
                    <div class="email-toolbar" style="display:flex;gap:4px;margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:5px;flex-wrap:wrap">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bold', 'annEmailBodyEditor')" title="Bold"><b>B</b></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('italic', 'annEmailBodyEditor')" title="Italic"><i>I</i></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('underline', 'annEmailBodyEditor')" title="Underline"><u>U</u></button>
                        <span style="border-left:1px solid #ccc;margin:0 4px"></span>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('heading', 'annEmailBodyEditor')" title="Heading">H</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bullet', 'annEmailBodyEditor')" title="Bullet List">‚Ä¢</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('link', 'annEmailBodyEditor')" title="Add Link">üîó</button>
                    </div>
                    <div id="annEmailBodyEditor" contenteditable="true" class="form-input rich-text-editor" style="min-height:300px;font-size:12px;line-height:1.6;overflow-y:auto;white-space:pre-wrap"></div>
                    <textarea class="form-input" id="annEmailBody" style="display:none"></textarea>
                </div>
                <p style="font-size:11px;color:var(--text-secondary);margin-top:8px">üí° Edit the anniversary template in Settings ‚Üí Email Templates</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('sendAnnEmail')">Cancel</button>
                <button class="btn btn-secondary" onclick="previewAnniversaryEmail()">üëÅ Preview</button>
                <button class="btn btn-primary" onclick="sendAnniversaryEmail()">Send Email</button>
            </div>
        </div>
    </div>

    <!-- New Designer -->
    <div class="modal-overlay" id="modal-editDesigner">
        <div class="modal" style="max-width:550px">
            <div class="modal-header"><h2 class="modal-title" id="designerModalTitle">Edit Designer</h2><button class="modal-close" onclick="closeModal('editDesigner')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="edDesignerIdx">
                <div class="form-group"><label class="form-label">Designer Name *</label><input type="text" class="form-input" id="edDesignerName"></div>
                <div class="form-group"><label class="form-label">Standard Production (months, no rush fee)</label><input type="number" class="form-input" id="edDesignerStandard" min="1" max="24"></div>
                
                <div class="form-group">
                    <label class="form-label">Rush Tiers</label>
                    <p style="font-size:10px;color:var(--rose);margin-bottom:8px">Add rush fee tiers from longest to shortest timeline</p>
                    <div id="edDesignerTiers"></div>
                    <button class="btn btn-sm btn-secondary" onclick="addDesignerTier()" style="margin-top:6px">+ Add Rush Tier</button>
                </div>
                
                <div class="form-group" style="background:var(--blush);padding:12px;border-radius:5px">
                    <label class="form-label">Below Minimum Timeline</label>
                    <p style="font-size:10px;color:var(--rose);margin-bottom:8px">What happens if timeline is shorter than all tiers?</p>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Min Months</label><input type="number" class="form-input" id="edDesignerMinMonths" min="1" max="12"></div>
                        <div class="form-group" style="margin-bottom:0"><label class="form-label">Fee (if any)</label><input type="text" class="form-input" id="edDesignerBelowFee" placeholder="e.g. $4,600 extra"></div>
                    </div>
                    <div class="form-group" style="margin-top:8px;margin-bottom:0"><label class="form-label">Note</label><input type="text" class="form-input" id="edDesignerBelowNote" placeholder="e.g. Inquiry required, not guaranteed"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="deleteDesigner()" style="background:#fee;color:#c00;margin-right:auto">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('editDesigner')">Cancel</button>
                <button class="btn btn-primary" onclick="saveDesigner()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Consultant -->
    <div class="modal-overlay" id="modal-newConsultant">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="consultantModalTitle">Add Consultant</h2><button class="modal-close" onclick="closeModal('newConsultant')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="editConsultantId">
                <div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="cConsultantName"></div>
                <div class="form-group">
                    <label class="form-label">Signature</label>
                    <p style="font-size:10px;color:var(--rose);margin-bottom:6px">Draw signature below. This will auto-fill on contracts.</p>
                    <canvas id="consultantSigPad" class="sig-pad" width="400" height="120"></canvas>
                    <button class="btn btn-sm btn-secondary" onclick="clearConsultantSig()" style="margin-top:6px">Clear</button>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('newConsultant')">Cancel</button><button class="btn btn-primary" onclick="saveConsultant()">Save</button></div>
        </div>
    </div>

    <!-- Add/Edit Email Template Modal -->
    <div class="modal-overlay" id="modal-emailTemplate">
        <div class="modal" style="max-width:720px">
            <div class="modal-header"><h2 class="modal-title" id="emailTemplateModalTitle">Create Email Template</h2><button class="modal-close" onclick="closeModal('emailTemplate')">√ó</button></div>
            <div class="modal-body" style="padding:0">
                <input type="hidden" id="editTemplateId">
                
                <!-- Starter Templates (only show for new) -->
                <div id="tplStarters" style="padding:16px 20px;border-bottom:1px solid var(--border)">
                    <div style="font-size:11px;font-weight:600;color:var(--taupe);margin-bottom:10px">START FROM A TEMPLATE</div>
                    <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:4px">
                        <button class="btn btn-sm btn-secondary" onclick="loadStarterTemplate('followup')" style="white-space:nowrap;font-size:11px">üìû Follow-up</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadStarterTemplate('thankyou')" style="white-space:nowrap;font-size:11px">üíå Thank You</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadStarterTemplate('reminder')" style="white-space:nowrap;font-size:11px">‚è∞ Reminder</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadStarterTemplate('status')" style="white-space:nowrap;font-size:11px">üì¶ Order Update</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadStarterTemplate('blank')" style="white-space:nowrap;font-size:11px">‚úèÔ∏è Blank</button>
                    </div>
                </div>
                
                <div style="padding:20px">
                    <div class="form-group">
                        <label class="form-label">Template Name *</label>
                        <input type="text" class="form-input" id="tplName" placeholder="e.g., Post-Appointment Follow Up" oninput="updateTplPreview()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subject Line *</label>
                        <input type="text" class="form-input" id="tplSubject" placeholder="e.g., Thank you for visiting us, {FirstName}!" oninput="updateTplPreview()">
                    </div>
                    
                    <div class="form-row" style="align-items:flex-start">
                        <!-- Editor side -->
                        <div class="form-group" style="flex:1;min-width:0">
                            <label class="form-label">Message *</label>
                            <textarea class="form-input" id="tplBody" style="min-height:220px;font-family:inherit;font-size:13px;line-height:1.6" placeholder="Write your email here...

Tip: Click the tags below to insert dynamic fields that auto-fill with client data." oninput="updateTplPreview()"></textarea>
                            
                            <!-- Placeholder Chips -->
                            <div style="margin-top:8px">
                                <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:6px">TAP TO INSERT</div>
                                <div style="display:flex;flex-wrap:wrap;gap:4px">
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{FirstName}')">üë§ First Name</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{LastName}')">üë§ Last Name</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{WeddingDate}')">üíç Wedding Date</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{Venue}')">üìç Venue</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{AppointmentDate}')">üìÖ Appt Date</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{AppointmentTime}')">üïê Appt Time</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{Consultant}')">üëó Consultant</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{topOptions}')">‚≠ê Top Picks</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{StoreName}')">üè™ Store Name</span>
                                    <span class="placeholder-chip" onclick="insertPlaceholder('tplBody', '{StorePhone}')">üìû Store Phone</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live Preview -->
                    <div style="margin-top:12px;border:1px solid var(--border);border-radius:10px;overflow:hidden">
                        <div style="background:var(--cream);padding:8px 14px;font-size:10px;font-weight:600;color:var(--taupe);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border)">Preview (sample data)</div>
                        <div id="tplPreview" style="padding:16px;font-size:12px;line-height:1.6;min-height:80px;color:var(--text-secondary);background:white">
                            <span style="color:var(--taupe);font-style:italic">Start typing to see a preview...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('emailTemplate')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEmailTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Send Email to Client Modal -->
    <div class="modal-overlay" id="modal-clientEmail">
        <div class="modal" style="max-width:650px">
            <div class="modal-header"><h2 class="modal-title">üìß Send Email</h2><button class="modal-close" onclick="closeModal('clientEmail')">√ó</button></div>
            <div class="modal-body">
                <div style="background:var(--blush);padding:12px;border-radius:8px;margin-bottom:16px">
                    <div style="font-size:12px"><strong>To:</strong> <span id="clientEmailTo">-</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choose Template</label>
                    <select class="form-input" id="clientEmailTemplate" onchange="loadClientEmailTemplate()">
                        <option value="">-- Select a template --</option>
                        <option value="custom">‚úèÔ∏è Write Custom Email</option>
                    </select>
                    <div style="margin-top:6px"><a href="#" onclick="event.preventDefault();closeModal('clientEmail');openAddTemplateModal()" style="font-size:11px;color:var(--accent)">+ Create a new template</a></div>
                </div>
                
                <!-- Appointment Selector (for templates with appointment placeholders) -->
                <div class="form-group" id="clientEmailApptGroup" style="display:none">
                    <label class="form-label">Select Appointment (for date/time placeholders)</label>
                    <select class="form-input" id="clientEmailAppt" onchange="updateClientEmailPreview()">
                        <option value="">-- No appointment --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <input type="text" class="form-input" id="clientEmailSubject" placeholder="Email subject...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <div class="email-toolbar" style="display:flex;gap:4px;margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:5px;flex-wrap:wrap">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bold', 'clientEmailBodyEditor')" title="Bold"><b>B</b></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('italic', 'clientEmailBodyEditor')" title="Italic"><i>I</i></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('underline', 'clientEmailBodyEditor')" title="Underline"><u>U</u></button>
                        <span style="border-left:1px solid #ccc;margin:0 4px"></span>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('heading', 'clientEmailBodyEditor')" title="Heading">H</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bullet', 'clientEmailBodyEditor')" title="Bullet List">‚Ä¢</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('link', 'clientEmailBodyEditor')" title="Add Link">üîó</button>
                    </div>
                    <div id="clientEmailBodyEditor" contenteditable="true" class="form-input rich-text-editor" style="min-height:200px;font-size:13px;line-height:1.6;overflow-y:auto;white-space:pre-wrap" placeholder="Write your message..."></div>
                    <textarea class="form-input" id="clientEmailBody" style="display:none"></textarea>
                </div>
                
                <div style="background:var(--cream);padding:12px;border-radius:8px">
                    <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:4px">üì§ HOW IT WORKS</div>
                    <div style="font-size:11px;color:var(--text-secondary)">Preview to see exactly how your email will look, then send.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('clientEmail')">Cancel</button>
                <button class="btn btn-secondary" onclick="previewClientEmail()">üëÅ Preview</button>
                <button class="btn btn-primary" onclick="sendClientEmail()">Send Email</button>
            </div>
        </div>
    </div>

    <!-- Order Email Modal -->
    <div class="modal-overlay" id="modal-orderEmail">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title" id="orderEmailTitle">Send Update Email</h2><button class="modal-close" onclick="closeModal('orderEmail')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="orderEmailOrderId">
                <div class="form-group">
                    <label class="form-label">Email Template</label>
                    <select class="form-input" id="orderEmailTemplate" onchange="loadOrderEmailTemplate()">
                        <option value="halfway">Halfway Update - Production on Track</option>
                        <option value="completed">Dress Completed - Ready for Shipping</option>
                        <option value="arrived">Dress Arrived - Schedule Your Fitting</option>
                        <option value="ready">Ready for Pickup</option>
                        <option value="custom">Custom Message</option>
                    </select>
                    <div id="savedTemplatesGroup" style="margin-top:8px">
                        <select class="form-input" id="savedTemplates" onchange="loadSavedTemplate()" style="font-size:11px">
                            <option value="">-- Saved Templates --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">To</label><input type="email" class="form-input" id="orderEmailTo" readonly style="background:var(--blush)"></div>
                <div class="form-group"><label class="form-label">Subject</label><input type="text" class="form-input" id="orderEmailSubject"></div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <div class="email-toolbar" style="display:flex;gap:4px;margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:5px;flex-wrap:wrap">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bold', 'orderEmailBodyEditor')" title="Bold"><b>B</b></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('italic', 'orderEmailBodyEditor')" title="Italic"><i>I</i></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('underline', 'orderEmailBodyEditor')" title="Underline"><u>U</u></button>
                        <span style="border-left:1px solid #ccc;margin:0 4px"></span>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('heading', 'orderEmailBodyEditor')" title="Heading">H</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bullet', 'orderEmailBodyEditor')" title="Bullet List">‚Ä¢</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('link', 'orderEmailBodyEditor')" title="Add Link">üîó</button>
                    </div>
                    <div id="orderEmailBodyEditor" contenteditable="true" class="form-input rich-text-editor" style="min-height:200px;font-size:12px;line-height:1.6;overflow-y:auto;white-space:pre-wrap"></div>
                    <textarea class="form-input" id="orderEmailBody" style="display:none"></textarea>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                    <input type="text" class="form-input" id="newTemplateName" placeholder="Template name..." style="flex:1;font-size:11px">
                    <button class="btn btn-sm btn-secondary" onclick="saveEmailTemplate()">üíæ Save Template</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orderEmail')">Cancel</button>
                <button class="btn btn-secondary" onclick="previewOrderEmail()">üëÅ Preview</button>
                <button class="btn btn-primary" onclick="sendOrderEmail()">Send Email</button>
            </div>
        </div>
    </div>
    
    <!-- Anniversary Email Modal (from Dashboard) -->
    <div class="modal-overlay" id="modal-anniversaryEmail">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">üíï Send Anniversary Email</h2><button class="modal-close" onclick="closeModal('anniversaryEmail')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="annEmail2ClientId">
                <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:12px">
                    <div style="font-weight:600" id="annEmail2BrideName">Bride Name</div>
                    <div style="font-size:11px;color:var(--taupe)" id="annEmail2Details">Celebrating 1st Anniversary</div>
                </div>
                <div class="form-group"><label class="form-label">To</label><input type="email" class="form-input" id="annEmail2To" readonly style="background:var(--cream)"></div>
                <div class="form-group"><label class="form-label">Subject</label><input type="text" class="form-input" id="annEmail2Subject"></div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <div class="email-toolbar" style="display:flex;gap:4px;margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:5px;flex-wrap:wrap">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bold', 'annEmail2BodyEditor')" title="Bold"><b>B</b></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('italic', 'annEmail2BodyEditor')" title="Italic"><i>I</i></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('underline', 'annEmail2BodyEditor')" title="Underline"><u>U</u></button>
                        <span style="border-left:1px solid #ccc;margin:0 4px"></span>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('heading', 'annEmail2BodyEditor')" title="Heading">H</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bullet', 'annEmail2BodyEditor')" title="Bullet List">‚Ä¢</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('link', 'annEmail2BodyEditor')" title="Add Link">üîó</button>
                    </div>
                    <div id="annEmail2BodyEditor" contenteditable="true" class="form-input rich-text-editor" style="min-height:200px;font-size:12px;line-height:1.6;overflow-y:auto;white-space:pre-wrap"></div>
                    <textarea class="form-input" id="annEmail2Body" style="display:none"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('anniversaryEmail')">Cancel</button>
                <button class="btn btn-secondary" onclick="previewAnniversaryEmail2()">üëÅ Preview</button>
                <button class="btn btn-primary" onclick="sendAnniversaryEmail2()">Send Email</button>
            </div>
        </div>
    </div>
    
    <!-- QA Checklist Modal -->
    <div class="modal-overlay" id="modal-qaChecklist">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h2 class="modal-title">‚úì QA Checklist</h2><button class="modal-close" onclick="closeModal('qaChecklist')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="qaOrderId">
                
                <!-- Order Info -->
                <div style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:16px">
                    <div style="font-weight:600;font-size:16px" id="qaClientName">Client Name</div>
                    <div style="font-size:12px;color:var(--taupe)" id="qaOrderInfo">PO# ¬∑ Dress ¬∑ Designer</div>
                </div>
                
                <!-- Checklist -->
                <div style="margin-bottom:16px">
                    <label style="display:flex;align-items:center;gap:10px;padding:12px;background:white;border:1px solid var(--champagne);border-radius:5px;margin-bottom:8px;cursor:pointer">
                        <input type="checkbox" id="qaCheck1" style="width:20px;height:20px">
                        <div>
                            <div style="font-weight:500">Correct dress/style received</div>
                            <div style="font-size:11px;color:var(--taupe)">Matches the ordered style number</div>
                        </div>
                    </label>
                    <label style="display:flex;align-items:center;gap:10px;padding:12px;background:white;border:1px solid var(--champagne);border-radius:5px;margin-bottom:8px;cursor:pointer">
                        <input type="checkbox" id="qaCheck2" style="width:20px;height:20px">
                        <div>
                            <div style="font-weight:500">Correct size</div>
                            <div style="font-size:11px;color:var(--taupe)">Size tag matches order</div>
                        </div>
                    </label>
                    <label style="display:flex;align-items:center;gap:10px;padding:12px;background:white;border:1px solid var(--champagne);border-radius:5px;margin-bottom:8px;cursor:pointer">
                        <input type="checkbox" id="qaCheck3" style="width:20px;height:20px">
                        <div>
                            <div style="font-weight:500">Correct color</div>
                            <div style="font-size:11px;color:var(--taupe)">Color matches order specifications</div>
                        </div>
                    </label>
                    <label style="display:flex;align-items:center;gap:10px;padding:12px;background:white;border:1px solid var(--champagne);border-radius:5px;margin-bottom:8px;cursor:pointer">
                        <input type="checkbox" id="qaCheck4" style="width:20px;height:20px">
                        <div>
                            <div style="font-weight:500">No damages or defects</div>
                            <div style="font-size:11px;color:var(--taupe)">No tears, stains, missing beading, etc.</div>
                        </div>
                    </label>
                    <label style="display:flex;align-items:center;gap:10px;padding:12px;background:white;border:1px solid var(--champagne);border-radius:5px;margin-bottom:8px;cursor:pointer">
                        <input type="checkbox" id="qaCheck5" style="width:20px;height:20px">
                        <div>
                            <div style="font-weight:500">Customizations correct</div>
                            <div style="font-size:11px;color:var(--taupe)">All requested modifications done</div>
                        </div>
                    </label>
                </div>
                
                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-input" id="qaNotes" placeholder="Any issues or observations..." style="min-height:60px"></textarea>
                </div>
                
                <!-- QA By -->
                <div class="form-group">
                    <label class="form-label">QA performed by</label>
                    <select class="form-input" id="qaPerformedBy">
                        <option value="">Select consultant...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer" style="justify-content:space-between">
                <button class="btn" onclick="flagQAIssue()" style="background:#e74c3c;color:white">‚ö†Ô∏è Flag Issue</button>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-secondary" onclick="closeModal('qaChecklist')">Cancel</button>
                    <button class="btn btn-primary" onclick="passQA()" style="background:#27ae60">‚úì QA Passed</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Order Modal (Quick order for veils, jewelry, etc.) -->
    <div class="modal-overlay" id="modal-addOrder">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h2 class="modal-title">+ Add Order</h2><button class="modal-close" onclick="closeModal('addOrder')">√ó</button></div>
            <div class="modal-body">
                <!-- Client Search/Select -->
                <div class="form-group">
                    <label class="form-label">Client</label>
                    <input type="text" class="form-input" id="newOrderClientSearch" placeholder="Search existing client or enter new name..." oninput="searchClientsForNewOrder(this.value)">
                    <div id="newOrderClientResults" style="max-height:120px;overflow-y:auto;margin-top:4px"></div>
                    <input type="hidden" id="newOrderClientId">
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="newOrderPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="newOrderEmail">
                    </div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--champagne);margin:16px 0">
                
                <!-- Items List -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <label class="form-label" style="margin:0;font-size:14px;font-weight:600">Items</label>
                    <button class="btn btn-sm btn-secondary" onclick="addNewOrderItem()">+ Add Item</button>
                </div>
                
                <div id="newOrderItemsList"></div>
                
                <hr style="border:none;border-top:1px solid var(--champagne);margin:16px 0">
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                    <div class="form-group">
                        <label class="form-label">PO #</label>
                        <input type="text" class="form-input" id="newOrderPO">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Order Date</label>
                        <input type="date" class="form-input" id="newOrderDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Wedding Date</label>
                        <input type="date" class="form-input" id="newOrderWedding">
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group">
                        <label class="form-label">Est. Arrival</label>
                        <input type="date" class="form-input" id="newOrderArrival">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="newOrderStatus">
                            <option value="pending submission">Pending Submission</option>
                            <option value="in production">In Production</option>
                            <option value="ready to ship">Ready to Ship</option>
                            <option value="shipped">Shipped</option>
                            <option value="arrived - pending QA">Arrived - Needs QA</option>
                        </select>
                    </div>
                </div>
                
                <!-- Order Submitted Tracking -->
                <div style="background:#f0f7ff;padding:12px;border-radius:5px;margin-bottom:16px;border-left:3px solid #3498db">
                    <div style="font-weight:600;font-size:12px;margin-bottom:8px">Order Submitted to Designer</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:11px">Submitted by</label>
                            <select class="form-input" id="newOrderSubmittedBy" style="font-size:12px">
                                <option value="">Not submitted yet</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:11px">Date submitted</label>
                            <input type="date" class="form-input" id="newOrderSubmittedDate" style="font-size:12px">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Customization</label>
                    <input type="text" class="form-input" id="newOrderCustomization" placeholder="e.g., Add beading, shorten straps">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Accessories</label>
                    <input type="text" class="form-input" id="newOrderAccessories" placeholder="e.g., Veil, belt">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="newOrderNotes" placeholder="Any special notes..." style="min-height:50px"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addOrder')">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewOrder()">üíæ Save Order</button>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div class="modal-overlay" id="modal-orderDetails">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h2 class="modal-title">üì¶ Order Details</h2><button class="modal-close" onclick="closeModal('orderDetails')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="editOrderId">
                <input type="hidden" id="editOrderClientId">
                
                <!-- Client Info -->
                <div style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:16px">
                    <div id="orderClientLinked" style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div>
                            <div style="font-weight:600;font-size:16px" id="orderDetailClient">Client Name</div>
                            <div style="font-size:11px;color:var(--taupe)" id="orderDetailContact">Phone / Email</div>
                            <div style="font-size:11px;margin-top:6px" id="orderDetailDates"></div>
                        </div>
                        <div style="display:flex;gap:6px">
                            <button class="btn btn-sm btn-secondary" onclick="openClientFromOrder()">View Client</button>
                            <button class="btn btn-sm btn-secondary" onclick="unlinkClientFromOrder()">Unlink</button>
                        </div>
                    </div>
                    <div id="orderClientNotLinked" style="display:none">
                        <div class="form-row" style="margin-bottom:8px">
                            <div class="form-group" style="flex:2">
                                <label class="form-label">Client Name</label>
                                <input type="text" class="form-input" id="editOrderClientName">
                            </div>
                            <div class="form-group" style="flex:1">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-input" id="editOrderPhone">
                            </div>
                        </div>
                        <div class="form-row" style="margin-bottom:8px">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="text" class="form-input" id="editOrderEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Wedding Date</label>
                                <input type="date" class="form-input" id="editOrderWedding">
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <input type="text" class="form-input" id="orderClientSearch" placeholder="Search to link existing client..." style="flex:1" oninput="searchClientsForOrder(this.value)">
                        </div>
                        <div id="orderClientSearchResults" style="max-height:120px;overflow-y:auto;margin-top:8px"></div>
                    </div>
                </div>
                
                <!-- Order Fields -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">PO Number</label>
                        <input type="text" class="form-input" id="editOrderPO">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Order Date</label>
                        <input type="date" class="form-input" id="editOrderDate">
                    </div>
                </div>
                
                <!-- Items Section -->
                <div id="orderItemsSection">
                    <div class="form-group">
                        <label class="form-label">Items <span id="orderItemCount" style="color:var(--taupe);font-weight:normal"></span></label>
                        <select class="form-input" id="editOrderItemSelect" onchange="selectOrderItem()" style="display:none">
                        </select>
                    </div>
                    <div id="orderItemDetails">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Dress / Item</label>
                                <input type="text" class="form-input" id="editOrderDress">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Designer</label>
                                <input type="text" class="form-input" id="editOrderDesigner">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Size</label>
                        <input type="text" class="form-input" id="editOrderSize">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editOrderStatus">
                            <option value="pending submission">pending submission</option>
                            <option value="in production">in production</option>
                            <option value="ready to ship">ready to ship</option>
                            <option value="shipped">shipped</option>
                            <option value="arrived - pending QA">arrived - needs QA</option>
                            <option value="QA complete">QA complete</option>
                            <option value="in alterations">in alterations</option>
                            <option value="picked up">picked up</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Est. Arrival (ETA)</label>
                    <input type="date" class="form-input" id="editOrderArrival">
                </div>
                
                <!-- Order Submitted Tracking -->
                <div style="background:#f0f7ff;padding:12px;border-radius:5px;margin-bottom:16px;border-left:3px solid #3498db">
                    <div style="font-weight:600;font-size:12px;margin-bottom:8px">üìã Order Submitted to Designer</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:11px">Submitted by</label>
                            <select class="form-input" id="editOrderSubmittedBy" style="font-size:12px">
                                <option value="">Not submitted yet</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label" style="font-size:11px">Date submitted</label>
                            <input type="date" class="form-input" id="editOrderSubmittedDate" style="font-size:12px">
                        </div>
                    </div>
                    <div id="orderSubmittedStatus" style="font-size:11px;margin-top:8px;color:var(--taupe)"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Customization</label>
                    <input type="text" class="form-input" id="editOrderCustomization" placeholder="e.g., Add beading, shorten straps">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Accessories</label>
                    <input type="text" class="form-input" id="editOrderAccessories" placeholder="e.g., Veil, belt">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Seamstress</label>
                    <input type="text" class="form-input" id="editOrderSeamstress">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="editOrderNotes" style="min-height:60px"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orderDetails')">Cancel</button>
                <button class="btn btn-primary" onclick="saveOrderDetails()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Anniversary Template Modal -->
    <div class="modal-overlay" id="modal-anniversaryTemplate">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">‚úèÔ∏è Edit Anniversary Template</h2><button class="modal-close" onclick="closeModal('anniversaryTemplate')">√ó</button></div>
            <div class="modal-body">
                <p style="font-size:11px;color:var(--taupe);margin-bottom:12px">Use these placeholders: <code>{{firstName}}</code>, <code>{{lastName}}</code>, <code>{{weddingDate}}</code>, <code>{{years}}</code>, <code>{{ordinal}}</code> (1st, 2nd, etc.)</p>
                <div class="form-group"><label class="form-label">Subject</label><input type="text" class="form-input" id="annTemplateSubject"></div>
                <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="annTemplateBody" style="min-height:250px;font-size:12px;line-height:1.6"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetAnniversaryTemplate()">Reset to Default</button>
                <button class="btn btn-primary" onclick="saveAnniversaryTemplate()">üíæ Save Template</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Bride Modal -->
    <div class="modal-overlay" id="modal-editBride">
        <div class="modal" style="max-width:400px">
            <div class="modal-header"><h2 class="modal-title">‚úèÔ∏è Edit Wedding Details</h2><button class="modal-close" onclick="closeModal('editBride')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="editBrideClientId">
                <div class="form-group"><label class="form-label">Bride Name</label><input type="text" class="form-input" id="editBrideName" readonly style="background:var(--cream)"></div>
                <div class="form-group"><label class="form-label">Wedding Date</label><input type="date" class="form-input" id="editBrideWeddingDate"></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="editBrideEmail"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('editBride')">Cancel</button><button class="btn btn-primary" onclick="saveBrideDetails()">Save</button></div>
        </div>
    </div>
    
    <!-- Add Measurement Modal -->
    <div class="modal-overlay" id="modal-addMeasurement">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h2 class="modal-title">üìè Add Measurements</h2><button class="modal-close" onclick="closeModal('addMeasurement')">√ó</button></div>
            <div class="modal-body">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                    <div class="form-group" style="margin:0"><label class="form-label">Date</label><input type="date" class="form-input" id="measDate" style="width:140px"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Taken By <span style="color:#e74c3c">*</span></label><select class="form-input" id="measTakenBy" style="width:140px"><option value="">Select...</option></select></div>
                    <div style="display:flex;align-items:center;gap:6px;font-size:11px">
                        <span>Unit:</span>
                        <button class="btn btn-sm" id="measUnitCm" onclick="setMeasModalUnit('cm')">CM</button>
                        <button class="btn btn-sm btn-secondary" id="measUnitIn" onclick="setMeasModalUnit('in')" style="background:var(--charcoal);color:white">Inches</button>
                    </div>
                </div>
                <div class="meas-grid">
                    <div class="meas-item"><div class="meas-label">Bust</div><input type="text" class="meas-input" id="measBust"><div class="meas-unit" data-meas-unit>in</div></div>
                    <div class="meas-item"><div class="meas-label">Cup Size</div><input type="text" class="meas-input" id="measCup" placeholder="e.g. 34C"></div>
                    <div class="meas-item"><div class="meas-label">Waist</div><input type="text" class="meas-input" id="measWaist"><div class="meas-unit" data-meas-unit>in</div></div>
                    <div class="meas-item"><div class="meas-label">Hip</div><input type="text" class="meas-input" id="measHip"><div class="meas-unit" data-meas-unit>in</div></div>
                    <div class="meas-item"><div class="meas-label">Height</div><input type="text" class="meas-input" id="measHeight"><div class="meas-unit">in</div></div>
                    <div class="meas-item"><div class="meas-label">Heels</div><input type="text" class="meas-input" id="measHeels"><div class="meas-unit">in</div></div>
                    <div class="meas-item"><div class="meas-label">Waist to Floor <span style="font-size:9px;color:var(--taupe)">(w/o heels)</span></div><input type="text" class="meas-input" id="measWaistToFloor"><div class="meas-unit" data-meas-unit>in</div></div>
                </div>
                <div style="margin-top:12px">
                    <div style="font-size:9px;letter-spacing:0.06em;text-transform:uppercase;color:var(--rose);margin-bottom:6px">Custom Measurements</div>
                    <div id="modalCustomMeasList"></div>
                    <div class="form-row" style="margin-top:6px">
                        <input type="text" class="form-input" id="modalCustomMeasName" placeholder="Name (e.g. Shoulder)">
                        <div style="display:flex;gap:4px">
                            <input type="text" class="form-input" id="modalCustomMeasValue" placeholder="Value" style="width:80px">
                            <button class="btn btn-sm btn-secondary" onclick="addModalCustomMeas()">+ Add</button>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top:12px"><label class="form-label">Notes</label><textarea class="form-input" id="measNotes" placeholder="e.g., Wearing spanx, with heels..." style="min-height:50px"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addMeasurement')">Cancel</button><button class="btn btn-primary" onclick="saveMeasurement()">Save Measurements</button></div>
        </div>
    </div>
    
    <!-- QA Checklist Modal -->
    
    <!-- Import from Timely Modal -->
    <div class="modal-overlay" id="modal-importTimely">
        <div class="modal" style="max-width:700px">
            <div class="modal-header"><h2 class="modal-title">üì• Import from Timely</h2><button class="modal-close" onclick="closeModal('importTimely')">√ó</button></div>
            <div class="modal-body">
                <div id="importStep1">
                    <p style="margin-bottom:12px;font-size:12px;color:var(--taupe)">Upload your Timely <strong>Schedule</strong> report (.xlsx). This will import clients and appointments automatically.</p>
                    <p style="margin-bottom:12px;font-size:11px;color:var(--sage)">üí° <a href="#" onclick="event.preventDefault();clearCacheAndReload()">Click here to refresh data</a> before importing to avoid duplicates.</p>
                    <div style="border:2px dashed var(--champagne);border-radius:8px;padding:30px;text-align:center;cursor:pointer" onclick="$('timelyFileInput').click()">
                        <div style="font-size:24px;margin-bottom:8px">üìÑ</div>
                        <div style="font-size:12px;color:var(--taupe)">Click to select Schedule.xlsx</div>
                        <input type="file" id="timelyFileInput" accept=".xlsx,.xls" style="display:none" onchange="parseTimelyFile(this)">
                    </div>
                    <div style="margin-top:16px">
                        <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.05em;color:var(--rose);margin-bottom:8px">Service Type Mapping</div>
                        <div id="serviceMappingList" style="font-size:11px;background:var(--cream);padding:10px;border-radius:5px">
                            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--champagne)"><span>Signature Bridal Consultation</span><span>‚Üí Consultation</span></div>
                            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--champagne)"><span>Bridal Fitting Appointment</span><span>‚Üí Fitting</span></div>
                            <div style="display:flex;justify-content:space-between;padding:4px 0"><span>Other services</span><span>‚Üí Consultation</span></div>
                        </div>
                    </div>
                </div>
                <div id="importStep2" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h3 style="margin:0;font-size:14px">Preview Import</h3>
                        <span id="importSummary" style="font-size:11px;color:var(--taupe)"></span>
                    </div>
                    <div style="max-height:350px;overflow-y:auto;border:1px solid var(--champagne);border-radius:5px">
                        <table class="table" style="font-size:11px">
                            <thead style="position:sticky;top:0;background:white"><tr><th>Action</th><th>Client</th><th>Date</th><th>Time</th><th>Type</th><th>Status</th></tr></thead>
                            <tbody id="importPreviewTable"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:12px;padding:10px;background:var(--blush);border-radius:5px;font-size:11px" id="importStats"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importTimely')">Cancel</button>
                <button class="btn btn-primary" id="btnConfirmImport" style="display:none" onclick="confirmTimelyImport()">‚úì Import All</button>
            </div>
        </div>
    </div>

    <!-- Email Templates Editor Modal -->
    <div class="modal-overlay" id="modal-templateEditor">
        <div class="modal" style="max-width:700px">
            <div class="modal-header">
                <h2 class="modal-title" id="templateEditorTitle">üìß Edit Email Template</h2>
                <button class="modal-close" onclick="closeModal('templateEditor')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="templateEditorType">
                
                <!-- Confirmation Template -->
                <div id="templateConfirmation" style="display:none">
                    <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                        <div style="font-weight:500;margin-bottom:8px">Available Placeholders:</div>
                        <div style="font-size:11px;display:flex;flex-wrap:wrap;gap:8px">
                            <code style="background:white;padding:2px 6px;border-radius:3px">{{firstName}}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{{lastName}}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{{appointmentDate}}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{{appointmentTime}}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{{appointmentType}}</code>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Body</label>
                        <textarea class="form-input" id="templateConfirmBody" style="min-height:300px;font-size:12px;line-height:1.6;font-family:monospace"></textarea>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" onclick="resetTemplate('confirmation')">Reset to Default</button>
                        <button class="btn btn-primary" onclick="saveTemplate('confirmation')">üíæ Save Template</button>
                    </div>
                </div>
                
                <!-- Anniversary Template -->
                <div id="templateAnniversary" style="display:none">
                    <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                        <div style="font-weight:500;margin-bottom:8px">Available Placeholders:</div>
                        <div style="font-size:11px;display:flex;flex-wrap:wrap;gap:8px">
                            <code style="background:white;padding:2px 6px;border-radius:3px">{firstName}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{years}</code>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject Line</label>
                        <input type="text" class="form-input" id="templateAnnSubject">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Body</label>
                        <textarea class="form-input" id="templateAnnBody" style="min-height:250px;font-size:12px;line-height:1.6;font-family:monospace"></textarea>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" onclick="resetTemplate('anniversary')">Reset to Default</button>
                        <button class="btn btn-primary" onclick="saveTemplate('anniversary')">üíæ Save Template</button>
                    </div>
                </div>
                
                <!-- Follow-up Template -->
                <div id="templateFollowup" style="display:none">
                    <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                        <div style="font-weight:500;margin-bottom:8px">Available Placeholders:</div>
                        <div style="font-size:11px;display:flex;flex-wrap:wrap;gap:8px">
                            <code style="background:white;padding:2px 6px;border-radius:3px">{firstName}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{appointmentType}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{appointmentDate}</code>
                            <code style="background:white;padding:2px 6px;border-radius:3px">{topOptions}</code>
                        </div>
                        <div style="font-size:10px;color:var(--taupe);margin-top:8px">Note: {topOptions} will show the client's starred/favorite dresses if any</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject Line</label>
                        <input type="text" class="form-input" id="templateFollowupSubject">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Body</label>
                        <textarea class="form-input" id="templateFollowupBody" style="min-height:250px;font-size:12px;line-height:1.6;font-family:monospace"></textarea>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" onclick="resetTemplate('followup')">Reset to Default</button>
                        <button class="btn btn-primary" onclick="saveTemplate('followup')">üíæ Save Template</button>
                    </div>
                </div>
                
                <!-- Order Templates -->
                <div id="templateOrder" style="display:none">
                    <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                        <div style="font-weight:500;margin-bottom:8px">Available Placeholders:</div>
                        <div style="font-size:11px;display:flex;flex-wrap:wrap;gap:8px">
                            <code style="background:white;padding:2px 6px;border-radius:3px">{firstName}</code>
                        </div>
                        <div style="font-size:10px;color:var(--taupe);margin-top:8px">Tip: Create templates for common updates like "Dress Arrived", "Ready for Pickup", etc.</div>
                    </div>
                    
                    <div style="margin-bottom:16px">
                        <div style="font-weight:500;margin-bottom:8px">Saved Templates</div>
                        <div id="orderTemplatesList"></div>
                    </div>
                    
                    <div style="border-top:1px solid var(--champagne);padding-top:16px">
                        <div style="font-weight:500;margin-bottom:8px">Add New Template</div>
                        <div class="form-group">
                            <label class="form-label">Template Name</label>
                            <input type="text" class="form-input" id="newOrderTemplateName" placeholder="e.g., Dress Arrived">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject Line</label>
                            <input type="text" class="form-input" id="newOrderTemplateSubject" placeholder="e.g., Great news about your order!">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Body</label>
                            <textarea class="form-input" id="newOrderTemplateBody" style="min-height:150px;font-size:12px;line-height:1.6" placeholder="Hi {firstName},&#10;&#10;Your dress has arrived!..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="addOrderTemplate()">+ Add Template</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QA Checklist Modal -->
    <div class="modal-overlay" id="modal-qa">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h2 class="modal-title">üìã QA Checklist</h2><button class="modal-close" onclick="closeModal('qa')">√ó</button></div>
            <div class="modal-body">
                <div id="qaClientInfo" style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:16px"></div>
                <div id="qaChecklist"></div>
                <div class="form-group" style="margin-top:16px">
                    <label class="form-label">QA Notes</label>
                    <textarea class="form-input" id="qaNotes" placeholder="Any issues found, notes for alterations, etc." style="min-height:80px"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Checked By</label>
                    <select class="form-input" id="qaConsultant">
                        <option value="">Select consultant...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('qa')">Cancel</button>
                <button class="btn btn-primary" onclick="submitQaChecklist()">‚úì Complete QA</button>
            </div>
        </div>
    </div>

    <!-- Initial Signature Modal -->
    <div class="modal-overlay" id="modal-initialSig" style="z-index:10001">
        <div class="modal" style="max-width:400px">
            <div class="modal-header"><h2 class="modal-title">‚úçÔ∏è Sign Initials</h2><button class="modal-close" onclick="closeModal('initialSig')">√ó</button></div>
            <div class="modal-body" style="text-align:center">
                <p style="font-size:12px;color:var(--taupe);margin-bottom:12px">Use your finger or stylus to sign your initials</p>
                <canvas id="initialSigPad" width="300" height="150" style="border:2px solid var(--dusty);border-radius:8px;background:white;touch-action:none;cursor:crosshair"></canvas>
                <div style="margin-top:8px">
                    <button class="btn btn-sm btn-secondary" onclick="clearInitialSig()">Clear</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('initialSig')">Cancel</button>
                <button class="btn btn-primary" onclick="applyInitialSig()">‚úì Apply to All</button>
            </div>
        </div>
    </div>

    <!-- Choice Dialog -->
    <div class="modal-overlay" id="modal-choice" style="z-index:10001">
        <div class="modal" style="max-width:400px">
            <div class="modal-header"><h2 class="modal-title" id="choiceTitle">Choose an option</h2><button class="modal-close" onclick="closeModal('choice'); if(window._choiceReject) window._choiceReject();">√ó</button></div>
            <div class="modal-body">
                <p id="choiceMessage" style="margin-bottom:16px"></p>
                <div id="choiceInput" style="display:none;margin-bottom:16px">
                    <input type="text" class="form-input" id="choiceInputField" style="width:100%">
                </div>
                <div id="choiceButtons" style="display:flex;flex-direction:column;gap:10px"></div>
            </div>
        </div>
    </div>

    <!-- She Said Yes -->
    <div class="modal-overlay" id="modal-yes">
        <div class="modal full">
            <div class="modal-header"><h2 class="modal-title">üíç She Said Yes!</h2><button class="modal-close" onclick="closeYesModal()">√ó</button></div>
            <div class="modal-body">
                <div class="steps">
                    <div class="step active" id="ys1" onclick="goToStep(1)" style="cursor:pointer"><span class="step-num">1</span><div class="step-label">Measurements</div></div>
                    <div class="step" id="ys2" onclick="goToStep(2)" style="cursor:pointer"><span class="step-num">2</span><div class="step-label">Order</div></div>
                    <div class="step" id="ys3" onclick="goToStep(3)" style="cursor:pointer"><span class="step-num">3</span><div class="step-label">Photos</div></div>
                    <div class="step" id="ys4" onclick="goToStep(4)" style="cursor:pointer"><span class="step-num">4</span><div class="step-label">Contract</div></div>
                    <div class="step" id="ys5" onclick="goToStep(5)" style="cursor:pointer"><span class="step-num">5</span><div class="step-label">Signature</div></div>
                    <div class="step" id="ys6" onclick="goToStep(6)" style="cursor:pointer"><span class="step-num">6</span><div class="step-label">Email</div></div>
                </div>
                <div id="yStep1">
                    <div id="savedMeasurementsSelector" style="display:none;margin-bottom:12px;padding:12px;background:var(--blush);border-radius:5px">
                        <div style="font-size:11px;font-weight:600;margin-bottom:6px">üìè Load from saved measurements:</div>
                        <select class="form-input" id="selectSavedMeasurement" onchange="loadSavedMeasurement()">
                            <option value="">‚Äî Enter manually ‚Äî</option>
                        </select>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <div class="form-group" style="margin:0;flex:1;max-width:200px">
                            <label class="form-label" style="font-size:10px">Measured by <span style="color:#e74c3c">*</span></label>
                            <select class="form-input" id="mTakenBy" style="padding:6px 8px;font-size:11px">
                                <option value="">Select consultant...</option>
                            </select>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;font-size:11px">
                            <span>Unit:</span>
                            <button class="btn btn-sm btn-secondary" id="unitCm" onclick="setMeasUnit('cm')">CM</button>
                            <button class="btn btn-sm" id="unitIn" onclick="setMeasUnit('in')" style="background:var(--charcoal);color:white">Inches</button>
                        </div>
                    </div>
                    <div class="meas-grid">
                        <div class="meas-item"><div class="meas-label">Bust</div><input type="text" class="meas-input" id="mBust"><div class="meas-unit" data-unit>in</div></div>
                        <div class="meas-item"><div class="meas-label">Cup Size</div><input type="text" class="meas-input" id="mCup" placeholder="e.g. 34C"></div>
                        <div class="meas-item"><div class="meas-label">Waist</div><input type="text" class="meas-input" id="mWaist"><div class="meas-unit" data-unit>in</div></div>
                        <div class="meas-item"><div class="meas-label">Hip</div><input type="text" class="meas-input" id="mHip"><div class="meas-unit" data-unit>in</div></div>
                        <div class="meas-item"><div class="meas-label">Height</div><input type="text" class="meas-input" id="mHeight"><div class="meas-unit">in</div></div>
                        <div class="meas-item"><div class="meas-label">Heels</div><input type="text" class="meas-input" id="mHeels"><div class="meas-unit">in</div></div>
                        <div class="meas-item"><div class="meas-label">Waist to Floor <span style="font-size:9px;color:var(--taupe)">(w/o heels)</span></div><input type="text" class="meas-input" id="mWaistToFloor"><div class="meas-unit" data-unit>in</div></div>
                    </div>
                    <div style="margin-top:12px">
                        <div style="font-size:9px;letter-spacing:0.06em;text-transform:uppercase;color:var(--rose);margin-bottom:6px">Custom Measurements</div>
                        <div id="customMeasList"></div>
                        <div class="form-row" style="margin-top:6px">
                            <input type="text" class="form-input" id="customMeasName" placeholder="Name (e.g. Shoulder)">
                            <div style="display:flex;gap:4px">
                                <input type="text" class="form-input" id="customMeasValue" placeholder="Value" style="width:80px">
                                <button class="btn btn-sm btn-secondary" onclick="addCustomMeas()">+ Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:12px"><label class="form-label">Measurement Notes</label><textarea class="form-input" id="mNotes"></textarea></div>
                    <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--champagne);display:flex;justify-content:flex-end">
                        <button class="btn btn-secondary" onclick="saveMeasurementsFromSayYes()" style="font-size:12px">üíæ Save Measurements to Client</button>
                    </div>
                </div>
                <div id="yStep2" style="display:none">
                    <!-- Order Details (PO, ETA) -->
                    <div style="background:var(--blush);padding:14px;border-radius:8px;margin-bottom:16px">
                        <div style="font-size:11px;font-weight:600;color:var(--taupe);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.05em">üìã Order Details</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">PO Number</label>
                                <input type="text" class="form-input" id="oiPO" placeholder="Auto-generated" style="background:#fff">
                                <div style="font-size:10px;color:var(--taupe);margin-top:4px">Leave blank to auto-generate</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Est. Arrival Date</label>
                                <input type="date" class="form-input" id="oiArrivalDate" style="background:#fff">
                                <div style="font-size:10px;color:var(--taupe);margin-top:4px" id="arrivalDateHint">Enter expected arrival date</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div>
                            <div class="form-group">
                                <label class="form-label">Item Type</label>
                                <select class="form-input" id="oiType" onchange="toggleOrderItemFields()">
                                    <option value="dress">Dress (from designer)</option>
                                    <option value="accessory">Accessory (from designer)</option>
                                    <option value="inhouse">In-House Item (veil, overskirt, etc.)</option>
                                    <option value="customization">Customization (add to existing item)</option>
                                    <option value="fee">Fee (shipping, rush, etc.)</option>
                                    <option value="discount">Discount</option>
                                    <option value="custom">Custom Item</option>
                                </select>
                            </div>
                            
                            <!-- Designer Items (dress/accessory) -->
                            <div id="oiDesignerFields">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Designer</label>
                                        <select class="form-input" id="oiDesignerSelect" onchange="handleDesignerSelect()">
                                            <option value="">Select designer...</option>
                                        </select>
                                        <input type="text" class="form-input" id="oiDesigner" style="display:none;margin-top:6px" placeholder="Enter designer name">
                                    </div>
                                    <div class="form-group"><label class="form-label">Style/Name</label><input type="text" class="form-input" id="oiStyle"></div>
                                </div>
                                <div class="form-row-3">
                                    <div class="form-group"><label class="form-label">Size</label><input type="text" class="form-input" id="oiSize"></div>
                                    <div class="form-group"><label class="form-label">Color</label><input type="text" class="form-input" id="oiColor"></div>
                                    <div class="form-group"><label class="form-label">Price</label><input type="text" class="form-input" id="oiPrice" placeholder="$0" oninput="formatPriceInput(this)"></div>
                                </div>
                            </div>
                            
                            <!-- In-House Items -->
                            <div id="oiInhouseFields" style="display:none">
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Item Name</label><input type="text" class="form-input" id="oiInhouseName" placeholder="e.g. Cathedral Veil, Overskirt"></div>
                                    <div class="form-group"><label class="form-label">Price</label><input type="text" class="form-input" id="oiInhousePrice" placeholder="$0" oninput="formatPriceInput(this)"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Production Notes</label>
                                    <textarea class="form-input" id="oiInhouseNotes" style="min-height:60px" placeholder="e.g. Seamstress to confirm length at first fitting, bride wants cathedral with blusher"></textarea>
                                </div>
                            </div>
                            
                            <!-- Customization -->
                            <div id="oiCustomFields" style="display:none">
                                <div class="form-group">
                                    <label class="form-label">Attach to Item</label>
                                    <select class="form-input" id="oiCustomParent">
                                        <option value="">Select item...</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Customization</label><input type="text" class="form-input" id="oiCustomName" placeholder="e.g. Add beading to bodice"></div>
                                    <div class="form-group"><label class="form-label">Price</label><input type="text" class="form-input" id="oiCustomPrice" placeholder="$0" oninput="formatPriceInput(this)"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Delivery</label>
                                    <div style="display:flex;gap:12px;margin-top:4px">
                                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer">
                                            <input type="radio" name="oiCustomDelivery" value="ondress" checked> On the dress
                                        </label>
                                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer">
                                            <input type="radio" name="oiCustomDelivery" value="separate"> Sent separately
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fee -->
                            <div id="oiFeeFields" style="display:none">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Fee Type</label>
                                        <select class="form-input" id="oiFeeType" onchange="toggleRushOptions()">
                                            <option value="shipping">Shipping</option>
                                            <option value="rush">Rush Fee</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="oiFeeAmountGroup">
                                        <label class="form-label">Amount</label>
                                        <input type="text" class="form-input" id="oiFeePrice" placeholder="$0" oninput="formatPriceInput(this)">
                                    </div>
                                </div>
                                <!-- Rush Fee Options (shown when rush is selected) -->
                                <div id="oiRushOptions" style="display:none">
                                    <div style="display:flex;gap:12px;margin-bottom:10px">
                                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer">
                                            <input type="radio" name="oiRushType" value="fixed" checked onchange="toggleRushType()"> Fixed Amount
                                        </label>
                                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer">
                                            <input type="radio" name="oiRushType" value="percent" onchange="toggleRushType()"> Percentage
                                        </label>
                                    </div>
                                    <div id="oiRushPercentGroup" style="display:none">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Percentage</label>
                                                <div style="display:flex;align-items:center;gap:4px">
                                                    <input type="number" class="form-input" id="oiRushPercent" placeholder="15" style="width:80px" min="0" max="100">
                                                    <span>%</span>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Apply To</label>
                                                <select class="form-input" id="oiRushApplyTo">
                                                    <option value="all">Entire Order</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="oiRushCalculated" style="font-size:11px;color:var(--taupe);margin-top:4px"></div>
                                    </div>
                                </div>
                                <div class="form-group"><label class="form-label">Note</label><input type="text" class="form-input" id="oiFeeNote" placeholder="e.g. Express shipping from Italy"></div>
                            </div>
                            
                            <!-- Discount -->
                            <div id="oiDiscountFields" style="display:none">
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Discount Reason</label><input type="text" class="form-input" id="oiDiscountName" placeholder="e.g. Sample sale, Loyalty discount"></div>
                                    <div class="form-group"><label class="form-label">Amount</label><input type="text" class="form-input" id="oiDiscountAmount" placeholder="$0" oninput="formatPriceInput(this)"></div>
                                </div>
                                <div style="font-size:10px;color:var(--taupe);margin-top:-8px;margin-bottom:8px">Enter the discount amount as a positive number (e.g. $200 for $200 off)</div>
                            </div>
                            
                            <!-- Custom Item -->
                            <div id="oiCustomItemFields" style="display:none">
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Item Name</label><input type="text" class="form-input" id="oiCustomItemName" placeholder="e.g. Alteration deposit, Special request"></div>
                                    <div class="form-group"><label class="form-label">Price</label><input type="text" class="form-input" id="oiCustomItemPrice" placeholder="$0" oninput="formatPriceInput(this)"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description (optional)</label>
                                    <textarea class="form-input" id="oiCustomItemDesc" style="min-height:50px" placeholder="Any additional details..."></textarea>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addOrderItem()" style="width:100%;margin-top:12px">+ Add Item</button>
                        </div>
                        <div>
                            <div style="font-size:9px;letter-spacing:0.06em;text-transform:uppercase;color:var(--rose);margin-bottom:6px">Order Summary</div>
                            <div id="orderItems" style="max-height:300px;overflow-y:auto"></div>
                            <div style="margin:10px 0">
                                <div style="display:flex;align-items:center;gap:8px;font-size:11px">
                                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                                        <input type="radio" name="taxOption" value="hst" id="taxHst" onchange="updateTaxOption()" checked> 13% HST
                                    </label>
                                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                                        <input type="radio" name="taxOption" value="custom" id="taxCustom" onchange="updateTaxOption()"> 
                                        <input type="number" class="form-input" id="customTaxRate" style="width:50px;padding:2px 4px;font-size:11px" placeholder="%" oninput="updateTaxOption()" onclick="$('taxCustom').checked=true;updateTaxOption()">%
                                    </label>
                                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                                        <input type="radio" name="taxOption" value="none" id="taxNone" onchange="updateTaxOption()"> No Tax
                                    </label>
                                </div>
                            </div>
                            <div id="orderSubtotal" style="display:none;font-size:11px;padding:6px 0;border-top:1px solid var(--champagne)"></div>
                            <div id="orderHstRow" style="display:none;font-size:11px;padding:6px 0"></div>
                            <div class="order-total"><span>Total</span><span class="order-total-value" id="orderTotal">$0</span></div>
                            <div class="form-group" style="margin-top:12px"><label class="form-label">Order Notes</label><textarea class="form-input" id="oiDetails" style="min-height:40px" placeholder="General notes about this order..."></textarea></div>
                        </div>
                    </div>
                </div>
                <div id="yStep3" style="display:none">
                    <p style="font-size:11px;color:var(--rose);margin-bottom:12px">üì∏ <b>Sample Fitting Photos</b> - Upload photos of the bride wearing the sample dress. These photos help the designer with sizing and can be used as reference.</p>
                    
                    <div style="background:#e8f4ea;border-left:3px solid var(--sage);padding:10px 12px;border-radius:4px;margin-bottom:16px;font-size:11px;color:#2d5a3d">
                        üí° <b>Optional:</b> Photos are helpful but not required to proceed.
                    </div>
                    
                    <div style="border:2px dashed var(--champagne);border-radius:8px;padding:30px;text-align:center;margin-bottom:16px;cursor:pointer;transition:all 0.2s" id="photoDropZone" onclick="$('photoInput').click()">
                        <div style="font-size:32px;margin-bottom:8px">üëó</div>
                        <div style="font-size:12px;color:var(--taupe)">Click to select fitting photos</div>
                        <div style="font-size:10px;color:var(--rose);margin-top:4px">Front, back, side views recommended</div>
                        <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotoSelect(event)">
                    </div>
                    
                    <div id="photoPreviewGrid" class="photo-grid" style="margin-bottom:16px"></div>
                    
                    <div id="photoUploadStatus" style="display:none;padding:10px;background:var(--blush);border-radius:5px;font-size:11px;margin-bottom:12px">
                        <span id="photoUploadText">Uploading photos...</span>
                    </div>
                    
                    <p style="font-size:10px;color:var(--taupe)">üí° These photos will be saved to the client profile and order details for easy reference when working with the designer.</p>
                </div>
                <div id="yStep4" style="display:none">
                    <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
                        <button class="btn btn-secondary" onclick="downloadContractPdf()" style="font-size:11px">üìÑ Download PDF</button>
                    </div>
                    <div class="contract" id="contractPreview" style="max-height:60vh;overflow-y:auto;font-size:12px;padding:20px"></div>
                </div>
                <div id="yStep5" style="display:none">
                    <div style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--champagne)">
                        <button class="btn btn-secondary" onclick="generateBlankContract()" style="width:100%">üìÑ Download Unsigned Contract</button>
                        <p style="font-size:10px;color:var(--taupe);margin:6px 0 0 0;text-align:center">PDF with consultant signature, without client signature</p>
                    </div>
                    
                    <div class="grid-2">
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:6px">Consultant <span style="color:#e74c3c">*</span></p>
                            <select class="form-input" id="yConsultantSelect" onchange="loadConsultantSignature()"><option value="">Select...</option></select>
                            <div class="form-group" style="margin-top:8px"><label class="form-label">Contract Date</label><input type="date" class="form-input" id="yDate"></div>
                        </div>
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:6px">Client Initials</p>
                            <p style="font-size:9px;color:var(--taupe);margin-bottom:6px">For digital signing only</p>
                            <div id="measInitials" style="background:var(--cream);padding:8px;border-radius:5px;font-size:11px"></div>
                        </div>
                    </div>
                    
                    <div class="grid-2" style="margin-top:16px">
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:6px">Customer Signature</p>
                            <canvas id="sigPad" class="sig-pad" width="280" height="100"></canvas>
                            <button class="btn btn-sm btn-secondary" onclick="clearSig('customer')" style="margin-top:4px">Clear</button>
                        </div>
                        <div>
                            <p style="font-size:11px;font-weight:600;margin-bottom:6px">Consultant Signature</p>
                            <p style="font-size:9px;color:var(--taupe);margin-bottom:4px" id="consultantSigNote">Select consultant to load</p>
                            <canvas id="sigPadConsultant" class="sig-pad" width="280" height="100"></canvas>
                            <button class="btn btn-sm btn-secondary" onclick="clearSig('consultant')" style="margin-top:4px">Clear</button>
                        </div>
                    </div>
                </div>
                <div id="yStep6" style="display:none">
                    <div style="background:var(--blush);padding:12px;border-radius:8px;margin-bottom:12px">
                        <p style="font-size:11px;font-weight:600;margin:0 0 6px 0">üìß Email Contract to Client</p>
                        <p style="font-size:10px;color:var(--taupe);margin:0">Review and send, or use "Save Order" if client signed on paper.</p>
                    </div>
                    <div class="form-group"><label class="form-label">To</label><input type="email" class="form-input" id="emailTo" readonly style="background:#f5f5f5"></div>
                    <div class="form-group"><label class="form-label">Subject</label><input type="text" class="form-input" id="emailSubject"></div>
                    <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="emailBody" style="min-height:120px;font-size:11px;line-height:1.5"></textarea></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="yPrev" onclick="yPrev()" style="display:none">‚Üê Back</button>
                <button class="btn btn-secondary" id="ySaveDraft" onclick="saveDraft()" title="Save and continue later">üíæ Save Draft</button>
                <div style="flex:1"></div>
                <button class="btn btn-primary" id="yNext" onclick="yNext()">Next ‚Üí</button>
                <button class="btn btn-secondary" id="ySaveOnly" onclick="saveOrderOnly()" style="display:none" title="Save order without emailing">üíæ Save Order</button>
                <button class="btn btn-primary" id="yGmail" onclick="openContractInGmail()" style="display:none">üìß Gmail</button>
                <button class="btn btn-success" id="yDone" onclick="sendContractEmail()" style="display:none">üì§ Send</button>
            </div>
        </div>
    </div>

    <!-- Floating Back Button -->
    <button class="floating-back" id="floatingBack" onclick="goBack()">‚Üê</button>
    
    <div class="toast" id="toast"></div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ========== CONFIG ==========
        const API_URL = 'https://script.google.com/macros/s/AKfycbxh6qeTRhQI047aN28it9f-BgKdUNkc1zW793oVrLuvuEs2yoJVScuvhp-xhKoVxCZbEA/exec';

        // ========== DATA ==========
        const CACHE_KEY = 'estrelle_data_cache';
        let data = { clients: [], appointments: [], topoptions: [], orders: [], alterations: [], designers: [], consultants: [], visitnotes: [], announcements: [] };
        let currentClient = null;
        let currentOrder = { items: [], measurements: {} };
        let editingDesigner = null;
        let originalClientNotes = { style: '', notes: '', budget: '' };
        
        // ========== UNDO SYSTEM ==========
        let undoStack = [];
        const MAX_UNDO = 20;
        
        function addUndo(action) {
            undoStack.push(action);
            if (undoStack.length > MAX_UNDO) undoStack.shift();
        }
        
        async function performUndo() {
            if (undoStack.length === 0) {
                toast('Nothing to undo', 'error');
                return;
            }
            
            const action = undoStack.pop();
            
            try {
                if (action.type === 'delete_client') {
                    // Re-add client
                    const result = await api('POST', { action: 'add', sheet: 'Clients', record: action.record });
                    action.record.ID = result.id || action.record.ID;
                    data.clients.push(action.record);
                    renderClients();
                    renderDash();
                    toast('Client restored!', 'success');
                    
                } else if (action.type === 'delete_appointment') {
                    // Re-add appointment
                    const result = await api('POST', { action: 'add', sheet: 'Appointments', record: action.record });
                    action.record.ID = result.id || action.record.ID;
                    data.appointments.push(action.record);
                    renderAllAppointments();
                    renderWeek();
                    renderDash();
                    toast('Appointment restored!', 'success');
                    
                } else if (action.type === 'mark_followup_done') {
                    // Undo mark done
                    await api('POST', { action: 'update', sheet: 'Appointments', id: action.id, updates: { FollowUpDone: false } });
                    const appt = data.appointments.find(a => a.ID == action.id);
                    if (appt) appt.FollowUpDone = false;
                    renderDash();
                    toast('Follow-up restored!', 'success');
                    
                } else if (action.type === 'edit_client') {
                    // Restore previous client data
                    await api('POST', { action: 'update', sheet: 'Clients', id: action.id, updates: action.previous });
                    const client = data.clients.find(c => c.ID == action.id);
                    if (client) Object.assign(client, action.previous);
                    renderClients();
                    if (currentClient && currentClient.ID == action.id) {
                        currentClient = data.clients.find(c => c.ID == action.id);
                        openClient(action.id);
                    }
                    toast('Client changes undone!', 'success');
                    
                } else if (action.type === 'edit_appointment') {
                    // Restore previous appointment data
                    await api('POST', { action: 'update', sheet: 'Appointments', id: action.id, updates: action.previous });
                    const appt = data.appointments.find(a => a.ID == action.id);
                    if (appt) Object.assign(appt, action.previous);
                    renderAllAppointments();
                    renderWeek();
                    renderDash();
                    toast('Appointment changes undone!', 'success');
                    
                } else if (action.type === 'bulk_delete_clients') {
                    // Re-add all deleted clients
                    for (const record of action.records) {
                        const result = await api('POST', { action: 'add', sheet: 'Clients', record: record });
                        record.ID = result.id || record.ID;
                        data.clients.push(record);
                    }
                    renderClients();
                    renderDash();
                    toast(`${action.records.length} clients restored!`, 'success');
                    
                } else if (action.type === 'bulk_delete_appointments') {
                    // Re-add all deleted appointments
                    for (const record of action.records) {
                        const result = await api('POST', { action: 'add', sheet: 'Appointments', record: record });
                        record.ID = result.id || record.ID;
                        data.appointments.push(record);
                    }
                    renderAllAppointments();
                    renderWeek();
                    renderDash();
                    toast(`${action.records.length} appointments restored!`, 'success');
                    
                } else if (action.type === 'delete_order') {
                    // Re-add order
                    const result = await api('POST', { action: 'add', sheet: 'Orders', record: action.record });
                    action.record.ID = result.id || action.record.ID;
                    data.orders.push(action.record);
                    
                    // Restore alteration data
                    if (action.alts && action.record.ClientID) {
                        if (action.alts.items) localStorage.setItem(`alts_${action.record.ClientID}`, action.alts.items);
                        if (action.alts.notes) localStorage.setItem(`alts_notes_${action.record.ClientID}`, action.alts.notes);
                        if (action.alts.neededby) localStorage.setItem(`alts_neededby_${action.record.ClientID}`, action.alts.neededby);
                    }
                    
                    renderOrders();
                    renderAlts();
                    toast('Order restored!', 'success');
                    
                } else if (action.type === 'picked_up') {
                    // Undo picked up - restore previous statuses
                    if (action.orderId && action.previousOrderStatus) {
                        const order = data.orders.find(o => o.ID == action.orderId);
                        if (order) {
                            order.Status = action.previousOrderStatus;
                            await updateRecord('Orders', action.orderId, { Status: action.previousOrderStatus });
                        }
                    }
                    
                    if (action.altRecordId && action.previousAltStatus) {
                        const altRecord = data.alterations?.find(a => a.ID == action.altRecordId);
                        if (altRecord) {
                            altRecord.Status = action.previousAltStatus;
                            await updateRecord('Alterations', action.altRecordId, { Status: action.previousAltStatus });
                        }
                    }
                    
                    renderOrders();
                    renderAlts();
                    toast(`${action.clientName} restored to alterations!`, 'success');
                    
                } else if (action.type === 'delete_topoption') {
                    // Re-add top option
                    const result = await api('POST', { action: 'add', sheet: 'TopOptions', record: action.record });
                    action.record.ID = result.id || action.record.ID;
                    data.topoptions.push(action.record);
                    renderClientOptions();
                    toast('Option restored!', 'success');
                    
                } else if (action.type === 'delete_alteration') {
                    // Re-add alteration
                    const result = await api('POST', { action: 'add', sheet: 'Alterations', record: action.record });
                    action.record.ID = result.id || action.record.ID;
                    data.alterations.push(action.record);
                    
                    // Restore localStorage data
                    if (action.localData && action.record.ClientID) {
                        if (action.localData.items) localStorage.setItem(`alts_${action.record.ClientID}`, action.localData.items);
                        if (action.localData.notes) localStorage.setItem(`alts_notes_${action.record.ClientID}`, action.localData.notes);
                        if (action.localData.neededby) localStorage.setItem(`alts_neededby_${action.record.ClientID}`, action.localData.neededby);
                    }
                    
                    renderAlts();
                    toast('Alteration restored!', 'success');
                    
                } else if (action.type === 'delete_measurement') {
                    // Restore deleted measurement
                    await undoDeleteMeasurement(action.clientId, action.measurement, action.idx);
                }
                
                saveCachedData();
                
            } catch (err) {
                console.error('Undo failed:', err);
                toast('Undo failed: ' + err.message, 'error');
                // Put action back on stack
                undoStack.push(action);
            }
        }

        // ========== HELPERS ==========
        const $ = id => document.getElementById(id);
        const fmtTime = t => {
            if (!t) return '';
            // Handle Google Sheets time serial numbers (fraction of day, value < 1)
            if (typeof t === 'number' && t < 1) {
                const totalMinutes = Math.round(t * 24 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
            }
            // Handle ISO datetime strings from Google Sheets (e.g., "1899-12-30T12:15:00.000Z")
            // Google Sheets returns times with fake date 1899-12-30 in UTC
            // We need to extract the time WITHOUT timezone conversion
            const str = String(t);
            if (str.includes('T')) {
                // Get the time part before any timezone indicator
                const timePart = str.split('T')[1];
                if (timePart) {
                    // Extract HH:MM directly from the string (ignore Z suffix to avoid timezone shift)
                    const match = timePart.match(/^(\d{2}):(\d{2})/);
                    if (match) {
                        return `${match[1]}:${match[2]}`;
                    }
                }
            }
            // Handle Date objects - use UTC methods to avoid local timezone conversion
            if (t instanceof Date) {
                return `${t.getUTCHours().toString().padStart(2,'0')}:${t.getUTCMinutes().toString().padStart(2,'0')}`;
            }
            // Handle plain time strings like "12:15" or "12:15:00"
            if (/^\d{1,2}:\d{2}/.test(str)) {
                const parts = str.split(':');
                return `${parts[0].padStart(2,'0')}:${parts[1]}`;
            }
            return str.substring(0,5);
        };
        const today = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        };
        // Normalize appointment type display (handles Timely inconsistencies)
        const normalizeApptType = (type) => {
            if (!type) return 'Bridal Consultation';
            // Clean up: trim, remove trailing punctuation and extra spaces
            let cleaned = String(type).trim().replace(/[!?.,]+$/, '').replace(/\s+/g, ' ').trim();
            const lower = cleaned.toLowerCase();
            
            // Check if this type matches a user-configured service type (case-insensitive)
            const userTypes = getServiceTypes();
            const matchedUserType = userTypes.find(t => t.toLowerCase() === lower);
            if (matchedUserType) return matchedUserType;
            
            // Map common variations to standard names
            if (lower === 'consultation' || lower === 'bridal consultation' || lower === 'bridal') {
                return 'Bridal Consultation';
            }
            if (lower === 'fitting' || lower === 'bridal fitting') {
                return 'Fitting';
            }
            if (lower === 'final fitting' || lower === 'final') {
                return 'Final Fitting';
            }
            if (lower === 'alterations' || lower === 'alteration') {
                return 'Alterations';
            }
            if (lower === 'pickup' || lower === 'pick up' || lower === 'pick-up') {
                return 'Pickup';
            }
            if (lower === 'measurement' || lower === 'measurements') {
                return 'Measurement';
            }
            // Return cleaned value with title case
            return cleaned.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
        };
        const isToday = (d) => {
            if (!d) return false;
            const todayStr = today();
            if (typeof d === 'number') {
                const date = new Date((d - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0] === todayStr;
            }
            return String(d).split('T')[0] === todayStr;
        };
        const isThisWeek = (d) => {
            if (!d) return false;
            let dateObj;
            if (typeof d === 'number') {
                dateObj = new Date((d - 25569) * 86400 * 1000);
            } else {
                dateObj = new Date(String(d).split('T')[0] + 'T00:00:00');
            }
            const now = new Date();
            
            // Get Monday of current week
            const dayOfWeek = now.getDay(); // 0=Sun, 1=Mon, etc.
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // If Sunday, go back 6 days
            
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() + mondayOffset);
            startOfWeek.setHours(0, 0, 0, 0);
            
            // Get Sunday of current week
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return dateObj >= startOfWeek && dateObj <= endOfWeek;
        };
        const getDateStr = (d) => {
            if (!d) return '';
            // Handle Date objects
            if (d instanceof Date) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            // Handle Google Sheets date serial numbers
            if (typeof d === 'number') {
                const date = new Date((d - 25569) * 86400 * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            // Handle ISO strings
            return String(d).split('T')[0];
        };
        const fmtDate = d => {
            if (!d) return '‚Äî';
            // Handle Google Sheets date serial numbers
            if (typeof d === 'number') {
                const date = new Date((d - 25569) * 86400 * 1000);
                return date.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
            }
            // Handle ISO strings or date strings
            const str = String(d).split('T')[0];
            if (!str || str.includes('1899')) return '‚Äî';
            return new Date(str+'T00:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
        };
        const fmtDateLong = d => new Date(d+'T00:00:00').toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric'});
        const initials = (f,l) => (f?.[0]||'') + (l?.[0]||'');
        const money = n => '$' + Number(n||0).toLocaleString();
        
        // Format price input as user types (e.g., $12,020)
        function formatPriceInput(input) {
            // Get cursor position
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;
            
            // Remove all non-digits and non-decimal points
            let value = input.value.replace(/[^\d.]/g, '');
            
            // Only allow one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Format with commas (only the integer part)
            if (value) {
                const [intPart, decPart] = value.split('.');
                const formattedInt = intPart ? Number(intPart).toLocaleString() : '0';
                value = '$' + formattedInt + (decPart !== undefined ? '.' + decPart.slice(0, 2) : '');
            }
            
            input.value = value;
            
            // Restore cursor position (accounting for added/removed chars)
            const newLength = input.value.length;
            const newPos = cursorPos + (newLength - oldLength);
            input.setSelectionRange(newPos, newPos);
        }
        
        // Parse formatted price back to number
        function parsePriceInput(value) {
            if (!value) return 0;
            // Remove $ and commas, parse as number
            return parseFloat(value.replace(/[$,]/g, '')) || 0;
        }
        
        const getClient = function(id) {
            return data.clients.find(function(c) { return String(c.ID) === String(id); });
        };
        const toast = (msg, type='', showUndo=false) => { 
            const t = $('toast'); 
            if (showUndo) {
                t.innerHTML = `${msg} <button onclick="performUndo();$('toast').className='toast'" style="margin-left:12px;background:white;color:var(--charcoal);border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">‚Ü© Undo</button>`;
            } else {
                t.textContent = msg;
            }
            t.className = 'toast show ' + type; 
            setTimeout(() => t.className = 'toast', showUndo ? 6000 : 3000); 
        };
        
        // Calculate time until wedding (accounts for weekends - designers don't work weekends)
        const timeUntilWedding = d => { 
            if (!d) return null; 
            let weddingDate;
            if (typeof d === 'number') {
                weddingDate = new Date((d - 25569) * 86400 * 1000);
            } else {
                weddingDate = new Date(d);
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            weddingDate.setHours(0, 0, 0, 0);
            
            if (weddingDate <= today) {
                return { months: 0, weeks: 0, totalWeeks: 0, totalDays: 0 };
            }
            
            // Calculate calendar months
            let months = 0;
            let tempDate = new Date(today);
            
            // Count full months
            while (true) {
                let nextMonth = new Date(tempDate);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                if (nextMonth <= weddingDate) {
                    months++;
                    tempDate = nextMonth;
                } else {
                    break;
                }
            }
            
            // Calculate remaining full weeks (7 days each)
            const remainingMs = weddingDate - tempDate;
            const remainingDays = Math.floor(remainingMs / (1000 * 60 * 60 * 24));
            const weeks = Math.floor(remainingDays / 7); // Only count full 7-day weeks
            
            // Total days for reference
            const totalDays = Math.floor((weddingDate - today) / (1000 * 60 * 60 * 24));
            const totalWeeks = Math.floor(totalDays / 7);
            
            return { 
                months, 
                weeks, 
                totalWeeks,
                totalDays
            };
        };
        
        // Legacy function for backward compatibility
        const monthsUntil = d => { 
            const t = timeUntilWedding(d);
            return t ? t.months : null;
        };
        
        // Format time nicely: "9 months, 2 weeks"
        const formatTimeUntil = d => {
            const t = timeUntilWedding(d);
            if (!t) return '‚Äî';
            if (t.months === 0 && t.weeks === 0) return 'This week!';
            if (t.months === 0) return `${t.weeks} week${t.weeks !== 1 ? 's' : ''}`;
            if (t.weeks === 0) return `${t.months} month${t.months !== 1 ? 's' : ''}`;
            return `${t.months}m ${t.weeks}w`;
        };

        // ========== API ==========
        async function api(method, body = null) {
            $('syncStatus').textContent = '‚óè Syncing...';
            $('syncStatus').className = 'sync-status syncing';
            try {
                const opts = { 
                    method,
                    redirect: 'follow',
                    mode: 'cors'
                };
                if (body) {
                    opts.method = 'POST';
                    opts.body = JSON.stringify(body);
                    opts.headers = { 'Content-Type': 'text/plain' };
                }
                
                const url = API_URL + (method === 'GET' ? '?action=getAll&t=' + Date.now() : '');
                const res = await fetch(url, opts);
                
                // Check HTTP status
                if (!res.ok) {
                    throw new Error('Server error: ' + res.status);
                }
                
                const text = await res.text();
                if (!text || text.trim() === '') {
                    throw new Error('Empty response from server');
                }
                
                let json;
                try {
                    json = JSON.parse(text);
                } catch (parseErr) {
                    console.error('JSON parse error:', text.substring(0, 200));
                    throw new Error('Invalid JSON response');
                }
                
                if (!json.success) throw new Error(json.error || 'Unknown server error');
                $('syncStatus').textContent = '‚óè Synced ' + new Date().toLocaleTimeString();
                $('syncStatus').className = 'sync-status';
                return json.data !== undefined ? json.data : json;
            } catch (e) {
                $('syncStatus').textContent = '‚óè Error: ' + e.message;
                $('syncStatus').className = 'sync-status error';
                throw e;
            }
        }

        function loadCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const parsed = JSON.parse(cached);
                    data = {
                        clients: parsed.clients || [],
                        appointments: parsed.appointments || [],
                        topoptions: parsed.topoptions || [],
                        orders: parsed.orders || [],
                        alterations: parsed.alterations || [],
                        designers: parsed.designers || [],
                        consultants: parsed.consultants || [],
                        visitnotes: parsed.visitnotes || [],
                        announcements: parsed.announcements || []
                    };
                    renderDash();
                    return true;
                }
            } catch (e) {
                console.log('Cache read error:', e);
            }
            return false;
        }

        function saveCachedData() {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            } catch (e) {
                console.log('Cache write error:', e);
            }
        }

        async function clearCacheAndReload() {
            localStorage.removeItem('estrelle_data');
            toast('Refreshing from server...', '');
            await loadData(true);
            closeModal('importTimely');
            setTimeout(function() { openModal('importTimely'); }, 500);
        }

        // Track pending updates that haven't been confirmed by server
        let pendingUpdates = {};
        let lastUpdateTime = 0;
        
        async function loadData(showToast = false) {
            // Don't auto-refresh if we just made an update (wait 5 seconds)
            if (!showToast && Date.now() - lastUpdateTime < 5000) {
                console.log('Skipping auto-refresh, recent update pending');
                return;
            }
            
            try {
                const d = await api('GET');
                // Handle undefined/null API response
                if (!d || typeof d !== 'object') {
                    console.warn('API returned invalid data:', d);
                    if (showToast) toast('Server returned empty data', 'error');
                    return;
                }
                
                // Merge server data with pending local updates
                let appointments = d.appointments || [];
                
                // Deduplicate appointments by ID (in case of sync issues)
                const seenApptIds = new Set();
                appointments = appointments.filter(a => {
                    if (seenApptIds.has(a.ID)) return false;
                    seenApptIds.add(a.ID);
                    return true;
                });
                
                // Apply any pending appointment updates
                if (pendingUpdates.appointments) {
                    for (const [apptId, updates] of Object.entries(pendingUpdates.appointments)) {
                        const appt = appointments.find(a => String(a.ID) === String(apptId));
                        if (appt) {
                            Object.assign(appt, updates);
                            console.log('Preserved pending update for appointment:', apptId, updates);
                        }
                    }
                }
                
                data = { 
                    clients: d.clients || [], 
                    appointments: appointments, 
                    topoptions: d.topoptions || [], 
                    orders: d.orders || [], 
                    alterations: d.alterations || [], 
                    designers: d.designers || [],
                    consultants: d.consultants || [],
                    visitnotes: d.visitnotes || [],
                    announcements: d.announcements || [],
                    emailtemplates: d.emailtemplates || []
                };
                saveCachedData();
                renderDash();
                if (showToast) toast('Data refreshed', 'success');
            } catch (e) { 
                console.error('loadData error:', e);
                toast('Failed to load: ' + e.message, 'error'); 
            }
        }

        async function syncData() {
            toast('Syncing...', '');
            try {
                const d = await api('GET');
                if (!d || typeof d !== 'object') {
                    toast('Sync failed - invalid response', 'error');
                    return;
                }
                
                data = { 
                    clients: d.clients || [], 
                    appointments: d.appointments || [], 
                    topoptions: d.topoptions || [], 
                    orders: d.orders || [], 
                    alterations: d.alterations || [], 
                    designers: d.designers || [],
                    consultants: d.consultants || [],
                    visitnotes: d.visitnotes || [],
                    announcements: d.announcements || [],
                    emailtemplates: d.emailtemplates || []
                };
                
                // Also sync localStorage alteration data from Google Sheets
                (data.alterations || []).forEach(alt => {
                    if (alt.AlterationItems) {
                        localStorage.setItem(`alts_${alt.ClientID}`, alt.AlterationItems);
                    }
                    if (alt.Notes) {
                        localStorage.setItem(`alts_notes_${alt.ClientID}`, alt.Notes);
                    }
                    if (alt.DueDate) {
                        const dueDate = typeof alt.DueDate === 'string' ? alt.DueDate.split('T')[0] : alt.DueDate;
                        if (dueDate) localStorage.setItem(`alts_neededby_${alt.ClientID}`, dueDate);
                    }
                });
                
                saveCachedData();
                renderDash();
                renderOrders();
                renderAlts();
                toast('Synced!', 'success');
            } catch (e) {
                console.error('Sync error:', e);
                toast('Sync failed: ' + e.message, 'error');
            }
        }

        async function saveRecord(sheet, record) {
            // Optimistic update - add to local data immediately with temp ID
            const tempId = Date.now();
            const newRecord = { ...record, ID: tempId };
            const sheetKey = sheet.toLowerCase();
            if (data[sheetKey]) {
                data[sheetKey].push(newRecord);
                saveCachedData();
            }
            
            // Send to server in background
            api('POST', { action: 'add', sheet, record })
                .then(res => {
                    // Update temp ID with real ID
                    if (res && res.id && data[sheetKey]) {
                        const idx = data[sheetKey].findIndex(r => r.ID === tempId);
                        if (idx >= 0) data[sheetKey][idx].ID = res.id;
                        saveCachedData();
                    }
                })
                .catch(e => {
                    // Remove optimistic record on error
                    if (data[sheetKey]) {
                        const idx = data[sheetKey].findIndex(r => r.ID === tempId);
                        if (idx >= 0) data[sheetKey].splice(idx, 1);
                        saveCachedData();
                    }
                    toast('Save failed - please refresh', 'error');
                });
            
            return { id: tempId };
        }

        async function updateRecord(sheet, id, record) {
            // Mark that we just made an update
            lastUpdateTime = Date.now();
            
            // Optimistic update - update local data immediately
            const sheetKey = sheet.toLowerCase();
            if (data[sheetKey]) {
                const idx = data[sheetKey].findIndex(r => String(r.ID) === String(id));
                if (idx >= 0) {
                    data[sheetKey][idx] = { ...data[sheetKey][idx], ...record };
                    saveCachedData();
                }
            }
            
            // Track as pending update so loadData doesn't overwrite it
            if (sheetKey === 'appointments') {
                if (!pendingUpdates.appointments) pendingUpdates.appointments = {};
                pendingUpdates.appointments[id] = { ...pendingUpdates.appointments[id], ...record };
            }
            
            // Send to server in background
            api('POST', { action: 'update', sheet, id, record })
                .then(() => {
                    // Clear pending update once server confirms
                    if (pendingUpdates.appointments && pendingUpdates.appointments[id]) {
                        delete pendingUpdates.appointments[id];
                        console.log('Cleared pending update for:', id);
                    }
                })
                .catch(e => {
                    toast('Update failed - please refresh', 'error');
                });
        }

        async function deleteRecord(sheet, id) {
            // Optimistic update - remove from local data immediately
            const sheetKey = sheet.toLowerCase();
            if (data[sheetKey]) {
                const removedIdx = data[sheetKey].findIndex(r => r.ID == id);
                if (removedIdx >= 0) {
                    data[sheetKey].splice(removedIdx, 1);
                    saveCachedData();
                }
            }
            
            // Send to server in background (fire and forget)
            api('POST', { action: 'delete', sheet, id }).catch(() => {});
        }

        function refreshData() { loadData(true); }

        // ========== NAV ==========
        // Page navigation history for back button
        let pageHistory = ['dashboard'];
        
        function goBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop(); // Remove current page
                const previousPage = pageHistory[pageHistory.length - 1];
                if (previousPage === 'consult' && currentClient) {
                    // Going back to consult page - already have client
                    showPage('consult', true);
                } else if (previousPage.startsWith('client-')) {
                    // Going back to a specific client
                    const clientId = previousPage.split('-')[1];
                    openClient(parseInt(clientId), true);
                } else {
                    showPage(previousPage, true);
                }
            } else {
                showPage('clients', true);
            }
            updateFloatingBackButton();
        }
        
        function updateFloatingBackButton() {
            const currentPage = document.querySelector('.section.active')?.id;
            const shouldShow = currentPage === 'page-consult';
            $('floatingBack').classList.toggle('visible', shouldShow);
        }
        
        function showPage(name, skipUnsavedCheck = false) {
            // Check for unsaved changes when leaving consult page
            const currentPage = document.querySelector('.section.active')?.id;
            if (!skipUnsavedCheck && currentPage === 'page-consult' && name !== 'consult') {
                if (hasUnsavedClientNotes()) {
                    if (!confirm('You have unsaved notes. Leave without saving?')) {
                        return; // Stay on current page
                    }
                }
                // Clear currentClient when leaving consult
                currentClient = null;
            }
            
            // Track page history (don't add duplicates)
            if (!skipUnsavedCheck && pageHistory[pageHistory.length - 1] !== name) {
                pageHistory.push(name);
                // Limit history size
                if (pageHistory.length > 20) pageHistory.shift();
            }
            
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            $('page-' + name)?.classList.add('active');
            document.querySelector(`.nav-item[data-page="${name}"]`)?.classList.add('active');
            if (name === 'clients') setClientsView(clientsView || 'all');
            if (name === 'schedule') setScheduleView(scheduleView || 'week');
            if (name === 'orders') { 
                // Render immediately with cached data
                setOrdersView(ordersView || 'orders');
                // Then refresh data in background
                loadData().then(() => {
                    if (ordersView === 'orders') renderOrders();
                    else renderAlts();
                });
            }
            if (name === 'reporting') renderReporting();
            if (name === 'settings') renderSettings();
            
            updateFloatingBackButton();
        }

        function openModal(n) { 
            $('modal-' + n)?.classList.add('active'); 
            // Only populate if NOT editing AND not pre-filled (apptForClientId indicates pre-fill)
            if (n === 'newAppt' && !$('editApptId').value && !$('apptForClientId').value) populateApptModal(); 
            if (n === 'addOption') populateOptionModal(); 
            if (n === 'newConsultant') initConsultantSigPad();
        }
        function closeModal(n) { 
            // Check for unsaved email drafts
            if (n === 'clientEmail') {
                const hasContent = $('clientEmailSubject')?.value?.trim() || 
                                   $('clientEmailBodyEditor')?.innerText?.trim();
                if (hasContent) {
                    if (!confirm('You have an unsaved email draft. Are you sure you want to close?')) {
                        return;
                    }
                }
            }
            
            if (n === 'emailPreview') {
                // If closing preview, ask if they want to go back to edit
                if (previewEmailData && (previewEmailData.subject || previewEmailData.body)) {
                    const choice = confirm('Go back to edit this email?\n\nClick OK to continue editing, or Cancel to discard.');
                    if (choice && previewSourceModal) {
                        $('modal-emailPreview')?.classList.remove('active');
                        openModal(previewSourceModal);
                        return;
                    }
                }
            }
            
            $('modal-' + n)?.classList.remove('active'); 
            // Re-enable client dropdown if it was disabled
            if (n === 'newAppt' && $('aClient')) {
                $('aClient').disabled = false;
                $('apptForClientId').value = ''; // Reset pre-fill flag
            }
        }

        // ========== ANNOUNCEMENTS ==========
        function getAnnouncements() {
            return data.announcements || [];
        }
        
        function renderAnnouncements() {
            const announcements = getAnnouncements();
            const container = $('announcementsSection');
            if (!container) return;
            
            if (announcements.length === 0) {
                container.innerHTML = `
                    <button class="add-announcement-btn" onclick="openAnnouncementModal()">
                        üìå Add Announcement
                    </button>
                `;
                return;
            }
            
            const icons = {
                info: 'üì¢',
                reminder: '‚è∞',
                urgent: 'üö®',
                celebration: 'üéâ',
                note: 'üìù'
            };
            
            container.innerHTML = announcements.map((a, i) => `
                <div class="announcement ${a.Type === 'urgent' ? 'urgent' : ''} ${a.Pinned ? 'pinned' : ''}">
                    <div class="announcement-icon">${icons[a.Type] || 'üìå'}</div>
                    <div class="announcement-content">
                        <div class="announcement-title">${escapeHtml(a.Title)}</div>
                        ${a.Details ? `<div class="announcement-text">${escapeHtml(a.Details)}</div>` : ''}
                        <div class="announcement-meta">Added ${formatTimeAgo(a.CreatedAt)}</div>
                    </div>
                    <div class="announcement-actions">
                        <button class="announcement-btn" onclick="editAnnouncement(${a.ID})" title="Edit">‚úèÔ∏è</button>
                        <button class="announcement-btn" onclick="dismissAnnouncement(${a.ID})" title="Dismiss">‚úï</button>
                    </div>
                </div>
            `).join('') + `
                <button class="add-announcement-btn" onclick="openAnnouncementModal()" style="margin-top:4px">
                    + Add Another
                </button>
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
            if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
            if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function openAnnouncementModal(editId = null) {
            const isEdit = editId !== null;
            const existing = isEdit ? data.announcements.find(a => a.ID == editId) : null;
            
            // Create modal content
            const modalHtml = `
                <div class="modal-header">
                    <h3 class="modal-title">${isEdit ? 'Edit' : 'Add'} Announcement</h3>
                    <button class="modal-close" onclick="closeModal('announcement')">√ó</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="annEditId" value="${editId || ''}">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="annType">
                            <option value="info" ${existing?.Type === 'info' ? 'selected' : ''}>üì¢ Info</option>
                            <option value="reminder" ${existing?.Type === 'reminder' ? 'selected' : ''}>‚è∞ Reminder</option>
                            <option value="urgent" ${existing?.Type === 'urgent' ? 'selected' : ''}>üö® Urgent</option>
                            <option value="celebration" ${existing?.Type === 'celebration' ? 'selected' : ''}>üéâ Celebration</option>
                            <option value="note" ${existing?.Type === 'note' ? 'selected' : ''}>üìù Note</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="annTitle" placeholder="e.g., Trunk show this weekend!" value="${existing?.Title || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Details (optional)</label>
                        <textarea class="form-input" id="annText" placeholder="Add more details..." rows="3">${existing?.Details || ''}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('announcement')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveAnnouncement()">${isEdit ? 'Update' : 'Add'}</button>
                </div>
            `;
            
            // Use existing modal or create one
            let modal = $('modal-announcement');
            if (!modal) {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.id = 'modal-announcement';
                overlay.innerHTML = '<div class="modal">' + modalHtml + '</div>';
                overlay.onclick = (e) => { if (e.target === overlay) closeModal('announcement'); };
                document.body.appendChild(overlay);
                modal = overlay;
            } else {
                modal.querySelector('.modal').innerHTML = modalHtml;
            }
            
            modal.classList.add('active');
            $('annTitle').focus();
        }
        
        function editAnnouncement(id) {
            openAnnouncementModal(id);
        }
        
        async function saveAnnouncement() {
            const editId = $('annEditId').value;
            const title = $('annTitle').value.trim();
            const details = $('annText').value.trim();
            const type = $('annType').value;
            
            if (!title) {
                toast('Please enter a title', 'error');
                return;
            }
            
            const record = {
                Title: title,
                Details: details,
                Type: type,
                CreatedAt: new Date().toISOString(),
                Pinned: false
            };
            
            try {
                if (editId) {
                    await updateRecord('Announcements', editId, record);
                    const idx = data.announcements.findIndex(a => a.ID == editId);
                    if (idx !== -1) {
                        data.announcements[idx] = { ...data.announcements[idx], ...record };
                    }
                    saveCachedData();
                } else {
                    // saveRecord handles optimistic update
                    await saveRecord('Announcements', record);
                }
                
                closeModal('announcement');
                renderAnnouncements();
                toast(editId ? 'Announcement updated!' : 'Announcement added!', 'success');
            } catch (e) {
                toast('Error saving: ' + e.message, 'error');
            }
        }
        
        async function dismissAnnouncement(id) {
            try {
                await deleteRecord('Announcements', id);
                data.announcements = data.announcements.filter(a => a.ID != id);
                saveCachedData();
                renderAnnouncements();
                toast('Announcement dismissed', 'success');
            } catch (e) {
                toast('Error deleting: ' + e.message, 'error');
            }
        }

        // ========== DASHBOARD ==========
        function renderDash() {
            // Render announcements
            renderAnnouncements();
            
            // Set greeting based on time of day
            const hour = new Date().getHours();
            let greeting = 'Good morning ‚òÄÔ∏è';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon üëã';
            else if (hour >= 17) greeting = 'Good evening üåô';
            $('dashGreeting').textContent = greeting;
            
            const t = today();
            const todayAppts = data.appointments.filter(a => isToday(a.Date));
            // Count excludes no-shows
            $('statToday').textContent = todayAppts.filter(a => a.Status !== 'no-show').length;
            $('statOrders').textContent = data.orders.filter(o => o.Status !== 'complete').length;
            $('statAlts').textContent = data.alterations.length;
            $('statClients').textContent = data.clients.length;

            // Filter to only show appointments with valid clients, and dedupe by ID
            const seenIds = new Set();
            const appts = todayAppts
                .filter(a => getClient(a.ClientID))
                .filter(a => {
                    if (seenIds.has(a.ID)) return false;
                    seenIds.add(a.ID);
                    return true;
                })
                .sort((a,b) => (a.Time||'').localeCompare(b.Time||''));
            $('dashToday').innerHTML = appts.length ? appts.map(a => {
                const c = getClient(a.ClientID);
                const isNoShow = a.Status === 'no-show';
                return `<div class="list-item" style="border-left:3px solid ${getTypeColor(a.Type)};${isNoShow ? 'opacity:0.5;background:#f5f5f5;' : ''}" onclick="openClient('${a.ClientID}')">
                    <div class="avatar">${initials(c.FirstName, c.LastName)}</div>
                    <div class="item-info">
                        <div class="item-name">${c.FirstName} ${c.LastName}${isNoShow ? ' <span style="color:var(--red);font-size:10px">NO-SHOW</span>' : ''}${a.ConfirmationSent ? ` <span class="confirmed-badge" onclick="event.stopPropagation();unmarkConfirmed('${a.ID}')" style="cursor:pointer" title="Click to undo">‚úì</span>` : ''}</div>
                        <div class="item-meta">${fmtTime(a.Time)} ¬∑ <span style="color:${getTypeColor(a.Type)};font-weight:600">${normalizeApptType(a.Type)}</span> ¬∑ ${a.Consultant||''}</div>
                    </div>
                    <div style="display:flex;gap:4px;align-items:center" onclick="event.stopPropagation()">
                        ${!isNoShow ? `<button class="btn btn-sm btn-secondary" onclick="openConfirmEmailModal('${a.ID}')" title="Send email">üìß</button>` : ''}
                        <button class="btn btn-sm btn-secondary" onclick="deleteApptConfirm('${a.ID}')" title="Delete">‚úï</button>
                        ${!isNoShow ? `<button class="btn btn-sm btn-secondary" onclick="showDashApptActions(${a.ID}, event)" title="More">‚ãØ</button>` : ''}
                    </div>
                </div>`;
            }).join('') : '<div class="empty">No appointments today</div>';

            // Pending Drafts - clients with unsaved Say Yes orders
            const clientsWithDrafts = data.clients.filter(c => {
                if (!c.OrderDraft) return false;
                try {
                    const draft = JSON.parse(c.OrderDraft);
                    return draft && draft.savedAt;
                } catch (e) {
                    return false;
                }
            }).map(c => {
                const draft = JSON.parse(c.OrderDraft);
                return { client: c, draft };
            }).sort((a, b) => (b.draft.savedAt || '').localeCompare(a.draft.savedAt || ''));
            
            $('dashDrafts').innerHTML = clientsWithDrafts.length ? clientsWithDrafts.map(({ client: c, draft }) => {
                const itemCount = draft.items?.length || 0;
                const savedDate = new Date(draft.savedAt);
                const timeAgo = getTimeAgo(savedDate);
                const total = draft.items?.reduce((sum, item) => {
                    let itemTotal = item.price || 0;
                    if (item.customizations) {
                        itemTotal += item.customizations.reduce((s, cust) => s + (cust.price || 0), 0);
                    }
                    return sum + itemTotal;
                }, 0) || 0;
                
                return `<div class="list-item" onclick="openClient('${c.ID}')">
                    <div class="avatar">${initials(c.FirstName, c.LastName)}</div>
                    <div class="item-info" style="flex:1">
                        <div class="item-name">${c.FirstName} ${c.LastName}</div>
                        <div class="item-meta">${itemCount} item${itemCount !== 1 ? 's' : ''} ¬∑ $${total.toLocaleString()} ¬∑ Saved ${timeAgo}</div>
                    </div>
                    <div style="display:flex;gap:4px" onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-primary" onclick="openClientAndSayYes('${c.ID}')" title="Continue">Continue</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteDraftFromDash('${c.ID}')" title="Delete" style="color:#e74c3c">√ó</button>
                    </div>
                </div>`;
            }).join('') : '<div class="empty">No pending drafts</div>';
            
            // Hide drafts card if empty
            $('draftsCard').style.display = clientsWithDrafts.length ? 'block' : 'none';

            // Follow-ups - ALL (due, overdue, and upcoming)
            const todayStr = today();
            const followUps = data.appointments
                .filter(a => a.FollowUpDate && a.FollowUpDone !== true && a.FollowUpDone !== 'TRUE' && getClient(a.ClientID))
                .sort((a, b) => getDateStr(a.FollowUpDate).localeCompare(getDateStr(b.FollowUpDate)));
            
            $('dashFollowUps').innerHTML = followUps.length ? followUps.map(a => {
                const c = getClient(a.ClientID);
                const followUpDateStr = getDateStr(a.FollowUpDate);
                const isOverdue = followUpDateStr < todayStr;
                const isDueToday = followUpDateStr === todayStr;
                const hasNotes = a.FollowUpNotes && a.FollowUpNotes.trim();
                
                // Calculate days until/since
                const followUpDate = new Date(followUpDateStr + 'T00:00:00');
                const todayDate = new Date(todayStr + 'T00:00:00');
                const diffDays = Math.round((followUpDate - todayDate) / (1000 * 60 * 60 * 24));
                
                let statusLabel, statusStyle;
                if (isOverdue) {
                    statusLabel = `‚ö†Ô∏è Overdue by ${Math.abs(diffDays)} day${Math.abs(diffDays) > 1 ? 's' : ''} (${fmtDate(a.FollowUpDate)})`;
                    statusStyle = 'background:#fff5f5;';
                } else if (isDueToday) {
                    statusLabel = 'üìç Due today';
                    statusStyle = 'background:#fff9e6;';
                } else if (diffDays === 1) {
                    statusLabel = 'üîú Due tomorrow';
                    statusStyle = '';
                } else if (diffDays <= 7) {
                    statusLabel = `üìÖ Due in ${diffDays} days (${fmtDate(a.FollowUpDate)})`;
                    statusStyle = '';
                } else {
                    statusLabel = `üìÖ Due ${fmtDate(a.FollowUpDate)}`;
                    statusStyle = 'opacity:0.8;';
                }
                
                return `<div class="list-item" style="${statusStyle}flex-direction:column;align-items:stretch;gap:8px">
                    <div style="display:flex;align-items:center;gap:10px" onclick="openClient('${a.ClientID}')">
                        <div class="avatar">${initials(c.FirstName, c.LastName)}</div>
                        <div class="item-info" style="flex:1">
                            <div class="item-name">${c.FirstName} ${c.LastName}</div>
                            <div class="item-meta">${statusLabel} ¬∑ ${normalizeApptType(a.Type)} on ${fmtDate(a.Date)}</div>
                        </div>
                        <div style="display:flex;gap:4px">
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();editAppt('${a.ID}')" title="Edit follow-up">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();openFollowUpEmail('${a.ID}')">üìß</button>
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation();markFollowUpDone('${a.ID}')">‚úì</button>
                        </div>
                    </div>
                    ${hasNotes ? `<div style="background:var(--cream);padding:8px 10px;border-radius:5px;font-size:11px;margin-left:38px;border-left:3px solid var(--rose)"><strong>üìù Notes:</strong> ${a.FollowUpNotes}</div>` : ''}
                </div>`;
            }).join('') : '<div class="empty">No follow-ups scheduled<br><span style="font-size:10px;color:var(--taupe)">Set follow-ups when editing appointments</span></div>';

            // Confirmations due - upcoming consultations without confirmation sent
            const next7Days = new Date();
            next7Days.setDate(next7Days.getDate() + 7);
            const next7DaysStr = next7Days.toISOString().split('T')[0];
            
            const confirmsDue = data.appointments
                .filter(a => {
                    if (!getClient(a.ClientID)) return false;
                    if (a.ConfirmationSent) {
                        console.log('Filtering out confirmed appointment:', a.ID, a.ConfirmationSent);
                        return false; // Already confirmed
                    }
                    // Only consultations need confirmation
                    const apptType = (a.Type || '').toLowerCase();
                    if (!apptType.includes('consultation')) return false;
                    const apptDateStr = getDateStr(a.Date);
                    if (!apptDateStr) return false;
                    return apptDateStr >= todayStr && apptDateStr <= next7DaysStr;
                })
                .sort((a, b) => getDateStr(a.Date).localeCompare(getDateStr(b.Date)));
            
            console.log('Confirmations due after filter:', confirmsDue.length, confirmsDue.map(a => a.ID));
            
            $('dashConfirmDue').innerHTML = confirmsDue.length ? confirmsDue.map(a => {
                const c = getClient(a.ClientID);
                const apptDateStr = getDateStr(a.Date);
                const apptDate = new Date(apptDateStr + 'T00:00:00');
                const todayDate = new Date(todayStr + 'T00:00:00');
                const diffDays = Math.round((apptDate - todayDate) / (1000 * 60 * 60 * 24));
                
                let urgencyLabel, urgencyStyle;
                if (diffDays === 0) {
                    urgencyLabel = 'üî¥ TODAY - Send now!';
                    urgencyStyle = 'background:#fff5f5;';
                } else if (diffDays === 1) {
                    urgencyLabel = 'üü† Tomorrow';
                    urgencyStyle = 'background:#fff9e6;';
                } else if (diffDays <= 3) {
                    urgencyLabel = `üü° In ${diffDays} days`;
                    urgencyStyle = '';
                } else {
                    urgencyLabel = `üìÖ ${fmtDate(a.Date)}`;
                    urgencyStyle = 'opacity:0.8;';
                }
                
                return `<div class="list-item" style="${urgencyStyle}">
                    <div class="avatar">${initials(c.FirstName, c.LastName)}</div>
                    <div class="item-info" style="flex:1" onclick="openClient('${a.ClientID}')">
                        <div class="item-name">${c.FirstName} ${c.LastName}</div>
                        <div class="item-meta">${urgencyLabel} ¬∑ ${fmtTime(a.Time)} ¬∑ ${normalizeApptType(a.Type)}</div>
                    </div>
                    ${confirmButtons(a.ID, false)}
                </div>`;
            }).join('') : '<div class="empty">All upcoming appointments confirmed! ‚úì</div>';

            const recent = [...data.clients].sort((a,b) => (b.LastVisit||'').localeCompare(a.LastVisit||'')).slice(0, 5);
            $('dashRecent').innerHTML = recent.length ? recent.map(c => `
                <div class="list-item" onclick="openClient('${c.ID}')">
                    <div class="avatar">${initials(c.FirstName, c.LastName)}</div>
                    <div class="item-info"><div class="item-name">${c.FirstName} ${c.LastName}</div><div class="item-meta">${fmtDate(c.LastVisit)}</div></div>
                    <span class="status status-${c.Status||'new'}">${c.Status||'new'}</span>
                </div>
            `).join('') : '<div class="empty">No clients yet</div>';
        }

        // ========== CLIENTS VIEW TOGGLE ==========
        let clientsView = 'all';
        const ANNIVERSARY_EMAILS_KEY = 'estrelle_anniversary_emails';
        
        function getAnniversaryEmails() {
            try {
                return JSON.parse(localStorage.getItem(ANNIVERSARY_EMAILS_KEY) || '{}');
            } catch {
                return {};
            }
        }
        
        function saveAnniversaryEmail(clientId, status, date = null) {
            const emails = getAnniversaryEmails();
            const year = new Date().getFullYear();
            const key = `${clientId}_${year}`;
            emails[key] = { status, date, updatedAt: new Date().toISOString() };
            localStorage.setItem(ANNIVERSARY_EMAILS_KEY, JSON.stringify(emails));
        }
        
        function getAnniversaryEmailStatus(clientId) {
            const emails = getAnniversaryEmails();
            const year = new Date().getFullYear();
            const key = `${clientId}_${year}`;
            return emails[key] || null;
        }
        
        function setClientsView(view) {
            clientsView = view;
            $('viewAllClients').style.background = view === 'all' ? 'var(--accent)' : 'white';
            $('viewAllClients').style.color = view === 'all' ? 'white' : 'var(--text)';
            $('viewAnniversaries').style.background = view === 'anniversaries' ? 'var(--accent)' : 'white';
            $('viewAnniversaries').style.color = view === 'anniversaries' ? 'white' : 'var(--text)';
            
            $('allClientsView').style.display = view === 'all' ? 'block' : 'none';
            $('anniversariesView').style.display = view === 'anniversaries' ? 'block' : 'none';
            
            if (view === 'all') {
                $('clientCount').textContent = data.clients.filter(c => c.Status !== 'archived').length + ' clients';
                renderClients();
            } else {
                renderAnniversariesView();
            }
        }
        
        function renderAnniversariesView() {
            const rangeFilter = parseInt($('annFilterRange').value) || 365;
            const statusFilter = $('annFilterStatus').value;
            const now = new Date();
            const currentYear = now.getFullYear();
            
            // Get all clients with wedding dates
            let anniversaries = data.clients
                .filter(c => c.WeddingDate && c.Status !== 'archived')
                .map(c => {
                    const wdStr = getDateStr(c.WeddingDate);
                    if (!wdStr || wdStr.includes('1899')) return null;
                    
                    const wd = new Date(wdStr + 'T00:00:00');
                    if (isNaN(wd.getTime())) return null;
                    
                    // Calculate this year's anniversary
                    let thisYearAnn = new Date(currentYear, wd.getMonth(), wd.getDate());
                    if (thisYearAnn < now) {
                        thisYearAnn.setFullYear(currentYear + 1);
                    }
                    
                    const daysUntil = Math.ceil((thisYearAnn - now) / (1000 * 60 * 60 * 24));
                    const yearsMarried = thisYearAnn.getFullYear() - wd.getFullYear();
                    const emailStatus = getAnniversaryEmailStatus(c.ID);
                    
                    return { 
                        ...c, 
                        daysUntil, 
                        anniversary: thisYearAnn, 
                        weddingYear: wd.getFullYear(), 
                        yearsMarried,
                        emailStatus 
                    };
                })
                .filter(c => c !== null && c.daysUntil <= rangeFilter);
            
            // Filter by email status
            if (statusFilter === 'pending') {
                anniversaries = anniversaries.filter(c => !c.emailStatus || c.emailStatus.status === 'pending');
            } else if (statusFilter === 'scheduled') {
                anniversaries = anniversaries.filter(c => c.emailStatus?.status === 'scheduled');
            } else if (statusFilter === 'sent') {
                anniversaries = anniversaries.filter(c => c.emailStatus?.status === 'sent');
            }
            
            // Sort by days until
            anniversaries.sort((a, b) => a.daysUntil - b.daysUntil);
            
            $('clientCount').textContent = anniversaries.length + ' anniversaries';
            
            $('anniversariesTable').innerHTML = anniversaries.length ? anniversaries.map(c => {
                const urgentClass = c.daysUntil <= 7 ? 'style="background:#fff5f5"' : c.daysUntil <= 30 ? 'style="background:#fffbeb"' : '';
                const status = c.emailStatus;
                let statusBadge, actionBtn;
                
                if (status?.status === 'sent') {
                    statusBadge = `<span class="confirmed-badge">‚úì Sent ${fmtDate(status.date)}</span>`;
                    actionBtn = `<button class="btn btn-sm btn-secondary" onclick="sendAnniversaryEmailNow('${c.ID}')">Resend</button>`;
                } else if (status?.status === 'scheduled') {
                    statusBadge = `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:#e0f2fe;color:#0369a1;border-radius:4px;font-size:10px">üìÖ ${fmtDate(status.date)}</span>`;
                    actionBtn = `
                        <button class="btn btn-sm btn-secondary" onclick="sendAnniversaryEmailNow('${c.ID}')">Send Now</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelScheduledEmail('${c.ID}')" style="color:var(--red)">Cancel</button>
                    `;
                } else {
                    statusBadge = `<span style="color:var(--text-secondary);font-size:11px">Not scheduled</span>`;
                    actionBtn = `
                        <button class="btn btn-sm btn-done" onclick="openScheduleEmailModal('${c.ID}', '${c.FirstName}', '${c.LastName}', '${c.anniversary.toISOString()}')">üìÖ Schedule</button>
                        <button class="btn btn-sm btn-email" onclick="sendAnniversaryEmailNow('${c.ID}')">üìß Send</button>
                    `;
                }
                
                return `<tr ${urgentClass}>
                    <td onclick="openClient('${c.ID}')" style="cursor:pointer">
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="avatar" style="width:32px;height:32px;font-size:11px">${initials(c.FirstName, c.LastName)}</div>
                            <div>
                                <div style="font-weight:500">${c.FirstName} ${c.LastName}</div>
                                <div style="font-size:10px;color:var(--text-secondary)">${c.Email || 'No email'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-weight:500">${c.anniversary.toLocaleDateString('en-US', {month:'short', day:'numeric'})}</div>
                        <div style="font-size:10px;color:${c.daysUntil <= 7 ? 'var(--red)' : c.daysUntil <= 30 ? 'var(--accent)' : 'var(--text-secondary)'}">${c.daysUntil === 0 ? 'Today!' : c.daysUntil === 1 ? 'Tomorrow' : 'In ' + c.daysUntil + ' days'}</div>
                    </td>
                    <td style="text-align:center">
                        <div style="font-size:18px;font-weight:600">${c.yearsMarried}</div>
                        <div style="font-size:9px;color:var(--text-secondary)">year${c.yearsMarried !== 1 ? 's' : ''}</div>
                    </td>
                    <td>${statusBadge}</td>
                    <td style="text-align:right">
                        <div style="display:flex;gap:4px;justify-content:flex-end">${actionBtn}</div>
                    </td>
                </tr>`;
            }).join('') : '<tr><td colspan="5" class="empty">No anniversaries found</td></tr>';
        }
        
        function openScheduleEmailModal(clientId, firstName, lastName, anniversaryDate) {
            const annDate = new Date(anniversaryDate);
            const defaultDate = new Date(annDate);
            defaultDate.setDate(defaultDate.getDate() - 3); // Default: 3 days before
            
            const modalHtml = `
                <div class="modal-header">
                    <h3 class="modal-title">üìÖ Schedule Anniversary Email</h3>
                    <button class="modal-close" onclick="closeModal('scheduleAnnEmail')">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom:16px">Schedule congratulations email for <strong>${firstName} ${lastName}</strong></p>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Anniversary: ${annDate.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'})}</p>
                    
                    <div class="form-group">
                        <label class="form-label">Send email on</label>
                        <input type="date" class="form-input" id="scheduleEmailDate" value="${defaultDate.toISOString().split('T')[0]}">
                    </div>
                    
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
                        <button class="btn btn-sm btn-secondary" onclick="setScheduleDate(${-7}, '${anniversaryDate}')">1 week before</button>
                        <button class="btn btn-sm btn-secondary" onclick="setScheduleDate(${-3}, '${anniversaryDate}')">3 days before</button>
                        <button class="btn btn-sm btn-secondary" onclick="setScheduleDate(${0}, '${anniversaryDate}')">On the day</button>
                    </div>
                    
                    <input type="hidden" id="scheduleEmailClientId" value="${clientId}">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('scheduleAnnEmail')">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmScheduleEmail()">Schedule Email</button>
                </div>
            `;
            
            let modal = $('modal-scheduleAnnEmail');
            if (!modal) {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.id = 'modal-scheduleAnnEmail';
                overlay.innerHTML = '<div class="modal">' + modalHtml + '</div>';
                overlay.onclick = (e) => { if (e.target === overlay) closeModal('scheduleAnnEmail'); };
                document.body.appendChild(overlay);
                modal = overlay;
            } else {
                modal.querySelector('.modal').innerHTML = modalHtml;
            }
            
            modal.classList.add('active');
        }
        
        function setScheduleDate(daysOffset, anniversaryDate) {
            const annDate = new Date(anniversaryDate);
            annDate.setDate(annDate.getDate() + daysOffset);
            $('scheduleEmailDate').value = annDate.toISOString().split('T')[0];
        }
        
        function confirmScheduleEmail() {
            const clientId = $('scheduleEmailClientId').value;
            const date = $('scheduleEmailDate').value;
            
            if (!date) {
                toast('Please select a date', 'error');
                return;
            }
            
            saveAnniversaryEmail(clientId, 'scheduled', date);
            closeModal('scheduleAnnEmail');
            renderAnniversariesView();
            toast('Anniversary email scheduled!', 'success');
        }
        
        function cancelScheduledEmail(clientId) {
            if (!confirm('Cancel scheduled email?')) return;
            saveAnniversaryEmail(clientId, 'pending', null);
            renderAnniversariesView();
            toast('Scheduled email cancelled', '');
        }
        
        function sendAnniversaryEmailNow(clientId) {
            const client = getClient(clientId);
            if (!client) {
                toast('Client not found', 'error');
                return;
            }
            
            if (!client.Email) {
                toast('No email address for this client', 'error');
                return;
            }
            
            // Open the anniversary email modal
            openAnniversaryEmailModal(clientId);
        }
        
        function openAnniversaryEmailModal(clientId) {
            const client = getClient(clientId);
            if (!client) return;
            
            const template = getAnniversaryTemplate();
            const storeInfo = getStoreInfo();
            
            // Calculate years married
            const wdStr = getDateStr(client.WeddingDate);
            const wd = new Date(wdStr + 'T00:00:00');
            const yearsMarried = new Date().getFullYear() - wd.getFullYear();
            
            // Replace placeholders
            let subject = template.subject
                .replace(/\{FirstName\}/g, client.FirstName)
                .replace(/\{LastName\}/g, client.LastName)
                .replace(/\{Years\}/g, yearsMarried);
            
            let body = template.body
                .replace(/\{FirstName\}/g, client.FirstName)
                .replace(/\{LastName\}/g, client.LastName)
                .replace(/\{Years\}/g, yearsMarried)
                .replace(/\{StoreName\}/g, storeInfo.name || 'Estrelle Bridal')
                .replace(/\{StorePhone\}/g, storeInfo.phone || '')
                .replace(/\{StoreEmail\}/g, storeInfo.email || '');
            
            $('annEmailTo').value = client.Email;
            $('annEmailSubject').value = subject;
            $('annEmailBody').value = body;
            $('annEmailClientId').value = clientId;
            
            openModal('sendAnnEmail');
            
            // Init rich text editor
            setTimeout(() => {
                initRichTextEditor('annEmailBodyEditor', 'annEmailBody');
            }, 50);
        }
        
        async function sendAnniversaryEmail() {
            syncRichTextEditor('annEmailBodyEditor', 'annEmailBody');
            
            const clientId = $('annEmailClientId').value;
            const to = $('annEmailTo').value;
            const subject = $('annEmailSubject').value;
            const body = $('annEmailBody').value;
            
            if (!to || !subject || !body) {
                toast('Please fill in all fields', 'error');
                return;
            }
            
            closeModal('sendAnnEmail');
            sendEmailViaPreferredMethod(to, subject, body, () => {
                saveAnniversaryEmail(clientId, 'sent', new Date().toISOString().split('T')[0]);
                renderAnniversariesView();
            });
        }

        // ========== CLIENTS ==========
        let clientSortField = 'lastVisit';
        let clientSortDirection = { name: 'asc', wedding: 'asc', status: 'asc', lastVisit: 'desc' };
        
        function renderClients() {
            let activeClients = data.clients.filter(c => c.Status !== 'archived');
            
            // Sort clients
            const dir = clientSortDirection[clientSortField] === 'desc' ? -1 : 1;
            if (clientSortField === 'name') {
                activeClients.sort((a, b) => dir * `${a.FirstName} ${a.LastName}`.localeCompare(`${b.FirstName} ${b.LastName}`));
            } else if (clientSortField === 'wedding') {
                activeClients.sort((a, b) => dir * (a.WeddingDate || '9999').localeCompare(b.WeddingDate || '9999'));
            } else if (clientSortField === 'status') {
                const statusOrder = { 'new': 0, 'active': 1, 'said yes': 2, 'ordered': 3, 'archived': 4 };
                activeClients.sort((a, b) => dir * ((statusOrder[a.Status] ?? 1) - (statusOrder[b.Status] ?? 1)));
            } else if (clientSortField === 'lastVisit') {
                activeClients.sort((a, b) => dir * (b.LastVisit || '').localeCompare(a.LastVisit || ''));
            }
            
            $('clientCount').textContent = activeClients.length + ' clients';
            $('selectAllClients').checked = false;
            $('btnDeleteClients').style.display = 'none';
            $('clientsTable').innerHTML = activeClients.length ? activeClients.map(c => {
                // Check if client said yes OR has orders
                const hasOrders = data.orders.some(o => String(o.ClientID) === String(c.ID));
                const saidYes = c.SaidYes === 'TRUE' || c.SaidYes === true || hasOrders;
                const saidYesIcon = saidYes ? ' üíç' : '';
                return `
                <tr>
                    <td onclick="event.stopPropagation()"><input type="checkbox" class="client-checkbox" data-id="${c.ID}" onchange="updateClientSelection()"></td>
                    <td onclick="openClient('${c.ID}')" style="cursor:pointer"><div style="display:flex;align-items:center;gap:6px"><div class="avatar" style="width:28px;height:28px;font-size:11px">${initials(c.FirstName,c.LastName)}</div><div><div style="font-weight:500">${c.FirstName} ${c.LastName}${saidYesIcon}</div><div style="font-size:9px;color:var(--rose)">${c.Email||''}</div></div></div></td>
                    <td onclick="openClient('${c.ID}')" style="cursor:pointer">${fmtDate(c.WeddingDate)}</td>
                    <td onclick="openClient('${c.ID}')" style="cursor:pointer"><span class="status status-${c.Status||'new'}">${c.Status||'new'}</span></td>
                    <td onclick="openClient('${c.ID}')" style="cursor:pointer">${fmtDate(c.LastVisit)}</td>
                    <td><button class="action-btn" onclick="event.stopPropagation();editClient('${c.ID}')">Edit</button></td>
                </tr>
            `}).join('') : '<tr><td colspan="6" class="empty">No clients</td></tr>';
            
            updateClientSortArrows();
        }
        
        function sortClientsBy(field) {
            if (clientSortField === field) {
                clientSortDirection[field] = clientSortDirection[field] === 'asc' ? 'desc' : 'asc';
            } else {
                clientSortField = field;
            }
            renderClients();
        }
        
        function updateClientSortArrows() {
            const fields = ['name', 'wedding', 'status', 'lastVisit'];
            fields.forEach(f => {
                const arrow = $('clientSortArrow_' + f);
                if (arrow) {
                    if (f === clientSortField) {
                        arrow.style.opacity = '1';
                        arrow.textContent = clientSortDirection[f] === 'desc' ? '‚Üì' : '‚Üë';
                    } else {
                        arrow.style.opacity = '0.3';
                        arrow.textContent = '‚Üï';
                    }
                }
            });
        }
        
        function toggleAllClients(checked) {
            document.querySelectorAll('.client-checkbox').forEach(function(cb) {
                cb.checked = checked;
            });
            updateClientSelection();
        }
        
        function updateClientSelection() {
            const selected = document.querySelectorAll('.client-checkbox:checked').length;
            $('btnDeleteClients').style.display = selected > 0 ? 'inline-block' : 'none';
            $('btnDeleteClients').textContent = 'üóë Delete (' + selected + ')';
        }
        
        async function bulkDeleteClients() {
            const checkboxes = document.querySelectorAll('.client-checkbox:checked');
            const count = checkboxes.length;
            if (count === 0) return;
            
            const confirmed = await appConfirmDanger(`Delete ${count} client(s) and all their appointments/orders?`, 'Delete Clients');
            if (!confirmed) return;
            
            // Collect IDs and store records for undo
            const ids = [];
            const deletedClients = [];
            checkboxes.forEach(function(cb) { 
                const id = cb.dataset.id;
                ids.push(id);
                const client = data.clients.find(c => c.ID == id);
                if (client) deletedClients.push({ ...client });
            });
            
            // Add to undo stack
            addUndo({ type: 'bulk_delete_clients', records: deletedClients });
            
            // Optimistic UI update - remove immediately
            ids.forEach(function(id) {
                data.clients = data.clients.filter(function(c) { return c.ID != id; });
                data.appointments = data.appointments.filter(function(a) { return a.ClientID != id; });
            });
            
            // Update UI immediately
            renderClients();
            renderAllAppointments();
            renderDash();
            toast(count + ' client(s) deleted', 'success', true);
            
            // Fire all deletes in background (don't await)
            ids.forEach(function(id) {
                api('POST', { action: 'delete', sheet: 'Clients', id: id }).catch(function() {});
            });
        }

        function filterClients() {
            const s = $('clientSearch').value.toLowerCase();
            document.querySelectorAll('#clientsTable tr').forEach(r => r.style.display = r.textContent.toLowerCase().includes(s) ? '' : 'none');
        }

        function editClient(id) {
            const c = getClient(id);
            if (!c) return;
            $('clientModalTitle').textContent = 'Edit Client';
            $('editClientId').value = c.ID;
            $('nFirstName').value = c.FirstName || '';
            $('nLastName').value = c.LastName || '';
            $('nEmail').value = c.Email || '';
            $('nPhone').value = c.Phone || '';
            $('nWedding').value = c.WeddingDate || '';
            $('nVenue').value = c.Venue || '';
            $('nBookingNotes').value = c.BookingNotes || '';
            openModal('newClient');
        }

        async function saveClient() {
            const id = $('editClientId').value;
            const existingClient = id ? getClient(id) : null;
            const record = {
                FirstName: $('nFirstName').value,
                LastName: $('nLastName').value,
                Email: $('nEmail').value,
                Phone: $('nPhone').value,
                WeddingDate: $('nWedding').value,
                Venue: $('nVenue').value,
                DestinationWedding: $('nDestination').checked,
                LeavingDate: $('nDestination').checked ? $('nLeavingDate').value : '',
                BookingNotes: $('nBookingNotes').value,
                Status: existingClient ? existingClient.Status : 'new',
                LastVisit: existingClient ? existingClient.LastVisit : today()
            };
            if (!record.FirstName || !record.LastName) { toast('Enter name'); return; }
            
            // Close modal immediately
            closeModal('newClient');
            toast('Saving...', '');
            
            if (id) {
                // Store previous values for undo
                const previousValues = {
                    FirstName: existingClient.FirstName,
                    LastName: existingClient.LastName,
                    Email: existingClient.Email,
                    Phone: existingClient.Phone,
                    WeddingDate: existingClient.WeddingDate,
                    Venue: existingClient.Venue,
                    DestinationWedding: existingClient.DestinationWedding,
                    LeavingDate: existingClient.LeavingDate,
                    BookingNotes: existingClient.BookingNotes
                };
                addUndo({ type: 'edit_client', id: id, previous: previousValues });
                
                updateRecord('Clients', id, record);
                // Refresh current client view if editing current client
                if (currentClient && currentClient.ID == id) {
                    currentClient = { ...currentClient, ...record };
                    $('cName').textContent = record.FirstName + ' ' + record.LastName;
                    let metaText = `Wedding: ${fmtDate(record.WeddingDate)} ¬∑ ${record.Venue || 'Venue TBD'}`;
                    if (record.DestinationWedding && record.LeavingDate) {
                        metaText += ` ¬∑ ‚úàÔ∏è Leaving: ${fmtDate(record.LeavingDate)}`;
                    }
                    $('cMeta').textContent = metaText;
                    updateTimeline();
                }
                toast('Saved!', 'success', true);
            } else { 
                saveRecord('Clients', record);
                toast('Saved!', 'success');
            }
            
            $('editClientId').value = '';
            $('clientModalTitle').textContent = 'New Client';
            ['nFirstName','nLastName','nEmail','nPhone','nWedding','nVenue','nBookingNotes','nLeavingDate'].forEach(i => $(i).value = '');
            $('nDestination').checked = false;
            $('leavingDateGroup').style.display = 'none';
        }
        
        function toggleLeavingDate() {
            $('leavingDateGroup').style.display = $('nDestination').checked ? 'block' : 'none';
        }
        
        function formatBudget(input) {
            let val = input.value;
            
            // Check if it's a range (contains - or "to" between numbers)
            const rangeMatch = val.match(/(\d[\d,]*)\s*(?:-|to)\s*(\d[\d,]*)/i);
            if (rangeMatch) {
                // Format both parts of the range
                const low = parseInt(rangeMatch[1].replace(/,/g, ''));
                const high = parseInt(rangeMatch[2].replace(/,/g, ''));
                input.value = '$' + low.toLocaleString() + ' - $' + high.toLocaleString();
            } else {
                // Single value - extract numbers
                const num = val.replace(/[^0-9]/g, '');
                if (num) {
                    input.value = '$' + parseInt(num).toLocaleString();
                }
                // If no numbers, leave as-is (allows typing)
            }
        }

        function editCurrentClient() {
            if (!currentClient) return;
            const c = currentClient;
            $('editClientId').value = c.ID;
            $('clientModalTitle').textContent = 'Edit Client';
            $('nFirstName').value = c.FirstName || '';
            $('nLastName').value = c.LastName || '';
            $('nEmail').value = c.Email || '';
            $('nPhone').value = c.Phone || '';
            // Handle date - could be ISO string or Google serial
            if (c.WeddingDate) {
                if (typeof c.WeddingDate === 'number') {
                    const d = new Date((c.WeddingDate - 25569) * 86400 * 1000);
                    $('nWedding').value = d.toISOString().split('T')[0];
                } else {
                    $('nWedding').value = String(c.WeddingDate).split('T')[0];
                }
            } else {
                $('nWedding').value = '';
            }
            $('nVenue').value = c.Venue || '';
            $('nBookingNotes').value = c.BookingNotes || '';
            
            // Destination wedding
            $('nDestination').checked = c.DestinationWedding === true || c.DestinationWedding === 'TRUE';
            $('leavingDateGroup').style.display = $('nDestination').checked ? 'block' : 'none';
            if (c.LeavingDate) {
                if (typeof c.LeavingDate === 'number') {
                    const d = new Date((c.LeavingDate - 25569) * 86400 * 1000);
                    $('nLeavingDate').value = d.toISOString().split('T')[0];
                } else {
                    $('nLeavingDate').value = String(c.LeavingDate).split('T')[0];
                }
            } else {
                $('nLeavingDate').value = '';
            }
            
            openModal('newClient');
        }
        
        async function archiveCurrentClient() {
            if (!currentClient) return;
            const name = `${currentClient.FirstName} ${currentClient.LastName}`;
            const confirmed = await appConfirm(`This will hide "${name}" from the active clients list.`, 'Archive Client');
            if (!confirmed) return;
            
            updateRecord('Clients', currentClient.ID, { Status: 'archived', ArchivedAt: new Date().toISOString() });
            toast(`${name} archived`, 'success');
            showPage('clients');
        }
        
        async function deleteCurrentClient() {
            if (!currentClient) return;
            const name = `${currentClient.FirstName} ${currentClient.LastName}`;
            
            // Store for undo before removing
            const clientCopy = { ...currentClient };
            addUndo({ type: 'delete_client', record: clientCopy });
            
            // Remove from local data
            const removedIdx = data.clients.findIndex(c => c.ID == currentClient.ID);
            if (removedIdx >= 0) {
                data.clients.splice(removedIdx, 1);
                saveCachedData();
            }
            
            // Send to server
            api('POST', { action: 'delete', sheet: 'Clients', id: currentClient.ID }).catch(() => {});
            
            toast(`${name} deleted`, 'success', true);
            showPage('clients');
        }

        // ========== SCHEDULE (WEEK/MONTH VIEW) ==========
        let weekOffset = 0;
        let monthOffset = 0;
        let scheduleView = 'week'; // 'week' or 'month'
        
        function setScheduleView(view) {
            scheduleView = view;
            // Update button styles
            $('viewWeek').style.background = view === 'week' ? 'var(--accent)' : 'white';
            $('viewWeek').style.color = view === 'week' ? 'white' : 'var(--text)';
            $('viewMonth').style.background = view === 'month' ? 'var(--accent)' : 'white';
            $('viewMonth').style.color = view === 'month' ? 'white' : 'var(--text)';
            $('viewList').style.background = view === 'list' ? 'var(--accent)' : 'white';
            $('viewList').style.color = view === 'list' ? 'white' : 'var(--text)';
            
            // Show/hide views
            $('weekList').style.display = view === 'week' ? 'block' : 'none';
            $('monthList').style.display = view === 'month' ? 'block' : 'none';
            $('scheduleListView').style.display = view === 'list' ? 'block' : 'none';
            
            // Render appropriate view
            if (view === 'week') {
                $('weekTitle').textContent = 'Schedule';
                $('weekSub').textContent = '';
                renderWeek();
            } else if (view === 'month') {
                renderMonth();
            } else if (view === 'list') {
                $('weekTitle').textContent = 'All Appointments';
                $('weekSub').textContent = `${data.appointments.length} total`;
                renderAllAppointments();
            }
        }
        
        function changePeriod(delta) {
            if (scheduleView === 'week') {
                if (delta === 0) {
                    weekOffset = 0;
                } else {
                    weekOffset += delta;
                }
                renderWeek();
            } else {
                if (delta === 0) {
                    monthOffset = 0;
                } else {
                    monthOffset += delta;
                }
                renderMonth();
            }
        }
        
        // Keep old function for compatibility
        function changeWeek(delta) {
            changePeriod(delta);
        }
        
        function renderWeek() {
            const now = new Date();
            
            // Get Monday of current week first
            const dayOfWeek = now.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() + mondayOffset + (weekOffset * 7));
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Update title based on offset
            if (weekOffset === 0) {
                $('weekTitle').textContent = 'This Week';
            } else if (weekOffset === -1) {
                $('weekTitle').textContent = 'Last Week';
            } else if (weekOffset === 1) {
                $('weekTitle').textContent = 'Next Week';
            } else if (weekOffset < 0) {
                $('weekTitle').textContent = `${Math.abs(weekOffset)} Weeks Ago`;
            } else {
                $('weekTitle').textContent = `${weekOffset} Weeks Ahead`;
            }
            
            const formatSubDate = d => d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            $('weekSub').textContent = `${formatSubDate(startOfWeek)} ‚Äì ${formatSubDate(endOfWeek)}, ${startOfWeek.getFullYear()}`;
            
            // Get all appointments for the selected week (only with valid clients)
            const weekAppts = data.appointments
                .filter(a => {
                    if (!getClient(a.ClientID)) return false;
                    let dateObj;
                    if (typeof a.Date === 'number') {
                        dateObj = new Date((a.Date - 25569) * 86400 * 1000);
                    } else {
                        dateObj = new Date(String(a.Date).split('T')[0] + 'T00:00:00');
                    }
                    return dateObj >= startOfWeek && dateObj <= endOfWeek;
                })
                .sort((a,b) => {
                    const dateCompare = getDateStr(a.Date).localeCompare(getDateStr(b.Date));
                    if (dateCompare !== 0) return dateCompare;
                    return (a.Time||'').localeCompare(b.Time||'');
                });
            
            if (!weekAppts.length) {
                $('weekList').innerHTML = '<div class="card"><div class="card-body empty">No appointments this week</div></div>';
                return;
            }
            
            // Group by date
            const grouped = {};
            weekAppts.forEach(a => {
                const dateKey = getDateStr(a.Date);
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(a);
            });
            
            // Render grouped
            let html = '';
            Object.keys(grouped).sort().forEach(dateKey => {
                const appts = grouped[dateKey];
                const dateObj = new Date(dateKey + 'T00:00:00');
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                const isTodays = dateKey === today();
                
                html += `<div class="card" style="margin-bottom:14px">
                    <div class="card-header" style="background:${isTodays ? 'var(--blush)' : 'var(--cream)'}">
                        <h2 class="card-title">${dayName}${isTodays ? ' (Today)' : ''}</h2>
                        <span style="font-size:11px;color:var(--rose)">${appts.length} appointment${appts.length > 1 ? 's' : ''}</span>
                    </div>
                    <div class="card-body" style="padding:0">
                        ${appts.map(a => {
                            const c = getClient(a.ClientID);
                            const typeClass = `appt-type-${normalizeApptType(a.Type).toLowerCase().replace(/\s+/g, '-')}`;
                            return `<div class="${typeClass} schedule-appt-row" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding:12px 14px;border-bottom:1px solid var(--blush);cursor:pointer" onclick="openClient('${a.ClientID}')">
                                <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:0">
                                    <div style="font-family:'Cormorant Garamond',serif;font-size:18px;width:50px;flex-shrink:0">${fmtTime(a.Time)}</div>
                                    <div class="avatar" style="flex-shrink:0">${initials(c.FirstName, c.LastName)}</div>
                                    <div style="min-width:0"><div style="font-weight:500">${c.FirstName} ${c.LastName}${a.ConfirmationSent ? ` <span class="confirmed-badge" onclick="event.stopPropagation();unmarkConfirmed('${a.ID}')" style="cursor:pointer" title="Click to undo confirmation">‚úì</span>` : ''}</div><div style="font-size:10px;color:var(--text-secondary)">${normalizeApptType(a.Type)} ¬∑ ${a.Consultant||''}</div></div>
                                </div>
                                <div style="display:flex;gap:4px;align-items:center;flex-shrink:0" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-secondary" onclick="editAppt('${a.ID}')">Edit</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deleteApptConfirm('${a.ID}')">‚úï</button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            });
            
            $('weekList').innerHTML = html;
        }
        
        function renderMonth() {
            const now = new Date();
            const targetMonth = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
            const monthName = targetMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Update title - always show year for clarity
            $('weekTitle').textContent = monthName;
            $('weekSub').textContent = `${data.appointments.length} total appointments in database`;
            
            // Get start and end of month
            const year = targetMonth.getFullYear();
            const month = targetMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Build calendar grid
            const todayStr = today();
            
            // Start from Monday of the week containing the 1st
            let startDay = new Date(firstDay);
            const firstDayOfWeek = firstDay.getDay();
            const mondayOffset = firstDayOfWeek === 0 ? -6 : 1 - firstDayOfWeek;
            startDay.setDate(firstDay.getDate() + mondayOffset);
            
            // Get all appointments for the month indexed by date
            const apptsByDate = {};
            
            // Build a list of all dates shown in the calendar (including prev/next month days)
            let tempDate = new Date(startDay);
            const calendarDates = new Set();
            for (let i = 0; i < 42; i++) {
                calendarDates.add(getDateStr(tempDate));
                tempDate.setDate(tempDate.getDate() + 1);
            }
            
            data.appointments.forEach(a => {
                if (!getClient(a.ClientID)) return;
                const dateStr = getDateStr(a.Date);
                if (!dateStr) return;
                
                // Include appointment if it falls on any day shown in the calendar
                if (calendarDates.has(dateStr)) {
                    if (!apptsByDate[dateStr]) apptsByDate[dateStr] = [];
                    apptsByDate[dateStr].push(a);
                }
            });
            
            // Sort appointments within each day by time
            Object.keys(apptsByDate).forEach(d => {
                apptsByDate[d].sort((a, b) => (a.Time || '').localeCompare(b.Time || ''));
            });
            
            let html = `<div class="card">
                <div class="card-body" style="padding:0">
                    <table style="width:100%;border-collapse:collapse;table-layout:fixed">
                        <thead>
                            <tr style="background:var(--cream)">
                                <th style="padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--taupe);border:1px solid var(--champagne)">Mon</th>
                                <th style="padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--taupe);border:1px solid var(--champagne)">Tue</th>
                                <th style="padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--taupe);border:1px solid var(--champagne)">Wed</th>
                                <th style="padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--taupe);border:1px solid var(--champagne)">Thu</th>
                                <th style="padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--taupe);border:1px solid var(--champagne)">Fri</th>
                                <th style="padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--taupe);border:1px solid var(--champagne)">Sat</th>
                                <th style="padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--taupe);border:1px solid var(--champagne)">Sun</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            let currentDate = new Date(startDay);
            let weekCount = 0;
            
            while (weekCount < 6) {
                html += '<tr>';
                
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    const dateStr = getDateStr(currentDate);
                    const isCurrentMonth = currentDate.getMonth() === month;
                    const isToday = dateStr === todayStr;
                    const dayAppts = apptsByDate[dateStr] || [];
                    const dayNum = currentDate.getDate();
                    
                    html += `<td style="
                        border:1px solid var(--champagne);
                        vertical-align:top;
                        height:100px;
                        padding:4px;
                        background:${isToday ? 'var(--blush)' : isCurrentMonth ? 'white' : 'var(--cream)'};
                        opacity:${isCurrentMonth ? '1' : '0.5'};
                        cursor:${dayAppts.length ? 'pointer' : 'default'}
                    " onclick="${dayAppts.length ? `showDayAppts('${dateStr}')` : ''}">
                        <div style="font-size:12px;font-weight:${isToday ? '700' : '500'};color:${isToday ? 'var(--rose)' : 'var(--charcoal)'};margin-bottom:4px">${dayNum}</div>`;
                    
                    // Show up to 3 appointments
                    dayAppts.slice(0, 3).forEach(a => {
                        const c = getClient(a.ClientID);
                        const typeColors = {
                            'consultation': '#e8d5d0',
                            'fitting': '#d5e0d5',
                            'pickup': '#d5d5e8',
                            'alteration': '#e8e5d0'
                        };
                        const bgColor = typeColors[(a.Type || '').toLowerCase()] || '#f0f0f0';
                        html += `<div style="
                            font-size:9px;
                            padding:2px 4px;
                            margin-bottom:2px;
                            background:${bgColor};
                            border-radius:3px;
                            white-space:nowrap;
                            overflow:hidden;
                            text-overflow:ellipsis;
                        " title="${fmtTime(a.Time)} - ${c.FirstName} ${c.LastName} (${normalizeApptType(a.Type)})">
                            <strong>${fmtTime(a.Time)}</strong> ${c.FirstName}
                        </div>`;
                    });
                    
                    if (dayAppts.length > 3) {
                        html += `<div style="font-size:9px;color:var(--taupe);padding:2px">+${dayAppts.length - 3} more</div>`;
                    }
                    
                    html += '</td>';
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                html += '</tr>';
                weekCount++;
                
                // Stop if we've passed the end of the month and completed the week
                if (currentDate.getMonth() !== month && currentDate.getDay() === 1) break;
            }
            
            html += '</tbody></table></div></div>';
            
            // Day detail popup
            html += `<div id="dayApptPopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.2);z-index:1000;max-width:400px;width:90%">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--champagne)">
                    <h3 style="margin:0;font-size:14px" id="dayApptTitle">Appointments</h3>
                    <button onclick="$('dayApptPopup').style.display='none';$('dayApptOverlay').style.display='none'" style="background:none;border:none;font-size:20px;cursor:pointer">√ó</button>
                </div>
                <div id="dayApptList" style="padding:14px 18px;max-height:400px;overflow-y:auto"></div>
            </div>
            <div id="dayApptOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:999" onclick="$('dayApptPopup').style.display='none';this.style.display='none'"></div>`;
            
            $('monthList').innerHTML = html;
        }
        
        function showDayAppts(dateStr) {
            const dateObj = new Date(dateStr + 'T00:00:00');
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            const dayAppts = data.appointments
                .filter(a => getDateStr(a.Date) === dateStr && getClient(a.ClientID))
                .sort((a, b) => (a.Time || '').localeCompare(b.Time || ''));
            
            $('dayApptTitle').textContent = dayName;
            $('dayApptList').innerHTML = dayAppts.map(a => {
                const c = getClient(a.ClientID);
                return `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--blush)">
                    <div style="font-size:12px;width:50px;color:var(--taupe)">${fmtTime(a.Time)}</div>
                    <div class="avatar" style="width:32px;height:32px;font-size:11px">${initials(c.FirstName, c.LastName)}</div>
                    <div style="flex:1">
                        <div style="font-weight:500;font-size:13px">${c.FirstName} ${c.LastName}</div>
                        <div style="font-size:10px;color:var(--taupe)">${normalizeApptType(a.Type)} ¬∑ ${a.Consultant || ''}</div>
                    </div>
                    <div style="display:flex;gap:4px">
                        <button class="btn btn-sm btn-secondary" onclick="$('dayApptPopup').style.display='none';$('dayApptOverlay').style.display='none';editAppt('${a.ID}')">Edit</button>
                        <button class="btn btn-sm btn-primary" onclick="$('dayApptPopup').style.display='none';$('dayApptOverlay').style.display='none';openClient('${a.ClientID}')">View</button>
                    </div>
                </div>`;
            }).join('');
            
            $('dayApptOverlay').style.display = 'block';
            $('dayApptPopup').style.display = 'block';
        }

        // ========== ALL APPOINTMENTS ==========
        function renderAllAppointments() {
            try {
                const filterEl = $('apptFilter');
                const typeFilterEl = $('apptTypeFilter');
                const searchEl = $('apptSearch');
                const tableEl = $('allApptTable');
                
                console.log('=== RENDER ALL APPOINTMENTS ===');
                console.log('Elements found:', { filterEl: !!filterEl, typeFilterEl: !!typeFilterEl, searchEl: !!searchEl, tableEl: !!tableEl });
                
                if (!filterEl || !typeFilterEl || !searchEl || !tableEl) {
                    console.log('List view elements not found - aborting');
                    return;
                }
                
                const filter = filterEl.value;
                const typeFilter = typeFilterEl.value;
                const search = searchEl.value.toLowerCase();
                const todayStr = today();
                
                console.log('Filter values:', { filter, typeFilter, search, todayStr });
                console.log('Total appointments in data:', data.appointments.length);
                console.log('Total clients in data:', data.clients.length);
                
                // Populate type filter dropdown (preserve current selection)
                const serviceTypes = getServiceTypes();
                const currentFilterHtml = typeFilterEl.innerHTML;
                if (!currentFilterHtml.includes(serviceTypes[0] || 'Consultation')) {
                    typeFilterEl.innerHTML = '<option value="">All Types</option>' + 
                        serviceTypes.map(t => `<option value="${t.toLowerCase()}" ${t.toLowerCase() === typeFilter ? 'selected' : ''}>${t}</option>`).join('');
                }
                
                // Start with only appointments that have valid clients
                let appts = data.appointments.filter(function(a) {
                    const client = getClient(a.ClientID);
                    return client;
                });
                
                console.log('Appointments with valid clients:', appts.length);
                
                // Filter by time
                if (filter === 'upcoming') {
                    appts = appts.filter(a => getDateStr(a.Date) >= todayStr);
                    console.log('After upcoming filter:', appts.length);
                } else if (filter === 'past') {
                    appts = appts.filter(a => getDateStr(a.Date) < todayStr);
                    console.log('After past filter:', appts.length);
                }
                
                // Filter by type
                if (typeFilter) {
                    appts = appts.filter(a => (a.Type || '').toLowerCase().includes(typeFilter.toLowerCase()));
                    console.log('After type filter:', appts.length);
                }
                
                // Filter by search
                if (search) {
                    appts = appts.filter(a => {
                        const c = getClient(a.ClientID);
                        const clientName = `${c.FirstName} ${c.LastName}`.toLowerCase();
                        return clientName.includes(search);
                    });
                    console.log('After search filter:', appts.length);
                }
                
                // Sort by date descending for past, ascending for upcoming/all
                appts.sort((a, b) => {
                    const dateCompare = getDateStr(a.Date).localeCompare(getDateStr(b.Date));
                    if (filter === 'past') return -dateCompare;
                    return dateCompare;
                });
                
                // Update subtitle with count
                if ($('weekSub')) {
                    $('weekSub').textContent = `${appts.length} appointment${appts.length !== 1 ? 's' : ''}`;
                }
                
                const selectAllEl = $('selectAllAppts');
                const deleteBtn = $('btnDeleteAppts');
                if (selectAllEl) selectAllEl.checked = false;
                if (deleteBtn) deleteBtn.style.display = 'none';
                
                console.log('About to render', appts.length, 'appointments to table');
                
                tableEl.innerHTML = appts.length ? appts.map(a => {
                    const c = getClient(a.ClientID);
                    const isPast = getDateStr(a.Date) < todayStr;
                    return `<tr style="${isPast ? 'opacity:0.6' : ''}">
                        <td onclick="event.stopPropagation()"><input type="checkbox" class="appt-checkbox" data-id="${a.ID}" onchange="updateApptSelection()"></td>
                        <td onclick="openClient('${a.ClientID}')" style="cursor:pointer">${fmtDate(a.Date)}</td>
                        <td onclick="openClient('${a.ClientID}')" style="cursor:pointer">${fmtTime(a.Time)}</td>
                        <td onclick="openClient('${a.ClientID}')" style="cursor:pointer">${c.FirstName} ${c.LastName}</td>
                        <td onclick="openClient('${a.ClientID}')" style="cursor:pointer"><span class="status status-${(a.Type||'consultation').replace(' ','-')}">${normalizeApptType(a.Type)}</span></td>
                        <td onclick="openClient('${a.ClientID}')" style="cursor:pointer">${a.Consultant || ''}${a.ConfirmationSent ? ` <span class="confirmed-badge" onclick="event.stopPropagation();unmarkConfirmed('${a.ID}')" style="cursor:pointer" title="Click to undo">‚úì</span>` : ''}</td>
                        <td style="text-align:right">
                            <div style="display:flex;gap:4px;justify-content:flex-end;align-items:center">
                                ${confirmButtons(a.ID, a.ConfirmationSent)}
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();editAppt('${a.ID}')">Edit</button>
                                <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteAppt('${a.ID}')">‚úï</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('') : '<tr><td colspan="7" class="empty">No appointments found</td></tr>';
                
                console.log('Table rendered successfully');
            } catch (err) {
                console.error('Error in renderAllAppointments:', err);
            }
        }
        
        function toggleAllAppts(checked) {
            document.querySelectorAll('.appt-checkbox').forEach(function(cb) {
                cb.checked = checked;
            });
            updateApptSelection();
        }
        
        function updateApptSelection() {
            const selected = document.querySelectorAll('.appt-checkbox:checked').length;
            $('btnDeleteAppts').style.display = selected > 0 ? 'inline-block' : 'none';
            $('btnDeleteAppts').textContent = 'üóë Delete (' + selected + ')';
        }
        
        async function bulkDeleteAppointments() {
            const checkboxes = document.querySelectorAll('.appt-checkbox:checked');
            const count = checkboxes.length;
            if (count === 0) return;
            
            const confirmed = await appConfirmDanger(`Delete ${count} appointment(s)?`, 'Delete Appointments');
            if (!confirmed) return;
            
            // Collect IDs and store records for undo
            const ids = [];
            const deletedAppts = [];
            checkboxes.forEach(function(cb) { 
                const id = cb.dataset.id;
                ids.push(id);
                const appt = data.appointments.find(a => a.ID == id);
                if (appt) deletedAppts.push({ ...appt });
            });
            
            // Add to undo stack
            addUndo({ type: 'bulk_delete_appointments', records: deletedAppts });
            
            // Optimistic UI update - remove immediately
            ids.forEach(function(id) {
                data.appointments = data.appointments.filter(function(a) { return a.ID != id; });
            });
            
            // Update UI immediately
            renderAllAppointments();
            renderDash();
            renderWeek();
            toast(count + ' appointment(s) deleted', 'success', true);
            
            // Fire all deletes in background (don't await)
            ids.forEach(function(id) {
                api('POST', { action: 'delete', sheet: 'Appointments', id: id }).catch(function() {});
            });
        }

        async function deleteAppt(id) {
            console.log('deleteAppt called with ID:', id, 'type:', typeof id);
            
            // Store for undo before removing
            const removedIdx = data.appointments.findIndex(a => String(a.ID) === String(id));
            console.log('Found appointment at index:', removedIdx);
            
            let removedAppt = null;
            if (removedIdx >= 0) {
                removedAppt = { ...data.appointments[removedIdx] };
                data.appointments.splice(removedIdx, 1);
                saveCachedData();
                
                // Add to undo stack
                addUndo({ type: 'delete_appointment', record: removedAppt });
                
                // Update UI immediately
                toast('Appointment deleted', 'success', true);
                renderDash();
                renderWeek();
                renderAllAppointments();
                if (currentClient) renderClientAppts();
                
                // Send to server in background (fire and forget)
                api('POST', { action: 'delete', sheet: 'Appointments', id }).catch(e => console.error('Delete API error:', e));
            } else {
                console.error('Appointment not found with ID:', id);
                console.log('Available IDs:', data.appointments.map(a => a.ID));
                toast('Could not find appointment', 'error');
            }
        }

        // ========== CONFIRMATION EMAIL ==========
        const DEFAULT_CONFIRM_TEMPLATE = `Hi {{firstName}}, 

Thank you for booking a bridal consultation with us at Estrelle Bridal, we can't wait to meet you and help you find the one!

Appointment: {{appointmentDate}} @{{appointmentTime}}

WHAT TO EXPECT DURING YOUR BRIDAL CONSULTATION

1. You're allowed up to 4 guests MAXIMUM
2. Shoes are not permitted in the private fitting rooms. We provide slippers and shoe covers for every guest
3. We provide heels, spanx, and hair ties; we recommend wearing nude or white underwear
4. We require a 48 hour notice for cancellations to ensure you get your full refund. Includes one rescheduling
5. Please give us a call if you are running late. If you are more than 15 minutes late to your consultation, you will automatically have a shorter appointment time. If you don't respond within 30 min of contacting you, your appointment is automatically cancelled!

I am not sure if you are familiar with our assortment or if you have a particular dress direction you are hoping to explore? If you can share some of your inspirations with us that would be great!

Below I have included a list of our collections with some additional details that I thought could prove to be helpful to you in your initial research. 

Our designers and price ranges:
Vivienne Westwood $8,000- $20,000
Netta Benshabu $12,800- $17,000 
Lihi Hod $10,000-$15,000
Nicole + Felicia $3,900- $11,000
Stephane Rolland $10,000- $17,000
Corston Couture $6,000- $9,000
Tina Valerdi $3,900-$6,000
Enaura Bridal $6,000- $10,000

*Please note that most of our dresses are customizable* 

Parking:
There is paid underground parking in the Yorkville Village building, look for the Wholefoods.
We are located on the upper level of the mall, near the escalators and across from TNT Fashion.  

Please let me know if you have any questions at all or if I can provide any additional information to you prior to your consultation with us. 

I recommend browsing our website and coming to the appointment prepared with dresses that you want to try on. 

Please respond to this message to confirm the details above. 

We look forward to hearing from you soon! :)

Best regards, 
The Estrelle Bridal Team`;

        const CONFIRM_TEMPLATE_KEY = 'estrelle_confirm_template';

        function getConfirmTemplate() {
            const saved = localStorage.getItem(CONFIRM_TEMPLATE_KEY);
            if (!saved) {
                console.log('No saved template, using default');
                return { text: DEFAULT_CONFIRM_TEMPLATE, html: null };
            }
            
            try {
                const data = JSON.parse(saved);
                if (data.version === 2) {
                    if (data.html) {
                        console.log('Loading HTML template');
                        return { text: data.text || null, html: data.html };
                    } else if (data.text) {
                        console.log('Loading text-only template');
                        return { text: data.text, html: null };
                    }
                }
            } catch (e) {
                // Old format - plain text
                console.log('Loading legacy plain text template');
                return { text: saved, html: null };
            }
            
            return { text: DEFAULT_CONFIRM_TEMPLATE, html: null };
        }

        function saveConfirmTemplate() {
            // Get the HTML content from the rich text editor (preserves formatting)
            let template = $('confirmBodyEditor').innerHTML;
            
            console.log('Saving template with HTML, length:', template.length);
            
            // Get the values that were substituted
            const firstName = $('confirmFirstName').value;
            const lastName = $('confirmLastName').value;
            const apptDate = $('confirmApptDate').value;
            const apptTime = $('confirmApptTime').value;
            const apptType = $('confirmApptType').value;
            
            // Replace actual values back to placeholders (in HTML)
            if (firstName) {
                template = template.split(firstName).join('{{firstName}}');
            }
            if (lastName) {
                template = template.split(lastName).join('{{lastName}}');
            }
            if (apptDate) {
                template = template.split(apptDate).join('{{appointmentDate}}');
            }
            if (apptTime) {
                template = template.split(apptTime).join('{{appointmentTime}}');
            }
            if (apptType) {
                template = template.split(apptType).join('{{appointmentType}}');
            }
            
            // Save with a flag indicating it's HTML
            const templateData = {
                html: template,
                version: 2
            };
            
            localStorage.setItem(CONFIRM_TEMPLATE_KEY, JSON.stringify(templateData));
            console.log('Template saved to localStorage with HTML formatting');
            toast('Template saved!', 'success');
        }

        function resetConfirmTemplate() {
            if (!confirm('Reset to default template? Your saved template will be lost.')) return;
            localStorage.removeItem(CONFIRM_TEMPLATE_KEY);
            const apptId = $('confirmApptId').value;
            if (apptId) openConfirmEmailModal(+apptId);
            toast('Template reset to default', 'success');
        }

        let lastAction = null; // Store last action for undo
        
        function markConfirmed(apptId) {
            console.log('markConfirmed called with ID:', apptId, 'type:', typeof apptId);
            
            const appt = data.appointments.find(a => String(a.ID) === String(apptId));
            console.log('Found appointment:', appt);
            
            if (!appt) { 
                console.error('Appointment not found. All IDs:', data.appointments.map(a => a.ID));
                toast('Appointment not found', 'error'); 
                return; 
            }
            
            const client = getClient(appt.ClientID);
            const clientName = client ? `${client.FirstName} ${client.LastName}` : 'Unknown';
            
            // Store for undo
            const previousValue = appt.ConfirmationSent;
            lastAction = {
                type: 'confirm',
                apptId: apptId,
                previousValue: previousValue,
                clientName: clientName
            };
            
            // Mark as confirmed without sending email
            const timestamp = new Date().toISOString();
            appt.ConfirmationSent = timestamp;
            console.log('Set ConfirmationSent to:', timestamp);
            
            updateRecord('Appointments', apptId, { ConfirmationSent: timestamp });
            saveCachedData();
            
            // Show toast with undo option
            toastWithUndo(`Marked ${clientName}'s appointment as confirmed`);
            renderDash();
        }
        
        function undoLastAction() {
            if (!lastAction) return;
            
            if (lastAction.type === 'confirm') {
                const appt = data.appointments.find(a => String(a.ID) === String(lastAction.apptId));
                if (appt) {
                    appt.ConfirmationSent = lastAction.previousValue || '';
                    updateRecord('Appointments', lastAction.apptId, { ConfirmationSent: appt.ConfirmationSent || '' });
                    saveCachedData();
                    toast('Undone!', 'success');
                    renderDash();
                }
            }
            
            lastAction = null;
        }
        
        function toastWithUndo(message) {
            // Remove existing toast
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const div = document.createElement('div');
            div.className = 'toast show';
            div.innerHTML = `
                <span>${message}</span>
                <button onclick="undoLastAction();this.parentElement.remove()" style="margin-left:12px;background:rgba(255,255,255,0.2);border:none;color:white;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px">Undo</button>
            `;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }
        
        // Helper to generate consistent confirmation buttons
        function confirmButtons(apptId, isConfirmed, compact = false) {
            if (isConfirmed) {
                return compact 
                    ? `<span class="confirmed-badge" onclick="event.stopPropagation();unmarkConfirmed('${apptId}')" style="cursor:pointer" title="Click to undo">‚úì Confirmed</span>`
                    : `<div class="confirm-btns">
                        <button class="btn btn-sm btn-confirmed" onclick="event.stopPropagation();unmarkConfirmed('${apptId}')" title="Click to undo confirmation">‚úì</button>
                        <button class="btn btn-sm btn-email" onclick="event.stopPropagation();openConfirmEmailModal('${apptId}')" title="Resend confirmation">üìß</button>
                    </div>`;
            }
            return `<div class="confirm-btns">
                <button class="btn btn-sm btn-done" onclick="event.stopPropagation();markConfirmed('${apptId}')" title="Mark confirmed (no email)">‚úì</button>
                <button class="btn btn-sm btn-email" onclick="event.stopPropagation();openConfirmEmailModal('${apptId}')" title="Send confirmation email">üìß</button>
            </div>`;
        }
        
        async function unmarkConfirmed(apptId) {
            const appt = data.appointments.find(a => String(a.ID) === String(apptId));
            if (!appt) { 
                toast('Appointment not found', 'error'); 
                return; 
            }
            
            const client = getClient(appt.ClientID);
            const clientName = client ? `${client.FirstName} ${client.LastName}` : 'Unknown';
            
            const confirmed = await appConfirm(`Remove confirmation for ${clientName}'s appointment?`, 'Remove Confirmation');
            if (!confirmed) return;
            
            // Clear confirmation
            appt.ConfirmationSent = '';
            updateRecord('Appointments', apptId, { ConfirmationSent: '' });
            saveCachedData();
            
            toast(`Confirmation removed for ${clientName}`, 'success');
            renderDash();
            renderWeek();
            renderAllAppointments();
        }
        
        function openConfirmEmailModal(apptId) {
            const appt = data.appointments.find(a => a.ID == apptId);
            if (!appt) { toast('Appointment not found', 'error'); return; }
            
            const client = getClient(appt.ClientID);
            if (!client) { toast('Client not found', 'error'); return; }
            
            if (!client.Email) { 
                toast('No email address for this client. Please add one first.', 'error'); 
                return; 
            }
            
            // Format appointment date (handle Google Sheets serial dates)
            let apptDate = '';
            if (appt.Date) {
                let dateObj;
                if (typeof appt.Date === 'number') {
                    dateObj = new Date((appt.Date - 25569) * 86400 * 1000);
                } else {
                    dateObj = new Date(String(appt.Date).split('T')[0] + 'T00:00:00');
                }
                apptDate = dateObj.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});
            }
            const apptTime = fmtTime(appt.Time);
            
            // Fill in template - handle both HTML and plain text
            const template = getConfirmTemplate();
            let bodyHtml = '';
            let bodyText = '';
            
            if (template.html) {
                // HTML template - replace placeholders in HTML
                bodyHtml = template.html
                    .replace(/\{\{firstName\}\}/g, client.FirstName || '')
                    .replace(/\{\{lastName\}\}/g, client.LastName || '')
                    .replace(/\{\{appointmentDate\}\}/g, apptDate)
                    .replace(/\{\{appointmentTime\}\}/g, apptTime)
                    .replace(/\{\{appointmentType\}\}/g, appt.Type || 'Bridal Consultation');
                // Extract plain text for hidden field
                const temp = document.createElement('div');
                temp.innerHTML = bodyHtml;
                bodyText = temp.innerText;
            } else {
                // Plain text template
                bodyText = template.text
                    .replace(/\{\{firstName\}\}/g, client.FirstName || '')
                    .replace(/\{\{lastName\}\}/g, client.LastName || '')
                    .replace(/\{\{appointmentDate\}\}/g, apptDate)
                    .replace(/\{\{appointmentTime\}\}/g, apptTime)
                    .replace(/\{\{appointmentType\}\}/g, appt.Type || 'Bridal Consultation');
            }
            
            $('confirmApptId').value = apptId;
            $('confirmTo').value = client.Email;
            $('confirmSubject').value = `${getStoreInfo().name || 'Estrelle Bridal'} - Appointment Confirmation for ${client.FirstName}`;
            $('confirmBody').value = bodyText;
            
            // Store values for reverse replacement when saving template
            $('confirmFirstName').value = client.FirstName || '';
            $('confirmLastName').value = client.LastName || '';
            $('confirmApptDate').value = apptDate;
            $('confirmApptTime').value = apptTime;
            $('confirmApptType').value = appt.Type || 'Bridal Consultation';
            
            // Hide follow-up notes reminder for regular confirmations
            const notesDiv = $('followUpNotesReminder');
            if (notesDiv) notesDiv.style.display = 'none';
            
            // Clear editor first before opening modal
            const editor = $('confirmBodyEditor');
            if (editor) editor.innerHTML = '';
            
            openModal('confirmEmail');
            
            // Sync content to rich text editor
            setTimeout(() => {
                const editor = $('confirmBodyEditor');
                if (editor) {
                    if (bodyHtml) {
                        // Use HTML if available (preserves formatting)
                        editor.innerHTML = bodyHtml;
                    } else {
                        // Fall back to plain text
                        editor.innerText = bodyText;
                    }
                }
            }, 50);
        }
        
        // Rich text formatting functions - generic for any editor
        let currentEditorId = 'confirmBodyEditor';
        let currentTextareaId = 'confirmBody';
        
        function setCurrentEditor(editorId, textareaId) {
            currentEditorId = editorId;
            currentTextareaId = textareaId;
        }
        
        function formatEmailText(format, editorId) {
            const editor = $(editorId || currentEditorId);
            if (!editor) return;
            
            // Focus editor first
            editor.focus();
            
            const selection = window.getSelection();
            
            if (format === 'bold') {
                document.execCommand('bold', false, null);
            } else if (format === 'italic') {
                document.execCommand('italic', false, null);
            } else if (format === 'underline') {
                document.execCommand('underline', false, null);
            } else if (format === 'heading') {
                const selectedText = selection.toString();
                if (selectedText) {
                    document.execCommand('insertHTML', false, `<b style="font-size:16px">${selectedText}</b>`);
                }
            } else if (format === 'bullet') {
                document.execCommand('insertUnorderedList', false, null);
            } else if (format === 'link') {
                const url = prompt('Enter URL:');
                if (url) {
                    document.execCommand('createLink', false, url);
                }
            }
        }
        
        function syncRichTextEditor(editorId, textareaId) {
            const editor = $(editorId);
            const textarea = $(textareaId);
            if (editor && textarea) {
                // Get HTML content
                let html = editor.innerHTML;
                
                // Debug: log the raw HTML to understand structure
                console.log('Raw HTML:', html);
                
                // Step 1: Normalize the HTML structure
                // Empty div with just <br> = blank line
                html = html.replace(/<div><br\s*\/?><\/div>/gi, '{{NEWLINE}}');
                html = html.replace(/<p><br\s*\/?><\/p>/gi, '{{NEWLINE}}');
                
                // Step 2: Add newline BEFORE each opening <div> (except first)
                // This handles: text<div>more text</div>
                html = html.replace(/([^>])(<div[^>]*>)/gi, '$1{{NEWLINE}}$2');
                
                // Step 3: Replace <br> tags with newlines
                html = html.replace(/<br\s*\/?>/gi, '{{NEWLINE}}');
                
                // Step 4: Remove all HTML tags
                html = html.replace(/<[^>]+>/g, '');
                
                // Step 5: Convert placeholders to actual newlines
                html = html.replace(/\{\{NEWLINE\}\}/g, '\n');
                
                // Step 6: Decode HTML entities
                const temp = document.createElement('textarea');
                temp.innerHTML = html;
                let text = temp.value;
                
                // Step 7: Replace non-breaking spaces
                text = text.replace(/\u00A0/g, ' ');
                
                // Step 8: Normalize newlines - collapse 3+ to 2
                text = text.replace(/\n{3,}/g, '\n\n');
                
                // Step 9: Trim
                text = text.trim();
                
                console.log('Final text:', JSON.stringify(text));
                
                textarea.value = text;
            }
        }
        
        function initRichTextEditor(editorId, textareaId) {
            const editor = $(editorId);
            const textarea = $(textareaId);
            if (editor && textarea) {
                editor.innerText = textarea.value;
            }
        }
        
        // ========== EMAIL PREVIEW ==========
        let previewEmailData = null;
        let previewSourceModal = null;
        let previewEditorId = null;
        let previewTextareaId = null;
        let previewOnSend = null;
        
        function showEmailPreview(toId, subjectId, bodyId, editorId, sourceModal, onSend) {
            // Sync editor first
            if (editorId && $(editorId)) {
                syncRichTextEditor(editorId, bodyId);
            }
            
            const to = $(toId)?.value || $(toId)?.textContent || '';
            const subject = $(subjectId)?.value || '';
            const body = $(bodyId)?.value || '';
            const formattedBody = $(editorId)?.innerHTML || '';
            
            console.log('Preview - body length:', body.length, 'formatted length:', formattedBody.length);
            
            if (!to) { toast('No email address', 'error'); return; }
            
            // Store for later
            previewEmailData = { to, subject, body, formattedBody };
            previewSourceModal = sourceModal;
            previewEditorId = editorId;
            previewTextareaId = bodyId;
            previewOnSend = onSend;
            
            // Populate preview
            $('previewTo').textContent = to;
            $('previewSubject').textContent = subject;
            
            // Show formatted HTML if available, otherwise plain text
            if (formattedBody && formattedBody.trim()) {
                $('previewBody').innerHTML = formattedBody;
            } else {
                $('previewBody').innerText = body;
            }
            
            // Hide source modal, show preview
            if (sourceModal) {
                $('modal-' + sourceModal)?.classList.remove('active');
            }
            openModal('emailPreview');
            
            // Scroll modal body to top
            setTimeout(() => {
                const modalBody = document.querySelector('#modal-emailPreview .modal-body');
                if (modalBody) modalBody.scrollTop = 0;
            }, 50);
        }
        
        function closeEmailPreview() {
            closeModal('emailPreview');
            // Re-open source modal
            if (previewSourceModal) {
                openModal(previewSourceModal);
            }
        }
        
        function openPreviewInGmail() {
            if (!previewEmailData) return;
            
            const { to, subject, body } = previewEmailData;
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            
            closeModal('emailPreview');
            toast('Email opened in Gmail (plain text)', 'success');
            
            // Call onSend callback if provided
            if (previewOnSend) previewOnSend();
        }
        
        function confirmSendFromPreview() {
            if (!previewEmailData) return;
            
            const { to, subject, body } = previewEmailData;
            
            closeModal('emailPreview');
            
            // Send via API
            sendEmailViaPreferredMethod(to, subject, body, () => {
                if (previewOnSend) previewOnSend();
            });
        }
        
        // Generic function to open any email in Gmail
        function openEmailInGmail(toId, subjectId, bodyId, editorId, onSuccess) {
            // Sync editor if exists
            if (editorId && $(editorId)) {
                syncRichTextEditor(editorId, bodyId);
            }
            
            const to = $(toId)?.value || $(toId)?.textContent || '';
            const subject = $(subjectId)?.value || '';
            const body = $(bodyId)?.value || '';
            
            if (!to) { toast('No email address', 'error'); return; }
            
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            
            toast('Email opened in Gmail', 'success');
            if (onSuccess) onSuccess();
        }
        
        // Generate email toolbar HTML
        function getEmailToolbarHTML(editorId) {
            return `
                <div class="email-toolbar" style="display:flex;gap:4px;margin-bottom:8px;padding:8px;background:#f5f5f5;border-radius:5px;flex-wrap:wrap">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bold', '${editorId}')" title="Bold"><b>B</b></button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('italic', '${editorId}')" title="Italic"><i>I</i></button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('underline', '${editorId}')" title="Underline"><u>U</u></button>
                    <span style="border-left:1px solid #ccc;margin:0 4px"></span>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('heading', '${editorId}')" title="Heading">H</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('bullet', '${editorId}')" title="Bullet List">‚Ä¢</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="formatEmailText('link', '${editorId}')" title="Add Link">üîó</button>
                </div>
            `;
        }
        
        // Legacy support for confirmation email
        function formatEmail(format) {
            formatEmailText(format, 'confirmBodyEditor');
        }
        
        function syncEmailEditor() {
            syncRichTextEditor('confirmBodyEditor', 'confirmBody');
        }
        
        function previewConfirmationEmail() {
            const apptId = $('confirmApptId').value;
            
            showEmailPreview(
                'confirmTo', 
                'confirmSubject', 
                'confirmBody', 
                'confirmBodyEditor', 
                'confirmEmail',
                () => {
                    // Don't auto-mark as sent - let user manually click done
                    renderDash();
                    renderWeek();
                    renderAllAppointments();
                }
            );
        }
        
        function openConfirmInGmail() {
            syncEmailEditor();
            
            const apptId = $('confirmApptId').value;
            const to = $('confirmTo').value;
            const subject = $('confirmSubject').value;
            const body = $('confirmBody').value;
            
            if (!to) { toast('No email address', 'error'); return; }
            
            // Open Gmail with pre-filled email
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            
            // Don't auto-mark as sent - let user manually click done
            
            closeModal('confirmEmail');
            toast('Email opened in Gmail', 'success');
            
            // Re-render views
            renderDash();
            renderWeek();
            renderAllAppointments();
        }
        
        // Preview functions for all email modals
        function previewAnniversaryEmail() {
            const clientId = $('annEmailClientId').value;
            showEmailPreview(
                'annEmailTo', 
                'annEmailSubject', 
                'annEmailBody', 
                'annEmailBodyEditor', 
                'sendAnnEmail',
                () => {
                    saveAnniversaryEmail(clientId, 'sent', new Date().toISOString().split('T')[0]);
                    renderAnniversariesView();
                }
            );
        }
        
        function previewClientEmail() {
            showEmailPreview(
                'clientEmailTo', 
                'clientEmailSubject', 
                'clientEmailBody', 
                'clientEmailBodyEditor', 
                'clientEmail',
                () => closeModal('clientEmail')
            );
        }
        
        function sendClientEmail() {
            syncRichTextEditor('clientEmailBodyEditor', 'clientEmailBody');
            const to = $('clientEmailTo')?.textContent || '';
            const subject = $('clientEmailSubject')?.value || '';
            const body = $('clientEmailBody')?.value || '';
            
            if (!to) { toast('No email address', 'error'); return; }
            
            closeModal('clientEmail');
            sendEmailViaPreferredMethod(to, subject, body);
        }
        
        function previewOrderEmail() {
            showEmailPreview(
                'orderEmailTo', 
                'orderEmailSubject', 
                'orderEmailBody', 
                'orderEmailBodyEditor', 
                'orderEmail',
                null
            );
        }
        
        function previewAnniversaryEmail2() {
            const clientId = $('annEmail2ClientId').value;
            showEmailPreview(
                'annEmail2To', 
                'annEmail2Subject', 
                'annEmail2Body', 
                'annEmail2BodyEditor', 
                'anniversaryEmail',
                () => {
                    const sentEmails = JSON.parse(localStorage.getItem('estrelle_anniversary_sent') || '{}');
                    sentEmails[`${clientId}-${new Date().getFullYear()}`] = today();
                    localStorage.setItem('estrelle_anniversary_sent', JSON.stringify(sentEmails));
                    renderAnniversaries();
                }
            );
        }

        async function sendConfirmationEmail() {
            // Sync editor content first
            syncEmailEditor();
            
            const apptId = $('confirmApptId').value;
            const to = $('confirmTo').value;
            const subject = $('confirmSubject').value;
            const body = $('confirmBody').value;
            
            if (!to) { toast('No email address', 'error'); return; }
            
            closeModal('confirmEmail');
            
            // Send via preferred method (Gmail or direct)
            sendEmailViaPreferredMethod(to, subject, body, () => {
                // Don't auto-mark as sent - let user manually click done
                
                // Re-render views
                renderDash();
                renderWeek();
                renderAllAppointments();
            });
        }

        // ========== FOLLOW-UP EMAILS ==========
        function openFollowUpEmail(apptId) {
            const appt = data.appointments.find(a => a.ID == apptId);
            if (!appt) { toast('Appointment not found', 'error'); return; }
            
            const client = getClient(appt.ClientID);
            if (!client) { toast('Client not found', 'error'); return; }
            
            if (!client.Email) { 
                toast('No email address for this client', 'error'); 
                return; 
            }
            
            // Get client's top options (starred)
            const topOptionsList = data.topoptions
                .filter(o => o.ClientID == client.ID && (o.IsFavorite === true || o.IsFavorite === 'TRUE'))
                .map(o => `${o.Designer} - ${o.Style}`);
            
            const topOptionsText = topOptionsList.length 
                ? `You looked absolutely stunning in your top choices:\n‚Ä¢ ${topOptionsList.join('\n‚Ä¢ ')}\n`
                : '';
            
            const storeName = getStoreInfo().name || 'Estrelle Bridal';
            
            // Get customizable template
            const template = getFollowupTemplate();
            
            // Replace placeholders
            let subject = template.subject
                .replace(/\{firstName\}/g, client.FirstName || '')
                .replace(/\{storeName\}/g, storeName);
            
            let body = template.body
                .replace(/\{firstName\}/g, client.FirstName || '')
                .replace(/\{appointmentType\}/g, appt.Type || 'Bridal Consultation')
                .replace(/\{appointmentDate\}/g, fmtDate(appt.Date))
                .replace(/\{topOptions\}/g, topOptionsText)
                .replace(/\{storeName\}/g, storeName);
            
            $('confirmApptId').value = apptId;
            $('confirmTo').value = client.Email;
            $('confirmSubject').value = subject;
            $('confirmBody').value = body;
            
            // Show follow-up notes if they exist
            const notesDiv = $('followUpNotesReminder');
            if (notesDiv) {
                if (appt.FollowUpNotes && appt.FollowUpNotes.trim()) {
                    notesDiv.innerHTML = `<div style="background:#fff3cd;padding:10px;border-radius:5px;margin-bottom:12px;font-size:11px;border-left:3px solid #f0ad4e"><strong>üìù Consultant Notes:</strong> ${appt.FollowUpNotes}</div>`;
                    notesDiv.style.display = 'block';
                } else {
                    notesDiv.style.display = 'none';
                }
            }
            
            // Clear and set editor content
            const editor = $('confirmBodyEditor');
            if (editor) editor.innerText = body;
            
            openModal('confirmEmail');
        }
        
        async function markFollowUpDone(apptId) {
            // Add to undo stack
            addUndo({ type: 'mark_followup_done', id: apptId });
            
            updateRecord('Appointments', apptId, { FollowUpDone: true });
            
            // Update local data
            const appt = data.appointments.find(a => a.ID == apptId);
            if (appt) appt.FollowUpDone = true;
            
            toast('Follow-up marked complete', 'success', true);
            renderDash();
        }
        
        function updateFollowUpDate() {
            const days = $('aFollowUp').value;
            if (days === '') {
                $('followUpDateDisplay').style.display = 'none';
                $('followUpNotesGroup').style.display = 'none';
                $('aFollowUpDate').value = '';
                $('aFollowUpDatePicker').style.display = 'none';
                $('aFollowUpDate').style.display = 'block';
            } else if (days === 'custom') {
                // Show date picker for custom date
                $('followUpDateDisplay').style.display = 'block';
                $('followUpNotesGroup').style.display = 'block';
                $('aFollowUpDatePicker').style.display = 'block';
                $('aFollowUpDate').style.display = 'none';
                // Default to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                $('aFollowUpDatePicker').value = tomorrow.toISOString().split('T')[0];
            } else {
                const apptDate = new Date($('aDate').value + 'T00:00:00');
                apptDate.setDate(apptDate.getDate() + parseInt(days));
                $('aFollowUpDate').value = fmtDate(apptDate.toISOString().split('T')[0]);
                $('aFollowUpDatePicker').value = apptDate.toISOString().split('T')[0];
                $('followUpDateDisplay').style.display = 'block';
                $('followUpNotesGroup').style.display = 'block';
                $('aFollowUpDatePicker').style.display = 'none';
                $('aFollowUpDate').style.display = 'block';
            }
        }
        
        function updateFollowUpDateFromPicker() {
            const pickedDate = $('aFollowUpDatePicker').value;
            if (pickedDate) {
                $('aFollowUpDate').value = fmtDate(pickedDate);
            }
        }

        // ========== CUSTOM SELECT DROPDOWN ==========
        const typeColors = {
            'bridal consultation': 'var(--accent)',
            'consultation': 'var(--accent)',
            'fitting': 'var(--blue)',
            'final fitting': '#9b59b6',
            'pickup': 'var(--sage)',
            'measurement': 'var(--honey)',
        };
        const typeIcons = {
            'bridal consultation': 'üí¨',
            'consultation': 'üí¨',
            'fitting': 'üëó',
            'final fitting': '‚ú®',
            'pickup': 'üéâ',
            'measurement': 'üìè',
        };
        
        function getTypeColor(type) {
            const lower = (type || '').toLowerCase();
            if (typeColors[lower]) return typeColors[lower];
            // Fuzzy match for renamed types
            if (lower.includes('consultation')) return 'var(--accent)';
            if (lower.includes('fitting')) return 'var(--blue)';
            if (lower.includes('pickup') || lower.includes('pick up')) return 'var(--sage)';
            if (lower.includes('measurement')) return 'var(--honey)';
            return 'var(--text-secondary)';
        }
        function getTypeIcon(type) {
            const lower = (type || '').toLowerCase();
            if (typeIcons[lower]) return typeIcons[lower];
            // Fuzzy match for renamed types
            if (lower.includes('consultation')) return 'üí¨';
            if (lower.includes('final')) return '‚ú®';
            if (lower.includes('fitting')) return 'üëó';
            if (lower.includes('pickup') || lower.includes('pick up')) return 'üéâ';
            if (lower.includes('measurement')) return 'üìè';
            if (lower.includes('alteration')) return '‚úÇÔ∏è';
            return 'üìã';
        }
        
        function renderCustomSelectOptions(selectId, customId) {
            const select = $(selectId);
            const optionsContainer = $(customId + 'Options');
            const label = $(customId + 'Label');
            if (!select || !optionsContainer) return;
            
            const options = Array.from(select.options);
            const currentVal = select.value;
            
            optionsContainer.innerHTML = options.map(opt => {
                const val = opt.value;
                const text = opt.textContent;
                const isSelected = val === currentVal;
                const color = getTypeColor(val);
                const icon = getTypeIcon(val);
                return `<div class="custom-select-option ${isSelected ? 'selected' : ''}" data-value="${val}" onclick="selectCustomOption('${selectId}', '${customId}', '${val}', this)">
                    <span style="font-size:16px">${icon}</span>
                    <span style="flex:1">${text}</span>
                    <span class="option-dot" style="background:${color}"></span>
                    <svg class="option-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                </div>`;
            }).join('');
            
            // Update trigger label
            const selectedOpt = options.find(o => o.value === currentVal);
            if (selectedOpt) {
                const icon = getTypeIcon(currentVal);
                const color = getTypeColor(currentVal);
                label.innerHTML = `<span style="font-size:15px">${icon}</span> ${selectedOpt.textContent} <span class="option-dot" style="background:${color};display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:2px"></span>`;
            }
        }
        
        function toggleCustomSelect(customId) {
            const trigger = document.querySelector(`#${customId} .custom-select-trigger`);
            const options = $(customId + 'Options');
            const isOpen = options.classList.contains('open');
            
            // Close all other open custom selects
            document.querySelectorAll('.custom-select-options.open').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.custom-select-trigger.open').forEach(el => el.classList.remove('open'));
            
            if (!isOpen) {
                options.classList.add('open');
                trigger.classList.add('open');
                // Close on outside click
                setTimeout(() => {
                    const closeHandler = (e) => {
                        if (!document.getElementById(customId)?.contains(e.target)) {
                            options.classList.remove('open');
                            trigger.classList.remove('open');
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 10);
            } else {
                options.classList.remove('open');
                trigger.classList.remove('open');
            }
        }
        
        function selectCustomOption(selectId, customId, value, optEl) {
            const select = $(selectId);
            select.value = value;
            
            // Update visual
            renderCustomSelectOptions(selectId, customId);
            
            // Close dropdown
            $(customId + 'Options').classList.remove('open');
            document.querySelector(`#${customId} .custom-select-trigger`).classList.remove('open');
            
            // Fire change event on the hidden select
            select.dispatchEvent(new Event('change'));
        }
        
        function syncCustomSelect(selectId, customId) {
            renderCustomSelectOptions(selectId, customId);
        }

        function populateApptModal(forClientId = null) {
            // Reset fields
            $('editApptId').value = '';
            $('apptForClientId').value = forClientId || '';
            $('aDate').value = today();
            $('aTime').value = '';
            $('aConsultant').value = '';
            $('apptModalTitle').textContent = 'New Appointment';
            
            // Populate service types dropdown
            const serviceTypes = getServiceTypes();
            $('aType').innerHTML = serviceTypes.map(t => {
                const val = t.toLowerCase();
                return `<option value="${val}">${t}</option>`;
            }).join('');
            $('aType').value = serviceTypes[0]?.toLowerCase() || 'bridal consultation';
            syncCustomSelect('aType', 'aTypeCustom');
            
            // Re-enable client dropdown (may have been disabled)
            $('aClient').disabled = false;
            
            // Reset new client fields
            ['aNewFirstName','aNewLastName','aNewEmail','aNewPhone','aNewWedding','aNewVenue'].forEach(id => $(id).value = '');
            $('newClientFields').style.display = 'none';
            
            // Reset structured visit log fields
            ['aLogFeedback','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => $(id).value = '');
            
            // Reset follow-up
            $('aFollowUp').value = '';
            $('followUpDateDisplay').style.display = 'none';
            $('followUpNotesGroup').style.display = 'none';
            $('aFollowUpDate').value = '';
            $('aFollowUpDatePicker').value = '';
            $('aFollowUpDatePicker').style.display = 'none';
            $('aFollowUpDate').style.display = 'block';
            $('aFollowUpNotes').value = '';
            
            // Reset consultation reason
            $('consultationReasonGroup').style.display = 'block'; // Show by default (consultation)
            document.querySelectorAll('input[name="aReason"]').forEach(r => r.checked = false);
            $('aReasonOther').style.display = 'none';
            $('aReasonOther').value = '';
            
            // Reset fitting fields (hidden by default)
            $('fittingFieldsGroup').style.display = 'none';
            $('aDressNeededBy').value = '';
            $('aWeddingDateDisplay').value = '';
            $('aDaysUntilWedding').textContent = '';
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            
            if (forClientId) {
                // Adding appointment for specific client - show fixed client name, NO new client option
                const c = getClient(forClientId);
                $('clientSelectGroup').style.display = 'none';
                $('clientFixedGroup').style.display = 'block';
                $('aClientName').value = c ? `${c.FirstName} ${c.LastName}` : '';
                $('aClient').value = forClientId;
            } else {
                // General appointment - show client dropdown with "new" option
                $('clientSelectGroup').style.display = 'block';
                $('clientFixedGroup').style.display = 'none';
                const activeClients = data.clients.filter(c => c.Status !== 'archived');
                $('aClient').innerHTML = '<option value="">Select existing...</option><option value="new">+ Create New Client</option>' + 
                    activeClients.map(c => `<option value="${c.ID}">${c.FirstName} ${c.LastName}</option>`).join('');
            }
        }
        
        function toggleNewClientFields() {
            const isNew = $('aClient').value === 'new';
            $('newClientFields').style.display = isNew ? 'block' : 'none';
        }
        
        function toggleConsultationReason() {
            const type = $('aType').value.toLowerCase();
            const isConsultation = type.includes('consultation');
            const isFitting = type.includes('fitting');
            
            // Show/hide consultation reason
            $('consultationReasonGroup').style.display = isConsultation ? 'block' : 'none';
            if (!isConsultation) {
                // Clear reason selection when not consultation
                document.querySelectorAll('input[name="aReason"]').forEach(r => r.checked = false);
                $('aReasonOther').style.display = 'none';
                $('aReasonOther').value = '';
            }
            
            // Show/hide fitting fields
            $('fittingFieldsGroup').style.display = isFitting ? 'block' : 'none';
            
            // If fitting and client is selected, populate wedding date
            if (isFitting) {
                const clientId = $('aClient').value || $('apptForClientId').value;
                if (clientId) {
                    const c = getClient(clientId);
                    if (c && c.WeddingDate) {
                        $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                        const weddingDate = parseDate(c.WeddingDate);
                        if (weddingDate) {
                            const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                            $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                            // Default dress needed by to 2 weeks before wedding
                            const neededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                            $('aDressNeededBy').value = neededBy.toISOString().split('T')[0];
                        }
                    }
                }
            }
        }
        
        function toggleOtherReason() {
            const otherChecked = document.querySelector('input[name="aReason"][value="other"]').checked;
            $('aReasonOther').style.display = otherChecked ? 'block' : 'none';
            if (otherChecked) $('aReasonOther').focus();
        }
        
        function getSelectedReason() {
            const selected = document.querySelector('input[name="aReason"]:checked');
            if (!selected) return '';
            if (selected.value === 'other') {
                return $('aReasonOther').value.trim() || 'Other';
            }
            const labels = { first: 'First Visit', revisit: 'Revisit Favourites', sayyes: 'Say Yes üíç', trymore: 'Try More Options' };
            return labels[selected.value] || selected.value;
        }
        
        function setSelectedReason(reason) {
            if (!reason) return;
            const labels = { 'First Visit': 'first', 'Revisit Favourites': 'revisit', 'Say Yes üíç': 'sayyes', 'Try More Options': 'trymore' };
            const value = labels[reason];
            if (value) {
                const radio = document.querySelector(`input[name="aReason"][value="${value}"]`);
                if (radio) radio.checked = true;
            } else {
                // It's an "other" reason
                const otherRadio = document.querySelector('input[name="aReason"][value="other"]');
                if (otherRadio) {
                    otherRadio.checked = true;
                    $('aReasonOther').style.display = 'block';
                    $('aReasonOther').value = reason;
                }
            }
        }

        // ========== VIEW APPOINTMENT ==========
        let currentViewApptId = null;
        
        function viewAppt(id) {
            const a = data.appointments.find(x => x.ID == id);
            if (!a) return;
            
            currentViewApptId = id;
            const c = getClient(a.ClientID);
            
            // Parse notes to extract structured fields
            const notes = a.Notes || '';
            const parseField = (emoji, label) => {
                const regex = new RegExp(emoji + '\\s*' + label + ':\\s*([^\\n]+)', 'i');
                const match = notes.match(regex);
                return match ? match[1].trim() : '';
            };
            
            const feedback = parseField('üí≠', 'Feedback') || parseField('üí≠', 'Style');
            const budget = parseField('üí∞', 'Budget');
            const nextSteps = parseField('‚û°Ô∏è', 'Next');
            const reason = parseField('üéØ', 'Reason');
            
            // Get remaining notes (without parsed fields)
            let otherNotes = notes
                .replace(/üí≠\s*(Feedback|Style):[^\n]+\n?/gi, '')
                .replace(/üí∞\s*Budget:[^\n]+\n?/gi, '')
                .replace(/‚û°Ô∏è\s*Next:[^\n]+\n?/gi, '')
                .replace(/üéØ\s*Reason:[^\n]+\n?/gi, '')
                .replace(/üëó\s*Tried:[^\n]+\n?/gi, '')
                .replace(/‚ú®\s*Style:[^\n]+\n?/gi, '')
                .trim();
            
            // Build details HTML
            let detailsHtml = `
                <div style="background:var(--cream);padding:12px;border-radius:6px;margin-bottom:12px">
                    <div style="font-size:16px;font-weight:600;margin-bottom:4px">${c ? c.FirstName + ' ' + c.LastName : 'Unknown Client'}</div>
                    <div style="font-size:12px;color:var(--rose)">${fmtDate(a.Date)} at ${fmtTime(a.Time)}</div>
                    <div style="font-size:11px;color:var(--taupe);margin-top:4px">${normalizeApptType(a.Type)} ¬∑ ${a.Consultant || 'No consultant'}</div>
                    ${reason ? `<div style="font-size:11px;color:var(--accent);margin-top:4px">üéØ ${reason}</div>` : ''}
                </div>
            `;
            
            // Display structured fields if present
            if (feedback || budget || nextSteps) {
                detailsHtml += `<div style="margin-bottom:12px">`;
                
                if (feedback) {
                    detailsHtml += `
                        <div style="margin-bottom:10px">
                            <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:3px">üí≠ STYLE FEEDBACK</div>
                            <div style="font-size:13px;line-height:1.5">${feedback}</div>
                        </div>
                    `;
                }
                
                if (budget) {
                    detailsHtml += `
                        <div style="margin-bottom:10px">
                            <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:3px">üí∞ BUDGET</div>
                            <div style="font-size:13px">${budget}</div>
                        </div>
                    `;
                }
                
                if (nextSteps) {
                    detailsHtml += `
                        <div style="margin-bottom:10px">
                            <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:3px">‚û°Ô∏è NEXT STEPS</div>
                            <div style="font-size:13px">${nextSteps}</div>
                        </div>
                    `;
                }
                
                detailsHtml += `</div>`;
            }
            
            if (otherNotes) {
                detailsHtml += `
                    <div style="margin-bottom:12px">
                        <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:3px">üìù NOTES</div>
                        <div style="font-size:12px;line-height:1.6;white-space:pre-wrap">${otherNotes}</div>
                    </div>
                `;
            }
            
            if (a.FollowUpDate) {
                const isOverdue = getDateStr(a.FollowUpDate) < today();
                const isDone = a.FollowUpDone === true || a.FollowUpDone === 'TRUE';
                detailsHtml += `
                    <div style="background:${isDone ? 'var(--blush)' : isOverdue ? '#fff5f5' : 'var(--blush)'};padding:8px 12px;border-radius:5px;margin-bottom:12px">
                        <div style="font-size:11px;color:var(--taupe)">üìÖ Follow-up: ${fmtDate(a.FollowUpDate)} ${isDone ? '‚úì Done' : isOverdue ? '‚ö†Ô∏è Overdue' : ''}</div>
                        ${a.FollowUpNotes ? `<div style="font-size:10px;color:var(--rose);margin-top:4px">${a.FollowUpNotes}</div>` : ''}
                    </div>
                `;
            }
            
            $('viewApptDetails').innerHTML = detailsHtml;
            
            // Render photos
            renderApptPhotos(a);
            
            openModal('viewAppt');
        }
        
        function renderApptPhotos(a) {
            const photos = a.Photos || [];
            if (photos.length > 0) {
                $('apptPhotoGrid').innerHTML = photos.map((p, i) => `
                    <div class="photo-thumb">
                        <img src="${p.url || p}" onclick="window.open('${p.url || p}', '_blank')" alt="Photo ${i+1}">
                        <button class="photo-remove" onclick="removeApptPhoto(${i})" title="Remove">√ó</button>
                    </div>
                `).join('');
            } else {
                $('apptPhotoGrid').innerHTML = '<div style="text-align:center;padding:20px;color:var(--rose);font-size:11px">No photos yet</div>';
            }
        }
        
        function editApptFromView() {
            closeModal('viewAppt');
            editAppt(currentViewApptId);
        }
        
        async function handleApptPhotoSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            const a = data.appointments.find(x => x.ID == currentViewApptId);
            if (!a) return;
            
            $('apptPhotoUploadStatus').style.display = 'block';
            $('apptPhotoUploadText').textContent = `Uploading ${files.length} photo(s)...`;
            
            const photos = a.Photos || [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                $('apptPhotoUploadText').textContent = `Uploading photo ${i+1} of ${files.length}...`;
                
                try {
                    const base64 = await fileToBase64(file);
                    const result = await api('POST', {
                        action: 'uploadPhoto',
                        fileName: `appt_${currentViewApptId}_${Date.now()}_${file.name}`,
                        mimeType: file.type,
                        data: base64.split(',')[1]
                    });
                    
                    if (result.url) {
                        photos.push({ url: result.url, name: file.name, uploadedAt: new Date().toISOString() });
                    }
                } catch (e) {
                    console.error('Photo upload failed:', e);
                }
            }
            
            // Update appointment with new photos
            a.Photos = photos;
            await updateRecord('Appointments', currentViewApptId, { Photos: JSON.stringify(photos) });
            
            $('apptPhotoUploadStatus').style.display = 'none';
            $('apptPhotoInput').value = '';
            
            renderApptPhotos(a);
            renderClientAppts();
            toast(`${files.length} photo(s) uploaded`, 'success');
        }
        
        async function removeApptPhoto(index) {
            if (!confirm('Remove this photo?')) return;
            
            const a = data.appointments.find(x => x.ID == currentViewApptId);
            if (!a || !a.Photos) return;
            
            a.Photos.splice(index, 1);
            await updateRecord('Appointments', currentViewApptId, { Photos: JSON.stringify(a.Photos) });
            
            renderApptPhotos(a);
            renderClientAppts();
            toast('Photo removed', 'success');
        }
        
        // ========== EDIT APPOINTMENT ==========
        function editAppt(id) {
            const a = data.appointments.find(x => x.ID == id);
            if (!a) return;
            
            // Set edit mode
            $('apptModalTitle').textContent = 'Edit Appointment';
            $('editApptId').value = a.ID;
            $('apptForClientId').value = '';
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            ['aNewFirstName','aNewLastName','aNewEmail','aNewPhone','aNewWedding','aNewVenue'].forEach(id => $(id).value = '');
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(c => `<option value="${c.Name}" ${c.Name === a.Consultant ? 'selected' : ''}>${c.Name}</option>`).join('');
            
            // Check if we're on a client profile - hide client selection entirely
            if (currentClient && a.ClientID == currentClient.ID) {
                $('clientSelectGroup').style.display = 'none';
                $('clientFixedGroup').style.display = 'block';
                $('aClientName').value = `${currentClient.FirstName} ${currentClient.LastName}`;
                $('apptForClientId').value = a.ClientID; // Set this so saveAppt knows the client
            } else {
                // Editing from Today page or elsewhere - show client dropdown
                $('clientSelectGroup').style.display = 'block';
                $('clientFixedGroup').style.display = 'none';
                const activeClients = data.clients.filter(c => c.Status !== 'archived');
                $('aClient').innerHTML = '<option value="">Select...</option>' + 
                    activeClients.map(c => `<option value="${c.ID}" ${c.ID == a.ClientID ? 'selected' : ''}>${c.FirstName} ${c.LastName}</option>`).join('');
            }
            
            // Handle date format
            if (a.Date) {
                if (typeof a.Date === 'number') {
                    const d = new Date((a.Date - 25569) * 86400 * 1000);
                    $('aDate').value = d.toISOString().split('T')[0];
                } else {
                    $('aDate').value = String(a.Date).split('T')[0];
                }
            } else {
                $('aDate').value = '';
            }
            $('aTime').value = a.Time || '';
            
            // Populate service types dropdown
            const serviceTypes = getServiceTypes();
            const normalizedType = normalizeApptType(a.Type);
            const currentType = normalizedType.toLowerCase();
            $('aType').innerHTML = serviceTypes.map(t => {
                const val = t.toLowerCase();
                return `<option value="${val}" ${val === currentType ? 'selected' : ''}>${t}</option>`;
            }).join('');
            // If current type not in list, add it
            if (!serviceTypes.some(t => t.toLowerCase() === currentType)) {
                $('aType').innerHTML += `<option value="${currentType}" selected>${normalizedType}</option>`;
            }
            syncCustomSelect('aType', 'aTypeCustom');
            
            // Show/hide consultation reason based on type
            toggleConsultationReason();
            
            // Clear and set reason
            document.querySelectorAll('input[name="aReason"]').forEach(r => r.checked = false);
            $('aReasonOther').style.display = 'none';
            $('aReasonOther').value = '';
            
            // Parse notes into structured fields
            const notes = a.Notes || '';
            const parseField = (emoji, prefix) => {
                const regex = new RegExp(`${emoji}\\s*${prefix}:\\s*(.+?)(?=\\n\\n|$)`, 's');
                const match = notes.match(regex);
                return match ? match[1].trim() : '';
            };
            
            // Parse reason from notes
            const reason = parseField('üéØ', 'Reason');
            if (reason) setSelectedReason(reason);
            
            $('aLogFeedback').value = parseField('üí≠', 'Feedback') || parseField('üí≠', 'Style');
            $('aLogBudget').value = parseField('üí∞', 'Budget');
            $('aLogNextSteps').value = parseField('‚û°Ô∏è', 'Next') || parseField('üìã', 'Next');
            $('aLogOther').value = parseField('üìù', 'Notes');
            
            // If notes don't match structured format, put everything in "other"
            if (!$('aLogFeedback').value && !$('aLogBudget').value && 
                !$('aLogNextSteps').value && !$('aLogOther').value && !reason && notes) {
                $('aLogOther').value = notes;
            }
            
            // Load follow-up setting
            if (a.FollowUpDate) {
                // Calculate days from appointment date to follow-up date
                const apptDate = new Date(getDateStr(a.Date) + 'T00:00:00');
                const followDate = new Date(getDateStr(a.FollowUpDate) + 'T00:00:00');
                const daysDiff = Math.round((followDate - apptDate) / (1000 * 60 * 60 * 24));
                
                // Try to match to dropdown option
                const options = [0, 1, 2, 3, 5, 7, 14];
                if (options.includes(daysDiff)) {
                    $('aFollowUp').value = String(daysDiff);
                    $('aFollowUpDatePicker').style.display = 'none';
                    $('aFollowUpDate').style.display = 'block';
                } else {
                    // Custom date
                    $('aFollowUp').value = 'custom';
                    $('aFollowUpDatePicker').value = getDateStr(a.FollowUpDate);
                    $('aFollowUpDatePicker').style.display = 'block';
                    $('aFollowUpDate').style.display = 'none';
                }
                
                $('aFollowUpDate').value = fmtDate(a.FollowUpDate);
                $('followUpDateDisplay').style.display = 'block';
                $('followUpNotesGroup').style.display = 'block';
                $('aFollowUpNotes').value = a.FollowUpNotes || '';
            } else {
                $('aFollowUp').value = '';
                $('aFollowUpDate').value = '';
                $('aFollowUpDatePicker').value = '';
                $('aFollowUpDatePicker').style.display = 'none';
                $('aFollowUpDate').style.display = 'block';
                $('followUpDateDisplay').style.display = 'none';
                $('followUpNotesGroup').style.display = 'none';
                $('aFollowUpNotes').value = '';
            }
            
            openModal('newAppt');
        }

        async function saveAppt() {
            const id = $('editApptId').value;
            const forClientId = $('apptForClientId').value;
            let clientId = forClientId || $('aClient').value;
            
            // If creating new client
            if (clientId === 'new') {
                const firstName = $('aNewFirstName').value.trim();
                const lastName = $('aNewLastName').value.trim();
                if (!firstName || !lastName) { 
                    toast('Enter client name'); 
                    return; 
                }
                
                // Create new client first - wait for server response to get real ID
                const newClient = {
                    FirstName: firstName,
                    LastName: lastName,
                    Email: $('aNewEmail').value,
                    Phone: $('aNewPhone').value,
                    WeddingDate: $('aNewWedding').value,
                    Venue: $('aNewVenue').value,
                    Status: 'new',
                    LastVisit: today()
                };
                
                try {
                    // Wait for server to return the real client ID
                    const result = await api('POST', { action: 'add', sheet: 'Clients', record: newClient });
                    clientId = result.id;
                    
                    // Add to local data with the REAL ID from server
                    newClient.ID = clientId;
                    data.clients.push(newClient);
                    saveCachedData();
                } catch (e) {
                    toast('Failed to create client', 'error');
                    return;
                }
            }
            
            if (!clientId || !$('aDate').value) { 
                toast('Select client and date'); 
                return; 
            }
            
            // Combine structured fields into notes
            const noteParts = [];
            
            // Add reason for consultation appointments
            if ($('aType').value.toLowerCase().includes('consultation')) {
                const reason = getSelectedReason();
                if (reason) noteParts.push(`üéØ Reason: ${reason}`);
            }
            
            const feedback = $('aLogFeedback').value.trim();
            const budget = $('aLogBudget').value.trim();
            const nextSteps = $('aLogNextSteps').value.trim();
            const other = $('aLogOther').value.trim();
            
            if (feedback) noteParts.push(`üí≠ Feedback: ${feedback}`);
            if (budget) noteParts.push(`üí∞ Budget: ${budget}`);
            if (nextSteps) noteParts.push(`‚û°Ô∏è Next: ${nextSteps}`);
            if (other) noteParts.push(other);
            
            // Calculate follow-up date
            let followUpDate = '';
            const followUpDays = $('aFollowUp').value;
            if (followUpDays === 'custom') {
                // Use custom date picker value
                followUpDate = $('aFollowUpDatePicker').value || '';
            } else if (followUpDays !== '') {
                const apptDate = new Date($('aDate').value + 'T00:00:00');
                apptDate.setDate(apptDate.getDate() + parseInt(followUpDays));
                followUpDate = apptDate.toISOString().split('T')[0];
            }
            
            // Get client name for easier sheet viewing
            const client = getClient(clientId);
            const clientName = client ? `${client.FirstName} ${client.LastName}` : '';
            
            const record = { 
                ClientID: +clientId,
                ClientName: clientName,
                Date: $('aDate').value, 
                Time: $('aTime').value, 
                Type: normalizeApptType($('aType').value), 
                Consultant: $('aConsultant').value, 
                Notes: noteParts.join('\n\n'),
                FollowUpDate: followUpDate,
                FollowUpNotes: $('aFollowUpNotes').value.trim(),
                FollowUpDone: false
            };
            
            // Check if this is a reschedule
            const rescheduleFrom = $('editApptId').dataset?.rescheduleFrom;
            if (rescheduleFrom && id) {
                record.RescheduledFrom = rescheduleFrom;
                delete $('editApptId').dataset.rescheduleFrom;
            }
            
            // Close immediately
            closeModal('newAppt');
            
            // Save dress needed by date for fitting appointments
            const apptType = record.Type.toLowerCase();
            if (apptType.includes('fitting') && $('aDressNeededBy') && $('aDressNeededBy').value) {
                localStorage.setItem(`alts_neededby_${clientId}`, $('aDressNeededBy').value);
            }
            
            if (id) {
                // Store previous values for undo
                const existingAppt = data.appointments.find(a => a.ID == id);
                if (existingAppt) {
                    const previousValues = {
                        ClientID: existingAppt.ClientID,
                        Date: existingAppt.Date,
                        Time: existingAppt.Time,
                        Type: existingAppt.Type,
                        Consultant: existingAppt.Consultant,
                        Notes: existingAppt.Notes,
                        FollowUpDate: existingAppt.FollowUpDate,
                        FollowUpNotes: existingAppt.FollowUpNotes,
                        FollowUpDone: existingAppt.FollowUpDone
                    };
                    addUndo({ type: 'edit_appointment', id: id, previous: previousValues });
                }
                updateRecord('Appointments', id, record);
                toast(rescheduleFrom ? 'Rescheduled!' : 'Saved!', 'success', true);
            } else { 
                saveRecord('Appointments', record);
                toast('Saved!', 'success');
                
                // Auto-create alteration record if this is a fitting appointment
                const apptType = record.Type.toLowerCase();
                if (apptType.includes('fitting')) {
                    await autoCreateAlteration(clientId, record);
                }
            }
            
            if (currentClient) {
                renderClientAppts();
                renderVisitHistory();
            }
            renderWeek();
            renderAllAppointments();
            renderDash();
        }
        
        async function autoCreateAlteration(clientId, apptRecord) {
            // Check if alteration already exists for this client
            const existingAlt = data.alterations.find(a => String(a.ClientID) === String(clientId) && a.Status !== 'complete');
            if (existingAlt) {
                console.log('Alteration already exists for client', clientId);
                return; // Don't create duplicate
            }
            
            const client = getClient(clientId);
            if (!client) return;
            
            const clientName = `${client.FirstName} ${client.LastName}`;
            
            // Get order info if exists
            const order = data.orders.find(o => String(o.ClientID) === String(clientId) && o.Status !== 'picked up');
            
            const altRecord = {
                ClientID: clientId,
                ClientName: clientName,
                OrderID: order ? order.ID : '',
                Items: order ? (order.Dress || 'Dress') : 'Dress',
                Notes: `Auto-created from ${apptRecord.Type} appointment on ${apptRecord.Date}`,
                Status: 'in progress',
                StartDate: today(),
                DueDate: client.WeddingDate || '',
                Seamstress: ''
            };
            
            try {
                const result = await api('POST', { action: 'add', sheet: 'Alterations', record: altRecord });
                if (result && result.id) {
                    altRecord.ID = result.id;
                } else {
                    altRecord.ID = 'alt_' + Date.now();
                }
                data.alterations.push(altRecord);
                saveCachedData();
                
                // Also update order status to "in alterations" if exists
                if (order && order.Status !== 'in alterations' && order.Status !== 'picked up' && order.Status !== 'picked up') {
                    await updateRecord('Orders', order.ID, { Status: 'in alterations' });
                    order.Status = 'in alterations';
                    saveCachedData();
                }
                
                console.log('Auto-created alteration for', clientName);
                return true;
            } catch (e) {
                console.error('Failed to auto-create alteration:', e);
                return false;
            }
        }
        
        async function syncFittingsToAlterations() {
            // Find all scheduled fitting appointments (today or future)
            const todayStr = today();
            const fittingAppts = data.appointments.filter(a => {
                const apptType = (a.Type || '').toLowerCase();
                const isFitting = apptType.includes('fitting');
                const isFuture = a.Date >= todayStr;
                return isFitting && isFuture;
            });
            
            console.log('Found fitting appointments:', fittingAppts.length);
            
            if (fittingAppts.length === 0) {
                toast('No scheduled fittings found', 'info');
                return;
            }
            
            // Get unique client IDs
            const clientIds = [...new Set(fittingAppts.map(a => String(a.ClientID)))];
            console.log('Unique clients with fittings:', clientIds);
            
            let created = 0;
            let skipped = 0;
            
            for (const clientId of clientIds) {
                // Check if alteration already exists
                const existingAlt = data.alterations.find(a => String(a.ClientID) === clientId && a.Status !== 'complete');
                if (existingAlt) {
                    console.log('Skipping client', clientId, '- alteration exists');
                    skipped++;
                    continue;
                }
                
                // Find the fitting appointment
                const appt = fittingAppts.find(a => String(a.ClientID) === clientId);
                const client = getClient(clientId);
                
                if (!client) {
                    console.log('Client not found:', clientId);
                    continue;
                }
                
                const clientName = `${client.FirstName} ${client.LastName}`;
                console.log('Creating alteration for:', clientName);
                
                // Get order info if exists
                const order = data.orders.find(o => String(o.ClientID) === clientId && o.Status !== 'picked up');
                
                const altRecord = {
                    ClientID: clientId,
                    ClientName: clientName,
                    OrderID: order ? order.ID : '',
                    Items: order ? (order.Dress || 'Dress') : 'Dress',
                    Notes: '',
                    Status: 'in progress',
                    StartDate: today(),
                    DueDate: client.WeddingDate || '',
                    Seamstress: ''
                };
                
                try {
                    const result = await api('POST', { action: 'add', sheet: 'Alterations', record: altRecord });
                    if (result && result.id) {
                        altRecord.ID = result.id;
                    } else {
                        altRecord.ID = 'alt_' + Date.now() + '_' + created;
                    }
                    data.alterations.push(altRecord);
                    
                    // Also update order status to "in alterations" if exists
                    if (order && order.Status !== 'in alterations' && order.Status !== 'picked up' && order.Status !== 'picked up') {
                        await updateRecord('Orders', order.ID, { Status: 'in alterations' });
                        order.Status = 'in alterations';
                    }
                    
                    created++;
                    console.log('Created alteration for:', clientName);
                } catch (e) {
                    console.error('Failed to create alteration for', clientName, e);
                }
            }
            
            saveCachedData();
            renderAlts();
            
            if (created > 0 || skipped > 0) {
                toast(`Created ${created} alterations (${skipped} already existed)`, 'success');
            } else {
                toast('No new alterations to create', 'info');
            }
        }

        // ========== ORDERS ==========
        const ORDER_STATUSES = [
            'pending submission',
            'in production',
            'ready to ship',
            'shipped',
            'arrived - pending QA',
            'QA complete',
            'in alterations',
            'picked up'
        ];
        
        let orderSortBy = 'orderDate';
        let needsAttentionFilter = false;
        
        function getMonthKey(dateVal) {
            if (!dateVal) return null;
            let d;
            if (typeof dateVal === 'number') {
                d = new Date((dateVal - 25569) * 86400 * 1000);
            } else {
                d = new Date(String(dateVal).split('T')[0] + 'T00:00:00');
            }
            return d.getFullYear() * 12 + d.getMonth();
        }
        
        function renderOrders() {
            const searchTerm = ($('orderSearch')?.value || '').toLowerCase();
            const statusFilter = currentStatusFilter || '';
            const sortBy = orderSortBy;
            
            // Calculate 2 months from now for "Needs Attention" alert
            const twoMonthsFromNow = new Date();
            twoMonthsFromNow.setMonth(twoMonthsFromNow.getMonth() + 2);
            const twoMonthsStr = twoMonthsFromNow.toISOString().split('T')[0];
            const todayStr = new Date().toISOString().split('T')[0];
            const preShipStatuses = ['pending submission', 'ordered', 'in production', 'ready to ship', 'shipped'];
            
            // Count stats (from all orders, not filtered)
            const allOrders = data.orders;
            const inProduction = allOrders.filter(o => o.Status === 'pending submission' || o.Status === 'ordered' || o.Status === 'in production' || o.Status === 'ready to ship' || o.Status === 'shipped').length;
            const arrived = allOrders.filter(o => o.Status === 'arrived - pending QA' || o.Status === 'QA complete').length;
            const needsQA = allOrders.filter(o => o.Status === 'arrived - pending QA').length;
            const inAlterations = allOrders.filter(o => o.Status === 'in alterations').length;
            const pickedUp = allOrders.filter(o => o.Status === 'picked up').length;
            
            // Count needs attention: ETA within 2 months but not yet shipped
            const needsAttentionCount = allOrders.filter(o => {
                if (!o.ArrivalDate || !preShipStatuses.includes(o.Status)) return false;
                const arrDate = getDateStr(o.ArrivalDate);
                return arrDate && arrDate <= twoMonthsStr;
            }).length;
            
            $('ordersNeedsAttention').textContent = needsAttentionCount;
            $('ordersInProduction').textContent = inProduction;
            $('ordersArrived').textContent = arrived;
            $('ordersNeedsQA').textContent = needsQA > 0 ? `(${needsQA} need QA)` : '';
            $('ordersInAlterations').textContent = inAlterations;
            $('ordersPickedUp').textContent = pickedUp;
            
            // FIRST: Filter individual orders based on filter criteria
            let filteredOrders = allOrders.filter(o => {
                // Apply status filter
                if (statusFilter) {
                    if (statusFilter === 'in production') {
                        if (!(o.Status === 'pending submission' || o.Status === 'ordered' || o.Status === 'in production' || o.Status === 'ready to ship' || o.Status === 'shipped')) {
                            return false;
                        }
                    } else if (statusFilter === 'arrived') {
                        // "arrived" means arrived - pending QA or QA complete
                        if (!(o.Status === 'arrived - pending QA' || o.Status === 'QA complete')) {
                            return false;
                        }
                    } else if (o.Status !== statusFilter) {
                        return false;
                    }
                }
                
                // Apply Needs Attention filter
                if (needsAttentionFilter) {
                    if (!o.ArrivalDate || !preShipStatuses.includes(o.Status)) return false;
                    const arrDate = getDateStr(o.ArrivalDate);
                    if (!(arrDate && arrDate <= twoMonthsStr)) return false;
                }
                
                // If no filter, exclude picked up by default
                if (!statusFilter && !needsAttentionFilter && !searchTerm) {
                    if (o.Status === 'picked up') return false;
                }
                
                // Apply search filter
                if (searchTerm) {
                    const searchStr = `${o.ClientName || ''} ${o.Dress || ''} ${o.Designer || ''} ${o.PO || ''}`.toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            // THEN: Group filtered orders by client name
            const clientGroups = {};
            filteredOrders.forEach(o => {
                const rawName = (o.ClientName || 'Unknown').trim().replace(/\s+/g, ' ');
                const key = rawName.toLowerCase();
                if (!clientGroups[key]) {
                    clientGroups[key] = { displayName: rawName, orders: [] };
                }
                clientGroups[key].orders.push(o);
            });
            
            // Convert to array
            let groupedOrders = Object.values(clientGroups).map(g => ({
                clientName: g.displayName,
                orders: g.orders,
                primaryOrder: g.orders[0],
                hasActiveOrders: g.orders.some(o => o.Status !== 'picked up'),
                filteredOrders: g.orders // All orders in group are already filtered
            }));
            
            // Count total items shown
            const totalItems = groupedOrders.reduce((sum, g) => sum + g.filteredOrders.length, 0);
            
            // Debug: log clients with multiple orders
            const multipleOrders = groupedOrders.filter(g => g.filteredOrders.length > 1);
            if (multipleOrders.length > 0) {
                console.log('Clients with multiple orders:', multipleOrders.map(g => `${g.clientName} (${g.filteredOrders.length})`));
            }
            
            // Sort groups
            const statusOrderMap = { 'pending submission': 0, 'arrived - pending QA': 1, 'QA complete': 2, 'in alterations': 3, 'shipped': 4, 'in production': 5, 'ordered': 5, 'picked up': 6 };
            const dir = orderSortDirection[sortBy] === 'desc' ? -1 : 1;
            
            if (sortBy === 'status') {
                groupedOrders.forEach(g => {
                    g.minStatus = Math.min(...g.filteredOrders.map(o => statusOrderMap[o.Status] ?? 6));
                });
                groupedOrders.sort((a, b) => dir * (a.minStatus - b.minStatus) || (a.primaryOrder.WeddingDate || '').localeCompare(b.primaryOrder.WeddingDate || ''));
            } else if (sortBy === 'weddingDate') {
                groupedOrders.sort((a, b) => dir * (a.primaryOrder.WeddingDate || '9999').localeCompare(b.primaryOrder.WeddingDate || '9999'));
            } else if (sortBy === 'arrivalDate') {
                groupedOrders.sort((a, b) => dir * (a.primaryOrder.ArrivalDate || '9999').localeCompare(b.primaryOrder.ArrivalDate || '9999'));
            } else if (sortBy === 'orderDate') {
                // Order date defaults to newest first (descending)
                const orderDir = orderSortDirection[sortBy] === 'asc' ? 1 : -1;
                groupedOrders.sort((a, b) => orderDir * (b.primaryOrder.OrderDate || '').localeCompare(a.primaryOrder.OrderDate || ''));
            } else if (sortBy === 'clientName') {
                groupedOrders.sort((a, b) => dir * a.clientName.localeCompare(b.clientName));
            }
            
            $('ordersCount').textContent = `(${groupedOrders.length} clients, ${totalItems} items)`;
            
            // Render table
            if (groupedOrders.length === 0) {
                $('ordersTableBody').innerHTML = '<tr><td colspan="10" class="empty">No orders found</td></tr>';
                return;
            }
            
            let html = '';
            
            // ETA alert helpers
            function isEtaAlert(o) {
                if (!o.ArrivalDate) return false;
                if (!preShipStatuses.includes(o.Status)) return false;
                const arrDate = getDateStr(o.ArrivalDate);
                return arrDate && arrDate <= twoMonthsStr;
            }
            
            function etaCell(o) {
                const alert = isEtaAlert(o);
                const dateStr = fmtDate(o.ArrivalDate) || '‚Äî';
                if (alert) {
                    const arrDate = parseDate(o.ArrivalDate);
                    const daysLeft = arrDate ? Math.ceil((arrDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
                    return `<span style="color:#e74c3c;font-weight:600">${dateStr}</span><div style="font-size:10px;color:#e74c3c">‚ö† ${daysLeft}d ‚Äî not shipped</div>`;
                }
                return dateStr;
            }
            
            groupedOrders.forEach(group => {
                const ordersToShow = group.filteredOrders;
                const hasMultiple = ordersToShow.length > 1;
                const gid = 'og_' + group.clientName.replace(/[^a-zA-Z0-9]/g, '_');
                const pickedUpCount = ordersToShow.filter(o => o.Status === 'picked up').length;
                
                if (hasMultiple) {
                    // Client header row with expand/collapse
                    html += `<tr class="client-group-header" style="background:var(--cream);cursor:pointer" onclick="toggleOrderGroup('${gid}')">
                        <td><input type="checkbox" class="order-group-checkbox" data-group="${gid}" onclick="event.stopPropagation();toggleGroupCheckboxes('${gid}', this.checked)"></td>
                        <td colspan="9">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span class="order-group-arrow" id="arrow_${gid}" style="transition:transform 0.2s">‚ñ∂</span>
                                <span style="font-weight:600">${group.clientName}</span>
                                <span style="font-size:11px;color:var(--text-secondary)">${ordersToShow.length} items${pickedUpCount ? ` <span style="color:#95a5a6">(${pickedUpCount} picked up)</span>` : ''}</span>
                                <span style="font-size:11px;color:var(--text-secondary);margin-left:auto">Wedding: ${fmtDate(group.primaryOrder.WeddingDate) || '‚Äî'}</span>
                            </div>
                        </td>
                    </tr>`;
                    
                    // Individual order rows (hidden by default)
                    ordersToShow.forEach(o => {
                        const statusColor = getStatusColor(o.Status);
                        const isPickedUp = o.Status === 'picked up';
                        const needsQA = o.Status === 'arrived - pending QA';
                        const etaWarning = isEtaAlert(o);
                        html += `<tr class="order-group-item ${gid}" style="display:none;background:${isPickedUp ? '#f5f5f5' : etaWarning ? '#fff5f5' : '#fafafa'};${isPickedUp ? 'opacity:0.7;' : ''}">
                            <td style="padding-left:30px"><input type="checkbox" class="order-checkbox" data-order-id="${o.ID}" data-group="${gid}" onchange="updateOrderSelection()"></td>
                            <td style="padding-left:30px;font-size:11px;color:var(--text-secondary)">${o.Phone || o.Email || ''}</td>
                            <td>${o.PO || '‚Äî'}</td>
                            <td>${o.Dress || o.Accessories || '‚Äî'}${o.Size ? `<div style="font-size:11px;color:var(--text-secondary)">Size ${o.Size}</div>` : ''}${isPickedUp ? '<div style="font-size:10px;color:#95a5a6">üìÅ picked up</div>' : ''}</td>
                            <td>${o.Designer || '‚Äî'}</td>
                            <td>${fmtDate(o.OrderDate) || '‚Äî'}</td>
                            <td>${fmtDate(o.WeddingDate) || '‚Äî'}</td>
                            <td>${etaCell(o)}</td>
                            <td>
                                <select class="form-input" style="width:auto;font-size:11px;padding:4px 8px;border-color:${statusColor};color:${statusColor}" onchange="updateOrderStatus(${o.ID}, this.value)">
                                    ${ORDER_STATUSES.map(s => `<option value="${s}" ${s === o.Status ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </td>
                            <td>
                                ${needsQA ? `<button class="action-btn" onclick="openQAChecklist(${o.ID})" style="background:#e67e22;color:white;border-color:#e67e22">QA</button>` : ''}
                                <button class="action-btn" onclick="viewOrderDetails(${o.ID})">Edit</button>
                                <button class="action-btn" onclick="deleteOrder(${o.ID})" style="color:#e74c3c">‚úï</button>
                            </td>
                        </tr>`;
                    });
                } else if (ordersToShow.length === 1) {
                    // Single order - show as regular row
                    const o = ordersToShow[0];
                    const statusColor = getStatusColor(o.Status);
                    const etaWarning = isEtaAlert(o);
                    html += `<tr style="${etaWarning ? 'background:#fff5f5' : ''}">
                        <td><input type="checkbox" class="order-checkbox" data-order-id="${o.ID}" onchange="updateOrderSelection()"></td>
                        <td>
                            <div style="font-weight:500">${o.ClientName || '‚Äî'}</div>
                            <div style="font-size:11px;color:var(--text-secondary)">${o.Phone || o.Email || ''}</div>
                        </td>
                        <td>${o.PO || '‚Äî'}</td>
                        <td>${o.Dress || '‚Äî'}${o.Size ? `<div style="font-size:11px;color:var(--text-secondary)">Size ${o.Size}</div>` : ''}</td>
                        <td>${o.Designer || '‚Äî'}</td>
                        <td>${fmtDate(o.OrderDate) || '‚Äî'}</td>
                        <td>${fmtDate(o.WeddingDate) || '‚Äî'}</td>
                        <td>${etaCell(o)}</td>
                        <td>
                            <select class="form-input" style="width:auto;font-size:11px;padding:4px 8px;border-color:${statusColor};color:${statusColor}" onchange="updateOrderStatus(${o.ID}, this.value)">
                                ${ORDER_STATUSES.map(s => `<option value="${s}" ${s === o.Status ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            ${(o.Status === 'arrived' || o.Status === 'arrived - pending QA') ? `<button class="action-btn" onclick="openQAChecklist(${o.ID})" style="background:#e67e22;color:white;border-color:#e67e22">QA</button>` : ''}
                            <button class="action-btn" onclick="viewOrderDetails(${o.ID})">Edit</button>
                            <button class="action-btn" onclick="deleteOrder(${o.ID})" style="color:#e74c3c">‚úï</button>
                        </td>
                    </tr>`;
                }
            });
            
            $('ordersTableBody').innerHTML = html;
        }
        
        function toggleOrderGroup(groupId) {
            const items = document.querySelectorAll(`.order-group-item.${groupId}`);
            const arrow = $('arrow_' + groupId);
            const isHidden = items[0]?.style.display === 'none';
            
            items.forEach(item => {
                item.style.display = isHidden ? 'table-row' : 'none';
            });
            
            if (arrow) {
                arrow.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
            }
        }
        
        function toggleGroupCheckboxes(groupId, checked) {
            document.querySelectorAll(`.order-checkbox[data-group="${groupId}"]`).forEach(cb => {
                cb.checked = checked;
            });
            updateOrderSelection();
        }
        
        let currentStatusFilter = '';
        
        function filterOrders(status) {
            // Toggle off if clicking the same filter
            if (currentStatusFilter === status) {
                currentStatusFilter = '';
                $('orderStatusFilter').value = '';
                needsAttentionFilter = false;
                $('orderSearch').value = '';
                renderOrders();
                highlightActiveStatCard('');
                return;
            }
            
            // Clear other filters when clicking a stat card
            currentStatusFilter = status;
            needsAttentionFilter = false;
            $('orderSearch').value = '';
            $('orderStatusFilter').value = status;
            renderOrders();
            highlightActiveStatCard(status);
        }
        
        function highlightActiveStatCard(activeStatus) {
            // Reset all cards
            document.querySelectorAll('.order-stat-card').forEach(card => {
                card.style.boxShadow = '';
                card.style.transform = '';
            });
            
            // Highlight active card
            const cardMap = {
                'in production': 'cardInProduction',
                'ordered': 'cardInProduction',
                'arrived': 'cardArrived',
                'arrived - pending QA': 'cardArrived',
                'QA complete': 'cardArrived',
                'in alterations': 'cardInAlterations',
                'picked up': 'cardPickedUp',
                'needsAttention': 'cardNeedsAttention'
            };
            
            const cardId = cardMap[activeStatus];
            if (cardId) {
                const card = $(cardId);
                if (card) {
                    card.style.boxShadow = '0 0 0 2px var(--accent)';
                    card.style.transform = 'scale(1.02)';
                }
            }
        }
        
        function clearOrderFilters() {
            $('orderSearch').value = '';
            $('orderStatusFilter').value = '';
            orderSortBy = 'orderDate';
            needsAttentionFilter = false;
            currentStatusFilter = '';
            orderSortDirection = {};
            renderOrders();
            updateSortArrows('orderDate');
            highlightActiveStatCard(''); // Clear all highlights
        }
        
        function toggleNeedsAttention() {
            // Toggle off if already on
            if (needsAttentionFilter) {
                needsAttentionFilter = false;
                currentStatusFilter = '';
                renderOrders();
                highlightActiveStatCard('');
                return;
            }
            
            // Enable needs attention, clear other filters
            needsAttentionFilter = true;
            currentStatusFilter = '';
            $('orderStatusFilter').value = '';
            $('orderSearch').value = '';
            // Sort by arrival date (soonest first)
            orderSortBy = 'arrivalDate';
            orderSortDirection['arrivalDate'] = 'asc';
            renderOrders();
            updateSortArrows(orderSortBy);
            highlightActiveStatCard('needsAttention');
        }
        
        let orderSortDirection = {}; // Track sort direction for each column
        
        function sortOrdersBy(field) {
            // Toggle direction if same field, otherwise default to ascending
            if (orderSortBy === field) {
                orderSortDirection[field] = orderSortDirection[field] === 'asc' ? 'desc' : 'asc';
            } else {
                orderSortDirection[field] = field === 'orderDate' ? 'desc' : 'asc';
            }
            
            orderSortBy = field;
            renderOrders();
            updateSortArrows(field);
        }
        
        function updateSortArrows(activeField) {
            const fields = ['clientName', 'weddingDate', 'status', 'orderDate', 'arrivalDate'];
            fields.forEach(f => {
                const arrow = $('sortArrow_' + f);
                if (arrow) {
                    if (f === activeField) {
                        arrow.style.opacity = '1';
                        arrow.textContent = orderSortDirection[f] === 'desc' ? '‚Üì' : '‚Üë';
                    } else {
                        arrow.style.opacity = '0.3';
                        arrow.textContent = '‚Üï';
                    }
                }
            });
        }
        
        function toggleAllOrderCheckboxes(checked) {
            document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = checked);
            updateOrderSelection();
        }
        
        function viewOrderDetails(orderId) {
            const order = data.orders.find(o => String(o.ID) === String(orderId));
            if (!order) return;
            
            // Populate modal fields
            $('editOrderId').value = order.ID;
            
            // Client info
            const client = order.ClientID ? getClient(order.ClientID) : null;
            $('orderDetailClient').textContent = client ? `${client.FirstName} ${client.LastName}` : (order.ClientName || 'Unknown');
            $('orderDetailContact').textContent = client ? 
                [client.Phone, client.Email].filter(Boolean).join(' ¬∑ ') || 'No contact info' :
                [order.Phone, order.Email].filter(Boolean).join(' ¬∑ ') || 'No contact info';
            
            // Order fields
            $('editOrderPO').value = order.PO || '';
            $('editOrderDate').value = order.OrderDate || '';
            
            // Parse items - check if Items JSON exists
            let items = [];
            try {
                if (order.Items) {
                    items = JSON.parse(order.Items);
                }
            } catch (e) {
                items = [];
            }
            
            // Store items on the modal for later use
            window.currentOrderItems = items;
            window.currentOrderItemIndex = 0;
            
            // If we have parsed items, use those
            if (items.length > 0) {
                const dressItems = items.filter(i => i.type === 'dress' || i.type === 'accessory' || i.type === 'inhouse');
                
                if (dressItems.length > 1) {
                    // Multiple items - show dropdown
                    $('editOrderItemSelect').style.display = 'block';
                    $('editOrderItemSelect').innerHTML = dressItems.map((item, idx) => {
                        const label = item.designer ? `${item.designer} - ${item.name}` : item.name;
                        return `<option value="${idx}">${label}</option>`;
                    }).join('');
                    $('orderItemCount').textContent = `(${dressItems.length} items)`;
                    
                    // Show first item details
                    selectOrderItem(0);
                } else if (dressItems.length === 1) {
                    // Single item
                    $('editOrderItemSelect').style.display = 'none';
                    $('orderItemCount').textContent = '';
                    $('editOrderDress').value = dressItems[0].name || '';
                    $('editOrderDesigner').value = dressItems[0].designer || '';
                    $('editOrderSize').value = dressItems[0].size || '';
                } else {
                    // No dress items - use legacy fields
                    $('editOrderItemSelect').style.display = 'none';
                    $('orderItemCount').textContent = '';
                    $('editOrderDress').value = order.Dress || '';
                    $('editOrderDesigner').value = order.Designer || '';
                    $('editOrderSize').value = order.Size || '';
                }
            } else {
                // Legacy order - no Items JSON, use flat fields
                $('editOrderItemSelect').style.display = 'none';
                $('orderItemCount').textContent = '';
                $('editOrderDress').value = order.Dress || '';
                $('editOrderDesigner').value = order.Designer || '';
                $('editOrderSize').value = order.Size || '';
            }
            
            $('editOrderStatus').value = order.Status || 'pending submission';
            $('editOrderArrival').value = order.ArrivalDate || '';
            $('editOrderCustomization').value = order.Customization || '';
            $('editOrderAccessories').value = order.Accessories || '';
            $('editOrderSeamstress').value = order.Seamstress || '';
            $('editOrderNotes').value = order.Notes || '';
            
            // Order submitted tracking
            const submittedBySelect = $('editOrderSubmittedBy');
            submittedBySelect.innerHTML = '<option value="">Not submitted yet</option>' + 
                (data.consultants || []).map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            submittedBySelect.value = order.SubmittedBy || '';
            $('editOrderSubmittedDate').value = order.SubmittedDate || '';
            
            // Show submitted status
            const statusEl = $('orderSubmittedStatus');
            if (order.SubmittedBy && order.SubmittedDate) {
                statusEl.innerHTML = `<span style="color:#27ae60">‚úì Submitted by ${order.SubmittedBy} on ${fmtDate(order.SubmittedDate)}</span>`;
            } else if (order.SubmittedBy || order.SubmittedDate) {
                statusEl.innerHTML = `<span style="color:#e67e22">‚ö†Ô∏è Incomplete - please fill both fields</span>`;
            } else {
                statusEl.innerHTML = `<span style="color:#e74c3c">‚ö†Ô∏è Not yet submitted to designer</span>`;
            }
            
            // Handle client linking
            $('editOrderClientId').value = order.ClientID || '';
            $('orderClientSearch').value = '';
            $('orderClientSearchResults').innerHTML = '';
            
            if (client) {
                // Client is linked - show linked view with dates
                $('orderClientLinked').style.display = 'flex';
                $('orderClientNotLinked').style.display = 'none';
                
                // Show wedding and leaving dates
                let datesHtml = '';
                if (client.WeddingDate) {
                    datesHtml += `<span style="color:var(--dusty)">üíí Wedding: ${fmtDate(client.WeddingDate)}</span>`;
                }
                if (client.LeavingDate) {
                    datesHtml += `${datesHtml ? ' ¬∑ ' : ''}<span style="color:#e74c3c">‚úàÔ∏è Leaving: ${fmtDate(client.LeavingDate)}</span>`;
                }
                $('orderDetailDates').innerHTML = datesHtml || '<span style="color:var(--taupe)">No wedding date set</span>';
            } else {
                // Client not linked - show edit view
                $('orderClientLinked').style.display = 'none';
                $('orderClientNotLinked').style.display = 'block';
                $('editOrderClientName').value = order.ClientName || '';
                $('editOrderPhone').value = order.Phone || '';
                $('editOrderEmail').value = order.Email || '';
                $('editOrderWedding').value = order.WeddingDate || '';
            }
            
            openModal('orderDetails');
        }
        
        function selectOrderItem(idx) {
            const index = idx !== undefined ? idx : parseInt($('editOrderItemSelect').value);
            const items = window.currentOrderItems || [];
            const dressItems = items.filter(i => i.type === 'dress' || i.type === 'accessory' || i.type === 'inhouse');
            
            if (dressItems[index]) {
                const item = dressItems[index];
                $('editOrderDress').value = item.name || '';
                $('editOrderDesigner').value = item.designer || '';
                $('editOrderSize').value = item.size || '';
                window.currentOrderItemIndex = index;
            }
        }
        
        async function saveOrderDetails() {
            const orderId = $('editOrderId').value;
            if (!orderId) return;
            
            const clientId = $('editOrderClientId').value;
            const isLinked = clientId && getClient(clientId);
            
            // Update the current item in Items array if applicable
            const items = window.currentOrderItems || [];
            const dressItems = items.filter(i => i.type === 'dress' || i.type === 'accessory' || i.type === 'inhouse');
            
            if (dressItems.length > 0 && window.currentOrderItemIndex !== undefined) {
                const item = dressItems[window.currentOrderItemIndex];
                if (item) {
                    item.name = $('editOrderDress').value;
                    item.designer = $('editOrderDesigner').value;
                    item.size = $('editOrderSize').value;
                }
            }
            
            const updates = {
                PO: $('editOrderPO').value,
                OrderDate: $('editOrderDate').value,
                Dress: $('editOrderDress').value,
                Designer: $('editOrderDesigner').value,
                Size: $('editOrderSize').value,
                Status: $('editOrderStatus').value,
                ArrivalDate: $('editOrderArrival').value,
                Customization: $('editOrderCustomization').value,
                Accessories: $('editOrderAccessories').value,
                Seamstress: $('editOrderSeamstress').value,
                Notes: $('editOrderNotes').value,
                SubmittedBy: $('editOrderSubmittedBy').value,
                SubmittedDate: $('editOrderSubmittedDate').value
            };
            
            // Update Items JSON if we have items
            if (items.length > 0) {
                updates.Items = JSON.stringify(items);
                
                // Also update flat fields to reflect all items
                const allDresses = dressItems.map(i => i.name).filter(Boolean).join(', ');
                const allDesigners = dressItems.map(i => i.designer).filter(Boolean).join(', ');
                const allSizes = dressItems.map(i => i.size).filter(Boolean).join(', ');
                updates.Dress = allDresses;
                updates.Designer = allDesigners;
                updates.Size = allSizes;
            }
            
            // Add client info if not linked
            if (!isLinked) {
                updates.ClientName = $('editOrderClientName').value;
                updates.Phone = $('editOrderPhone').value;
                updates.Email = $('editOrderEmail').value;
                updates.WeddingDate = $('editOrderWedding').value;
            }
            
            // Add ClientID if linked
            if (clientId) {
                updates.ClientID = clientId;
            }
            
            try {
                await updateRecord('Orders', orderId, updates);
                
                // Update local data
                const order = data.orders.find(o => String(o.ID) === String(orderId));
                if (order) {
                    Object.assign(order, updates);
                }
                saveCachedData();
                
                closeModal('orderDetails');
                renderOrders();
                toast('Order updated!', 'success');
            } catch (e) {
                console.error('Failed to save order:', e);
                toast('Failed to save order', 'error');
            }
        }
        
        function openClientFromOrder() {
            const clientId = $('editOrderClientId').value;
            if (clientId && getClient(clientId)) {
                closeModal('orderDetails');
                openClient(clientId);
            } else {
                toast('Client not linked to this order', 'error');
            }
        }
        
        function unlinkClientFromOrder() {
            $('editOrderClientId').value = '';
            
            // Get current client info before unlinking
            const orderId = $('editOrderId').value;
            const order = data.orders.find(o => String(o.ID) === String(orderId));
            
            $('orderClientLinked').style.display = 'none';
            $('orderClientNotLinked').style.display = 'block';
            $('editOrderClientName').value = order?.ClientName || '';
            $('editOrderPhone').value = order?.Phone || '';
            $('editOrderEmail').value = order?.Email || '';
        }
        
        // ========== ADD NEW ORDER ==========
        let newOrderItems = [];
        
        function openAddOrder() {
            // Reset form
            $('newOrderClientSearch').value = '';
            $('newOrderClientId').value = '';
            $('newOrderClientResults').innerHTML = '';
            $('newOrderPhone').value = '';
            $('newOrderEmail').value = '';
            $('newOrderPO').value = generateNextPO();
            $('newOrderDate').value = today();
            $('newOrderWedding').value = '';
            $('newOrderArrival').value = '';
            $('newOrderStatus').value = 'pending submission';
            $('newOrderSubmittedBy').value = '';
            $('newOrderSubmittedDate').value = '';
            $('newOrderCustomization').value = '';
            $('newOrderAccessories').value = '';
            $('newOrderNotes').value = '';
            
            // Populate consultant dropdown
            const consultants = data.consultants || [];
            $('newOrderSubmittedBy').innerHTML = '<option value="">Not submitted yet</option>' + 
                consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            
            // Start with one empty item
            newOrderItems = [];
            addNewOrderItem();
            
            openModal('addOrder');
        }
        
        function addNewOrderItem() {
            const id = Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            newOrderItems.push({ id, type: 'Veil', name: '', designer: '', size: '' });
            renderNewOrderItems();
        }
        
        function removeNewOrderItem(id) {
            if (newOrderItems.length <= 1) {
                toast('Need at least one item', 'error');
                return;
            }
            newOrderItems = newOrderItems.filter(i => i.id !== id);
            renderNewOrderItems();
        }
        
        function renderNewOrderItems() {
            const container = $('newOrderItemsList');
            container.innerHTML = newOrderItems.map((item, idx) => `
                <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:10px;border-left:3px solid var(--sage);position:relative">
                    ${newOrderItems.length > 1 ? `<button onclick="removeNewOrderItem('${item.id}')" style="position:absolute;top:8px;right:8px;background:none;border:none;color:var(--taupe);cursor:pointer;font-size:16px" title="Remove item">‚úï</button>` : ''}
                    <div style="font-size:11px;font-weight:600;color:var(--taupe);margin-bottom:8px">ITEM ${idx + 1}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div class="form-group" style="margin:0">
                            <select class="form-input" style="font-size:12px" onchange="newOrderItems.find(i=>i.id==='${item.id}').type=this.value">
                                <option value="Veil" ${item.type==='Veil'?'selected':''}>Veil</option>
                                <option value="Jewelry" ${item.type==='Jewelry'?'selected':''}>Jewelry</option>
                                <option value="Belt" ${item.type==='Belt'?'selected':''}>Belt</option>
                                <option value="Headpiece" ${item.type==='Headpiece'?'selected':''}>Headpiece</option>
                                <option value="Shoes" ${item.type==='Shoes'?'selected':''}>Shoes</option>
                                <option value="Dress" ${item.type==='Dress'?'selected':''}>Dress</option>
                                <option value="Other" ${item.type==='Other'?'selected':''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <input type="text" class="form-input" style="font-size:12px" placeholder="Item name" value="${item.name || ''}" onchange="newOrderItems.find(i=>i.id==='${item.id}').name=this.value">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
                        <div class="form-group" style="margin:0">
                            <input type="text" class="form-input" style="font-size:12px" placeholder="Designer/Brand" value="${item.designer || ''}" onchange="newOrderItems.find(i=>i.id==='${item.id}').designer=this.value">
                        </div>
                        <div class="form-group" style="margin:0">
                            <input type="text" class="form-input" style="font-size:12px" placeholder="Size" value="${item.size || ''}" onchange="newOrderItems.find(i=>i.id==='${item.id}').size=this.value">
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function searchClientsForNewOrder(query) {
            const results = $('newOrderClientResults');
            
            if (!query || query.length < 2) {
                results.innerHTML = '';
                $('newOrderClientId').value = '';
                return;
            }
            
            const q = query.toLowerCase();
            const matches = data.clients.filter(c => {
                const name = `${c.FirstName} ${c.LastName}`.toLowerCase();
                const phone = (c.Phone || '').toLowerCase();
                const email = (c.Email || '').toLowerCase();
                return name.includes(q) || phone.includes(q) || email.includes(q);
            }).slice(0, 5);
            
            if (matches.length === 0) {
                results.innerHTML = '<div style="padding:8px;font-size:11px;color:var(--taupe)">No existing client found - will create as new order</div>';
                return;
            }
            
            results.innerHTML = matches.map(c => `
                <div style="padding:8px;border:1px solid var(--champagne);border-radius:4px;margin-bottom:4px;cursor:pointer;transition:background 0.2s" 
                     onmouseover="this.style.background='var(--blush)'" 
                     onmouseout="this.style.background=''" 
                     onclick="selectClientForNewOrder(${c.ID})">
                    <div style="font-weight:500">${c.FirstName} ${c.LastName}</div>
                    <div style="font-size:10px;color:var(--taupe)">${c.Phone || ''} ${c.Email || ''}</div>
                </div>
            `).join('');
        }
        
        function selectClientForNewOrder(clientId) {
            const client = getClient(clientId);
            if (!client) return;
            
            $('newOrderClientId').value = clientId;
            $('newOrderClientSearch').value = `${client.FirstName} ${client.LastName}`;
            $('newOrderPhone').value = client.Phone || '';
            $('newOrderEmail').value = client.Email || '';
            if (client.WeddingDate) $('newOrderWedding').value = getDateStr(client.WeddingDate);
            $('newOrderClientResults').innerHTML = `<div style="padding:8px;background:var(--blush);border-radius:4px;font-size:11px">‚úì Linked to existing client: ${client.FirstName} ${client.LastName}</div>`;
        }
        
        async function saveNewOrder() {
            const clientName = $('newOrderClientSearch').value.trim();
            
            if (!clientName) {
                toast('Please enter a client name', 'error');
                return;
            }
            
            // Sync items from DOM inputs (in case onchange didn't fire)
            const itemEls = $('newOrderItemsList').querySelectorAll('[style*="border-left"]');
            itemEls.forEach((el, idx) => {
                if (newOrderItems[idx]) {
                    const inputs = el.querySelectorAll('input');
                    const select = el.querySelector('select');
                    if (select) newOrderItems[idx].type = select.value;
                    if (inputs[0]) newOrderItems[idx].name = inputs[0].value;
                    if (inputs[1]) newOrderItems[idx].designer = inputs[1].value;
                    if (inputs[2]) newOrderItems[idx].size = inputs[2].value;
                }
            });
            
            // Check at least one item has a name
            const validItems = newOrderItems.filter(i => i.name.trim());
            if (validItems.length === 0) {
                toast('Please enter at least one item name', 'error');
                return;
            }
            
            const clientId = $('newOrderClientId').value;
            
            // Build items array for the order
            const items = validItems.map(i => ({
                type: i.type,
                name: i.name.trim(),
                designer: i.designer.trim(),
                size: i.size.trim()
            }));
            
            // Determine Dress and Accessories fields
            const dressItems = items.filter(i => i.type === 'Dress');
            const accessoryItems = items.filter(i => i.type !== 'Dress');
            
            const record = {
                ClientID: clientId || '',
                ClientName: clientName,
                Phone: $('newOrderPhone').value,
                Email: $('newOrderEmail').value,
                PO: $('newOrderPO').value || generateNextPO(),
                OrderDate: $('newOrderDate').value || today(),
                Dress: dressItems.map(i => i.name).join(', '),
                Designer: items.map(i => i.designer).filter(d => d).join(', '),
                Size: items.map(i => i.size).filter(s => s).join(', '),
                Accessories: accessoryItems.map(i => `${i.type}: ${i.name}`).join(', ') || $('newOrderAccessories').value,
                Items: JSON.stringify(items),
                Status: $('newOrderStatus').value,
                ArrivalDate: $('newOrderArrival').value,
                WeddingDate: $('newOrderWedding').value || (clientId ? (getClient(clientId)?.WeddingDate || '') : ''),
                SubmittedBy: $('newOrderSubmittedBy').value,
                SubmittedDate: $('newOrderSubmittedDate').value,
                Customization: $('newOrderCustomization').value,
                Notes: $('newOrderNotes').value
            };
            
            try {
                const result = await saveRecord('Orders', record);
                record.ID = result.id || Date.now();
                // saveRecord already pushed to data.orders, just update the reference
                saveCachedData();
                
                closeModal('addOrder');
                renderOrders();
                toast(`Order added for ${clientName} (${validItems.length} item${validItems.length > 1 ? 's' : ''})!`, 'success');
            } catch (e) {
                console.error('Failed to save order:', e);
                toast('Failed to save order', 'error');
            }
        }
        
        function searchClientsForOrder(query) {
            const results = $('orderClientSearchResults');
            
            if (!query || query.length < 2) {
                results.innerHTML = '';
                return;
            }
            
            const q = query.toLowerCase();
            const matches = data.clients.filter(c => {
                const name = `${c.FirstName} ${c.LastName}`.toLowerCase();
                const phone = (c.Phone || '').toLowerCase();
                const email = (c.Email || '').toLowerCase();
                return name.includes(q) || phone.includes(q) || email.includes(q);
            }).slice(0, 5);
            
            if (matches.length === 0) {
                results.innerHTML = '<div style="padding:8px;font-size:11px;color:var(--taupe)">No clients found</div>';
                return;
            }
            
            results.innerHTML = matches.map(c => `
                <div style="padding:8px;border-bottom:1px solid var(--champagne);cursor:pointer;transition:background 0.2s" 
                     onmouseover="this.style.background='var(--blush)'" 
                     onmouseout="this.style.background=''" 
                     onclick="linkClientToOrder(${c.ID})">
                    <div style="font-weight:500">${c.FirstName} ${c.LastName}</div>
                    <div style="font-size:10px;color:var(--taupe)">${c.Phone || ''} ${c.Email || ''}</div>
                </div>
            `).join('');
        }
        
        function linkClientToOrder(clientId) {
            const client = getClient(clientId);
            if (!client) return;
            
            $('editOrderClientId').value = clientId;
            $('orderDetailClient').textContent = `${client.FirstName} ${client.LastName}`;
            $('orderDetailContact').textContent = [client.Phone, client.Email].filter(Boolean).join(' ¬∑ ') || 'No contact info';
            
            // Show wedding and leaving dates
            let datesHtml = '';
            if (client.WeddingDate) {
                datesHtml += `<span style="color:var(--dusty)">üíí Wedding: ${fmtDate(client.WeddingDate)}</span>`;
            }
            if (client.LeavingDate) {
                datesHtml += `${datesHtml ? ' ¬∑ ' : ''}<span style="color:#e74c3c">‚úàÔ∏è Leaving: ${fmtDate(client.LeavingDate)}</span>`;
            }
            $('orderDetailDates').innerHTML = datesHtml || '<span style="color:var(--taupe)">No wedding date set</span>';
            
            $('orderClientLinked').style.display = 'flex';
            $('orderClientNotLinked').style.display = 'none';
            $('orderClientSearch').value = '';
            $('orderClientSearchResults').innerHTML = '';
            
            toast(`Linked to ${client.FirstName} ${client.LastName}`, 'success');
        }
        
        function renderOrderCard(o, isPast = false) {
            const c = getClient(o.ClientID);
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const status = o.Status || 'ordered';
            
            // Group items by designer/source
            const designers = {};
            const inhouse = [];
            
            items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    const key = item.designer || 'Unknown';
                    if (!designers[key]) designers[key] = [];
                    designers[key].push(item);
                } else if (item.type === 'inhouse') {
                    inhouse.push(item);
                }
            });
            
            let itemsHtml = '';
            
            // Designer items - simplified display (no checkboxes here)
            Object.keys(designers).forEach(designer => {
                itemsHtml += `<div style="margin-bottom:8px">
                    <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:4px">${designer}</div>`;
                designers[designer].forEach(item => {
                    const qaIcon = item.qaChecked ? '‚úì' : '';
                    itemsHtml += `<div style="padding:4px 0;border-bottom:1px dashed var(--champagne)">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <span style="font-size:11px;font-weight:500">${item.type === 'dress' ? 'üëó' : '‚ú®'} ${item.name}</span>
                                ${qaIcon ? '<span style="color:#27ae60;margin-left:6px">‚úì QA</span>' : ''}
                            </div>
                            <div style="font-size:10px;color:var(--taupe)">${item.size ? 'Size ' + item.size : ''}${item.color ? ' ¬∑ ' + item.color : ''}</div>
                        </div>
                        ${item.customizations && item.customizations.length > 0 ? 
                            `<div style="margin-left:20px;margin-top:4px;font-size:10px;color:var(--taupe)">
                                ${item.customizations.map(cust => `<div>üîß ${cust.name} ${cust.qaChecked ? '<span style="color:#27ae60">‚úì</span>' : ''}</div>`).join('')}
                            </div>` : ''}
                    </div>`;
                });
                itemsHtml += `</div>`;
            });
            
            // In-house items
            if (inhouse.length > 0) {
                itemsHtml += `<div style="margin-bottom:8px">
                    <div style="font-size:10px;font-weight:600;color:var(--taupe);margin-bottom:4px">üè† In-House</div>`;
                inhouse.forEach(item => {
                    const statusLabel = item.status === 'complete' ? '<span style="color:#27ae60">‚úì Complete</span>' : 
                                       item.status === 'in progress' ? '<span style="color:#f39c12">In Progress</span>' : 
                                       '<span style="color:var(--taupe)">Pending</span>';
                    itemsHtml += `<div style="padding:4px 0;border-bottom:1px dashed var(--champagne)">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="font-size:11px;font-weight:500">${item.name}</div>
                            ${statusLabel}
                        </div>
                        ${item.notes ? `<div style="font-size:10px;color:var(--taupe);font-style:italic;margin-top:2px">${item.notes}</div>` : ''}
                    </div>`;
                });
                itemsHtml += `</div>`;
            }
            
            // Action buttons based on status
            let actionButtons = `<button class="btn btn-sm btn-secondary" onclick="openOrderEmailModal(${o.ID})">üìß Email</button>`;
            
            if (status === 'arrived - pending QA') {
                actionButtons += `<button class="btn btn-sm btn-primary" onclick="openQaChecklist(${o.ID})">üìã Do QA Check</button>`;
            } else if (status === 'QA complete') {
                actionButtons += `<button class="btn btn-sm btn-primary" onclick="scheduleFirstFitting(${o.ID})">üìÖ Schedule Fitting</button>`;
            } else if (status === 'in alterations') {
                actionButtons += `<button class="btn btn-sm btn-secondary" onclick="viewAlterations(${o.ClientID})">‚úÇÔ∏è View Alterations</button>`;
            }
            
            if (!isPast) {
                actionButtons += `<button class="btn btn-sm btn-secondary" onclick="openQaChecklist(${o.ID})" title="View QA Details">üìã</button>`;
            }
            
            // Add delete button
            actionButtons += `<button class="btn btn-sm btn-secondary" onclick="deleteOrder(${o.ID})" title="Delete Order" style="color:#e74c3c">‚úï</button>`;
            
            return `<div style="padding:12px;background:var(--cream);border-radius:5px;margin-bottom:12px;border-left:3px solid ${getStatusColor(status)}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
                    <div style="display:flex;align-items:flex-start;gap:10px">
                        <input type="checkbox" class="order-checkbox" data-order-id="${o.ID}" onchange="updateOrderSelection()" style="margin-top:4px;width:16px;height:16px;cursor:pointer">
                        <div>
                            <div style="font-weight:600;font-size:14px">${c ? c.FirstName + ' ' + c.LastName : (o.ClientName || '?')}</div>
                            <div style="font-size:10px;color:var(--taupe)">${o.PO ? 'PO#' + o.PO + ' ¬∑ ' : ''}Order: ${fmtDate(o.OrderDate)} ¬∑ Wedding: ${o.WeddingDate ? fmtDate(o.WeddingDate) : (c ? fmtDate(c.WeddingDate) : '?')}</div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        ${isPast ? 
                            `<div style="font-size:11px;font-weight:500;padding:3px 8px;background:${getStatusColor(status)}20;color:${getStatusColor(status)};border-radius:3px;margin-bottom:4px">${status}</div>` :
                            `<select class="form-input" style="width:auto;font-size:10px;padding:4px 8px;margin-bottom:4px" onchange="updateOrderStatus(${o.ID}, this.value)">
                                ${ORDER_STATUSES.map(s => `<option value="${s}" ${s === status ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>`
                        }
                        <div style="font-size:12px;font-weight:600">${money(o.Total)}</div>
                    </div>
                </div>
                ${itemsHtml}
                <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:8px;flex-wrap:wrap">
                    ${actionButtons}
                </div>
            </div>`;
        }
        
        function getStatusColor(status) {
            const colors = {
                'pending submission': '#e74c3c',
                'ordered': '#3498db',
                'in production': '#3498db',
                'ready to ship': '#8e44ad',
                'shipped': '#f39c12',
                'arrived': '#e67e22',
                'arrived - pending QA': '#e67e22',
                'QA complete': '#27ae60',
                'in alterations': '#1abc9c',
                'picked up': '#95a5a6'
            };
            return colors[status] || '#95a5a6';
        }
        
        // ========== QA CHECKLIST ==========
        function openQAChecklist(orderId) {
            const order = data.orders.find(o => String(o.ID) === String(orderId));
            if (!order) return;
            
            $('qaOrderId').value = orderId;
            $('qaClientName').textContent = order.ClientName || 'Unknown Client';
            $('qaOrderInfo').textContent = `PO# ${order.PO || '‚Äî'} ¬∑ ${order.Dress || 'Item'} ¬∑ ${order.Designer || ''}`;
            
            // Reset checkboxes
            for (let i = 1; i <= 5; i++) {
                $('qaCheck' + i).checked = false;
            }
            $('qaNotes').value = '';
            
            // Populate consultant dropdown
            const qaBy = $('qaPerformedBy');
            qaBy.innerHTML = '<option value="">Select consultant...</option>' + 
                (data.consultants || []).map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            
            openModal('qaChecklist');
        }
        
        async function passQA() {
            const orderId = $('qaOrderId').value;
            if (!orderId) return;
            
            // Check if all items are checked
            let allChecked = true;
            for (let i = 1; i <= 5; i++) {
                if (!$('qaCheck' + i).checked) allChecked = false;
            }
            
            if (!allChecked) {
                if (!confirm('Not all items are checked. Pass QA anyway?')) return;
            }
            
            const qaBy = $('qaPerformedBy').value;
            const notes = $('qaNotes').value;
            
            // Update order
            const order = data.orders.find(o => String(o.ID) === String(orderId));
            if (!order) return;
            
            const updates = {
                Status: 'QA complete',
                QADate: today(),
                QABy: qaBy,
                QANotes: notes ? (order.QANotes ? order.QANotes + '\n' + notes : notes) : order.QANotes
            };
            
            try {
                await updateRecord('Orders', orderId, updates);
                Object.assign(order, updates);
                saveCachedData();
                
                closeModal('qaChecklist');
                renderOrders();
                toast(`QA passed! Ready for alterations.`, 'success');
                
                // Ask if they want to schedule fitting
                const client = order.ClientID ? getClient(order.ClientID) : null;
                if (client && confirm(`Schedule fitting for ${client.FirstName} ${client.LastName}?`)) {
                    scheduleClientFitting(client.ID);
                }
            } catch (e) {
                console.error('QA update failed:', e);
                toast('Failed to update order', 'error');
            }
        }
        
        async function flagQAIssue() {
            const orderId = $('qaOrderId').value;
            if (!orderId) return;
            
            const notes = $('qaNotes').value;
            if (!notes.trim()) {
                toast('Please describe the issue in notes', 'error');
                return;
            }
            
            const qaBy = $('qaPerformedBy').value;
            
            const order = data.orders.find(o => String(o.ID) === String(orderId));
            if (!order) return;
            
            const updates = {
                Status: 'arrived - pending QA',
                QADate: today(),
                QABy: qaBy,
                QANotes: `‚ö†Ô∏è ISSUE FLAGGED (${today()}): ${notes}` + (order.QANotes ? '\n' + order.QANotes : '')
            };
            
            try {
                await updateRecord('Orders', orderId, updates);
                Object.assign(order, updates);
                saveCachedData();
                
                closeModal('qaChecklist');
                renderOrders();
                toast(`Issue flagged for ${order.ClientName}`, 'error');
            } catch (e) {
                console.error('QA flag failed:', e);
                toast('Failed to update order', 'error');
            }
        }
        
        // Bulk order actions
        function updateOrderSelection() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const count = checkboxes.length;
            const bulkBar = $('ordersBulkBar');
            
            if (count > 0) {
                bulkBar.style.display = 'flex';
                $('ordersSelectedCount').textContent = count + ' selected';
            } else {
                bulkBar.style.display = 'none';
            }
        }
        
        function selectAllOrders() {
            document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = true);
            updateOrderSelection();
        }
        
        function deselectAllOrders() {
            document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
            updateOrderSelection();
        }
        
        function getSelectedOrderIds() {
            return Array.from(document.querySelectorAll('.order-checkbox:checked'))
                .map(cb => cb.dataset.orderId);
        }
        
        async function applyBulkStatus() {
            const newStatus = $('bulkStatusSelect').value;
            if (!newStatus) {
                toast('Select a status first', 'error');
                return;
            }
            
            const orderIds = getSelectedOrderIds();
            if (orderIds.length === 0) {
                toast('No orders selected', 'error');
                return;
            }
            
            if (!confirm(`Change status to "${newStatus}" for ${orderIds.length} orders?`)) return;
            
            let altsCreated = 0;
            for (const id of orderIds) {
                await updateRecord('Orders', id, { Status: newStatus });
                const order = data.orders.find(o => String(o.ID) === String(id));
                if (order) {
                    order.Status = newStatus;
                    
                    // Auto-create alteration when bulk-changing to "in alterations"
                    if (newStatus === 'in alterations' && order.ClientID) {
                        const existingAlt = data.alterations.find(a => String(a.ClientID) === String(order.ClientID) && a.Status !== 'complete');
                        if (!existingAlt) {
                            const client = getClient(order.ClientID);
                            if (client) {
                                const altRecord = {
                                    ClientID: String(order.ClientID),
                                    ClientName: `${client.FirstName} ${client.LastName}`,
                                    OrderID: order.ID,
                                    Items: order.Dress || 'Dress',
                                    Notes: 'Auto-created from order status change',
                                    Status: 'in progress',
                                    StartDate: today(),
                                    DueDate: client.WeddingDate || '',
                                    Seamstress: ''
                                };
                                try {
                                    const result = await api('POST', { action: 'add', sheet: 'Alterations', record: altRecord });
                                    altRecord.ID = (result && result.id) ? result.id : 'alt_' + Date.now() + '_' + altsCreated;
                                    data.alterations.push(altRecord);
                                    altsCreated++;
                                } catch (e) {
                                    console.error('Failed to create alteration:', e);
                                }
                            }
                        }
                    }
                }
            }
            
            saveCachedData();
            renderOrders();
            if (altsCreated > 0) renderAlts();
            deselectAllOrders();
            let msg = `Updated ${orderIds.length} orders to "${newStatus}"`;
            if (altsCreated > 0) msg += ` (${altsCreated} alteration${altsCreated > 1 ? 's' : ''} created)`;
            toast(msg, 'success');
        }
        
        async function bulkDeleteOrders() {
            const orderIds = getSelectedOrderIds();
            if (orderIds.length === 0) {
                toast('No orders selected', 'error');
                return;
            }
            
            const confirmed = await appConfirmDanger(`Delete ${orderIds.length} orders? This cannot be undone.`, 'Delete Orders');
            if (!confirmed) return;
            
            for (const id of orderIds) {
                await deleteRecord('Orders', id);
                data.orders = data.orders.filter(o => String(o.ID) !== String(id));
            }
            
            saveCachedData();
            renderOrders();
            deselectAllOrders();
            toast(`Deleted ${orderIds.length} orders`, 'success');
        }
        
        async function toggleItemArrived(orderId, itemId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.arrived = !item.arrived;
                await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                renderOrders();
            }
        }
        
        async function toggleItemQa(orderId, itemId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.qaChecked = !item.qaChecked;
                await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                renderOrders();
            }
        }
        
        async function toggleCustomQa(orderId, itemId, custId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item && item.customizations) {
                const cust = item.customizations.find(c => c.id === custId);
                if (cust) {
                    cust.qaChecked = !cust.qaChecked;
                    await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                    renderOrders();
                }
            }
        }
        
        async function updateInhouseStatus(orderId, itemId, status) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.status = status;
                await updateRecord('Orders', orderId, { Items: JSON.stringify(items) });
                toast('Status updated', 'success');
            }
        }
        
        let currentQaOrderId = null;
        
        function openQaChecklist(orderId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            currentQaOrderId = orderId;
            
            const c = getClient(o.ClientID);
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            
            // Client info
            $('qaClientInfo').innerHTML = `
                <div style="font-weight:600;font-size:14px">${c ? c.FirstName + ' ' + c.LastName : '?'}</div>
                <div style="font-size:11px;color:var(--taupe)">Order Date: ${fmtDate(o.OrderDate)} ¬∑ Wedding: ${c ? fmtDate(c.WeddingDate) : '?'}</div>
            `;
            
            // Build checklist
            let html = '';
            items.forEach((item, idx) => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    const icon = item.type === 'dress' ? 'üëó' : '‚ú®';
                    html += `<div style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:8px">
                        <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer">
                            <input type="checkbox" class="qa-item" data-idx="${idx}" ${item.qaChecked ? 'checked' : ''} style="margin-top:3px;transform:scale(1.3)">
                            <div style="flex:1">
                                <div style="font-weight:600">${icon} ${item.designer} - ${item.name}</div>
                                <div style="font-size:11px;color:var(--taupe)">Size: ${item.size || '‚Äî'} ¬∑ Color: ${item.color || '‚Äî'}</div>
                            </div>
                        </label>`;
                    
                    if (item.customizations && item.customizations.length > 0) {
                        html += `<div style="margin-left:28px;margin-top:8px;padding-top:8px;border-top:1px dashed var(--champagne)">`;
                        item.customizations.forEach((cust, cidx) => {
                            const deliveryLabel = cust.delivery === 'ondress' ? 
                                '<span style="color:var(--dusty)">‚úì Check ON dress</span>' : 
                                '<span style="color:#e67e22">üì¶ Separate package</span>';
                            html += `<label style="display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer">
                                <input type="checkbox" class="qa-custom" data-idx="${idx}" data-cidx="${cidx}" ${cust.qaChecked ? 'checked' : ''}>
                                <span>üîß ${cust.name}</span>
                                <span style="font-size:10px;margin-left:auto">${deliveryLabel}</span>
                            </label>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                } else if (item.type === 'inhouse') {
                    html += `<div style="background:var(--cream);padding:12px;border-radius:5px;margin-bottom:8px">
                        <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer">
                            <input type="checkbox" class="qa-inhouse" data-idx="${idx}" ${item.status === 'complete' ? 'checked' : ''} style="margin-top:3px;transform:scale(1.3)">
                            <div style="flex:1">
                                <div style="font-weight:600">üè† ${item.name}</div>
                                ${item.notes ? `<div style="font-size:11px;color:var(--taupe);font-style:italic">${item.notes}</div>` : ''}
                            </div>
                        </label>
                    </div>`;
                }
            });
            
            $('qaChecklist').innerHTML = html || '<div class="empty">No items to check</div>';
            $('qaNotes').value = o.QaNotes || '';
            
            // Populate consultant dropdown
            $('qaConsultant').innerHTML = '<option value="">Select consultant...</option>' +
                data.consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            
            openModal('qa');
        }
        
        async function submitQaChecklist() {
            if (!currentQaOrderId) return;
            
            const o = data.orders.find(x => x.ID == currentQaOrderId);
            if (!o) return;
            
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const consultant = $('qaConsultant').value;
            const notes = $('qaNotes').value;
            
            // Check if consultant is selected
            if (!consultant) {
                toast('Please select who is doing the QA check', 'error');
                return;
            }
            
            // Update items from checkboxes
            document.querySelectorAll('.qa-item').forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                if (items[idx]) items[idx].qaChecked = cb.checked;
            });
            
            document.querySelectorAll('.qa-custom').forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const cidx = parseInt(cb.dataset.cidx);
                if (items[idx] && items[idx].customizations && items[idx].customizations[cidx]) {
                    items[idx].customizations[cidx].qaChecked = cb.checked;
                }
            });
            
            document.querySelectorAll('.qa-inhouse').forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                if (items[idx]) items[idx].status = cb.checked ? 'complete' : 'pending';
            });
            
            // Check if all items are checked
            let allChecked = true;
            let uncheckedItems = [];
            items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    if (!item.qaChecked) {
                        allChecked = false;
                        uncheckedItems.push(item.name);
                    }
                    if (item.customizations) {
                        item.customizations.forEach(c => { 
                            if (!c.qaChecked) {
                                allChecked = false;
                                uncheckedItems.push(c.name);
                            }
                        });
                    }
                } else if (item.type === 'inhouse') {
                    if (item.status !== 'complete') {
                        allChecked = false;
                        uncheckedItems.push(item.name);
                    }
                }
            });
            
            if (!allChecked) {
                toast(`Cannot complete QA. Unchecked: ${uncheckedItems.join(', ')}`, 'error');
                return;
            }
            
            try {
                await updateRecord('Orders', currentQaOrderId, { 
                    Items: JSON.stringify(items),
                    Status: 'QA complete',
                    QaNotes: notes,
                    QaBy: consultant,
                    QaDate: today()
                });
                closeModal('qa');
                toast('‚úì QA Complete! All items verified by ' + consultant, 'success');
                renderOrders();
            } catch (e) {
                toast('Error saving QA', 'error');
            }
        }
        
        // Keep old function as alias
        function viewOrderQaChecklist(orderId) {
            openQaChecklist(orderId);
        }
        
        function scheduleFirstFitting(orderId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            const c = getClient(o.ClientID);
            if (!c) return;
            
            // Set the pre-fill flag FIRST so openModal doesn't call populateApptModal
            $('apptForClientId').value = c.ID;
            $('editApptId').value = '';
            
            // Open modal first
            $('modal-newAppt').classList.add('active');
            
            // Now set all the fields AFTER modal is open
            $('aDate').value = today();
            $('aTime').value = '11:00';
            $('aType').value = 'first fitting';
            $('apptModalTitle').textContent = 'Schedule First Fitting';
            
            // Show fixed client name, hide client dropdown
            $('clientSelectGroup').style.display = 'none';
            $('clientFixedGroup').style.display = 'block';
            $('aClientName').value = c.FirstName + ' ' + c.LastName;
            $('aClient').value = c.ID;
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            
            // Hide consultation reason, show fitting fields
            $('consultationReasonGroup').style.display = 'none';
            $('fittingFieldsGroup').style.display = 'block';
            
            // Clear visit log fields
            ['aLogFeedback','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => {
                if ($(id)) $(id).value = '';
            });
            
            // Populate wedding date and dress needed by
            if (c.WeddingDate) {
                $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                const weddingDate = parseDate(c.WeddingDate);
                if (weddingDate) {
                    const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                    $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                    // Default dress needed by to 2 weeks before wedding
                    const neededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                    $('aDressNeededBy').value = neededBy.toISOString().split('T')[0];
                }
            } else {
                $('aWeddingDateDisplay').value = 'Not set';
                $('aDaysUntilWedding').textContent = '';
                $('aDressNeededBy').value = '';
            }
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(con => `<option value="${con.Name}">${con.Name}</option>`).join('');
            $('aConsultant').value = '';
        }
        
        function viewAlterations(clientId) {
            showPage('alterations');
            setTimeout(() => openAlterationDetail(clientId), 100);
        }
        
        async function updateOrderStatus(id, status) {
            try {
                await updateRecord('Orders', id, { Status: status });
                // Immediately update local data and re-render
                const order = data.orders.find(o => o.ID == id);
                if (order) {
                    order.Status = status;
                    
                    // Auto-create alteration record when status changes to "in alterations"
                    if (status === 'in alterations' && order.ClientID) {
                        const existingAlt = data.alterations.find(a => String(a.ClientID) === String(order.ClientID) && a.Status !== 'complete');
                        if (!existingAlt) {
                            const client = getClient(order.ClientID);
                            if (client) {
                                const altRecord = {
                                    ClientID: String(order.ClientID),
                                    ClientName: `${client.FirstName} ${client.LastName}`,
                                    OrderID: order.ID,
                                    Items: order.Dress || 'Dress',
                                    Notes: `Auto-created from order status change`,
                                    Status: 'in progress',
                                    StartDate: today(),
                                    DueDate: client.WeddingDate || '',
                                    Seamstress: ''
                                };
                                const result = await api('POST', { action: 'add', sheet: 'Alterations', record: altRecord });
                                altRecord.ID = (result && result.id) ? result.id : 'alt_' + Date.now();
                                data.alterations.push(altRecord);
                                saveCachedData();
                                renderAlts();
                                console.log('Auto-created alteration for', altRecord.ClientName);
                            }
                        }
                    }
                }
                renderOrders();
                toast('Status updated', 'success');
            } catch (e) {}
        }
        
        async function deleteOrder(id) {
            const o = data.orders.find(x => x.ID == id);
            if (!o) return;
            
            const c = getClient(o.ClientID);
            const clientName = c ? `${c.FirstName} ${c.LastName}` : (o.ClientName || 'Unknown');
            
            // Store for undo
            const deletedOrder = { ...o };
            const deletedAlts = o.ClientID ? {
                items: localStorage.getItem(`alts_${o.ClientID}`),
                notes: localStorage.getItem(`alts_notes_${o.ClientID}`),
                neededby: localStorage.getItem(`alts_neededby_${o.ClientID}`)
            } : null;
            
            // Remove from local data immediately (optimistic)
            data.orders = data.orders.filter(x => x.ID != id);
            
            // Remove alteration data from localStorage
            if (o.ClientID) {
                localStorage.removeItem(`alts_${o.ClientID}`);
                localStorage.removeItem(`alts_notes_${o.ClientID}`);
                localStorage.removeItem(`alts_neededby_${o.ClientID}`);
            }
            
            renderOrders();
            renderAlts();
            
            // Push to undo stack
            undoStack.push({
                type: 'delete_order',
                record: deletedOrder,
                alts: deletedAlts
            });
            
            // Show toast with undo
            toast(`Order deleted for ${clientName}`, 'success', true);
            
            // Delete from server in background
            try {
                await deleteRecord('Orders', id);
            } catch (e) {
                console.error('Error deleting order from server:', e);
            }
        }
        
        function viewOrder(id) {
            const o = data.orders.find(x => x.ID == id);
            if (!o) return;
            const c = getClient(o.ClientID);
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            alert(`Order #${o.ID}\nClient: ${c ? c.FirstName + ' ' + c.LastName : '?'}\nItems: ${items.length}\nTotal: ${money(o.Total)}\nStatus: ${o.Status || 'order received'}`);
        }
        
        let currentEmailOrder = null;
        
        function openOrderEmailModal(orderId) {
            const o = data.orders.find(x => x.ID == orderId);
            if (!o) return;
            currentEmailOrder = o;
            
            const c = getClient(o.ClientID);
            $('orderEmailOrderId').value = orderId;
            $('orderEmailTo').value = c?.Email || '';
            $('orderEmailTemplate').value = 'halfway';
            loadOrderEmailTemplate();
            openModal('orderEmail');
            
            // Init rich text editor after template loads
            setTimeout(() => {
                initRichTextEditor('orderEmailBodyEditor', 'orderEmailBody');
            }, 100);
        }
        
        function loadOrderEmailTemplate() {
            const template = $('orderEmailTemplate').value;
            const o = currentEmailOrder;
            if (!o) return;
            
            const c = getClient(o.ClientID);
            const firstName = c?.FirstName || 'there';
            const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
            const dressInfo = items.map(i => `${i.designer || ''} ${i.name || i.type}`).join(', ') || 'your dress';
            const arrivalDate = fmtDate(o.ArrivalDate);
            
            const templates = {
                halfway: {
                    subject: `Update on Your ${getStoreInfo().name || 'Estrelle Bridal'} Order`,
                    body: `Hi ${firstName},

We wanted to give you a quick update on your order!

Your dress (${dressInfo}) is currently in production and everything is on track. The estimated arrival is still ${arrivalDate}.

We'll keep you posted as we get closer to completion. In the meantime, if you have any questions, please don't hesitate to reach out.

Warmly,
${getStoreInfo().name || 'Estrelle Bridal'}
${getStoreInfo().address || ''}
${getStoreInfo().phone || ''}`
                },
                completed: {
                    subject: `Great News! Your Dress is Complete ‚Äî ${getStoreInfo().name || 'Estrelle Bridal'}`,
                    body: `Hi ${firstName},

We have wonderful news ‚Äî your dress (${dressInfo}) has been completed and is being prepared for shipping!

We expect it to arrive at our boutique around ${arrivalDate}. We'll contact you as soon as it arrives to schedule your first fitting appointment.

We can't wait for you to see it!

With love,
${getStoreInfo().name || 'Estrelle Bridal'}
${getStoreInfo().address || ''}
${getStoreInfo().phone || ''}`
                },
                arrived: {
                    subject: `Your Dress Has Arrived! ‚Äî ${getStoreInfo().name || 'Estrelle Bridal'}`,
                    body: `Hi ${firstName},

Your dress has arrived at our boutique! üéâ

Please call us or reply to this email to schedule your first fitting appointment. We recommend booking soon so we have plenty of time for any alterations before your big day.

We're so excited for you to try it on!

With love,
${getStoreInfo().name || 'Estrelle Bridal'}
${getStoreInfo().address || ''}
${getStoreInfo().phone || ''}`
                },
                ready: {
                    subject: `Your Dress is Ready for Pickup! ‚Äî ${getStoreInfo().name || 'Estrelle Bridal'}`,
                    body: `Hi ${firstName},

Your dress is ready and waiting for you! üë∞‚ú®

All alterations are complete and your dress looks absolutely beautiful. Please call us or reply to this email to arrange your pickup time.

Don't forget to bring:
‚Ä¢ Someone to help carry the dress
‚Ä¢ A garment bag (if you have one)

We're so excited for your big day!

With love,
${getStoreInfo().name || 'Estrelle Bridal'}
${getStoreInfo().address || ''}
${getStoreInfo().phone || ''}`
                },
                custom: {
                    subject: `Update from ${getStoreInfo().name || 'Estrelle Bridal'}`,
                    body: `Hi ${firstName},

[Your message here]

Warmly,
${getStoreInfo().name || 'Estrelle Bridal'}`
                }
            };
            
            const t = templates[template];
            $('orderEmailSubject').value = t.subject;
            $('orderEmailBody').value = t.body;
            
            // Sync to rich text editor
            setTimeout(() => initRichTextEditor('orderEmailBodyEditor', 'orderEmailBody'), 50);
            
            // Load saved templates list
            loadSavedTemplatesList();
        }
        
        function loadSavedTemplatesList() {
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            const names = Object.keys(saved);
            $('savedTemplates').innerHTML = '<option value="">-- Saved Templates (' + names.length + ') --</option>' +
                names.map(n => `<option value="${n}">${n}</option>`).join('');
        }
        
        function loadSavedTemplate() {
            const name = $('savedTemplates').value;
            if (!name) return;
            
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            const template = saved[name];
            if (template) {
                // Replace placeholders with current client info
                const o = currentEmailOrder;
                const c = o ? getClient(o.ClientID) : null;
                const firstName = c?.FirstName || 'there';
                
                let subject = template.subject.replace(/\{firstName\}/g, firstName);
                let body = template.body.replace(/\{firstName\}/g, firstName);
                
                $('orderEmailSubject').value = subject;
                $('orderEmailBody').value = body;
                
                // Sync to rich text editor
                setTimeout(() => initRichTextEditor('orderEmailBodyEditor', 'orderEmailBody'), 50);
            }
        }
        
        function saveEmailTemplate() {
            const name = $('newTemplateName').value.trim();
            if (!name) {
                toast('Enter a template name', 'error');
                return;
            }
            
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            
            // Get current values and replace client name with placeholder
            const o = currentEmailOrder;
            const c = o ? getClient(o.ClientID) : null;
            const firstName = c?.FirstName || '';
            
            let subject = $('orderEmailSubject').value;
            let body = $('orderEmailBody').value;
            
            // Replace actual first name with placeholder
            if (firstName) {
                subject = subject.replace(new RegExp(firstName, 'g'), '{firstName}');
                body = body.replace(new RegExp(firstName, 'g'), '{firstName}');
            }
            
            saved[name] = { subject, body };
            localStorage.setItem('estrelle_email_templates', JSON.stringify(saved));
            
            $('newTemplateName').value = '';
            loadSavedTemplatesList();
            toast('Template saved!', 'success');
        }
        
        // ========== ANALYTICS ==========
        function renderAnalytics() {
            const year = parseInt($('analyticsYear').value);
            const yearOrders = data.orders.filter(o => {
                const d = parseDate(o.OrderDate);
                return d && d.getFullYear() === year;
            });
            
            // Calculate totals
            let totalPreTax = 0;
            let totalTax = 0;
            yearOrders.forEach(o => {
                totalPreTax += parseFloat(o.Subtotal) || parseFloat(o.Total) || 0;
                totalTax += parseFloat(o.HST) || 0;
            });
            const totalWithTax = totalPreTax + totalTax;
            const avgOrder = yearOrders.length > 0 ? totalPreTax / yearOrders.length : 0;
            
            $('analyticsTotalPreTax').textContent = money(totalPreTax);
            $('analyticsTotalWithTax').textContent = money(totalWithTax);
            $('analyticsTotalOrders').textContent = yearOrders.length;
            $('analyticsAvgOrder').textContent = money(avgOrder);
            
            // Monthly data
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = months.map((m, i) => {
                const monthOrders = yearOrders.filter(o => {
                    const d = parseDate(o.OrderDate);
                    return d && d.getMonth() === i;
                });
                const preTax = monthOrders.reduce((s, o) => s + (parseFloat(o.Subtotal) || parseFloat(o.Total) || 0), 0);
                const tax = monthOrders.reduce((s, o) => s + (parseFloat(o.HST) || 0), 0);
                return { month: m, orders: monthOrders.length, preTax, tax, total: preTax + tax };
            });
            
            // Sales chart
            const maxSales = Math.max(...monthlyData.map(d => d.preTax), 1);
            $('salesChart').innerHTML = monthlyData.map((d, i) => {
                const height = Math.max((d.preTax / maxSales) * 200, 4);
                const isCurrentMonth = new Date().getFullYear() === year && new Date().getMonth() === i;
                return `<div style="flex:1;display:flex;flex-direction:column;align-items:center">
                    <div style="font-size:10px;margin-bottom:4px">${d.preTax > 0 ? money(d.preTax) : ''}</div>
                    <div style="width:100%;height:${height}px;background:${isCurrentMonth ? 'var(--dusty)' : 'var(--champagne)'};border-radius:3px 3px 0 0"></div>
                </div>`;
            }).join('');
            $('salesChartLabels').innerHTML = months.map(m => `<div style="flex:1;text-align:center">${m}</div>`).join('');
            
            // Monthly breakdown table
            $('monthlyBreakdownTable').querySelector('tbody').innerHTML = monthlyData.map(d => 
                `<tr><td>${d.month}</td><td>${d.orders}</td><td>${money(d.preTax)}</td><td>${money(d.tax)}</td><td><b>${money(d.total)}</b></td></tr>`
            ).join('') + `<tr style="background:var(--cream);font-weight:600">
                <td>TOTAL</td><td>${yearOrders.length}</td><td>${money(totalPreTax)}</td><td>${money(totalTax)}</td><td>${money(totalWithTax)}</td>
            </tr>`;
            
            // Customer stats
            const yearClients = data.clients.filter(c => {
                const d = parseDate(c.LastVisit);
                return d && d.getFullYear() === year;
            });
            
            const customerMonthly = months.map((m, i) => {
                const newClients = data.clients.filter(c => {
                    // Use first appointment or estimate from LastVisit
                    const clientAppts = data.appointments.filter(a => a.ClientID == c.ID);
                    if (clientAppts.length > 0) {
                        const firstAppt = clientAppts.sort((a, b) => parseDate(a.Date) - parseDate(b.Date))[0];
                        const d = parseDate(firstAppt.Date);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    }
                    return false;
                });
                
                const monthAppts = data.appointments.filter(a => {
                    const d = parseDate(a.Date);
                    return d && d.getFullYear() === year && d.getMonth() === i && 
                           ((a.Type || '').toLowerCase().includes('consultation') || !a.Type);
                });
                
                const monthOrders = yearOrders.filter(o => {
                    const d = parseDate(o.OrderDate);
                    return d && d.getMonth() === i;
                });
                
                const conversionRate = monthAppts.length > 0 ? Math.round((monthOrders.length / monthAppts.length) * 100) : 0;
                
                return { month: m, newClients: newClients.length, consultations: monthAppts.length, conversions: conversionRate };
            });
            
            $('customerStatsTable').querySelector('tbody').innerHTML = customerMonthly.map(d => 
                `<tr><td>${d.month}</td><td>${d.newClients}</td><td>${d.consultations}</td><td>${d.conversions}%</td></tr>`
            ).join('');
            
            // Wedding seasonality (by wedding month)
            const weddingMonths = months.map((m, i) => {
                const count = data.clients.filter(c => {
                    const d = parseDate(c.WeddingDate);
                    return d && d.getFullYear() === year && d.getMonth() === i;
                }).length;
                return { month: m, count };
            });
            
            const maxWeddings = Math.max(...weddingMonths.map(w => w.count), 1);
            $('seasonalityChart').innerHTML = weddingMonths.map(w => {
                const width = (w.count / maxWeddings) * 100;
                const isSeason = w.count > maxWeddings * 0.5;
                return `<div style="display:flex;align-items:center;gap:8px">
                    <div style="width:40px;font-size:11px">${w.month}</div>
                    <div style="flex:1;background:var(--blush);border-radius:3px;height:20px">
                        <div style="width:${width}%;height:100%;background:${isSeason ? 'var(--dusty)' : 'var(--champagne)'};border-radius:3px;display:flex;align-items:center;justify-content:flex-end;padding-right:6px">
                            <span style="font-size:10px;color:${isSeason ? 'white' : 'var(--charcoal)'}"><b>${w.count}</b></span>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            // Top designers
            const designerSales = {};
            yearOrders.forEach(o => {
                const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
                items.forEach(item => {
                    if (item.designer) {
                        designerSales[item.designer] = (designerSales[item.designer] || 0) + (item.price || 0);
                    }
                });
            });
            
            const topDesigners = Object.entries(designerSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const maxDesignerSales = topDesigners.length > 0 ? topDesigners[0][1] : 1;
            $('topDesignersChart').innerHTML = topDesigners.length > 0 ? 
                topDesigners.map(([name, sales], i) => {
                    const width = (sales / maxDesignerSales) * 100;
                    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <div style="width:120px;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${name}">${i + 1}. ${name}</div>
                        <div style="flex:1;background:var(--blush);border-radius:3px;height:18px">
                            <div style="width:${width}%;height:100%;background:var(--dusty);border-radius:3px"></div>
                        </div>
                        <div style="width:70px;font-size:10px;text-align:right">${money(sales)}</div>
                    </div>`;
                }).join('') : '<div class="empty">No designer data</div>';
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Handle Excel serial number
            if (typeof dateStr === 'number') {
                return new Date((dateStr - 25569) * 86400 * 1000);
            }
            
            const str = String(dateStr).trim();
            
            // Handle empty or invalid
            if (!str || str === 'nan' || str === 'NaN' || str === 'undefined') return null;
            
            // Try ISO format first (2025-06-15)
            if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
                const d = new Date(str.split('T')[0] + 'T00:00:00');
                if (!isNaN(d.getTime())) return d;
            }
            
            // Handle "Month Day, Year" format (June 6th, 2024 or Sept 13, 2025)
            const monthNames = {
                'jan': 0, 'january': 0,
                'feb': 1, 'february': 1,
                'mar': 2, 'march': 2,
                'apr': 3, 'april': 3,
                'may': 4,
                'jun': 5, 'june': 5,
                'jul': 6, 'july': 6,
                'aug': 7, 'august': 7,
                'sep': 8, 'sept': 8, 'september': 8,
                'oct': 9, 'october': 9,
                'nov': 10, 'november': 10,
                'dec': 11, 'december': 11
            };
            
            // Try "Month Day, Year" or "Month Day Year"
            const textMatch = str.match(/^([a-zA-Z]+)\s*(\d{1,2})(?:st|nd|rd|th)?,?\s*(\d{4})/i);
            if (textMatch) {
                const month = monthNames[textMatch[1].toLowerCase()];
                const day = parseInt(textMatch[2]);
                const year = parseInt(textMatch[3]);
                if (month !== undefined && day && year) {
                    return new Date(year, month, day);
                }
            }
            
            // Try "Day Month Year" format
            const textMatch2 = str.match(/^(\d{1,2})(?:st|nd|rd|th)?\s+([a-zA-Z]+),?\s*(\d{4})/i);
            if (textMatch2) {
                const day = parseInt(textMatch2[1]);
                const month = monthNames[textMatch2[2].toLowerCase()];
                const year = parseInt(textMatch2[3]);
                if (month !== undefined && day && year) {
                    return new Date(year, month, day);
                }
            }
            
            // Handle MM/DD/YYYY or DD/MM/YYYY (assume MM/DD/YYYY for US)
            const slashMatch = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (slashMatch) {
                const month = parseInt(slashMatch[1]) - 1;
                const day = parseInt(slashMatch[2]);
                const year = parseInt(slashMatch[3]);
                return new Date(year, month, day);
            }
            
            // Handle partial dates like "SEPT/OCT" - return null
            if (str.includes('/') && !slashMatch) {
                return null;
            }
            
            // Fallback to native Date parsing
            const d = new Date(str);
            return isNaN(d.getTime()) ? null : d;
        }
        
        function exportData(type) {
            const year = parseInt($('analyticsYear').value);
            let csvContent = '';
            let filename = '';
            
            if (type === 'monthly-sales') {
                filename = `estrelle_monthly_sales_${year}.csv`;
                csvContent = 'Month,Orders,Pre-Tax Sales,Tax (HST),Total Sales\n';
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach((m, i) => {
                    const monthOrders = data.orders.filter(o => {
                        const d = parseDate(o.OrderDate);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    });
                    const preTax = monthOrders.reduce((s, o) => s + (parseFloat(o.Subtotal) || parseFloat(o.Total) || 0), 0);
                    const tax = monthOrders.reduce((s, o) => s + (parseFloat(o.HST) || 0), 0);
                    csvContent += `${m},${monthOrders.length},${preTax.toFixed(2)},${tax.toFixed(2)},${(preTax + tax).toFixed(2)}\n`;
                });
            } else if (type === 'orders') {
                filename = `estrelle_orders_${year}.csv`;
                csvContent = 'Order ID,Client,Order Date,Status,Subtotal,Tax,Total,Items\n';
                data.orders.filter(o => {
                    const d = parseDate(o.OrderDate);
                    return d && d.getFullYear() === year;
                }).forEach(o => {
                    const c = getClient(o.ClientID);
                    const items = typeof o.Items === 'string' ? JSON.parse(o.Items || '[]') : (o.Items || []);
                    const itemsList = items.map(i => i.name || i.type).join('; ');
                    csvContent += `${o.ID},"${c ? c.FirstName + ' ' + c.LastName : ''}",${fmtDate(o.OrderDate)},${o.Status || ''},${o.Subtotal || o.Total || 0},${o.HST || 0},${o.Total || 0},"${itemsList}"\n`;
                });
            } else if (type === 'customers') {
                filename = `estrelle_customers_${year}.csv`;
                csvContent = 'Client ID,First Name,Last Name,Email,Phone,Wedding Date,Venue,Status,Budget\n';
                data.clients.forEach(c => {
                    csvContent += `${c.ID},"${c.FirstName}","${c.LastName}","${c.Email || ''}","${c.Phone || ''}",${fmtDate(c.WeddingDate)},"${c.Venue || ''}",${c.Status || ''},"${c.Budget || ''}"\n`;
                });
            } else if (type === 'appointments') {
                filename = `estrelle_appointments_${year}.csv`;
                csvContent = 'Date,Time,Client,Type,Consultant,Notes\n';
                data.appointments.filter(a => {
                    const d = parseDate(a.Date);
                    return d && d.getFullYear() === year;
                }).forEach(a => {
                    const c = getClient(a.ClientID);
                    csvContent += `${fmtDate(a.Date)},${a.Time || ''},"${c ? c.FirstName + ' ' + c.LastName : ''}",${normalizeApptType(a.Type)},${a.Consultant || ''},"${(a.Notes || '').replace(/"/g, '""')}"\n`;
                });
            } else if (type === 'seasonality') {
                filename = `estrelle_seasonality_${year}.csv`;
                csvContent = 'Month,Weddings,New Clients,Consultations,Orders,Conversion Rate\n';
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach((m, i) => {
                    const weddings = data.clients.filter(c => {
                        const d = parseDate(c.WeddingDate);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    }).length;
                    const consultations = data.appointments.filter(a => {
                        const d = parseDate(a.Date);
                        return d && d.getFullYear() === year && d.getMonth() === i && ((a.Type || '').toLowerCase().includes('consultation') || !a.Type);
                    }).length;
                    const orders = data.orders.filter(o => {
                        const d = parseDate(o.OrderDate);
                        return d && d.getFullYear() === year && d.getMonth() === i;
                    }).length;
                    const conversion = consultations > 0 ? Math.round((orders / consultations) * 100) : 0;
                    csvContent += `${m},${weddings},0,${consultations},${orders},${conversion}%\n`;
                });
            }
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            toast(`Downloaded ${filename}`, 'success');
        }
        
        function exportAnalytics() {
            exportData('monthly-sales');
        }
        
        async function sendOrderEmail() {
            syncRichTextEditor('orderEmailBodyEditor', 'orderEmailBody');
            
            const email = $('orderEmailTo').value;
            if (!email) {
                toast('No email address', 'error');
                return;
            }
            
            const subject = $('orderEmailSubject').value;
            const body = $('orderEmailBody').value;
            
            closeModal('orderEmail');
            sendEmailViaPreferredMethod(email, subject, body);
        }

        // ========== ALTERATIONS ==========
        let currentAltClientId = null;
        let currentAltItems = [];
        
        function renderAlts() {
            // Get clients in alterations from TWO sources:
            // 1. Orders with status 'in alterations' or 'QA complete'
            // 2. Records in data.alterations array
            
            const altsClients = [];
            const processedClientIds = new Set();
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            // Source 1: From orders
            data.orders.forEach(o => {
                if (o.Status === 'in alterations' || o.Status === 'QA complete') {
                    const c = getClient(o.ClientID);
                    if (c && !processedClientIds.has(String(c.ID))) {
                        processedClientIds.add(String(c.ID));
                        const weddingDate = parseDate(c.WeddingDate);
                        const daysToWedding = weddingDate ? Math.ceil((weddingDate - now) / (1000 * 60 * 60 * 24)) : 999;
                        
                        const fittings = data.appointments.filter(a => 
                            a.ClientID == c.ID && 
                            (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
                        ).sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
                        
                        // Load alt items - localStorage FIRST (has existing data), then Google Sheets
                        let altItems = [];
                        const localItems = localStorage.getItem(`alts_${c.ID}`);
                        if (localItems) {
                            try { altItems = JSON.parse(localItems); } catch (e) {}
                        }
                        // If localStorage empty, try Google Sheets
                        if (altItems.length === 0) {
                            const altRec = data.alterations?.find(a => String(a.ClientID) === String(c.ID) && a.Status !== 'complete');
                            if (altRec && altRec.AlterationItems) {
                                try { altItems = JSON.parse(altRec.AlterationItems); } catch (e) {}
                            }
                        }
                        const doneCount = altItems.filter(i => i.status === 'done').length;
                        const totalCount = altItems.length;
                        
                        // Get today's date at start of day for comparison
                        const todayStart = new Date();
                        todayStart.setHours(0, 0, 0, 0);
                        
                        altsClients.push({
                            client: c,
                            order: o,
                            fittings,
                            altItems,
                            doneCount,
                            totalCount,
                            daysToWedding,
                            nextFitting: fittings.find(f => {
                                const fDate = parseDate(f.Date);
                                return fDate && fDate >= todayStart;
                            })
                        });
                    }
                }
            });
            
            // Source 2: From data.alterations array (created by sync or auto-create)
            console.log('Checking data.alterations:', data.alterations?.length || 0, 'records');
            (data.alterations || []).forEach(alt => {
                console.log('Alteration record:', alt.ClientID, alt.ClientName, alt.Status);
                if (alt.Status === 'complete') return; // Skip completed
                
                const clientId = String(alt.ClientID);
                if (processedClientIds.has(clientId)) {
                    console.log('Already processed from orders:', clientId);
                    return;
                }
                
                const c = getClient(clientId);
                console.log('getClient(' + clientId + ') =', c ? c.FirstName + ' ' + c.LastName : 'NOT FOUND');
                
                if (c) {
                    processedClientIds.add(clientId);
                    const weddingDate = parseDate(c.WeddingDate);
                    const daysToWedding = weddingDate ? Math.ceil((weddingDate - now) / (1000 * 60 * 60 * 24)) : 999;
                    
                    const fittings = data.appointments.filter(a => 
                        String(a.ClientID) === clientId && 
                        (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
                    ).sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
                    
                    // Get order for this client
                    const order = data.orders.find(o => String(o.ClientID) === clientId && o.Status !== 'picked up');
                    
                    // Load alt items - localStorage FIRST (has existing data), then Google Sheets
                    let altItems = [];
                    const localItems = localStorage.getItem(`alts_${c.ID}`);
                    if (localItems) {
                        try { altItems = JSON.parse(localItems); } catch (e) {}
                    }
                    // If localStorage empty, try Google Sheets record
                    if (altItems.length === 0 && alt.AlterationItems) {
                        try { altItems = JSON.parse(alt.AlterationItems); } catch (e) {}
                    }
                    const doneCount = altItems.filter(i => i.status === 'done').length;
                    const totalCount = altItems.length;
                    
                    // Get today's date at start of day for comparison
                    const todayStart = new Date();
                    todayStart.setHours(0, 0, 0, 0);
                    
                    altsClients.push({
                        client: c,
                        order: order || { ID: alt.OrderID, Dress: alt.Items },
                        alteration: alt,
                        fittings,
                        altItems,
                        doneCount,
                        totalCount,
                        daysToWedding,
                        nextFitting: fittings.find(f => {
                            const fDate = parseDate(f.Date);
                            return fDate && fDate >= todayStart;
                        })
                    });
                    console.log('Added to altsClients:', c.FirstName, c.LastName);
                }
            });
            
            console.log('Total altsClients after both sources:', altsClients.length);
            
            // Sort by next upcoming fitting (soonest first), then by wedding date
            altsClients.sort((a, b) => {
                const aFitting = a.nextFitting ? parseDate(a.nextFitting.Date) : null;
                const bFitting = b.nextFitting ? parseDate(b.nextFitting.Date) : null;
                
                // Both have fittings - sort by fitting date
                if (aFitting && bFitting) return aFitting - bFitting;
                // Only one has a fitting - that one goes first
                if (aFitting && !bFitting) return -1;
                if (!aFitting && bFitting) return 1;
                // Neither has a fitting - sort by wedding date (most urgent first)
                return a.daysToWedding - b.daysToWedding;
            });
            
            // Calculate stats
            const active = altsClients.length;
            const fittingsThisWeek = altsClients.filter(ac => ac.nextFitting && parseDate(ac.nextFitting.Date) <= weekFromNow).length;
            const urgent = altsClients.filter(ac => ac.daysToWedding <= 30).length;
            
            $('altsActive').textContent = active;
            $('altsFittingsWeek').textContent = fittingsThisWeek;
            $('altsUrgent').textContent = urgent;
            
            // Render list
            if (altsClients.length === 0) {
                $('alterationsList').innerHTML = '<div class="card"><div class="card-body empty">No active alterations. Clients appear here when orders are marked "QA complete" or "in alterations".</div></div>';
                return;
            }
            
            $('alterationsList').innerHTML = altsClients.map(ac => {
                const c = ac.client;
                const urgencyColor = ac.daysToWedding <= 14 ? '#e74c3c' : ac.daysToWedding <= 30 ? '#f39c12' : '#27ae60';
                const progressPct = ac.totalCount > 0 ? Math.round((ac.doneCount / ac.totalCount) * 100) : 0;
                
                // Next fitting info
                let nextFittingHtml = '';
                if (ac.nextFitting) {
                    nextFittingHtml = `<div style="font-size:10px;color:var(--dusty)">Next: ${fmtDate(ac.nextFitting.Date)} @ ${ac.nextFitting.Time} (${ac.nextFitting.Type})</div>`;
                } else {
                    nextFittingHtml = `<div style="font-size:10px;color:#e74c3c">‚ö†Ô∏è No fitting scheduled</div>`;
                }
                
                // Items summary
                let itemsHtml = '';
                if (ac.altItems.length > 0) {
                    itemsHtml = ac.altItems.slice(0, 4).map(item => {
                        const icon = item.status === 'done' ? '‚úì' : item.status === 'in-progress' ? '‚è≥' : '‚óã';
                        const color = item.status === 'done' ? '#27ae60' : item.status === 'in-progress' ? '#f39c12' : 'var(--taupe)';
                        return `<span style="font-size:10px;color:${color};margin-right:8px">${icon} ${item.name}</span>`;
                    }).join('');
                    if (ac.altItems.length > 4) itemsHtml += `<span style="font-size:10px;color:var(--taupe)">+${ac.altItems.length - 4} more</span>`;
                }
                
                return `<div class="card" style="margin-bottom:12px;border-left:3px solid ${urgencyColor};cursor:pointer" onclick="openAlterationDetail(${c.ID})">
                    <div class="card-body">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
                            <div>
                                <div style="font-weight:600;font-size:14px">${c.FirstName} ${c.LastName}</div>
                                <div style="font-size:10px;color:var(--taupe)">Wedding: ${fmtDate(c.WeddingDate)} ¬∑ <span style="color:${urgencyColor};font-weight:600">${ac.daysToWedding} days away</span></div>
                                ${nextFittingHtml}
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:10px;color:var(--taupe)">Progress</div>
                                <div style="font-size:14px;font-weight:600">${ac.doneCount}/${ac.totalCount}</div>
                                <div style="width:60px;height:4px;background:var(--blush);border-radius:2px;overflow:hidden">
                                    <div style="width:${progressPct}%;height:100%;background:${progressPct === 100 ? '#27ae60' : 'var(--dusty)'}"></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom:8px">${itemsHtml || '<span style="font-size:10px;color:var(--taupe)">No alteration items yet</span>'}</div>
                        <div style="display:flex;justify-content:flex-end;gap:6px">
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteAlteration(${c.ID})" title="Remove from alterations" style="color:#e74c3c">‚úï</button>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();scheduleClientFitting(${c.ID})">üìÖ Schedule</button>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();markAlterationComplete(${c.ID})" style="background:#27ae60">‚úì Picked Up</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        async function deleteAlteration(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            const clientName = `${c.FirstName} ${c.LastName}`;
            
            // Save data for undo before removing
            const localData = {
                items: localStorage.getItem(`alts_${clientId}`),
                notes: localStorage.getItem(`alts_notes_${clientId}`),
                neededby: localStorage.getItem(`alts_neededby_${clientId}`)
            };
            
            // Find alteration record
            const altRecord = data.alterations?.find(a => String(a.ClientID) === String(clientId) && a.Status !== 'complete');
            const altRecordCopy = altRecord ? { ...altRecord } : null;
            
            // Remove from data.alterations
            if (altRecord) {
                const idx = data.alterations.indexOf(altRecord);
                if (idx >= 0) data.alterations.splice(idx, 1);
                // Delete from server
                api('POST', { action: 'delete', sheet: 'Alterations', id: altRecord.ID }).catch(() => {});
            }
            
            // Remove alteration data from localStorage
            localStorage.removeItem(`alts_${clientId}`);
            localStorage.removeItem(`alts_notes_${clientId}`);
            localStorage.removeItem(`alts_neededby_${clientId}`);
            
            // Set order status back to QA complete (so they can re-enter alterations if needed)
            const order = data.orders.find(o => o.ClientID == clientId && o.Status === 'in alterations');
            const prevOrderStatus = order?.Status;
            if (order) {
                order.Status = 'QA complete';
                updateRecord('Orders', order.ID, { Status: 'QA complete' });
            }
            
            saveCachedData();
            renderAlts();
            renderOrders();
            
            // Add to undo stack
            addUndo({ 
                type: 'delete_alteration', 
                record: altRecordCopy,
                localData,
                clientName,
                orderId: order?.ID,
                prevOrderStatus
            });
            
            toast(`${clientName} removed from alterations`, 'success', true);
        }
        
        function scheduleClientFitting(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            // Set the pre-fill flag FIRST so openModal doesn't call populateApptModal
            $('apptForClientId').value = clientId;
            $('editApptId').value = '';
            
            // Open modal first
            $('modal-newAppt').classList.add('active');
            
            // Now set all the fields AFTER modal is open
            $('aDate').value = today();
            $('aTime').value = '11:00';
            
            // Populate type dropdown BEFORE setting value
            const serviceTypes = getServiceTypes();
            $('aType').innerHTML = serviceTypes.map(t => {
                const val = t.toLowerCase();
                return `<option value="${val}">${t}</option>`;
            }).join('');
            $('aType').value = 'fitting';
            
            $('apptModalTitle').textContent = 'Schedule Fitting';
            
            // Show fixed client name, hide client dropdown
            $('clientSelectGroup').style.display = 'none';
            $('clientFixedGroup').style.display = 'block';
            $('aClientName').value = c.FirstName + ' ' + c.LastName;
            $('aClient').value = clientId;
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            
            // Hide consultation reason, show fitting fields
            $('consultationReasonGroup').style.display = 'none';
            $('fittingFieldsGroup').style.display = 'block';
            
            // Clear visit log fields
            ['aLogFeedback','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => {
                if ($(id)) $(id).value = '';
            });
            
            // Populate wedding date and dress needed by
            // First check for saved neededby date
            const savedNeededBy = localStorage.getItem(`alts_neededby_${clientId}`);
            
            if (c.WeddingDate) {
                $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                const weddingDate = parseDate(c.WeddingDate);
                if (weddingDate) {
                    const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                    $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                }
                
                // Use saved date if exists, otherwise default to 2 weeks before wedding
                if (savedNeededBy) {
                    $('aDressNeededBy').value = savedNeededBy;
                } else if (weddingDate) {
                    const neededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                    $('aDressNeededBy').value = neededBy.toISOString().split('T')[0];
                }
            } else {
                $('aWeddingDateDisplay').value = 'Not set';
                $('aDaysUntilWedding').textContent = '';
                $('aDressNeededBy').value = savedNeededBy || '';
            }
            
            // Populate consultant dropdown
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(con => `<option value="${con.Name}">${con.Name}</option>`).join('');
            $('aConsultant').value = '';
        }
        
        function openAddAlterationItem() {
            // Open appointment modal with fitting type selected
            $('editApptId').value = '';
            $('apptForClientId').value = '';
            populateApptModal();
            
            // Set type to fitting
            $('aType').value = 'fitting';
            toggleConsultationReason();
            
            openModal('newAppt');
        }
        
        function openAlterationDetail(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            currentAltClientId = clientId;
            
            // PRIORITY 1: Load from Google Sheets (for cross-device sync)
            const altRecord = data.alterations?.find(a => String(a.ClientID) === String(clientId) && a.Status !== 'complete');
            
            if (altRecord && altRecord.AlterationItems) {
                try {
                    currentAltItems = JSON.parse(altRecord.AlterationItems);
                    // Also update localStorage for offline use
                    localStorage.setItem(`alts_${clientId}`, altRecord.AlterationItems);
                    console.log(`[ALTS] Loaded ${currentAltItems.length} items from Google Sheets for client ${clientId}`);
                } catch (e) {
                    console.error('[ALTS] Failed to parse Google Sheets items:', e);
                    currentAltItems = [];
                }
            } else {
                currentAltItems = [];
            }
            
            // PRIORITY 2: If Google Sheets empty, try localStorage (for offline data)
            if (currentAltItems.length === 0) {
                const localItems = localStorage.getItem(`alts_${clientId}`);
                if (localItems) {
                    try {
                        currentAltItems = JSON.parse(localItems);
                        console.log(`[ALTS] Loaded ${currentAltItems.length} items from localStorage (offline fallback)`);
                    } catch (e) {
                        console.error('[ALTS] Failed to parse localStorage items:', e);
                        currentAltItems = [];
                    }
                }
            }
            
            // Get order info
            const order = data.orders.find(o => o.ClientID == clientId && (o.Status === 'in alterations' || o.Status === 'QA complete'));
            
            // Client info - clickable to edit
            const weddingDate = parseDate(c.WeddingDate);
            const daysToWedding = weddingDate ? Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24)) : '?';
            
            $('altClientInfo').innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div style="cursor:pointer" onclick="closeModal('alteration');openClient(${clientId})">
                        <div style="font-weight:600;font-size:16px">${c.FirstName} ${c.LastName} <span style="font-size:11px;color:var(--dusty)">‚úèÔ∏è</span></div>
                        <div style="font-size:11px;color:var(--taupe)">Wedding: ${fmtDate(c.WeddingDate)} ¬∑ ${daysToWedding} days away</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:11px;color:var(--taupe)">${c.Phone || ''}</div>
                        <div style="font-size:11px;color:var(--taupe)">${c.Email || ''}</div>
                    </div>
                </div>
            `;
            
            // Fittings list
            const fittings = data.appointments.filter(a => 
                a.ClientID == clientId && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            ).sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
            
            renderAltFittingsList(fittings);
            
            // Render alteration items
            renderAltItems();
            
            // Load notes - Google Sheets first (for sync), then localStorage
            let notes = '';
            if (altRecord && altRecord.Notes) {
                notes = altRecord.Notes;
                localStorage.setItem(`alts_notes_${clientId}`, notes);
            } else {
                notes = localStorage.getItem(`alts_notes_${clientId}`) || '';
            }
            $('altNotes').value = notes;
            
            // Load dress needed by - Google Sheets first, then localStorage, then default
            let neededBy = '';
            if (altRecord && altRecord.DueDate) {
                neededBy = typeof altRecord.DueDate === 'string' ? altRecord.DueDate.split('T')[0] : String(altRecord.DueDate);
                if (neededBy && neededBy !== 'undefined' && neededBy !== 'null') {
                    localStorage.setItem(`alts_neededby_${clientId}`, neededBy);
                } else {
                    neededBy = '';
                }
            }
            if (!neededBy) {
                neededBy = localStorage.getItem(`alts_neededby_${clientId}`) || '';
            }
            if (!neededBy && weddingDate) {
                // Default to 2 weeks before wedding ONLY if no saved date
                const defaultNeededBy = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                neededBy = defaultNeededBy.toISOString().split('T')[0];
                console.log(`[ALTS] Using default neededBy (2 weeks before wedding): ${neededBy}`);
            }
            $('altDressNeededBy').value = neededBy || '';
            updateNeededByCountdown();
            
            // Render next fitting section
            altPendingNextFitting = null;
            renderAltNextFitting();
            
            openModal('alteration');
        }
        
        function saveAltNeededBy() {
            if (!currentAltClientId) return;
            const neededBy = $('altDressNeededBy').value;
            localStorage.setItem(`alts_neededby_${currentAltClientId}`, neededBy);
            updateNeededByCountdown();
        }
        
        function updateNeededByCountdown() {
            const neededBy = $('altDressNeededBy').value;
            if (!neededBy) {
                $('altNeededByCountdown').innerHTML = '';
                return;
            }
            const neededByDate = new Date(neededBy + 'T00:00:00');
            const daysUntil = Math.ceil((neededByDate - new Date()) / (1000 * 60 * 60 * 24));
            
            let color = '#27ae60';
            let text = `${daysUntil} days`;
            if (daysUntil <= 7) {
                color = '#e74c3c';
                text = `‚ö†Ô∏è ${daysUntil} days - URGENT!`;
            } else if (daysUntil <= 14) {
                color = '#f39c12';
                text = `${daysUntil} days - soon`;
            }
            
            $('altNeededByCountdown').innerHTML = `<span style="color:${color}">${text}</span>`;
        }
        
        function editFittingFromAlt(apptId) {
            const appt = data.appointments.find(a => a.ID == apptId);
            if (!appt) return;
            
            const c = getClient(appt.ClientID);
            
            // Close alteration modal
            closeModal('alteration');
            
            // Open appointment edit modal
            $('editApptId').value = apptId;
            $('apptForClientId').value = appt.ClientID;
            $('apptModalTitle').textContent = 'Edit Fitting';
            
            // Show modal
            $('modal-newAppt').classList.add('active');
            
            // Fill in appointment details
            const apptDate = appt.Date ? (typeof appt.Date === 'number' ? 
                new Date((appt.Date - 25569) * 86400 * 1000).toISOString().split('T')[0] : 
                String(appt.Date).split('T')[0]) : '';
            $('aDate').value = apptDate;
            
            // Parse time
            let timeVal = appt.Time || '';
            if (timeVal.includes('T')) {
                timeVal = timeVal.split('T')[1]?.substring(0, 5) || '';
            }
            $('aTime').value = timeVal;
            
            $('aType').value = appt.Type || 'fitting';
            
            // Show fixed client name
            $('clientSelectGroup').style.display = 'none';
            $('clientFixedGroup').style.display = 'block';
            $('aClientName').value = c ? `${c.FirstName} ${c.LastName}` : '';
            $('aClient').value = appt.ClientID;
            
            // Hide new client fields
            $('newClientFields').style.display = 'none';
            
            // Hide consultation reason, show fitting fields for fitting types
            const isFitting = (appt.Type || '').includes('fitting');
            $('consultationReasonGroup').style.display = isFitting ? 'none' : 'block';
            $('fittingFieldsGroup').style.display = isFitting ? 'block' : 'none';
            
            if (isFitting && c && c.WeddingDate) {
                $('aWeddingDateDisplay').value = fmtDate(c.WeddingDate);
                const weddingDate = parseDate(c.WeddingDate);
                if (weddingDate) {
                    const daysUntil = Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24));
                    $('aDaysUntilWedding').textContent = `${daysUntil} days until wedding`;
                }
                // Load saved dress needed by
                const neededBy = localStorage.getItem(`alts_neededby_${appt.ClientID}`);
                $('aDressNeededBy').value = neededBy || '';
            }
            
            // Clear visit log fields
            ['aLogFeedback','aLogBudget','aLogNextSteps','aLogOther'].forEach(id => {
                if ($(id)) $(id).value = '';
            });
            
            // Load notes into appropriate field
            if (appt.Notes) {
                $('aLogOther').value = appt.Notes;
            }
            
            // Populate consultant dropdown and select current
            $('aConsultant').innerHTML = '<option value="">Select...</option>' + 
                data.consultants.map(con => `<option value="${con.Name}">${con.Name}</option>`).join('');
            $('aConsultant').value = appt.Consultant || '';
        }
        
        function renderAltItems() {
            if (currentAltItems.length === 0) {
                $('altItemsList').innerHTML = '<div class="empty" style="font-size:11px">No alteration items yet. Add items as they\'re identified during fittings.</div>';
                return;
            }
            
            $('altItemsList').innerHTML = currentAltItems.map((item, idx) => {
                const statusColor = item.status === 'done' ? '#27ae60' : item.status === 'in-progress' ? '#f39c12' : item.status === 'needs-adjustment' ? '#e67e22' : 'var(--taupe)';
                const statusBg = item.status === 'done' ? '#27ae6020' : item.status === 'in-progress' ? '#f39c1220' : item.status === 'needs-adjustment' ? '#e67e2220' : 'var(--blush)';
                
                return `<div style="display:flex;align-items:flex-start;gap:8px;padding:8px;background:${statusBg};border-radius:4px;margin-bottom:6px;border-left:3px solid ${statusColor}">
                    <select class="form-input" style="width:auto;font-size:10px;padding:3px 6px" onchange="updateAltItemStatus(${idx}, this.value)">
                        <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="in-progress" ${item.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="done" ${item.status === 'done' ? 'selected' : ''}>Done</option>
                        <option value="needs-adjustment" ${item.status === 'needs-adjustment' ? 'selected' : ''}>Needs Adjustment</option>
                    </select>
                    <div style="flex:1">
                        <div style="font-size:12px;font-weight:500">${item.name}</div>
                        ${item.details ? `<div style="font-size:10px;color:var(--taupe)">${item.details}</div>` : ''}
                        <div style="font-size:9px;color:var(--taupe)">Added: Fitting ${item.addedAtFitting || 1}</div>
                    </div>
                    <button class="action-btn" onclick="editAltItem(${idx})" title="Edit">‚úèÔ∏è</button>
                    <button class="action-btn" style="color:#e74c3c" onclick="removeAltItem(${idx})" title="Delete">√ó</button>
                </div>`;
            }).join('');
        }
        
        async function editAltItem(idx) {
            const item = currentAltItems[idx];
            if (!item) return;
            
            const newName = await appPrompt('Item name:', item.name, 'Edit Alteration Item');
            if (newName === null) return; // Cancelled
            
            if (newName.trim()) {
                item.name = newName.trim();
            }
            
            const newDetails = await appPrompt('Details (optional):', item.details || '', 'Edit Alteration Item');
            if (newDetails !== null) {
                item.details = newDetails.trim();
            }
            
            saveAltItemsLocal();
            renderAltItems();
        }
        
        function addAlterationItem() {
            $('addAltItemForm').style.display = 'block';
            $('newAltItemDetails').value = '';
            $('customAltItem').value = '';
            if ($('saveCustomAltItem')) $('saveCustomAltItem').checked = false;
            
            // Populate dropdown with saved items
            populateAltItemDropdown();
            $('newAltItemType').value = 'hem';
            toggleCustomAltItem();
        }
        
        function populateAltItemDropdown() {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            const dropdown = $('newAltItemType');
            
            if (!dropdown) {
                console.log('Alteration dropdown not found');
                return;
            }
            
            console.log('populateAltItemDropdown called, savedItems:', savedItems.length);
            
            // Rebuild dropdown
            let html = `
                <option value="hem">Hem (shorten/lengthen)</option>
                <option value="bustle">Bustle</option>
                <option value="take-in">Take In</option>
                <option value="let-out">Let Out</option>
                <option value="straps">Straps Adjustment</option>
                <option value="cups">Add Bra Cups</option>
                <option value="buttons">Buttons/Hooks</option>
                <option value="steaming">Steaming</option>
                <option value="cleaning">Cleaning</option>
            `;
            
            if (savedItems.length > 0) {
                html += `<option value="---" disabled>‚îÄ‚îÄ Saved Items ‚îÄ‚îÄ</option>`;
                savedItems.forEach(item => {
                    html += `<option value="saved:${item}">${item}</option>`;
                });
            }
            
            html += `<option value="custom">+ Custom...</option>`;
            dropdown.innerHTML = html;
        }
        
        function manageSavedAltItems() {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            
            if (savedItems.length === 0) {
                toast('No saved items yet. Add a custom item and check "Save for future use"', 'info');
                return;
            }
            
            let html = '<div style="font-size:12px;margin-bottom:12px">Click √ó to remove saved items:</div>';
            savedItems.forEach((item, idx) => {
                html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--cream);border-radius:4px;margin-bottom:4px">
                    <span>${item}</span>
                    <button class="action-btn" style="color:#e74c3c" onclick="deleteSavedAltItem(${idx})">√ó</button>
                </div>`;
            });
            
            // Show in a simple alert-style popup
            const popup = document.createElement('div');
            popup.id = 'savedItemsPopup';
            popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:10001;max-width:300px;width:90%';
            popup.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h3 style="font-size:14px;font-weight:600">Saved Alteration Items</h3>
                    <button onclick="document.getElementById('savedItemsPopup').remove()" style="background:none;border:none;font-size:18px;cursor:pointer">√ó</button>
                </div>
                ${html}
            `;
            document.body.appendChild(popup);
        }
        
        function deleteSavedAltItem(idx) {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            const removed = savedItems.splice(idx, 1);
            localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
            toast(`Removed "${removed}"`, 'success');
            
            // Refresh the popup
            document.getElementById('savedItemsPopup')?.remove();
            if (savedItems.length > 0) {
                manageSavedAltItems();
            }
            
            // Refresh dropdown if form is open
            if ($('addAltItemForm').style.display !== 'none') {
                populateAltItemDropdown();
            }
        }
        
        function cancelAddAltItem() {
            $('addAltItemForm').style.display = 'none';
        }
        
        function toggleCustomAltItem() {
            const val = $('newAltItemType').value;
            $('customAltItemGroup').style.display = val === 'custom' ? 'block' : 'none';
        }
        
        function saveNewAltItem() {
            const type = $('newAltItemType').value;
            let name;
            
            if (type === 'custom') {
                name = $('customAltItem').value.trim();
                if (!name) {
                    toast('Enter item name', 'error');
                    return;
                }
                // Save for future if checkbox checked
                if ($('saveCustomAltItem')?.checked) {
                    const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
                    if (!savedItems.includes(name)) {
                        savedItems.push(name);
                        localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
                        toast('Item saved for future use!', 'success');
                    }
                }
            } else if (type.startsWith('saved:')) {
                name = type.replace('saved:', '');
            } else {
                name = type.charAt(0).toUpperCase() + type.slice(1).replace('-', ' ');
            }
            
            const details = $('newAltItemDetails').value;
            
            // Calculate which fitting we're at
            const fittings = data.appointments.filter(a => 
                a.ClientID == currentAltClientId && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            );
            const pastFittings = fittings.filter(f => parseDate(f.Date) < new Date());
            
            currentAltItems.push({
                id: 'alt_' + Date.now(),
                name,
                details,
                status: 'pending',
                addedAtFitting: pastFittings.length || 1
            });
            
            renderAltItems();
            cancelAddAltItem();
        }
        
        function updateAltItemStatus(idx, status) {
            if (currentAltItems[idx]) {
                currentAltItems[idx].status = status;
                renderAltItems();
            }
        }
        
        async function removeAltItem(idx) {
            const confirmed = await appConfirmDanger('Remove this alteration item?', 'Remove Item');
            if (confirmed) {
                currentAltItems.splice(idx, 1);
                renderAltItems();
            }
        }
        
        async function saveAlterations() {
            if (!currentAltClientId) return;
            
            const itemsJson = JSON.stringify(currentAltItems);
            const notes = $('altNotes').value;
            const neededBy = $('altDressNeededBy').value;
            
            // ALWAYS save to localStorage FIRST (this is the safe, working storage)
            localStorage.setItem(`alts_${currentAltClientId}`, itemsJson);
            localStorage.setItem(`alts_notes_${currentAltClientId}`, notes);
            if (neededBy) localStorage.setItem(`alts_neededby_${currentAltClientId}`, neededBy);
            
            console.log(`[ALTS] Saved to localStorage for client ${currentAltClientId}:`, {
                items: currentAltItems.length,
                notes: notes.length + ' chars',
                neededBy: neededBy
            });
            
            // THEN try to sync to Google Sheets as backup (non-blocking, won't lose data if fails)
            try {
                console.log('[ALTS] Looking for alteration record. ClientID:', currentAltClientId);
                console.log('[ALTS] data.alterations count:', data.alterations?.length || 0);
                console.log('[ALTS] All alterations:', data.alterations?.map(a => ({ ID: a.ID, ClientID: a.ClientID, Status: a.Status })));
                
                const altRecord = data.alterations?.find(a => String(a.ClientID) === String(currentAltClientId) && a.Status !== 'complete');
                console.log('[ALTS] Found record:', altRecord ? { ID: altRecord.ID, ClientID: altRecord.ClientID } : 'NONE');
                
                if (altRecord && altRecord.ID) {
                    // Update existing record - preserve existing DueDate if not changed
                    const updates = {
                        AlterationItems: itemsJson,
                        Notes: notes
                    };
                    if (neededBy) updates.DueDate = neededBy;
                    
                    console.log('[ALTS] Updating record ID:', altRecord.ID, 'with:', Object.keys(updates));
                    updateRecord('Alterations', altRecord.ID, updates).catch(e => {
                        console.warn('[ALTS] Google Sheets sync failed (data safe in localStorage):', e);
                    });
                    
                    // Update local cache
                    altRecord.AlterationItems = itemsJson;
                    altRecord.Notes = notes;
                    if (neededBy) altRecord.DueDate = neededBy;
                    console.log('[ALTS] Updated local cache');
                } else {
                    // Create new alteration record in background
                    const client = getClient(currentAltClientId);
                    const order = data.orders.find(o => String(o.ClientID) === String(currentAltClientId) && o.Status !== 'picked up');
                    const newAlt = {
                        ClientID: currentAltClientId,
                        ClientName: client ? `${client.FirstName} ${client.LastName}` : '',
                        OrderID: order ? order.ID : '',
                        Items: order ? (order.Dress || 'Dress') : 'Dress',
                        AlterationItems: itemsJson,
                        Notes: notes,
                        Status: 'in progress',
                        StartDate: today(),
                        DueDate: neededBy || (client ? client.WeddingDate : '') || '',
                        Seamstress: ''
                    };
                    
                    api('POST', { action: 'add', sheet: 'Alterations', record: newAlt })
                        .then(result => {
                            newAlt.ID = result?.id || 'alt_' + Date.now();
                            data.alterations.push(newAlt);
                            saveCachedData();
                            console.log('[ALTS] Created new record in Google Sheets:', newAlt.ID);
                        })
                        .catch(e => {
                            console.warn('[ALTS] Failed to create Google Sheets record (data safe in localStorage):', e);
                        });
                }
            } catch (e) {
                console.warn('[ALTS] Google Sheets sync error (data safe in localStorage):', e);
            }
            
            saveCachedData();
            
            // Update order status to 'in alterations' if needed
            const order = data.orders.find(o => o.ClientID == currentAltClientId && o.Status === 'QA complete');
            if (order) {
                updateRecord('Orders', order.ID, { Status: 'in alterations' });
            }
            
            toast('Alterations saved!', 'success');
            closeModal('alteration');
            renderAlts();
        }
        
        async function saveAndMarkReady() {
            if (!currentAltClientId) return;
            
            const itemsJson = JSON.stringify(currentAltItems);
            const notes = $('altNotes').value;
            const neededBy = $('altDressNeededBy').value;
            
            // ALWAYS save to localStorage FIRST
            localStorage.setItem(`alts_${currentAltClientId}`, itemsJson);
            localStorage.setItem(`alts_notes_${currentAltClientId}`, notes);
            if (neededBy) localStorage.setItem(`alts_neededby_${currentAltClientId}`, neededBy);
            
            console.log(`[ALTS] Saved to localStorage before marking ready for client ${currentAltClientId}`);
            
            // Try to sync to Google Sheets (non-blocking)
            try {
                const altRecord = data.alterations?.find(a => String(a.ClientID) === String(currentAltClientId) && a.Status !== 'complete');
                if (altRecord && altRecord.ID) {
                    const updates = { AlterationItems: itemsJson, Notes: notes };
                    if (neededBy) updates.DueDate = neededBy;
                    await updateRecord('Alterations', altRecord.ID, updates);
                }
            } catch (e) {
                console.warn('[ALTS] Google Sheets sync failed (data safe in localStorage):', e);
            }
            
            // Then mark ready
            await markAlterationComplete(currentAltClientId);
            closeModal('alteration');
        }
        
        async function markAlterationComplete(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            const clientName = `${c.FirstName} ${c.LastName}`;
            
            // Find order and save previous status for undo
            const order = data.orders.find(o => String(o.ClientID) === String(clientId) && 
                (o.Status === 'in alterations' || o.Status === 'QA complete' || o.Status === 'arrived - pending QA'));
            
            const previousOrderStatus = order ? order.Status : null;
            
            // Find alteration record
            const altRecord = data.alterations?.find(a => String(a.ClientID) === String(clientId));
            const previousAltStatus = altRecord ? altRecord.Status : null;
            
            // Update order status to "picked up"
            if (order) {
                order.Status = 'picked up';
                updateRecord('Orders', order.ID, { Status: 'picked up' });
            }
            
            // Update alteration record if exists
            if (altRecord) {
                altRecord.Status = 'complete';
                updateRecord('Alterations', altRecord.ID, { Status: 'complete' });
            }
            
            saveCachedData();
            renderAlts();
            renderOrders();
            
            // Add to undo stack
            addUndo({ 
                type: 'picked_up', 
                clientId,
                clientName,
                orderId: order?.ID,
                previousOrderStatus,
                altRecordId: altRecord?.ID,
                previousAltStatus
            });
            
            toast(`${clientName} marked as picked up! üéâ`, 'success', true);
            
            // Offer to send email after a short delay
            setTimeout(() => {
                if (c.Email && confirm(`Send pickup confirmation email to ${c.Email}?`)) {
                    sendPickupEmail(clientId);
                }
            }, 500);
        }
        
        function sendPickupEmail(clientId) {
            const c = getClient(clientId);
            if (!c || !c.Email) return;
            
            const storeName = store.name || 'Estrelle Bridal';
            const subject = `Your dress is ready for pickup! üë∞`;
            const body = `Hi ${c.FirstName},

Great news! Your dress alterations are complete and your gown is ready for pickup.

Please contact us to schedule a convenient time to pick up your dress.

We can't wait to see you!

${storeName}
${store.phone || ''}`;
            
            // Open Gmail
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(c.Email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
        }
        
        function sendFittingSummary() {
            const c = getClient(currentAltClientId);
            if (!c || !c.Email) {
                toast('No email address for this client', 'error');
                return;
            }
            
            // Count fittings to determine which fitting this is
            const fittings = data.appointments.filter(a => 
                a.ClientID == currentAltClientId && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            );
            const pastFittings = fittings.filter(f => parseDate(f.Date) <= new Date());
            const fittingNum = pastFittings.length || 1;
            const nextFitting = getNextFittingForClient(currentAltClientId);
            
            // Build summary
            const doneItems = currentAltItems.filter(i => i.status === 'done').map(i => `  ‚úì ${i.name}${i.details ? ' ‚Äì ' + i.details : ''}`).join('\n');
            const inProgressItems = currentAltItems.filter(i => i.status === 'in-progress').map(i => `  ‚Üí ${i.name}${i.details ? ' ‚Äì ' + i.details : ''} (in progress)`).join('\n');
            const pendingItems = currentAltItems.filter(i => i.status === 'pending' || i.status === 'needs-adjustment').map(i => `  ‚óã ${i.name}${i.details ? ' ‚Äì ' + i.details : ''}${i.status === 'needs-adjustment' ? ' (needs adjustment)' : ''}`).join('\n');
            const notes = $('altNotes').value;
            
            // Get wedding date info
            const weddingDate = c.WeddingDate ? fmtDate(c.WeddingDate) : null;
            
            const subject = `Your Fitting Summary ‚Äì Estrelle Bridal`;
            let body = `Dear ${c.FirstName},

Thank you for visiting us today for your ${fittingNum === 1 ? 'first ' : ''}fitting appointment. It was wonderful to see you and we're excited to be part of your wedding journey!

FITTING ${fittingNum} SUMMARY
${'‚îÄ'.repeat(30)}
`;
            if (doneItems) body += `\nCompleted:\n${doneItems}\n`;
            if (inProgressItems) body += `\nIn Progress:\n${inProgressItems}\n`;
            if (pendingItems) body += `\nRemaining:\n${pendingItems}\n`;
            if (notes) body += `\nSeamstress Notes:\n${notes}\n`;
            
            body += `\n${'‚îÄ'.repeat(30)}`;
            
            if (nextFitting) {
                body += `\n\nYour next fitting is scheduled for ${fmtDate(nextFitting.Date)} at ${fmtTime12(nextFitting.Time)}. We look forward to seeing you then!`;
            } else {
                body += `\n\nYour next fitting: TBD. Please contact us to schedule your next appointment.`;
            }
            
            if (weddingDate) {
                body += `\n\nWedding Date: ${weddingDate}`;
            }
            
            body += `

If you have any questions or need to reschedule, please don't hesitate to contact us.

Warm regards,

Estrelle Bridal
55 Avenue Road, Suite 201.5
Toronto, Ontario
(647) 333-6582
www.estrellebridal.com`;
            
            // Use Gmail compose URL (works better than mailto)
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(c.Email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
        }
        
        function copySeamstressText() {
            const c = getClient(currentAltClientId);
            if (!c) return;
            
            // Get wedding date and calculate urgency
            const weddingDate = c.WeddingDate ? parseDate(c.WeddingDate) : null;
            const daysUntil = weddingDate ? Math.ceil((weddingDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            // Get next fitting using helper (picks up just-scheduled fittings too)
            const nextFitting = getNextFittingForClient(currentAltClientId);
            
            // Get dress needed by - calculate 2 weeks before wedding if not set
            let dressNeededBy = localStorage.getItem(`alts_neededby_${currentAltClientId}`);
            if (!dressNeededBy && weddingDate) {
                const neededByDate = new Date(weddingDate.getTime() - 14 * 24 * 60 * 60 * 1000);
                dressNeededBy = fmtDate(neededByDate);
            }
            
            // Build clean text summary
            let text = `${c.FirstName} ${c.LastName}\n`;
            text += `${'‚Äî'.repeat(10)}\n`;
            
            // Dress needed by
            if (dressNeededBy) {
                const neededByDate = parseDate(dressNeededBy);
                const daysUntilNeeded = neededByDate ? Math.ceil((neededByDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
                text += `NEED BY: ${dressNeededBy}`;
                if (daysUntilNeeded !== null) {
                    if (daysUntilNeeded <= 7) text += ` ** ${daysUntilNeeded} days! **`;
                    else text += ` (${daysUntilNeeded} days)`;
                }
                text += `\n`;
            }
            
            if (weddingDate) {
                text += `Wedding: ${fmtDate(c.WeddingDate)}`;
                if (daysUntil <= 30) text += ` ** URGENT **`;
                text += ` (${daysUntil} days)\n`;
            }
            if (nextFitting) {
                text += `Next fitting: ${fmtDate(nextFitting.Date)} at ${fmtTime12(nextFitting.Time)}\n`;
            } else {
                text += `Next fitting: TBD\n`;
            }
            text += `\n`;
            
            // Items to do
            const pending = currentAltItems.filter(i => i.status === 'pending');
            const inProgress = currentAltItems.filter(i => i.status === 'in-progress');
            const needsAdj = currentAltItems.filter(i => i.status === 'needs-adjustment');
            const done = currentAltItems.filter(i => i.status === 'done');
            
            if (needsAdj.length > 0) {
                text += `NEEDS ADJUSTMENT:\n`;
                needsAdj.forEach(i => text += `  - ${i.name}${i.details ? ' ‚Äî ' + i.details : ''}\n`);
                text += `\n`;
            }
            
            if (inProgress.length > 0) {
                text += `IN PROGRESS:\n`;
                inProgress.forEach(i => text += `  - ${i.name}${i.details ? ' ‚Äî ' + i.details : ''}\n`);
                text += `\n`;
            }
            
            if (pending.length > 0) {
                text += `TO DO:\n`;
                pending.forEach(i => text += `  - ${i.name}${i.details ? ' ‚Äî ' + i.details : ''}\n`);
                text += `\n`;
            }
            
            if (done.length > 0) {
                text += `DONE:\n`;
                done.forEach(i => text += `  - ${i.name}\n`);
                text += `\n`;
            }
            
            // Notes
            const notes = $('altNotes').value;
            if (notes) {
                text += `Notes: ${notes}\n`;
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                toast('Copied for seamstress!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                toast('Copied for seamstress!', 'success');
            });
        }

        // ========== NEXT FITTING (from alteration modal) ==========
        let altPendingNextFitting = null; // Stores scheduled but not yet saved fitting
        
        // Convert 24hr time to 12hr (e.g. "18:00" -> "6:00 PM")
        function fmtTime12(t) {
            const raw = fmtTime(t);
            if (!raw || !raw.includes(':')) return raw;
            const [h, m] = raw.split(':');
            const hr = parseInt(h);
            return `${hr % 12 || 12}:${m} ${hr >= 12 ? 'PM' : 'AM'}`;
        }
        
        function renderAltNextFitting() {
            const c = getClient(currentAltClientId);
            if (!c) return;
            
            // Use tomorrow to exclude today's appointments (which may have already happened)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            // Check for existing upcoming fitting
            const nextFitting = data.appointments.find(a => 
                String(a.ClientID) === String(currentAltClientId) && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting') &&
                parseDate(a.Date) >= tomorrow
            );
            
            const scheduleBtn = `<div style="margin-top:8px;text-align:center">
                <button class="btn btn-sm btn-secondary" onclick="showAltNextFittingForm()" style="font-size:11px;width:100%">+ Add Appointment</button>
            </div>`;
            
            if (altPendingNextFitting) {
                const fitDate = fmtDate(altPendingNextFitting.Date);
                const fitTime = fmtTime12(altPendingNextFitting.Time);
                $('altNextFittingDisplay').style.display = '';
                $('altNextFittingDisplay').innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:white;border-radius:4px;border-left:3px solid #27ae60">
                        <div>
                            <div style="font-size:13px;font-weight:600">${fitDate} at ${fitTime}</div>
                            <div style="font-size:10px;color:var(--taupe)">${altPendingNextFitting.Type}${altPendingNextFitting.Consultant ? ' ¬∑ ' + altPendingNextFitting.Consultant : ''}</div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="removeAltNextFitting()" style="color:#e74c3c;font-size:11px">Remove</button>
                    </div>
                    ${scheduleBtn}`;
                $('altNextFittingStatus').textContent = '‚úì Scheduled';
                $('altNextFittingStatus').style.color = '#27ae60';
                $('altNextFittingForm').style.display = 'none';
            } else if (nextFitting) {
                const fitDate = fmtDate(nextFitting.Date);
                const fitTime = fmtTime12(nextFitting.Time);
                $('altNextFittingDisplay').style.display = '';
                $('altNextFittingDisplay').innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:white;border-radius:4px;border-left:3px solid var(--sage)">
                        <div>
                            <div style="font-size:13px;font-weight:600">${fitDate} at ${fitTime}</div>
                            <div style="font-size:10px;color:var(--taupe)">${nextFitting.Type}${nextFitting.Consultant ? ' ¬∑ ' + nextFitting.Consultant : ''}</div>
                        </div>
                    </div>
                    ${scheduleBtn}`;
                $('altNextFittingStatus').textContent = '‚úì Booked';
                $('altNextFittingStatus').style.color = '#27ae60';
                $('altNextFittingForm').style.display = 'none';
            } else {
                $('altNextFittingDisplay').style.display = '';
                $('altNextFittingDisplay').innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:white;border-radius:4px;border-left:3px solid #e74c3c">
                        <div style="font-size:13px;color:var(--taupe)">TBD ‚Äî No fitting scheduled</div>
                        <button class="btn btn-sm btn-primary" onclick="showAltNextFittingForm()" style="font-size:11px">+ Add Appointment</button>
                    </div>`;
                $('altNextFittingStatus').textContent = 'TBD';
                $('altNextFittingStatus').style.color = '#e74c3c';
                $('altNextFittingForm').style.display = 'none';
            }
        }
        
        function showAltNextFittingForm() {
            $('altNextFittingDisplay').style.display = 'none';
            $('altNextFittingForm').style.display = 'block';
            
            // Default to 2 weeks from now
            const twoWeeks = new Date();
            twoWeeks.setDate(twoWeeks.getDate() + 14);
            $('altNextFitDate').value = twoWeeks.toISOString().split('T')[0];
            $('altNextFitTime').value = '11:00';
            $('altNextFitType').value = 'fitting';
            
            // Populate consultants
            const consultants = data.consultants || [];
            $('altNextFitConsultant').innerHTML = '<option value="">‚Äî</option>' + 
                consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
        }
        
        function cancelAltNextFitting() {
            $('altNextFittingDisplay').style.display = '';
            $('altNextFittingForm').style.display = 'none';
        }
        
        async function confirmAltNextFitting() {
            const date = $('altNextFitDate').value;
            const time = $('altNextFitTime').value;
            if (!date) { toast('Please select a date', 'error'); return; }
            
            const c = getClient(currentAltClientId);
            if (!c) return;
            
            const clientName = `${c.FirstName} ${c.LastName}`;
            const type = $('altNextFitType').value;
            const consultant = $('altNextFitConsultant').value;
            
            const newAppt = {
                ClientID: currentAltClientId,
                ClientName: clientName,
                Date: date,
                Time: time || '11:00',
                Type: type,
                Consultant: consultant,
                Status: 'scheduled',
                Source: 'estrelle'  // Mark as internally created ‚Äî protected from Timely auto-delete
            };
            
            // saveRecord adds to data.appointments and syncs to server
            saveRecord('Appointments', newAppt);
            
            altPendingNextFitting = newAppt;
            
            // Re-render next fitting section
            renderAltNextFitting();
            
            // Refresh the fitting list at top of modal
            const fittings = data.appointments.filter(a => 
                String(a.ClientID) === String(currentAltClientId) && 
                (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting')
            ).sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
            renderAltFittingsList(fittings);
            
            toast(`Fitting scheduled: ${fmtDate(date)} at ${fmtTime(time)}`, 'success');
        }
        
        function removeAltNextFitting() {
            if (!altPendingNextFitting) return;
            if (!confirm('Remove this scheduled fitting?')) return;
            
            // Remove from data
            const idx = data.appointments.findIndex(a => String(a.ID) === String(altPendingNextFitting.ID));
            if (idx >= 0) {
                const removed = data.appointments.splice(idx, 1)[0];
                addUndo({ type: 'delete_appointment', record: removed });
                api('POST', { action: 'delete', sheet: 'Appointments', id: altPendingNextFitting.ID }).catch(() => {});
            }
            
            altPendingNextFitting = null;
            saveCachedData();
            renderAltNextFitting();
            toast('Fitting removed', 'success', true);
        }
        
        function renderAltFittingsList(fittings) {
            if (!fittings || fittings.length === 0) {
                $('altFittingsList').innerHTML = '<div class="empty" style="font-size:11px">No fittings scheduled yet</div>';
                return;
            }
            $('altFittingsList').innerHTML = fittings.map((f, idx) => {
                const d = parseDate(f.Date);
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const isPast = d && d < todayStart;
                const isToday = d && d.toDateString() === new Date().toDateString();
                // Convert to 12hr
                const raw = fmtTime(f.Time);
                let timeStr = raw;
                if (raw && raw.includes(':')) {
                    const [h, m] = raw.split(':');
                    const hr = parseInt(h);
                    timeStr = `${hr % 12 || 12}:${m} ${hr >= 12 ? 'PM' : 'AM'}`;
                }
                const bgColor = isToday ? '#e8f5e9' : (isPast ? 'var(--cream)' : 'var(--blush)');
                const circleColor = isToday ? '#27ae60' : (isPast ? 'var(--champagne)' : 'var(--dusty)');
                return `<div style="display:flex;align-items:center;gap:8px;padding:8px;${isPast ? 'opacity:0.7' : ''};background:${bgColor};border-radius:4px;margin-bottom:4px;cursor:pointer;transition:all 0.2s" onclick="editFittingFromAlt(${f.ID})" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='none'">
                    <div style="width:24px;height:24px;background:${circleColor};color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600">${idx + 1}</div>
                    <div style="flex:1">
                        <div style="font-size:11px;font-weight:500">${f.Type} - ${fmtDate(f.Date)}${isToday ? ' (TODAY)' : ''} @ ${timeStr}</div>
                        ${f.Consultant ? `<div style="font-size:9px;color:var(--taupe)">with ${f.Consultant}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }
        
        // Get next fitting for seamstress/email (checks both existing and pending)
        function getNextFittingForClient(clientId) {
            // Get tomorrow's date to exclude today's appointments (which may have already happened)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const upcoming = data.appointments
                .filter(a => 
                    String(a.ClientID) === String(clientId) && 
                    (a.Type === 'first fitting' || a.Type === 'fitting' || a.Type === 'final fitting') &&
                    parseDate(a.Date) >= tomorrow
                )
                .sort((a, b) => parseDate(a.Date) - parseDate(b.Date));
            
            return upcoming[0] || null;
        }

        // ========== DESIGNERS ==========
        function renderDesigners() {
            // Ensure designer data is loaded
            if (!designerData || designerData.length === 0) {
                loadDesignerData();
            }
            
            const tableEl = $('settingsDesignersTable');
            if (!tableEl) return;
            
            tableEl.innerHTML = designerData.map((d, idx) => {
                // Format rush tiers
                let tiersHtml = '';
                if (d.rushTiers && d.rushTiers.length > 0) {
                    tiersHtml = d.rushTiers.map(t => {
                        const note = t.note ? `<br><span style="font-size:9px;color:var(--rose)">${t.note}</span>` : '';
                        return `<div style="margin-bottom:4px"><b>${t.months} months:</b> ${t.fee}${note}</div>`;
                    }).join('');
                } else {
                    tiersHtml = '<span style="color:var(--taupe)">No rush tiers</span>';
                }
                
                // Format below minimum
                let belowHtml = '‚Äî';
                if (d.belowMin && (d.belowMin.fee || d.belowMin.note)) {
                    belowHtml = `<span style="color:var(--rose)">`;
                    if (d.belowMin.fee) belowHtml += `${d.belowMin.fee}<br>`;
                    if (d.belowMin.note) belowHtml += `<span style="font-size:9px">${d.belowMin.note}</span>`;
                    belowHtml += '</span>';
                }
                
                return `<tr>
                    <td style="font-weight:500">${d.name}</td>
                    <td><span style="font-size:18px;font-weight:600">${d.standard}</span> months<br><span style="font-size:9px;color:var(--sage)">No rush fee</span></td>
                    <td style="font-size:11px">${tiersHtml}</td>
                    <td style="font-size:11px">${belowHtml}</td>
                    <td><button class="action-btn" onclick="editDesignerByIdx(${idx})">Edit</button></td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" class="empty">No designers</td></tr>';
            
            // Update count
            const countEl = $('designerCount');
            if (countEl) countEl.textContent = `(${designerData.length})`;
        }
        
        // Alias for backward compatibility
        function openEditDesignerModal(idx) { editDesignerByIdx(idx); }
        async function deleteDesignerFromList(idx) {
            const confirmed = await appConfirmDanger('Delete this designer?', 'Delete Designer');
            if (!confirmed) return;
            designerData.splice(idx, 1);
            saveDesignerData();
            renderDesigners();
            toast('Designer deleted', 'success');
        }
        
        let editingDesignerTiers = [];
        
        function openAddDesignerModal() {
            $('designerModalTitle').textContent = 'Add Designer';
            $('edDesignerIdx').value = '-1';
            $('edDesignerName').value = '';
            $('edDesignerStandard').value = '4';
            $('edDesignerMinMonths').value = '';
            $('edDesignerBelowFee').value = '';
            $('edDesignerBelowNote').value = 'Inquiry required';
            editingDesignerTiers = [];
            renderDesignerTiers();
            openModal('editDesigner');
        }
        
        function editDesignerByIdx(idx) {
            const d = designerData[idx];
            if (!d) return;
            
            $('designerModalTitle').textContent = 'Edit Designer';
            $('edDesignerIdx').value = idx;
            $('edDesignerName').value = d.name || '';
            $('edDesignerStandard').value = d.standard || 4;
            $('edDesignerMinMonths').value = d.minMonths || '';
            $('edDesignerBelowFee').value = d.belowMin?.fee || '';
            $('edDesignerBelowNote').value = d.belowMin?.note || '';
            editingDesignerTiers = d.rushTiers ? [...d.rushTiers] : [];
            renderDesignerTiers();
            openModal('editDesigner');
        }
        
        function renderDesignerTiers() {
            $('edDesignerTiers').innerHTML = editingDesignerTiers.length ? editingDesignerTiers.map((t, i) => `
                <div class="form-row" style="margin-bottom:6px;align-items:center">
                    <div class="form-group" style="margin-bottom:0;flex:1">
                        <input type="number" class="form-input" value="${t.months||''}" onchange="editingDesignerTiers[${i}].months=+this.value" placeholder="Months" min="1" max="12">
                    </div>
                    <div class="form-group" style="margin-bottom:0;flex:2">
                        <input type="text" class="form-input" value="${t.fee||''}" onchange="editingDesignerTiers[${i}].fee=this.value" placeholder="Fee (e.g. 10% rush)">
                    </div>
                    <button class="action-btn" onclick="editingDesignerTiers.splice(${i},1);renderDesignerTiers()" style="padding:8px">√ó</button>
                </div>
            `).join('') : '<div class="empty" style="padding:8px;font-size:11px">No rush tiers - click + Add to create</div>';
        }
        
        function addDesignerTier() {
            editingDesignerTiers.push({ months: '', fee: '' });
            renderDesignerTiers();
        }
        
        function saveDesigner() {
            const idx = parseInt($('edDesignerIdx').value);
            const name = $('edDesignerName').value.trim();
            if (!name) { toast('Enter designer name'); return; }
            
            // Check for duplicate names (case-insensitive), skip if editing same entry
            const dupeIdx = designerData.findIndex((d, i) => i !== idx && d.name.trim().toLowerCase() === name.toLowerCase());
            if (dupeIdx !== -1) {
                toast(`"${designerData[dupeIdx].name}" already exists ‚Äî updating existing entry instead`, 'success');
                // Merge into existing entry instead of creating duplicate
                const designer = {
                    ...designerData[dupeIdx],
                    name: name,
                    standard: parseInt($('edDesignerStandard').value) || 4,
                    rushTiers: editingDesignerTiers.filter(t => t.months && t.fee).sort((a,b) => b.months - a.months),
                    minMonths: parseInt($('edDesignerMinMonths').value) || null,
                    belowMin: {
                        fee: $('edDesignerBelowFee').value.trim() || null,
                        note: $('edDesignerBelowNote').value.trim() || null
                    }
                };
                if (!designer.minMonths) {
                    designer.minMonths = designer.rushTiers.length > 0 
                        ? designer.rushTiers[designer.rushTiers.length - 1].months 
                        : designer.standard;
                }
                designerData[dupeIdx] = designer;
                // If we were adding new (idx === -1), don't also add ‚Äî just updated the dupe
                saveDesignerData();
                closeModal('editDesigner');
                renderDesigners();
                return;
            }
            
            const designer = {
                name: name,
                standard: parseInt($('edDesignerStandard').value) || 4,
                rushTiers: editingDesignerTiers.filter(t => t.months && t.fee).sort((a,b) => b.months - a.months),
                minMonths: parseInt($('edDesignerMinMonths').value) || null,
                belowMin: {
                    fee: $('edDesignerBelowFee').value.trim() || null,
                    note: $('edDesignerBelowNote').value.trim() || null
                }
            };
            
            // Set minMonths to lowest tier or standard if not set
            if (!designer.minMonths) {
                if (designer.rushTiers.length > 0) {
                    designer.minMonths = designer.rushTiers[designer.rushTiers.length - 1].months;
                } else {
                    designer.minMonths = designer.standard;
                }
            }
            
            if (idx === -1) {
                designerData.push(designer);
            } else {
                designerData[idx] = designer;
            }
            
            saveDesignerData();
            closeModal('editDesigner');
            renderDesigners();
            toast('Designer saved!', 'success');
        }
        
        function deleteDesigner() {
            const idx = parseInt($('edDesignerIdx').value);
            if (idx === -1) {
                closeModal('editDesigner');
                return;
            }
            
            const name = designerData[idx]?.name || 'this designer';
            if (!confirm(`Delete "${name}"?`)) return;
            
            designerData.splice(idx, 1);
            saveDesignerData();
            closeModal('editDesigner');
            renderDesigners();
            toast('Designer deleted', 'success');
        }

        // ========== EMAIL TEMPLATES ==========
        function renderEmailTemplates() {
            const templates = data.emailtemplates || [];
            const container = $('emailTemplatesList');
            if (!container) return;
            
            container.innerHTML = templates.length ? templates.map(t => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--bg);border-radius:10px;margin-bottom:8px">
                    <div style="flex:1;min-width:0">
                        <div style="font-weight:600">${t.Name || 'Untitled'}</div>
                        <div style="font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Subject: ${t.Subject || '(no subject)'}</div>
                    </div>
                    <div style="display:flex;gap:4px">
                        <button class="btn btn-secondary btn-sm" onclick="editEmailTemplate('${t.ID}')">Edit</button>
                        <button class="btn btn-sm" onclick="deleteEmailTemplate('${t.ID}')" style="background:var(--red);color:white">Delete</button>
                    </div>
                </div>
            `).join('') : '<p style="color:var(--text-secondary);font-size:13px">No templates yet. Click "Add Template" to create one.</p>';
        }
        
        
        function editEmailTemplate(id) {
            const template = (data.emailtemplates || []).find(t => String(t.ID) === String(id));
            if (!template) { toast('Template not found', 'error'); return; }
            
            $('emailTemplateModalTitle').textContent = 'Edit Email Template';
            $('editTemplateId').value = id;
            $('tplName').value = template.Name || '';
            $('tplSubject').value = template.Subject || '';
            $('tplBody').value = template.Body || '';
            if ($('tplStarters')) $('tplStarters').style.display = 'none'; // Hide starters when editing
            updateTplPreview();
            openModal('emailTemplate');
        }
        
        async function saveEmailTemplate() {
            const name = $('tplName').value.trim();
            const subject = $('tplSubject').value.trim();
            const body = $('tplBody').value.trim();
            
            if (!name || !subject || !body) {
                toast('Please fill in all fields', 'error');
                return;
            }
            
            const id = $('editTemplateId').value;
            const record = { Name: name, Subject: subject, Body: body };
            
            if (id) {
                // Update existing
                updateRecord('EmailTemplates', id, record);
                const existing = (data.emailtemplates || []).find(t => String(t.ID) === String(id));
                if (existing) Object.assign(existing, record);
                toast('Template updated!', 'success');
            } else {
                // Create new
                const tempId = Date.now();
                const newTemplate = { ...record, ID: tempId };
                if (!data.emailtemplates) data.emailtemplates = [];
                data.emailtemplates.push(newTemplate);
                
                api('POST', { action: 'add', sheet: 'EmailTemplates', record })
                    .then(res => {
                        if (res && res.id) {
                            const idx = data.emailtemplates.findIndex(t => t.ID === tempId);
                            if (idx >= 0) data.emailtemplates[idx].ID = res.id;
                        }
                    });
                toast('Template created!', 'success');
            }
            
            saveCachedData();
            closeModal('emailTemplate');
            renderEmailTemplates();
            renderSettings();
        }
        
        async function deleteEmailTemplate(id) {
            if (!confirm('Delete this template?')) return;
            
            deleteRecord('EmailTemplates', id);
            data.emailtemplates = (data.emailtemplates || []).filter(t => String(t.ID) !== String(id));
            saveCachedData();
            renderEmailTemplates();
            renderSettings();
            toast('Template deleted', 'success');
        }
        
        function insertPlaceholder(fieldId, placeholder) {
            const field = $(fieldId);
            if (!field) return;
            
            const start = field.selectionStart;
            const end = field.selectionEnd;
            const text = field.value;
            
            field.value = text.substring(0, start) + placeholder + text.substring(end);
            field.selectionStart = field.selectionEnd = start + placeholder.length;
            field.focus();
        }
        
        function copyPlaceholder(placeholder) {
            navigator.clipboard.writeText(placeholder);
            toast('Copied: ' + placeholder, 'success');
        }
        
        // ========== STARTER TEMPLATES & LIVE PREVIEW ==========
        const STARTER_TEMPLATES = {
            followup: {
                name: 'Post-Appointment Follow Up',
                subject: 'Following up on your {StoreName} visit, {FirstName}!',
                body: `Hi {FirstName},

It was so lovely meeting you at your {AppointmentType} on {AppointmentDate}! I wanted to follow up and see how you're feeling about everything.

{topOptions}

If you have any questions or would like to schedule another appointment, please don't hesitate to reach out!

We're here to help you find THE dress.

Warmly,
The {StoreName} Team`
            },
            thankyou: {
                name: 'Thank You',
                subject: 'Thank you for visiting {StoreName}, {FirstName}! üíï',
                body: `Hi {FirstName},

Thank you so much for choosing {StoreName} for your bridal journey! It was such a pleasure working with you.

We hope you had a wonderful experience and we look forward to seeing you again soon.

If you have a moment, we'd love it if you could share your experience with us on Google ‚Äî it means the world to us!

With love,
The {StoreName} Team
{StorePhone}`
            },
            reminder: {
                name: 'Appointment Reminder',
                subject: 'Reminder: Your appointment at {StoreName} tomorrow!',
                body: `Hi {FirstName},

Just a friendly reminder about your upcoming appointment:

üìÖ {AppointmentDate} at {AppointmentTime}
üëó {AppointmentType}
üìç {StoreAddress}

Please arrive 5-10 minutes early. If you need to reschedule, please let us know as soon as possible.

We can't wait to see you!

Warmly,
The {StoreName} Team`
            },
            status: {
                name: 'Order Status Update',
                subject: 'Update on your order, {FirstName}!',
                body: `Hi {FirstName},

We have an exciting update on your order from {StoreName}!

[Add your update here]

If you have any questions at all, please don't hesitate to reach out to us.

With love,
The {StoreName} Team
{StorePhone}`
            },
            blank: {
                name: '',
                subject: '',
                body: ''
            }
        };
        
        function loadStarterTemplate(type) {
            const starter = STARTER_TEMPLATES[type];
            if (!starter) return;
            
            $('tplName').value = starter.name;
            $('tplSubject').value = starter.subject;
            $('tplBody').value = starter.body;
            updateTplPreview();
            
            if (type !== 'blank') toast('Template loaded ‚Äî customize it!', 'success');
        }
        
        function updateTplPreview() {
            const subject = $('tplSubject')?.value || '';
            const body = $('tplBody')?.value || '';
            const preview = $('tplPreview');
            if (!preview) return;
            
            if (!subject && !body) {
                preview.innerHTML = '<span style="color:var(--taupe);font-style:italic">Start typing to see a preview...</span>';
                return;
            }
            
            // Replace placeholders with sample data for preview
            const sampleClient = currentClient || { FirstName: 'Sarah', LastName: 'Chen', WeddingDate: '2026-08-15', Venue: 'Casa Loma', ID: 0 };
            const sampleAppt = { Date: '2026-03-15', Time: '2:00 PM', Type: 'Bridal Consultation', Consultant: 'Yining Jin' };
            
            const previewSubject = replacePlaceholders(subject, sampleClient, sampleAppt);
            const previewBody = replacePlaceholders(body, sampleClient, sampleAppt);
            
            preview.innerHTML = `
                <div style="font-weight:600;margin-bottom:8px;color:var(--text)">Subject: ${previewSubject || '<span style="color:var(--taupe)">(empty)</span>'}</div>
                <div style="border-top:1px solid var(--border);padding-top:8px;white-space:pre-wrap;color:var(--text)">${previewBody || '<span style="color:var(--taupe)">(empty)</span>'}</div>
            `;
        }
        
        function openAddTemplateModal() {
            $('emailTemplateModalTitle').textContent = 'Create Email Template';
            $('editTemplateId').value = '';
            $('tplName').value = '';
            $('tplSubject').value = '';
            $('tplBody').value = '';
            if ($('tplStarters')) $('tplStarters').style.display = 'block';
            updateTplPreview();
            openModal('emailTemplate');
        }
        
        // ========== CLIENT EMAIL ==========
        function openClientEmailModal() {
            if (!currentClient) { toast('No client selected', 'error'); return; }
            if (!currentClient.Email) { 
                toast('This client has no email address. Please add one first.', 'error'); 
                return; 
            }
            
            $('clientEmailTo').textContent = `${currentClient.FirstName} ${currentClient.LastName} <${currentClient.Email}>`;
            $('clientEmailSubject').value = '';
            $('clientEmailBody').value = '';
            $('clientEmailBodyEditor').innerHTML = ''; // Clear the rich text editor
            
            // Populate template dropdown with system + custom templates
            const customTemplates = data.emailtemplates || [];
            $('clientEmailTemplate').innerHTML = `
                <option value="">-- Select a template --</option>
                <optgroup label="System Templates">
                    <option value="sys_confirmation">üìÖ Appointment Confirmation</option>
                    <option value="sys_followup">üìû Follow-up Email</option>
                    <option value="sys_anniversary">üíç Anniversary Email</option>
                </optgroup>
                ${customTemplates.length ? `
                <optgroup label="Custom Templates">
                    ${customTemplates.map(t => `<option value="custom_${t.ID}">${t.Name}</option>`).join('')}
                </optgroup>
                ` : ''}
                <option value="custom">‚úèÔ∏è Write Custom Email</option>
            `;
            
            // Populate appointment dropdown
            const clientAppts = data.appointments
                .filter(a => String(a.ClientID) === String(currentClient.ID))
                .sort((a, b) => (b.Date || '').localeCompare(a.Date || ''));
            
            $('clientEmailAppt').innerHTML = `
                <option value="">-- No appointment selected --</option>
                ${clientAppts.map(a => `<option value="${a.ID}">${fmtDate(a.Date)} at ${fmtTime(a.Time)} - ${normalizeApptType(a.Type)}</option>`).join('')}
            `;
            
            $('clientEmailApptGroup').style.display = 'none';
            $('clientEmailTemplate').value = ''; // Reset template selection
            $('clientEmailAppt').value = ''; // Reset appointment selection
            openModal('clientEmail');
        }
        
        function loadClientEmailTemplate() {
            const templateId = $('clientEmailTemplate').value;
            
            if (templateId === 'custom' || templateId === '') {
                $('clientEmailSubject').value = '';
                $('clientEmailBody').value = '';
                $('clientEmailApptGroup').style.display = 'none';
                return;
            }
            
            let subject = '';
            let body = '';
            
            // Handle system templates
            if (templateId === 'sys_confirmation') {
                subject = 'Your appointment at {StoreName} is confirmed!';
                const tpl = getConfirmTemplate();
                body = (typeof tpl === 'string') ? tpl : (tpl.text || tpl.html || '');
                $('clientEmailApptGroup').style.display = 'block';
            } else if (templateId === 'sys_followup') {
                const template = getFollowupTemplate();
                subject = template.subject;
                body = template.body;
                $('clientEmailApptGroup').style.display = 'block';
            } else if (templateId === 'sys_anniversary') {
                const template = getAnniversaryTemplate();
                subject = template.subject;
                body = template.body;
                $('clientEmailApptGroup').style.display = 'none';
            } else if (templateId.startsWith('custom_')) {
                // Handle custom templates
                const customId = templateId.replace('custom_', '');
                const template = (data.emailtemplates || []).find(t => String(t.ID) === String(customId));
                if (template) {
                    subject = template.Subject;
                    body = template.Body;
                    
                    // Check if template uses appointment placeholders
                    const hasApptPlaceholders = subject.includes('{Appointment') || 
                                                subject.includes('{Consultant}') ||
                                                body.includes('{Appointment') || 
                                                body.includes('{Consultant}');
                    $('clientEmailApptGroup').style.display = hasApptPlaceholders ? 'block' : 'none';
                }
            }
            
            // Auto-select the most recent appointment if available
            const clientAppts = data.appointments
                .filter(a => String(a.ClientID) === String(currentClient.ID))
                .sort((a, b) => (b.Date || '').localeCompare(a.Date || ''));
            
            let selectedAppt = null;
            if (clientAppts.length > 0) {
                // Auto-select the first (most recent) appointment
                $('clientEmailAppt').value = clientAppts[0].ID;
                selectedAppt = clientAppts[0];
            }
            
            // Replace placeholders with client and appointment data
            const finalSubject = replacePlaceholders(subject, currentClient, selectedAppt);
            const finalBody = replacePlaceholders(body, currentClient, selectedAppt);
            
            $('clientEmailSubject').value = finalSubject;
            $('clientEmailBody').value = finalBody;
            
            // Also update the rich text editor
            const editor = $('clientEmailBodyEditor');
            if (editor) {
                editor.innerText = finalBody;
            }
        }
        
        function updateClientEmailPreview() {
            const templateId = $('clientEmailTemplate').value;
            if (!templateId || templateId === 'custom') return;
            
            const apptId = $('clientEmailAppt').value;
            const appt = apptId ? data.appointments.find(a => String(a.ID) === String(apptId)) : null;
            
            let subject = $('clientEmailSubject').value;
            let body = $('clientEmailBody').value;
            
            // Re-replace placeholders with appointment data if selected
            if (appt) {
                // Get original template to re-apply placeholders
                if (templateId === 'sys_confirmation') {
                    subject = 'Your appointment at {StoreName} is confirmed!';
                    const tpl = getConfirmTemplate();
                    body = (typeof tpl === 'string') ? tpl : (tpl.text || tpl.html || '');
                } else if (templateId === 'sys_followup') {
                    const template = getFollowupTemplate();
                    subject = template.subject;
                    body = template.body;
                } else if (templateId === 'sys_anniversary') {
                    const template = getAnniversaryTemplate();
                    subject = template.subject;
                    body = template.body;
                } else if (templateId.startsWith('custom_')) {
                    const customId = templateId.replace('custom_', '');
                    const template = (data.emailtemplates || []).find(t => String(t.ID) === String(customId));
                    if (template) {
                        subject = template.Subject;
                        body = template.Body;
                    }
                }
                
                subject = replacePlaceholders(subject, currentClient, appt);
                body = replacePlaceholders(body, currentClient, appt);
                
                $('clientEmailSubject').value = subject;
                $('clientEmailBody').value = body;
                
                // Also update the rich text editor
                const editor = $('clientEmailBodyEditor');
                if (editor) {
                    editor.innerText = body;
                }
            }
        }
        
        function replacePlaceholders(text, client, appt) {
            if (!text || typeof text !== 'string') return text || '';
            
            const storeInfo = getStoreInfo();
            
            // Helper: replace both {{var}} and {var} (case-insensitive)
            function r(pattern, value) {
                // Double braces first, then single
                text = text.replace(new RegExp('\\{\\{' + pattern + '\\}\\}', 'gi'), value);
                text = text.replace(new RegExp('\\{' + pattern + '\\}', 'gi'), value);
            }
            
            // Client placeholders
            r('firstName', client.FirstName || '');
            r('FirstName', client.FirstName || '');
            r('lastName', client.LastName || '');
            r('LastName', client.LastName || '');
            r('weddingDate', fmtDate(client.WeddingDate) || '');
            r('WeddingDate', fmtDate(client.WeddingDate) || '');
            r('venue', client.Venue || '');
            r('Venue', client.Venue || '');
            
            // Appointment placeholders
            if (appt) {
                r('appointmentDate', fmtDate(appt.Date) || '');
                r('AppointmentDate', fmtDate(appt.Date) || '');
                r('appointmentTime', fmtTime(appt.Time) || '');
                r('AppointmentTime', fmtTime(appt.Time) || '');
                r('appointmentType', appt.Type || 'Bridal Consultation');
                r('AppointmentType', appt.Type || 'Bridal Consultation');
                r('consultant', appt.Consultant || '');
                r('Consultant', appt.Consultant || '');
            } else {
                r('appointmentDate', '');
                r('AppointmentDate', '');
                r('appointmentTime', '');
                r('AppointmentTime', '');
                r('appointmentType', '');
                r('AppointmentType', '');
                r('consultant', '');
                r('Consultant', '');
            }
            
            // Store placeholders
            r('storeName', storeInfo.name || 'Estrelle Bridal');
            r('StoreName', storeInfo.name || 'Estrelle Bridal');
            r('storePhone', storeInfo.phone || '');
            r('StorePhone', storeInfo.phone || '');
            r('storeAddress', storeInfo.address || '');
            r('StoreAddress', storeInfo.address || '');
            r('storeEmail', storeInfo.email || '');
            r('StoreEmail', storeInfo.email || '');
            
            // Top options placeholder
            if (client && client.ID) {
                const topOptionsList = (data.topoptions || [])
                    .filter(o => String(o.ClientID) === String(client.ID) && (o.IsFavorite === true || o.IsFavorite === 'TRUE'))
                    .map(o => `${o.Designer} - ${o.Style}`);
                
                const topOptionsText = topOptionsList.length 
                    ? `You looked absolutely stunning in your top choices:\n‚Ä¢ ${topOptionsList.join('\n‚Ä¢ ')}`
                    : '';
                    
                text = text.replace(/\{\{topOptions\}\}/gi, topOptionsText);
                text = text.replace(/\{topOptions\}/gi, topOptionsText);
            } else {
                text = text.replace(/\{\{topOptions\}\}/gi, '');
                text = text.replace(/\{topOptions\}/gi, '');
            }
            
            return text;
        }
        
        function openInEmailApp() {
            const subject = $('clientEmailSubject').value.trim();
            const body = $('clientEmailBody').value.trim();
            const email = currentClient.Email;
            
            if (!subject) { toast('Please enter a subject', 'error'); return; }
            if (!body) { toast('Please enter a message', 'error'); return; }
            
            // Create mailto link
            const mailtoLink = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open in email app
            window.location.href = mailtoLink;
            
            closeModal('clientEmail');
            toast('Opening email app...', 'success');
        }
        
        function openInGmail(toFieldId, subjectFieldId, bodyFieldId) {
            // Handle different field ID formats
            let email, subject, body;
            
            if (toFieldId === 'clientEmailTo') {
                // Client email modal uses span, not input
                email = currentClient?.Email || '';
            } else {
                const toField = $(toFieldId);
                email = toField ? (toField.value || toField.textContent || '') : '';
            }
            
            const subjectField = $(subjectFieldId);
            const bodyField = $(bodyFieldId);
            
            subject = subjectField ? subjectField.value.trim() : '';
            body = bodyField ? bodyField.value.trim() : '';
            
            if (!email) { toast('No email address', 'error'); return; }
            if (!subject) { toast('Please enter a subject', 'error'); return; }
            if (!body) { toast('Please enter a message', 'error'); return; }
            
            // Create Gmail compose URL
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open in new tab
            window.open(gmailUrl, '_blank');
            
            toast('Opening Gmail...', 'success');
        }

        // ========== CONSULTANTS ==========
        let consultantSigPad = null;
        
        function renderConsultants() {
            $('consultantsList').innerHTML = data.consultants.length ? data.consultants.map(c => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--cream);border-radius:5px;margin-bottom:8px">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div class="avatar">${(c.Name || '?')[0]}</div>
                        <div>
                            <div style="font-weight:500">${c.Name || 'Unknown'}</div>
                            <div style="font-size:10px;color:var(--rose)">${c.Signature ? '‚úì Signature saved' : 'No signature'}</div>
                        </div>
                    </div>
                    <div>
                        <button class="action-btn" onclick="editConsultant(${c.ID})">Edit</button>
                        <button class="action-btn" onclick="deleteConsultant(${c.ID})">Delete</button>
                    </div>
                </div>
            `).join('') : '<div class="empty">No consultants yet. Add your team members to save their signatures.</div>';
            
            // Also render saved alteration items
            renderSavedAltItems();
        }
        
        // ========== ALTERATION ITEMS ==========
        function renderSavedAltItems() {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            if (savedItems.length === 0) {
                $('savedAltItemsList').innerHTML = '<div class="empty" style="font-size:11px">No custom items saved yet. Add items here or check "Save for future use" when adding alterations.</div>';
                return;
            }
            
            $('savedAltItemsList').innerHTML = savedItems.map((item, idx) => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--cream);border-radius:4px;margin-bottom:6px">
                    <span style="font-size:12px">‚úÇÔ∏è ${item}</span>
                    <button class="action-btn" style="color:#e74c3c" onclick="removeSavedAltItem(${idx})">√ó</button>
                </div>
            `).join('');
        }
        
        function addSavedAltItem() {
            const name = $('newSavedAltItem').value.trim();
            if (!name) {
                toast('Enter item name', 'error');
                return;
            }
            
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            if (savedItems.includes(name)) {
                toast('Item already exists', 'error');
                return;
            }
            
            savedItems.push(name);
            localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
            $('newSavedAltItem').value = '';
            renderSavedAltItems();
            toast('Item saved!', 'success');
        }
        
        function removeSavedAltItem(idx) {
            const savedItems = JSON.parse(localStorage.getItem('estrelle_alt_items') || '[]');
            savedItems.splice(idx, 1);
            localStorage.setItem('estrelle_alt_items', JSON.stringify(savedItems));
            renderSavedAltItems();
            toast('Item removed', 'success');
        }
        
        // ========== SETTINGS ==========
        const DEFAULT_SERVICE_TYPES = ['Bridal Consultation', 'Fitting', 'Final Fitting', 'Pickup', 'Measurement'];
        const DEFAULT_STORE_INFO = {
            name: 'Estrelle Bridal',
            address: '',
            phone: '',
            email: '',
            website: '',
            instagram: '',
            tiktok: ''
        };
        
        function getStoreInfo() {
            const saved = localStorage.getItem('estrelle_store_info');
            if (saved) {
                try {
                    return { ...DEFAULT_STORE_INFO, ...JSON.parse(saved) };
                } catch (e) {
                    return { ...DEFAULT_STORE_INFO };
                }
            }
            return { ...DEFAULT_STORE_INFO };
        }
        
        // Email mode: 'gmail' (open in Gmail) or 'direct' (send via API)
        // Default to 'gmail' for now - can change to 'direct' when ready
        function getEmailMode() {
            return localStorage.getItem('estrelle_email_mode') || 'gmail';
        }
        
        function setEmailMode(mode) {
            localStorage.setItem('estrelle_email_mode', mode);
        }
        
        // Helper to send email - uses Gmail or direct based on setting
        function sendEmailViaPreferredMethod(to, subject, body, onSuccess) {
            if (getEmailMode() === 'gmail') {
                const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(gmailUrl, '_blank');
                toast('Email opened in Gmail', 'success');
                if (onSuccess) onSuccess();
            } else {
                // Direct send via API (for future use)
                api('POST', { action: 'sendEmail', to, subject, body })
                    .then(() => {
                        toast('Email sent!', 'success');
                        if (onSuccess) onSuccess();
                    })
                    .catch(e => toast('Failed to send email', 'error'));
            }
        }
        
        function getServiceTypes() {
            const saved = localStorage.getItem('estrelle_service_types');
            if (saved) {
                try {
                    let types = JSON.parse(saved);
                    let changed = false;
                    
                    // One-time migration: if "Consultation" exists but "Bridal Consultation" doesn't, rename it
                    const hasPlain = types.indexOf('Consultation');
                    const hasBridal = types.some(t => t === 'Bridal Consultation');
                    if (hasPlain !== -1 && !hasBridal) {
                        types[hasPlain] = 'Bridal Consultation';
                        changed = true;
                    } else if (hasPlain !== -1 && hasBridal) {
                        // Both exist ‚Äî remove the plain duplicate
                        types.splice(hasPlain, 1);
                        changed = true;
                    }
                    
                    // Remove duplicates
                    const before = types.length;
                    types = [...new Set(types)];
                    if (types.length !== before) changed = true;
                    
                    // Add Measurement if missing
                    if (!types.some(t => t.toLowerCase() === 'measurement')) {
                        types.push('Measurement');
                        changed = true;
                    }
                    
                    // Only save back if something actually changed
                    if (changed) {
                        localStorage.setItem('estrelle_service_types', JSON.stringify(types));
                    }
                    
                    return types;
                } catch (e) {
                    return [...DEFAULT_SERVICE_TYPES];
                }
            }
            return [...DEFAULT_SERVICE_TYPES];
        }
        
        function renderSettings() {
            // Load store info
            const storeInfo = getStoreInfo();
            $('setStoreName').value = storeInfo.name || '';
            $('setStoreAddress').value = storeInfo.address || '';
            $('setStorePhone').value = storeInfo.phone || '';
            $('setStoreEmail').value = storeInfo.email || '';
            $('setStoreWebsite').value = storeInfo.website || '';
            $('setStoreInstagram').value = storeInfo.instagram || '';
            $('setStoreTiktok').value = storeInfo.tiktok || '';
            
            // Load service types
            renderServiceTypes();
            
            // Load email templates
            renderEmailTemplates();
            
            // Ensure designer data is loaded
            if (!designerData || designerData.length === 0) {
                loadDesignerData();
            }
            
            // Update counts
            $('consultantCount').textContent = `(${data.consultants.length})`;
            $('designerCount').textContent = `(${designerData.length})`;
            
            // Count total email template types (4 system templates)
            const templateCount = 4;
            $('templateCount').textContent = `(${templateCount})`;
            
            // Render consultants in settings
            $('settingsConsultantsList').innerHTML = data.consultants.length ? data.consultants.map(c => `
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg);border-radius:10px;margin-bottom:8px">
                    <div class="avatar">${c.Name ? c.Name[0] : '?'}</div>
                    <div style="flex:1">
                        <div style="font-weight:600">${c.Name || 'Unknown'}</div>
                        <div style="font-size:12px;color:var(--text-secondary)">${c.Signature ? 'Signature saved' : 'No signature'}</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="editConsultant('${c.ID}')">Edit</button>
                    <button class="btn btn-sm" onclick="deleteConsultant('${c.ID}')" style="background:var(--red);color:white">Delete</button>
                </div>
            `).join('') : '<p style="color:var(--text-secondary);font-size:13px">No consultants added yet</p>';
            
            // Render designers in settings (using localStorage designerData)
            $('settingsDesignersTable').innerHTML = designerData.length ? designerData.map((d, idx) => `
                <tr>
                    <td style="font-weight:500">${d.name}</td>
                    <td>${d.standard || '?'} months</td>
                    <td style="font-size:11px">${d.rushTiers && d.rushTiers.length > 0 ? d.rushTiers.map(t => `${t.months}mo: ${t.fee}`).join('<br>') : '‚Äî'}</td>
                    <td style="font-size:11px;color:var(--red)">${d.belowMin ? (d.belowMin.fee || d.belowMin.note || 'Call') : 'Call'}</td>
                    <td>
                        <button class="action-btn" onclick="openEditDesignerModal(${idx})">Edit</button>
                        <button class="action-btn" onclick="deleteDesignerFromList(${idx})" style="color:var(--red)">Delete</button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary)">No designers added</td></tr>';
            
            // Render anniversaries preview
            renderSettingsAnniversaries();
        }
        
        function renderSettingsAnniversaries() {
            const now = new Date();
            const currentYear = now.getFullYear();
            
            console.log('=== RENDER ANNIVERSARIES ===');
            console.log('Total clients:', data.clients.length);
            
            // Get all clients with wedding dates
            const clientsWithWedding = data.clients.filter(c => c.WeddingDate);
            console.log('Clients with WeddingDate:', clientsWithWedding.length);
            
            if (clientsWithWedding.length === 0) {
                $('settingsAnniversariesList').innerHTML = '<p style="color:var(--text-secondary);font-size:13px">No clients have wedding dates set</p>';
                return;
            }
            
            const upcoming = clientsWithWedding
                .map(c => {
                    const wdStr = getDateStr(c.WeddingDate);
                    if (!wdStr || wdStr.includes('1899')) return null; // Invalid date
                    
                    const wd = new Date(wdStr + 'T00:00:00');
                    if (isNaN(wd.getTime())) return null; // Invalid date
                    
                    // Calculate this year's anniversary
                    let thisYearAnn = new Date(currentYear, wd.getMonth(), wd.getDate());
                    
                    // If anniversary already passed this year, use next year
                    if (thisYearAnn < now) {
                        thisYearAnn.setFullYear(currentYear + 1);
                    }
                    
                    const daysUntil = Math.ceil((thisYearAnn - now) / (1000 * 60 * 60 * 24));
                    const yearsMarried = thisYearAnn.getFullYear() - wd.getFullYear();
                    
                    return { ...c, daysUntil, anniversary: thisYearAnn, weddingYear: wd.getFullYear(), yearsMarried };
                })
                .filter(c => c !== null)
                .sort((a, b) => a.daysUntil - b.daysUntil);
            
            console.log('Valid anniversaries:', upcoming.length);
            
            // Show all, grouped by timeframe
            const soon = upcoming.filter(c => c.daysUntil <= 30);
            const later = upcoming.filter(c => c.daysUntil > 30 && c.daysUntil <= 90);
            const rest = upcoming.filter(c => c.daysUntil > 90).slice(0, 10);
            
            let html = '';
            
            if (soon.length > 0) {
                html += '<div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:8px;margin-top:4px">üìÖ NEXT 30 DAYS</div>';
                html += soon.map(c => renderAnniversaryItem(c)).join('');
            }
            
            if (later.length > 0) {
                html += '<div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;margin-top:12px">NEXT 90 DAYS</div>';
                html += later.map(c => renderAnniversaryItem(c)).join('');
            }
            
            if (rest.length > 0) {
                html += '<div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;margin-top:12px">LATER THIS YEAR</div>';
                html += rest.map(c => renderAnniversaryItem(c)).join('');
            }
            
            if (html === '') {
                html = '<p style="color:var(--text-secondary);font-size:13px">No valid anniversary dates found</p>';
            }
            
            $('settingsAnniversariesList').innerHTML = html;
        }
        
        function renderAnniversaryItem(c) {
            const urgentStyle = c.daysUntil <= 7 ? 'border-left:3px solid var(--red);' : '';
            return `
                <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:6px;${urgentStyle}" onclick="openClient('${c.ID}')" class="clickable">
                    <div class="avatar" style="width:36px;height:36px;font-size:12px">${initials(c.FirstName, c.LastName)}</div>
                    <div style="flex:1">
                        <div style="font-weight:500;font-size:13px">${c.FirstName} ${c.LastName}</div>
                        <div style="font-size:11px;color:var(--text-secondary)">${c.anniversary.toLocaleDateString('en-US', {month:'short', day:'numeric'})} ¬∑ ${c.yearsMarried} year${c.yearsMarried !== 1 ? 's' : ''}</div>
                    </div>
                    <span style="font-size:12px;font-weight:500;color:${c.daysUntil <= 7 ? 'var(--red)' : c.daysUntil <= 30 ? 'var(--accent)' : 'var(--text-secondary)'}">${c.daysUntil === 0 ? 'Today!' : c.daysUntil + 'd'}</span>
                </div>
            `;
        }
        
        function toggleSettingsSection(section) {
            const content = $('section' + section.charAt(0).toUpperCase() + section.slice(1));
            const toggle = $('toggle' + section.charAt(0).toUpperCase() + section.slice(1));
            if (content && toggle) {
                const isOpen = content.style.display !== 'none';
                content.style.display = isOpen ? 'none' : 'block';
                toggle.textContent = isOpen ? '‚ñº' : '‚ñ≤';
                
                // Render content when opening specific sections
                if (!isOpen) {
                    if (section === 'anniversaries') renderSettingsAnniversaries();
                    if (section === 'consultants') renderSettings();
                    if (section === 'designers') renderDesigners();
                    if (section === 'altItems') renderSavedAltItems();
                    if (section === 'services') renderServiceTypes();
                }
            }
        }
        
        // ========== ORDERS VIEW TOGGLE ==========
        let ordersView = 'orders';
        
        function setOrdersView(view) {
            ordersView = view;
            $('viewOrders').style.background = view === 'orders' ? 'var(--accent)' : 'white';
            $('viewOrders').style.color = view === 'orders' ? 'white' : 'var(--text)';
            $('viewAlterations').style.background = view === 'alterations' ? 'var(--accent)' : 'white';
            $('viewAlterations').style.color = view === 'alterations' ? 'white' : 'var(--text)';
            
            $('ordersViewContent').style.display = view === 'orders' ? 'block' : 'none';
            $('alterationsViewContent').style.display = view === 'alterations' ? 'block' : 'none';
            
            if (view === 'orders') {
                $('ordersAddBtn').textContent = '+ Add Order';
                $('ordersAddBtn').onclick = openAddOrder;
                renderOrders();
            } else {
                $('ordersAddBtn').textContent = '+ Add Fitting';
                $('ordersAddBtn').onclick = openAddAlterationItem;
                renderAlts();
            }
        }
        
        // ========== REPORTING VIEW TOGGLE ==========
        let reportingView = 'analytics';
        
        function setReportingView(view) {
            reportingView = view;
            $('viewAnalytics').style.background = view === 'analytics' ? 'var(--accent)' : 'white';
            $('viewAnalytics').style.color = view === 'analytics' ? 'white' : 'var(--text)';
            $('viewReportBuilder').style.background = view === 'builder' ? 'var(--accent)' : 'white';
            $('viewReportBuilder').style.color = view === 'builder' ? 'white' : 'var(--text)';
            
            $('analyticsViewContent').style.display = view === 'analytics' ? 'block' : 'none';
            $('reportBuilderContent').style.display = view === 'builder' ? 'block' : 'none';
            
            if (view === 'analytics') {
                $('reportingSubtitle').textContent = 'Sales trends & insights';
                renderAnalytics();
            } else {
                $('reportingSubtitle').textContent = 'Build custom reports';
                initReportBuilder();
            }
        }
        
        function renderReporting() {
            if (reportingView === 'analytics') {
                renderAnalytics();
            } else {
                initReportBuilder();
            }
        }
        
        // ========== REPORT BUILDER ==========
        function initReportBuilder() {
            // Set default date range to this month
            const now = new Date();
            const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            $('reportDateFrom').value = firstOfMonth.toISOString().split('T')[0];
            $('reportDateTo').value = lastOfMonth.toISOString().split('T')[0];
        }
        
        function setReportDateRange(range) {
            const now = new Date();
            let from, to;
            
            switch(range) {
                case 'thisMonth':
                    from = new Date(now.getFullYear(), now.getMonth(), 1);
                    to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    from = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    to = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const q = Math.floor(now.getMonth() / 3);
                    from = new Date(now.getFullYear(), q * 3, 1);
                    to = new Date(now.getFullYear(), (q + 1) * 3, 0);
                    break;
                case 'lastQuarter':
                    const lq = Math.floor(now.getMonth() / 3) - 1;
                    from = new Date(now.getFullYear(), lq * 3, 1);
                    to = new Date(now.getFullYear(), (lq + 1) * 3, 0);
                    break;
                case 'thisYear':
                    from = new Date(now.getFullYear(), 0, 1);
                    to = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'lastYear':
                    from = new Date(now.getFullYear() - 1, 0, 1);
                    to = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                default:
                    return;
            }
            
            $('reportDateFrom').value = from.toISOString().split('T')[0];
            $('reportDateTo').value = to.toISOString().split('T')[0];
        }
        
        function generateReport() {
            const type = $('reportType').value;
            const groupBy = $('reportGroupBy').value;
            const dateFrom = $('reportDateFrom').value;
            const dateTo = $('reportDateTo').value;
            const excludeNoShow = $('reportFilterNoShow').checked;
            
            let results = [];
            let columns = [];
            
            if (type === 'appointments') {
                columns = ['Date', 'Time', 'Client', 'Type', 'Consultant', 'Status'];
                results = data.appointments
                    .filter(a => {
                        const d = getDateStr(a.Date);
                        if (d < dateFrom || d > dateTo) return false;
                        if (excludeNoShow && a.Status === 'no-show') return false;
                        return true;
                    })
                    .map(a => {
                        const c = getClient(a.ClientID);
                        return {
                            Date: fmtDate(a.Date),
                            Time: fmtTime(a.Time),
                            Client: c ? `${c.FirstName} ${c.LastName}` : 'Unknown',
                            Type: a.Type || '',
                            Consultant: a.Consultant || '',
                            Status: a.Status || ''
                        };
                    });
            } else if (type === 'clients') {
                columns = ['Name', 'Email', 'Phone', 'Wedding Date', 'Status', 'Created'];
                results = data.clients.map(c => ({
                    Name: `${c.FirstName} ${c.LastName}`,
                    Email: c.Email || '',
                    Phone: c.Phone || '',
                    'Wedding Date': fmtDate(c.WeddingDate),
                    Status: c.Status || '',
                    Created: fmtDate(c.CreatedDate)
                }));
            } else if (type === 'orders') {
                columns = ['Client', 'Designer', 'Style', 'Status', 'Total', 'Order Date'];
                results = data.orders.map(o => {
                    const c = getClient(o.ClientID);
                    return {
                        Client: c ? `${c.FirstName} ${c.LastName}` : 'Unknown',
                        Designer: o.Designer || '',
                        Style: o.StyleNumber || '',
                        Status: o.Status || '',
                        Total: money(o.TotalWithTax),
                        'Order Date': fmtDate(o.OrderDate)
                    };
                });
            } else if (type === 'consultants') {
                columns = ['Consultant', 'Appointments', 'Consultations', 'Sales', 'Conversion'];
                const consultantStats = {};
                data.consultants.forEach(c => {
                    consultantStats[c.Name] = { appts: 0, consults: 0, sales: 0 };
                });
                data.appointments
                    .filter(a => {
                        const d = getDateStr(a.Date);
                        return d >= dateFrom && d <= dateTo;
                    })
                    .forEach(a => {
                        if (a.Consultant && consultantStats[a.Consultant]) {
                            consultantStats[a.Consultant].appts++;
                            if (a.Type?.toLowerCase().includes('consult')) {
                                consultantStats[a.Consultant].consults++;
                            }
                        }
                    });
                results = Object.entries(consultantStats).map(([name, stats]) => ({
                    Consultant: name,
                    Appointments: stats.appts,
                    Consultations: stats.consults,
                    Sales: stats.sales,
                    Conversion: stats.consults > 0 ? Math.round(stats.sales / stats.consults * 100) + '%' : '0%'
                }));
            }
            
            // Display results
            $('reportResultsCard').style.display = 'block';
            $('reportResultsTitle').textContent = type.charAt(0).toUpperCase() + type.slice(1) + ' Report';
            $('reportResultsCount').textContent = results.length + ' records';
            
            $('reportResultsHead').innerHTML = '<tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr>';
            $('reportResultsBody').innerHTML = results.length ? results.map(r => 
                '<tr>' + columns.map(c => `<td>${r[c] || ''}</td>`).join('') + '</tr>'
            ).join('') : '<tr><td colspan="' + columns.length + '" style="text-align:center;color:var(--text-secondary)">No data found</td></tr>';
        }
        
        function exportReport() {
            generateReport();
            // Export to CSV
            const table = $('reportResultsTable');
            if (!table) return;
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = Array.from(cols).map(col => '"' + col.textContent.replace(/"/g, '""') + '"');
                csv.push(rowData.join(','));
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            toast('Report exported!', 'success');
        }
        
        function saveStoreInfo() {
            const storeInfo = {
                name: $('setStoreName').value.trim(),
                address: $('setStoreAddress').value.trim(),
                phone: $('setStorePhone').value.trim(),
                email: $('setStoreEmail').value.trim(),
                website: $('setStoreWebsite').value.trim(),
                instagram: $('setStoreInstagram').value.trim(),
                tiktok: $('setStoreTiktok').value.trim()
            };
            localStorage.setItem('estrelle_store_info', JSON.stringify(storeInfo));
            toast('Store info saved!', 'success');
        }
        
        // ========== EMAIL TEMPLATE EDITOR ==========
        function openTemplateEditor(type) {
            $('templateEditorType').value = type;
            
            // Hide all template sections
            $('templateConfirmation').style.display = 'none';
            $('templateAnniversary').style.display = 'none';
            $('templateFollowup').style.display = 'none';
            $('templateOrder').style.display = 'none';
            
            if (type === 'confirmation') {
                $('templateEditorTitle').textContent = 'üìÖ Edit Appointment Confirmation Template';
                // Handle both new HTML format and legacy plain text
                const template = getConfirmTemplate();
                if (template.html) {
                    // Convert HTML to plain text for editing (strip tags but keep line breaks)
                    const temp = document.createElement('div');
                    temp.innerHTML = template.html;
                    $('templateConfirmBody').value = temp.innerText;
                } else {
                    $('templateConfirmBody').value = template.text || DEFAULT_CONFIRM_TEMPLATE;
                }
                $('templateConfirmation').style.display = 'block';
            } else if (type === 'anniversary') {
                $('templateEditorTitle').textContent = 'üíç Edit Anniversary Email Template';
                const template = getAnniversaryTemplate();
                $('templateAnnSubject').value = template.subject;
                $('templateAnnBody').value = template.body;
                $('templateAnniversary').style.display = 'block';
            } else if (type === 'followup') {
                $('templateEditorTitle').textContent = 'üìû Edit Follow-up Email Template';
                const template = getFollowupTemplate();
                $('templateFollowupSubject').value = template.subject;
                $('templateFollowupBody').value = template.body;
                $('templateFollowup').style.display = 'block';
            } else if (type === 'order') {
                $('templateEditorTitle').textContent = 'üì¶ Manage Order Status Templates';
                renderOrderTemplatesList();
                $('templateOrder').style.display = 'block';
            }
            
            openModal('templateEditor');
        }
        
        function saveTemplate(type) {
            if (type === 'confirmation') {
                const template = $('templateConfirmBody').value;
                // Save as plain text (Settings editor doesn't support rich text)
                // This will be converted to new format when saved from email modal with formatting
                const templateData = {
                    html: null,
                    text: template,
                    version: 2
                };
                localStorage.setItem(CONFIRM_TEMPLATE_KEY, JSON.stringify(templateData));
                toast('Confirmation template saved!', 'success');
            } else if (type === 'anniversary') {
                const template = {
                    subject: $('templateAnnSubject').value,
                    body: $('templateAnnBody').value
                };
                localStorage.setItem('estrelle_anniversary_template', JSON.stringify(template));
                toast('Anniversary template saved!', 'success');
            } else if (type === 'followup') {
                const template = {
                    subject: $('templateFollowupSubject').value,
                    body: $('templateFollowupBody').value
                };
                localStorage.setItem('estrelle_followup_template', JSON.stringify(template));
                toast('Follow-up template saved!', 'success');
            }
        }
        
        function resetTemplate(type) {
            if (!confirm('Reset to default template? Your changes will be lost.')) return;
            
            if (type === 'confirmation') {
                localStorage.removeItem(CONFIRM_TEMPLATE_KEY);
                $('templateConfirmBody').value = DEFAULT_CONFIRM_TEMPLATE;
                toast('Confirmation template reset to default', 'success');
            } else if (type === 'anniversary') {
                localStorage.removeItem('estrelle_anniversary_template');
                $('templateAnnSubject').value = DEFAULT_ANNIVERSARY_TEMPLATE.subject;
                $('templateAnnBody').value = DEFAULT_ANNIVERSARY_TEMPLATE.body;
                toast('Anniversary template reset to default', 'success');
            } else if (type === 'followup') {
                localStorage.removeItem('estrelle_followup_template');
                $('templateFollowupSubject').value = DEFAULT_FOLLOWUP_TEMPLATE.subject;
                $('templateFollowupBody').value = DEFAULT_FOLLOWUP_TEMPLATE.body;
                toast('Follow-up template reset to default', 'success');
            }
        }
        
        function renderOrderTemplatesList() {
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            const names = Object.keys(saved);
            
            if (names.length === 0) {
                $('orderTemplatesList').innerHTML = '<div style="font-size:11px;color:var(--taupe);padding:12px;background:var(--cream);border-radius:5px">No saved templates yet. Create one below.</div>';
                return;
            }
            
            $('orderTemplatesList').innerHTML = names.map(function(name) {
                const t = saved[name];
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--cream);border-radius:5px;margin-bottom:8px">' +
                    '<div style="flex:1">' +
                        '<div style="font-weight:500;font-size:12px">' + name + '</div>' +
                        '<div style="font-size:10px;color:var(--taupe)">' + (t.subject || '').substring(0, 50) + '...</div>' +
                    '</div>' +
                    '<div style="display:flex;gap:4px">' +
                        '<button class="btn btn-sm btn-secondary" onclick="editOrderTemplate(\'' + name.replace(/'/g, "\\'") + '\')">‚úèÔ∏è</button>' +
                        '<button class="btn btn-sm" style="background:#fee;color:#c00" onclick="deleteOrderTemplate(\'' + name.replace(/'/g, "\\'") + '\')">üóë</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        function addOrderTemplate() {
            const name = $('newOrderTemplateName').value.trim();
            const subject = $('newOrderTemplateSubject').value.trim();
            const body = $('newOrderTemplateBody').value.trim();
            
            if (!name) {
                toast('Please enter a template name', 'error');
                return;
            }
            if (!subject || !body) {
                toast('Please enter subject and body', 'error');
                return;
            }
            
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            saved[name] = { subject, body };
            localStorage.setItem('estrelle_email_templates', JSON.stringify(saved));
            
            // Clear form
            $('newOrderTemplateName').value = '';
            $('newOrderTemplateSubject').value = '';
            $('newOrderTemplateBody').value = '';
            
            renderOrderTemplatesList();
            toast('Template "' + name + '" saved!', 'success');
        }
        
        function editOrderTemplate(name) {
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            const t = saved[name];
            if (!t) return;
            
            // Fill form with existing template
            $('newOrderTemplateName').value = name;
            $('newOrderTemplateSubject').value = t.subject || '';
            $('newOrderTemplateBody').value = t.body || '';
            
            // Scroll to form
            $('newOrderTemplateName').focus();
            toast('Editing "' + name + '" - make changes and click Add to save', '');
        }
        
        function deleteOrderTemplate(name) {
            if (!confirm('Delete template "' + name + '"?')) return;
            
            const saved = JSON.parse(localStorage.getItem('estrelle_email_templates') || '{}');
            delete saved[name];
            localStorage.setItem('estrelle_email_templates', JSON.stringify(saved));
            
            renderOrderTemplatesList();
            toast('Template deleted', 'success');
        }
        
        function renderServiceTypes() {
            const types = getServiceTypes();
            $('serviceTypesList').innerHTML = types.length ? types.map((type, idx) => `
                <div class="service-type-item" draggable="true" data-idx="${idx}" style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--cream);border-radius:4px;margin-bottom:6px;cursor:grab">
                    <span style="font-size:12px;display:flex;align-items:center;gap:8px"><span style="color:var(--rose);cursor:grab">‚ãÆ‚ãÆ</span> üìÖ ${type}</span>
                    <div style="display:flex;gap:4px;align-items:center">
                        <button class="action-btn" onclick="editServiceType(${idx})" title="Edit">‚úèÔ∏è</button>
                        <button class="action-btn" style="color:#e74c3c" onclick="removeServiceType(${idx})" title="Delete">√ó</button>
                    </div>
                </div>
            `).join('') : '<div class="empty" style="font-size:11px">No service types. Add some below.</div>';
            
            // Add drag and drop handlers
            initServiceTypeDragDrop();
        }
        
        function initServiceTypeDragDrop() {
            const items = document.querySelectorAll('.service-type-item');
            let draggedItem = null;
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', () => {
                    item.style.opacity = '1';
                    draggedItem = null;
                    document.querySelectorAll('.service-type-item').forEach(i => i.style.borderTop = '');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedItem && draggedItem !== item) {
                        item.style.borderTop = '2px solid var(--rose)';
                    }
                });
                
                item.addEventListener('dragleave', () => {
                    item.style.borderTop = '';
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.style.borderTop = '';
                    
                    if (draggedItem && draggedItem !== item) {
                        const fromIdx = parseInt(draggedItem.dataset.idx);
                        const toIdx = parseInt(item.dataset.idx);
                        
                        const types = getServiceTypes();
                        const [moved] = types.splice(fromIdx, 1);
                        types.splice(toIdx, 0, moved);
                        localStorage.setItem('estrelle_service_types', JSON.stringify(types));
                        renderServiceTypes();
                    }
                });
            });
        }
        
        function addServiceType() {
            const name = $('newServiceType').value.trim();
            if (!name) {
                toast('Enter service type name', 'error');
                return;
            }
            
            const types = getServiceTypes();
            // Check for duplicates (case-insensitive)
            if (types.some(t => t.toLowerCase() === name.toLowerCase())) {
                toast('Type already exists', 'error');
                return;
            }
            
            types.push(name);
            localStorage.setItem('estrelle_service_types', JSON.stringify(types));
            $('newServiceType').value = '';
            renderServiceTypes();
            toast('Service type added!', 'success');
        }
        
        async function removeServiceType(idx) {
            const types = getServiceTypes();
            if (types.length <= 1) {
                toast('Need at least one service type', 'error');
                return;
            }
            const confirmed = await appConfirmDanger(`Delete "${types[idx]}"?`, 'Delete Service Type');
            if (!confirmed) return;
            types.splice(idx, 1);
            localStorage.setItem('estrelle_service_types', JSON.stringify(types));
            renderServiceTypes();
            toast('Service type removed', 'success');
        }
        
        async function editServiceType(idx) {
            const types = getServiceTypes();
            const oldName = types[idx];
            const newName = await appPrompt('Edit service type name:', oldName, 'Edit Service Type');
            
            if (!newName || newName.trim() === '') return;
            if (newName.trim() === oldName) return;
            
            // Check for duplicates
            if (types.some((t, i) => i !== idx && t.toLowerCase() === newName.trim().toLowerCase())) {
                toast('Type already exists', 'error');
                return;
            }
            
            const trimmedNewName = newName.trim();
            types[idx] = trimmedNewName;
            localStorage.setItem('estrelle_service_types', JSON.stringify(types));
            
            // Migrate existing appointments with the old type name
            const oldNameLower = oldName.toLowerCase();
            const appointmentsToUpdate = data.appointments.filter(a => 
                a.Type && a.Type.toLowerCase() === oldNameLower
            );
            
            if (appointmentsToUpdate.length > 0) {
                const doMigrate = await appConfirm(`Found ${appointmentsToUpdate.length} appointment(s) with type "${oldName}". Update them to "${trimmedNewName}"?`, 'Update Appointments');
                
                if (doMigrate) {
                    toast(`Updating ${appointmentsToUpdate.length} appointments...`, '');
                    
                    // Update appointments with delay to avoid API overload
                    let updated = 0;
                    const updateNext = (index) => {
                        if (index >= appointmentsToUpdate.length) {
                            saveCachedData();
                            toast(`Updated ${updated} appointment(s) to "${trimmedNewName}"`, 'success');
                            renderServiceTypes();
                            return;
                        }
                        
                        const a = appointmentsToUpdate[index];
                        // Update local data immediately
                        a.Type = trimmedNewName;
                        
                        // Update in Google Sheets with delay
                        api('POST', { action: 'update', sheet: 'Appointments', id: a.ID, record: { Type: trimmedNewName } })
                            .then(() => {
                                updated++;
                                // Process next after 200ms delay
                                setTimeout(() => updateNext(index + 1), 200);
                            })
                            .catch(e => {
                                console.error('Failed to update appointment:', a.ID, e);
                                // Continue anyway
                                setTimeout(() => updateNext(index + 1), 200);
                            });
                    };
                    
                    updateNext(0);
                    return; // Don't show toast yet, will show when done
                }
            }
            
            renderServiceTypes();
            toast('Service type updated!', 'success');
        }
        
        function moveServiceType(idx, direction) {
            const types = getServiceTypes();
            const newIdx = idx + direction;
            
            if (newIdx < 0 || newIdx >= types.length) return;
            
            // Swap
            [types[idx], types[newIdx]] = [types[newIdx], types[idx]];
            localStorage.setItem('estrelle_service_types', JSON.stringify(types));
            renderServiceTypes();
        }
        
        async function cleanUpAppointmentTypes() {
            // Only run once ‚Äî check flag
            if (localStorage.getItem('estrelle_types_cleaned')) return;
            
            const toFix = data.appointments.filter(a => {
                if (!a.Type) return false;
                const normalized = normalizeApptType(a.Type);
                return normalized !== a.Type;
            });
            
            if (toFix.length === 0) {
                localStorage.setItem('estrelle_types_cleaned', '1');
                return;
            }
            
            console.log(`Auto-cleaning ${toFix.length} appointment type(s)...`);
            
            let updated = 0;
            for (let i = 0; i < toFix.length; i++) {
                const a = toFix[i];
                const newType = normalizeApptType(a.Type);
                try {
                    await api('POST', { action: 'update', sheet: 'Appointments', id: a.ID, record: { Type: newType } });
                    a.Type = newType;
                    updated++;
                } catch (e) {
                    console.error('Failed to update appointment:', a.ID, e);
                }
                if (i < toFix.length - 1) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }
            
            saveCachedData();
            localStorage.setItem('estrelle_types_cleaned', '1');
            console.log(`Cleaned up ${updated} appointment type(s)`);
            
            // Silently re-render
            renderDash();
        }
        
        // ========== ANNIVERSARIES ==========
        let anniversaryView = 'list';
        let annCalMonth = new Date().getMonth();
        let annCalYear = new Date().getFullYear();
        
        const DEFAULT_ANNIVERSARY_TEMPLATE = {
            subject: 'Happy {{ordinal}} Anniversary, {{firstName}}! üíï',
            body: `Hi {{firstName}},

Happy {{ordinal}} Wedding Anniversary! üéâ

It's hard to believe it's been {{years}} year(s) since you found your dream dress with us and married the love of your life on {{weddingDate}}.

We hope this year has been filled with love, laughter, and beautiful memories. Thank you for letting us be a part of your special day ‚Äî it was truly an honor.

Wishing you many more years of happiness together!

With love,
${getStoreInfo().name || 'Estrelle Bridal'}`
        };
        
        function getAnniversaryTemplate() {
            const saved = localStorage.getItem('estrelle_anniversary_template');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return { ...DEFAULT_ANNIVERSARY_TEMPLATE };
                }
            }
            return { ...DEFAULT_ANNIVERSARY_TEMPLATE };
        }
        
        const DEFAULT_FOLLOWUP_TEMPLATE = {
            subject: 'Following up on your {storeName} visit, {firstName}!',
            body: `Hi {firstName},

It was so lovely meeting you at your {appointmentType} on {appointmentDate}! I wanted to follow up and see how you're feeling about everything.

{topOptions}

If you have any questions about any of the options, or if you'd like to schedule another appointment, please don't hesitate to reach out!

We're here to help you find THE dress.

Warmly,
The {storeName} Team`
        };
        
        function getFollowupTemplate() {
            const saved = localStorage.getItem('estrelle_followup_template');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return { ...DEFAULT_FOLLOWUP_TEMPLATE };
                }
            }
            return { ...DEFAULT_FOLLOWUP_TEMPLATE };
        }
        
        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }
        
        function getBridesWithOrders() {
            // Get clients who have orders (brides who purchased)
            const clientsWithOrders = new Set(data.orders.map(o => o.ClientID));
            return data.clients.filter(c => clientsWithOrders.has(c.ID) && c.WeddingDate);
        }
        
        function getAnniversaryInfo(weddingDate) {
            const wedding = new Date(getDateStr(weddingDate));
            const today = new Date();
            const thisYear = today.getFullYear();
            
            // Anniversary this year
            const annThisYear = new Date(thisYear, wedding.getMonth(), wedding.getDate());
            const annNextYear = new Date(thisYear + 1, wedding.getMonth(), wedding.getDate());
            
            // Years married
            let years = thisYear - wedding.getFullYear();
            let nextAnniversary = annThisYear;
            
            if (annThisYear < today) {
                // Anniversary passed this year
                years++;
                nextAnniversary = annNextYear;
            }
            
            const daysUntil = Math.ceil((nextAnniversary - today) / (1000 * 60 * 60 * 24));
            
            return {
                years,
                ordinal: getOrdinal(years),
                nextAnniversary,
                daysUntil,
                month: wedding.getMonth(),
                day: wedding.getDate()
            };
        }
        
        function setAnniversaryView(view) {
            anniversaryView = view;
            $('annViewList').className = view === 'list' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('annViewCal').className = view === 'calendar' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('anniversaryListView').style.display = view === 'list' ? 'block' : 'none';
            $('anniversaryCalendarView').style.display = view === 'calendar' ? 'block' : 'none';
            renderAnniversaries();
        }
        
        function renderAnniversaries() {
            const brides = getBridesWithOrders();
            $('anniversaryCount').textContent = `${brides.length} bride${brides.length !== 1 ? 's' : ''} in your wedding calendar`;
            
            if (anniversaryView === 'list') {
                renderAnniversaryList(brides);
            } else {
                renderAnniversaryCalendar(brides);
            }
        }
        
        function renderAnniversaryList(brides) {
            const filterMonth = $('annFilterMonth').value;
            
            let bridesWithInfo = brides.map(c => ({
                ...c,
                annInfo: getAnniversaryInfo(c.WeddingDate)
            }));
            
            // Filter by month if selected
            if (filterMonth !== '') {
                bridesWithInfo = bridesWithInfo.filter(b => b.annInfo.month === parseInt(filterMonth));
            }
            
            // Sort by days until next anniversary
            bridesWithInfo.sort((a, b) => a.annInfo.daysUntil - b.annInfo.daysUntil);
            
            // Get sent emails from localStorage
            const sentEmails = JSON.parse(localStorage.getItem('estrelle_anniversary_sent') || '{}');
            
            $('anniversaryTable').innerHTML = bridesWithInfo.length ? bridesWithInfo.map(b => {
                const sentKey = `${b.ID}-${new Date().getFullYear()}`;
                const wasSent = sentEmails[sentKey];
                const isUpcoming = b.annInfo.daysUntil <= 30;
                const isToday = b.annInfo.daysUntil === 0;
                
                return `<tr style="${isToday ? 'background:#fff3e0' : isUpcoming ? 'background:#f5fff5' : ''}">
                    <td>
                        <div style="font-weight:500">${b.FirstName} ${b.LastName}</div>
                    </td>
                    <td>${fmtDate(b.WeddingDate)}</td>
                    <td>
                        <span style="font-weight:600;color:var(--rose)">${b.annInfo.ordinal}</span>
                        <div style="font-size:10px;color:var(--taupe)">${isToday ? 'üéâ Today!' : b.annInfo.daysUntil + ' days'}</div>
                    </td>
                    <td style="font-size:11px">${b.Email || '<span style="color:var(--rose)">No email</span>'}</td>
                    <td>
                        ${wasSent ? `<span style="color:var(--sage);font-size:11px">‚úì Sent ${fmtDate(wasSent)}</span>` : '<span style="color:var(--taupe);font-size:11px">Not sent</span>'}
                    </td>
                    <td style="text-align:right">
                        <button class="btn btn-sm btn-secondary" onclick="openEditBrideModal(${b.ID})">‚úèÔ∏è</button>
                        <button class="btn btn-sm ${wasSent ? 'btn-secondary' : 'btn-primary'}" onclick="openAnniversaryEmailModal(${b.ID})" ${!b.Email ? 'disabled' : ''}>üìß</button>
                    </td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="empty">No brides found</td></tr>';
        }
        
        function renderAnniversaryCalendar(brides) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            $('annCalTitle').textContent = `${monthNames[annCalMonth]} ${annCalYear}`;
            
            // Get brides with anniversaries this month
            const bridesThisMonth = brides.filter(b => {
                const wedding = new Date(getDateStr(b.WeddingDate));
                return wedding.getMonth() === annCalMonth;
            });
            
            // Build calendar grid
            const firstDay = new Date(annCalYear, annCalMonth, 1).getDay();
            const daysInMonth = new Date(annCalYear, annCalMonth + 1, 0).getDate();
            
            let html = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div style="text-align:center;font-size:10px;font-weight:600;color:var(--taupe);padding:8px">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const bridesOnDay = bridesThisMonth.filter(b => {
                    const wedding = new Date(getDateStr(b.WeddingDate));
                    return wedding.getDate() === day;
                });
                
                const isToday = annCalYear === new Date().getFullYear() && annCalMonth === new Date().getMonth() && day === new Date().getDate();
                
                html += `<div style="min-height:60px;padding:4px;border:1px solid var(--champagne);border-radius:4px;${isToday ? 'background:var(--blush);' : ''}">
                    <div style="font-size:11px;font-weight:${isToday ? '600' : '400'};margin-bottom:4px">${day}</div>
                    ${bridesOnDay.map(b => `
                        <div style="font-size:9px;background:var(--dusty);color:white;padding:2px 4px;border-radius:3px;margin-bottom:2px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" onclick="openAnniversaryEmailModal(${b.ID})" title="${b.FirstName} ${b.LastName}">
                            üíï ${b.FirstName}
                        </div>
                    `).join('')}
                </div>`;
            }
            
            $('anniversaryCalendar').innerHTML = html;
        }
        
        function changeAnnCalMonth(delta) {
            annCalMonth += delta;
            if (annCalMonth > 11) {
                annCalMonth = 0;
                annCalYear++;
            } else if (annCalMonth < 0) {
                annCalMonth = 11;
                annCalYear--;
            }
            renderAnniversaryCalendar(getBridesWithOrders());
        }
        
        function openAnniversaryEmailModal(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            const annInfo = getAnniversaryInfo(c.WeddingDate);
            const template = getAnniversaryTemplate();
            
            // Replace placeholders
            let subject = template.subject
                .replace(/\{\{firstName\}\}/g, c.FirstName)
                .replace(/\{\{lastName\}\}/g, c.LastName)
                .replace(/\{\{ordinal\}\}/g, annInfo.ordinal)
                .replace(/\{\{years\}\}/g, annInfo.years)
                .replace(/\{\{weddingDate\}\}/g, fmtDate(c.WeddingDate));
                
            let body = template.body
                .replace(/\{\{firstName\}\}/g, c.FirstName)
                .replace(/\{\{lastName\}\}/g, c.LastName)
                .replace(/\{\{ordinal\}\}/g, annInfo.ordinal)
                .replace(/\{\{years\}\}/g, annInfo.years)
                .replace(/\{\{weddingDate\}\}/g, fmtDate(c.WeddingDate));
            
            $('annEmail2ClientId').value = clientId;
            $('annEmail2BrideName').textContent = `${c.FirstName} ${c.LastName}`;
            $('annEmail2Details').textContent = `Celebrating ${annInfo.ordinal} Anniversary ‚Ä¢ Wedding: ${fmtDate(c.WeddingDate)}`;
            $('annEmail2To').value = c.Email || '';
            $('annEmail2Subject').value = subject;
            $('annEmail2Body').value = body;
            
            openModal('anniversaryEmail');
            
            // Init rich text editor
            setTimeout(() => {
                initRichTextEditor('annEmail2BodyEditor', 'annEmail2Body');
            }, 50);
        }
        
        async function sendAnniversaryEmail2() {
            syncRichTextEditor('annEmail2BodyEditor', 'annEmail2Body');
            
            const clientId = $('annEmail2ClientId').value;
            const to = $('annEmail2To').value;
            const subject = $('annEmail2Subject').value;
            const body = $('annEmail2Body').value;
            
            if (!to) {
                toast('No email address', 'error');
                return;
            }
            
            closeModal('anniversaryEmail');
            
            sendEmailViaPreferredMethod(to, subject, body, () => {
                // Track sent email
                const sentEmails = JSON.parse(localStorage.getItem('estrelle_anniversary_sent') || '{}');
                sentEmails[`${clientId}-${new Date().getFullYear()}`] = today();
                localStorage.setItem('estrelle_anniversary_sent', JSON.stringify(sentEmails));
                renderAnniversaries();
            });
        }
        
        function openAnniversaryTemplateModal() {
            const template = getAnniversaryTemplate();
            $('annTemplateSubject').value = template.subject;
            $('annTemplateBody').value = template.body;
            openModal('anniversaryTemplate');
        }
        
        function saveAnniversaryTemplate() {
            const template = {
                subject: $('annTemplateSubject').value,
                body: $('annTemplateBody').value
            };
            localStorage.setItem('estrelle_anniversary_template', JSON.stringify(template));
            closeModal('anniversaryTemplate');
            toast('Template saved!', 'success');
        }
        
        function resetAnniversaryTemplate() {
            if (!confirm('Reset to default template?')) return;
            localStorage.removeItem('estrelle_anniversary_template');
            const template = getAnniversaryTemplate();
            $('annTemplateSubject').value = template.subject;
            $('annTemplateBody').value = template.body;
            toast('Template reset', 'success');
        }
        
        function openEditBrideModal(clientId) {
            const c = getClient(clientId);
            if (!c) return;
            
            $('editBrideClientId').value = clientId;
            $('editBrideName').value = `${c.FirstName} ${c.LastName}`;
            $('editBrideWeddingDate').value = getDateStr(c.WeddingDate);
            $('editBrideEmail').value = c.Email || '';
            
            openModal('editBride');
        }
        
        async function saveBrideDetails() {
            const clientId = $('editBrideClientId').value;
            const weddingDate = $('editBrideWeddingDate').value;
            const email = $('editBrideEmail').value;
            
            await updateRecord('Clients', clientId, {
                WeddingDate: weddingDate,
                Email: email
            });
            
            // Update local data
            const c = getClient(clientId);
            if (c) {
                c.WeddingDate = weddingDate;
                c.Email = email;
            }
            
            closeModal('editBride');
            toast('Updated!', 'success');
            renderAnniversaries();
        }
        
        function initConsultantSigPad() {
            $('editConsultantId').value = '';
            $('cConsultantName').value = '';
            $('consultantModalTitle').textContent = 'Add Consultant';
            
            setTimeout(() => {
                const canvas = $('consultantSigPad');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#2C2825';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                
                let drawing = false;
                const getPos = e => { 
                    const r = canvas.getBoundingClientRect(); 
                    return { 
                        x: ((e.clientX||e.touches?.[0]?.clientX) - r.left) * (canvas.width/r.width), 
                        y: ((e.clientY||e.touches?.[0]?.clientY) - r.top) * (canvas.height/r.height) 
                    }; 
                };
                canvas.onmousedown = canvas.ontouchstart = e => { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
                canvas.onmousemove = canvas.ontouchmove = e => { if (!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
                canvas.onmouseup = canvas.ontouchend = canvas.onmouseleave = () => { drawing = false; };
                
                consultantSigPad = { canvas, ctx };
            }, 100);
        }
        
        function clearConsultantSig() {
            if (!consultantSigPad) return;
            consultantSigPad.ctx.fillStyle = 'white';
            consultantSigPad.ctx.fillRect(0, 0, consultantSigPad.canvas.width, consultantSigPad.canvas.height);
        }
        
        function editConsultant(id) {
            const c = data.consultants.find(x => x.ID == id);
            if (!c) return;
            
            $('editConsultantId').value = c.ID;
            $('cConsultantName').value = c.Name || '';
            $('consultantModalTitle').textContent = 'Edit Consultant';
            
            openModal('newConsultant');
            
            // Load existing signature after canvas is ready
            setTimeout(() => {
                if (c.Signature && consultantSigPad) {
                    const img = new Image();
                    img.onload = () => {
                        consultantSigPad.ctx.fillStyle = 'white';
                        consultantSigPad.ctx.fillRect(0, 0, consultantSigPad.canvas.width, consultantSigPad.canvas.height);
                        consultantSigPad.ctx.drawImage(img, 0, 0);
                    };
                    img.src = c.Signature;
                }
            }, 150);
        }
        
        async function saveConsultant() {
            const id = $('editConsultantId').value;
            const name = $('cConsultantName').value.trim();
            if (!name) { toast('Enter name'); return; }
            
            const signature = consultantSigPad?.canvas?.toDataURL() || null;
            const record = { Name: name, Signature: signature };
            
            closeModal('newConsultant');
            toast('Saving...', '');
            
            if (id) {
                updateRecord('Consultants', id, record);
            } else {
                saveRecord('Consultants', record);
            }
            
            toast('Saved!', 'success');
            renderConsultants();
        }
        
        async function deleteConsultant(id) {
            const confirmed = await appConfirmDanger('Delete this consultant?', 'Delete Consultant');
            if (!confirmed) return;
            deleteRecord('Consultants', id);
            renderConsultants();
            toast('Deleted', 'success');
        }
        
        function loadConsultantSignature() {
            const selectedId = $('yConsultantSelect').value;
            const consultant = data.consultants.find(c => c.ID == selectedId);
            
            if (consultant && consultant.Signature && sigPadConsultant) {
                const img = new Image();
                img.onload = () => {
                    sigPadConsultant.ctx.fillStyle = 'white';
                    sigPadConsultant.ctx.fillRect(0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                    sigPadConsultant.ctx.drawImage(img, 0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                    $('consultantSigNote').textContent = consultant.Name + "'s signature loaded";
                    $('sigTimeConsultant').textContent = new Date().toLocaleString();
                };
                img.src = consultant.Signature;
                currentOrder.consultant = consultant.Name;
            } else if (sigPadConsultant) {
                sigPadConsultant.ctx.fillStyle = 'white';
                sigPadConsultant.ctx.fillRect(0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                $('consultantSigNote').textContent = 'Select consultant above to load signature';
                $('sigTimeConsultant').textContent = '';
            }
        }

        // ========== CONSULTATION ==========
        function openClient(id, fromHistory = false) {
            const c = getClient(id);
            if (!c) return;
            currentClient = c;
            $('cAvatar').textContent = initials(c.FirstName, c.LastName);
            
            // Show Said Yes icon if client said yes OR has orders
            const hasOrders = data.orders.some(o => String(o.ClientID) === String(c.ID));
            const saidYes = c.SaidYes === 'TRUE' || c.SaidYes === true || hasOrders;
            const saidYesIcon = saidYes ? ' üíç' : '';
            $('cName').textContent = c.FirstName + ' ' + c.LastName + saidYesIcon;
            
            let metaText = `Wedding: ${fmtDate(c.WeddingDate)} ¬∑ ${c.Venue || 'Venue TBD'}`;
            if (c.DestinationWedding === true || c.DestinationWedding === 'TRUE') {
                metaText += ' ¬∑ ‚úàÔ∏è Destination';
                if (c.LeavingDate) {
                    metaText += ` (Leaving: ${fmtDate(c.LeavingDate)})`;
                }
            }
            $('cMeta').textContent = metaText;
            
            $('cStyle').value = c.StylePreferences || '';
            $('cNotes').value = c.Notes || '';
            $('cBudget').value = c.Budget || '';
            
            // Save original values to detect unsaved changes
            originalClientNotes = {
                style: c.StylePreferences || '',
                notes: c.Notes || '',
                budget: c.Budget || ''
            };
            
            // Check for saved draft
            $('draftIndicator').style.display = hasDraft(c.ID) ? 'inline' : 'none';
            
            // Track page history
            if (!fromHistory && pageHistory[pageHistory.length - 1] !== 'consult') {
                pageHistory.push('consult');
                if (pageHistory.length > 20) pageHistory.shift();
            }
            
            renderTimeline();
            renderClientAppts();
            renderClientOptions();
            renderClientPhotos();
            renderClientMeasurements();
            renderVisitHistory();
            showPage('consult', true); // true = skip unsaved check since we're opening
            updateFloatingBackButton();
            
            // Scroll to top of page
            window.scrollTo(0, 0);
            $('page-consult')?.scrollTo(0, 0);
        }
        
        function hasUnsavedClientNotes() {
            if (!currentClient) return false;
            return $('cStyle').value !== originalClientNotes.style ||
                   $('cNotes').value !== originalClientNotes.notes ||
                   $('cBudget').value !== originalClientNotes.budget;
        }

        function toggleDesignerTable() {
            const wrap = $('designerTableWrap');
            const btn = $('tlToggle');
            if (wrap.style.display === 'none') {
                wrap.style.display = 'block';
                btn.textContent = 'Designer Rush Fees ‚ñ≤';
            } else {
                wrap.style.display = 'none';
                btn.textContent = 'Designer Rush Fees ‚ñº';
            }
        }
        
        // Designer rush fee data - hardcoded for reliability
        const DESIGNER_RUSH_DATA = [
            {
                name: 'Vivienne Westwood',
                standard: 5,
                rushTiers: [
                    { months: 3, fee: '$3,800 extra', note: 'Inquiry required, not guaranteed' }
                ],
                belowMin: { fee: '$4,600 extra', note: 'Inquiry required, not guaranteed' },
                minMonths: 3
            },
            {
                name: 'Netta BenShabu',
                standard: 7,
                rushTiers: [
                    { months: 6, fee: '10% rush' },
                    { months: 5, fee: '20% rush' }
                ],
                belowMin: { note: 'Inquiry required, may be possible with higher rush' },
                minMonths: 5
            },
            {
                name: 'Stephane Rolland',
                standard: 2,
                rushTiers: [],
                belowMin: { note: 'Inquiry required, may not be possible' },
                minMonths: 2
            },
            {
                name: 'Enaura Bridal',
                standard: 4,
                rushTiers: [
                    { months: 3, fee: '10% rush' },
                    { months: 2, fee: '20% rush' }
                ],
                belowMin: { note: 'Inquiry required, most likely possible' },
                minMonths: 2
            },
            {
                name: 'Nicole + Felicia',
                standard: 4,
                rushTiers: [
                    { months: 3, fee: '10% rush' },
                    { months: 2, fee: '20% rush' }
                ],
                belowMin: { note: 'Inquiry required, most likely possible' },
                minMonths: 2
            },
            {
                name: 'Rosa Clara',
                standard: 4,
                rushTiers: [],
                belowMin: { note: 'Inquiry required, most likely possible' },
                minMonths: 4
            },
            {
                name: 'Tania Olsen',
                standard: 4,
                rushTiers: [],
                belowMin: { note: 'Inquiry required, most likely NOT possible' },
                minMonths: 4
            },
            {
                name: 'Lihi Hod',
                standard: 5,
                rushTiers: [],
                belowMin: { note: 'Inquiry required' },
                minMonths: 5
            }
        ];
        
        // Load designers from localStorage or use defaults
        let designerData = [];
        function loadDesignerData() {
            const saved = localStorage.getItem('estrelle_designers');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Make sure we have valid data with items
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        designerData = parsed;
                    } else {
                        designerData = [...DEFAULT_DESIGNER_DATA];
                    }
                } catch (e) {
                    designerData = [...DEFAULT_DESIGNER_DATA];
                }
            } else {
                designerData = [...DEFAULT_DESIGNER_DATA];
            }
            
            // Deduplicate ‚Äî keep the last (most recently added/edited) entry for each name
            const beforeCount = designerData.length;
            const seen = new Map();
            designerData.forEach((d, i) => {
                const key = d.name.trim().toLowerCase();
                seen.set(key, i); // last occurrence wins
            });
            if (seen.size < designerData.length) {
                const keepIndices = new Set(seen.values());
                designerData = designerData.filter((_, i) => keepIndices.has(i));
                console.log(`Deduped designers: ${beforeCount} ‚Üí ${designerData.length}`);
                saveDesignerData(); // Persist the cleanup
            }
            
            // Merge any new default designers that aren't in localStorage yet
            const existingNames = new Set(designerData.map(d => d.name.trim().toLowerCase()));
            let added = 0;
            for (const def of DEFAULT_DESIGNER_DATA) {
                if (!existingNames.has(def.name.trim().toLowerCase())) {
                    designerData.push({ ...def });
                    existingNames.add(def.name.trim().toLowerCase());
                    added++;
                }
            }
            if (added > 0) {
                console.log(`Merged ${added} new default designer(s) into localStorage`);
                saveDesignerData();
            }
            
            console.log('Loaded designerData:', designerData.length, 'designers');
        }
        function saveDesignerData() {
            localStorage.setItem('estrelle_designers', JSON.stringify(designerData));
        }
        
        // Rename constant to DEFAULT
        const DEFAULT_DESIGNER_DATA = DESIGNER_RUSH_DATA;
        
        // Initialize on load
        loadDesignerData();

        function renderTimeline() {
            updateTimeline();
        }
        
        function updateTimeline() {
            const c = currentClient;
            
            // Use LeavingDate for destination weddings, otherwise WeddingDate
            const targetDate = c.LeavingDate || c.WeddingDate;
            const isDestination = !!c.LeavingDate;
            
            const timeInfo = timeUntilWedding(targetDate);
            const totalMonths = timeInfo ? timeInfo.months : null;
            const altMonths = parseInt($('tlAltMonths').value) || 4;
            
            // Show alteration warning
            $('altWarning').style.display = altMonths < 3 ? 'block' : 'none';
            
            // Calculate production months (total - alterations)
            const prodMonths = totalMonths !== null ? Math.max(0, totalMonths - altMonths) : null;
            
            // Update label based on destination wedding
            $('tlLabel').textContent = isDestination ? 'Departs In' : 'Wedding In';
            
            // Display months and weeks
            if (timeInfo) {
                if (timeInfo.months === 0 && timeInfo.weeks === 0) {
                    $('tlMonths').textContent = 'This week!';
                } else if (timeInfo.months === 0) {
                    $('tlMonths').textContent = `${timeInfo.weeks}w`;
                } else if (timeInfo.weeks === 0) {
                    $('tlMonths').textContent = `${timeInfo.months}m`;
                } else {
                    $('tlMonths').textContent = `${timeInfo.months}m ${timeInfo.weeks}w`;
                }
            } else {
                $('tlMonths').textContent = '‚Äî';
            }
            
            // Count statuses
            let okCount = 0, rushCount = 0, inquireCount = 0;
            
            const rows = designerData.map(d => {
                let statusBadge, statusText, rushInfo;
                
                // Build rush fee description
                let rushDesc = '';
                if (d.rushTiers.length > 0) {
                    rushDesc = d.rushTiers.map(t => `${t.months}mo: ${t.fee}`).join('<br>');
                }
                if (d.belowMin) {
                    const belowText = d.belowMin.fee ? `<${d.minMonths}mo: ${d.belowMin.fee}` : `<${d.minMonths}mo: Inquire`;
                    rushDesc += (rushDesc ? '<br>' : '') + `<span style="color:var(--rose)">${belowText}</span>`;
                }
                if (!rushDesc) rushDesc = '‚Äî';
                
                // Determine status for this client's timeline
                if (prodMonths === null) {
                    statusBadge = 'confirm';
                    statusText = 'Set date';
                } else if (prodMonths >= d.standard) {
                    statusBadge = 'ok';
                    statusText = '‚úì No rush';
                    okCount++;
                } else {
                    // Check rush tiers
                    let foundTier = null;
                    for (const t of d.rushTiers) {
                        if (prodMonths >= t.months) {
                            foundTier = t;
                            break;
                        }
                    }
                    
                    if (foundTier) {
                        statusBadge = foundTier.fee.includes('20') ? 'high' : 'warn';
                        statusText = foundTier.fee;
                        rushCount++;
                    } else if (prodMonths < d.minMonths || d.rushTiers.length === 0 && prodMonths < d.standard) {
                        statusBadge = 'confirm';
                        statusText = '‚ö†Ô∏è Rush (Inquire)';
                        inquireCount++;
                    } else {
                        statusBadge = 'confirm';
                        statusText = '‚ö†Ô∏è Rush (Inquire)';
                        inquireCount++;
                    }
                }
                
                return `<tr>
                    <td style="font-weight:500">${d.name}</td>
                    <td>${d.standard} months</td>
                    <td style="font-size:10px;line-height:1.4">${rushDesc}</td>
                    <td><span class="rush-badge ${statusBadge}">${statusText}</span></td>
                </tr>`;
            });
            
            // Summary text
            let summary = '';
            if (totalMonths === null) {
                summary = '<span style="color:var(--rose)">‚ö†Ô∏è Set wedding date</span>';
            } else if (prodMonths <= 0) {
                summary = '<span style="color:#c00">‚ùå Not enough time</span>';
            } else if (rushCount > 0 || inquireCount > 0) {
                const parts = [];
                if (okCount > 0) parts.push(`<span style="color:var(--sage)">‚úì ${okCount} OK</span>`);
                if (rushCount > 0) parts.push(`<span style="color:#e67e22">‚ö† ${rushCount} rush</span>`);
                if (inquireCount > 0) parts.push(`<span style="color:var(--rose)">‚ö† ${inquireCount} rush (inquire)</span>`);
                summary = parts.join('<br>');
            } else {
                summary = `<span style="color:var(--sage)">‚úì All ${okCount} designers OK</span>`;
            }
            $('tlSummary').innerHTML = summary;
            
            $('rushBody').innerHTML = rows.join('');
        }

        function renderClientAppts() {
            if (!currentClient) return;
            const appts = data.appointments.filter(a => a.ClientID == currentClient.ID).sort((a,b) => (b.Date||'').localeCompare(a.Date||''));
            $('cAppts').innerHTML = appts.length ? appts.map(a => {
                const photos = a.Photos ? (typeof a.Photos === 'string' ? JSON.parse(a.Photos || '[]') : a.Photos) : [];
                const photoCount = Array.isArray(photos) ? photos.length : 0;
                const isNoShow = a.Status === 'no-show';
                const isUpcoming = getDateStr(a.Date) >= today();
                const rescheduledFrom = a.RescheduledFrom;
                
                return `
                <div class="appt-item appt-type-${normalizeApptType(a.Type).toLowerCase().replace(/\s+/g, '-')}" style="cursor:pointer;${isNoShow ? 'opacity:0.5;background:#f5f5f5;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div onclick="viewAppt('${a.ID}')" style="flex:1;min-width:0">
                            <div class="appt-date">
                                ${fmtDate(a.Date)} at ${fmtTime(a.Time)}
                                ${photoCount > 0 ? ` <span style="font-size:10px;color:var(--sage)">üì∑${photoCount}</span>` : ''}
                                ${isNoShow ? ' <span style="font-size:10px;color:var(--red);font-weight:600">NO-SHOW</span>' : ''}
                                ${a.ConfirmationSent ? ` <span class="confirmed-badge" onclick="event.stopPropagation();unmarkConfirmed('${a.ID}')" style="cursor:pointer" title="Click to undo">‚úì</span>` : ''}
                            </div>
                            <div class="appt-meta">${normalizeApptType(a.Type)} ¬∑ ${a.Consultant||''}</div>
                            ${rescheduledFrom ? `<div style="font-size:9px;color:var(--taupe);margin-top:2px">‚Ü©Ô∏è Rescheduled from ${rescheduledFrom}</div>` : ''}
                        </div>
                        <div class="appt-actions" onclick="event.stopPropagation()">
                            <!-- Desktop: Simplified buttons -->
                            <div class="appt-desktop-actions">
                                <button class="action-btn" onclick="editAppt('${a.ID}')" title="Edit">‚úèÔ∏è</button>
                                <button class="action-btn" onclick="showApptActions(${a.ID}, ${isNoShow}, ${isUpcoming}, ${a.ConfirmationSent || false})" title="More">‚ãØ</button>
                            </div>
                            <!-- Mobile: Same as desktop now -->
                            <div class="appt-mobile-actions">
                                <button class="action-btn" onclick="editAppt('${a.ID}')" title="Edit">‚úèÔ∏è</button>
                                <button class="action-btn" onclick="showApptActions(${a.ID}, ${isNoShow}, ${isUpcoming}, ${a.ConfirmationSent || false})" title="More">‚ãØ</button>
                            </div>
                        </div>
                    </div>
                    ${a.Notes ? `<div class="appt-notes" style="margin-top:6px;padding-top:6px;border-top:1px dashed var(--champagne)" onclick="viewAppt('${a.ID}')">${a.Notes}</div>` : `<div style="font-size:10px;color:var(--champagne);margin-top:4px;font-style:italic" onclick="editAppt('${a.ID}')">Click to add notes</div>`}
                </div>`;
            }).join('') : '<div class="empty">No appointments</div>';
        }
        
        // Mobile action sheet for appointments
        function showApptActions(apptId, isNoShow, isUpcoming, isConfirmed) {
            const actions = [];
            
            if (!isNoShow && isUpcoming) {
                actions.push({ label: 'üìÖ Reschedule', action: () => { rescheduleAppt(apptId); closeActionSheet(); } });
            }
            
            if (!isNoShow) {
                actions.push({ label: 'üö´ Mark No-Show', action: () => { markNoShow(apptId); closeActionSheet(); } });
            }
            
            actions.push({ label: 'üóë Delete', action: () => { deleteApptConfirm(apptId); closeActionSheet(); }, danger: true });
            
            showActionSheet(actions);
        }
        
        // Dashboard action sheet for Today's Appointments (no delete - it's already visible)
        function showDashApptActions(apptId, event) {
            closeDropdown(); // Close any existing dropdown
            
            const btn = event.target;
            const rect = btn.getBoundingClientRect();
            
            // Create overlay to catch outside clicks
            const overlay = document.createElement('div');
            overlay.className = 'dropdown-overlay';
            overlay.id = 'dropdownOverlay';
            overlay.onclick = closeDropdown;
            document.body.appendChild(overlay);
            
            // Create dropdown menu
            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';
            menu.id = 'dropdownMenu';
            menu.innerHTML = `
                <button class="dropdown-item" onclick="rescheduleAppt(${apptId}); closeDropdown();">üìÖ Reschedule</button>
                <button class="dropdown-item" onclick="markNoShow(${apptId}); closeDropdown();">üö´ Mark No-Show</button>
            `;
            
            document.body.appendChild(menu);
            
            // Position near button
            const menuRect = menu.getBoundingClientRect();
            let top = rect.bottom + 4;
            let left = rect.right - menuRect.width;
            
            // Keep within viewport
            if (top + menuRect.height > window.innerHeight) {
                top = rect.top - menuRect.height - 4;
            }
            if (left < 8) left = 8;
            
            menu.style.top = top + 'px';
            menu.style.left = left + 'px';
        }
        
        function closeDropdown() {
            const menu = $('dropdownMenu');
            const overlay = $('dropdownOverlay');
            if (menu) menu.remove();
            if (overlay) overlay.remove();
        }
        
        function showActionSheet(actions) {
            let sheet = $('actionSheet');
            if (!sheet) {
                const div = document.createElement('div');
                div.id = 'actionSheet';
                div.className = 'action-sheet-overlay';
                div.innerHTML = '<div class="action-sheet"><div class="action-sheet-items"></div><button class="action-sheet-cancel" onclick="closeActionSheet()">Cancel</button></div>';
                div.onclick = (e) => { if (e.target === div) closeActionSheet(); };
                document.body.appendChild(div);
                sheet = div;
            }
            
            // Store actions globally so we can call them by index
            window._actionSheetActions = actions;
            
            const itemsContainer = sheet.querySelector('.action-sheet-items');
            itemsContainer.innerHTML = actions.map((a, idx) => 
                `<button class="action-sheet-item ${a.danger ? 'danger' : ''}" onclick="window._actionSheetActions[${idx}].action()">${a.label}</button>`
            ).join('');
            
            sheet.classList.add('active');
        }
        
        function closeActionSheet() {
            const sheet = $('actionSheet');
            if (sheet) sheet.classList.remove('active');
        }
        
        async function markNoShow(id) {
            if (!confirm('Mark this appointment as no-show?')) return;
            
            const a = data.appointments.find(x => x.ID == id);
            if (!a) return;
            
            a.Status = 'no-show';
            await updateRecord('Appointments', id, { Status: 'no-show' });
            
            renderClientAppts();
            renderDash();
            toast('Marked as no-show', 'success');
        }
        
        function rescheduleAppt(id) {
            const a = data.appointments.find(x => x.ID == id);
            if (!a) return;
            
            // Store original date/time before editing
            const originalDateTime = `${fmtDate(a.Date)} at ${fmtTime(a.Time)}`;
            
            // Open edit modal
            editAppt(id);
            
            // Set flag to track this is a reschedule
            $('editApptId').dataset.rescheduleFrom = originalDateTime;
        }

        function addApptForClient() {
            populateApptModal(currentClient.ID);
            openModal('newAppt');
        }

        async function deleteApptConfirm(id) {
            console.log('deleteApptConfirm called with ID:', id, 'type:', typeof id);
            
            // Store for undo before removing
            const removedIdx = data.appointments.findIndex(a => String(a.ID) === String(id));
            console.log('Found appointment at index:', removedIdx);
            
            let removedAppt = null;
            if (removedIdx >= 0) {
                removedAppt = { ...data.appointments[removedIdx] };
                data.appointments.splice(removedIdx, 1);
                saveCachedData();
                
                // Add to undo stack
                addUndo({ type: 'delete_appointment', record: removedAppt });
                
                // Update UI
                renderClientAppts();
                renderWeek();
                renderAllAppointments();
                renderDash();
                toast('Appointment deleted', 'success', true);
                
                // Delete from server in background
                api('POST', { action: 'delete', sheet: 'Appointments', id }).catch(e => console.error('Delete API error:', e));
            } else {
                console.error('Appointment not found with ID:', id);
                console.log('Available IDs:', data.appointments.map(a => a.ID));
                toast('Could not find appointment', 'error');
            }
        }

        function populateOptionModal() {
            const dropdown = $('oDesigner');
            if (!dropdown) {
                console.error('Designer dropdown not found!');
                return;
            }
            
            // Reset to Add mode (editOption will override this)
            if (!$('editOptionId').value) {
                $('optionModalTitle').textContent = 'Add Top Option';
                $('optionSaveBtn').textContent = 'Add';
                ['oDesigner','oStyle','oCustom','oOptionNotes','oCustomDesigner','oDecisionBy','oSize','oPrice'].forEach(i => { if ($(i)) $(i).value = ''; });
                $('oFavorite').checked = false;
                $('editOptionId').value = '';
            }
            
            // Ensure designer data is loaded
            if (!designerData || designerData.length === 0) {
                loadDesignerData();
            }
            
            // Final fallback - use DESIGNER_RUSH_DATA directly
            const designers = (designerData && designerData.length > 0) ? designerData : DESIGNER_RUSH_DATA;
            
            // Deduplicate by name (case-insensitive) ‚Äî keeps first occurrence
            const seen = new Set();
            const uniqueDesigners = designers.filter(d => {
                const key = d.name.trim().toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
            
            console.log('populateOptionModal - using', uniqueDesigners.length, 'designers (deduped from', designers.length, ')');
            
            dropdown.innerHTML = '<option value="">Select designer...</option>' + 
                uniqueDesigners.map(d => `<option value="${d.name}">${d.name}</option>`).join('') +
                '<option value="custom">+ Custom Designer</option>';
            
            $('customDesignerGroup').style.display = 'none';
            if ($('oCustomDesigner')) $('oCustomDesigner').value = '';
        }

        function toggleCustomDesigner() {
            const isCustom = $('oDesigner').value === 'custom';
            $('customDesignerGroup').style.display = isCustom ? 'block' : 'none';
            if (isCustom) $('oCustomDesigner').focus();
        }

        function renderClientOptions() {
            const opts = data.topoptions.filter(o => o.ClientID == currentClient.ID);
            $('cOptions').innerHTML = opts.length ? opts.map(o => {
                const isLiked = o.IsFavorite === true || o.IsFavorite === 'TRUE';
                const priceText = o.Price ? money(o.Price) : '<span style="color:var(--taupe);font-style:italic">as listed</span>';
                return `
                <div class="option-card ${isLiked ? 'favorite' : ''}">
                    <div class="option-designer">${o.Designer} ‚Äî ${o.Style}</div>
                    <div class="option-style">${o.Size ? 'Size ' + o.Size + ' ¬∑ ' : ''}${priceText}</div>
                    ${o.Customizations ? `<div class="option-notes"><b>Custom:</b> ${o.Customizations}</div>` : ''}
                    ${o.DecisionBy ? `<div class="option-notes"><b>Decision by:</b> ${fmtDate(o.DecisionBy)}</div>` : ''}
                    ${o.Notes ? `<div class="option-notes">${o.Notes}</div>` : ''}
                    <div class="option-actions">
                        <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleFavorite(${o.ID})">${isLiked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}</button>
                        <button class="action-btn" onclick="editOption(${o.ID})">Edit</button>
                        <button class="action-btn" onclick="deleteOptionConfirm(${o.ID})">Delete</button>
                    </div>
                </div>`;
            }).join('') : '<div class="empty">No options</div>';
        }

        async function saveOption() {
            let designer = $('oDesigner').value;
            if (designer === 'custom') {
                designer = $('oCustomDesigner').value.trim();
                if (!designer) { toast('Enter custom designer name'); return; }
            }
            if (!designer) { toast('Select designer'); return; }
            
            const editId = $('editOptionId').value;
            const clientName = `${currentClient.FirstName} ${currentClient.LastName}`;
            
            // Parse price ‚Äî strip $ and commas
            let priceVal = $('oPrice').value.trim().replace(/[$,]/g, '');
            const price = priceVal ? parseFloat(priceVal) || 0 : '';
            
            const record = { 
                ClientID: currentClient.ID, 
                ClientName: clientName, 
                Designer: designer, 
                Style: $('oStyle').value, 
                Size: $('oSize').value.trim(),
                Price: price,
                Customizations: $('oCustom').value, 
                DecisionBy: $('oDecisionBy').value, 
                Notes: $('oOptionNotes').value, 
                IsFavorite: $('oFavorite').checked 
            };
            
            closeModal('addOption');
            
            if (editId) {
                // UPDATE existing option
                const existing = data.topoptions.find(o => String(o.ID) === String(editId));
                if (existing) {
                    Object.assign(existing, record);
                    saveCachedData();
                    renderClientOptions();
                    toast('Option updated!', 'success');
                    
                    // Update server in background
                    updateRecord('TopOptions', editId, record);
                }
            } else {
                // ADD new option
                const tempId = Date.now();
                const newRecord = { ...record, ID: tempId };
                data.topoptions.push(newRecord);
                saveCachedData();
                renderClientOptions();
                toast('Added!', 'success');
                
                // Send to server in background
                api('POST', { action: 'add', sheet: 'TopOptions', record })
                    .then(res => {
                        if (res && res.id) {
                            const idx = data.topoptions.findIndex(r => r.ID === tempId);
                            if (idx >= 0) data.topoptions[idx].ID = res.id;
                            saveCachedData();
                        }
                    })
                    .catch(e => {
                        const idx = data.topoptions.findIndex(r => r.ID === tempId);
                        if (idx >= 0) data.topoptions.splice(idx, 1);
                        saveCachedData();
                        renderClientOptions();
                        toast('Save failed', 'error');
                    });
            }
            
            // Clear form
            $('editOptionId').value = '';
            ['oDesigner','oStyle','oCustom','oOptionNotes','oCustomDesigner','oDecisionBy','oSize','oPrice'].forEach(i => $(i).value = '');
            $('oFavorite').checked = false;
            $('customDesignerGroup').style.display = 'none';
        }
        
        function editOption(id) {
            const opt = data.topoptions.find(o => o.ID == id);
            if (!opt) { toast('Option not found', 'error'); return; }
            
            // Set modal to edit mode
            $('optionModalTitle').textContent = 'Edit Top Option';
            $('optionSaveBtn').textContent = 'Save Changes';
            $('editOptionId').value = id;
            
            // Open modal (this also calls populateOptionModal which sets up designers)
            openModal('addOption');
            
            // Populate fields after a tick to ensure dropdown is populated
            setTimeout(() => {
                // Check if designer is in dropdown, otherwise use custom
                const dropdown = $('oDesigner');
                const designerInList = Array.from(dropdown.options).some(o => o.value === opt.Designer);
                
                if (designerInList) {
                    dropdown.value = opt.Designer;
                    $('customDesignerGroup').style.display = 'none';
                } else {
                    dropdown.value = 'custom';
                    $('oCustomDesigner').value = opt.Designer;
                    $('customDesignerGroup').style.display = 'block';
                }
                
                $('oStyle').value = opt.Style || '';
                $('oSize').value = opt.Size || '';
                $('oPrice').value = opt.Price ? money(opt.Price).replace('$', '') : '';
                $('oCustom').value = opt.Customizations || '';
                $('oDecisionBy').value = opt.DecisionBy || '';
                $('oOptionNotes').value = opt.Notes || '';
                $('oFavorite').checked = (opt.IsFavorite === true || opt.IsFavorite === 'TRUE');
            }, 50);
        }
        
        function formatOptionPrice(input) {
            let val = input.value.trim();
            if (!val) return;
            val = val.replace(/[$,]/g, '');
            const num = parseFloat(val);
            if (!isNaN(num) && num > 0) {
                input.value = num.toLocaleString();
            }
        }

        async function toggleFavorite(id) {
            const opt = data.topoptions.find(o => o.ID == id);
            if (!opt) return;
            const newValue = !(opt.IsFavorite === true || opt.IsFavorite === 'TRUE');
            opt.IsFavorite = newValue ? 'TRUE' : '';
            saveCachedData();
            updateRecord('TopOptions', id, { IsFavorite: newValue });
            renderClientOptions();
        }

        async function deleteOptionConfirm(id) {
            // Find and save option for undo
            const option = data.topoptions.find(o => o.ID == id);
            if (!option) return;
            
            const optionCopy = { ...option };
            
            // Remove from local data
            const idx = data.topoptions.findIndex(o => o.ID == id);
            if (idx >= 0) data.topoptions.splice(idx, 1);
            
            saveCachedData();
            renderClientOptions();
            
            // Add to undo stack
            addUndo({ type: 'delete_topoption', record: optionCopy });
            
            toast('Option deleted', 'success', true);
            
            // Delete from server in background
            api('POST', { action: 'delete', sheet: 'TopOptions', id }).catch(() => {});
        }

        // ========== CLIENT PHOTOS ==========
        function renderClientPhotos() {
            if (!currentClient) return;
            
            let photos = [];
            if (currentClient.Photos) {
                try {
                    photos = typeof currentClient.Photos === 'string' ? JSON.parse(currentClient.Photos) : currentClient.Photos;
                } catch (e) {
                    photos = [];
                }
            }
            
            $('cPhotos').innerHTML = photos.length ? photos.map((url, idx) => `
                <div style="position:relative;border-radius:6px;overflow:hidden;aspect-ratio:1;background:var(--cream);cursor:pointer" onclick="viewPhoto('${url}')">
                    <img src="${url}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:var(--rose);font-size:10px\\'>Failed</div>'">
                    <button onclick="event.stopPropagation();deleteClientPhoto(${idx})" style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.5);color:white;border:none;width:20px;height:20px;border-radius:50%;cursor:pointer;font-size:12px">√ó</button>
                </div>
            `).join('') : '<div class="empty" style="grid-column:1/-1">No photos yet</div>';
        }
        
        function viewPhoto(url) {
            window.open(url, '_blank');
        }
        
        async function deleteClientPhoto(idx) {
            const confirmed = await appConfirmDanger('Delete this photo?', 'Delete Photo');
            if (!confirmed) return;
            
            let photos = [];
            try {
                photos = typeof currentClient.Photos === 'string' ? JSON.parse(currentClient.Photos) : currentClient.Photos;
            } catch (e) {
                return;
            }
            
            photos.splice(idx, 1);
            updateRecord('Clients', currentClient.ID, { Photos: JSON.stringify(photos) });
            currentClient.Photos = JSON.stringify(photos);
            renderClientPhotos();
            toast('Photo deleted', 'success');
        }
        
        function openPhotoUpload() {
            // Create a quick file input for direct upload
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = async (e) => {
                const files = Array.from(e.target.files);
                toast('Uploading...', 'success');
                
                let uploadedUrls = [];
                for (const file of files) {
                    if (!file.type.startsWith('image/')) continue;
                    if (file.size > 10 * 1024 * 1024) {
                        toast(`${file.name} too large`, 'error');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    const dataUrl = await new Promise(resolve => {
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(file);
                    });
                    
                    try {
                        const result = await api('POST', {
                            action: 'uploadPhoto',
                            clientId: currentClient.ID,
                            clientName: `${currentClient.FirstName}_${currentClient.LastName}`,
                            fileName: file.name,
                            data: dataUrl
                        });
                        if (result && result.url) uploadedUrls.push(result.url);
                    } catch (err) {
                        console.error('Upload error:', err);
                    }
                }
                
                if (uploadedUrls.length > 0) {
                    let existing = [];
                    try {
                        existing = currentClient.Photos ? (typeof currentClient.Photos === 'string' ? JSON.parse(currentClient.Photos) : currentClient.Photos) : [];
                    } catch (e) {}
                    
                    const allPhotos = [...existing, ...uploadedUrls];
                    updateRecord('Clients', currentClient.ID, { Photos: JSON.stringify(allPhotos) });
                    currentClient.Photos = JSON.stringify(allPhotos);
                    renderClientPhotos();
                    toast(`${uploadedUrls.length} photo(s) uploaded!`, 'success');
                }
            };
            input.click();
        }

        // ========== MEASUREMENTS ==========
        let measModalUnit = 'in';
        let modalCustomMeasurements = [];
        
        function getClientMeasurements() {
            if (!currentClient) return [];
            try {
                const meas = currentClient.MeasurementHistory;
                if (!meas) return [];
                return typeof meas === 'string' ? JSON.parse(meas) : meas;
            } catch (e) {
                return [];
            }
        }
        
        function renderClientMeasurements() {
            const measurements = getClientMeasurements();
            
            if (measurements.length === 0) {
                $('cMeasurements').innerHTML = '<div class="empty">No measurements recorded yet</div>';
                return;
            }
            
            // Sort by date, most recent first
            measurements.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            
            $('cMeasurements').innerHTML = measurements.map((m, idx) => {
                const unit = m.unit || 'in';
                const customHtml = (m.custom && m.custom.length > 0) ? 
                    `<div style="margin-top:6px;padding-top:6px;border-top:1px dashed var(--champagne);display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:11px">
                        ${m.custom.map(c => `<div><span style="color:var(--taupe)">${c.name}:</span> ${c.value}</div>`).join('')}
                    </div>` : '';
                return `
                <div style="background:var(--cream);padding:10px;border-radius:5px;margin-bottom:8px;position:relative;cursor:pointer" onclick="editMeasurement(${idx})">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div style="font-weight:600;font-size:12px">üìÖ ${fmtDate(m.date)}${m.takenBy ? ` <span style="font-weight:400;color:var(--taupe)">by ${m.takenBy}</span>` : ''}</div>
                        <div style="display:flex;gap:4px" onclick="event.stopPropagation()">
                            <button class="action-btn" onclick="editMeasurement(${idx})" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="deleteMeasurement(${idx})" title="Delete">√ó</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:11px">
                        <div><span style="color:var(--taupe)">Bust:</span> ${m.bust || '‚Äî'} ${m.bust ? unit : ''}</div>
                        <div><span style="color:var(--taupe)">Cup:</span> ${m.cup || '‚Äî'}</div>
                        <div><span style="color:var(--taupe)">Waist:</span> ${m.waist || '‚Äî'} ${m.waist ? unit : ''}</div>
                        <div><span style="color:var(--taupe)">Hip:</span> ${m.hip || '‚Äî'} ${m.hip ? unit : ''}</div>
                        <div><span style="color:var(--taupe)">Height:</span> ${m.height || '‚Äî'} ${m.height ? 'in' : ''}</div>
                        <div><span style="color:var(--taupe)">Heels:</span> ${m.heels || '‚Äî'} ${m.heels ? 'in' : ''}</div>
                        <div><span style="color:var(--taupe)">WtF:</span> ${m.waistToFloor || '‚Äî'} ${m.waistToFloor ? unit : ''}</div>
                    </div>
                    ${customHtml}
                    ${m.notes ? `<div style="font-size:10px;color:var(--taupe);margin-top:6px;font-style:italic">${m.notes}</div>` : ''}
                </div>`;
            }).join('');
        }
        
        let editingMeasurementIdx = null;
        
        function openAddMeasurementModal() {
            editingMeasurementIdx = null;
            $('measDate').value = today();
            $('measBust').value = '';
            $('measCup').value = '';
            $('measWaist').value = '';
            $('measHip').value = '';
            $('measHeight').value = '';
            $('measHeels').value = '';
            $('measWaistToFloor').value = '';
            $('measNotes').value = '';
            $('modalCustomMeasName').value = '';
            $('modalCustomMeasValue').value = '';
            modalCustomMeasurements = [];
            renderModalCustomMeas();
            measModalUnit = 'in';
            updateMeasModalUnitDisplay();
            
            // Populate Taken By dropdown
            $('measTakenBy').innerHTML = '<option value="">Select...</option>' +
                data.consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            $('measTakenBy').value = '';
            
            // Update modal title
            document.querySelector('#modal-addMeasurement .modal-title').textContent = 'üìè Add Measurements';
            
            openModal('addMeasurement');
        }
        
        function editMeasurement(idx) {
            const measurements = getClientMeasurements();
            measurements.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const m = measurements[idx];
            if (!m) return;
            
            editingMeasurementIdx = idx;
            
            // Populate fields with existing data
            $('measDate').value = m.date || today();
            $('measBust').value = m.bust || '';
            $('measCup').value = m.cup || '';
            $('measWaist').value = m.waist || '';
            $('measHip').value = m.hip || '';
            $('measHeight').value = m.height || '';
            $('measHeels').value = m.heels || '';
            $('measWaistToFloor').value = m.waistToFloor || '';
            $('measNotes').value = m.notes || '';
            
            // Set unit
            measModalUnit = m.unit || 'in';
            updateMeasModalUnitDisplay();
            
            // Load custom measurements
            modalCustomMeasurements = m.custom ? [...m.custom] : [];
            renderModalCustomMeas();
            
            // Populate and set Taken By dropdown
            $('measTakenBy').innerHTML = '<option value="">Select...</option>' +
                data.consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            $('measTakenBy').value = m.takenBy || '';
            
            // Update modal title
            document.querySelector('#modal-addMeasurement .modal-title').textContent = 'üìè Edit Measurements';
            
            openModal('addMeasurement');
        }
        
        function setMeasModalUnit(unit) {
            measModalUnit = unit;
            updateMeasModalUnitDisplay();
        }
        
        function updateMeasModalUnitDisplay() {
            document.querySelectorAll('[data-meas-unit]').forEach(el => el.textContent = measModalUnit);
            $('measUnitCm').className = measModalUnit === 'cm' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('measUnitIn').className = measModalUnit === 'in' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('measUnitIn').style.background = measModalUnit === 'in' ? 'var(--charcoal)' : '';
            $('measUnitIn').style.color = measModalUnit === 'in' ? 'white' : '';
            $('measUnitCm').style.background = measModalUnit === 'cm' ? 'var(--charcoal)' : '';
            $('measUnitCm').style.color = measModalUnit === 'cm' ? 'white' : '';
        }
        
        function addModalCustomMeas() {
            const name = $('modalCustomMeasName').value.trim();
            const value = $('modalCustomMeasValue').value.trim();
            if (!name || !value) {
                toast('Enter name and value', 'error');
                return;
            }
            modalCustomMeasurements.push({ name, value });
            $('modalCustomMeasName').value = '';
            $('modalCustomMeasValue').value = '';
            renderModalCustomMeas();
        }
        
        function removeModalCustomMeas(idx) {
            modalCustomMeasurements.splice(idx, 1);
            renderModalCustomMeas();
        }
        
        function renderModalCustomMeas() {
            $('modalCustomMeasList').innerHTML = modalCustomMeasurements.map((m, idx) => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--blush);border-radius:4px;margin-bottom:4px;font-size:11px">
                    <span>${m.name}: ${m.value}</span>
                    <button class="action-btn" onclick="removeModalCustomMeas(${idx})" style="font-size:10px">√ó</button>
                </div>
            `).join('');
        }
        
        async function saveMeasurement() {
            // Validate Taken By is required
            if (!$('measTakenBy').value) {
                toast('Please select who took the measurements', 'error');
                return;
            }
            
            const measurement = {
                date: $('measDate').value || today(),
                takenBy: $('measTakenBy').value,
                bust: $('measBust').value.trim(),
                cup: $('measCup').value.trim(),
                waist: $('measWaist').value.trim(),
                hip: $('measHip').value.trim(),
                height: $('measHeight').value.trim(),
                heels: $('measHeels').value.trim(),
                waistToFloor: $('measWaistToFloor').value.trim(),
                notes: $('measNotes').value.trim(),
                unit: measModalUnit,
                custom: [...modalCustomMeasurements]
            };
            
            // Build summary for confirmation
            const summary = [
                measurement.bust ? `Bust: ${measurement.bust}` : '',
                measurement.waist ? `Waist: ${measurement.waist}` : '',
                measurement.hip ? `Hip: ${measurement.hip}` : '',
                measurement.height ? `Height: ${measurement.height}` : '',
                measurement.waistToFloor ? `WtF: ${measurement.waistToFloor}` : '',
                measurement.heels ? `Heels: ${measurement.heels}` : ''
            ].filter(Boolean).join(', ');
            
            const action = editingMeasurementIdx !== null ? 'update' : 'save';
            const confirmMsg = `${summary}\n\nTaken by: ${measurement.takenBy}\nDate: ${fmtDate(measurement.date)}`;
            
            const confirmed = await appConfirm(confirmMsg, action === 'update' ? 'Confirm Update' : 'Confirm Save');
            if (!confirmed) return;
            
            // Get existing measurements (sorted by date desc)
            const measurements = getClientMeasurements();
            measurements.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            
            if (editingMeasurementIdx !== null) {
                // Update existing measurement
                measurements[editingMeasurementIdx] = measurement;
                toast('Measurements updated!', 'success');
            } else {
                // Add new measurement
                measurements.push(measurement);
                toast('Measurements saved!', 'success');
            }
            
            // Save to client
            await updateRecord('Clients', currentClient.ID, { MeasurementHistory: JSON.stringify(measurements) });
            currentClient.MeasurementHistory = JSON.stringify(measurements);
            
            editingMeasurementIdx = null;
            closeModal('addMeasurement');
            renderClientMeasurements();
        }
        
        // Save measurements from Say Yes modal (Step 1) to client's history
        async function saveMeasurementsFromSayYes() {
            // Validate Taken By is required
            if (!$('mTakenBy').value) {
                toast('Please select who took the measurements', 'error');
                return;
            }
            
            // Check if there's at least some measurement data
            const hasMeasurements = $('mBust').value || $('mWaist').value || $('mHip').value || 
                                   $('mHeight').value || $('mWaistToFloor').value;
            if (!hasMeasurements) {
                toast('Please enter at least one measurement', 'error');
                return;
            }
            
            const measurement = {
                date: today(),
                takenBy: $('mTakenBy').value,
                bust: $('mBust').value.trim(),
                cup: $('mCup').value.trim(),
                waist: $('mWaist').value.trim(),
                hip: $('mHip').value.trim(),
                height: $('mHeight').value.trim(),
                heels: $('mHeels').value.trim(),
                waistToFloor: $('mWaistToFloor').value.trim(),
                notes: $('mNotes').value.trim(),
                unit: measUnit,
                custom: [...customMeasurements],
                source: 'order'
            };
            
            // Build summary for confirmation
            const summary = [
                measurement.bust ? `B: ${measurement.bust}` : '',
                measurement.waist ? `W: ${measurement.waist}` : '',
                measurement.hip ? `H: ${measurement.hip}` : ''
            ].filter(Boolean).join(' / ');
            
            const confirmed = await appConfirm(
                `Save these measurements to ${currentClient.FirstName}'s profile?\n\n${summary}\nTaken by: ${measurement.takenBy}`,
                'Save Measurements'
            );
            if (!confirmed) return;
            
            // Get existing measurements
            const measurements = getClientMeasurements();
            measurements.push(measurement);
            
            // Save to client
            await updateRecord('Clients', currentClient.ID, { MeasurementHistory: JSON.stringify(measurements) });
            currentClient.MeasurementHistory = JSON.stringify(measurements);
            
            // Also store in currentOrder so it persists
            currentOrder.measurements = { ...measurement };
            currentOrder.measurementsSaved = true;
            
            toast('Measurements saved to client profile!', 'success');
            
            // Update the dropdown to show the new measurement
            populateSavedMeasurementsDropdown();
        }
        
        async function deleteMeasurement(idx) {
            const confirmed = await appConfirmDanger('Delete this measurement record?', 'Delete Measurement');
            if (!confirmed) return;
            
            const measurements = getClientMeasurements();
            const deletedMeasurement = measurements[idx];
            const deletedIdx = idx;
            
            measurements.splice(idx, 1);
            
            await updateRecord('Clients', currentClient.ID, { MeasurementHistory: JSON.stringify(measurements) });
            currentClient.MeasurementHistory = JSON.stringify(measurements);
            
            renderClientMeasurements();
            toast('Measurement deleted', 'success', true);
            
            // Add undo
            addUndo({
                type: 'delete_measurement',
                clientId: currentClient.ID,
                measurement: deletedMeasurement,
                idx: deletedIdx
            });
        }
        
        async function undoDeleteMeasurement(clientId, measurement, idx) {
            const client = data.clients.find(c => c.ID == clientId);
            if (!client) return;
            
            let measurements = [];
            try {
                measurements = client.MeasurementHistory ? JSON.parse(client.MeasurementHistory) : [];
            } catch (e) {
                measurements = [];
            }
            
            // Insert back at original position
            measurements.splice(idx, 0, measurement);
            
            await updateRecord('Clients', clientId, { MeasurementHistory: JSON.stringify(measurements) });
            client.MeasurementHistory = JSON.stringify(measurements);
            
            if (currentClient && currentClient.ID == clientId) {
                currentClient.MeasurementHistory = JSON.stringify(measurements);
                renderClientMeasurements();
            }
            
            toast('Measurement restored', 'success');
        }

        // ========== TIMELY IMPORT ==========
        let timelyImportData = [];
        let timelyAllAppointments = []; // Track ALL appointments in file (including skipped) for delete logic
        
        const SERVICE_TYPE_MAP = {
            'signature bridal consultation': 'consultation',
            'bridal fitting appointment': 'fitting',
            'final fitting': 'final fitting',
            'pickup': 'pickup'
        };
        
        function mapServiceType(timelyService) {
            const lower = (timelyService || '').toLowerCase();
            for (const [key, value] of Object.entries(SERVICE_TYPE_MAP)) {
                if (lower.indexOf(key) >= 0) return value;
            }
            // Default to consultation
            return 'consultation';
        }
        
        async function parseTimelyFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Force fresh data reload before parsing
            toast('Loading latest data...', '');
            try {
                const response = await fetch(API_URL);
                const freshData = await response.json();
                if (freshData && freshData.clients) {
                    data.clients = freshData.clients || [];
                    data.appointments = freshData.appointments || [];
                    console.log('Refreshed data - Clients:', data.clients.length, 'Appointments:', data.appointments.length);
                }
            } catch (e) {
                console.log('Could not refresh data, using cached:', e);
            }
            
            // Log current state before parsing
            console.log('=== STARTING IMPORT ===');
            console.log('Clients in memory:', data.clients.length);
            console.log('Client emails:', data.clients.map(function(c) { return (c.Email || '').toLowerCase().trim(); }));
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileData = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(fileData, { type: 'array', cellDates: true });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    console.log('Rows found:', rows.length);
                    
                    // Find header row - look for "Customer" text
                    let headerIdx = -1;
                    for (let i = 0; i < Math.min(rows.length, 15); i++) {
                        const row = rows[i];
                        if (!row) continue;
                        const rowStr = row.map(function(x) { return String(x || ''); }).join(' ').toLowerCase();
                        if (rowStr.indexOf('customer') >= 0 && rowStr.indexOf('email') >= 0) {
                            headerIdx = i;
                            break;
                        }
                    }
                    
                    if (headerIdx === -1) {
                        toast('Invalid file - no header row found', 'error');
                        return;
                    }
                    
                    console.log('Header row index:', headerIdx);
                    console.log('Header row:', rows[headerIdx]);
                    
                    // Build column index map by scanning header row
                    const headerRow = rows[headerIdx];
                    const colIdx = { date: -1, customer: -1, email: -1, phone: -1, sms: -1, status: -1, start: -1, staff: -1, service: -1 };
                    
                    for (let i = 0; i < headerRow.length; i++) {
                        const h = String(headerRow[i] || '').toLowerCase().replace(/\n/g, ' ').trim();
                        if (h === 'date') colIdx.date = i;
                        else if (h === 'customer') colIdx.customer = i;
                        else if (h === 'email') colIdx.email = i;
                        else if (h === 'telephone') colIdx.phone = i;
                        else if (h.indexOf('sms') >= 0) colIdx.sms = i;
                        else if (h === 'status') colIdx.status = i;
                        else if (h === 'start') colIdx.start = i;
                        else if (h.indexOf('staff') >= 0) colIdx.staff = i;
                        else if (h.indexOf('service') >= 0) colIdx.service = i;
                    }
                    
                    console.log('Column indexes:', colIdx);
                    
                    if (colIdx.customer === -1) {
                        toast('Invalid file - no Customer column', 'error');
                        return;
                    }
                    
                    timelyImportData = [];
                    timelyAllAppointments = []; // Reset tracking array
                    
                    // Track clients we're adding in this batch (by email)
                    const batchClients = {}; // email -> index in timelyImportData
                    
                    for (let i = headerIdx + 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row) continue;
                        
                        // Get customer name
                        const customerVal = row[colIdx.customer];
                        if (!customerVal) continue;
                        
                        const customer = String(customerVal).trim();
                        if (!customer) continue;
                        
                        // Skip total/summary rows
                        if (customer.toLowerCase().indexOf('total') >= 0) continue;
                        
                        // Get email
                        const email = colIdx.email >= 0 && row[colIdx.email] ? String(row[colIdx.email]).trim() : '';
                        
                        // Get phone - try SMS column first (that's where the data actually is)
                        let phone = '';
                        if (colIdx.sms >= 0 && row[colIdx.sms]) {
                            phone = String(row[colIdx.sms]).trim();
                        }
                        if (!phone && colIdx.phone >= 0 && row[colIdx.phone]) {
                            phone = String(row[colIdx.phone]).trim();
                        }
                        
                        // Get status
                        const status = colIdx.status >= 0 && row[colIdx.status] ? String(row[colIdx.status]).toLowerCase().trim() : '';
                        
                        // Get service
                        const service = colIdx.service >= 0 && row[colIdx.service] ? String(row[colIdx.service]).trim() : '';
                        
                        // Get staff
                        const staff = colIdx.staff >= 0 && row[colIdx.staff] ? String(row[colIdx.staff]).trim() : '';
                        
                        // Parse date/time from Date or Start column
                        let apptDate = '';
                        let apptTime = '';
                        
                        let dateVal = colIdx.date >= 0 ? row[colIdx.date] : null;
                        if (!dateVal) dateVal = colIdx.start >= 0 ? row[colIdx.start] : null;
                        
                        if (dateVal) {
                            let d = null;
                            if (dateVal instanceof Date) {
                                d = dateVal;
                            } else if (typeof dateVal === 'number') {
                                // Excel serial date - add small offset to fix rounding
                                d = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
                            } else {
                                d = new Date(String(dateVal));
                            }
                            
                            if (d && !isNaN(d.getTime())) {
                                apptDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                                // Round seconds to nearest minute
                                var hours = d.getHours();
                                var mins = d.getMinutes();
                                var secs = d.getSeconds();
                                if (secs >= 30) mins++;
                                if (mins >= 60) { mins = 0; hours++; }
                                apptTime = String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
                            }
                        }
                        
                        // Skip cancelled
                        if (status === 'cancelled') continue;
                        
                        // Parse name
                        const nameParts = customer.split(' ');
                        const firstName = nameParts[0] || '';
                        const lastName = nameParts.slice(1).join(' ') || '';
                        
                        // Check existing client by email (trim and lowercase)
                        let existingClient = null;
                        let batchClientIdx = null;
                        const emailClean = (email || '').trim().toLowerCase();
                        const firstNameClean = (firstName || '').trim().toLowerCase();
                        const lastNameClean = (lastName || '').trim().toLowerCase();
                        
                        console.log('Checking client:', firstName, lastName, '| email:', emailClean);
                        
                        // First check if we already have this client in the database
                        if (data && data.clients && data.clients.length > 0) {
                            // Try matching by email first
                            if (emailClean) {
                                for (let c of data.clients) {
                                    const clientEmail = (c.Email || '').trim().toLowerCase();
                                    if (clientEmail && clientEmail === emailClean) {
                                        existingClient = c;
                                        console.log('Found existing client by email:', emailClean, '-> ID:', c.ID);
                                        break;
                                    }
                                }
                            }
                            
                            // If not found by email, try matching by name
                            if (!existingClient && firstNameClean && lastNameClean) {
                                for (let c of data.clients) {
                                    const cFirst = (c.FirstName || '').trim().toLowerCase();
                                    const cLast = (c.LastName || '').trim().toLowerCase();
                                    if (cFirst === firstNameClean && cLast === lastNameClean) {
                                        existingClient = c;
                                        console.log('Found existing client by name:', firstName, lastName, '-> ID:', c.ID);
                                        break;
                                    }
                                }
                            }
                            
                            if (!existingClient) {
                                console.log('No match found for:', firstName, lastName, emailClean);
                            }
                        } else {
                            console.log('WARNING: No clients in data!');
                        }
                        
                        // Also check if we're creating this client in this same batch
                        if (!existingClient && emailClean && batchClients[emailClean] !== undefined) {
                            batchClientIdx = batchClients[emailClean];
                            console.log('Found client in same batch:', emailClean, '-> batch index:', batchClientIdx);
                        }
                        
                        // Check existing appointment (use String comparison for IDs)
                        let existingAppt = null;
                        if (existingClient && apptDate && apptTime && data && data.appointments) {
                            for (let a of data.appointments) {
                                if (String(a.ClientID) === String(existingClient.ID) && getDateStr(a.Date) === apptDate && a.Time === apptTime) {
                                    existingAppt = a;
                                    console.log('Found existing appointment:', a.ID);
                                    break;
                                }
                            }
                        }
                        
                        // Determine action
                        let action = 'new_client';
                        if (existingClient && existingAppt) {
                            // Only mark_noshow if it was a no-show, otherwise skip (already exists)
                            if (status === 'did-not-show' && existingAppt.Status !== 'no-show') {
                                action = 'mark_noshow';
                            } else {
                                action = 'skip'; // Already exists, no changes needed
                                console.log('SKIP: Appointment already exists for', firstName, lastName, 'on', apptDate, 'at', apptTime, '- Existing appt ID:', existingAppt.ID);
                            }
                        } else if (existingClient) {
                            action = 'add_appt';
                            console.log('ADD_APPT: Client exists, will add appointment for', firstName, lastName, 'on', apptDate, 'at', apptTime);
                        } else if (batchClientIdx !== null) {
                            // Client is being created in this batch - just add appointment
                            action = 'add_appt_to_batch';
                            console.log('ADD_APPT_TO_BATCH: Will add appointment for', firstName, lastName, 'on', apptDate, 'at', apptTime);
                        } else {
                            console.log('NEW_CLIENT: Will create new client and appointment for', firstName, lastName, 'on', apptDate, 'at', apptTime);
                        }
                        
                        // Don't add skipped items to the import list
                        if (action === 'skip') {
                            // But DO track it for delete logic - this appointment IS in Timely
                            if (existingClient && apptDate && apptTime) {
                                timelyAllAppointments.push({
                                    clientId: existingClient.ID,
                                    date: apptDate,
                                    time: apptTime
                                });
                            }
                            // If this was created internally, hand ownership to Timely now
                            if (existingAppt && existingAppt.Source === 'estrelle') {
                                existingAppt.Source = '';
                                api('POST', { action: 'update', sheet: 'Appointments', id: existingAppt.ID, record: { Source: '' } }).catch(() => {});
                            }
                            continue;
                        }
                        
                        // Track ALL appointments from Timely file for delete logic
                        if (existingClient && apptDate && apptTime) {
                            timelyAllAppointments.push({
                                clientId: existingClient.ID,
                                date: apptDate,
                                time: apptTime
                            });
                        }
                        
                        // Track this client for future rows in the batch
                        if (action === 'new_client' && emailClean) {
                            batchClients[emailClean] = timelyImportData.length; // Store the index
                        }
                        
                        timelyImportData.push({
                            action: action,
                            firstName: firstName,
                            lastName: lastName,
                            email: email,
                            phone: phone,
                            date: apptDate,
                            time: apptTime,
                            type: mapServiceType(service),
                            consultant: staff,
                            status: status,
                            existingClientId: existingClient ? existingClient.ID : null,
                            existingApptId: existingAppt ? existingAppt.ID : null,
                            batchClientIdx: batchClientIdx
                        });
                    }
                    
                    console.log('Parsed records:', timelyImportData.length);
                    
                    if (timelyImportData.length === 0) {
                        toast('No appointments found in file', 'error');
                        return;
                    }
                    
                    renderImportPreview();
                    
                } catch (err) {
                    console.error('Parse error:', err);
                    toast('Error: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function renderImportPreview() {
            if (timelyImportData.length === 0) {
                toast('No appointments found in file', 'error');
                return;
            }
            
            $('importStep1').style.display = 'none';
            $('importStep2').style.display = 'block';
            $('btnConfirmImport').style.display = 'inline-block';
            
            const actionLabels = {
                'new_client': '<span style="color:var(--sage)">+ New Client</span>',
                'add_appt': '<span style="color:var(--dusty)">+ Add Appt</span>',
                'add_appt_to_batch': '<span style="color:var(--dusty)">+ Add Appt</span>',
                'update': '<span style="color:var(--taupe)">Update</span>',
                'mark_noshow': '<span style="color:var(--rose)">No-Show</span>'
            };
            
            $('importPreviewTable').innerHTML = timelyImportData.map(function(item) {
                return '<tr>' +
                    '<td>' + (actionLabels[item.action] || item.action) + '</td>' +
                    '<td>' + item.firstName + ' ' + item.lastName + (item.email ? '<br><span style="font-size:9px;color:var(--taupe)">' + item.email + '</span>' : '') + '</td>' +
                    '<td>' + (item.date ? fmtDate(item.date) : '<span style="color:var(--rose)">No date</span>') + '</td>' +
                    '<td>' + (item.time || '‚Äî') + '</td>' +
                    '<td>' + item.type + '</td>' +
                    '<td>' + item.status + '</td>' +
                '</tr>';
            }).join('');
            
            // Stats
            const newClients = timelyImportData.filter(function(i) { return i.action === 'new_client'; }).length;
            const addAppts = timelyImportData.filter(function(i) { return i.action === 'add_appt' || i.action === 'add_appt_to_batch'; }).length;
            const noShows = timelyImportData.filter(function(i) { return i.action === 'mark_noshow'; }).length;
            const withDates = timelyImportData.filter(function(i) { return i.date; }).length;
            
            $('importSummary').textContent = timelyImportData.length + ' records';
            $('importStats').innerHTML = 
                '<strong>Summary:</strong> ' +
                newClients + ' new clients, ' +
                (addAppts + newClients) + ' new appointments, ' +
                noShows + ' no-shows' +
                (withDates < timelyImportData.length ? ' <span style="color:var(--rose)">(' + (timelyImportData.length - withDates) + ' missing dates)</span>' : '');
        }
        
        async function confirmTimelyImport() {
            $('btnConfirmImport').disabled = true;
            $('btnConfirmImport').textContent = 'Importing...';
            
            let clientsCreated = 0, apptsCreated = 0;
            
            // Track client IDs created in this batch (by index)
            const batchClientIds = {};
            
            // Build set of ALL appointments from Timely file (including skipped)
            const timelyApptKeys = new Set();
            
            // Track date range from Timely file - use timelyAllAppointments which includes skipped
            let minDate = null;
            let maxDate = null;
            
            // First pass: collect all appointment keys and date range from ALL appointments in Timely file
            for (const appt of timelyAllAppointments) {
                if (appt.date) {
                    if (!minDate || appt.date < minDate) minDate = appt.date;
                    if (!maxDate || appt.date > maxDate) maxDate = appt.date;
                    // Add to tracking set
                    timelyApptKeys.add(`${appt.clientId}|${appt.date}|${appt.time}`);
                }
            }
            // Also add from timelyImportData (for new clients that don't have clientId yet)
            for (const item of timelyImportData) {
                if (item.date) {
                    if (!minDate || item.date < minDate) minDate = item.date;
                    if (!maxDate || item.date > maxDate) maxDate = item.date;
                }
            }
            
            console.log('Timely date range:', minDate, 'to', maxDate);
            console.log('Total appointments in Timely file (including skipped):', timelyAllAppointments.length);
            console.log('Appointments to import:', timelyImportData.length);
            
            try {
                // Process each item sequentially to get correct server IDs
                for (let idx = 0; idx < timelyImportData.length; idx++) {
                    const item = timelyImportData[idx];
                    let clientId = item.existingClientId;
                    
                    $('btnConfirmImport').textContent = 'Importing ' + (idx + 1) + '/' + timelyImportData.length + '...';
                    
                    // Create new client if needed - WAIT for server response
                    if (item.action === 'new_client') {
                        const newClient = {
                            FirstName: item.firstName,
                            LastName: item.lastName,
                            Email: item.email,
                            Phone: item.phone,
                            Status: 'new',
                            CreatedAt: today()
                        };
                        
                        console.log('Creating client:', newClient);
                        const response = await api('POST', { action: 'add', sheet: 'Clients', record: newClient });
                        
                        // Get the server-assigned ID
                        if (response && response.id) {
                            clientId = response.id;
                            newClient.ID = response.id;
                            console.log('Server assigned client ID:', clientId);
                        } else {
                            // Fallback - generate temp ID
                            clientId = 'c' + Date.now() + idx;
                            newClient.ID = clientId;
                            console.log('Using temp client ID:', clientId);
                        }
                        
                        // Store this client ID for batch lookups
                        batchClientIds[idx] = clientId;
                        
                        data.clients.push(newClient);
                        clientsCreated++;
                    }
                    
                    // For batch appointments, get the client ID from the earlier item
                    if (item.action === 'add_appt_to_batch' && item.batchClientIdx !== null) {
                        clientId = batchClientIds[item.batchClientIdx];
                        console.log('Using batch client ID for appointment:', clientId, 'from batch index:', item.batchClientIdx);
                    }
                    
                    // Create appointment with the correct client ID
                    if (clientId && (item.action === 'new_client' || item.action === 'add_appt' || item.action === 'add_appt_to_batch')) {
                        // Get client name
                        const clientName = `${item.firstName} ${item.lastName}`.trim();
                        
                        const newAppt = {
                            ClientID: clientId,
                            ClientName: clientName,
                            Date: item.date || today(),
                            Time: item.time || '10:00',
                            Type: item.type || 'Bridal Consultation',
                            Consultant: item.consultant || '',
                            Status: item.status === 'did-not-show' ? 'no-show' : '',
                            CreatedAt: today()
                        };
                        
                        console.log('Creating appointment with ClientID:', clientId, newAppt);
                        const apptResponse = await api('POST', { action: 'add', sheet: 'Appointments', record: newAppt });
                        
                        if (apptResponse && apptResponse.id) {
                            newAppt.ID = apptResponse.id;
                        } else {
                            newAppt.ID = 'a' + Date.now() + idx;
                        }
                        
                        data.appointments.push(newAppt);
                        apptsCreated++;
                        
                        // Track this appointment key for new clients (they weren't in timelyAllAppointments)
                        if (item.action === 'new_client' || item.action === 'add_appt_to_batch') {
                            timelyApptKeys.add(`${clientId}|${item.date}|${item.time}`);
                        }
                    }
                    
                    // Handle no-show updates
                    if (item.action === 'mark_noshow' && item.existingApptId) {
                        await api('POST', { action: 'update', sheet: 'Appointments', id: item.existingApptId, updates: { Status: 'no-show' } });
                        const appt = data.appointments.find(function(a) { return String(a.ID) === String(item.existingApptId); });
                        if (appt) appt.Status = 'no-show';
                    }
                }
                
                // AUTO-DELETE: Find appointments in app that are within Timely date range but not in Timely file
                let apptsDeleted = 0;
                const deletedAppts = [];
                
                if (minDate && maxDate) {
                    const apptsToDelete = data.appointments.filter(a => {
                        const apptDate = getDateStr(a.Date);
                        // Only consider appointments within the Timely file's date range
                        if (apptDate < minDate || apptDate > maxDate) return false;
                        
                        // Never auto-delete appointments created internally (from alteration modal, etc.)
                        if (a.Source === 'estrelle') return false;
                        
                        // Check if this appointment exists in Timely
                        const key = `${a.ClientID}|${apptDate}|${a.Time}`;
                        return !timelyApptKeys.has(key);
                    });
                    
                    console.log('Appointments to delete (not in Timely):', apptsToDelete.length);
                    
                    for (const appt of apptsToDelete) {
                        // Save for undo
                        deletedAppts.push({ ...appt });
                        
                        // Remove from local data
                        const idx = data.appointments.findIndex(a => String(a.ID) === String(appt.ID));
                        if (idx >= 0) {
                            data.appointments.splice(idx, 1);
                        }
                        
                        // Delete from server
                        api('POST', { action: 'delete', sheet: 'Appointments', id: appt.ID }).catch(() => {});
                        
                        apptsDeleted++;
                    }
                    
                    // Add to undo stack if any were deleted
                    if (deletedAppts.length > 0) {
                        addUndo({ type: 'bulk_delete_appointments', records: deletedAppts });
                    }
                }
                
                console.log('Import complete - Clients:', clientsCreated, 'Appointments:', apptsCreated, 'Deleted:', apptsDeleted);
                
                // Auto-create alteration records for imported fitting appointments
                let altsCreated = 0;
                const fittingItems = timelyImportData.filter(item => {
                    const type = (item.type || '').toLowerCase();
                    return type.includes('fitting');
                });
                
                for (const item of fittingItems) {
                    const clientId = item.existingClientId || batchClientIds[timelyImportData.indexOf(item)] || (item.batchClientIdx !== null ? batchClientIds[item.batchClientIdx] : null);
                    if (!clientId) continue;
                    
                    // Check for existing alteration (no duplicates)
                    const existingAlt = data.alterations.find(a => String(a.ClientID) === String(clientId) && a.Status !== 'complete');
                    if (existingAlt) continue;
                    
                    const client = getClient(clientId);
                    if (!client) continue;
                    
                    const order = data.orders.find(o => String(o.ClientID) === String(clientId) && o.Status !== 'picked up');
                    
                    const altRecord = {
                        ClientID: String(clientId),
                        ClientName: `${client.FirstName} ${client.LastName}`,
                        OrderID: order ? order.ID : '',
                        Items: order ? (order.Dress || 'Dress') : 'Dress',
                        Notes: `Auto-created from Timely ${normalizeApptType(item.type)} import on ${item.date}`,
                        Status: 'in progress',
                        StartDate: today(),
                        DueDate: client.WeddingDate || '',
                        Seamstress: ''
                    };
                    
                    try {
                        const result = await api('POST', { action: 'add', sheet: 'Alterations', record: altRecord });
                        altRecord.ID = (result && result.id) ? result.id : 'alt_' + Date.now() + '_' + altsCreated;
                        data.alterations.push(altRecord);
                        
                        // Also update order status to "in alterations" if applicable
                        if (order && order.Status !== 'in alterations' && order.Status !== 'picked up') {
                            await updateRecord('Orders', order.ID, { Status: 'in alterations' });
                            order.Status = 'in alterations';
                        }
                        
                        altsCreated++;
                    } catch (e) {
                        console.error('Failed to create alteration for', altRecord.ClientName, e);
                    }
                }
                
                if (altsCreated > 0) {
                    console.log('Auto-created', altsCreated, 'alteration(s) from fitting imports');
                }
                
                // Save to cache
                saveCachedData();
                
                // Update UI
                closeModal('importTimely');
                renderClients();
                renderAllAppointments();
                renderDash();
                renderAlts();
                
                // Show toast with results
                let msg = 'Imported! ' + clientsCreated + ' clients, ' + apptsCreated + ' appointments';
                if (altsCreated > 0) {
                    msg += ', ' + altsCreated + ' alteration(s)';
                }
                if (apptsDeleted > 0) {
                    msg += '. ' + apptsDeleted + ' removed (not in Timely)';
                }
                toast(msg, 'success', apptsDeleted > 0); // Show undo if any were deleted
                
            } catch (err) {
                console.error('Import error:', err);
                toast('Import error: ' + err.message, 'error');
            }
            
            // Reset modal for next import
            timelyImportData = [];
            timelyAllAppointments = [];
            $('importStep1').style.display = 'block';
            $('importStep2').style.display = 'none';
            $('btnConfirmImport').style.display = 'none';
            $('btnConfirmImport').disabled = false;
            $('btnConfirmImport').textContent = '‚úì Import All';
            $('timelyFileInput').value = '';
        }

        let autoSaveTimer = null;
        
        function scheduleAutoSave() {
            // Clear existing timer
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            
            // Hide saved status while typing
            $('autoSaveStatus').style.display = 'none';
            
            // Schedule save after 1 second of no typing
            autoSaveTimer = setTimeout(() => {
                saveClientNotes(true); // silent save
            }, 1000);
        }
        
        async function saveClientNotes(silent = false) {
            if (!currentClient) return;
            
            updateRecord('Clients', currentClient.ID, {
                StylePreferences: $('cStyle').value,
                Notes: $('cNotes').value,
                Budget: $('cBudget').value,
                LastVisit: today(),
                Status: currentClient.Status === 'new' ? 'consultation' : currentClient.Status
            });
            // Also update local currentClient
            currentClient.StylePreferences = $('cStyle').value;
            currentClient.Notes = $('cNotes').value;
            currentClient.Budget = $('cBudget').value;
            
            // Update original values so unsaved check passes
            originalClientNotes = {
                style: $('cStyle').value,
                notes: $('cNotes').value,
                budget: $('cBudget').value
            };
            
            if (silent) {
                // Show subtle saved indicator
                $('autoSaveStatus').style.display = 'inline';
                setTimeout(() => {
                    $('autoSaveStatus').style.display = 'none';
                }, 2000);
            } else {
                toast('Saved!', 'success');
            }
        }

        // ========== VISIT NOTES ==========
        function renderVisitHistory() {
            // Pull from appointments that have notes
            const apptsWithNotes = data.appointments
                .filter(a => a.ClientID == currentClient.ID && a.Notes)
                .sort((a, b) => (b.Date || '').localeCompare(a.Date || ''));
            
            if (!apptsWithNotes.length) {
                $('cVisitHistory').innerHTML = '<div class="empty">No visit notes yet. Click on any appointment above to add notes about what was discussed.</div>';
                return;
            }
            
            $('cVisitHistory').innerHTML = apptsWithNotes.map(a => {
                const typeColors = {
                    consultation: '#9b59b6',
                    fitting: '#3498db',
                    pickup: '#27ae60',
                    alteration: '#e67e22',
                    other: '#7f8c8d'
                };
                const color = typeColors[a.Type] || '#7f8c8d';
                
                return `<div style="border-left:3px solid ${color};padding:10px 12px;margin-bottom:10px;background:var(--cream);border-radius:0 5px 5px 0;cursor:pointer" onclick="editAppt('${a.ID}')">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
                        <div>
                            <span style="font-weight:600;font-size:12px">${fmtDate(a.Date)}</span>
                            <span style="background:${color};color:white;font-size:9px;padding:2px 6px;border-radius:3px;margin-left:6px">${a.Type || 'appointment'}</span>
                            ${a.Consultant ? `<span style="font-size:10px;color:var(--taupe);margin-left:6px">with ${a.Consultant}</span>` : ''}
                        </div>
                        <span style="font-size:9px;color:var(--taupe)">click to edit</span>
                    </div>
                    <div style="font-size:11px;line-height:1.5;white-space:pre-wrap">${a.Notes}</div>
                </div>`;
            }).join('');
        }

        // ========== SHE SAID YES ==========
        let yStep = 1;
        let measUnit = 'in';
        let customMeasurements = [];

        function setMeasUnit(unit) {
            measUnit = unit;
            $('unitCm').className = unit === 'cm' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('unitCm').style.background = unit === 'cm' ? 'var(--charcoal)' : '';
            $('unitCm').style.color = unit === 'cm' ? 'white' : '';
            $('unitIn').className = unit === 'in' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
            $('unitIn').style.background = unit === 'in' ? 'var(--charcoal)' : '';
            $('unitIn').style.color = unit === 'in' ? 'white' : '';
            document.querySelectorAll('[data-unit]').forEach(el => el.textContent = unit);
        }

        function addCustomMeas() {
            const name = $('customMeasName').value.trim();
            const value = $('customMeasValue').value.trim();
            if (!name || !value) { toast('Enter name and value'); return; }
            customMeasurements.push({ name, value, unit: measUnit });
            $('customMeasName').value = '';
            $('customMeasValue').value = '';
            renderCustomMeas();
        }

        function renderCustomMeas() {
            $('customMeasList').innerHTML = customMeasurements.map((m, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:var(--cream);border-radius:4px;margin-bottom:4px;font-size:11px">
                    <span>${m.name}: ${m.value} ${m.unit}</span>
                    <button class="action-btn" onclick="customMeasurements.splice(${i},1);renderCustomMeas()">√ó</button>
                </div>
            `).join('');
        }

        function sheSaidYes(autoLoadDraft = false) {
            yStep = 1;
            currentOrder = { items: [], measurements: {}, hst: false };
            customMeasurements = [];
            measUnit = 'in';
            setMeasUnit('in');
            pendingPhotos = [];
            renderPhotoPreview();
            
            // Populate saved measurements dropdown
            populateSavedMeasurementsDropdown();
            
            // Populate "measured by" consultant dropdown
            $('mTakenBy').innerHTML = '<option value="">Select consultant...</option>' + 
                data.consultants.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('');
            
            // Populate designer dropdown for step 2
            populateDesignerDropdown();
            
            // Clear measurement fields
            ['mBust','mCup','mWaist','mHip','mHeight','mHeels','mWaistToFloor'].forEach(id => $(id).value = '');
            $('mNotes').value = '';
            $('customMeasList').innerHTML = '';
            $('selectSavedMeasurement').value = '';
            $('mTakenBy').value = '';
            
            $('orderItems').innerHTML = '';
            $('orderTotal').textContent = '$0';
            // Default to 13% HST
            $('taxHst').checked = true;
            $('taxCustom').checked = false;
            $('taxNone').checked = false;
            $('customTaxRate').value = '';
            $('orderSubtotal').style.display = 'none';
            $('orderHstRow').style.display = 'none';
            $('yDate').value = today();
            
            // Clear PO - consultant will enter
            $('oiPO').value = '';
            
            // Clear arrival date
            $('oiArrivalDate').value = '';
            $('arrivalDateHint').textContent = 'Enter expected arrival date';
            $('arrivalDateHint').style.color = 'var(--taupe)';
            
            // Reset item type to dress
            $('oiType').value = 'dress';
            toggleOrderItemFields();
            
            updateYSteps();
            openModal('yes');
            
            // Check if there's a draft for this client
            if (autoLoadDraft) {
                // Auto-load draft without asking (from dashboard Continue button)
                console.log('Auto-loading draft for client:', currentClient.ID);
                console.log('OrderDraft field:', currentClient.OrderDraft);
                let draft = null;
                try {
                    draft = currentClient.OrderDraft ? JSON.parse(currentClient.OrderDraft) : null;
                    console.log('Parsed draft:', draft);
                } catch (e) {
                    console.error('Failed to parse draft:', e);
                    draft = null;
                }
                if (draft && draft.savedAt) {
                    loadDraft(draft);
                } else {
                    console.log('No valid draft found');
                }
            } else {
                // Show dialog asking if they want to load
                checkForDraft();
            }
        }
        
        function generateNextPO() {
            // Return placeholder - consultant will enter actual PO
            return '';
        }
        
        function getNextPONumber() {
            // Get all existing PO numbers from orders
            const existingPOs = (data.orders || [])
                .map(o => o.PO)
                .filter(po => po && !isNaN(parseInt(String(po).replace(/^0+/, ''))))
                .map(po => parseInt(String(po).replace(/^0+/, '')));
            
            // Find the highest PO number
            const maxPO = existingPOs.length > 0 ? Math.max(...existingPOs) : 0;
            
            // Return next number (padded to 6 digits)
            const nextNum = maxPO + 1;
            return String(nextNum).padStart(6, '0');
        }
        
        function populateSavedMeasurementsDropdown() {
            const measurements = getClientMeasurements();
            
            if (measurements.length === 0) {
                $('savedMeasurementsSelector').style.display = 'none';
                return;
            }
            
            // Sort by date, most recent first
            measurements.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            
            $('selectSavedMeasurement').innerHTML = '<option value="">‚Äî Enter manually ‚Äî</option>' + 
                measurements.map((m, idx) => {
                    const unit = m.unit || 'in';
                    const summary = [
                        m.bust ? `B:${m.bust}` : '',
                        m.waist ? `W:${m.waist}` : '',
                        m.hip ? `H:${m.hip}` : ''
                    ].filter(Boolean).join(' / ') || 'No measurements';
                    const takenBy = m.takenBy ? ` by ${m.takenBy}` : '';
                    return `<option value="${idx}">${fmtDate(m.date)}${takenBy} ‚Äî ${summary} (${unit})</option>`;
                }).join('');
            
            $('savedMeasurementsSelector').style.display = 'block';
        }
        
        function loadSavedMeasurement() {
            const idx = $('selectSavedMeasurement').value;
            
            if (idx === '') {
                // Clear fields for manual entry
                ['mBust','mCup','mWaist','mHip','mHeight','mHeels','mWaistToFloor'].forEach(id => $(id).value = '');
                $('mNotes').value = '';
                $('mTakenBy').value = '';
                customMeasurements = [];
                renderCustomMeas();
                return;
            }
            
            const measurements = getClientMeasurements();
            measurements.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            const m = measurements[parseInt(idx)];
            
            if (!m) return;
            
            // Set unit
            measUnit = m.unit || 'in';
            setMeasUnit(measUnit);
            
            // Fill in measurements
            $('mBust').value = m.bust || '';
            $('mCup').value = m.cup || '';
            $('mWaist').value = m.waist || '';
            $('mHip').value = m.hip || '';
            $('mHeight').value = m.height || '';
            $('mHeels').value = m.heels || '';
            $('mWaistToFloor').value = m.waistToFloor || '';
            $('mNotes').value = m.notes || '';
            $('mTakenBy').value = m.takenBy || '';
            
            // Load custom measurements
            customMeasurements = m.custom ? [...m.custom] : [];
            renderCustomMeas();
            
            toast('Measurements loaded!', 'success');
        }
        
        function closeYesModal() {
            // Check if there's any data entered
            const hasItems = currentOrder.items && currentOrder.items.length > 0;
            const hasMeasurements = $('mBust').value || $('mWaist').value || $('mHip').value;
            
            if (hasItems || hasMeasurements) {
                showChoiceDialog(
                    'Unsaved Work',
                    'You have unsaved work. What would you like to do?',
                    [
                        { label: 'üíæ Save Draft', style: 'primary', action: () => { closeModal('choice'); saveDraft(); } },
                        { label: 'üóëÔ∏è Discard', style: 'danger', action: () => { closeModal('choice'); closeModal('yes'); } },
                        { label: '‚Üê Go Back', style: 'secondary', action: () => { closeModal('choice'); } }
                    ]
                );
            } else {
                closeModal('yes');
            }
        }
        
        function showChoiceDialog(title, message, buttons) {
            $('choiceTitle').textContent = title;
            $('choiceMessage').textContent = message;
            $('choiceInput').style.display = 'none';
            $('choiceButtons').innerHTML = buttons.map(btn => {
                const btnClass = btn.style === 'primary' ? 'btn btn-primary' : 
                                 btn.style === 'danger' ? 'btn btn-secondary' : 'btn btn-secondary';
                const extraStyle = btn.style === 'danger' ? 'background:#e74c3c;color:white;border-color:#e74c3c' : '';
                return `<button class="${btnClass}" style="width:100%;padding:12px;${extraStyle}" onclick="(${btn.action.toString()})()">${btn.label}</button>`;
            }).join('');
            openModal('choice');
        }
        
        // Promise-based confirm dialog
        function appConfirm(message, title = 'Confirm') {
            return new Promise((resolve) => {
                $('choiceTitle').textContent = title;
                $('choiceMessage').textContent = message;
                $('choiceInput').style.display = 'none';
                window._choiceReject = () => resolve(false);
                $('choiceButtons').innerHTML = `
                    <div style="display:flex;gap:10px">
                        <button class="btn btn-secondary" style="flex:1;padding:12px" onclick="closeModal('choice'); window._choiceResolve(false)">Cancel</button>
                        <button class="btn btn-primary" style="flex:1;padding:12px" onclick="closeModal('choice'); window._choiceResolve(true)">OK</button>
                    </div>
                `;
                window._choiceResolve = resolve;
                openModal('choice');
            });
        }
        
        // Promise-based prompt dialog
        function appPrompt(message, defaultValue = '', title = 'Input') {
            return new Promise((resolve) => {
                $('choiceTitle').textContent = title;
                $('choiceMessage').textContent = message;
                $('choiceInput').style.display = 'block';
                $('choiceInputField').value = defaultValue;
                window._choiceReject = () => resolve(null);
                $('choiceButtons').innerHTML = `
                    <div style="display:flex;gap:10px">
                        <button class="btn btn-secondary" style="flex:1;padding:12px" onclick="closeModal('choice'); window._choiceResolve(null)">Cancel</button>
                        <button class="btn btn-primary" style="flex:1;padding:12px" onclick="closeModal('choice'); window._choiceResolve($('choiceInputField').value)">OK</button>
                    </div>
                `;
                window._choiceResolve = resolve;
                openModal('choice');
                setTimeout(() => $('choiceInputField').focus(), 100);
            });
        }
        
        // Danger confirm (for deletes)
        function appConfirmDanger(message, title = 'Are you sure?') {
            return new Promise((resolve) => {
                $('choiceTitle').textContent = title;
                $('choiceMessage').textContent = message;
                $('choiceInput').style.display = 'none';
                window._choiceReject = () => resolve(false);
                $('choiceButtons').innerHTML = `
                    <div style="display:flex;gap:10px">
                        <button class="btn btn-secondary" style="flex:1;padding:12px" onclick="closeModal('choice'); window._choiceResolve(false)">Cancel</button>
                        <button class="btn" style="flex:1;padding:12px;background:#e74c3c;color:white;border-color:#e74c3c" onclick="closeModal('choice'); window._choiceResolve(true)">Delete</button>
                    </div>
                `;
                window._choiceResolve = resolve;
                openModal('choice');
            });
        }
        
        async function saveDraft() {
            // Collect current measurements from form
            const measurements = { 
                bust: $('mBust').value,
                cup: $('mCup').value,
                waist: $('mWaist').value, 
                hip: $('mHip').value, 
                height: $('mHeight').value, 
                waistToFloor: $('mWaistToFloor').value,
                heels: $('mHeels').value, 
                notes: $('mNotes').value,
                unit: measUnit,
                takenBy: $('mTakenBy').value,
                custom: [...customMeasurements]
            };
            
            // Guard: don't save empty drafts ‚Äî must have items OR at least one measurement
            const hasItems = currentOrder.items && currentOrder.items.length > 0;
            const hasMeasurements = measurements.bust || measurements.waist || measurements.hip || 
                                    measurements.height || measurements.waistToFloor;
            const hasOrderDetails = $('oiPO')?.value || $('oiDetails')?.value || $('oiArrivalDate')?.value;
            
            if (!hasItems && !hasMeasurements && !hasOrderDetails) {
                toast('Nothing to save yet ‚Äî enter measurements or add items first', 'error');
                return;
            }
            
            // Collect initials if on step 5
            let initials = {};
            if ($('init_bust')) initials.bust = $('init_bust').value || '';
            if ($('init_waist')) initials.waist = $('init_waist').value || '';
            if ($('init_hip')) initials.hip = $('init_hip').value || '';
            if ($('init_other')) initials.other = $('init_other').value || '';
            
            const draft = {
                step: yStep,
                measurements: measurements,
                selectedMeasurementIdx: $('selectSavedMeasurement').value,
                items: currentOrder.items.map(item => ({ ...item, customizations: item.customizations ? [...item.customizations] : [] })),
                taxType: $('taxHst')?.checked ? 'hst' : ($('taxCustom')?.checked ? 'custom' : 'none'),
                customTaxRate: $('customTaxRate')?.value || '',
                date: $('yDate')?.value || '',
                po: $('oiPO')?.value || '',
                arrivalDate: $('oiArrivalDate')?.value || '',
                orderDetails: $('oiDetails')?.value || '',
                consultant: $('yConsultantSelect')?.value || '',
                initials: initials,
                savedAt: new Date().toISOString()
            };
            
            console.log('Saving draft:', draft);
            console.log('Items being saved:', draft.items);
            
            // Save to Google Sheets (syncs across devices)
            await updateRecord('Clients', currentClient.ID, { OrderDraft: JSON.stringify(draft) });
            currentClient.OrderDraft = JSON.stringify(draft);
            closeModal('yes');
            toast('Draft saved! Available on all devices.', 'success');
            renderClientProfile();
        }
        
        function checkForDraft() {
            // Check Google Sheets draft (synced across devices)
            let draft = null;
            try {
                draft = currentClient.OrderDraft ? JSON.parse(currentClient.OrderDraft) : null;
            } catch (e) {
                draft = null;
            }
            
            if (draft && draft.savedAt) {
                const savedDate = new Date(draft.savedAt).toLocaleDateString();
                const itemCount = draft.items?.length || 0;
                
                showChoiceDialog(
                    'Draft Found',
                    `Found saved draft from ${savedDate} with ${itemCount} item(s). What would you like to do?`,
                    [
                        { label: 'üìÇ Load Draft', style: 'primary', action: () => { closeModal('choice'); loadDraft(draft); } },
                        { label: 'üóëÔ∏è Delete Draft', style: 'danger', action: async () => { 
                            await updateRecord('Clients', currentClient.ID, { OrderDraft: '' });
                            currentClient.OrderDraft = '';
                            closeModal('choice'); 
                            toast('Draft deleted', 'success'); 
                        } },
                        { label: '‚ú® Start Fresh (keep draft)', style: 'secondary', action: () => { closeModal('choice'); } }
                    ]
                );
            }
        }
        
        function loadDraft(draft) {
            console.log('Loading draft:', draft);
            
            // Use setTimeout to ensure modal is fully rendered
            setTimeout(() => {
                // Restore measurements
                if (draft.measurements) {
                    console.log('Restoring measurements:', draft.measurements);
                    $('mBust').value = draft.measurements.bust || '';
                    $('mCup').value = draft.measurements.cup || '';
                    $('mWaist').value = draft.measurements.waist || '';
                    $('mHip').value = draft.measurements.hip || '';
                    $('mHeight').value = draft.measurements.height || '';
                    $('mWaistToFloor').value = draft.measurements.waistToFloor || '';
                    $('mHeels').value = draft.measurements.heels || '';
                    $('mNotes').value = draft.measurements.notes || '';
                    $('mTakenBy').value = draft.measurements.takenBy || '';
                    
                    if (draft.measurements.unit) {
                        measUnit = draft.measurements.unit;
                        setMeasUnit(draft.measurements.unit);
                    }
                    
                    if (draft.measurements.custom && draft.measurements.custom.length > 0) {
                        customMeasurements = [...draft.measurements.custom];
                        renderCustomMeas();
                    }
                    
                    // Also store in currentOrder so it persists through navigation
                    currentOrder.measurements = { ...draft.measurements };
                }
                
                // Restore selected measurement from dropdown
                if (draft.selectedMeasurementIdx) {
                    $('selectSavedMeasurement').value = draft.selectedMeasurementIdx;
                }
                
                // Restore tax settings BEFORE rendering items so total is correct
                if (draft.taxType === 'custom') {
                    $('taxCustom').checked = true;
                    $('taxHst').checked = false;
                    $('taxNone').checked = false;
                    $('customTaxRate').value = draft.customTaxRate || '';
                } else if (draft.taxType === 'none') {
                    $('taxNone').checked = true;
                    $('taxHst').checked = false;
                    $('taxCustom').checked = false;
                    $('customTaxRate').value = '';
                } else {
                    // Default to HST (or legacy drafts with hst: true)
                    $('taxHst').checked = true;
                    $('taxCustom').checked = false;
                    $('taxNone').checked = false;
                    $('customTaxRate').value = '';
                }
                
                // Restore order items (include designer info)
                if (draft.items && draft.items.length > 0) {
                    currentOrder.items = draft.items.map(item => ({ ...item }));
                    console.log('Restored items:', currentOrder.items);
                }
                
                // Restore date
                if (draft.date) $('yDate').value = draft.date;
                
                // Restore PO and arrival date if saved
                if (draft.po) $('oiPO').value = draft.po;
                if (draft.arrivalDate) $('oiArrivalDate').value = draft.arrivalDate;
                
                // Restore order details
                if (draft.orderDetails) $('oiDetails').value = draft.orderDetails;
                
                // Restore consultant selection
                if (draft.consultant) {
                    currentOrder.consultantId = draft.consultant;
                }
                
                // Restore initials
                if (draft.initials) {
                    currentOrder.draftInitials = draft.initials;
                }
                
                // Go to the step they were on (allow up to step 5 for signing later)
                yStep = Math.min(draft.step || 1, 5);
                updateYSteps();
                
                // Render items after a short delay to ensure DOM is ready
                setTimeout(() => {
                    if (currentOrder.items.length > 0) {
                        renderOrderItems();
                    }
                    // Re-apply measurements one more time to be safe
                    if (draft.measurements) {
                        $('mBust').value = draft.measurements.bust || '';
                        $('mCup').value = draft.measurements.cup || '';
                        $('mWaist').value = draft.measurements.waist || '';
                        $('mHip').value = draft.measurements.hip || '';
                        $('mHeight').value = draft.measurements.height || '';
                        $('mWaistToFloor').value = draft.measurements.waistToFloor || '';
                        $('mHeels').value = draft.measurements.heels || '';
                        $('mNotes').value = draft.measurements.notes || '';
                        $('mTakenBy').value = draft.measurements.takenBy || '';
                    }
                }, 100);
                
                toast('Draft loaded!', 'success');
            }, 50);
        }
        
        async function deleteDraft(clientId) {
            const id = clientId || currentClient.ID;
            await updateRecord('Clients', id, { OrderDraft: '' });
            if (currentClient && currentClient.ID == id) {
                currentClient.OrderDraft = '';
            }
        }
        
        function hasDraft(clientId) {
            // Check Google Sheets draft
            const client = data.clients.find(c => c.ID == clientId);
            if (!client || !client.OrderDraft) return false;
            try {
                const draft = JSON.parse(client.OrderDraft);
                return draft && draft.savedAt;
            } catch (e) {
                return false;
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return 'yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return fmtDate(date.toISOString().split('T')[0]);
        }
        
        async function openClientAndSayYes(clientId) {
            // Get fresh client data from the array (which should have OrderDraft)
            const client = data.clients.find(c => c.ID == clientId);
            if (!client) {
                toast('Client not found', 'error');
                return;
            }
            
            // Open the client profile
            openClient(clientId);
            
            // Small delay to ensure UI is ready, then open Say Yes with auto-load draft
            setTimeout(() => sheSaidYes(true), 150);
        }
        
        async function deleteDraftFromDash(clientId) {
            const confirmed = await appConfirmDanger('Delete this draft?', 'Delete Draft');
            if (!confirmed) return;
            
            await updateRecord('Clients', clientId, { OrderDraft: '' });
            const client = data.clients.find(c => c.ID == clientId);
            if (client) client.OrderDraft = '';
            renderDash();
            toast('Draft deleted', 'success');
        }

        function updateYSteps() {
            [1,2,3,4,5,6].forEach(i => {
                $('ys'+i).classList.remove('active','done');
                $('yStep'+i).style.display = 'none';
                if (i < yStep) $('ys'+i).classList.add('done');
                if (i === yStep) { $('ys'+i).classList.add('active'); $('yStep'+i).style.display = 'block'; }
            });
            
            // Button visibility - simplified
            $('yPrev').style.display = yStep > 1 ? 'inline-flex' : 'none';
            $('yNext').style.display = yStep < 5 ? 'inline-flex' : 'none';
            $('ySaveOnly').style.display = (yStep === 5 || yStep === 6) ? 'inline-flex' : 'none';
            $('yGmail').style.display = yStep === 6 ? 'inline-flex' : 'none';
            $('yDone').style.display = yStep === 6 ? 'inline-flex' : 'none';
            
            // On step 5, show "Next" to go to email step (but don't require signatures)
            if (yStep === 5) {
                $('yNext').style.display = 'inline-flex';
                $('yNext').textContent = 'Email ‚Üí';
            } else {
                $('yNext').textContent = 'Next ‚Üí';
            }
            
            // Restore data when navigating to specific steps
            if (yStep === 1 && currentOrder.measurements) {
                // Restore measurements from currentOrder when going back to step 1
                const m = currentOrder.measurements;
                $('mBust').value = m.bust || '';
                $('mCup').value = m.cup || '';
                $('mWaist').value = m.waist || '';
                $('mHip').value = m.hip || '';
                $('mHeight').value = m.height || '';
                $('mWaistToFloor').value = m.waistToFloor || '';
                $('mHeels').value = m.heels || '';
                $('mNotes').value = m.notes || '';
                $('mTakenBy').value = m.takenBy || '';
                if (m.unit) {
                    measUnit = m.unit;
                    setMeasUnit(m.unit);
                }
                if (m.custom) {
                    customMeasurements = [...m.custom];
                    renderCustomMeas();
                }
            }
            
            if (yStep === 2) {
                // Ensure items are rendered
                renderOrderItems();
            }
            
            if (yStep === 4) genContract();
            
            if (yStep === 5) {
                initSig();
                // Restore consultant selection if saved
                if (currentOrder.consultantId) {
                    setTimeout(() => {
                        $('yConsultantSelect').value = currentOrder.consultantId;
                        loadConsultantSig();
                    }, 100);
                }
                // Restore initials if saved from draft
                if (currentOrder.draftInitials) {
                    setTimeout(() => {
                        if ($('init_bust') && currentOrder.draftInitials.bust) $('init_bust').value = currentOrder.draftInitials.bust;
                        if ($('init_waist') && currentOrder.draftInitials.waist) $('init_waist').value = currentOrder.draftInitials.waist;
                        if ($('init_hip') && currentOrder.draftInitials.hip) $('init_hip').value = currentOrder.draftInitials.hip;
                        if ($('init_other') && currentOrder.draftInitials.other) $('init_other').value = currentOrder.draftInitials.other;
                    }, 100);
                }
            }
            
            if (yStep === 6) prepareEmail();
        }

        function yNext() {
            if (yStep === 1) {
                // Validate Taken By is required
                if (!$('mTakenBy').value) {
                    toast('Please select who took the measurements', 'error');
                    return;
                }
                
                currentOrder.measurements = { 
                    bust: $('mBust').value,
                    cup: $('mCup').value,
                    waist: $('mWaist').value, 
                    hip: $('mHip').value, 
                    height: $('mHeight').value, 
                    waistToFloor: $('mWaistToFloor').value,
                    heels: $('mHeels').value, 
                    notes: $('mNotes').value,
                    unit: measUnit,
                    custom: [...customMeasurements],
                    takenBy: $('mTakenBy').value
                };
            }
            if (yStep === 2) {
                // Check if at least one item is added
                if (currentOrder.items.length === 0) {
                    toast('Please add at least one item to the order', 'error');
                    return;
                }
            }
            if (yStep === 3) {
                // Photos are optional - no validation needed
            }
            if (yStep === 5) {
                // Only require consultant selection
                const selectedId = $('yConsultantSelect').value;
                if (!selectedId) {
                    toast('Please select a consultant', 'error');
                    return;
                }
                
                const consultant = data.consultants.find(c => c.ID == selectedId);
                currentOrder.consultant = consultant ? consultant.Name : '';
                currentOrder.consultantId = selectedId;
                
                // Capture signatures if present (but don't require them)
                if (sigPadCustomer?.canvas && !isCanvasBlank(sigPadCustomer.canvas)) {
                    currentOrder.signatureData = sigPadCustomer.canvas.toDataURL();
                }
                if (sigPadConsultant?.canvas && !isCanvasBlank(sigPadConsultant.canvas)) {
                    currentOrder.consultantSignatureData = sigPadConsultant.canvas.toDataURL();
                }
                
                // Collect any initials that were entered
                currentOrder.initials = collectInitials();
                
                // Warn if missing signatures but allow proceeding
                const isCustomerSigBlank = isCanvasBlank(sigPadCustomer?.canvas);
                const hasInitials = $('init_bust')?.value?.trim() || $('init_waist')?.value?.trim() || $('init_hip')?.value?.trim();
                
                if (isCustomerSigBlank && !hasInitials) {
                    // No digital signatures - that's fine for paper signing workflow
                    console.log('Proceeding without digital signatures (paper signing workflow)');
                }
            }
            if (yStep < 6) { yStep++; updateYSteps(); }
        }
        
        function isCanvasBlank(canvas) {
            if (!canvas) return true;
            const ctx = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(
                ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            // Check if all pixels are white (0xFFFFFFFF)
            return pixelBuffer.every(color => color === 0xFFFFFFFF || color === 0);
        }
        
        function yPrev() { 
            // Save current step data before going back
            saveCurrentStepData();
            if (yStep > 1) { yStep--; updateYSteps(); } 
        }
        
        function saveCurrentStepData() {
            if (yStep === 1) {
                // Save measurements when leaving step 1
                currentOrder.measurements = { 
                    bust: $('mBust').value,
                    cup: $('mCup').value,
                    waist: $('mWaist').value, 
                    hip: $('mHip').value, 
                    height: $('mHeight').value, 
                    waistToFloor: $('mWaistToFloor').value,
                    heels: $('mHeels').value, 
                    notes: $('mNotes').value,
                    unit: measUnit,
                    custom: [...customMeasurements],
                    takenBy: $('mTakenBy').value
                };
            }
            if (yStep === 2) {
                // Items are already saved in currentOrder.items via addOrderItem
                // Save order details and tax settings
                currentOrder.orderDetails = $('oiDetails')?.value || '';
                currentOrder.taxType = $('taxHst')?.checked ? 'hst' : ($('taxCustom')?.checked ? 'custom' : 'none');
                currentOrder.customTaxRate = $('customTaxRate')?.value || '';
            }
            if (yStep === 5) {
                // Save consultant and initials
                currentOrder.consultantId = $('yConsultantSelect')?.value || '';
                currentOrder.draftInitials = {
                    bust: $('init_bust')?.value || '',
                    waist: $('init_waist')?.value || '',
                    hip: $('init_hip')?.value || '',
                    other: $('init_other')?.value || ''
                };
            }
        }
        
        function goToStep(step) {
            // Save current step data before navigating
            saveCurrentStepData();
            
            // Allow going back to any previous step, or forward only if validation passes
            if (step < yStep) {
                // Going back - always allowed
                yStep = step;
                updateYSteps();
            } else if (step > yStep) {
                // Going forward - need to validate each step
                // For now, just use yNext logic by calling it multiple times
                while (yStep < step) {
                    const prevStep = yStep;
                    yNext();
                    // If yNext didn't advance (validation failed), stop
                    if (yStep === prevStep) break;
                }
            }
        }

        // ========== PHOTO UPLOAD ==========
        let pendingPhotos = [];
        
        // Drag and drop handlers
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = $('photoDropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--rose)';
                    dropZone.style.background = 'var(--blush)';
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = 'var(--champagne)';
                    dropZone.style.background = '';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = 'var(--champagne)';
                    dropZone.style.background = '';
                    handlePhotoSelect({ target: { files: e.dataTransfer.files } });
                });
            }
            
            // Pull to refresh for mobile
            let touchStartY = 0;
            let touchCurrentY = 0;
            let isPulling = false;
            let isRefreshing = false;
            const pullThreshold = 80;
            const indicator = $('pullIndicator');
            const pullText = $('pullText');
            
            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !isRefreshing) {
                    touchStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                if (!isPulling || isRefreshing) return;
                
                touchCurrentY = e.touches[0].clientY;
                const pullDistance = touchCurrentY - touchStartY;
                
                if (pullDistance > 0 && window.scrollY === 0) {
                    if (pullDistance > 20) {
                        indicator.classList.add('visible');
                        if (pullDistance > pullThreshold) {
                            pullText.textContent = '‚Üë Release to refresh';
                        } else {
                            pullText.textContent = '‚Üì Pull to refresh';
                        }
                    }
                }
            }, { passive: true });
            
            document.addEventListener('touchend', async () => {
                if (!isPulling || isRefreshing) return;
                
                const pullDistance = touchCurrentY - touchStartY;
                
                if (pullDistance > pullThreshold && window.scrollY === 0) {
                    // Trigger refresh
                    isRefreshing = true;
                    pullText.innerHTML = '<div class="pull-spinner"></div> Syncing...';
                    indicator.classList.add('refreshing');
                    
                    try {
                        await syncData();
                    } catch (e) {
                        console.error('Refresh error:', e);
                    }
                    
                    setTimeout(() => {
                        indicator.classList.remove('visible', 'refreshing');
                        pullText.textContent = '‚Üì Pull to refresh';
                        isRefreshing = false;
                    }, 500);
                } else {
                    indicator.classList.remove('visible');
                }
                
                isPulling = false;
                touchStartY = 0;
                touchCurrentY = 0;
            }, { passive: true });
        });
        
        function handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    toast('Only image files allowed', 'error');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    toast(`${file.name} is too large (max 10MB)`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    pendingPhotos.push({
                        id: photoId,
                        name: file.name,
                        data: e.target.result,
                        file: file
                    });
                    renderPhotoPreview();
                };
                reader.readAsDataURL(file);
            });
            // Clear input so same file can be selected again
            event.target.value = '';
        }
        
        function renderPhotoPreview() {
            const grid = $('photoPreviewGrid');
            grid.innerHTML = pendingPhotos.map(p => `
                <div style="position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;background:var(--cream)">
                    <img src="${p.data}" style="width:100%;height:100%;object-fit:cover">
                    <button onclick="removePhoto('${p.id}')" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px">√ó</button>
                </div>
            `).join('');
        }
        
        function removePhoto(id) {
            pendingPhotos = pendingPhotos.filter(p => p.id !== id);
            renderPhotoPreview();
        }
        
        async function uploadPhotos() {
            if (pendingPhotos.length === 0) return [];
            
            const uploadedUrls = [];
            $('photoUploadStatus').style.display = 'block';
            
            for (let i = 0; i < pendingPhotos.length; i++) {
                const photo = pendingPhotos[i];
                $('photoUploadText').textContent = `Uploading photo ${i + 1} of ${pendingPhotos.length}...`;
                
                try {
                    const result = await api('POST', {
                        action: 'uploadPhoto',
                        clientId: currentClient.ID,
                        clientName: `${currentClient.FirstName}_${currentClient.LastName}`,
                        fileName: photo.name,
                        data: photo.data
                    });
                    
                    if (result && result.url) {
                        uploadedUrls.push(result.url);
                    }
                } catch (e) {
                    console.error('Photo upload error:', e);
                    toast(`Failed to upload ${photo.name}`, 'error');
                }
            }
            
            $('photoUploadStatus').style.display = 'none';
            return uploadedUrls;
        }

        function toggleOrderItemFields() {
            const type = $('oiType').value;
            $('oiDesignerFields').style.display = (type === 'dress' || type === 'accessory') ? 'block' : 'none';
            $('oiInhouseFields').style.display = type === 'inhouse' ? 'block' : 'none';
            $('oiCustomFields').style.display = type === 'customization' ? 'block' : 'none';
            $('oiFeeFields').style.display = type === 'fee' ? 'block' : 'none';
            $('oiDiscountFields').style.display = type === 'discount' ? 'block' : 'none';
            $('oiCustomItemFields').style.display = type === 'custom' ? 'block' : 'none';
            
            // Reset rush options when switching types
            if (type === 'fee') {
                toggleRushOptions();
            }
            
            // Populate designer dropdown when showing designer fields
            if (type === 'dress' || type === 'accessory') {
                populateDesignerDropdown();
            }
            
            // Populate parent dropdown for customizations
            if (type === 'customization') {
                const parentItems = currentOrder.items.filter(i => i.type === 'dress' || i.type === 'accessory' || i.type === 'inhouse');
                $('oiCustomParent').innerHTML = '<option value="">Select item...</option>' + 
                    parentItems.map((item, idx) => {
                        const label = item.type === 'inhouse' ? item.name : `${item.designer} - ${item.name}`;
                        return `<option value="${item.id}">${label}</option>`;
                    }).join('');
            }
        }
        
        function toggleRushOptions() {
            const feeType = $('oiFeeType').value;
            const rushOptions = $('oiRushOptions');
            const amountGroup = $('oiFeeAmountGroup');
            
            if (feeType === 'rush') {
                rushOptions.style.display = 'block';
                // Populate apply-to dropdown with current items
                populateRushApplyTo();
                toggleRushType();
            } else {
                rushOptions.style.display = 'none';
                amountGroup.style.display = 'block';
            }
        }
        
        function toggleRushType() {
            const rushType = document.querySelector('input[name="oiRushType"]:checked')?.value || 'fixed';
            const amountGroup = $('oiFeeAmountGroup');
            const percentGroup = $('oiRushPercentGroup');
            
            if (rushType === 'percent') {
                amountGroup.style.display = 'none';
                percentGroup.style.display = 'block';
                calculateRushPercent();
            } else {
                amountGroup.style.display = 'block';
                percentGroup.style.display = 'none';
            }
        }
        
        function populateRushApplyTo() {
            const items = currentOrder.items.filter(i => i.type === 'dress' || i.type === 'accessory' || i.type === 'inhouse');
            let html = '<option value="all">Entire Order</option>';
            
            items.forEach(item => {
                const label = item.designer ? `${item.designer} - ${item.name}` : item.name;
                html += `<option value="${item.id}">${label}</option>`;
            });
            
            $('oiRushApplyTo').innerHTML = html;
            
            // Add change listener to recalculate
            $('oiRushApplyTo').onchange = calculateRushPercent;
            $('oiRushPercent').oninput = calculateRushPercent;
        }
        
        function calculateRushPercent() {
            const percent = parseFloat($('oiRushPercent').value) || 0;
            const applyTo = $('oiRushApplyTo').value;
            let baseAmount = 0;
            
            if (applyTo === 'all') {
                // Calculate from all items (excluding fees and discounts)
                currentOrder.items.forEach(item => {
                    if (item.type !== 'fee' && item.type !== 'discount') {
                        baseAmount += item.price || 0;
                        if (item.customizations) {
                            item.customizations.forEach(c => baseAmount += c.price || 0);
                        }
                    }
                });
            } else {
                // Calculate from specific item
                const item = currentOrder.items.find(i => i.id === applyTo);
                if (item) {
                    baseAmount = item.price || 0;
                    if (item.customizations) {
                        item.customizations.forEach(c => baseAmount += c.price || 0);
                    }
                }
            }
            
            const rushAmount = Math.round(baseAmount * percent / 100 * 100) / 100;
            const applyLabel = applyTo === 'all' ? 'entire order' : $('oiRushApplyTo').options[$('oiRushApplyTo').selectedIndex].text;
            $('oiRushCalculated').innerHTML = percent > 0 ? 
                `${percent}% of ${money(baseAmount)} (${applyLabel}) = <b>${money(rushAmount)}</b>` : '';
        }
        
        function populateDesignerDropdown() {
            // Get designers from designerData (localStorage)
            console.log('populateDesignerDropdown called, designerData:', designerData);
            
            // Ensure designerData is loaded
            if (!designerData || designerData.length === 0) {
                loadDesignerData();
            }
            
            // Deduplicate by name (case-insensitive)
            const seen = new Set();
            const designerNames = (designerData || [])
                .map(d => d.name)
                .filter(name => {
                    if (!name) return false;
                    const key = name.trim().toLowerCase();
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                })
                .sort();
            console.log('Designer names:', designerNames);
            
            $('oiDesignerSelect').innerHTML = '<option value="">Select designer...</option>' +
                designerNames.map(name => `<option value="${name}">${name}</option>`).join('') +
                '<option value="__custom__">+ Add custom designer</option>';
            
            // Reset custom input
            $('oiDesigner').style.display = 'none';
            $('oiDesigner').value = '';
        }
        
        function handleDesignerSelect() {
            const selected = $('oiDesignerSelect').value;
            if (selected === '__custom__') {
                $('oiDesigner').style.display = 'block';
                $('oiDesigner').focus();
            } else {
                $('oiDesigner').style.display = 'none';
                $('oiDesigner').value = selected;
            }
        }
        
        function getSelectedDesigner() {
            const selected = $('oiDesignerSelect').value;
            if (selected === '__custom__') {
                return $('oiDesigner').value.trim();
            }
            return selected;
        }
        
        function addOrderItem() {
            const type = $('oiType').value;
            const id = 'item_' + Date.now();
            let item = { id, type };
            
            if (type === 'dress' || type === 'accessory') {
                item.designer = getSelectedDesigner();
                item.name = $('oiStyle').value.trim();
                item.size = $('oiSize').value.trim();
                item.color = $('oiColor').value.trim();
                item.price = parsePriceInput($('oiPrice').value);
                item.customizations = [];
                item.qaChecked = false;
                item.arrived = false;
                if (!item.designer || !item.name) { toast('Enter designer and style'); return; }
                
                // Clear fields
                ['oiDesigner','oiStyle','oiSize','oiColor','oiPrice'].forEach(i => $(i).value = '');
                $('oiDesignerSelect').value = '';
                $('oiDesigner').style.display = 'none';
            } else if (type === 'inhouse') {
                item.name = $('oiInhouseName').value.trim();
                item.price = parsePriceInput($('oiInhousePrice').value);
                item.notes = $('oiInhouseNotes').value.trim();
                item.status = 'pending';
                if (!item.name) { toast('Enter item name'); return; }
                ['oiInhouseName','oiInhousePrice','oiInhouseNotes'].forEach(i => $(i).value = '');
            } else if (type === 'customization') {
                const parentId = $('oiCustomParent').value;
                item.parentId = parentId;
                item.name = $('oiCustomName').value.trim();
                item.price = parsePriceInput($('oiCustomPrice').value);
                item.delivery = document.querySelector('input[name="oiCustomDelivery"]:checked')?.value || 'ondress';
                item.qaChecked = false;
                if (!item.name) { toast('Enter customization name'); return; }
                if (!parentId) { toast('Select item to attach customization to'); return; }
                
                // Add to parent item's customizations array
                const parent = currentOrder.items.find(i => i.id === parentId);
                if (parent) {
                    parent.customizations = parent.customizations || [];
                    parent.customizations.push({ id: item.id, name: item.name, price: item.price, delivery: item.delivery, qaChecked: false });
                }
                ['oiCustomName','oiCustomPrice'].forEach(i => $(i).value = '');
                $('oiCustomParent').value = '';
            } else if (type === 'fee') {
                item.feeType = $('oiFeeType').value;
                
                if (item.feeType === 'rush') {
                    const rushType = document.querySelector('input[name="oiRushType"]:checked')?.value || 'fixed';
                    
                    if (rushType === 'percent') {
                        const percent = parseFloat($('oiRushPercent').value) || 0;
                        const applyTo = $('oiRushApplyTo').value;
                        
                        if (!percent) { toast('Enter rush fee percentage'); return; }
                        
                        // Calculate the amount
                        let baseAmount = 0;
                        if (applyTo === 'all') {
                            currentOrder.items.forEach(i => {
                                if (i.type !== 'fee' && i.type !== 'discount') {
                                    baseAmount += i.price || 0;
                                    if (i.customizations) {
                                        i.customizations.forEach(c => baseAmount += c.price || 0);
                                    }
                                }
                            });
                            item.name = `Rush Fee (${percent}% of order)`;
                        } else {
                            const targetItem = currentOrder.items.find(i => i.id === applyTo);
                            if (targetItem) {
                                baseAmount = targetItem.price || 0;
                                if (targetItem.customizations) {
                                    targetItem.customizations.forEach(c => baseAmount += c.price || 0);
                                }
                                const targetLabel = targetItem.designer ? `${targetItem.designer} ${targetItem.name}` : targetItem.name;
                                item.name = `Rush Fee (${percent}% of ${targetLabel})`;
                            }
                        }
                        
                        item.price = Math.round(baseAmount * percent / 100 * 100) / 100;
                        item.rushPercent = percent;
                        item.rushApplyTo = applyTo;
                    } else {
                        item.name = 'Rush Fee';
                        item.price = parsePriceInput($('oiFeePrice').value);
                    }
                } else {
                    item.name = item.feeType === 'shipping' ? 'Shipping' : $('oiFeeNote').value || 'Other Fee';
                    item.price = parsePriceInput($('oiFeePrice').value);
                }
                
                item.note = $('oiFeeNote').value.trim();
                if (!item.price) { toast('Enter fee amount'); return; }
                
                // Reset fields
                ['oiFeePrice','oiFeeNote'].forEach(i => $(i).value = '');
                $('oiRushPercent').value = '';
                $('oiRushApplyTo').value = 'all';
                $('oiRushCalculated').innerHTML = '';
                document.querySelector('input[name="oiRushType"][value="fixed"]').checked = true;
                toggleRushType();
            } else if (type === 'discount') {
                item.name = $('oiDiscountName').value.trim() || 'Discount';
                const amount = parsePriceInput($('oiDiscountAmount').value);
                item.price = -Math.abs(amount); // Store as negative
                if (!amount) { toast('Enter discount amount'); return; }
                ['oiDiscountName','oiDiscountAmount'].forEach(i => $(i).value = '');
            } else if (type === 'custom') {
                item.name = $('oiCustomItemName').value.trim();
                item.price = parsePriceInput($('oiCustomItemPrice').value);
                item.notes = $('oiCustomItemDesc').value.trim();
                if (!item.name) { toast('Enter item name'); return; }
                ['oiCustomItemName','oiCustomItemPrice','oiCustomItemDesc'].forEach(i => $(i).value = '');
            }
            
            // Don't add customization as separate item (it's attached to parent)
            if (type !== 'customization') {
                currentOrder.items.push(item);
            }
            
            renderOrderItems();
            toast('Item added', 'success');
        }

        async function removeOrderItem(index) {
            const item = currentOrder.items[index];
            const itemName = item.designer ? `${item.designer} ‚Äî ${item.name}` : item.name;
            const confirmed = await appConfirmDanger(`Remove "${itemName}" from order?`, 'Remove Item');
            if (confirmed) {
                currentOrder.items.splice(index, 1);
                renderOrderItems();
            }
        }
        
        async function editOrderItem(index) {
            const item = currentOrder.items[index];
            if (!item) return;
            
            if (item.type === 'dress' || item.type === 'accessory') {
                const newName = await appPrompt('Style/Name:', item.name, 'Edit Item');
                if (newName === null) return;
                
                const newSize = await appPrompt('Size:', item.size || '', 'Edit Item');
                if (newSize === null) return;
                
                const newColor = await appPrompt('Color:', item.color || '', 'Edit Item');
                if (newColor === null) return;
                
                const newPrice = await appPrompt('Price:', String(item.price || 0), 'Edit Item');
                if (newPrice === null) return;
                
                item.name = newName.trim() || item.name;
                item.size = newSize.trim();
                item.color = newColor.trim();
                item.price = parseFloat(newPrice) || item.price;
                
            } else if (item.type === 'inhouse') {
                const newName = await appPrompt('Item Name:', item.name, 'Edit Item');
                if (newName === null) return;
                
                const newPrice = await appPrompt('Price:', String(item.price || 0), 'Edit Item');
                if (newPrice === null) return;
                
                const newNotes = await appPrompt('Notes:', item.notes || '', 'Edit Item');
                if (newNotes === null) return;
                
                item.name = newName.trim() || item.name;
                item.price = parseFloat(newPrice) || item.price;
                item.notes = newNotes.trim();
            }
            
            renderOrderItems();
            toast('Item updated', 'success');
        }
        
        function removeCustomization(parentId, customIdx) {
            const parent = currentOrder.items.find(i => i.id === parentId);
            if (parent && parent.customizations) {
                parent.customizations.splice(customIdx, 1);
                renderOrderItems();
            }
        }

        function renderOrderItems() {
            // Group items by type
            const designers = {}; // Group dress/accessory by designer
            const inhouse = currentOrder.items.filter(i => i.type === 'inhouse');
            const fees = currentOrder.items.filter(i => i.type === 'fee');
            const discounts = currentOrder.items.filter(i => i.type === 'discount');
            
            currentOrder.items.filter(i => i.type === 'dress' || i.type === 'accessory').forEach(item => {
                if (!designers[item.designer]) designers[item.designer] = [];
                designers[item.designer].push(item);
            });
            
            let html = '';
            
            // Designer items
            Object.keys(designers).forEach(designer => {
                html += `<div style="margin-bottom:12px">
                    <div style="font-size:9px;font-weight:600;color:var(--taupe);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">${designer}</div>`;
                designers[designer].forEach((item, idx) => {
                    const itemIdx = currentOrder.items.indexOf(item);
                    html += `<div class="order-item" style="flex-direction:column;align-items:stretch">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div class="order-item-info" style="cursor:pointer" onclick="editOrderItem(${itemIdx})">
                                <div class="order-item-name">${item.type === 'dress' ? 'Dress' : 'Accessory'}: ${item.name}</div>
                                <div class="order-item-meta">${item.size ? 'Size ' + item.size : ''}${item.color ? ' ¬∑ ' + item.color : ''}</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <div class="order-item-price">${money(item.price)}</div>
                                <button class="action-btn" onclick="editOrderItem(${itemIdx})" title="Edit">‚úèÔ∏è</button>
                                <button class="order-remove" onclick="removeOrderItem(${itemIdx})">√ó</button>
                            </div>
                        </div>`;
                    // Show customizations
                    if (item.customizations && item.customizations.length > 0) {
                        html += `<div style="margin-left:16px;margin-top:6px;padding-left:8px;border-left:2px solid var(--champagne)">`;
                        item.customizations.forEach((c, cidx) => {
                            html += `<div style="display:flex;justify-content:space-between;align-items:center;font-size:10px;padding:2px 0">
                                <span>üîß ${c.name} <span style="color:var(--taupe)">(${c.delivery === 'ondress' ? 'on dress' : 'separate'})</span></span>
                                <span style="display:flex;align-items:center;gap:6px">
                                    ${money(c.price)}
                                    <button onclick="removeCustomization('${item.id}', ${cidx})" style="background:none;border:none;color:#c00;cursor:pointer;font-size:12px">√ó</button>
                                </span>
                            </div>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
            });
            
            // In-house items
            if (inhouse.length > 0) {
                html += `<div style="margin-bottom:12px">
                    <div style="font-size:9px;font-weight:600;color:var(--taupe);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">In-House</div>`;
                inhouse.forEach(item => {
                    const itemIdx = currentOrder.items.indexOf(item);
                    html += `<div class="order-item">
                        <div class="order-item-info" style="cursor:pointer" onclick="editOrderItem(${itemIdx})">
                            <div class="order-item-name">${item.name}</div>
                            ${item.notes ? `<div class="order-item-meta" style="font-style:italic">${item.notes.substring(0, 50)}${item.notes.length > 50 ? '...' : ''}</div>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="order-item-price">${money(item.price)}</div>
                            <button class="action-btn" onclick="editOrderItem(${itemIdx})" title="Edit">‚úèÔ∏è</button>
                            <button class="order-remove" onclick="removeOrderItem(${itemIdx})">√ó</button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            
            // Fees
            if (fees.length > 0) {
                html += `<div style="margin-bottom:12px">
                    <div style="font-size:9px;font-weight:600;color:var(--taupe);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">Fees</div>`;
                fees.forEach(item => {
                    const itemIdx = currentOrder.items.indexOf(item);
                    html += `<div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">${item.name}</div>
                            ${item.note ? `<div class="order-item-meta">${item.note}</div>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="order-item-price">${money(item.price)}</div>
                            <button class="order-remove" onclick="removeOrderItem(${itemIdx})">√ó</button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            
            // Discounts
            if (discounts.length > 0) {
                html += `<div style="margin-bottom:12px">
                    <div style="font-size:9px;font-weight:600;color:var(--sage);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">üè∑Ô∏è Discounts</div>`;
                discounts.forEach(item => {
                    const itemIdx = currentOrder.items.indexOf(item);
                    html += `<div class="order-item" style="background:#e8f4ea">
                        <div class="order-item-info">
                            <div class="order-item-name">${item.name}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="order-item-price" style="color:var(--sage)">-${money(Math.abs(item.price))}</div>
                            <button class="order-remove" onclick="removeOrderItem(${itemIdx})">√ó</button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            
            $('orderItems').innerHTML = html || '<div class="empty">No items</div>';
            
            // Calculate totals including customizations
            let subtotal = 0;
            currentOrder.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(c => subtotal += c.price || 0);
                }
            });
            
            // Get tax rate from radio selection
            const taxInfo = getTaxInfo();
            const taxAmount = Math.round(subtotal * taxInfo.rate * 100) / 100;
            const total = subtotal + taxAmount;
            
            currentOrder.taxType = taxInfo.type;
            currentOrder.taxRate = taxInfo.rate;
            currentOrder.taxAmount = taxAmount;
            currentOrder.subtotal = subtotal;
            currentOrder.total = total;
            // Keep hst for backwards compatibility
            currentOrder.hst = taxInfo.rate > 0;
            currentOrder.hstAmount = taxAmount;
            
            if (taxInfo.rate > 0) {
                $('orderSubtotal').style.display = 'flex';
                $('orderSubtotal').innerHTML = `<span>Subtotal</span><span>${money(subtotal)}</span>`;
                $('orderSubtotal').style.justifyContent = 'space-between';
                $('orderHstRow').style.display = 'flex';
                $('orderHstRow').innerHTML = `<span>${taxInfo.label}</span><span>${money(taxAmount)}</span>`;
                $('orderHstRow').style.justifyContent = 'space-between';
            } else {
                $('orderSubtotal').style.display = 'none';
                $('orderHstRow').style.display = 'none';
            }
            
            $('orderTotal').textContent = money(total);
        }
        
        function getTaxInfo() {
            if ($('taxHst').checked) {
                return { type: 'hst', rate: 0.13, label: 'HST (13%)' };
            } else if ($('taxCustom').checked) {
                const rate = parseFloat($('customTaxRate').value) || 0;
                return { type: 'custom', rate: rate / 100, label: `Tax (${rate}%)` };
            } else {
                return { type: 'none', rate: 0, label: '' };
            }
        }
        
        function updateTaxOption() {
            renderOrderItems();
        }
        
        function openQuickEditClient() {
            const c = currentClient;
            const email = prompt('Email:', c.Email || '');
            if (email === null) return; // Cancelled
            
            const phone = prompt('Phone:', c.Phone || '');
            if (phone === null) return;
            
            const weddingDate = prompt('Wedding Date (YYYY-MM-DD):', c.WeddingDate || '');
            if (weddingDate === null) return;
            
            // Update client
            const updates = {};
            if (email !== c.Email) updates.Email = email;
            if (phone !== c.Phone) updates.Phone = phone;
            if (weddingDate !== c.WeddingDate) updates.WeddingDate = weddingDate;
            
            if (Object.keys(updates).length > 0) {
                // Update local
                Object.assign(currentClient, updates);
                
                // Update in Google Sheets
                updateRecord('Clients', c.ID, updates);
                saveCachedData();
                
                // Refresh contract preview
                genContract();
                toast('Client info updated!', 'success');
            }
        }

        function genContract() {
            const c = currentClient;
            const o = currentOrder;
            
            // Calculate totals including customizations
            let subtotal = 0;
            o.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(c => subtotal += c.price || 0);
                }
            });
            
            const hst = o.hst ? Math.round(subtotal * 0.13 * 100) / 100 : 0;
            const total = subtotal + hst;
            const unit = measUnit;
            
            let hstRows = '';
            if (o.hst) {
                hstRows = `
                    <tr><td colspan="4" style="text-align:right">Subtotal</td><td>${money(subtotal)}</td></tr>
                    <tr><td colspan="4" style="text-align:right">HST (13%)</td><td>${money(hst)}</td></tr>
                `;
            }
            
            let customMeasRows = '';
            if (customMeasurements.length > 0) {
                customMeasRows = customMeasurements.map(m => 
                    `<tr><td>${m.name}</td><td>${m.value} ${m.unit}</td><td style="width:80px;border:1px solid #ccc"></td></tr>`
                ).join('');
            }
            
            // Build items table with new structure
            let itemsHtml = '';
            o.items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    const typeLabel = item.type === 'dress' ? 'üëó Dress' : '‚ú® Accessory';
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>${item.designer || '‚Äî'}</td>
                        <td>${item.size || '‚Äî'}${item.color ? ', ' + item.color : ''}</td>
                        <td>‚Äî</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                    // Add customizations as sub-items
                    if (item.customizations && item.customizations.length > 0) {
                        item.customizations.forEach(cust => {
                            itemsHtml += `<tr style="font-size:11px;color:var(--taupe)">
                                <td style="padding-left:20px">‚Ü≥ ${cust.name}</td>
                                <td>${item.designer}</td>
                                <td>${cust.delivery === 'ondress' ? 'On dress' : 'Separate'}</td>
                                <td>Customization</td>
                                <td>${money(cust.price)}</td>
                            </tr>`;
                        });
                    }
                } else if (item.type === 'inhouse') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>In-House</td>
                        <td>‚Äî</td>
                        <td>${item.notes ? item.notes.substring(0, 30) + '...' : '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                } else if (item.type === 'fee') {
                    itemsHtml += `<tr style="font-size:11px">
                        <td>${item.name}</td>
                        <td>‚Äî</td>
                        <td>‚Äî</td>
                        <td>${item.note || '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                }
            });
            
            $('contractPreview').innerHTML = `
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:24px;letter-spacing:0.15em;font-weight:600">ESTRELLE</div>
                    <div style="font-size:10px;letter-spacing:0.2em;color:var(--rose)">BRIDAL</div>
                </div>
                <h2 style="text-align:center;font-size:18px;margin-bottom:20px">SALES CONTRACT</h2>
                
                <div style="background:var(--blush);padding:12px;border-radius:5px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <h3 style="margin:0;font-size:12px">CUSTOMER INFORMATION</h3>
                        <button class="btn btn-sm btn-secondary" onclick="openQuickEditClient()" style="font-size:10px">‚úèÔ∏è Edit</button>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
                        <div><b>Name:</b> ${c.FirstName} ${c.LastName}</div>
                        <div><b>Email:</b> ${c.Email || '<span style="color:#e74c3c">Missing</span>'}</div>
                        <div><b>Phone:</b> ${c.Phone || '‚Äî'}</div>
                        <div><b>Wedding Date:</b> ${fmtDate(c.WeddingDate) || '<span style="color:#e74c3c">Missing</span>'}</div>
                        <div><b>Contract Date:</b> ${fmtDate(today())}</div>
                    </div>
                </div>
                
                <h3>PARTIES</h3>
                <p>This Sales Contract (hereinafter referred to as the "Contract") is entered into on <b>${fmtDate(today())}</b> (the "Effective Date"), by and between Estrelle Bridal (ESTR INC.) with an address of 55 Avenue Road, #201.5, Toronto, Canada, M5R 3L2 (hereinafter referred to as the "Seller"), and <b>${c.FirstName} ${c.LastName}</b> (hereinafter referred to as the "Customer") (collectively referred to as the "Parties").</p>
                
                <h3>GOODS AND PRICE</h3>
                <p>The goods that the Seller is selling to the Customer are enlisted below with their quantities (hereinafter referred to as the "Goods").</p>
                <table><tr><th>Product</th><th>Designer/Source</th><th>Details</th><th>Notes</th><th>Price</th></tr>
                ${itemsHtml}
                ${hstRows}
                <tr><td colspan="4" style="text-align:right;font-weight:bold">TOTAL</td><td style="font-weight:bold">${money(total)}</td></tr></table>
                ${$('oiDetails').value ? `<p><b>Important ordering details:</b> ${$('oiDetails').value}</p>` : ''}
                
                <h3>MEASUREMENTS</h3>
                ${o.measurements.takenBy ? `<p style="font-size:11px;margin-bottom:8px"><b>Measured by:</b> ${o.measurements.takenBy}</p>` : ''}
                <table>
                    <tr><th>Item</th><th>Measurement</th><th style="width:80px">Client's Initial</th></tr>
                    <tr><td>Bust</td><td>${o.measurements.bust||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Cup Size</td><td>${o.measurements.cup||'‚Äî'}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Waist</td><td>${o.measurements.waist||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Hip</td><td>${o.measurements.hip||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    <tr><td>Height</td><td>${o.measurements.height||'‚Äî'} ${unit}</td><td style="border:1px solid #ccc"></td></tr>
                    ${o.measurements.waistToFloor ? `<tr><td>Waist to Floor</td><td>${o.measurements.waistToFloor} ${unit}</td><td style="border:1px solid #ccc"></td></tr>` : ''}
                    <tr><td>Heels</td><td>${o.measurements.heels||'‚Äî'}"</td><td style="border:1px solid #ccc"></td></tr>
                    ${customMeasRows}
                </table>
                ${o.measurements.notes ? `<p><b>Important measurement notes:</b> ${o.measurements.notes}</p>` : ''}
                
                <h3>PAYMENT TERMS</h3>
                <p>The Customer agrees to make an initial deposit of at least 50% of the total purchase price upon placing the order, which is non-refundable.</p>
                <p>The Seller will send a balance finalization request to the Buyer by the end of the production, and the Customer agrees to pay the remaining balance in full before shipment.</p>
                
                <h3>DELIVERY AND SHIPPING</h3>
                <p>The delivery of the goods (hereinafter referred to as the "Delivery") will be at Estrelle Bridal.</p>
                <p>The shipping method will be decided by the suppliers and Seller will be responsible for the costs of the shipment.</p>
                
                <h3>NO REFUNDS OR RETURNS</h3>
                <p>The Customer acknowledges that the wedding dress is made-to-order or customized to their specifications. Therefore, NO returns or refunds will be accepted after the order has been confirmed and production has started.</p>
                
                <h3>CANCELLATION OF ORDERS</h3>
                <p>The Customer who cancels their sales contract are NOT entitled to a refund of ANY monies paid up to and including the cancellation date. The Customer is required to make full payment as per the original order agreement, even in the event of order cancellation, costs will still be incurred to the suppliers and to the Seller regardless of any circumstance.</p>
                
                <h3>INSPECTION</h3>
                <p>Hereby, the Customer acknowledges that it has relied solely on the investigations, examinations, and inspections that the Customer has chosen to make and that the Seller has afforded the Customer the opportunity for full and complete investigations, examinations, and inspections.</p>
                
                <h3>RISK OF LOSS AND TITLE</h3>
                <p>The risk of loss or damage for the goods will be on the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                <p>The Title of the goods will also remain with the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                
                <h3>DELAY OR FAILURE TO PERFORM AND FORCE MAJEURE</h3>
                <p>Under no circumstances will the Seller be held liable to the Customer for any delay that may occur, non-delivery or an arising fault of this Agreement that may be due to any labour dispute, shortage in transportation, delay or shortage of materials to produce the Goods, fires, accidents, Acts of God, or any other causes outside Seller's control. The Seller will notify the Customer immediately upon realization that it will not be able to deliver the Goods as promised. Upon such notice, either Party may terminate this Agreement.</p>
                
                <h3>LIMITATION OF LIABILITY</h3>
                <p>Under no circumstances will the Seller be liable for any indirect, special, consequential, or punitive damages (including lost profits) arising out of or relating to this Agreement or the transactions it contemplates (whether for breach of contract, tort, negligence, or other form of action).</p>
                
                <h3>FIT & BODY SIZE CHANGES</h3>
                <p>The Customer acknowledges that the wedding dress is ordered based on measurements taken at the time of purchase. The Seller is not responsible for any changes in the Customer's body size or shape after the order is placed. Any significant fluctuations in weight or body measurements may affect the fit, potentially requiring substantial alterations at the Customer's expense, or, in some cases, resulting in the dress not fitting as intended. The Seller bears no liability for such outcomes.</p>
                
                <h3>ENTIRE AGREEMENT</h3>
                <p>This Agreement contains the entire agreement and understanding among the Parties hereto with respect to the subject matter hereof, and supersedes all prior agreements, understandings, inducements and conditions, express or implied, oral or written, of any nature whatsoever with respect to the subject matter hereof. The express terms hereof control and supersede any course of performance and/or usage of the trade inconsistent with any of the terms hereof.</p>
                
                <h3>FORCE MAJEURE</h3>
                <p>The Seller will not be liable for delays in performance or for non-performance due to unforeseen circumstances or causes beyond the Seller's reasonable control.</p>
            `;
        }

        let sigPadCustomer, sigPadConsultant, drawingCustomer = false, drawingConsultant = false;
        let measInitialsData = {};
        
        function initSig() {
            // Populate consultant dropdown
            $('yConsultantSelect').innerHTML = '<option value="">Select consultant... *</option>' + 
                data.consultants.map(c => `<option value="${c.ID}">${c.Name}</option>`).join('');
            $('consultantSigNote').textContent = 'Select consultant above to load signature';
            
            // Render measurement initials - core 3 get individual initials, rest grouped
            const o = currentOrder;
            const unit = o.measurements.unit || 'cm';
            
            // Core measurements - individual initials required
            const coreMeasurements = [
                { key: 'bust', label: 'Bust', value: o.measurements.bust, unit: unit },
                { key: 'waist', label: 'Waist', value: o.measurements.waist, unit: unit },
                { key: 'hip', label: 'Hip', value: o.measurements.hip, unit: unit }
            ];
            
            // Other measurements - grouped under one initial
            const otherMeasurements = [
                { key: 'cup', label: 'Cup Size', value: o.measurements.cup, unit: '' },
                { key: 'height', label: 'Height', value: o.measurements.height, unit: unit },
                { key: 'waistToFloor', label: 'Waist to Floor', value: o.measurements.waistToFloor, unit: unit },
                { key: 'heels', label: 'Heels', value: o.measurements.heels, unit: '"' }
            ];
            
            // Add custom measurements to others
            if (o.measurements.custom) {
                o.measurements.custom.forEach((m, i) => {
                    otherMeasurements.push({ key: 'custom_' + i, label: m.name, value: m.value, unit: m.unit });
                });
            }
            
            const otherWithValues = otherMeasurements.filter(m => m.value);
            
            let html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:10px;color:var(--rose)">* Required initials</div><button class="btn btn-sm btn-secondary" onclick="initialAll()" style="font-size:10px">‚úçÔ∏è Initial All</button></div>';
            
            // Core measurements with individual initials
            coreMeasurements.filter(m => m.value).forEach(m => {
                html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--champagne)">
                    <span style="font-size:12px;font-weight:500">${m.label}: ${m.value} ${m.unit}</span>
                    <input type="text" class="form-input init-field" style="width:60px;padding:4px;text-align:center;font-size:12px;border:2px solid var(--dusty)" placeholder="Initial *" id="init_${m.key}" maxlength="4" required>
                </div>`;
            });
            
            // Other measurements grouped
            if (otherWithValues.length > 0) {
                html += `<div style="padding:8px 0;border-bottom:1px solid var(--champagne)">
                    <div style="font-size:10px;color:var(--taupe);margin-bottom:6px">Other Measurements:</div>
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <span style="font-size:11px">${otherWithValues.map(m => `${m.label}: ${m.value}${m.unit}`).join(', ')}</span>
                        <input type="text" class="form-input init-field" style="width:60px;padding:4px;text-align:center;font-size:12px;border:2px solid var(--dusty)" placeholder="Initial *" id="init_other" maxlength="4" required>
                    </div>
                </div>`;
            }
            
            $('measInitials').innerHTML = html;
            
            // Customer signature
            const canvas1 = $('sigPad');
            const ctx1 = canvas1.getContext('2d');
            ctx1.fillStyle = 'white';
            ctx1.fillRect(0, 0, canvas1.width, canvas1.height);
            ctx1.strokeStyle = '#2C2825';
            ctx1.lineWidth = 2;
            ctx1.lineCap = 'round';
            const getPos1 = e => { const r = canvas1.getBoundingClientRect(); return { x: ((e.clientX||e.touches?.[0]?.clientX) - r.left) * (canvas1.width/r.width), y: ((e.clientY||e.touches?.[0]?.clientY) - r.top) * (canvas1.height/r.height) }; };
            canvas1.onmousedown = canvas1.ontouchstart = e => { e.preventDefault(); drawingCustomer = true; canvas1.classList.add('active'); const p = getPos1(e); ctx1.beginPath(); ctx1.moveTo(p.x, p.y); };
            canvas1.onmousemove = canvas1.ontouchmove = e => { if (!drawingCustomer) return; e.preventDefault(); const p = getPos1(e); ctx1.lineTo(p.x, p.y); ctx1.stroke(); };
            canvas1.onmouseup = canvas1.ontouchend = canvas1.onmouseleave = () => { drawingCustomer = false; canvas1.classList.remove('active'); $('sigTime').textContent = new Date().toLocaleString(); };
            sigPadCustomer = { canvas: canvas1, ctx: ctx1 };
            
            // Consultant signature
            const canvas2 = $('sigPadConsultant');
            const ctx2 = canvas2.getContext('2d');
            ctx2.fillStyle = 'white';
            ctx2.fillRect(0, 0, canvas2.width, canvas2.height);
            ctx2.strokeStyle = '#2C2825';
            ctx2.lineWidth = 2;
            ctx2.lineCap = 'round';
            const getPos2 = e => { const r = canvas2.getBoundingClientRect(); return { x: ((e.clientX||e.touches?.[0]?.clientX) - r.left) * (canvas2.width/r.width), y: ((e.clientY||e.touches?.[0]?.clientY) - r.top) * (canvas2.height/r.height) }; };
            canvas2.onmousedown = canvas2.ontouchstart = e => { e.preventDefault(); drawingConsultant = true; canvas2.classList.add('active'); const p = getPos2(e); ctx2.beginPath(); ctx2.moveTo(p.x, p.y); };
            canvas2.onmousemove = canvas2.ontouchmove = e => { if (!drawingConsultant) return; e.preventDefault(); const p = getPos2(e); ctx2.lineTo(p.x, p.y); ctx2.stroke(); };
            canvas2.onmouseup = canvas2.ontouchend = canvas2.onmouseleave = () => { drawingConsultant = false; canvas2.classList.remove('active'); $('sigTimeConsultant').textContent = new Date().toLocaleString(); };
            sigPadConsultant = { canvas: canvas2, ctx: ctx2 };
        }
        
        function clearSig(type) {
            if (type === 'customer' && sigPadCustomer) {
                sigPadCustomer.ctx.fillStyle = 'white';
                sigPadCustomer.ctx.fillRect(0, 0, sigPadCustomer.canvas.width, sigPadCustomer.canvas.height);
                $('sigTime').textContent = '';
            } else if (type === 'consultant' && sigPadConsultant) {
                sigPadConsultant.ctx.fillStyle = 'white';
                sigPadConsultant.ctx.fillRect(0, 0, sigPadConsultant.canvas.width, sigPadConsultant.canvas.height);
                $('sigTimeConsultant').textContent = '';
            }
        }
        
        function collectInitials() {
            const initials = {};
            document.querySelectorAll('[id^="init_"]').forEach(el => {
                initials[el.id.replace('init_', '')] = el.value;
            });
            return initials;
        }
        
        let initialSigPad = null;
        let drawingInitial = false;
        
        function initialAll() {
            // Open signature modal
            openModal('initialSig');
            
            // Initialize canvas
            const canvas = $('initialSigPad');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#2C2825';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            const getPos = e => {
                const r = canvas.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0]?.clientX);
                const clientY = e.clientY || (e.touches && e.touches[0]?.clientY);
                return { 
                    x: (clientX - r.left) * (canvas.width / r.width), 
                    y: (clientY - r.top) * (canvas.height / r.height) 
                };
            };
            
            canvas.onmousedown = canvas.ontouchstart = e => {
                e.preventDefault();
                drawingInitial = true;
                const p = getPos(e);
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
            };
            
            canvas.onmousemove = canvas.ontouchmove = e => {
                if (!drawingInitial) return;
                e.preventDefault();
                const p = getPos(e);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
            };
            
            canvas.onmouseup = canvas.ontouchend = canvas.onmouseleave = () => {
                drawingInitial = false;
            };
            
            initialSigPad = { canvas, ctx };
        }
        
        function clearInitialSig() {
            if (initialSigPad) {
                initialSigPad.ctx.fillStyle = 'white';
                initialSigPad.ctx.fillRect(0, 0, initialSigPad.canvas.width, initialSigPad.canvas.height);
            }
        }
        
        function isInitialSigBlank() {
            if (!initialSigPad) return true;
            const canvas = initialSigPad.canvas;
            const ctx = canvas.getContext('2d');
            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] !== 255 || data[i+1] !== 255 || data[i+2] !== 255) {
                    return false;
                }
            }
            return true;
        }
        
        function applyInitialSig() {
            if (isInitialSigBlank()) {
                toast('Please sign your initials first', 'error');
                return;
            }
            
            // Get signature as image
            const sigData = initialSigPad.canvas.toDataURL('image/png');
            
            // Apply to all init fields as small images
            document.querySelectorAll('.init-field').forEach(el => {
                // Create a container if not exists
                const container = el.parentElement;
                
                // Hide the input and show image instead
                el.style.display = 'none';
                el.value = '‚úì'; // Mark as signed
                
                // Check if image already exists
                let img = container.querySelector('.init-sig-img');
                if (!img) {
                    img = document.createElement('img');
                    img.className = 'init-sig-img';
                    img.style.cssText = 'width:60px;height:30px;object-fit:contain;border:1px solid var(--champagne);border-radius:4px;background:white';
                    container.appendChild(img);
                }
                img.src = sigData;
            });
            
            // Store signature data for PDF
            currentOrder.initialSignature = sigData;
            
            closeModal('initialSig');
            toast('Initials applied to all measurements', 'success');
        }

        async function completeOrder() {
            const c = currentClient;
            const o = currentOrder;
            
            // Calculate totals with new structure
            let subtotal = 0;
            o.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(cust => subtotal += cust.price || 0);
                }
            });
            
            const hst = o.hst ? Math.round(subtotal * 0.13 * 100) / 100 : 0;
            const total = subtotal + hst;
            const clientName = `${c.FirstName} ${c.LastName}`;
            
            // Prepare fitting photos - get from client's recently added photos
            let fittingPhotos = [];
            if (pendingPhotos.length > 0) {
                // Photos will be uploaded and added to client by sendContractEmail
                // Mark them for order storage too
                fittingPhotos = currentOrder.fittingPhotoUrls || [];
            }
            
            // Get dress info for individual fields
            const dressItem = o.items.find(i => i.type === 'dress');
            const accessoryItems = o.items.filter(i => i.type === 'accessory' || i.type === 'inhouse');
            
            // Save measurements to client's measurement history
            const measurementRecord = {
                date: today(),
                takenBy: o.measurements.takenBy || '',
                bust: o.measurements.bust || '',
                cup: o.measurements.cup || '',
                waist: o.measurements.waist || '',
                hip: o.measurements.hip || '',
                height: o.measurements.height || '',
                heels: o.measurements.heels || '',
                waistToFloor: o.measurements.waistToFloor || '',
                notes: o.measurements.notes || '',
                unit: o.measurements.unit || 'in',
                custom: o.measurements.custom || [],
                source: 'order' // Mark as coming from Say Yes
            };
            
            // Get existing measurements and add new one
            const existingMeasurements = getClientMeasurements();
            existingMeasurements.push(measurementRecord);
            
            const record = {
                ClientID: c.ID,
                ClientName: clientName,
                Phone: c.Phone || '',
                Email: c.Email || '',
                PO: $('oiPO').value || generateNextPO(),
                OrderDate: today(),
                WeddingDate: c.WeddingDate || '',
                ArrivalDate: $('oiArrivalDate').value || '',
                Status: 'pending submission',
                Consultant: currentOrder.consultant || '',
                Dress: dressItem ? dressItem.name : '',
                Designer: dressItem ? dressItem.designer : '',
                Size: dressItem ? dressItem.size : '',
                Customization: dressItem && dressItem.customizations ? dressItem.customizations.map(c => c.name).join(', ') : '',
                Accessories: accessoryItems.map(i => i.name).join(', '),
                Notes: $('oiDetails') ? $('oiDetails').value : '',
                Seamstress: '',
                Total: total,
                Subtotal: subtotal,
                HST: hst,
                Items: JSON.stringify(o.items),
                Measurements: JSON.stringify(o.measurements),
                FittingPhotos: JSON.stringify(fittingPhotos),
                SignatureTimestamp: new Date().toISOString()
            };
            try {
                await saveRecord('Orders', record);
                await updateRecord('Clients', c.ID, { 
                    Status: 'ordered', 
                    Measurements: JSON.stringify(o.measurements), 
                    MeasurementHistory: JSON.stringify(existingMeasurements),
                    OrderDraft: '', // Clear draft after successful order
                    SaidYes: 'TRUE',
                    SaidYesDate: today(),
                    LastVisit: today() 
                });
                currentClient.MeasurementHistory = JSON.stringify(existingMeasurements);
                currentClient.OrderDraft = '';
                currentClient.SaidYes = 'TRUE';
                currentClient.SaidYesDate = today();
                return true;
            } catch (e) { 
                console.error('Error saving order:', e);
                return false; 
            }
        }

        function prepareEmail() {
            const c = currentClient;
            const consultant = currentOrder.consultant || $('yConsultant').value || '';
            const store = getStoreInfo();
            const signDate = $('yDate').value ? fmtDate($('yDate').value) : fmtDate(today());
            
            $('emailTo').value = c.Email || '';
            $('emailSubject').value = `Your ${store.name || 'Estrelle Bridal'} Contract ‚Äî ${c.FirstName} ${c.LastName}`;
            $('emailBody').value = `Hi ${c.FirstName},

Congratulations on finding your dream dress with us! We are so excited to be part of this special time.

Please find your signed sales contract attached. Feel free to reach out with any questions.

We would greatly appreciate it if you could take a moment to share your experience with us on Google: https://g.page/r/CeGl9T2vSOuIEAE/review

Your review means the world to us and helps future brides find their dream dress too.

With love,
${consultant}
${store.name || 'Estrelle Bridal'}`;
        }

        function downloadContractPdf() {
            const c = currentClient;
            const contractHtml = getContractHtml();
            const signDate = $('yDate').value || today();
            
            // Create full HTML document for PDF
            const fullHtml = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>
body{font-family:Georgia,serif;font-size:11px;line-height:1.5;padding:30px;max-width:800px;margin:0 auto;}
h1{font-size:18px;text-align:center;margin-bottom:20px;}
h2{font-size:13px;margin-top:18px;margin-bottom:8px;border-bottom:1px solid #ccc;padding-bottom:4px;}
table{width:100%;border-collapse:collapse;margin:12px 0;}
th,td{border:1px solid #ccc;padding:6px 8px;text-align:left;font-size:10px;}
th{background:#f5f5f5;font-weight:bold;}
p{margin:6px 0;}
</style></head><body>${contractHtml}</body></html>`;
            
            // Create blob and download
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            // Create download link
            const a = document.createElement('a');
            const safeName = `${c.FirstName}_${c.LastName}`.replace(/[^a-zA-Z0-9]/g, '_');
            a.href = url;
            a.download = `${safeName}_Bridal_Contract_${signDate}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            toast('Contract downloaded! Open in browser and print to PDF.', 'success');
        }

        function getContractHtml() {
            const c = currentClient;
            const o = currentOrder;
            
            // Calculate totals with new structure
            let subtotal = 0;
            o.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(cust => subtotal += cust.price || 0);
                }
            });
            
            const hst = o.hst ? Math.round(subtotal * 0.13 * 100) / 100 : 0;
            const total = subtotal + hst;
            const unit = o.measurements.unit || 'in';
            const initials = o.initials || {};
            
            let hstRows = '';
            if (o.hst) {
                hstRows = `
                    <tr><td colspan="4" style="text-align:right">Subtotal</td><td>${money(subtotal)}</td></tr>
                    <tr><td colspan="4" style="text-align:right">HST (13%)</td><td>${money(hst)}</td></tr>
                `;
            }
            
            // Build items HTML with new structure
            let itemsHtml = '';
            o.items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>${item.designer || '‚Äî'}</td>
                        <td>${item.size || '‚Äî'}${item.color ? ', ' + item.color : ''}</td>
                        <td>‚Äî</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                    if (item.customizations && item.customizations.length > 0) {
                        item.customizations.forEach(cust => {
                            itemsHtml += `<tr style="font-size:10px;color:#666">
                                <td style="padding-left:15px">‚Ü≥ ${cust.name}</td>
                                <td>${item.designer}</td>
                                <td>${cust.delivery === 'ondress' ? 'On dress' : 'Separate'}</td>
                                <td>Customization</td>
                                <td>${money(cust.price)}</td>
                            </tr>`;
                        });
                    }
                } else if (item.type === 'inhouse') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>In-House</td>
                        <td>‚Äî</td>
                        <td>${item.notes ? item.notes.substring(0, 30) : '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                } else if (item.type === 'fee') {
                    itemsHtml += `<tr style="font-size:10px">
                        <td>${item.name}</td>
                        <td>‚Äî</td>
                        <td>‚Äî</td>
                        <td>${item.note || '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                }
            });
            
            // Build measurements with initials - core 3 have individual, others grouped
            const coreMeas = [
                { key: 'bust', label: 'Bust', value: o.measurements.bust, u: unit },
                { key: 'waist', label: 'Waist', value: o.measurements.waist, u: unit },
                { key: 'hip', label: 'Hip', value: o.measurements.hip, u: unit }
            ];
            
            const otherMeas = [
                { key: 'cup', label: 'Cup Size', value: o.measurements.cup, u: '' },
                { key: 'height', label: 'Height', value: o.measurements.height, u: unit },
                { key: 'waistToFloor', label: 'Waist to Floor', value: o.measurements.waistToFloor, u: unit },
                { key: 'heels', label: 'Heels', value: o.measurements.heels, u: '"' }
            ];
            
            if (o.measurements.custom) {
                o.measurements.custom.forEach((m, i) => {
                    otherMeas.push({ key: 'custom_' + i, label: m.name, value: m.value, u: m.unit });
                });
            }
            
            const coreRows = coreMeas.filter(m => m.value).map(m => {
                const initialHtml = o.initialSignature ? 
                    `<img src="${o.initialSignature}" style="width:50px;height:25px;object-fit:contain">` : 
                    (initials[m.key] || '');
                return `<tr><td>${m.label}</td><td>${m.value} ${m.u}</td><td style="text-align:center">${initialHtml}</td></tr>`;
            }).join('');
            
            const otherWithValues = otherMeas.filter(m => m.value);
            let otherRow = '';
            if (otherWithValues.length > 0) {
                const otherInitialHtml = o.initialSignature ? 
                    `<img src="${o.initialSignature}" style="width:50px;height:25px;object-fit:contain">` : 
                    (initials['other'] || '');
                otherRow = `<tr><td>Other</td><td>${otherWithValues.map(m => `${m.label}: ${m.value}${m.u}`).join(', ')}</td><td style="text-align:center">${otherInitialHtml}</td></tr>`;
            }
            
            return `
                <h1 style="text-align:center;font-size:16px;">SALES CONTRACT</h1>
                
                <div style="background:#f9f7f5;padding:10px;border-radius:4px;margin-bottom:15px">
                    <h2 style="margin:0 0 8px 0;font-size:11px">CUSTOMER INFORMATION</h2>
                    <table style="border:none;font-size:10px">
                        <tr><td style="border:none;padding:2px"><b>Name:</b> ${c.FirstName} ${c.LastName}</td><td style="border:none;padding:2px"><b>Email:</b> ${c.Email || '‚Äî'}</td></tr>
                        <tr><td style="border:none;padding:2px"><b>Phone:</b> ${c.Phone || '‚Äî'}</td><td style="border:none;padding:2px"><b>Wedding Date:</b> ${fmtDate(c.WeddingDate) || '‚Äî'}</td></tr>
                        <tr><td style="border:none;padding:2px" colspan="2"><b>Contract Date:</b> ${fmtDate(today())}</td></tr>
                    </table>
                </div>
                
                <h2>PARTIES</h2>
                <p>This Sales Contract (hereinafter referred to as the "Contract") is entered into on <b>${fmtDate(today())}</b> (the "Effective Date"), by and between Estrelle Bridal (ESTR INC.) with an address of 55 Avenue Road, #201.5, Toronto, Canada, M5R 3L2 (hereinafter referred to as the "Seller"), and <b>${c.FirstName} ${c.LastName}</b> (hereinafter referred to as the "Customer") (collectively referred to as the "Parties").</p>
                
                <h2>GOODS AND PRICE</h2>
                <p>The goods that the Seller is selling to the Customer are enlisted below (hereinafter referred to as the "Goods").</p>
                <table>
                    <tr><th>Product</th><th>Designer/Source</th><th>Details</th><th>Notes</th><th>Price</th></tr>
                    ${itemsHtml}
                    ${hstRows}
                    <tr><td colspan="4" style="text-align:right;font-weight:bold">TOTAL</td><td style="font-weight:bold">${money(total)}</td></tr>
                </table>
                ${$('oiDetails').value ? `<p><b>Important ordering details:</b> ${$('oiDetails').value}</p>` : ''}
                
                <h2>MEASUREMENTS</h2>
                ${o.measurements.takenBy ? `<p style="font-size:9px;margin-bottom:6px"><b>Measured by:</b> ${o.measurements.takenBy}</p>` : ''}
                <table>
                    <tr><th>Item</th><th>Measurement</th><th>Client's Initial</th></tr>
                    ${coreRows}
                    ${otherRow}
                </table>
                ${o.measurements.notes ? `<p><b>Important measurement notes:</b> ${o.measurements.notes}</p>` : ''}
                
                <h2>PAYMENT TERMS</h2>
                <p>The Customer agrees to make an initial deposit of at least 50% of the total purchase price upon placing the order, which is non-refundable.</p>
                <p>The Seller will send a balance finalization request to the Buyer by the end of the production, and the Customer agrees to pay the remaining balance in full before shipment.</p>
                
                <h2>DELIVERY AND SHIPPING</h2>
                <p>The delivery of the goods (hereinafter referred to as the "Delivery") will be at Estrelle Bridal.</p>
                <p>The shipping method will be decided by the suppliers and Seller will be responsible for the costs of the shipment.</p>
                
                <h2>NO REFUNDS OR RETURNS</h2>
                <p>The Customer acknowledges that the wedding dress is made-to-order or customized to their specifications. Therefore, NO returns or refunds will be accepted after the order has been confirmed and production has started.</p>
                
                <h2>CANCELLATION OF ORDERS</h2>
                <p>The Customer who cancels their sales contract are NOT entitled to a refund of ANY monies paid up to and including the cancellation date. The Customer is required to make full payment as per the original order agreement, even in the event of order cancellation, costs will still be incurred to the suppliers and to the Seller regardless of any circumstance.</p>
                
                <h2>INSPECTION</h2>
                <p>Hereby, the Customer acknowledges that it has relied solely on the investigations, examinations, and inspections that the Customer has chosen to make and that the Seller has afforded the Customer the opportunity for full and complete investigations, examinations, and inspections.</p>
                
                <h2>RISK OF LOSS AND TITLE</h2>
                <p>The risk of loss or damage for the goods will be on the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                <p>The Title of the goods will also remain with the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                
                <h2>DELAY OR FAILURE TO PERFORM AND FORCE MAJEURE</h2>
                <p>Under no circumstances will the Seller be held liable to the Customer for any delay that may occur, non-delivery or an arising fault of this Agreement that may be due to any labour dispute, shortage in transportation, delay or shortage of materials to produce the Goods, fires, accidents, Acts of God, or any other causes outside Seller's control. The Seller will notify the Customer immediately upon realization that it will not be able to deliver the Goods as promised. Upon such notice, either Party may terminate this Agreement.</p>
                
                <h2>LIMITATION OF LIABILITY</h2>
                <p>Under no circumstances will the Seller be liable for any indirect, special, consequential, or punitive damages (including lost profits) arising out of or relating to this Agreement or the transactions it contemplates (whether for breach of contract, tort, negligence, or other form of action).</p>
                
                <h2>FIT & BODY SIZE CHANGES</h2>
                <p>The Customer acknowledges that the wedding dress is ordered based on measurements taken at the time of purchase. The Seller is not responsible for any changes in the Customer's body size or shape after the order is placed. Any significant fluctuations in weight or body measurements may affect the fit, potentially requiring substantial alterations at the Customer's expense, or, in some cases, resulting in the dress not fitting as intended. The Seller bears no liability for such outcomes.</p>
                
                <h2>ENTIRE AGREEMENT</h2>
                <p>This Agreement contains the entire agreement and understanding among the Parties hereto with respect to the subject matter hereof, and supersedes all prior agreements, understandings, inducements and conditions, express or implied, oral or written, of any nature whatsoever with respect to the subject matter hereof. The express terms hereof control and supersede any course of performance and/or usage of the trade inconsistent with any of the terms hereof.</p>
                
                <h2>FORCE MAJEURE</h2>
                <p>The Seller will not be liable for delays in performance or for non-performance due to unforeseen circumstances or causes beyond the Seller's reasonable control.</p>
            `;
        }
        
        async function generateBlankContract() {
            const c = currentClient;
            const o = currentOrder;
            
            // Ensure measurements are saved from form if on step 1 or navigated back
            if (!o.measurements || !o.measurements.bust) {
                o.measurements = { 
                    bust: $('mBust').value,
                    cup: $('mCup').value,
                    waist: $('mWaist').value, 
                    hip: $('mHip').value, 
                    height: $('mHeight').value, 
                    waistToFloor: $('mWaistToFloor').value,
                    heels: $('mHeels').value, 
                    notes: $('mNotes').value,
                    unit: measUnit,
                    custom: [...customMeasurements],
                    takenBy: $('mTakenBy').value
                };
            }
            
            // Validate we have items
            if (!o.items || o.items.length === 0) {
                toast('Please add items to the order first', 'error');
                return;
            }
            
            toast('Generating blank contract...', '');
            
            // Get contract HTML without signatures/initials
            const contractHtml = getBlankContractHtml();
            
            try {
                const result = await api('POST', {
                    action: 'sendContract',
                    contractData: {
                        brideName: `${c.FirstName} ${c.LastName}`,
                        contractHtml: contractHtml,
                        signatureData: null,
                        consultantSignatureData: null,
                        signDate: $('yDate').value || today(),
                        skipEmail: true,
                        blankContract: true
                    }
                });
                
                if (result.driveLink) {
                    toast('Blank contract saved to Drive!', 'success');
                    window.open(result.driveLink, '_blank');
                } else {
                    toast('Contract generated', 'success');
                }
            } catch (e) {
                console.error('Generate blank contract error:', e);
                toast('Failed to generate contract', 'error');
            }
        }
        
        function getBlankContractHtml() {
            const c = currentClient;
            const o = currentOrder;
            
            // Get consultant signature if selected
            const selectedConsultantId = $('yConsultantSelect')?.value;
            const consultant = data.consultants.find(cons => cons.ID == selectedConsultantId);
            const consultantName = consultant?.Name || '';
            const consultantSig = consultant?.Signature || '';
            
            // Calculate totals
            let subtotal = 0;
            o.items.forEach(item => {
                subtotal += item.price || 0;
                if (item.customizations) {
                    item.customizations.forEach(cust => subtotal += cust.price || 0);
                }
            });
            
            const taxInfo = getTaxInfo();
            const taxAmount = Math.round(subtotal * taxInfo.rate * 100) / 100;
            const total = subtotal + taxAmount;
            const unit = o.measurements?.unit || measUnit || 'in';
            
            let taxRows = '';
            if (taxInfo.rate > 0) {
                taxRows = `
                    <tr><td colspan="4" style="text-align:right">Subtotal</td><td>${money(subtotal)}</td></tr>
                    <tr><td colspan="4" style="text-align:right">${taxInfo.label}</td><td>${money(taxAmount)}</td></tr>
                `;
            }
            
            // Build items HTML
            let itemsHtml = '';
            o.items.forEach(item => {
                if (item.type === 'dress' || item.type === 'accessory') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>${item.designer || '‚Äî'}</td>
                        <td>${item.size || '‚Äî'}${item.color ? ', ' + item.color : ''}</td>
                        <td>‚Äî</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                    if (item.customizations && item.customizations.length > 0) {
                        item.customizations.forEach(cust => {
                            itemsHtml += `<tr style="font-size:10px;color:#666">
                                <td style="padding-left:15px">‚Ü≥ ${cust.name}</td>
                                <td>${item.designer}</td>
                                <td>${cust.delivery === 'ondress' ? 'On dress' : 'Separate'}</td>
                                <td>Customization</td>
                                <td>${money(cust.price)}</td>
                            </tr>`;
                        });
                    }
                } else if (item.type === 'inhouse') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>In-House</td>
                        <td>‚Äî</td>
                        <td>${item.notes ? item.notes.substring(0, 30) : '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                } else if (item.type === 'fee') {
                    itemsHtml += `<tr style="font-size:10px">
                        <td>${item.name}</td>
                        <td>‚Äî</td>
                        <td>‚Äî</td>
                        <td>${item.note || '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                } else if (item.type === 'discount') {
                    itemsHtml += `<tr style="font-size:10px;color:#27ae60">
                        <td>${item.name}</td>
                        <td>‚Äî</td>
                        <td>‚Äî</td>
                        <td>Discount</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                } else if (item.type === 'custom') {
                    itemsHtml += `<tr>
                        <td>${item.name}</td>
                        <td>Custom</td>
                        <td>‚Äî</td>
                        <td>${item.notes ? item.notes.substring(0, 30) : '‚Äî'}</td>
                        <td>${money(item.price)}</td>
                    </tr>`;
                }
            });
            
            // Build measurements with blank initial boxes
            const meas = o.measurements || {};
            const coreMeas = [
                { label: 'Bust', value: meas.bust, u: unit },
                { label: 'Waist', value: meas.waist, u: unit },
                { label: 'Hip', value: meas.hip, u: unit }
            ];
            
            const otherMeas = [
                { label: 'Cup Size', value: meas.cup, u: '' },
                { label: 'Height', value: meas.height, u: unit },
                { label: 'Waist to Floor', value: meas.waistToFloor, u: unit },
                { label: 'Heels', value: meas.heels, u: '"' }
            ];
            
            if (meas.custom) {
                meas.custom.forEach(m => {
                    otherMeas.push({ label: m.name, value: m.value, u: m.unit });
                });
            }
            
            // Blank initial box HTML
            const blankInitial = '<div style="width:60px;height:25px;border:1px solid #999;display:inline-block"></div>';
            
            const coreRows = coreMeas.filter(m => m.value).map(m => 
                `<tr><td>${m.label}</td><td>${m.value} ${m.u}</td><td style="text-align:center">${blankInitial}</td></tr>`
            ).join('');
            
            const otherWithValues = otherMeas.filter(m => m.value);
            let otherRow = '';
            if (otherWithValues.length > 0) {
                otherRow = `<tr><td>Other</td><td>${otherWithValues.map(m => `${m.label}: ${m.value}${m.u}`).join(', ')}</td><td style="text-align:center">${blankInitial}</td></tr>`;
            }
            
            // Blank signature box for client, real signature for consultant if available
            const blankSigBox = '<div style="width:200px;height:60px;border-bottom:1px solid #000;display:inline-block"></div>';
            const consultantSigHtml = consultantSig ? 
                `<img src="${consultantSig}" style="max-width:200px;max-height:60px;border-bottom:1px solid #000;">` : 
                blankSigBox;
            
            const orderDetails = $('oiDetails')?.value || '';
            const contractDate = $('yDate')?.value || today();
            
            return `
                <h1 style="text-align:center;font-size:16px;">SALES CONTRACT</h1>
                
                <div style="background:#f9f7f5;padding:10px;border-radius:4px;margin-bottom:15px">
                    <h2 style="margin:0 0 8px 0;font-size:11px">CUSTOMER INFORMATION</h2>
                    <table style="border:none;font-size:10px">
                        <tr><td style="border:none;padding:2px"><b>Name:</b> ${c.FirstName} ${c.LastName}</td><td style="border:none;padding:2px"><b>Email:</b> ${c.Email || '‚Äî'}</td></tr>
                        <tr><td style="border:none;padding:2px"><b>Phone:</b> ${c.Phone || '‚Äî'}</td><td style="border:none;padding:2px"><b>Wedding Date:</b> ${fmtDate(c.WeddingDate) || '‚Äî'}</td></tr>
                        <tr><td style="border:none;padding:2px" colspan="2"><b>Contract Date:</b> ${fmtDate(contractDate)}</td></tr>
                    </table>
                </div>
                
                <h2>PARTIES</h2>
                <p>This Sales Contract (hereinafter referred to as the "Contract") is entered into on <b>${fmtDate(contractDate)}</b> (the "Effective Date"), by and between Estrelle Bridal (ESTR INC.) with an address of 55 Avenue Road, #201.5, Toronto, Canada, M5R 3L2 (hereinafter referred to as the "Seller"), and <b>${c.FirstName} ${c.LastName}</b> (hereinafter referred to as the "Customer") (collectively referred to as the "Parties").</p>
                
                <h2>GOODS AND PRICE</h2>
                <p>The goods that the Seller is selling to the Customer are enlisted below (hereinafter referred to as the "Goods").</p>
                <table>
                    <tr><th>Product</th><th>Designer/Source</th><th>Details</th><th>Notes</th><th>Price</th></tr>
                    ${itemsHtml}
                    ${taxRows}
                    <tr><td colspan="4" style="text-align:right;font-weight:bold">TOTAL</td><td style="font-weight:bold">${money(total)}</td></tr>
                </table>
                ${orderDetails ? `<p><b>Important ordering details:</b> ${orderDetails}</p>` : ''}
                
                <h2>MEASUREMENTS</h2>
                ${meas.takenBy ? `<p style="font-size:9px;margin-bottom:6px"><b>Measured by:</b> ${meas.takenBy}</p>` : ''}
                <table>
                    <tr><th>Item</th><th>Measurement</th><th>Client's Initial</th></tr>
                    ${coreRows}
                    ${otherRow}
                </table>
                ${meas.notes ? `<p><b>Important measurement notes:</b> ${meas.notes}</p>` : ''}
                
                <h2>PAYMENT TERMS</h2>
                <p>The Customer agrees to make an initial deposit of at least 50% of the total purchase price upon placing the order, which is non-refundable.</p>
                <p>The Seller will send a balance finalization request to the Buyer by the end of the production, and the Customer agrees to pay the remaining balance in full before shipment.</p>
                
                <h2>DELIVERY AND SHIPPING</h2>
                <p>The delivery of the goods (hereinafter referred to as the "Delivery") will be at Estrelle Bridal.</p>
                <p>The shipping method will be decided by the suppliers and Seller will be responsible for the costs of the shipment.</p>
                
                <h2>NO REFUNDS OR RETURNS</h2>
                <p>The Customer acknowledges that the wedding dress is made-to-order or customized to their specifications. Therefore, NO returns or refunds will be accepted after the order has been confirmed and production has started.</p>
                
                <h2>CANCELLATION OF ORDERS</h2>
                <p>The Customer who cancels their sales contract are NOT entitled to a refund of ANY monies paid up to and including the cancellation date. The Customer is required to make full payment as per the original order agreement, even in the event of order cancellation, costs will still be incurred to the suppliers and to the Seller regardless of any circumstance.</p>
                
                <h2>INSPECTION</h2>
                <p>Hereby, the Customer acknowledges that it has relied solely on the investigations, examinations, and inspections that the Customer has chosen to make and that the Seller has afforded the Customer the opportunity for full and complete investigations, examinations, and inspections.</p>
                
                <h2>RISK OF LOSS AND TITLE</h2>
                <p>The risk of loss or damage for the goods will be on the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                <p>The Title of the goods will also remain with the Seller until the goods pass upon delivery to the Customer or its designee.</p>
                
                <h2>DELAY OR FAILURE TO PERFORM AND FORCE MAJEURE</h2>
                <p>Under no circumstances will the Seller be held liable to the Customer for any delay that may occur, non-delivery or an arising fault of this Agreement that may be due to any labour dispute, shortage in transportation, delay or shortage of materials to produce the Goods, fires, accidents, Acts of God, or any other causes outside Seller's control. The Seller will notify the Customer immediately upon realization that it will not be able to deliver the Goods as promised. Upon such notice, either Party may terminate this Agreement.</p>
                
                <h2>LIMITATION OF LIABILITY</h2>
                <p>Under no circumstances will the Seller be liable for any indirect, special, consequential, or punitive damages (including lost profits) arising out of or relating to this Agreement or the transactions it contemplates (whether for breach of contract, tort, negligence, or other form of action).</p>
                
                <h2>FIT & BODY SIZE CHANGES</h2>
                <p>The Customer acknowledges that the wedding dress is ordered based on measurements taken at the time of purchase. The Seller is not responsible for any changes in the Customer's body size or shape after the order is placed. Any significant fluctuations in weight or body measurements may affect the fit, potentially requiring substantial alterations at the Customer's expense, or, in some cases, resulting in the dress not fitting as intended. The Seller bears no liability for such outcomes.</p>
                
                <h2>ENTIRE AGREEMENT</h2>
                <p>This Agreement contains the entire agreement and understanding among the Parties hereto with respect to the subject matter hereof, and supersedes all prior agreements, understandings, inducements and conditions, express or implied, oral or written, of any nature whatsoever with respect to the subject matter hereof. The express terms hereof control and supersede any course of performance and/or usage of the trade inconsistent with any of the terms hereof.</p>
                
                <h2>FORCE MAJEURE</h2>
                <p>The Seller will not be liable for delays in performance or for non-performance due to unforeseen circumstances or causes beyond the Seller's reasonable control.</p>
                
                <div style="margin-top:40px;page-break-inside:avoid;">
                    <div style="display:flex;justify-content:space-between;">
                        <div style="width:45%;">
                            <p style="font-weight:bold;margin-bottom:10px;font-size:12px;">Customer Signature:</p>
                            ${blankSigBox}
                            <p style="font-size:10px;color:#666;margin-top:5px;">Date: ${fmtDate(contractDate)}</p>
                        </div>
                        <div style="width:45%;">
                            <p style="font-weight:bold;margin-bottom:10px;font-size:12px;">Consultant Signature:</p>
                            ${consultantSigHtml}
                            <p style="font-size:10px;color:#666;margin-top:5px;">${consultantName ? consultantName + ' ‚Äî ' : ''}${fmtDate(contractDate)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveOrderOnly() {
            const c = currentClient;
            
            // Upload photos first if any
            if (pendingPhotos.length > 0) {
                toast('Uploading photos...', 'success');
                const photoUrls = await uploadPhotos();
                if (photoUrls.length > 0) {
                    const existingPhotos = c.Photos ? (typeof c.Photos === 'string' ? JSON.parse(c.Photos) : c.Photos) : [];
                    const allPhotos = [...existingPhotos, ...photoUrls];
                    updateRecord('Clients', c.ID, { Photos: JSON.stringify(allPhotos) });
                    currentClient.Photos = JSON.stringify(allPhotos);
                    currentOrder.fittingPhotoUrls = photoUrls;
                    toast(`${photoUrls.length} photo(s) uploaded!`, 'success');
                }
                pendingPhotos = [];
                renderPhotoPreview();
            }
            
            // Save order
            const success = await completeOrder();
            
            if (success) {
                // Delete draft since order is complete
                deleteDraft(c.ID);
                $('draftIndicator').style.display = 'none';
                
                closeModal('yes');
                toast('Order saved! Saving contract to Drive...', 'success');
                
                // Save contract to Google Drive (no email)
                let sigData = currentOrder.signatureData;
                let consultantSigData = currentOrder.consultantSignatureData;
                if (sigData && sigData.length > 500000) sigData = null;
                if (consultantSigData && consultantSigData.length > 500000) consultantSigData = null;
                
                const contractData = {
                    brideName: `${c.FirstName} ${c.LastName}`,
                    contractHtml: getContractHtml(),
                    signatureData: sigData,
                    consultantSignatureData: consultantSigData,
                    signDate: $('yDate').value || today(),
                    skipEmail: true
                };
                
                api('POST', { action: 'sendContract', contractData })
                    .then(res => {
                        if (res.driveLink) {
                            toast('Contract saved to Drive!', 'success');
                        }
                    })
                    .catch(e => console.error('Drive save failed:', e));
                
                // Render client profile and clients list to show üíç icon
                if (currentClient) {
                    renderClientProfile();
                    renderClientPhotos();
                }
                renderClients();
            } else {
                toast('Failed to save order', 'error');
            }
        }

        async function openContractInGmail() {
            const c = currentClient;
            const brideEmail = $('emailTo').value;
            const subject = $('emailSubject').value;
            const body = $('emailBody').value;
            
            if (!brideEmail) {
                toast('No email address for this client', 'error');
                return;
            }
            
            // Upload photos first if any
            if (pendingPhotos.length > 0) {
                toast('Uploading photos...', 'success');
                const photoUrls = await uploadPhotos();
                if (photoUrls.length > 0) {
                    const existingPhotos = c.Photos ? (typeof c.Photos === 'string' ? JSON.parse(c.Photos) : c.Photos) : [];
                    const allPhotos = [...existingPhotos, ...photoUrls];
                    updateRecord('Clients', c.ID, { Photos: JSON.stringify(allPhotos) });
                    currentClient.Photos = JSON.stringify(allPhotos);
                    currentOrder.fittingPhotoUrls = photoUrls;
                    toast(`${photoUrls.length} photo(s) uploaded!`, 'success');
                }
                pendingPhotos = [];
                renderPhotoPreview();
            }
            
            // Save order first
            await completeOrder();
            
            // Delete draft since order is complete
            deleteDraft(c.ID);
            $('draftIndicator').style.display = 'none';
            
            // Close modal
            closeModal('yes');
            toast('Order saved! Opening Gmail...', 'success');
            
            // Open Gmail compose
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(brideEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            
            // Render client profile and clients list to show üíç icon
            if (currentClient) {
                renderClientProfile();
                renderClientPhotos();
            }
            renderClients();
        }

        async function sendContractEmail() {
            const c = currentClient;
            const brideEmail = $('emailTo').value;
            
            if (!brideEmail) {
                toast('No email address for this client', 'error');
                return;
            }
            
            // Upload photos first if any
            if (pendingPhotos.length > 0) {
                toast('Uploading photos...', 'success');
                const photoUrls = await uploadPhotos();
                if (photoUrls.length > 0) {
                    // Save photo URLs to client record
                    const existingPhotos = c.Photos ? (typeof c.Photos === 'string' ? JSON.parse(c.Photos) : c.Photos) : [];
                    const allPhotos = [...existingPhotos, ...photoUrls];
                    updateRecord('Clients', c.ID, { Photos: JSON.stringify(allPhotos) });
                    currentClient.Photos = JSON.stringify(allPhotos);
                    
                    // Also save to currentOrder for order record
                    currentOrder.fittingPhotoUrls = photoUrls;
                    
                    toast(`${photoUrls.length} photo(s) uploaded!`, 'success');
                }
                pendingPhotos = [];
                renderPhotoPreview();
            }
            
            // Save order first
            await completeOrder();
            
            // Delete draft since order is complete
            deleteDraft(c.ID);
            $('draftIndicator').style.display = 'none';
            
            // Close modal immediately for better UX
            closeModal('yes');
            toast('Order saved! Sending email...', 'success');
            
            // Prepare signature data
            let sigData = currentOrder.signatureData;
            let consultantSigData = currentOrder.consultantSignatureData;
            
            // Skip if signatures too large
            if (sigData && sigData.length > 500000) sigData = null;
            if (consultantSigData && consultantSigData.length > 500000) consultantSigData = null;
            
            // Send email in background
            const contractData = {
                brideName: `${c.FirstName} ${c.LastName}`,
                brideEmail: brideEmail,
                consultantName: currentOrder.consultant || '',
                subject: $('emailSubject').value,
                body: $('emailBody').value,
                contractHtml: getContractHtml(),
                signatureData: sigData,
                consultantSignatureData: consultantSigData,
                weddingDate: c.WeddingDate ? fmtDate(c.WeddingDate) : '',
                phone: c.Phone || '',
                signDate: $('yDate').value || today()
            };
            
            // Fire and forget - send in background
            api('POST', { action: 'sendContract', contractData })
                .then(() => toast('Email sent to ' + brideEmail, 'success'))
                .catch(e => {
                    console.error('Email send failed:', e);
                    toast('Email failed. Try "Open in Gmail" instead.', 'error');
                });
                
            // Render client profile and clients list to show üíç icon
            if (currentClient) {
                renderClientProfile();
                renderClientPhotos();
            }
            renderClients();
        }

        // ========== INIT ==========
        document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', () => { if (n.dataset.page) showPage(n.dataset.page); }));
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));
        
        // Load cached data first for instant UI, then fetch fresh from server
        loadCachedData();
        showPage('dashboard');
        
        // Load fresh data and re-render current view
        loadData().then(() => {
            // Re-render dashboard with fresh data
            renderDash();
            // If orders tab needs rendering, do it
            if (ordersView === 'orders') {
                renderOrders();
            } else if (ordersView === 'alterations') {
                renderAlts();
            }
            // One-time silent cleanup of messy type names in Google Sheet
            cleanUpAppointmentTypes();
        });
        
        // ========== AUTO-REFRESH ==========
        // Poll for updates every 60 seconds when app is visible
        let autoRefreshInterval = null;
        const AUTO_REFRESH_MS = 60000; // 60 seconds
        
        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            autoRefreshInterval = setInterval(async () => {
                // Only refresh if document is visible and no modal is open
                if (document.hidden) return;
                if (document.querySelector('.modal-overlay.active')) return;
                
                console.log('Auto-refreshing data...');
                try {
                    const d = await api('GET');
                    if (!d || typeof d !== 'object') return;
                    
                    // Check if data actually changed
                    const oldApptCount = data.appointments.length;
                    const oldOrderCount = data.orders.length;
                    const newApptCount = (d.appointments || []).length;
                    const newOrderCount = (d.orders || []).length;
                    
                    // Update data
                    data = { 
                        clients: d.clients || [], 
                        appointments: d.appointments || [], 
                        topoptions: d.topoptions || [], 
                        orders: d.orders || [], 
                        alterations: d.alterations || [], 
                        designers: d.designers || [],
                        consultants: d.consultants || [],
                        visitnotes: d.visitnotes || [],
                        announcements: d.announcements || [],
                        emailtemplates: d.emailtemplates || []
                    };
                    saveCachedData();
                    
                    // Re-render current view
                    const activePage = document.querySelector('.section.active')?.id?.replace('page-', '');
                    if (activePage === 'dashboard') renderDash();
                    else if (activePage === 'orders') {
                        if (ordersView === 'orders') renderOrders();
                        else renderAlts();
                    }
                    else if (activePage === 'schedule') renderSchedule();
                    else if (activePage === 'clients' && !currentClient) renderClients();
                    
                    // Show subtle indicator if counts changed
                    if (oldApptCount !== newApptCount || oldOrderCount !== newOrderCount) {
                        console.log('Data updated:', { appointments: newApptCount, orders: newOrderCount });
                    }
                } catch (e) {
                    console.log('Auto-refresh failed:', e.message);
                }
            }, AUTO_REFRESH_MS);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Start/stop based on visibility
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                // Refresh immediately when tab becomes visible
                loadData().then(() => {
                    const activePage = document.querySelector('.section.active')?.id?.replace('page-', '');
                    if (activePage === 'dashboard') renderDash();
                    else if (activePage === 'orders') {
                        if (ordersView === 'orders') renderOrders();
                        else renderAlts();
                    }
                });
                startAutoRefresh();
            }
        });
        
        // Start auto-refresh
        startAutoRefresh();

        </script>
</body>
</html>
